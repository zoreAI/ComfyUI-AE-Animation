import{d as tt,r as z,c as me,b as He,k as Je,a as nt,w as Ve,f as A,h as R,j as l,C as Ae,D as qe,l as Q,u as y,z as we,E as at,t as D,_ as Qe,y as st,q,G as Ze,H as ot,p as rt,F as de,s as be,i as fe,A as it,B as ct}from"./assets/_plugin-vue_export-helper.js";function Ge(T){const L=Math.max(1,T.fps||1);return T.duration||T.total_frames/L}const et=tt("timeline",()=>{const T=z({width:1280,height:720,fps:30,duration:5,total_frames:150,mask_expansion:0,mask_feather:0}),L=z([]),t=z(-1),S=z(0),N=z(0),G=z(!1),X=z({enabled:!1,drawing:!1,erase:!1,brush:20}),se=z({enabled:!1,data:null}),oe=z({enabled:!1,drawing:!1,brush:30,blurType:"gaussian"}),H=me(()=>t.value>=0&&t.value<L.value.length?L.value[t.value]:null),ee=me(()=>L.value.filter(m=>m.type==="foreground")),W=me(()=>L.value.find(m=>m.type==="background"));function V(m){const k=Math.max(1,m.fps??T.value.fps),w=typeof m.duration=="number",P=typeof m.total_frames=="number",E={...T.value,...m,fps:k};w&&!P?E.total_frames=Math.max(1,Math.round((E.duration||0)*k)):P&&!w?(E.total_frames=Math.max(1,Math.round(E.total_frames)),E.duration=E.total_frames/k):(E.total_frames=Math.max(1,Math.round(E.total_frames||E.duration*k)),E.duration=E.duration||E.total_frames/k),Object.assign(T.value,E)}function O(m){L.value.push(m),t.value=L.value.length-1}function B(m){m>=0&&m<L.value.length&&(L.value.splice(m,1),t.value>=L.value.length&&(t.value=L.value.length-1))}function U(){L.value=[],t.value=-1}function xe(m){m>=0&&m<L.value.length&&(t.value=m)}function re(m,k){m>=0&&m<L.value.length&&Object.assign(L.value[m],k)}function I(m){const k=Ge(T.value);S.value=Math.max(0,Math.min(m,k)),N.value=Math.floor(S.value*T.value.fps)}function Z(m){const k=Math.max(1,Math.round(T.value.total_frames||Ge(T.value)*T.value.fps));N.value=Math.max(0,Math.min(m,k-1)),S.value=N.value/T.value.fps}let Y=null,j=0;function pe(){G.value=!G.value,G.value?F():ne()}function F(){Y===null&&(j=performance.now(),te())}function te(){if(!G.value)return;const m=performance.now(),k=(m-j)/1e3;j=m;let w=S.value+k;const P=Ge(T.value);w>=P&&(w=0),I(w),Y=requestAnimationFrame(te)}function ne(){Y!==null&&(cancelAnimationFrame(Y),Y=null)}function _e(){G.value=!1,ne(),I(0)}function ce(m){if(!m)return;const k=m.project||{},w=k.fps||T.value.fps||30,P=k.duration??(k.total_frames?k.total_frames/Math.max(1,w):T.value.duration),E=k.total_frames??Math.max(1,Math.round((P||T.value.duration)*w));V({width:k.width||1280,height:k.height||720,fps:w,duration:P,total_frames:E,mask_expansion:k.mask_expansion||0,mask_feather:k.mask_feather||0}),L.value=(m.layers||[]).map(C=>({id:C.id,name:C.name,type:C.type,image_data:C.image_data,x:C.x||0,y:C.y||0,scale:C.scale||1,rotation:C.rotation||0,opacity:C.opacity!==void 0?C.opacity:1,rotationX:C.rotationX||0,rotationY:C.rotationY||0,rotationZ:C.rotationZ||0,anchorX:C.anchorX||0,anchorY:C.anchorY||0,perspective:C.perspective||1e3,mask_size:C.mask_size||0,customMask:C.customMask,bezierPath:C.bezierPath,usePathAnimation:C.usePathAnimation||!1,keyframes:C.keyframes||{},bg_mode:C.bg_mode||"fit"}))}function Me(){const m=H.value;if(!m)return;const k=["x","y","scale","rotation","opacity","mask_size","rotationX","rotationY","rotationZ","anchorX","anchorY","perspective"];m.keyframes||(m.keyframes={});for(const w of k){let P=m[w];P===void 0&&(w==="scale"||w==="opacity"?P=1:w==="perspective"?P=1e3:P=0),m.keyframes[w]||(m.keyframes[w]=[]),m.keyframes[w]=m.keyframes[w].filter(E=>E.time!==S.value),m.keyframes[w].push({time:S.value,value:P}),m.keyframes[w].sort((E,C)=>E.time-C.time)}}function Le(){const m=H.value;if(!m||!m.keyframes)return;const k=["x","y","scale","rotation","opacity","mask_size","rotationX","rotationY","rotationZ","anchorX","anchorY","perspective"];for(const w of k)m.keyframes[w]&&(m.keyframes[w]=m.keyframes[w].filter(P=>P.time!==S.value))}function he(){const m=H.value;m&&(m.keyframes={})}function ye(){return{project:{...T.value},layers:L.value.map(m=>({id:m.id,name:m.name,type:m.type,image_data:m.image_data,x:m.x,y:m.y,scale:m.scale,rotation:m.rotation,opacity:m.opacity,rotationX:m.rotationX,rotationY:m.rotationY,rotationZ:m.rotationZ,anchorX:m.anchorX,anchorY:m.anchorY,perspective:m.perspective,mask_size:m.mask_size,customMask:m.customMask,bezierPath:m.bezierPath,usePathAnimation:m.usePathAnimation,keyframes:m.keyframes,bg_mode:m.bg_mode}))}}return{project:T,layers:L,currentLayerIndex:t,currentTime:S,currentFrame:N,isPlaying:G,maskMode:X,pathMode:se,extractMode:oe,currentLayer:H,foregroundLayers:ee,backgroundLayer:W,setProject:V,addLayer:O,removeLayer:B,clearLayers:U,selectLayer:xe,updateLayer:re,setCurrentTime:I,setCurrentFrame:Z,togglePlayback:pe,stopPlayback:_e,addKeyframe:Me,deleteKeyframe:Le,clearAllKeyframes:he,loadAnimation:ce,exportAnimation:ye}}),lt={class:"canvas-wrapper"},ut=["width","height"],dt=["width","height"],ft={class:"canvas-info"},mt={key:0},pt={key:0,class:"gpu-badge"},ht={key:1},yt=He({__name:"CanvasPreview",setup(T,{expose:L}){const t=et(),S=z(),N=z(),G=z();let X=!1,se=0,oe=0,H=0,ee=0;const W=z(!1);let V=!1,O=null;const B=new Map,U=new Map;Je(async()=>{S.value&&(O=S.value.getContext("2d",{alpha:!1,desynchronized:!0})),await xe(),I()}),nt(()=>{B.clear(),re()});async function xe(){console.log("[Timeline GPU] GPU rendering disabled, using Canvas 2D for stability"),W.value=!1}function re(){for(const n of U.values())n.destroy();U.clear()}function I(){V||(V=!0,requestAnimationFrame(()=>{V=!1,te()}))}Ve(()=>[t.layers,t.currentLayer,t.currentTime],()=>{I()},{deep:!0}),Ve(()=>t.extractMode.enabled,()=>{E=!1,I()});function Z(){{ne();return}}function Y(n){if(n.img)return n.img;if(!n.image_data)return null;const o=n.id;if(B.has(o)){const i=B.get(o);return i.complete?(n.img=i,i):null}const r=new Image;return r.onload=()=>{n.img=r,I()},r.src=n.image_data,B.set(o,r),null}function j(n,o,r){if(!n||n.length===0)return r;const i=[...n].sort((d,u)=>d.time-u.time);if(o<=i[0].time)return i[0].value;if(o>=i[i.length-1].time)return i[i.length-1].value;for(let d=0;d<i.length-1;d++)if(o>=i[d].time&&o<=i[d+1].time){const u=(o-i[d].time)/(i[d+1].time-i[d].time);return i[d].value+(i[d+1].value-i[d].value)*u}return r}function pe(n,o,r){if(!n||n.length<2)return null;const i=o/r,u=n.length-1,h=Math.min(Math.floor(i*u),u-1),_=i*u-h,g=n[h],x=n[h+1];if(!g||!x)return null;const s=g.cp2x??g.x+(x.x-g.x)/3,e=g.cp2y??g.y+(x.y-g.y)/3,a=x.cp1x??g.x+(x.x-g.x)*2/3,c=x.cp1y??g.y+(x.y-g.y)*2/3,f=1-_,p=f*f,v=p*f,M=_*_,b=M*_;return{x:v*g.x+3*p*_*s+3*f*M*a+b*x.x,y:v*g.y+3*p*_*e+3*f*M*c+b*x.y}}function F(n){const o=t.currentTime,r=n.keyframes||{};let i=j(r.x,o,n.x||0),d=j(r.y,o,n.y||0);if(n.usePathAnimation&&n.bezierPath&&n.bezierPath.length>=2){const u=pe(n.bezierPath,o,t.project.duration);u&&(i=u.x,d=u.y)}return{x:i,y:d,scale:j(r.scale,o,n.scale||1),rotation:j(r.rotation,o,n.rotation||0),opacity:j(r.opacity,o,n.opacity??1),mask_size:j(r.mask_size,o,n.mask_size||0),rotationX:j(r.rotationX,o,n.rotationX||0),rotationY:j(r.rotationY,o,n.rotationY||0),rotationZ:j(r.rotationZ,o,n.rotationZ||0),anchorX:j(r.anchorX,o,n.anchorX||0),anchorY:j(r.anchorY,o,n.anchorY||0),perspective:j(r.perspective,o,n.perspective||1e3)}}function te(){if(W.value){Z();return}ne()}function ne(){var o;if(!S.value||!O)return;O.fillStyle="#000",O.fillRect(0,0,t.project.width,t.project.height);const n=t.layers.find(r=>r.type==="background");n&&Me(O,n),t.layers.filter(r=>r.type!=="background").forEach(r=>{Le(O,r)}),t.pathMode.enabled&&((o=t.currentLayer)!=null&&o.bezierPath)&&_e(O,t.currentLayer.bezierPath),t.extractMode.enabled&&$e(O)}function _e(n,o){if(!o||o.length===0)return;const r=t.project.width/2,i=t.project.height/2;n.save(),n.strokeStyle="#ff6b6b",n.lineWidth=2,n.setLineDash([5,5]),n.beginPath(),n.moveTo(r+o[0].x,i+o[0].y);for(let d=1;d<o.length;d++){const u=o[d-1],h=o[d],_=u.cp2x??u.x+(h.x-u.x)/3,g=u.cp2y??u.y+(h.y-u.y)/3,x=h.cp1x??u.x+(h.x-u.x)*2/3,s=h.cp1y??u.y+(h.y-u.y)*2/3;n.bezierCurveTo(r+_,i+g,r+x,i+s,r+h.x,i+h.y)}if(n.stroke(),n.setLineDash([]),o.forEach((d,u)=>{n.beginPath(),n.arc(r+d.x,i+d.y,6,0,Math.PI*2),n.fillStyle=u===0?"#4ecdc4":u===o.length-1?"#ff6b6b":"#ffe66d",n.fill(),n.strokeStyle="#fff",n.lineWidth=2,n.stroke()}),o.length>=2){const d=o.length-1,u=o[d-1],h=o[d],_=u.cp2x??u.x+(h.x-u.x)/3,g=u.cp2y??u.y+(h.y-u.y)/3,x=h.cp1x??u.x+(h.x-u.x)*2/3,s=h.cp1y??u.y+(h.y-u.y)*2/3,e=.99,a=1-e,c=3*a*a*(_-u.x)+6*a*e*(x-_)+3*e*e*(h.x-x),f=3*a*a*(g-u.y)+6*a*e*(s-g)+3*e*e*(h.y-s),p=Math.atan2(f,c),v=r+h.x,M=i+h.y,b=18;n.beginPath(),n.moveTo(v,M),n.lineTo(v-b*Math.cos(p-Math.PI/6),M-b*Math.sin(p-Math.PI/6)),n.moveTo(v,M),n.lineTo(v-b*Math.cos(p+Math.PI/6),M-b*Math.sin(p+Math.PI/6)),n.strokeStyle="#ff6b6b",n.lineWidth=2,n.stroke()}n.restore()}function ce(n,o,r){if(n.maskCanvas||!n.customMask)return;const i=new Image;i.onload=()=>{const d=document.createElement("canvas");d.width=i.width||o,d.height=i.height||r;const u=d.getContext("2d");u&&(u.drawImage(i,0,0,d.width,d.height),n.maskCanvas=d,I())},i.src=n.customMask}function Me(n,o){const r=Y(o);if(!r||r.width===0||r.height===0)return;const i=F(o);n.save(),n.globalAlpha=i.opacity;const d=o.bg_mode||"fit",u=t.project.width,h=t.project.height,_=r.width,g=r.height;let x=1;_>0&&g>0&&(d==="fit"?x=Math.min(u/_,h/g):d==="fill"?x=Math.max(u/_,h/g):d==="stretch"&&(x=Math.min(u/_,h/g))),(!Number.isFinite(x)||x<=0)&&(x=1),n.translate(u/2+i.x,h/2+i.y),n.rotate(i.rotation*Math.PI/180),n.scale(i.scale*x,i.scale*x),n.drawImage(r,-_/2,-g/2,_,g),o===t.currentLayer&&(n.strokeStyle="#3a7bc8",n.lineWidth=2/(i.scale*x),n.strokeRect(-_/2-2,-g/2-2,_+4,g+4)),n.restore()}function Le(n,o){const r=Y(o);if(!r||r.width===0||r.height===0)return;const i=F(o),d=r.width,u=r.height;if(ce(o,d,u),n.save(),n.translate(t.project.width/2+i.x,t.project.height/2+i.y),i.rotationX!==0||i.rotationY!==0){const g=i.perspective||1e3,x=i.rotationX*Math.PI/180,s=i.rotationY*Math.PI/180,e=Math.cos(x),a=Math.sin(x),c=Math.cos(s),f=Math.sin(s),p=1/(1+(f*d/2+a*u/2)/g);n.transform(c*p,a*f*p,0,e*p,0,0)}n.rotate(i.rotation*Math.PI/180),n.scale(i.scale,i.scale),n.globalAlpha=i.opacity;const h=(i.anchorX||0)*d,_=(i.anchorY||0)*u;if(o.maskCanvas){const g=document.createElement("canvas");g.width=d,g.height=u;const x=g.getContext("2d");x?(x.clearRect(0,0,d,u),x.drawImage(r,0,0,d,u),x.globalCompositeOperation="destination-in",x.drawImage(o.maskCanvas,0,0,d,u),n.drawImage(g,-d/2-h,-u/2-_,d,u)):n.drawImage(r,-d/2-h,-u/2-_,d,u)}else n.drawImage(r,-d/2-h,-u/2-_,d,u);if(o===t.currentLayer&&o.img){n.strokeStyle="#3a7bc8",n.lineWidth=2/i.scale;const g=o.img.width,x=o.img.height;n.strokeRect(-g/2-2,-x/2-2,g+4,x+4),n.fillStyle="#3a7bc8",[[-g/2,-x/2],[g/2,-x/2],[g/2,x/2],[-g/2,x/2]].forEach(([e,a])=>{n.fillRect(e-4/i.scale,a-4/i.scale,8/i.scale,8/i.scale)})}if(i.mask_size>0){n.strokeStyle="#3ac88e",n.lineWidth=2/i.scale,n.setLineDash([5/i.scale,5/i.scale]);const g=o.img?o.img.width:512,x=o.img?o.img.height:512,s=g*i.mask_size,e=x*i.mask_size;n.strokeRect(-s/2,-e/2,s,e),n.setLineDash([])}n.restore()}function he(){return W.value?N.value||null:S.value||null}function ye(n){const o=he();if(!o)return{x:0,y:0};const r=o.getBoundingClientRect(),i=t.project.width/r.width,d=t.project.height/r.height;return{x:(n.clientX-r.left)*i,y:(n.clientY-r.top)*d}}let m=!1,k=null,w=null,P=null,E=!1,C=null,Ce=!1,ie=-1;function Re(n){var i;if((i=he())==null||i.focus(),n.shiftKey,n.altKey,!t.currentLayer)return;const o=ye(n);if(t.extractMode.enabled){if(!Ie()){console.warn("[Timeline] Extract mode requires a background layer with image data");return}E=!0,Fe(o.x,o.y,n.button===2||n.altKey);return}if(t.maskMode.enabled){m=!0,Xe(),Pe(o.x,o.y);return}if(t.pathMode.enabled){Oe(o);return}X=!0,se=o.x,oe=o.y;const r=F(t.currentLayer);H=r.x,ee=r.y}function ze(n){const o=ye(n);if(t.extractMode.enabled&&E){Fe(o.x,o.y,(n.buttons&2)===2||n.altKey);return}if(m&&t.maskMode.enabled){Pe(o.x,o.y);return}if(Ce&&ie>=0){Ne(o);return}if(!X||!t.currentLayer)return;let r=o.x-se,i=o.y-oe;n.shiftKey&&(Math.abs(r)>Math.abs(i)?i=0:r=0);const d=H+r,u=ee+i;$(t.currentLayer,"x",d),$(t.currentLayer,"y",u),I()}function $(n,o,r){const i=t.currentTime;if(n.keyframes&&n.keyframes[o]&&n.keyframes[o].length>0){const d=n.keyframes[o].findIndex(u=>Math.abs(u.time-i)<.05);d>=0?n.keyframes[o][d]={time:n.keyframes[o][d].time,value:r}:(n.keyframes[o].push({time:i,value:r}),n.keyframes[o].sort((u,h)=>u.time-h.time))}t.updateLayer(t.currentLayerIndex,{[o]:r})}function Xe(){const n=t.currentLayer;if(!(!n||!n.img)){if(n.maskCanvas)k=n.maskCanvas.getContext("2d");else if(n.maskCanvas=document.createElement("canvas"),n.maskCanvas.width=n.img.width,n.maskCanvas.height=n.img.height,k=n.maskCanvas.getContext("2d"),k)if(n.customMask){const o=new Image;o.onload=()=>{k==null||k.drawImage(o,0,0),I()},o.src=n.customMask}else k.globalCompositeOperation="source-over",k.fillStyle="white",k.fillRect(0,0,n.maskCanvas.width,n.maskCanvas.height)}}function Pe(n,o){const r=t.currentLayer;if(!r||((!k||!r.maskCanvas)&&Xe(),!r.img||!k||!r.maskCanvas))return;const i=F(r),d=t.project.width/2+i.x,u=t.project.height/2+i.y,h=(n-d)/i.scale+r.img.width/2,_=(o-u)/i.scale+r.img.height/2,g=t.maskMode.brush||20;k.save(),k.beginPath(),k.arc(h,_,g,0,Math.PI*2),t.maskMode.erase?(k.globalCompositeOperation="source-over",k.fillStyle="white"):(k.globalCompositeOperation="destination-out",k.fillStyle="black"),k.fill(),k.restore(),I()}function Ie(){const n=t.layers.find(r=>r.type==="background");if(!n)return null;const o=Y(n);return o?((!w||!P||w.width!==o.width||w.height!==o.height||C!==n.id)&&(w=document.createElement("canvas"),w.width=o.width,w.height=o.height,P=w.getContext("2d"),P&&P.clearRect(0,0,o.width,o.height),C=n.id||null),{layer:n,img:o,ctx:P}):null}function Fe(n,o,r=!1){const i=Ie();if(!i)return;const{layer:d,img:u,ctx:h}=i,_=F(d),g=t.project.width/2+(_.x??0),x=t.project.height/2+(_.y??0),s=_.scale??1,e=(n-g)/s+u.width/2,a=(o-x)/s+u.height/2,c=Math.max(1,t.extractMode.brush||30);h.beginPath(),h.arc(e,a,c,0,Math.PI*2),h.fillStyle=r?"black":"white",h.fill(),I()}function $e(n){if(!t.extractMode.enabled||!w||!C)return;const o=t.layers.find(h=>h.id===C);if(!o)return;const r=Y(o);if(!r)return;const i=F(o);n.save(),n.translate(t.project.width/2+(i.x??0),t.project.height/2+(i.y??0)),n.rotate((i.rotation??0)*Math.PI/180),n.scale(i.scale??1,i.scale??1);const d=-r.width/2,u=-r.height/2;n.fillStyle="rgba(0, 0, 0, 0.65)",n.fillRect(d,u,r.width,r.height),n.globalCompositeOperation="destination-out",n.drawImage(w,d,u,r.width,r.height),n.restore()}function ve(){P&&w&&(P.clearRect(0,0,w.width,w.height),I())}function Ee(){if(!P||!w)return!1;const n=P.getImageData(0,0,w.width,w.height).data;for(let o=0;o<n.length;o+=4)if(n[o]>10)return!0;return!1}function Ke(n,o,r){const i=n.canvas,d=document.createElement("canvas");d.width=o,d.height=r;const u=d.getContext("2d");if(!u)return null;u.drawImage(i,0,0);const h=20;u.globalCompositeOperation="destination-over";for(let _=0;_<h;_++)u.drawImage(d,1,0),u.drawImage(d,-1,0),u.drawImage(d,0,1),u.drawImage(d,0,-1),_%2===0&&(u.drawImage(d,1,1),u.drawImage(d,-1,-1),u.drawImage(d,1,-1),u.drawImage(d,-1,1));for(let _=0;_<10;_++)u.drawImage(d,2,0),u.drawImage(d,-2,0),u.drawImage(d,0,2),u.drawImage(d,0,-2),u.drawImage(d,2,2),u.drawImage(d,-2,-2),u.drawImage(d,2,-2),u.drawImage(d,-2,2);return d.toDataURL("image/png")}function Ue(){const n=Ie();if(!n||!w||!P)return{error:"背景图层尚未准备好"};if(!Ee())return null;const{img:o}=n,r=document.createElement("canvas");r.width=o.width,r.height=o.height;const i=r.getContext("2d");if(!i)return{error:"无法创建临时画布"};i.drawImage(o,0,0),i.globalCompositeOperation="destination-in",i.drawImage(w,0,0);const d=r.toDataURL("image/png"),u=document.createElement("canvas");u.width=o.width,u.height=o.height;const h=u.getContext("2d");if(!h)return{error:"无法创建背景画布"};h.drawImage(o,0,0),h.globalCompositeOperation="destination-out",h.drawImage(w,0,0),h.globalCompositeOperation="source-over";const _=Ke(h,o.width,o.height)||o.src,g=w.toDataURL("image/png");return{foregroundDataUrl:d,backgroundDataUrl:_,extractMaskDataUrl:g}}function Oe(n,o){const r=t.currentLayer;if(!r)return;r.bezierPath||(r.bezierPath=[]);const i=Be(n);if(i>=0)ie=i,Ce=!0;else{const d=t.project.width/2,u=t.project.height/2;r.bezierPath.push({x:n.x-d,y:n.y-u}),r.bezierPath.length>=2&&(r.usePathAnimation=!0),I()}}function Be(n){const o=t.currentLayer;if(!o||!o.bezierPath)return-1;const r=t.project.width/2,i=t.project.height/2,d=10;for(let u=0;u<o.bezierPath.length;u++){const h=o.bezierPath[u],_=h.x+r-n.x,g=h.y+i-n.y;if(Math.sqrt(_*_+g*g)<d)return u}return-1}function Ne(n){const o=t.currentLayer;if(!o||!o.bezierPath||ie<0)return;const r=t.project.width/2,i=t.project.height/2;o.bezierPath[ie].x=n.x-r,o.bezierPath[ie].y=n.y-i,I()}function ge(){X=!1,m=!1,E=!1,Ce=!1,ie=-1}function Ye(n){if(!t.currentLayer)return;const o=n.deltaY>0?-.05:.05,r=t.currentLayer;if(n.shiftKey){const d=F(r).rotation+(o>0?5:-5);$(r,"rotation",d)}else if(n.altKey){const i=F(r),d=Math.max(0,Math.min(1,i.opacity+o));$(r,"opacity",d)}else{const i=F(r),d=Math.max(.1,Math.min(5,i.scale+o));$(r,"scale",d)}I()}function We(n){if(!t.currentLayer)return;const o=n.shiftKey?10:1,r=t.currentLayer,i=F(r);switch(n.key){case"ArrowLeft":$(r,"x",i.x-o),I(),n.preventDefault();break;case"ArrowRight":$(r,"x",i.x+o),I(),n.preventDefault();break;case"ArrowUp":$(r,"y",i.y-o),I(),n.preventDefault();break;case"ArrowDown":$(r,"y",i.y+o),I(),n.preventDefault();break;case"r":case"R":$(r,"x",0),$(r,"y",0),$(r,"scale",1),$(r,"rotation",0),$(r,"opacity",1),I(),n.preventDefault();break;case"Delete":case"Backspace":confirm("删除当前图层?")&&t.removeLayer(t.currentLayerIndex),n.preventDefault();break}}return L({clearExtractSelection:ve,applyExtractSelection:Ue}),(n,o)=>(R(),A("div",{class:"canvas-preview",ref_key:"containerRef",ref:G},[l("div",lt,[Ae(l("canvas",{ref_key:"gpuCanvasRef",ref:N,width:y(t).project.width,height:y(t).project.height,onMousedown:Re,onMousemove:ze,onMouseup:ge,onMouseleave:ge,onWheel:Q(Ye,["prevent"]),onContextmenu:o[0]||(o[0]=Q(()=>{},["prevent"])),tabindex:"0",onKeydown:We},null,40,ut),[[qe,W.value]]),Ae(l("canvas",{ref_key:"canvasRef",ref:S,width:y(t).project.width,height:y(t).project.height,onMousedown:Re,onMousemove:ze,onMouseup:ge,onMouseleave:ge,onWheel:Q(Ye,["prevent"]),onContextmenu:o[1]||(o[1]=Q(()=>{},["prevent"])),tabindex:"0",onKeydown:We},null,40,dt),[[qe,!W.value]]),l("div",ft,[y(t).currentLayer?(R(),A("span",mt,[W.value?(R(),A("span",pt,"GPU")):we("",!0),at(" Layer "+D(y(t).currentLayerIndex+1)+" | X:"+D(Math.round(y(t).currentLayer.x||0))+" Y:"+D(Math.round(y(t).currentLayer.y||0))+" S:"+D((y(t).currentLayer.scale||1).toFixed(2))+" R:"+D(Math.round(y(t).currentLayer.rotation||0))+"° ",1)])):(R(),A("span",ht,"No layer selected"))])])],512))}}),vt=Qe(yt,[["__scopeId","data-v-22fe3123"]]),gt={class:"ae-timeline-root"},kt={class:"ae-header"},bt={class:"header-center"},wt={class:"project-info"},xt={class:"ae-main"},_t={class:"ae-inspector"},Mt={key:0,class:"inspector-card"},Lt={class:"card-header"},Ct={class:"layer-title"},Pt={class:"card-subtitle"},It={key:1,class:"inspector-card empty"},Et={key:2,class:"inspector-section"},St={class:"property-list"},Tt={class:"property-row"},jt=["value"],Dt={class:"property-row"},At=["value"],Rt={class:"property-row"},zt=["value"],Xt={class:"property-row"},Ft=["value"],Yt={class:"property-row slider-row"},Wt={class:"slider-header"},$t={class:"prop-value"},Kt=["value"],Ut={class:"inspector-section"},Ot={class:"tools-grid"},Bt=["disabled"],Nt={key:0,class:"tool-settings"},Gt={class:"slider-header"},Vt={class:"prop-value"},qt={key:1,class:"tool-settings"},Zt={class:"slider-header"},Ht={class:"prop-value"},Jt={class:"inspector-section"},Qt={class:"fit-row"},en={class:"ae-viewport"},tn={class:"viewport-bar"},nn={class:"duration-text"},an={class:"time-text"},sn={class:"viewport-canvas"},on={class:"ae-timeline"},rn={class:"timeline-controls"},cn={class:"controls-center"},ln={class:"time-display"},un={class:"playback-btns"},dn={class:"controls-right"},fn=["disabled"],mn=["disabled"],pn={class:"timeline-body"},hn={class:"layers-panel"},yn={class:"layers-header"},vn=["onClick"],gn=["onClick"],kn={class:"layer-name"},bn={class:"layer-btns"},wn=["onClick"],xn=["onClick"],_n={class:"tick-text"},Mn=["onClick"],Ln=["onClick"],Cn=["onDblclick"],Pn=["title","onMousedown","onClick","onContextmenu"],De=80,In=He({__name:"TimelineApp",props:{node:{}},setup(T){const L=T,t=et(),S=z(null),N=z(),G=z(),X=z(),se=z(0);let oe="foreground",H=!1,ee=null;const W=s=>{var e,a;return(a=(e=L.node)==null?void 0:e.widgets)==null?void 0:a.find(c=>c.name===s)};function V(s,e){const a=typeof s=="number"?s:parseFloat(s);return Number.isFinite(a)?a:e}const O=z("fit"),B=me(()=>{const s=Math.max(1,t.project.fps||1);return t.project.duration||t.project.total_frames/s||0}),U=me(()=>{var c;const s=Math.max(.001,B.value||0),e=se.value||((c=X.value)==null?void 0:c.clientWidth)||0,a=e?e/s:De;return Math.max(De,a)}),xe=me(()=>{var f;const a=B.value*U.value+120,c=se.value||((f=X.value)==null?void 0:f.clientWidth)||0;return Math.max(a,c,800)});Ve(()=>t.extractMode.enabled,s=>{var e,a;s||(a=(e=S.value)==null?void 0:e.clearExtractSelection)==null||a.call(e)});function re(){var f;if(!X.value){setTimeout(re,100);return}const s=X.value.getBoundingClientRect(),e=((f=X.value.parentElement)==null?void 0:f.clientWidth)||s.width||0,a=typeof window<"u"?window.innerWidth:e,c=Math.max(e||a,800);c>0&&(se.value=c)}Je(()=>{Xe(),re(),typeof ResizeObserver<"u"&&X.value?(ee=new ResizeObserver(s=>{const e=s[0];e!=null&&e.contentRect&&(se.value=e.contentRect.width)}),ee.observe(X.value)):window.addEventListener("resize",re)});let I=!1,Z=null;const Y=z(new Set([0])),j=z(null),pe=[{key:"x",label:"X"},{key:"y",label:"Y"},{key:"scale",label:"Scl"},{key:"rotation",label:"Rot"},{key:"opacity",label:"Op"}],F=me(()=>{const s=t.currentLayer;if(!s)return{x:0,y:0,scale:1,rotation:0,opacity:1};const e=t.currentTime,a=s.keyframes||{};return{x:te(a.x,e,s.x||0),y:te(a.y,e,s.y||0),scale:te(a.scale,e,s.scale||1),rotation:te(a.rotation,e,s.rotation||0),opacity:te(a.opacity,e,s.opacity??1)}});function te(s,e,a){if(!s||s.length===0)return a;const c=[...s].sort((f,p)=>f.time-p.time);if(e<=c[0].time)return c[0].value;if(e>=c[c.length-1].time)return c[c.length-1].value;for(let f=0;f<c.length-1;f++)if(e>=c[f].time&&e<=c[f+1].time){const p=(e-c[f].time)/(c[f+1].time-c[f].time);return c[f].value+(c[f+1].value-c[f].value)*p}return a}function ne(s,e){const a=t.currentLayer;if(!a)return;const c=parseFloat(e.target.value);if(isNaN(c))return;const f=t.currentTime;if(a.keyframes&&a.keyframes[s]&&a.keyframes[s].length>0){const p=a.keyframes[s].findIndex(v=>Math.abs(v.time-f)<.05);p>=0?a.keyframes[s][p]={time:a.keyframes[s][p].time,value:c}:(a.keyframes[s].push({time:f,value:c}),a.keyframes[s].sort((v,M)=>v.time-M.time))}t.updateLayer(t.currentLayerIndex,{[s]:c})}function _e(s){const e=t.currentLayer;if(!e)return;const a=parseFloat(s.target.value);if(isNaN(a))return;const c=a/100,f=t.currentTime;if(e.keyframes&&e.keyframes.scale&&e.keyframes.scale.length>0){const p=e.keyframes.scale.findIndex(v=>Math.abs(v.time-f)<.05);p>=0?e.keyframes.scale[p]={time:e.keyframes.scale[p].time,value:c}:(e.keyframes.scale.push({time:f,value:c}),e.keyframes.scale.sort((v,M)=>v.time-M.time))}t.updateLayer(t.currentLayerIndex,{scale:c})}function ce(s){const e=Math.floor(s/60),a=Math.floor(s%60),c=Math.floor(s%1*t.project.fps);return`${e.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}:${c.toString().padStart(2,"0")}`}function Me(s,e){return!s.keyframes||!s.keyframes[e]?[]:s.keyframes[e].map(a=>({time:a.time,value:a.value}))}function Le(s){const e=[];if(!s.keyframes)return e;for(const a of pe){const c=s.keyframes[a.key];c&&c.forEach(f=>e.push({time:f.time,prop:a.key}))}return e}function he(s,e){return e==="opacity"||e==="scale"?(s*100).toFixed(0)+"%":s.toFixed(1)}function ye(s){Y.value.has(s)?Y.value.delete(s):Y.value.add(s)}function m(s){var e,a;s.hidden=!s.hidden,(a=(e=S.value)==null?void 0:e.scheduleRender)==null||a.call(e)}function k(s){if(!X.value)return 0;const e=X.value.querySelector(".tracks-content");if(!e)return 0;const a=e.getBoundingClientRect(),c=X.value.scrollLeft,f=s.clientX-a.left+c,p=U.value||De;if(f<=10)return 0;const v=f/p;return Math.max(0,Math.min(v,B.value))}function w(s){s.preventDefault(),H=!0,t.setCurrentTime(k(s));const e=c=>{H&&t.setCurrentTime(k(c))},a=()=>{H=!1,document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",e),document.addEventListener("mouseup",a)}function P(s){if(!t.currentLayer)return;const e=k(s);t.setCurrentTime(e),t.addKeyframe()}function E(s,e,a){const f=s.currentTarget.getBoundingClientRect(),p=s.clientX-f.left,v=U.value||De,M=Math.max(0,p/v),b=t.layers[e];if(!b)return;const K=b[a]??(a==="scale"||a==="opacity"?1:0);b.keyframes||(b.keyframes={}),b.keyframes[a]||(b.keyframes[a]=[]),b.keyframes[a].find(ae=>Math.abs(ae.time-M)<.05)||(b.keyframes[a].push({time:M,value:K}),b.keyframes[a].sort((ae,J)=>ae.time-J.time))}function C(s,e,a){j.value={layerIdx:s,prop:e,time:a},t.selectLayer(s),t.setCurrentTime(a)}function Ce(s,e,a){const c=j.value;return c?c.layerIdx===s&&c.prop===e&&Math.abs(c.time-a)<.01:!1}function ie(s,e,a,c){s.preventDefault(),I=!0,Z={layerIdx:e,prop:a,originalTime:c.time},C(e,a,c.time);const f=s.clientX,p=c.time,v=U.value||De,M=K=>{var Se;if(!I||!Z)return;const ae=(K.clientX-f)/v;let J=Math.max(0,p+ae);const ue=t.layers[Z.layerIdx];if((Se=ue==null?void 0:ue.keyframes)!=null&&Se[Z.prop]){const Te=ue.keyframes[Z.prop],je=Te.findIndex(ke=>Math.abs(ke.time-Z.originalTime)<.01);je>=0&&(Te[je].time=J,Z.originalTime=J,j.value.time=J,t.setCurrentTime(J))}},b=()=>{var le;I=!1,Z=null,document.removeEventListener("mousemove",M),document.removeEventListener("mouseup",b);const K=t.layers[e];(le=K==null?void 0:K.keyframes)!=null&&le[a]&&K.keyframes[a].sort((ae,J)=>ae.time-J.time)};document.addEventListener("mousemove",M),document.addEventListener("mouseup",b)}function Re(s,e,a){var f,p,v,M;const c=t.layers[s];(f=c==null?void 0:c.keyframes)!=null&&f[e]&&(c.keyframes[e]=c.keyframes[e].filter(b=>Math.abs(b.time-a)>.01),((p=j.value)==null?void 0:p.layerIdx)===s&&((v=j.value)==null?void 0:v.prop)===e&&Math.abs(((M=j.value)==null?void 0:M.time)-a)<.01&&(j.value=null))}function ze(s){if(X.value){const e=s.target,a=X.value.querySelector(".tracks-list");a&&(a.scrollTop=e.scrollTop)}}function $(s){const e=s.target,a=document.querySelector(".layers-list");a&&(a.scrollTop=e.scrollTop)}function Xe(){var K,le,ae,J,ue,Se,Te,je;if(!((K=L.node)!=null&&K.widgets))return;const s=V((le=W("width"))==null?void 0:le.value,t.project.width),e=V((ae=W("height"))==null?void 0:ae.value,t.project.height),a=Math.max(1,V((J=W("fps"))==null?void 0:J.value,t.project.fps)),c=Math.max(1,Math.round(V((ue=W("total_frames"))==null?void 0:ue.value,t.project.total_frames))),f=V((Se=W("mask_expansion"))==null?void 0:Se.value,t.project.mask_expansion),p=V((Te=W("mask_feather"))==null?void 0:Te.value,t.project.mask_feather);let v=[];const M=(je=W("layers_keyframes"))==null?void 0:je.value;if(typeof M=="string"&&M.trim())try{const ke=JSON.parse(M);Array.isArray(ke)&&(v=ke)}catch(ke){console.warn("[AE Timeline] Failed to parse layers_keyframes widget",ke)}else Array.isArray(M)&&(v=M);const b={width:s,height:e,fps:a,total_frames:c,duration:c/a,mask_expansion:f,mask_feather:p};t.loadAnimation({project:b,layers:v}),t.layers.length>0&&t.currentLayerIndex<0&&t.selectLayer(0)}function Pe(s,e){return s.name?s.name:s.type==="background"?"Background":`Layer ${e+1}`}function Ie(){const s=t.exportAnimation(),e=new Blob([JSON.stringify(s,null,2)],{type:"application/json"}),a=URL.createObjectURL(e),c=document.createElement("a");c.href=a,c.download=`ae_project_${Date.now()}.json`,c.click(),URL.revokeObjectURL(a)}function Fe(){var s;(s=G.value)==null||s.click()}function $e(s){var c;const e=(c=s.target.files)==null?void 0:c[0];if(!e)return;const a=new FileReader;a.onload=f=>{var p;try{const v=JSON.parse((p=f.target)==null?void 0:p.result);t.loadAnimation(v),console.log("Project loaded successfully")}catch(v){console.error("Failed to parse project file",v),alert("Project file is corrupted or has invalid format")}},a.readAsText(e),G.value&&(G.value.value="")}function ve(s,e){const c=(f=>{var p,v;return(v=(p=L.node)==null?void 0:p.widgets)==null?void 0:v.find(M=>M.name===f)})(s);c&&(c.value=e,c.inputEl&&(c.inputEl.value=e,c.inputEl.dispatchEvent(new Event("input"))),c.callback&&c.callback(e))}function Ee(){var c,f,p,v,M;if(!((c=L.node)!=null&&c.widgets)){console.error("[AE Timeline] Node or widgets not found!");return}console.log("[AE Timeline] Saving..."),t.layers.forEach(b=>{b.maskCanvas&&(b.customMask=b.maskCanvas.toDataURL(),console.log(`[AE Timeline] Layer ${b.id}: Saved mask (len=${b.customMask.length})`))});const s=t.exportAnimation();s.layers.forEach(b=>{b.bezierPath&&b.bezierPath.length>0&&console.log(`[AE Timeline] Layer ${b.id}: Exporting Path with ${b.bezierPath.length} points`)});const a=(b=>L.node.widgets.find(K=>K.name===b))("layers_keyframes");if(a){const b=JSON.stringify(s.layers);if(a.value=b,console.log(`[AE Timeline] Saved layers_keyframes (len=${b.length})`),a.inputEl&&(a.inputEl.value=b,a.inputEl.dispatchEvent(new Event("input"))),a.callback&&a.callback(b),L.node.widgets_values){const K=L.node.widgets.indexOf(a);K>=0&&(L.node.widgets_values[K]=b)}(p=(f=L.node).setDirtyCanvas)==null||p.call(f,!0,!1)}else console.error("[AE Timeline] Widget layers_keyframes not found!");ve("width",t.project.width),ve("height",t.project.height),ve("fps",t.project.fps),ve("total_frames",t.project.total_frames),(M=(v=L.node).setDirtyCanvas)==null||M.call(v,!0,!1)}function Ke(){Ee();const s=document.querySelector(".ae-timeline-dialog");s&&s.close()}function Ue(){t.addKeyframe()}function Oe(){t.deleteKeyframe()}function Be(){t.setCurrentTime(0)}function Ne(){t.setCurrentTime(B.value)}function ge(){if(!t.currentLayer||!confirm("纭畾瑕佹竻闄ゅ綋鍓嶅浘灞傜殑鎵€鏈夊叧閿抚鍚楋紵"))return;const s=t.currentLayer;["x","y","scale","rotation","opacity","mask_size"].forEach(a=>{var c;(c=s.keyframes)!=null&&c[a]&&(s.keyframes[a]=[])})}function Ye(){t.layers.forEach((s,e)=>{e!==t.currentLayerIndex&&(s._cachedImage&&delete s._cachedImage,console.log(`[AE Timeline] Cleared cache for layer ${s.id}`))})}function We(){var s,e;(e=(s=S.value)==null?void 0:s.scheduleRender)==null||e.call(s),console.log("[AE Timeline] Preview refreshed")}function n(){var s,e;L.node&&L.node.graph&&window.app&&((e=(s=window.app).queuePrompt)==null||e.call(s,0))}function o(s){var f,p;const e={mask:t.maskMode,path:t.pathMode,extract:t.extractMode},a=e[s],c=!a.enabled;if(s==="extract"&&c&&!t.layers.find(M=>M.type==="background")){alert("Add a background layer before using extract");return}Object.entries(e).forEach(([v,M])=>{v!==s&&(M.enabled=!1)}),(!c||s!=="extract")&&((p=(f=S.value)==null?void 0:f.clearExtractSelection)==null||p.call(f)),a.enabled=c}function r(){var s,e;(e=(s=S.value)==null?void 0:s.clearExtractSelection)==null||e.call(s)}function i(){var f,p;const s=S.value;if(!s||typeof s.applyExtractSelection!="function")return;const e=s.applyExtractSelection();if(!e){alert("Draw an extract selection first");return}if("error"in e){alert(e.error);return}const a=new Image;a.onload=()=>{const v=t.layers.filter(M=>{var b;return(b=M.id)==null?void 0:b.startsWith("extracted_")}).length;t.addLayer({id:`extracted_${Date.now()}`,name:`Extract ${v+1}`,type:"foreground",image_data:e.foregroundDataUrl,img:a,x:0,y:0,scale:1,rotation:0,opacity:1,mask_size:0,keyframes:{}})},a.src=e.foregroundDataUrl;const c=t.layers.find(v=>v.type==="background");if(c&&e.backgroundDataUrl){const v=new Image;v.onload=()=>{c.image_data=e.backgroundDataUrl,c.img=v,t.updateLayer(t.layers.indexOf(c),{image_data:e.backgroundDataUrl})},v.src=e.backgroundDataUrl}t.extractMode.enabled=!1,(p=(f=S.value)==null?void 0:f.clearExtractSelection)==null||p.call(f)}function d(){var s;oe="foreground",(s=N.value)==null||s.click()}function u(){var s;oe="background",(s=N.value)==null||s.click()}function h(s){const e=s.target.files;e&&(Array.from(e).forEach((a,c)=>{const f=new FileReader;f.onload=p=>{var b;const v=(b=p.target)==null?void 0:b.result,M=new Image;M.onload=()=>{t.addLayer({id:"uploaded_"+Date.now()+"_"+c,name:a.name.replace(/\.[^/.]+$/,""),type:oe,image_data:v,img:M,x:0,y:0,scale:1,rotation:0,opacity:1,mask_size:0,keyframes:{},bg_mode:"fit"})},M.src=v},f.readAsDataURL(a)}),N.value&&(N.value.value=""))}function _(){x(-1)}function g(){x(1)}function x(s){const e=t.currentLayerIndex;if(e<0)return;const a=e+s;if(a>=0&&a<t.layers.length){const c=t.layers[e];t.layers.splice(e,1),t.layers.splice(a,0,c),t.selectLayer(a)}}return st(()=>{ee&&X.value&&(ee.disconnect(),ee=null),window.removeEventListener("resize",re),Ee()}),(s,e)=>(R(),A("div",gt,[l("header",kt,[l("div",{class:"header-left"},[e[13]||(e[13]=l("div",{class:"logo"},[l("div",{class:"logo-icon"},"AE"),l("span",{class:"logo-text"},"AE Animator")],-1)),e[14]||(e[14]=l("div",{class:"header-divider"},null,-1)),l("button",{class:"btn btn-ghost",onClick:Ie,title:"保存工程文件"},"Save"),l("button",{class:"btn btn-ghost",onClick:Fe,title:"加载工程文件"},"Load")]),l("div",bt,[l("span",wt,D(y(t).project.width)+"x"+D(y(t).project.height)+" @ "+D(y(t).project.fps)+" FPS",1)]),l("div",{class:"header-right"},[l("button",{class:"btn btn-primary",onClick:d},"+ FG Layer"),l("button",{class:"btn btn-secondary",onClick:u},"+ BG Layer"),e[15]||(e[15]=l("div",{class:"header-divider"},null,-1)),l("button",{class:"btn btn-accent",onClick:Ee,title:"保存到节点"},"Save"),l("button",{class:"btn btn-close",onClick:Ke,title:"关闭"},"Close")])]),l("div",xt,[l("aside",_t,[y(t).currentLayer?(R(),A("div",Mt,[l("div",Lt,[l("span",Ct,D(Pe(y(t).currentLayer,y(t).currentLayerIndex)),1),l("span",{class:q(["layer-badge",y(t).currentLayer.type])},D(y(t).currentLayer.type==="background"?"BG":"FG"),3)]),l("div",Pt," Layer "+D(y(t).currentLayerIndex+1)+" - "+D(y(t).currentLayer.type==="background"?"Background":"Foreground"),1)])):(R(),A("div",It,[...e[16]||(e[16]=[l("span",null,"请选择一个图层",-1)])])),y(t).currentLayer?(R(),A("div",Et,[e[24]||(e[24]=l("div",{class:"section-title"},"Transform",-1)),l("div",St,[l("div",Tt,[e[17]||(e[17]=l("span",{class:"prop-label"},"Position X",-1)),l("input",{type:"number",class:"prop-input",value:F.value.x.toFixed(0),onInput:e[0]||(e[0]=a=>ne("x",a)),step:"1"},null,40,jt)]),l("div",Dt,[e[18]||(e[18]=l("span",{class:"prop-label"},"Position Y",-1)),l("input",{type:"number",class:"prop-input",value:F.value.y.toFixed(0),onInput:e[1]||(e[1]=a=>ne("y",a)),step:"1"},null,40,At)]),l("div",Rt,[e[19]||(e[19]=l("span",{class:"prop-label"},"Scale",-1)),l("input",{type:"number",class:"prop-input",value:(F.value.scale*100).toFixed(0),onInput:e[2]||(e[2]=a=>_e(a)),step:"1"},null,40,zt),e[20]||(e[20]=l("span",{class:"prop-unit"},"%",-1))]),l("div",Xt,[e[21]||(e[21]=l("span",{class:"prop-label"},"Rotation",-1)),l("input",{type:"number",class:"prop-input",value:F.value.rotation.toFixed(0),onInput:e[3]||(e[3]=a=>ne("rotation",a)),step:"1"},null,40,Ft),e[22]||(e[22]=l("span",{class:"prop-unit"},"deg",-1))]),l("div",Yt,[l("div",Wt,[e[23]||(e[23]=l("span",{class:"prop-label"},"Opacity",-1)),l("span",$t,D((F.value.opacity*100).toFixed(0))+"%",1)]),l("input",{type:"range",class:"prop-slider",value:F.value.opacity,onInput:e[4]||(e[4]=a=>ne("opacity",a)),min:"0",max:"1",step:"0.01"},null,40,Kt)])])])):we("",!0),l("div",Ut,[e[27]||(e[27]=l("div",{class:"section-title"},"Tools",-1)),l("div",Ot,[l("button",{class:q(["tool-btn",{active:y(t).maskMode.enabled}]),onClick:e[5]||(e[5]=a=>o("mask"))},"Mask Mode",2),l("button",{class:q(["tool-btn",{active:y(t).maskMode.enabled&&y(t).maskMode.erase}]),onClick:e[6]||(e[6]=a=>y(t).maskMode.erase=!y(t).maskMode.erase),disabled:!y(t).maskMode.enabled},"Eraser",10,Bt),l("button",{class:q(["tool-btn",{active:y(t).pathMode.enabled}]),onClick:e[7]||(e[7]=a=>o("path"))},"Path Tool",2),l("button",{class:q(["tool-btn",{active:y(t).extractMode.enabled}]),onClick:e[8]||(e[8]=a=>o("extract"))},"AI Extract",2)]),y(t).maskMode.enabled?(R(),A("div",Nt,[l("div",Gt,[e[25]||(e[25]=l("span",{class:"prop-label"},"Brush Size",-1)),l("span",Vt,D(y(t).maskMode.brush)+"px",1)]),Ae(l("input",{type:"range",class:"prop-slider","onUpdate:modelValue":e[9]||(e[9]=a=>y(t).maskMode.brush=a),min:"1",max:"100",step:"1"},null,512),[[Ze,y(t).maskMode.brush,void 0,{number:!0}]])])):we("",!0),y(t).extractMode.enabled?(R(),A("div",qt,[l("div",Zt,[e[26]||(e[26]=l("span",{class:"prop-label"},"Brush Size",-1)),l("span",Ht,D(y(t).extractMode.brush)+"px",1)]),Ae(l("input",{type:"range",class:"prop-slider","onUpdate:modelValue":e[10]||(e[10]=a=>y(t).extractMode.brush=a),min:"5",max:"150",step:"1"},null,512),[[Ze,y(t).extractMode.brush,void 0,{number:!0}]]),l("div",{class:"extract-actions"},[l("button",{class:"btn btn-small btn-primary",onClick:i},"Apply"),l("button",{class:"btn btn-small btn-ghost",onClick:r},"Clear")])])):we("",!0)]),l("div",Jt,[e[30]||(e[30]=l("div",{class:"section-title"},"Actions",-1)),l("div",{class:"action-row"},[l("button",{class:"btn btn-small btn-ghost",onClick:Ye},"Clear Cache"),l("button",{class:"btn btn-small btn-ghost",onClick:We},"Refresh"),l("button",{class:"btn btn-small btn-accent",onClick:n},"Run")]),l("div",Qt,[e[29]||(e[29]=l("span",{class:"prop-label"},"Fit Mode",-1)),Ae(l("select",{class:"fit-select","onUpdate:modelValue":e[11]||(e[11]=a=>O.value=a)},[...e[28]||(e[28]=[l("option",{value:"fit"},"Fit",-1),l("option",{value:"fill"},"Fill",-1),l("option",{value:"stretch"},"Stretch",-1)])],512),[[ot,O.value]])])])]),l("main",en,[l("div",tn,[l("span",nn,"Duration: "+D(ce(B.value)),1),l("span",an,D(ce(y(t).currentTime)),1)]),l("div",sn,[rt(vt,{ref_key:"canvasPreviewRef",ref:S,fitMode:O.value},null,8,["fitMode"])])])]),l("footer",on,[l("div",rn,[l("div",{class:"controls-left"},[l("button",{class:"btn btn-small btn-ghost",onClick:Ue},"+ Keyframe"),l("button",{class:"btn btn-small btn-ghost",onClick:Oe},"Del Key"),l("button",{class:"btn btn-small btn-ghost",onClick:ge},"Clear All")]),l("div",cn,[l("span",ln,D(ce(y(t).currentTime)),1),l("div",un,[l("button",{class:"pb-btn",onClick:Be},"|<"),l("button",{class:q(["play-btn",{playing:y(t).isPlaying}]),onClick:e[12]||(e[12]=(...a)=>y(t).togglePlayback&&y(t).togglePlayback(...a))},D(y(t).isPlaying?"Pause":"Play"),3),l("button",{class:"pb-btn",onClick:Ne},">|")])]),l("div",dn,[l("button",{class:"nav-btn",onClick:_,disabled:!y(t).currentLayer},"Up",8,fn),l("button",{class:"nav-btn",onClick:g,disabled:!y(t).currentLayer},"Down",8,mn)])]),l("div",pn,[l("div",hn,[l("div",yn,"Layers ("+D(y(t).layers.length)+")",1),l("div",{class:"layers-list",onScroll:ze},[(R(!0),A(de,null,be(y(t).layers,(a,c)=>(R(),A("div",{key:a.id,class:q(["layer-item",{active:c===y(t).currentLayerIndex}]),onClick:f=>y(t).selectLayer(c)},[l("span",{class:"expand-icon",onClick:Q(f=>ye(c),["stop"])},D(Y.value.has(c)?"v":">"),9,gn),l("span",{class:q(["layer-type",a.type])},D(a.type==="background"?"B":"F"),3),l("span",kn,D(Pe(a,c)),1),l("span",bn,[l("span",{class:q(["vis-icon",{off:a.hidden}]),onClick:Q(f=>m(a),["stop"])},"eye",10,wn),l("span",{class:"del-icon",onClick:Q(f=>y(t).removeLayer(c),["stop"])},"x",8,xn)])],10,vn))),128))],32)]),l("div",{class:"tracks-panel",ref_key:"timelineRef",ref:X},[l("div",{class:"tracks-content",style:fe({width:xe.value+"px"})},[l("div",{class:"ruler",onMousedown:w},[(R(!0),A(de,null,be(Math.ceil(B.value)+1,a=>(R(),A("div",{key:a,class:"ruler-tick",style:fe({left:(a-1)*U.value+"px"})},[l("span",_n,D(a-1)+"s",1)],4))),128)),l("div",{class:"playhead-top",style:fe({left:y(t).currentTime*U.value+"px"})},null,4)],32),l("div",{class:"tracks-list",onDblclick:P,onScroll:$},[(R(!0),A(de,null,be(y(t).layers,(a,c)=>(R(),A(de,{key:a.id},[l("div",{class:q(["track-row",{active:c===y(t).currentLayerIndex}]),onClick:f=>y(t).selectLayer(c)},[l("div",{class:q(["track-bar",a.type]),style:fe({width:B.value*U.value+"px"})},[Y.value.has(c)?we("",!0):(R(!0),A(de,{key:0},be(Le(a),f=>(R(),A("div",{key:f.time+f.prop,class:"mini-kf",style:fe({left:f.time*U.value+"px"})},null,4))),128))],6)],10,Mn),Y.value.has(c)?(R(),A(de,{key:0},be(pe,f=>l("div",{key:f.key,class:q(["prop-track-row",{active:c===y(t).currentLayerIndex}]),onClick:p=>y(t).selectLayer(c)},[l("div",{class:"prop-track",onDblclick:Q(p=>E(p,c,f.key),["stop"])},[(R(!0),A(de,null,be(Me(a,f.key),p=>(R(),A("div",{key:p.time,class:q(["keyframe-dot",{selected:Ce(c,f.key,p.time)}]),style:fe({left:p.time*U.value+"px"}),title:`${f.label}: ${he(p.value,f.key)} @ ${p.time.toFixed(2)}s`,onMousedown:Q(v=>ie(v,c,f.key,p),["stop"]),onClick:Q(v=>C(c,f.key,p.time),["stop"]),onContextmenu:Q(v=>Re(c,f.key,p.time),["prevent"])},null,46,Pn))),128))],40,Cn)],10,Ln)),64)):we("",!0)],64))),128))],32),l("div",{class:"playhead-line",style:fe({left:y(t).currentTime*U.value+"px"})},null,4)],4)],512)])]),l("input",{ref_key:"fileInput",ref:N,type:"file",accept:"image/*",multiple:"",style:{display:"none"},onChange:h},null,544),l("input",{ref_key:"projectInput",ref:G,type:"file",accept:".json",style:{display:"none"},onChange:$e},null,544)]))}}),En=Qe(In,[["__scopeId","data-v-bc98c80b"]]);function Sn(T,L){const t=it(En,{node:L.node}),S=ct();return t.use(S),t.mount(T),t}window.createTimelineApp=Sn;
