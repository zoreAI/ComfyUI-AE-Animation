var na=Object.defineProperty;var oa=(e,n,t)=>n in e?na(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t;var Q=(e,n,t)=>oa(e,typeof n!="symbol"?n+"":n,t);import{d as ia,r as Pe,c as je,q as wt,W as Zt,an as aa,al as pt,a1 as Se,ag as ra,b2 as sa,bl as Tt,bq as Ct,bi as ca,w as yt,bm as le,bn as ue,bp as i,bA as He,bo as Ne,bv as Ze,bw as nt,bE as la,bu as Oe,u as M,br as We,bs as he,bB as St,bF as Wt,bz as ua,bG as gt,bH as Nt,bI as Mt,bt as qt,bJ as ma,bC as pa,bD as da}from"./assets/_plugin-vue_export-helper.js";function kt(e){const n=Math.max(1,e.fps||1);return e.duration||e.total_frames/n}const zt=ia("timeline",()=>{const e=Pe({width:1280,height:720,fps:30,duration:5,total_frames:150,mask_expansion:0,mask_feather:0,hdr_enable:!1,hdr_exposure:0,pano_enable:!1,cam_enable:!1,cam_yaw:0,cam_pitch:0,cam_roll:0,cam_fov:90,cam_offset_x:0,cam_offset_y:0,cam_pos_x:0,cam_pos_y:0,cam_pos_z:1e3,preview_mode:"2d"}),n=Pe({}),t=Pe([]),l=Pe(-1),h=Pe(!1),g=Pe(0),j=Pe(0),R=Pe(!1),G=Pe({enabled:!1,drawing:!1,erase:!1,brush:20}),E=Pe({enabled:!1,data:null}),q=Pe({enabled:!1,drawing:!1,brush:30,blurType:"gaussian"}),z=je(()=>l.value>=0&&l.value<t.value.length?t.value[l.value]:null),$=je(()=>t.value.filter(c=>c.type==="foreground")),U=je(()=>t.value.find(c=>c.type==="background"));function ee(c){const f=Math.max(1,c.fps??e.value.fps),y=typeof c.duration=="number",C=typeof c.total_frames=="number",F={...e.value,...c,fps:f};y&&!C?F.total_frames=Math.max(1,Math.round((F.duration||0)*f)):C&&!y?(F.total_frames=Math.max(1,Math.round(F.total_frames)),F.duration=F.total_frames/f):(F.total_frames=Math.max(1,Math.round(F.total_frames||F.duration*f)),F.duration=F.duration||F.total_frames/f),Object.assign(e.value,F)}function Z(c,f,y){n.value[c]||(n.value[c]=[]);const C=n.value[c],F=C.find(k=>Math.abs(k.time-f)<.001);F?F.value=y:C.push({time:f,value:y}),C.sort((k,T)=>k.time-T.time)}function me(c,f){const y=n.value[c];y&&(n.value[c]=y.filter(C=>Math.abs(C.time-f)>.001))}function V(c,f,y){const C=n.value[c];if(!C||C.length===0)return y;const F=[...C].sort((k,T)=>k.time-T.time);if(f<=F[0].time)return F[0].value;if(f>=F[F.length-1].time)return F[F.length-1].value;for(let k=0;k<F.length-1;k++){const T=F[k],A=F[k+1];if(f>=T.time&&f<=A.time){const oe=(f-T.time)/Math.max(1e-6,A.time-T.time);return T.value+(A.value-T.value)*oe}}return y}function L(c){t.value.push({z:0,is3D:!1,rotationX:0,rotationY:0,rotationZ:0,scaleX:1,scaleY:1,scaleZ:1,anchorX:0,anchorY:0,perspective:1e3,...c}),l.value=t.value.length-1}function Ye(c){c>=0&&c<t.value.length&&(t.value.splice(c,1),l.value>=t.value.length&&(l.value=t.value.length-1))}function Te(){t.value=[],l.value=-1}function Be(c){c>=0&&c<t.value.length&&(l.value=c,h.value=!1)}function ze(){h.value=!0,l.value=-1}function De(){h.value=!1,l.value=-1}function Xe(c,f){c>=0&&c<t.value.length&&Object.assign(t.value[c],f)}function Ue(c){const f=kt(e.value);g.value=Math.max(0,Math.min(c,f)),j.value=Math.floor(g.value*e.value.fps)}function Ee(c){const f=Math.max(1,Math.round(e.value.total_frames||kt(e.value)*e.value.fps));j.value=Math.max(0,Math.min(c,f-1)),g.value=j.value/e.value.fps}let pe=null,Ge=0;function $e(){R.value=!R.value,R.value?Ve():B()}function Ve(){pe===null&&(Ge=performance.now(),_e())}function _e(){if(!R.value)return;const c=performance.now(),f=(c-Ge)/1e3;Ge=c;let y=g.value+f;const C=kt(e.value);y>=C&&(y=0),Ue(y),pe=requestAnimationFrame(_e)}function B(){pe!==null&&(cancelAnimationFrame(pe),pe=null)}function r(){R.value=!1,B(),Ue(0)}function p(c){if(!c)return;const f=c.project||{},y=f.fps||e.value.fps||30,C=f.duration??(f.total_frames?f.total_frames/Math.max(1,y):e.value.duration),F=f.total_frames??Math.max(1,Math.round((C||e.value.duration)*y));ee({width:f.width||1280,height:f.height||720,fps:y,duration:C,total_frames:F,mask_expansion:f.mask_expansion||0,mask_feather:f.mask_feather||0,hdr_enable:!!f.hdr_enable,hdr_exposure:f.hdr_exposure||0,pano_enable:!!f.pano_enable,cam_enable:f.cam_enable!==void 0?!!f.cam_enable:!!f.pano_enable,cam_yaw:f.cam_yaw||0,cam_pitch:f.cam_pitch||0,cam_roll:f.cam_roll||0,cam_fov:f.cam_fov||90,cam_offset_x:f.cam_offset_x||0,cam_offset_y:f.cam_offset_y||0,cam_pos_x:f.cam_pos_x||0,cam_pos_y:f.cam_pos_y||0,cam_pos_z:f.cam_pos_z!==void 0?f.cam_pos_z:1e3,preview_mode:f.preview_mode||"2d"}),n.value=f.project_keyframes||{},t.value=(c.layers||[]).map(k=>({id:k.id,name:k.name,type:k.type,image_data:k.image_data,x:k.x||0,y:k.y||0,z:k.z||0,scale:k.scale||1,rotation:k.rotation||0,opacity:k.opacity!==void 0?k.opacity:1,is3D:k.is3D||!1,rotationX:k.rotationX||0,rotationY:k.rotationY||0,rotationZ:k.rotationZ||0,scaleX:k.scaleX!==void 0?k.scaleX:k.scale||1,scaleY:k.scaleY!==void 0?k.scaleY:k.scale||1,scaleZ:k.scaleZ!==void 0?k.scaleZ:1,anchorX:k.anchorX||0,anchorY:k.anchorY||0,perspective:k.perspective||1e3,mask_size:k.mask_size||0,customMask:k.customMask,bezierPath:k.bezierPath,usePathAnimation:k.usePathAnimation||!1,keyframes:k.keyframes||{},bg_mode:k.bg_mode||"fit"}))}function _(){const c=z.value;if(!c)return;const f=["x","y","z","scale","rotation","opacity","mask_size","rotationX","rotationY","rotationZ","scaleX","scaleY","scaleZ","anchorX","anchorY","perspective"];c.keyframes||(c.keyframes={});for(const y of f){let C=c[y];C===void 0&&(y==="scale"||y==="opacity"?C=1:y==="perspective"?C=1e3:C=0),c.keyframes[y]||(c.keyframes[y]=[]),c.keyframes[y]=c.keyframes[y].filter(F=>F.time!==g.value),c.keyframes[y].push({time:g.value,value:C}),c.keyframes[y].sort((F,k)=>F.time-k.time)}}function v(){const c=z.value;if(!c||!c.keyframes)return;const f=["x","y","z","scale","rotation","opacity","mask_size","rotationX","rotationY","rotationZ","scaleX","scaleY","scaleZ","anchorX","anchorY","perspective"];for(const y of f)c.keyframes[y]&&(c.keyframes[y]=c.keyframes[y].filter(C=>C.time!==g.value))}function P(){const c=z.value;c&&(c.keyframes={})}function x(){return{project:{...e.value,project_keyframes:n.value},layers:t.value.map(c=>({id:c.id,name:c.name,type:c.type,image_data:c.image_data,x:c.x,y:c.y,z:c.z||0,scale:c.scale,rotation:c.rotation,opacity:c.opacity,is3D:c.is3D||!1,rotationX:c.rotationX,rotationY:c.rotationY,rotationZ:c.rotationZ,scaleX:c.scaleX,scaleY:c.scaleY,scaleZ:c.scaleZ,anchorX:c.anchorX,anchorY:c.anchorY,perspective:c.perspective,mask_size:c.mask_size,customMask:c.customMask,bezierPath:c.bezierPath,usePathAnimation:c.usePathAnimation,keyframes:c.keyframes,bg_mode:c.bg_mode}))}}return{project:e,layers:t,currentLayerIndex:l,cameraSelected:h,currentTime:g,currentFrame:j,isPlaying:R,maskMode:G,pathMode:E,extractMode:q,projectKeyframes:n,currentLayer:z,foregroundLayers:$,backgroundLayer:U,setProject:ee,addLayer:L,removeLayer:Ye,clearLayers:Te,selectLayer:Be,selectCameraLayer:ze,deselectAll:De,updateLayer:Xe,setCurrentTime:Ue,setCurrentFrame:Ee,togglePlayback:$e,stopPlayback:r,addKeyframe:_,deleteKeyframe:v,clearAllKeyframes:P,setProjectKeyframe:Z,deleteProjectKeyframe:me,interpolateProjectValue:V,loadAnimation:p,exportAnimation:x}});class fa{constructor(n,t=100){Q(this,"cache",new Map);Q(this,"device");Q(this,"maxCacheSize");this.device=n,this.maxCacheSize=t}loadImage(n,t){if(this.cache.has(n)){const g=this.cache.get(n);return g.lastUsed=Date.now(),g.refCount++,g.texture}this.evictLRU();const l=this.createTextureFromImage(t),h=l.createView();return this.cache.set(n,{texture:l,view:h,lastUsed:Date.now(),refCount:1,width:t.width,height:t.height}),l}getView(n){const t=this.cache.get(n);return t?(t.lastUsed=Date.now(),t.view):null}createTextureFromImage(n){const t=this.device.createTexture({size:[n.width,n.height],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});return this.device.queue.copyExternalImageToTexture({source:n},{texture:t},[n.width,n.height]),t}release(n){const t=this.cache.get(n);t&&(t.refCount--,t.refCount<=0&&(t.texture.destroy(),this.cache.delete(n)))}evictLRU(){if(this.cache.size<this.maxCacheSize)return;let n=null,t=1/0;for(const[l,h]of this.cache)h.refCount===0&&h.lastUsed<t&&(t=h.lastUsed,n=l);n?(this.cache.get(n).texture.destroy(),this.cache.delete(n),console.log(`[TextureCache] Evicted texture: ${n}`)):console.warn("[TextureCache] Cache full but no textures can be evicted")}has(n){return this.cache.has(n)}getStats(){let n=0,t=0;for(const l of this.cache.values())n+=l.refCount,l.refCount>0&&t++;return{size:this.cache.size,maxSize:this.maxCacheSize,activeTextures:t,totalRefCount:n}}cleanup(){for(const[n,t]of this.cache)t.texture.destroy();this.cache.clear(),console.log("[TextureCache] Cleaned up all textures")}evict(n){const t=this.cache.get(n);return t&&t.refCount===0?(t.texture.destroy(),this.cache.delete(n),!0):!1}setMaxCacheSize(n){for(this.maxCacheSize=n;this.cache.size>this.maxCacheSize;)this.evictLRU()}}class ha{constructor(n=60){Q(this,"frameTimes",[]);Q(this,"lastFrameTime",0);Q(this,"frameCount",0);Q(this,"droppedFrames",0);Q(this,"startTime",0);Q(this,"maxSamples",60);this.maxSamples=n,this.startTime=performance.now()}startFrame(){this.lastFrameTime=performance.now()}endFrame(){const t=performance.now()-this.lastFrameTime;this.frameTimes.push(t),this.frameTimes.length>this.maxSamples&&this.frameTimes.shift(),this.frameCount++,t>16.67&&this.droppedFrames++}getStats(){if(this.frameTimes.length===0)return{fps:0,frameTime:0,avgFrameTime:0,minFrameTime:0,maxFrameTime:0,totalFrames:0,droppedFrames:0};const n=this.frameTimes.reduce((g,j)=>g+j,0)/this.frameTimes.length,t=Math.min(...this.frameTimes),l=Math.max(...this.frameTimes),h=1e3/n;return{fps:Math.round(h*10)/10,frameTime:Math.round(this.frameTimes[this.frameTimes.length-1]*100)/100,avgFrameTime:Math.round(n*100)/100,minFrameTime:Math.round(t*100)/100,maxFrameTime:Math.round(l*100)/100,totalFrames:this.frameCount,droppedFrames:this.droppedFrames}}reset(){this.frameTimes=[],this.frameCount=0,this.droppedFrames=0,this.startTime=performance.now()}getFormattedStats(){const n=this.getStats();return`FPS: ${n.fps} | Frame: ${n.frameTime}ms | Avg: ${n.avgFrameTime}ms | Dropped: ${n.droppedFrames}`}isPerformanceGood(){return this.getStats().fps>=55}isPerformanceAcceptable(){return this.getStats().fps>=30}}const Ht=`
struct LayerUniforms {
  opacity: f32,
}

struct VertexOutput {
  @builtin(position) position: vec4<f32>,
  @location(0) uv: vec2<f32>,
  @location(1) opacity: f32,
}

@group(0) @binding(0) var<uniform> uniforms: LayerUniforms;

@vertex
fn vs(@location(0) pos: vec2<f32>, @location(1) uv: vec2<f32>) -> VertexOutput {
  var output: VertexOutput;
  output.position = vec4<f32>(pos, 0.0, 1.0);
  output.uv = uv;
  output.opacity = uniforms.opacity;
  return output;
}
`,Jt=`
struct VertexOutput {
  @builtin(position) position: vec4<f32>,
  @location(0) uv: vec2<f32>,
  @location(1) opacity: f32,
}

@group(1) @binding(0) var layerTexture: texture_2d<f32>;
@group(1) @binding(1) var layerSampler: sampler;

@fragment
fn fs(input: VertexOutput) -> @location(0) vec4<f32> {
  var color = textureSample(layerTexture, layerSampler, input.uv);
  
  // Apply opacity
  color.a *= input.opacity;
  
  // Return premultiplied alpha
  return vec4<f32>(color.rgb * color.a, color.a);
}
`,va=`
struct PanoramaUniforms {
  yaw: f32,
  pitch: f32,
  roll: f32,
  fov: f32,
  aspectRatio: f32,
  padding: f32,
  screenSize: vec2<f32>,
}

struct VertexOutput {
  @builtin(position) position: vec4<f32>,
  @location(0) uv: vec2<f32>,
  @location(1) opacity: f32,
}

@group(0) @binding(0) var<uniform> uniforms: PanoramaUniforms;
@group(1) @binding(0) var panoTexture: texture_2d<f32>;
@group(1) @binding(1) var panoSampler: sampler;

fn screenToRay(screenPos: vec2<f32>) -> vec3<f32> {
  // Convert screen position to normalized coordinates [-1, 1]
  // 与Canvas 2D一致: nx = (xPix + 0.5) / prevW * 2 - 1
  let nx = (screenPos.x / uniforms.screenSize.x) * 2.0 - 1.0;
  // Canvas 2D: ny = (yPix + 0.5) / prevH * 2 - 1
  let ny = (screenPos.y / uniforms.screenSize.y) * 2.0 - 1.0;
  
  // Calculate ray direction based on FOV
  // 与Canvas 2D一致: vx = nx * tanHalfFov * aspect, vy = -ny * tanHalfFov
  // Clamp FOV to valid range [10, 170] degrees (与Canvas 2D一致)
  let fovClamped = clamp(uniforms.fov, 10.0, 170.0);
  let tanHalfFov = tan(fovClamped * 0.5 * 0.01745329); // deg to rad
  let vx = nx * tanHalfFov * uniforms.aspectRatio;
  let vy = -ny * tanHalfFov;
  let vz = 1.0;
  
  // Normalize ray
  let len = sqrt(vx * vx + vy * vy + vz * vz);
  return vec3<f32>(vx / len, vy / len, vz / len);
}

fn applyCameraRotation(ray: vec3<f32>) -> vec3<f32> {
  // Convert degrees to radians
  let yawRad = uniforms.yaw * 0.01745329;
  let pitchRad = uniforms.pitch * 0.01745329;
  let rollRad = uniforms.roll * 0.01745329;
  
  // Build rotation components - 与Canvas 2D完全一致的顺序
  let cy = cos(yawRad);
  let sy = sin(yawRad);
  let cp = cos(pitchRad);
  let sp = sin(pitchRad);
  let cr = cos(rollRad);
  let sr = sin(rollRad);
  
  var vx = ray.x;
  var vy = ray.y;
  var vz = ray.z;
  
  // Apply Yaw (Y轴旋转) - 与Canvas 2D一致
  var tx = cy * vx + sy * vz;
  var tz = -sy * vx + cy * vz;
  vx = tx;
  vz = tz;
  
  // Apply Pitch (X轴旋转) - 与Canvas 2D一致
  var ty = cp * vy - sp * vz;
  tz = sp * vy + cp * vz;
  vy = ty;
  vz = tz;
  
  // Apply Roll (Z轴旋转) - 与Canvas 2D一致
  tx = cr * vx - sr * vy;
  ty = sr * vx + cr * vy;
  vx = tx;
  vy = ty;
  
  return vec3<f32>(vx, vy, vz);
}

fn rayToEquirectangular(ray: vec3<f32>) -> vec2<f32> {
  // Convert ray to spherical coordinates - 与Canvas 2D完全一致
  let lon = atan2(ray.x, ray.z);
  let lat = asin(clamp(ray.y, -1.0, 1.0));
  
  // Map to UV coordinates [0, 1] - 与Canvas 2D的映射一致
  // Canvas 2D: u = ((lon / (Math.PI * 2)) + 0.5) * imgW
  //            v = ((0.5 - (lat / Math.PI))) * imgH
  let u = (lon / (3.14159265 * 2.0)) + 0.5;
  let v = 0.5 - (lat / 3.14159265);  // 与Canvas 2D一致
  
  return vec2<f32>(u, v);
}

@vertex
fn vs(@location(0) pos: vec2<f32>, @location(1) uv: vec2<f32>) -> VertexOutput {
  var output: VertexOutput;
  output.position = vec4<f32>(pos, 0.0, 1.0);
  output.uv = uv;
  output.opacity = 1.0;
  return output;
}

@fragment
fn fs(input: VertexOutput) -> @location(0) vec4<f32> {
  // Convert screen position to ray direction
  var ray = screenToRay(input.position.xy);
  
  // Apply camera rotation
  ray = applyCameraRotation(ray);
  
  // Convert ray to equirectangular UV
  let uv = rayToEquirectangular(ray);
  
  // Sample panorama texture
  var color = textureSample(panoTexture, panoSampler, uv);
  
  // Return with full opacity (panorama should be opaque)
  return vec4<f32>(color.rgb, 1.0);
}
`,Qt=`
struct LayerUniforms {
  opacity: f32,
  // Camera rotation matrix (3x3, stored as 3 vec4s for alignment)
  rotationRow0: vec4<f32>,  // [r00, r01, r02, padding]
  rotationRow1: vec4<f32>,  // [r10, r11, r12, padding]
  rotationRow2: vec4<f32>,  // [r20, r21, r22, padding]
}

struct VertexOutput {
  @builtin(position) position: vec4<f32>,
  @location(0) uv: vec2<f32>,
  @location(1) opacity: f32,
}

@group(0) @binding(0) var<uniform> uniforms: LayerUniforms;

@vertex
fn vs(@location(0) pos: vec2<f32>, @location(1) uv: vec2<f32>) -> VertexOutput {
  // Apply camera rotation to vertex position
  // Extract rotation matrix
  let r00 = uniforms.rotationRow0.x;
  let r01 = uniforms.rotationRow0.y;
  let r02 = uniforms.rotationRow0.z;
  let r10 = uniforms.rotationRow1.x;
  let r11 = uniforms.rotationRow1.y;
  let r12 = uniforms.rotationRow1.z;
  let r20 = uniforms.rotationRow2.x;
  let r21 = uniforms.rotationRow2.y;
  let r22 = uniforms.rotationRow2.z;
  
  // Apply rotation (pos is already in NDC space)
  let rotatedX = r00 * pos.x + r01 * pos.y;
  let rotatedY = r10 * pos.x + r11 * pos.y;
  
  var output: VertexOutput;
  output.position = vec4<f32>(rotatedX, rotatedY, 0.0, 1.0);
  output.uv = uv;
  output.opacity = uniforms.opacity;
  return output;
}
`,ea=`
struct VertexOutput {
  @builtin(position) position: vec4<f32>,
  @location(0) uv: vec2<f32>,
  @location(1) opacity: f32,
}

@group(1) @binding(0) var layerTexture: texture_2d<f32>;
@group(1) @binding(1) var layerSampler: sampler;

@fragment
fn fs(input: VertexOutput) -> @location(0) vec4<f32> {
  var color = textureSample(layerTexture, layerSampler, input.uv);
  
  // Apply opacity
  color.a *= input.opacity;
  
  // Return premultiplied alpha
  return vec4<f32>(color.rgb * color.a, color.a);
}
`;class ya{constructor(n){Q(this,"device");Q(this,"presentationFormat");Q(this,"width");Q(this,"height");Q(this,"enableCameraRotation",!1);Q(this,"backgroundPipeline",null);Q(this,"foregroundPipeline",null);Q(this,"panoramaPipeline",null);Q(this,"overlayPipeline",null);Q(this,"advancedBackgroundPipeline",null);Q(this,"advancedForegroundPipeline",null);Q(this,"useAdvancedTransforms",!1);Q(this,"uniformBindGroupLayout",null);Q(this,"textureBindGroupLayout",null);Q(this,"overlayBindGroupLayout",null);Q(this,"uniformBuffer",null);Q(this,"panoUniformBuffer",null);Q(this,"quadVertexBuffer",null);Q(this,"indexBuffer",null);Q(this,"textureCache");Q(this,"sampler",null);Q(this,"performanceMonitor");Q(this,"lastUniformData",null);Q(this,"uniformsDirty",!0);Q(this,"lastCameraState",null);Q(this,"lastLayerProps",new Map);Q(this,"currentDuration",5);Q(this,"panoSampler",null);Q(this,"tempBuffers",[]);this.device=n.device,this.presentationFormat=n.presentationFormat,this.width=n.width,this.height=n.height,this.useAdvancedTransforms=n.useAdvancedTransforms??!1,this.textureCache=new fa(this.device),this.performanceMonitor=new ha,this.initialize(),console.log("[GPUTimelineRenderer] Advanced transforms:",this.useAdvancedTransforms?"ENABLED":"DISABLED")}initialize(){this.createBindGroupLayouts(),this.createBuffers(),this.createSampler(),this.createPanoSampler(),this.createPipelines()}createBindGroupLayouts(){this.uniformBindGroupLayout=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]}),this.textureBindGroupLayout=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),this.overlayBindGroupLayout=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]})}createBuffers(){this.uniformBuffer=this.device.createBuffer({size:256,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.panoUniformBuffer=this.device.createBuffer({size:256,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const n=new Float32Array([-1,-1,0,1,1,-1,1,1,1,1,1,0,-1,1,0,0]);this.quadVertexBuffer=this.device.createBuffer({size:n.byteLength,usage:GPUBufferUsage.VERTEX,mappedAtCreation:!0}),new Float32Array(this.quadVertexBuffer.getMappedRange()).set(n),this.quadVertexBuffer.unmap();const t=new Uint16Array([0,1,2,0,2,3]);this.indexBuffer=this.device.createBuffer({size:t.byteLength,usage:GPUBufferUsage.INDEX,mappedAtCreation:!0}),new Uint16Array(this.indexBuffer.getMappedRange()).set(t),this.indexBuffer.unmap()}createSampler(){this.sampler=this.device.createSampler({magFilter:"linear",minFilter:"linear",mipmapFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"})}createPanoSampler(){this.panoSampler=this.device.createSampler({magFilter:"linear",minFilter:"linear",mipmapFilter:"linear",addressModeU:"repeat",addressModeV:"clamp-to-edge"})}createPipelines(){const n=this.device.createPipelineLayout({bindGroupLayouts:[this.uniformBindGroupLayout,this.textureBindGroupLayout]}),t={arrayStride:16,attributes:[{shaderLocation:0,offset:0,format:"float32x2"},{shaderLocation:1,offset:8,format:"float32x2"}]},l={color:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}};this.backgroundPipeline=this.device.createRenderPipeline({layout:n,vertex:{module:this.device.createShaderModule({code:Ht}),entryPoint:"vs",buffers:[t]},fragment:{module:this.device.createShaderModule({code:Jt}),entryPoint:"fs",targets:[{format:this.presentationFormat,blend:l}]},primitive:{topology:"triangle-list",cullMode:"none"}}),this.foregroundPipeline=this.device.createRenderPipeline({layout:n,vertex:{module:this.device.createShaderModule({code:Ht}),entryPoint:"vs",buffers:[t]},fragment:{module:this.device.createShaderModule({code:Jt}),entryPoint:"fs",targets:[{format:this.presentationFormat,blend:l}]},primitive:{topology:"triangle-list",cullMode:"none"}});const h=this.device.createShaderModule({code:va});this.panoramaPipeline=this.device.createRenderPipeline({layout:n,vertex:{module:h,entryPoint:"vs",buffers:[t]},fragment:{module:h,entryPoint:"fs",targets:[{format:this.presentationFormat,blend:l}]},primitive:{topology:"triangle-list",cullMode:"none"}});const g=`
      @group(0) @binding(0) var<uniform> overlayColor: vec4<f32>;
      
      struct VertexOutput {
        @builtin(position) position: vec4<f32>,
        @location(0) uv: vec2<f32>
      }
      
      @vertex
      fn vs(@location(0) pos: vec2<f32>, @location(1) uv: vec2<f32>) -> VertexOutput {
        return VertexOutput(vec4<f32>(pos, 0.0, 1.0), uv);
      }
      
      @fragment
      fn fs(input: VertexOutput) -> @location(0) vec4<f32> {
        return overlayColor;
      }
    `,j=this.device.createPipelineLayout({bindGroupLayouts:[this.overlayBindGroupLayout]});this.overlayPipeline=this.device.createRenderPipeline({layout:j,vertex:{module:this.device.createShaderModule({code:g}),entryPoint:"vs",buffers:[t]},fragment:{module:this.device.createShaderModule({code:g}),entryPoint:"fs",targets:[{format:this.presentationFormat,blend:l}]},primitive:{topology:"triangle-list",cullMode:"none"}}),this.useAdvancedTransforms&&(this.advancedBackgroundPipeline=this.device.createRenderPipeline({layout:n,vertex:{module:this.device.createShaderModule({code:Qt}),entryPoint:"vs",buffers:[t]},fragment:{module:this.device.createShaderModule({code:ea}),entryPoint:"fs",targets:[{format:this.presentationFormat,blend:l}]},primitive:{topology:"triangle-list",cullMode:"none"}}),this.advancedForegroundPipeline=this.device.createRenderPipeline({layout:n,vertex:{module:this.device.createShaderModule({code:Qt}),entryPoint:"vs",buffers:[t]},fragment:{module:this.device.createShaderModule({code:ea}),entryPoint:"fs",targets:[{format:this.presentationFormat,blend:l}]},primitive:{topology:"triangle-list",cullMode:"none"}}),console.log("[GPUTimelineRenderer] Advanced pipelines created")),console.log("[GPUTimelineRenderer] Pipelines created successfully")}renderFrame(n,t,l,h,g=5){if(this.currentDuration=g,this.performanceMonitor.startFrame(),!this.backgroundPipeline||!this.foregroundPipeline){console.warn("[GPUTimelineRenderer] Pipelines not initialized");return}this.tempBuffers=[];const j=this.device.createCommandEncoder();j.beginRenderPass({colorAttachments:[{view:h,loadOp:"clear",clearValue:{r:0,g:0,b:0,a:1},storeOp:"store"}]}).end();const G=n.find(U=>U.type==="background");if(G&&G.img){const U=this.getLayerProps(G,t);if(l.panorama&&G.img.width>0&&G.img.height>0)this.renderPanoramaLayer(j,G,l,h);else{const Z=this.useAdvancedTransforms&&this.advancedBackgroundPipeline?this.advancedBackgroundPipeline:this.backgroundPipeline;this.renderLayerInternal(j,G,U,l,h,Z)}}const E=n.filter(U=>U.type!=="background"),q=this.cullLayers(E,t,l),z=[],$=[];for(const U of q)U.maskCanvas?$.push(U):z.push(U);for(const U of z)if(U.img){const ee=this.getLayerProps(U,t),Z=this.useAdvancedTransforms&&this.advancedForegroundPipeline?this.advancedForegroundPipeline:this.foregroundPipeline;this.renderLayerInternal(j,U,ee,l,h,Z)}for(const U of $)if(U.img){const ee=this.getLayerProps(U,t);this.renderLayerWithMask(j,U,ee,l,h)}this.device.queue.submit([j.finish()]);for(const U of this.tempBuffers)U.destroy();this.tempBuffers=[],this.performanceMonitor.endFrame()}cullLayers(n,t,l){const h=[];for(const g of n){if(!g.img)continue;const j=this.getLayerProps(g,t);if(j.opacity<=.001||Math.abs(j.scale)<.001)continue;const R=l.enabled?Math.max(.2,Math.min(4,1/(1+l.position.z*.001))):1,G=1/Math.max(.1,1+j.z*.001),E=j.scale*R*G,q=(g.img.width||0)*E,z=(g.img.height||0)*E,$=Math.max(q,z)*1.5,U=j.x+(l.enabled?l.offset.x:0),ee=j.y+(l.enabled?l.offset.y:0);U+$<0||U-$>this.width||ee+$<0||ee-$>this.height||h.push(g)}return h}getPerformanceStats(){return this.performanceMonitor.getStats()}resetPerformanceStats(){this.performanceMonitor.reset()}getLayerProps(n,t){const l=`${n.id}_${t}`,h=this.lastLayerProps.get(l);if(h&&!n.keyframes&&!n.usePathAnimation)return h;const g=n.keyframes||{};let j=this.interpolateValue(g.x,t,n.x),R=this.interpolateValue(g.y,t,n.y);if(n.usePathAnimation&&n.bezierPath&&n.bezierPath.length>=2){const E=this.interpolateBezierPath(n.bezierPath,t,this.currentDuration);E&&(j=E.x,R=E.y)}const G={x:j,y:R,z:this.interpolateValue(g.z,t,n.z),scale:this.interpolateValue(g.scale,t,n.scale),rotation:this.interpolateValue(g.rotation,t,n.rotation),rotationX:this.interpolateValue(g.rotationX,t,n.rotationX),rotationY:this.interpolateValue(g.rotationY,t,n.rotationY),rotationZ:this.interpolateValue(g.rotationZ,t,n.rotationZ),opacity:this.interpolateValue(g.opacity,t,n.opacity??1),anchorX:this.interpolateValue(g.anchorX,t,n.anchorX),anchorY:this.interpolateValue(g.anchorY,t,n.anchorY),perspective:this.interpolateValue(g.perspective,t,n.perspective),mask_size:this.interpolateValue(g.mask_size,t,n.mask_size)};if(this.lastLayerProps.set(l,G),this.lastLayerProps.size>100){const E=this.lastLayerProps.keys().next().value;E&&this.lastLayerProps.delete(E)}return G}interpolateValue(n,t,l){if(!n||n.length===0)return l;const h=[...n].sort((g,j)=>g.time-j.time);if(t<=h[0].time)return h[0].value;if(t>=h[h.length-1].time)return h[h.length-1].value;for(let g=0;g<h.length-1;g++)if(t>=h[g].time&&t<=h[g+1].time){const j=(t-h[g].time)/(h[g+1].time-h[g].time);return h[g].value+(h[g+1].value-h[g].value)*j}return l}interpolateBezierPath(n,t,l){if(!n||n.length<2)return null;const h=t/l,j=n.length-1,R=Math.min(Math.floor(h*j),j-1),G=h*j-R,E=n[R],q=n[R+1];if(!E||!q)return null;const z=E.cp2x??E.x+(q.x-E.x)/3,$=E.cp2y??E.y+(q.y-E.y)/3,U=q.cp1x??E.x+(q.x-E.x)*2/3,ee=q.cp1y??E.y+(q.y-E.y)*2/3,Z=1-G,me=Z*Z,V=me*Z,L=G*G,Ye=L*G;return{x:V*E.x+3*me*G*z+3*Z*L*U+Ye*q.x,y:V*E.y+3*me*G*$+3*Z*L*ee+Ye*q.y}}calculateBackgroundScale(n,t,l){if(!n.img||n.type!=="background")return 1;const h=n.img.width,g=n.img.height;if(h===0||g===0)return 1;switch(n.bg_mode||"fit"){case"fit":return Math.min(t/h,l/g);case"fill":return Math.max(t/h,l/g);case"stretch":return Math.min(t/h,l/g);default:return 1}}renderPanoramaLayer(n,t,l,h){if(!t.img||!this.panoramaPipeline)return;const g=t.id;let j;try{j=this.textureCache.loadImage(g,t.img)}catch(V){console.error("[GPUTimelineRenderer] Failed to load panorama texture:",V);return}const R=Math.max(1,this.width),G=Math.max(1,this.height),E=R/G,q=Math.min(170,Math.max(10,l.fov||90)),z=new ArrayBuffer(256),$=new Float32Array(z);let U=0;$[U++]=l.rotation.yaw||0,$[U++]=l.rotation.pitch||0,$[U++]=l.rotation.roll||0,$[U++]=q,$[U++]=E,$[U++]=0,$[U++]=R,$[U++]=G,this.device.queue.writeBuffer(this.panoUniformBuffer,0,z);const ee=this.device.createBindGroup({layout:this.uniformBindGroupLayout,entries:[{binding:0,resource:{buffer:this.panoUniformBuffer}}]}),Z=this.device.createBindGroup({layout:this.textureBindGroupLayout,entries:[{binding:0,resource:j.createView()},{binding:1,resource:this.panoSampler}]}),me=n.beginRenderPass({colorAttachments:[{view:h,loadOp:"load",storeOp:"store"}]});me.setPipeline(this.panoramaPipeline),me.setBindGroup(0,ee),me.setBindGroup(1,Z),me.setVertexBuffer(0,this.quadVertexBuffer),me.setIndexBuffer(this.indexBuffer,"uint16"),me.drawIndexed(6),me.end()}renderLayerInternal(n,t,l,h,g,j){if(!t.img)return;const R=t.id;let G;try{G=this.textureCache.loadImage(R,t.img)}catch(H){console.error(`[GPUTimelineRenderer] Failed to load texture for layer ${t.id}:`,H);return}const E=h.offset.x,q=h.offset.y,z=h.panorama,$=h.enabled,U=1/Math.max(.1,1+l.z*.001),ee=h.position.z,Z=$&&!z?Math.max(.1,Math.min(10,1e3/Math.max(100,ee))):1;let me=1;t.type==="background"&&(me=this.calculateBackgroundScale(t,this.width,this.height));const V=l.scale*me*U*Z,L=t.img.width,Ye=t.img.height,Te=this.width/2,Be=this.height/2;let ze=l.x,De=l.y;if(t.type==="background"&&$&&!z){const H=h.rotation.yaw,re=h.rotation.pitch,ne=Math.max(10,Math.min(170,h.fov||90)),de=h.position.x,Ce=h.position.y;if(ze-=de,De-=Ce,H!==0||re!==0){const Me=H*Math.PI/180,ye=re*Math.PI/180,Le=Math.tan(ne*Math.PI/180/2),be=this.width/(2*Le);ze+=Math.tan(Me)*be,De+=Math.tan(ye)*be}}if(t.type!=="background"&&($||z)){const H=h.rotation.yaw,re=h.rotation.pitch,ne=Math.max(10,Math.min(170,h.fov||90)),de=h.position.x,Ce=h.position.y;if(z||(ze-=de,De-=Ce),H!==0||re!==0){const Me=H*Math.PI/180,ye=re*Math.PI/180,Le=Math.tan(ne*Math.PI/180/2),be=this.width/(2*Le);z?(ze-=Math.tan(Me)*be,De-=Math.tan(ye)*be):(ze+=Math.tan(Me)*be,De+=Math.tan(ye)*be)}}const Xe=Te+ze+E,Ue=Be+De+q,Ee=L*V,pe=Ye*V,Ge=(l.rotationX||0)*Math.PI/180,$e=(l.rotationY||0)*Math.PI/180,Ve=(l.rotationZ||l.rotation||0)*Math.PI/180,_e=l.perspective||1e3,B=Ee/2,r=pe/2,p=[{x:-B,y:r,z:0},{x:B,y:r,z:0},{x:B,y:-r,z:0},{x:-B,y:-r,z:0}],_=Math.cos(Ge),v=Math.sin(Ge),P=Math.cos($e),x=Math.sin($e),c=Math.cos(Ve),f=Math.sin(Ve),y=p.map(H=>{let re=H.x*c-H.y*f,ne=H.x*f+H.y*c,de=H.z;const Ce=re*P+de*x;de=-re*x+de*P,re=Ce;const Me=ne*_-de*v;de=ne*v+de*_,ne=Me;const ye=_e/(_e+de);return{x:re*ye,y:ne*ye}}),C=new Float32Array([(Xe+y[0].x)/this.width*2-1,1-(Ue+y[0].y)/this.height*2,0,1,(Xe+y[1].x)/this.width*2-1,1-(Ue+y[1].y)/this.height*2,1,1,(Xe+y[2].x)/this.width*2-1,1-(Ue+y[2].y)/this.height*2,1,0,(Xe+y[3].x)/this.width*2-1,1-(Ue+y[3].y)/this.height*2,0,0]),F=this.device.createBuffer({size:C.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});this.device.queue.writeBuffer(F,0,C),this.tempBuffers.push(F);const k=new ArrayBuffer(256),T=new Float32Array(k);let A=0;if(T[A++]=l.opacity,this.useAdvancedTransforms&&h.enabled){const H=h.rotation.yaw*Math.PI/180,re=h.rotation.pitch*Math.PI/180,ne=h.rotation.roll*Math.PI/180,de=Math.cos(H),Ce=Math.sin(H),Me=Math.cos(re),ye=Math.sin(re),Le=Math.cos(ne),be=Math.sin(ne),m=Le*de+be*ye*Ce,d=be*Me,w=Le*-Ce+be*ye*de,I=-be*de+Le*ye*Ce,D=Le*Me,S=-be*-Ce+Le*ye*de,W=Me*Ce,K=-ye,Y=Me*de;T[A++]=m,T[A++]=d,T[A++]=w,T[A++]=0,T[A++]=I,T[A++]=D,T[A++]=S,T[A++]=0,T[A++]=W,T[A++]=K,T[A++]=Y,T[A++]=0}else T[A++]=1,T[A++]=0,T[A++]=0,T[A++]=0,T[A++]=0,T[A++]=1,T[A++]=0,T[A++]=0,T[A++]=0,T[A++]=0,T[A++]=1,T[A++]=0;this.device.queue.writeBuffer(this.uniformBuffer,0,k);const oe=this.device.createBindGroup({layout:this.uniformBindGroupLayout,entries:[{binding:0,resource:{buffer:this.uniformBuffer}}]}),ve=this.device.createBindGroup({layout:this.textureBindGroupLayout,entries:[{binding:0,resource:G.createView()},{binding:1,resource:this.sampler}]}),ie=n.beginRenderPass({colorAttachments:[{view:g,loadOp:"load",storeOp:"store"}]});ie.setPipeline(j),ie.setBindGroup(0,oe),ie.setBindGroup(1,ve),ie.setVertexBuffer(0,F),ie.setIndexBuffer(this.indexBuffer,"uint16"),ie.drawIndexed(6),ie.end()}renderLayer(n,t,l){const h=this.device.createCommandEncoder(),g=n.type==="background"?this.backgroundPipeline:this.foregroundPipeline,j={enabled:!1,position:{x:0,y:0,z:0},offset:{x:0,y:0},rotation:{yaw:0,pitch:0,roll:0},fov:90,panorama:!1};this.renderLayerInternal(h,n,t,j,l,g),this.device.queue.submit([h.finish()])}renderLayerWithMask(n,t,l,h,g){if(!t.maskCanvas||!t.img){this.renderLayerInternal(n,t,l,h,g,this.foregroundPipeline);return}try{const j=`${t.id}_mask`,R=t.maskCanvas,G=this.textureCache.loadImage(j,R),E={...l};E.opacity*=.8,this.renderLayerInternal(n,t,E,h,g,this.foregroundPipeline)}catch(j){console.warn(`[GPUTimelineRenderer] Failed to apply mask for layer ${t.id}:`,j),this.renderLayerInternal(n,t,l,h,g,this.foregroundPipeline)}}renderOverlay(n,t,l){if(n==="none"||!this.overlayPipeline)return;const h=this.device.createCommandEncoder();let g=[1,0,0,.3];switch(n){case"mask":g=[1,0,0,.5];break;case"extract":g=[0,0,0,.6];break;case"path":g=[0,.5,1,.8];break}l!=null&&l.color&&(g=l.color);const j=this.device.createBuffer({size:16,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),R=new Float32Array(g);this.device.queue.writeBuffer(j,0,R);const G=this.device.createBindGroup({layout:this.overlayBindGroupLayout,entries:[{binding:0,resource:{buffer:j}}]}),E=h.beginRenderPass({colorAttachments:[{view:t,loadOp:"load",storeOp:"store"}]});E.setPipeline(this.overlayPipeline),E.setBindGroup(0,G),E.setVertexBuffer(0,this.quadVertexBuffer),E.setIndexBuffer(this.indexBuffer,"uint16"),E.drawIndexed(6),E.end(),this.device.queue.submit([h.finish()]),j.destroy()}renderPathOverlay(n,t,l){!n||n.length<2||this.renderOverlay("path",t,{color:[0,.5,1,.8]})}renderMaskOverlay(n,t,l){n.maskCanvas&&this.renderOverlay("mask",t,{color:[1,0,0,.5],layer:n})}renderExtractOverlay(n,t,l){this.renderOverlay("extract",t,{color:[0,0,0,.6],layer:n})}updateUniforms(n){if(this.lastUniformData){const t=new Uint8Array(this.lastUniformData),l=new Uint8Array(n);let h=!1;for(let g=0;g<Math.min(t.length,l.length);g++)if(t[g]!==l[g]){h=!0;break}if(!h)return}this.device.queue.writeBuffer(this.uniformBuffer,0,n),this.lastUniformData=n.slice(0)}cameraStateChanged(n){if(!this.lastCameraState)return this.lastCameraState={...n},!0;const t=this.lastCameraState.enabled!==n.enabled||this.lastCameraState.position.x!==n.position.x||this.lastCameraState.position.y!==n.position.y||this.lastCameraState.position.z!==n.position.z||this.lastCameraState.offset.x!==n.offset.x||this.lastCameraState.offset.y!==n.offset.y||this.lastCameraState.rotation.yaw!==n.rotation.yaw||this.lastCameraState.rotation.pitch!==n.rotation.pitch||this.lastCameraState.rotation.roll!==n.rotation.roll||this.lastCameraState.fov!==n.fov||this.lastCameraState.panorama!==n.panorama;return t&&(this.lastCameraState={...n}),t}resizeRenderTargets(n,t){this.width=n,this.height=t}cleanup(){var n,t,l,h;for(const g of this.tempBuffers)g.destroy();this.tempBuffers=[],(n=this.uniformBuffer)==null||n.destroy(),(t=this.panoUniformBuffer)==null||t.destroy(),(l=this.quadVertexBuffer)==null||l.destroy(),(h=this.indexBuffer)==null||h.destroy(),this.textureCache.cleanup(),console.log("[GPUTimelineRenderer] Cleaned up all resources")}getCacheStats(){return this.textureCache.getStats()}}class ga{constructor(n,t){Q(this,"device");Q(this,"adapter",null);this.device=n,this.adapter=t||null}async getDeviceInfo(){var h,g,j;const n={},t=[];if(this.device.limits)for(const[R,G]of Object.entries(this.device.limits))typeof G=="number"&&(n[R]=G);this.device.features&&this.device.features.forEach(R=>{t.push(R)});let l="Unknown";if(this.adapter)try{const R=await((g=(h=this.adapter).requestAdapterInfo)==null?void 0:g.call(h));l=(R==null?void 0:R.description)||(R==null?void 0:R.vendor)||"WebGPU Adapter"}catch{l="WebGPU Adapter"}return{adapter:l,device:"WebGPU Device",limits:n,features:t,canvasFormat:((j=navigator.gpu)==null?void 0:j.getPreferredCanvasFormat())||"unknown"}}async logDeviceInfo(){const n=await this.getDeviceInfo();console.group("[GPUDebugger] Device Information"),console.log("Adapter:",n.adapter),console.log("Device:",n.device),console.log("Canvas Format:",n.canvasFormat),console.log("Features:",n.features),console.log("Limits:",n.limits),console.groupEnd()}checkRequiredFeatures(){const n=[],t=[];for(const l of n)this.device.features.has(l)||t.push(l);return{supported:t.length===0,missing:t}}getMemoryEstimate(n,t){const g=n*t*4/(1024*1024);return`~${Math.round(g)}MB`}validatePipeline(n){return n?!0:(console.error("[GPUDebugger] Pipeline is null"),!1)}logCacheStats(n){console.group("[GPUDebugger] Texture Cache Stats"),console.log("Total Textures:",n.totalTextures),console.log("Cache Hits:",n.cacheHits),console.log("Cache Misses:",n.cacheMisses),console.log("Hit Rate:",`${n.hitRate}%`),console.log("Memory Usage:",n.memoryUsage),console.groupEnd()}logPerformanceStats(n){console.group("[GPUDebugger] Performance Stats"),console.log("FPS:",n.fps),console.log("Frame Time:",`${n.frameTime}ms`),console.log("Avg Frame Time:",`${n.avgFrameTime}ms`),console.log("Min Frame Time:",`${n.minFrameTime}ms`),console.log("Max Frame Time:",`${n.maxFrameTime}ms`),console.log("Total Frames:",n.totalFrames),console.log("Dropped Frames:",n.droppedFrames),console.groupEnd()}createDebugOverlay(n){const t=document.createElement("div");return t.style.position="absolute",t.style.top="10px",t.style.right="10px",t.style.padding="10px",t.style.backgroundColor="rgba(0, 0, 0, 0.7)",t.style.color="#00ff00",t.style.fontFamily="monospace",t.style.fontSize="12px",t.style.zIndex="10000",t.style.pointerEvents="none",n.appendChild(t),t}updateDebugOverlay(n,t,l){n.innerHTML=`
      <div><strong>GPU Timeline Renderer</strong></div>
      <div>FPS: ${t.fps}</div>
      <div>Frame: ${t.frameTime}ms</div>
      <div>Avg: ${t.avgFrameTime}ms</div>
      <div>Dropped: ${t.droppedFrames}</div>
      <div>---</div>
      <div>Textures: ${l.totalTextures}</div>
      <div>Hit Rate: ${l.hitRate}%</div>
    `}}(globalThis.__TYPEGPU_AUTONAME__??(e=>e))(wt({position:pt,scale:pt,rotation:Se,opacity:Se,screenSize:pt,rotationX:Se,rotationY:Se,rotationZ:Se,perspective:Se,cameraOffset:pt,cameraScale:Se,cameraYaw:Se,cameraPitch:Se,cameraRoll:Se,cameraFOV:Se,zDepth:Se,anchorOffset:pt,backgroundMode:aa}),"LayerUniforms");(globalThis.__TYPEGPU_AUTONAME__??(e=>e))(wt({position:ra,offset:pt,yaw:Se,pitch:Se,roll:Se,fov:Se,scale:Se,enabled:aa}),"CameraUniforms");(globalThis.__TYPEGPU_AUTONAME__??(e=>e))(wt({yaw:Se,pitch:Se,roll:Se,fov:Se,aspectRatio:Se,screenSize:pt}),"PanoramaUniforms");(globalThis.__TYPEGPU_AUTONAME__??(e=>e))(wt({position:sa.position,uv:Zt(0,pt),opacity:Zt(1,Se)}),"VertexOutput");function _a(e,n,t){let l=null,h=null,g=!1,j=null,R=null,G=null,E=!1;const q=new Map,z={};async function $(){const r=localStorage.getItem("timeline_disable_gpu")==="true";if(localStorage.getItem("timeline_gpu_camera_rotation"),!r&&"gpu"in navigator&&n.value)try{console.log("[Timeline] Attempting WebGPU initialization...");const p=await navigator.gpu.requestAdapter();if(console.log("[Timeline] GPU adapter:",p),p){const _=await p.requestDevice();console.log("[Timeline] GPU device:",_);const v=n.value.getContext("webgpu");if(console.log("[Timeline] WebGPU context:",v),v){const P=navigator.gpu.getPreferredCanvasFormat();console.log("[Timeline] Presentation format:",P),v.configure({device:_,format:P,alphaMode:"premultiplied"});const x=localStorage.getItem("timeline_gpu_advanced")==="true";j=new ya({device:_,presentationFormat:P,width:e.project.width,height:e.project.height,useAdvancedTransforms:x}),G=new ga(_,p),R=v,E=!0,console.log("[Timeline] ✅ WebGPU initialized successfully"),console.log("[Timeline] Canvas size:",e.project.width,"x",e.project.height),t.value&&(h=t.value.getContext("2d",{alpha:!0}));return}}}catch(p){console.warn("[Timeline] ❌ WebGPU initialization failed, falling back to Canvas 2D:",p)}else r?console.log("[Timeline] GPU rendering disabled by user preference"):"gpu"in navigator||console.log("[Timeline] WebGPU not supported in this browser");console.log("[Timeline] Using Canvas 2D renderer"),E=!1,n.value&&(l=n.value.getContext("2d",{alpha:!1,desynchronized:!0})),t.value&&(h=t.value.getContext("2d",{alpha:!0}))}function U(){g||(g=!0,requestAnimationFrame(()=>{g=!1,L()}))}function ee(r){if(r.img)return r.img;if(!r.image_data)return null;const p=r.id;if(q.has(p)){const v=q.get(p);return v.complete?(r.img=v,v):null}const _=new Image;return _.onload=()=>{r.img=_,U()},_.src=r.image_data,q.set(p,_),null}function Z(r,p,_){if(!r||r.length===0)return _;const v=[...r].sort((P,x)=>P.time-x.time);if(p<=v[0].time)return v[0].value;if(p>=v[v.length-1].time)return v[v.length-1].value;for(let P=0;P<v.length-1;P++)if(p>=v[P].time&&p<=v[P+1].time){const x=(p-v[P].time)/(v[P+1].time-v[P].time);return v[P].value+(v[P+1].value-v[P].value)*x}return _}function me(r,p,_){if(!r||r.length<2)return null;const v=p/_,x=r.length-1,c=Math.min(Math.floor(v*x),x-1),f=v*x-c,y=r[c],C=r[c+1];if(!y||!C)return null;const F=y.cp2x??y.x+(C.x-y.x)/3,k=y.cp2y??y.y+(C.y-y.y)/3,T=C.cp1x??y.x+(C.x-y.x)*2/3,A=C.cp1y??y.y+(C.y-y.y)*2/3,oe=1-f,ve=oe*oe,ie=ve*oe,H=f*f,re=H*f;return{x:ie*y.x+3*ve*f*F+3*oe*H*T+re*C.x,y:ie*y.y+3*ve*f*k+3*oe*H*A+re*C.y}}function V(r){const p=e.currentTime,_=r.keyframes||{};let v=Z(_.x,p,r.x||0),P=Z(_.y,p,r.y||0);if(r.usePathAnimation&&r.bezierPath&&r.bezierPath.length>=2){const x=me(r.bezierPath,p,e.project.duration);x&&(v=x.x,P=x.y)}return{x:v,y:P,z:Z(_.z,p,r.z||0),scale:Z(_.scale,p,r.scale||1),rotation:Z(_.rotation,p,r.rotation||0),opacity:Z(_.opacity,p,r.opacity??1),mask_size:Z(_.mask_size,p,r.mask_size||0),rotationX:Z(_.rotationX,p,r.rotationX||0),rotationY:Z(_.rotationY,p,r.rotationY||0),rotationZ:Z(_.rotationZ,p,r.rotationZ||0),anchorX:Z(_.anchorX,p,r.anchorX||0),anchorY:Z(_.anchorY,p,r.anchorY||0),perspective:Z(_.perspective,p,r.perspective||1e3)}}function L(){E&&j&&R?Ye():Te(),De()}function Ye(){var v,P,x,c,f,y,C,F,k;if(!j||!R)return;let r=!0;for(const T of e.layers)T.image_data&&!T.img&&(ee(T)||(r=!1));if(!r){Te();return}const _={enabled:!!e.project.cam_enable&&!e.project.pano_enable,position:{x:((v=e.interpolateProjectValue)==null?void 0:v.call(e,"cam_pos_x",e.currentTime,e.project.cam_pos_x||0))??(e.project.cam_pos_x||0),y:((P=e.interpolateProjectValue)==null?void 0:P.call(e,"cam_pos_y",e.currentTime,e.project.cam_pos_y||0))??(e.project.cam_pos_y||0),z:((x=e.interpolateProjectValue)==null?void 0:x.call(e,"cam_pos_z",e.currentTime,e.project.cam_pos_z||0))??(e.project.cam_pos_z||0)},offset:{x:((c=e.interpolateProjectValue)==null?void 0:c.call(e,"cam_offset_x",e.currentTime,e.project.cam_offset_x||0))??(e.project.cam_offset_x||0),y:((f=e.interpolateProjectValue)==null?void 0:f.call(e,"cam_offset_y",e.currentTime,e.project.cam_offset_y||0))??(e.project.cam_offset_y||0)},rotation:{yaw:((y=e.interpolateProjectValue)==null?void 0:y.call(e,"cam_yaw",e.currentTime,e.project.cam_yaw||0))??(e.project.cam_yaw||0),pitch:((C=e.interpolateProjectValue)==null?void 0:C.call(e,"cam_pitch",e.currentTime,e.project.cam_pitch||0))??(e.project.cam_pitch||0),roll:((F=e.interpolateProjectValue)==null?void 0:F.call(e,"cam_roll",e.currentTime,e.project.cam_roll||0))??(e.project.cam_roll||0)},fov:((k=e.interpolateProjectValue)==null?void 0:k.call(e,"cam_fov",e.currentTime,e.project.cam_fov||90))??(e.project.cam_fov||90),panorama:!!e.project.pano_enable};try{const T=e.project.width,A=e.project.height;j.resizeRenderTargets(T,A);const oe=R.getCurrentTexture().createView();j.renderFrame(e.layers,e.currentTime,_,oe,e.project.duration)}catch(T){console.error("[Timeline] GPU rendering error:",T),E=!1,Te()}}function Te(){var P,x,c;if(!n.value||!l)return;l.fillStyle="#000",l.fillRect(0,0,e.project.width,e.project.height);const r=((P=e.interpolateProjectValue)==null?void 0:P.call(e,"cam_offset_x",e.currentTime,e.project.cam_offset_x??0))??e.project.cam_offset_x??0,p=((x=e.interpolateProjectValue)==null?void 0:x.call(e,"cam_offset_y",e.currentTime,e.project.cam_offset_y??0))??e.project.cam_offset_y??0;e.project.pano_enable;const _=!!e.project.cam_enable,v=e.layers.find(f=>f.type==="background");v&&l&&Ue(l,v,r,p,1,_),l&&e.layers.filter(f=>f.type!=="background").forEach(f=>{Ee(l,f,r,p,_,1)}),e.pathMode.enabled&&((c=e.currentLayer)!=null&&c.bezierPath)&&l&&pe(l,e.currentLayer.bezierPath),e.extractMode.enabled}let Be=null;function ze(r){Be=r}function De(){var v,P;if(!t.value||!h)return;const r=h,p=e.project.width,_=e.project.height;r.clearRect(0,0,p,_),e.pathMode.enabled&&((v=e.currentLayer)!=null&&v.bezierPath)&&Ge(r,e.currentLayer.bezierPath),e.extractMode.enabled&&Be&&Be(r),e.maskMode.enabled&&((P=e.currentLayer)!=null&&P.maskCanvas)&&$e(r),e.currentLayer&&e.currentLayer.img&&Ve(r)}function Xe(r,p,_){if(r.maskCanvas||!r.customMask)return;const v=new Image;v.onload=()=>{const P=document.createElement("canvas");P.width=v.width||p,P.height=v.height||_;const x=P.getContext("2d");x&&(x.drawImage(v,0,0,P.width,P.height),r.maskCanvas=P,U())},v.src=r.customMask}function Ue(r,p,_=0,v=0,P=1,x=!1){var ie,H,re,ne,de,Ce,Me,ye,Le,be,m;const c=ee(p);if(!c||c.width===0||c.height===0)return;const f=V(p),y=!!e.project.pano_enable;r.save(),r.globalAlpha=f.opacity;const C=p.bg_mode||"fit",F=e.project.width,k=e.project.height,T=c.width,A=c.height;let oe=1;if(y&&T>0&&A>0){const d=((ie=e.interpolateProjectValue)==null?void 0:ie.call(e,"cam_yaw",e.currentTime,e.project.cam_yaw||0))??(e.project.cam_yaw||0),w=((H=e.interpolateProjectValue)==null?void 0:H.call(e,"cam_pitch",e.currentTime,e.project.cam_pitch||0))??(e.project.cam_pitch||0),I=((re=e.interpolateProjectValue)==null?void 0:re.call(e,"cam_roll",e.currentTime,e.project.cam_roll||0))??(e.project.cam_roll||0),D=Math.min(170,Math.max(10,((ne=e.interpolateProjectValue)==null?void 0:ne.call(e,"cam_fov",e.currentTime,e.project.cam_fov||90))??(e.project.cam_fov||90))),S=Math.PI/180,W=1024;let K=F,Y=k;const se=Math.max(1,Math.max(F,k)/W);se>1.01&&(K=Math.max(1,Math.round(F/se)),Y=Math.max(1,Math.round(k/se)));const te=`${K}x${Y}|${T}x${A}|${d}|${w}|${I}|${D}`;if(z.key!==te){const J=document.createElement("canvas");J.width=T,J.height=A;const Ae=J.getContext("2d");Ae?(Ae.drawImage(c,0,0,T,A),z.srcData=Ae.getImageData(0,0,T,A).data):z.srcData=void 0;const rt=F/Math.max(1,k),Je=Math.tan(D*S/2),ct=d*S,lt=w*S,qe=I*S,Qe=Math.cos(ct),dt=Math.sin(ct),ft=Math.cos(lt),ht=Math.sin(lt),st=Math.cos(qe),bt=Math.sin(qe),xt=new Float32Array(K*Y),Pt=new Float32Array(K*Y);for(let vt=0;vt<Y;vt++){const s=(vt+.5)/Y*2-1;for(let a=0;a<K;a++){let u=((a+.5)/K*2-1)*Je*rt,b=-s*Je,X=1;const O=1/Math.hypot(u,b,X);u*=O,b*=O,X*=O;let ae=Qe*u+dt*X,N=-dt*u+Qe*X;u=ae,X=N;let Ie=ft*b-ht*X;N=ht*b+ft*X,b=Ie,X=N,ae=st*u-bt*b,Ie=bt*u+st*b,u=ae,b=Ie;const et=Math.atan2(u,X),Re=Math.asin(Math.max(-1,Math.min(1,b))),tt=(et/(Math.PI*2)+.5)*T,ut=(.5-Re/Math.PI)*A;let ot=Math.floor(tt)%T;ot<0&&(ot+=T);let at=Math.floor(ut);at=Math.max(0,Math.min(A-1,at));const mt=vt*K+a;xt[mt]=ot,Pt[mt]=at}}z.key=te,z.mapX=xt,z.mapY=Pt,z.imgW=T,z.imgH=A,z.outW=K,z.outH=Y,z.canvas=document.createElement("canvas"),z.canvas.width=K,z.canvas.height=Y,z.ctx=z.canvas.getContext("2d")}const ke=z.srcData,fe=z.mapX,Ke=z.mapY,xe=z.canvas,ge=z.ctx,we=z.outW||0,ce=z.outH||0;if(ke&&fe&&Ke&&xe&&ge&&we>0&&ce>0){const J=ge.getImageData(0,0,we,ce),Ae=J.data,rt=we*ce;for(let Je=0;Je<rt;Je++){const ct=fe[Je],qe=(Ke[Je]*T+ct)*4,Qe=Je*4;Ae[Qe]=ke[qe],Ae[Qe+1]=ke[qe+1],Ae[Qe+2]=ke[qe+2],Ae[Qe+3]=255}ge.putImageData(J,0,0),r.drawImage(xe,0,0,F,k),r.restore();return}else return r.restore(),Ue(r,{...p,panoFallback:!0,type:p.type,bg_mode:p.bg_mode},_,v,1,!1)}else{T>0&&A>0&&(C==="fit"?oe=Math.min(F/T,k/A):C==="fill"?oe=Math.max(F/T,k/A):C==="stretch"&&(oe=Math.min(F/T,k/A))),(!Number.isFinite(oe)||oe<=0)&&(oe=1);let d=f.x,w=f.y;const I=f.z||0,D=x&&!y;if(D){const Fe=((de=e.interpolateProjectValue)==null?void 0:de.call(e,"cam_yaw",e.currentTime,e.project.cam_yaw??0))??e.project.cam_yaw??0,ke=((Ce=e.interpolateProjectValue)==null?void 0:Ce.call(e,"cam_pitch",e.currentTime,e.project.cam_pitch??0))??e.project.cam_pitch??0,fe=((Me=e.interpolateProjectValue)==null?void 0:Me.call(e,"cam_fov",e.currentTime,e.project.cam_fov??90))??e.project.cam_fov??90,Ke=((ye=e.interpolateProjectValue)==null?void 0:ye.call(e,"cam_pos_x",e.currentTime,e.project.cam_pos_x??0))??e.project.cam_pos_x??0,xe=((Le=e.interpolateProjectValue)==null?void 0:Le.call(e,"cam_pos_y",e.currentTime,e.project.cam_pos_y??0))??e.project.cam_pos_y??0;if(((be=e.interpolateProjectValue)==null?void 0:be.call(e,"cam_pos_z",e.currentTime,e.project.cam_pos_z??0))??e.project.cam_pos_z,d-=Ke,w-=xe,Fe!==0||ke!==0){const ge=Fe*Math.PI/180,we=ke*Math.PI/180,ce=Math.tan(fe*Math.PI/180/2),J=F/(2*ce);d+=Math.tan(ge)*J,w+=Math.tan(we)*J}}const S=1/Math.max(.1,1+I*.001);let W=1;if(D){const Fe=((m=e.interpolateProjectValue)==null?void 0:m.call(e,"cam_pos_z",e.currentTime,e.project.cam_pos_z??1e3))??e.project.cam_pos_z??1e3;W=Math.max(.1,Math.min(10,1e3/Math.max(100,Fe)))}const K=F/2+d+_,Y=k/2+w+v,se=(f.scale||1)*oe*S*W;if(!Number.isFinite(K)||!Number.isFinite(Y)||!Number.isFinite(se)||se<=0){r.restore();return}if(r.translate(K,Y),f.rotationX!==0||f.rotationY!==0){const Fe=(f.rotationX||0)*Math.PI/180,ke=(f.rotationY||0)*Math.PI/180,fe=Math.cos(Fe),Ke=Math.cos(ke);r.scale(Ke,fe)}const te=f.rotationZ||f.rotation||0;r.rotate(te*Math.PI/180),r.scale(se,se),r.drawImage(c,-T/2,-A/2,T,A)}r.restore()}function Ee(r,p,_=0,v=0,P=!1,x=1){var Me,ye,Le,be,m,d;const c=ee(p);if(!c||c.width===0||c.height===0)return;const f=V(p),y=c.width,C=c.height;Xe(p,y,C),r.save();const F=!!e.project.pano_enable;let k=f.x,T=f.y;const A=f.z||0;if(P||F){const w=((Me=e.interpolateProjectValue)==null?void 0:Me.call(e,"cam_yaw",e.currentTime,e.project.cam_yaw??0))??e.project.cam_yaw??0,I=((ye=e.interpolateProjectValue)==null?void 0:ye.call(e,"cam_pitch",e.currentTime,e.project.cam_pitch??0))??e.project.cam_pitch??0,D=((Le=e.interpolateProjectValue)==null?void 0:Le.call(e,"cam_fov",e.currentTime,e.project.cam_fov??90))??e.project.cam_fov??90,S=((be=e.interpolateProjectValue)==null?void 0:be.call(e,"cam_pos_x",e.currentTime,e.project.cam_pos_x??0))??e.project.cam_pos_x??0,W=((m=e.interpolateProjectValue)==null?void 0:m.call(e,"cam_pos_y",e.currentTime,e.project.cam_pos_y??0))??e.project.cam_pos_y??0;if(F||(k-=S,T-=W),w!==0||I!==0){const K=w*Math.PI/180,Y=I*Math.PI/180,se=Math.tan(D*Math.PI/180/2),te=e.project.width/(2*se);F?(k-=Math.tan(K)*te,T-=Math.tan(Y)*te):(k+=Math.tan(K)*te,T+=Math.tan(Y)*te)}}const oe=1/Math.max(.1,1+A*.001);let ve=1;if(P&&!F){const w=((d=e.interpolateProjectValue)==null?void 0:d.call(e,"cam_pos_z",e.currentTime,e.project.cam_pos_z??1e3))??e.project.cam_pos_z??1e3;ve=Math.max(.1,Math.min(10,1e3/Math.max(100,w)))}const ie=e.project.width/2+k+_,H=e.project.height/2+T+v;if(!Number.isFinite(ie)||!Number.isFinite(H)){r.restore();return}if(r.translate(ie,H),f.rotationX!==0||f.rotationY!==0){const w=f.rotationX*Math.PI/180,I=f.rotationY*Math.PI/180,D=Math.cos(w),S=Math.cos(I);r.scale(S,D)}const re=f.rotationZ||f.rotation||0;r.rotate(re*Math.PI/180);const ne=f.scale*oe*ve;r.scale(ne,ne),r.globalAlpha=f.opacity;const de=(f.anchorX||0)*y,Ce=(f.anchorY||0)*C;if(p.maskCanvas){const w=document.createElement("canvas");w.width=y,w.height=C;const I=w.getContext("2d");I?(I.clearRect(0,0,y,C),I.drawImage(c,0,0,y,C),I.globalCompositeOperation="destination-in",I.drawImage(p.maskCanvas,0,0,y,C),r.drawImage(w,-y/2-de,-C/2-Ce,y,C)):r.drawImage(c,-y/2-de,-C/2-Ce,y,C)}else r.drawImage(c,-y/2-de,-C/2-Ce,y,C);if(f.mask_size>0){r.strokeStyle="#3ac88e",r.lineWidth=2/f.scale,r.setLineDash([5/f.scale,5/f.scale]);const w=y*f.mask_size,I=C*f.mask_size;r.strokeRect(-w/2,-I/2,w,I),r.setLineDash([])}r.restore()}function pe(r,p){if(!p||p.length===0)return;const _=e.project.width/2,v=e.project.height/2;r.save(),r.strokeStyle="#ff6b6b",r.lineWidth=2,r.setLineDash([5,5]),r.beginPath(),r.moveTo(_+p[0].x,v+p[0].y);for(let P=1;P<p.length;P++){const x=p[P-1],c=p[P],f=x.cp2x??x.x+(c.x-x.x)/3,y=x.cp2y??x.y+(c.y-x.y)/3,C=c.cp1x??x.x+(c.x-x.x)*2/3,F=c.cp1y??x.y+(c.y-x.y)*2/3;r.bezierCurveTo(_+f,v+y,_+C,v+F,_+c.x,v+c.y)}if(r.stroke(),r.setLineDash([]),p.forEach((P,x)=>{r.beginPath(),r.arc(_+P.x,v+P.y,6,0,Math.PI*2),r.fillStyle=x===0?"#4ecdc4":x===p.length-1?"#ff6b6b":"#ffe66d",r.fill(),r.strokeStyle="#fff",r.lineWidth=2,r.stroke()}),p.length>=2){const P=p.length-1,x=p[P-1],c=p[P],f=x.cp2x??x.x+(c.x-x.x)/3,y=x.cp2y??x.y+(c.y-x.y)/3,C=c.cp1x??x.x+(c.x-x.x)*2/3,F=c.cp1y??x.y+(c.y-x.y)*2/3,k=.99,T=1-k,A=3*T*T*(f-x.x)+6*T*k*(C-f)+3*k*k*(c.x-C),oe=3*T*T*(y-x.y)+6*T*k*(F-y)+3*k*k*(c.y-F),ve=Math.atan2(oe,A),ie=_+c.x,H=v+c.y,re=18;r.beginPath(),r.moveTo(ie,H),r.lineTo(ie-re*Math.cos(ve-Math.PI/6),H-re*Math.sin(ve-Math.PI/6)),r.moveTo(ie,H),r.lineTo(ie-re*Math.cos(ve+Math.PI/6),H-re*Math.sin(ve+Math.PI/6)),r.strokeStyle="#ff6b6b",r.lineWidth=2,r.stroke()}r.restore()}function Ge(r,p){if(!p||p.length===0)return;const _=e.project.width/2,v=e.project.height/2;r.save(),r.strokeStyle="#ff6b6b",r.lineWidth=2,r.setLineDash([5,5]),r.beginPath(),r.moveTo(_+p[0].x,v+p[0].y);for(let P=1;P<p.length;P++){const x=p[P-1],c=p[P],f=x.cp2x??x.x+(c.x-x.x)/3,y=x.cp2y??x.y+(c.y-x.y)/3,C=c.cp1x??x.x+(c.x-x.x)*2/3,F=c.cp1y??x.y+(c.y-x.y)*2/3;r.bezierCurveTo(_+f,v+y,_+C,v+F,_+c.x,v+c.y)}r.stroke(),r.setLineDash([]),p.forEach((P,x)=>{r.beginPath(),r.arc(_+P.x,v+P.y,6,0,Math.PI*2),r.fillStyle=x===0?"#4ecdc4":x===p.length-1?"#ff6b6b":"#ffe66d",r.fill(),r.strokeStyle="#fff",r.lineWidth=2,r.stroke()}),r.restore()}function $e(r){var H,re;const p=e.currentLayer;if(!p||!p.maskCanvas||!p.img)return;const _=V(p),v=p.img.width,P=p.img.height,x=e.project.width,c=e.project.height,f=x/2,y=c/2,C=((H=e.interpolateProjectValue)==null?void 0:H.call(e,"cam_offset_x",e.currentTime,e.project.cam_offset_x??0))??e.project.cam_offset_x??0,F=((re=e.interpolateProjectValue)==null?void 0:re.call(e,"cam_offset_y",e.currentTime,e.project.cam_offset_y??0))??e.project.cam_offset_y??0,k=_.z||0,T=1/Math.max(.1,1+k*.001),A=_.x+C,oe=_.y+F,ve=_.scale*T;r.save(),r.globalAlpha=.5,r.translate(f+A,y+oe);const ie=_.rotationZ!==void 0&&_.rotationZ!==0?_.rotationZ:_.rotation;r.rotate(ie*Math.PI/180),r.scale(ve,ve),r.fillStyle="rgba(255, 0, 0, 0.3)",r.fillRect(-v/2,-P/2,v,P),r.globalCompositeOperation="destination-out",r.drawImage(p.maskCanvas,-v/2,-P/2,v,P),r.restore()}function Ve(r){var Me,ye,Le,be,m;const p=e.currentLayer;if(!p||!p.img)return;const _=V(p),v=p.img.width,P=p.img.height,x=e.project.width,c=e.project.height,f=x/2,y=c/2,C=!!e.project.cam_enable,F=!!e.project.pano_enable,k=((Me=e.interpolateProjectValue)==null?void 0:Me.call(e,"cam_offset_x",e.currentTime,e.project.cam_offset_x??0))??e.project.cam_offset_x??0,T=((ye=e.interpolateProjectValue)==null?void 0:ye.call(e,"cam_offset_y",e.currentTime,e.project.cam_offset_y??0))??e.project.cam_offset_y??0,A=_.z||0,oe=1/Math.max(.1,1+A*.001);let ve=_.x,ie=_.y;if((C||F)&&p.type!=="background"){const d=((Le=e.interpolateProjectValue)==null?void 0:Le.call(e,"cam_yaw",e.currentTime,e.project.cam_yaw??0))??e.project.cam_yaw??0,w=((be=e.interpolateProjectValue)==null?void 0:be.call(e,"cam_pitch",e.currentTime,e.project.cam_pitch??0))??e.project.cam_pitch??0,I=((m=e.interpolateProjectValue)==null?void 0:m.call(e,"cam_fov",e.currentTime,e.project.cam_fov??90))??e.project.cam_fov??90;if(d!==0||w!==0){const D=d*Math.PI/180,S=w*Math.PI/180,W=Math.tan(I*Math.PI/180/2),K=x/(2*W);ve-=Math.tan(D)*K,ie-=Math.tan(S)*K}}let H=ve+k,re=ie+T,ne=_.scale*oe;if(p.type==="background"&&v>0&&P>0){const d=p.bg_mode||"fit";let w=1;d==="fit"?w=Math.min(x/v,c/P):d==="fill"?w=Math.max(x/v,c/P):w=Math.min(x/v,c/P),ne=_.scale*w*oe}(!Number.isFinite(ne)||ne<=0)&&(ne=1),r.save(),r.translate(f+H,y+re);const de=_.rotationZ!==void 0&&_.rotationZ!==0?_.rotationZ:_.rotation;r.rotate(de*Math.PI/180),r.scale(ne,ne),r.strokeStyle="#3a7bc8",r.lineWidth=2/ne,r.strokeRect(-v/2,-P/2,v,P),r.fillStyle="#3a7bc8",[[-v/2,-P/2],[v/2,-P/2],[v/2,P/2],[-v/2,P/2]].forEach(([d,w])=>{r.fillRect(d-4/ne,w-4/ne,8/ne,8/ne)}),r.restore()}function _e(){q.clear(),j&&(j.cleanup(),j=null),R=null}function B(r){r?(localStorage.removeItem("timeline_disable_gpu"),console.log("[Timeline] GPU rendering will be enabled on next reload")):(localStorage.setItem("timeline_disable_gpu","true"),console.log("[Timeline] GPU rendering will be disabled on next reload"))}return{initContexts:$,scheduleRender:U,render:L,getCachedImage:ee,getLayerProps:V,setDrawExtractOverlayOnCtx:ze,cleanup:_e,panoCache:z,imageCache:q,isUsingGPU:()=>E,toggleGPU:B,getGPUStats:()=>(j==null?void 0:j.getCacheStats())||null,getPerformanceStats:()=>(j==null?void 0:j.getPerformanceStats())||null,resetPerformanceStats:()=>j==null?void 0:j.resetPerformanceStats()}}function ba(e,n,t,l,h,g){let j=!1,R=0,G=0,E=0,q=0,z=!1,$=!1,U=0,ee=0,Z=0,me=0,V=0,L=0,Ye=!1,Te=!1,Be=!1,ze=!1,De=0,Xe=0,Ue=0,Ee=0,pe=0,Ge=0,$e=0,Ve=0,_e=!1,B=null,r=null,p=null,_=!1,v=null,P=!1,x=-1;function c(m){return!(!e.maskMode.enabled&&!e.extractMode.enabled&&!e.pathMode.enabled)||!e.project.cam_enable||e.project.pano_enable?!1:e.cameraSelected?!0:e.currentLayer&&m&&("ctrlKey"in m&&m.ctrlKey||"shiftKey"in m&&m.shiftKey||"altKey"in m&&m.altKey)?!1:!e.currentLayer}function f(m){const d=t.value||n.value;if(!d)return{x:0,y:0};const w=d.getBoundingClientRect(),I=e.project.width/w.width,D=e.project.height/w.height;return{x:(m.clientX-w.left)*I,y:(m.clientY-w.top)*D}}function y(m,d,w){const I=e.currentTime;if(m.keyframes&&m.keyframes[d]&&m.keyframes[d].length>0){const D=m.keyframes[d].findIndex(S=>Math.abs(S.time-I)<.05);D>=0?m.keyframes[d][D]={time:m.keyframes[d][D].time,value:w}:(m.keyframes[d].push({time:I,value:w}),m.keyframes[d].sort((S,W)=>S.time-W.time))}e.updateLayer(e.currentLayerIndex,{[d]:w})}function C(m){var S;(S=t.value)==null||S.focus(),m.shiftKey,m.altKey;const d=f(m);if(c(m)){if(De=d.x,Xe=d.y,Ue=e.project.cam_pos_x||0,Ee=e.project.cam_pos_y||0,pe=e.project.cam_pos_z||0,Ge=e.project.cam_yaw||0,$e=e.project.cam_pitch||0,Ve=e.project.cam_roll||0,m.button===0&&m.shiftKey){ze=!0;return}if(m.button===0){Te=!0;return}if(m.button===1){Ye=!0;return}if(m.button===2){Be=!0;return}}if(e.project.pano_enable&&!e.maskMode.enabled&&!e.extractMode.enabled&&!e.pathMode.enabled){if(U=d.x,ee=d.y,Z=e.project.cam_yaw||0,me=e.project.cam_pitch||0,V=e.project.cam_offset_x||0,L=e.project.cam_offset_y||0,m.button===1||m.button===2){z=!0;return}else if(m.button===0&&(!e.currentLayer||m.altKey)){$=!0;return}}if(!e.currentLayer)return;if(e.extractMode.enabled){if(!ie()){console.warn("[Timeline] Extract mode requires a background layer with image data");return}_=!0,H(d.x,d.y,m.button===2||m.altKey);return}if(e.maskMode.enabled){_e=!0,oe(),ve(d.x,d.y);return}if(e.pathMode.enabled){ye(d);return}j=!0,R=d.x,G=d.y;const D=h(e.currentLayer);E=D.x,q=D.y}function F(m){var W,K,Y,se,te,Fe,ke,fe,Ke,xe;const d=f(m);if(Te){const ge=d.x-De,we=d.y-Xe,ce=Ge+ge*.25,J=Math.max(-89,Math.min(89,$e+we*.25));e.setProject({cam_yaw:ce,cam_pitch:J}),(W=e.setProjectKeyframe)==null||W.call(e,"cam_yaw",e.currentTime,ce),(K=e.setProjectKeyframe)==null||K.call(e,"cam_pitch",e.currentTime,J),l();return}if(Ye){const ge=d.x-De,we=d.y-Xe,ce=1+Math.max(0,(pe||0)/500),J=Ue+ge*ce,Ae=Ee+we*ce;e.setProject({cam_pos_x:J,cam_pos_y:Ae}),(Y=e.setProjectKeyframe)==null||Y.call(e,"cam_pos_x",e.currentTime,J),(se=e.setProjectKeyframe)==null||se.call(e,"cam_pos_y",e.currentTime,Ae),l();return}if(Be){const ge=d.y-Xe,ce=pe+ge*2;e.setProject({cam_pos_z:ce}),(te=e.setProjectKeyframe)==null||te.call(e,"cam_pos_z",e.currentTime,ce),l();return}if(ze){const ge=d.x-De,we=Ve+ge*.25;e.setProject({cam_roll:we}),(Fe=e.setProjectKeyframe)==null||Fe.call(e,"cam_roll",e.currentTime,we),l();return}if(z){const ge=d.x-U,we=d.y-ee,ce=Z+ge*.2,J=Math.max(-89,Math.min(89,me+we*.2));e.setProject({cam_yaw:ce,cam_pitch:J}),(ke=e.setProjectKeyframe)==null||ke.call(e,"cam_yaw",e.currentTime,ce),(fe=e.setProjectKeyframe)==null||fe.call(e,"cam_pitch",e.currentTime,J),l();return}if($){const ge=d.x-U,we=d.y-ee,ce=(V||0)+ge,J=(L||0)+we;e.setProject({cam_offset_x:ce,cam_offset_y:J}),(Ke=e.setProjectKeyframe)==null||Ke.call(e,"cam_offset_x",e.currentTime,ce),(xe=e.setProjectKeyframe)==null||xe.call(e,"cam_offset_y",e.currentTime,J),l();return}if(e.extractMode.enabled&&_){H(d.x,d.y,(m.buttons&2)===2||m.altKey);return}if(_e&&e.maskMode.enabled){ve(d.x,d.y);return}if(P&&x>=0){be(d);return}if(!j||!e.currentLayer)return;let w=d.x-R,I=d.y-G;m.shiftKey&&(Math.abs(w)>Math.abs(I)?I=0:w=0);const D=E+w,S=q+I;y(e.currentLayer,"x",D),y(e.currentLayer,"y",S),l()}function k(){j=!1,_e=!1,_=!1,P=!1,x=-1,z=!1,$=!1,Ye=!1,Te=!1,Be=!1,ze=!1}function T(m){var Y,se,te,Fe,ke,fe,Ke;const d=m.deltaY>0?-.05:.05,w=!e.maskMode.enabled&&!e.extractMode.enabled&&!e.pathMode.enabled;if(e.cameraSelected&&e.project.cam_enable&&w){if(m.shiftKey&&!m.ctrlKey&&!m.altKey){const ce=e.project.cam_pitch||0,J=Math.max(-89,Math.min(89,ce+(d>0?2:-2)));e.setProject({cam_pitch:J}),(Y=e.setProjectKeyframe)==null||Y.call(e,"cam_pitch",e.currentTime,J)}else if(m.ctrlKey&&!m.shiftKey&&!m.altKey){const J=(e.project.cam_yaw||0)+(d>0?2:-2);e.setProject({cam_yaw:J}),(se=e.setProjectKeyframe)==null||se.call(e,"cam_yaw",e.currentTime,J)}else if(m.altKey&&!m.shiftKey&&!m.ctrlKey){const J=(e.project.cam_roll||0)+(d>0?2:-2);e.setProject({cam_roll:J}),(te=e.setProjectKeyframe)==null||te.call(e,"cam_roll",e.currentTime,J)}else if(m.ctrlKey&&m.shiftKey&&!m.altKey){const ce=e.project.cam_fov||90,J=Math.min(170,Math.max(10,ce+(d>0?2:-2)));e.setProject({cam_fov:J}),(Fe=e.setProjectKeyframe)==null||Fe.call(e,"cam_fov",e.currentTime,J)}else{const ce=e.project.cam_pos_z||1e3,J=Math.max(100,ce+(d>0?50:-50));e.setProject({cam_pos_z:J}),(ke=e.setProjectKeyframe)==null||ke.call(e,"cam_pos_z",e.currentTime,J)}l();return}if(c(m)){const xe=e.project.cam_pos_z||0,ge=8,we=xe+(d>0?ge:-ge);e.setProject({cam_pos_z:we}),(fe=e.setProjectKeyframe)==null||fe.call(e,"cam_pos_z",e.currentTime,we),l();return}if(e.project.pano_enable&&w&&!e.currentLayer){const xe=Math.min(170,Math.max(10,(e.project.cam_fov||90)+(d>0?2:-2)));e.setProject({cam_fov:xe}),(Ke=e.setProjectKeyframe)==null||Ke.call(e,"cam_fov",e.currentTime,xe),l();return}if(!e.currentLayer)return;const S=e.currentLayer,W=h(S),K=2;if(m.ctrlKey&&m.shiftKey&&!m.altKey){const ge=(W.z||0)+(d>0?50:-50);y(S,"z",ge)}else if(m.shiftKey&&!m.ctrlKey&&!m.altKey){const xe=W.rotationX+(d>0?K:-K);y(S,"rotationX",xe)}else if(m.ctrlKey&&!m.shiftKey&&!m.altKey){const xe=W.rotationY+(d>0?K:-K);y(S,"rotationY",xe)}else if(m.altKey&&!m.shiftKey&&!m.ctrlKey){const xe=(W.rotationZ||W.rotation||0)+(d>0?K:-K);y(S,"rotationZ",xe)}else{const xe=Math.max(.1,Math.min(5,W.scale+d));y(S,"scale",xe)}l()}function A(m){var D,S,W,K,Y,se;const d=m.shiftKey?10:1;if(e.cameraSelected&&e.project.cam_enable){const te=d*5;switch(m.key){case"ArrowLeft":const Fe=(e.project.cam_pos_x||0)-te;e.setProject({cam_pos_x:Fe}),(D=e.setProjectKeyframe)==null||D.call(e,"cam_pos_x",e.currentTime,Fe),l(),m.preventDefault();break;case"ArrowRight":const ke=(e.project.cam_pos_x||0)+te;e.setProject({cam_pos_x:ke}),(S=e.setProjectKeyframe)==null||S.call(e,"cam_pos_x",e.currentTime,ke),l(),m.preventDefault();break;case"ArrowUp":if(m.ctrlKey){const fe=Math.max(100,(e.project.cam_pos_z||1e3)-te*10);e.setProject({cam_pos_z:fe}),(W=e.setProjectKeyframe)==null||W.call(e,"cam_pos_z",e.currentTime,fe)}else{const fe=(e.project.cam_pos_y||0)-te;e.setProject({cam_pos_y:fe}),(K=e.setProjectKeyframe)==null||K.call(e,"cam_pos_y",e.currentTime,fe)}l(),m.preventDefault();break;case"ArrowDown":if(m.ctrlKey){const fe=(e.project.cam_pos_z||1e3)+te*10;e.setProject({cam_pos_z:fe}),(Y=e.setProjectKeyframe)==null||Y.call(e,"cam_pos_z",e.currentTime,fe)}else{const fe=(e.project.cam_pos_y||0)+te;e.setProject({cam_pos_y:fe}),(se=e.setProjectKeyframe)==null||se.call(e,"cam_pos_y",e.currentTime,fe)}l(),m.preventDefault();break;case"r":case"R":e.setProject({cam_pos_x:0,cam_pos_y:0,cam_pos_z:1e3,cam_yaw:0,cam_pitch:0,cam_roll:0,cam_fov:90}),l(),m.preventDefault();break}return}if(!e.currentLayer)return;const w=e.currentLayer,I=h(w);switch(m.key){case"ArrowLeft":y(w,"x",I.x-d),l(),m.preventDefault();break;case"ArrowRight":y(w,"x",I.x+d),l(),m.preventDefault();break;case"ArrowUp":m.ctrlKey?(y(w,"z",(I.z||0)-d*10),l(),m.preventDefault()):(y(w,"y",I.y-d),l(),m.preventDefault());break;case"ArrowDown":m.ctrlKey?(y(w,"z",(I.z||0)+d*10),l(),m.preventDefault()):(y(w,"y",I.y+d),l(),m.preventDefault());break;case"r":case"R":y(w,"x",0),y(w,"y",0),y(w,"scale",1),y(w,"rotation",0),y(w,"opacity",1),l(),m.preventDefault();break;case"Delete":case"Backspace":confirm("Delete current layer?")&&e.removeLayer(e.currentLayerIndex),m.preventDefault();break}}function oe(){const m=e.currentLayer;if(!(!m||!m.img)){if(m.maskCanvas)B=m.maskCanvas.getContext("2d");else if(m.maskCanvas=document.createElement("canvas"),m.maskCanvas.width=m.img.width,m.maskCanvas.height=m.img.height,B=m.maskCanvas.getContext("2d"),B)if(m.customMask){const d=new Image;d.onload=()=>{B==null||B.drawImage(d,0,0),l()},d.src=m.customMask}else B.globalCompositeOperation="source-over",B.fillStyle="white",B.fillRect(0,0,m.maskCanvas.width,m.maskCanvas.height)}}function ve(m,d){const w=e.currentLayer;if(!w||((!B||!w.maskCanvas)&&oe(),!w.img||!B||!w.maskCanvas))return;const I=h(w),D=e.project.width/2+I.x,S=e.project.height/2+I.y,W=(m-D)/I.scale+w.img.width/2,K=(d-S)/I.scale+w.img.height/2,Y=e.maskMode.brush||20;B.save(),B.beginPath(),B.arc(W,K,Y,0,Math.PI*2),e.maskMode.erase?(B.globalCompositeOperation="source-over",B.fillStyle="white"):(B.globalCompositeOperation="destination-out",B.fillStyle="black"),B.fill(),B.restore(),l()}function ie(){const m=e.layers.find(w=>w.type==="background");if(!m)return null;const d=g(m);return d?((!r||!p||r.width!==d.width||r.height!==d.height||v!==m.id)&&(r=document.createElement("canvas"),r.width=d.width,r.height=d.height,p=r.getContext("2d"),p&&p.clearRect(0,0,d.width,d.height),v=m.id||null),{layer:m,img:d,ctx:p}):null}function H(m,d,w=!1){const I=ie();if(!I)return;const{layer:D,img:S,ctx:W}=I,K=h(D),Y=e.project.width/2+(K.x??0),se=e.project.height/2+(K.y??0),te=K.scale??1,Fe=(m-Y)/te+S.width/2,ke=(d-se)/te+S.height/2,fe=Math.max(1,e.extractMode.brush||30);W.beginPath(),W.arc(Fe,ke,fe,0,Math.PI*2),W.fillStyle=w?"black":"white",W.fill(),l()}function re(){p&&r&&(p.clearRect(0,0,r.width,r.height),l())}function ne(){if(!p||!r)return!1;const m=p.getImageData(0,0,r.width,r.height).data;for(let d=0;d<m.length;d+=4)if(m[d]>10)return!0;return!1}function de(m,d,w){const I=m.canvas,D=document.createElement("canvas");D.width=d,D.height=w;const S=D.getContext("2d");if(!S)return null;S.drawImage(I,0,0);const W=20;S.globalCompositeOperation="destination-over";for(let K=0;K<W;K++)S.drawImage(D,1,0),S.drawImage(D,-1,0),S.drawImage(D,0,1),S.drawImage(D,0,-1),K%2===0&&(S.drawImage(D,1,1),S.drawImage(D,-1,-1),S.drawImage(D,1,-1),S.drawImage(D,-1,1));for(let K=0;K<10;K++)S.drawImage(D,2,0),S.drawImage(D,-2,0),S.drawImage(D,0,2),S.drawImage(D,0,-2),S.drawImage(D,2,2),S.drawImage(D,-2,-2),S.drawImage(D,2,-2),S.drawImage(D,-2,2);return D.toDataURL("image/png")}function Ce(){const m=ie();if(!m||!r||!p)return{error:"Background layer not ready"};if(!ne())return null;const{img:d}=m,w=document.createElement("canvas");w.width=d.width,w.height=d.height;const I=w.getContext("2d");if(!I)return{error:"Cannot create temporary canvas"};I.drawImage(d,0,0),I.globalCompositeOperation="destination-in",I.drawImage(r,0,0);const D=w.toDataURL("image/png"),S=document.createElement("canvas");S.width=d.width,S.height=d.height;const W=S.getContext("2d");if(!W)return{error:"Cannot create background canvas"};W.drawImage(d,0,0),W.globalCompositeOperation="destination-out",W.drawImage(r,0,0),W.globalCompositeOperation="source-over";const K=de(W,d.width,d.height)||d.src,Y=r.toDataURL("image/png");return{foregroundDataUrl:D,backgroundDataUrl:K,extractMaskDataUrl:Y}}function Me(m){var qe,Qe,dt,ft,ht;if(!e.extractMode.enabled||!r||!v)return;const d=e.layers.find(st=>st.id===v);if(!d)return;const w=g(d);if(!w)return;const I=h(d),D=e.project.width,S=e.project.height,W=D/2,K=S/2,Y=w.width,se=w.height,te=!!e.project.cam_enable,Fe=te?((qe=e.interpolateProjectValue)==null?void 0:qe.call(e,"cam_pos_x",e.currentTime,e.project.cam_pos_x||0))??(e.project.cam_pos_x||0):0,ke=te?((Qe=e.interpolateProjectValue)==null?void 0:Qe.call(e,"cam_pos_y",e.currentTime,e.project.cam_pos_y||0))??(e.project.cam_pos_y||0):0,fe=te?((dt=e.interpolateProjectValue)==null?void 0:dt.call(e,"cam_pos_z",e.currentTime,e.project.cam_pos_z||0))??(e.project.cam_pos_z||0):0,Ke=((ft=e.interpolateProjectValue)==null?void 0:ft.call(e,"cam_offset_x",e.currentTime,e.project.cam_offset_x||0))??(e.project.cam_offset_x||0),xe=((ht=e.interpolateProjectValue)==null?void 0:ht.call(e,"cam_offset_y",e.currentTime,e.project.cam_offset_y||0))??(e.project.cam_offset_y||0),ge=te?Math.max(.2,Math.min(4,1/(1+fe*.001))):1,we=I.z||0,ce=1/Math.max(.1,1+we*.001),J=te?ce:1,Ae=te?ge:1;let rt=1;if(Y>0&&se>0){const st=d.bg_mode||"fit";st==="fit"?rt=Math.min(D/Y,S/se):st==="fill"?rt=Math.max(D/Y,S/se):rt=Math.min(D/Y,S/se)}const Je=((I.x??0)+(Ke+Fe)*J)*Ae,ct=((I.y??0)+(xe+ke)*J)*Ae,lt=(I.scale??1)*rt*Ae*ce;m.save(),m.translate(W+Je,K+ct),m.rotate((I.rotation??0)*Math.PI/180),m.scale(lt,lt),m.fillStyle="rgba(0, 0, 0, 0.65)",m.fillRect(-Y/2,-se/2,Y,se),m.globalCompositeOperation="destination-out",m.drawImage(r,-Y/2,-se/2,Y,se),m.restore()}function ye(m,d){const w=e.currentLayer;if(!w)return;w.bezierPath||(w.bezierPath=[]);const I=Le(m);if(I>=0)x=I,P=!0;else{const D=e.project.width/2,S=e.project.height/2;w.bezierPath.push({x:m.x-D,y:m.y-S}),w.bezierPath.length>=2&&(w.usePathAnimation=!0),l()}}function Le(m){const d=e.currentLayer;if(!d||!d.bezierPath)return-1;const w=e.project.width/2,I=e.project.height/2,D=10;for(let S=0;S<d.bezierPath.length;S++){const W=d.bezierPath[S],K=W.x+w-m.x,Y=W.y+I-m.y;if(Math.sqrt(K*K+Y*Y)<D)return S}return-1}function be(m){const d=e.currentLayer;if(!d||!d.bezierPath||x<0)return;const w=e.project.width/2,I=e.project.height/2;d.bezierPath[x].x=m.x-w,d.bezierPath[x].y=m.y-I,l()}return{onMouseDown:C,onMouseMove:F,onMouseUp:k,onWheel:T,onKeyDown:A,getCanvasCoords:f,clearExtractSelection:re,applyExtractSelection:Ce,drawExtractOverlayOnCtx:Me}}function xa(e,n,t,l,h){const{x:g,y:j,z:R,rotationX:G,rotationY:E,rotationZ:q,scaleX:z,scaleY:$,scaleZ:U,anchorX:ee,anchorY:Z}=e,me=ee*n,V=Z*t;let L=g-me,Ye=j-V;if(l!==void 0&&h!==void 0){const Be=n*z,ze=t*$;L=l/2+g-Be/2-me*z,Ye=h/2+j-ze/2-V*$}const Te=[];return Te.push(`translate3d(${L}px, ${Ye}px, ${R}px)`),G!==0&&Te.push(`rotateX(${G}deg)`),E!==0&&Te.push(`rotateY(${E}deg)`),q!==0&&Te.push(`rotateZ(${q}deg)`),(z!==1||$!==1||U!==1)&&Te.push(`scale3d(${z}, ${$}, ${U})`),Te.join(" ")}function Pa(e,n){const t=(.5+e)*100,l=(.5+n)*100;return`${t}% ${l}%`}function wa(e,n){const t=Math.max(1,Math.min(179,e))*Math.PI/180;return n/(2*Math.tan(t/2))}function ta(e,n,t,l){const{cam_pos_x:h,cam_pos_y:g,cam_pos_z:j,cam_yaw:R,cam_pitch:G}=l,E=e-h,q=n-g,z=t-j,$=R*Math.PI/180,U=G*Math.PI/180,ee=Math.cos($),Z=Math.sin($),me=Math.cos(U),V=Math.sin(U),L=E*Z+z*ee;return q*V+L*me}function ja(e,n){return[...e].sort((t,l)=>{const h=ta(t.x,t.y,t.z,n);return ta(l.x,l.y,l.z,n)-h})}const Ma={class:"canvas-wrapper"},ka=["src","alt"],Ta=["width","height"],Ca=["width","height"],Sa={class:"canvas-info"},za={key:0},La={key:1},Fa={key:2,style:{color:"#ff9800","margin-left":"10px"}},Ia=Tt({__name:"CanvasPreview",setup(e,{expose:n}){const t=zt(),l=Pe(),h=Pe(),g=Pe(),j=_a(t,l,h),{initContexts:R,scheduleRender:G,getCachedImage:E,getLayerProps:q,setDrawExtractOverlayOnCtx:z,cleanup:$}=j,U=je(()=>t.project.preview_mode==="3d-css"),ee=je(()=>({x:Math.max(0,(t.project.width||0)/2),y:Math.max(0,(t.project.height||0)/2)})),Z=je(()=>({cam_pos_x:t.project.cam_pos_x??0,cam_pos_y:t.project.cam_pos_y??0,cam_pos_z:t.project.cam_pos_z??1e3,cam_yaw:t.project.cam_yaw??0,cam_pitch:t.project.cam_pitch??0,cam_roll:t.project.cam_roll??0,cam_fov:t.project.cam_fov??90})),me=je(()=>{const B=Math.max(1,t.project.height||1);return wa(Z.value.cam_fov,B)}),V=je(()=>({width:`${t.project.width}px`,height:`${t.project.height}px`,perspective:`${Math.round(me.value)}px`,perspectiveOrigin:"50% 50%",transformStyle:"preserve-3d"})),L=je(()=>{const B=[],r=Z.value,p=t.project.cam_offset_x||0,_=t.project.cam_offset_y||0;B.push(`translate3d(${ee.value.x}px, ${ee.value.y}px, 0px)`);const v=-(r.cam_pos_x+p),P=-(r.cam_pos_y+_),x=-(r.cam_pos_z||0);if(B.push(`translate3d(${v}px, ${P}px, ${x}px)`),t.project.cam_enable){r.cam_pitch!==0&&B.push(`rotateX(${-r.cam_pitch}deg)`),r.cam_yaw!==0&&B.push(`rotateY(${-r.cam_yaw}deg)`),r.cam_roll!==0&&B.push(`rotateZ(${-r.cam_roll}deg)`);const c=Math.max(.2,Math.min(4,1/(1+(r.cam_pos_z??1e3)*.001)));c!==1&&B.push(`scale(${c})`)}return{transform:B.join(" ")||void 0,transformStyle:"preserve-3d"}}),Ye=je(()=>{if(!U.value)return[];Ve.value;const B=t.layers.map(_=>{const v=E(_);if(!v||!v.complete)return null;const P=Math.max(1,t.project.width||1),x=Math.max(1,t.project.height||1),c=q(_);let f=1;if(_.type==="background"&&v.width&&v.height){const ie=_.bg_mode||"fit";ie==="fit"?f=Math.min(P/v.width,x/v.height):ie==="fill"?f=Math.max(P/v.width,x/v.height):f=Math.min(P/v.width,x/v.height),(!Number.isFinite(f)||f<=0)&&(f=1)}const y=(_.scaleX??c.scale??1)*f,C=(_.scaleY??c.scale??1)*f,F=_.scaleZ??1,k=c.x,T=c.y,A=c.z||0,oe=c.rotationZ!==void 0&&c.rotationZ!==0?c.rotationZ:c.rotation,ve=xa({x:k,y:T,z:A,rotationX:c.rotationX||0,rotationY:c.rotationY||0,rotationZ:oe||0,scaleX:y,scaleY:C,scaleZ:F,anchorX:_.anchorX??0,anchorY:_.anchorY??0,opacity:c.opacity??1},v.width,v.height,P,x);return{id:_.id,type:_.type,src:v.src||_.image_data,width:v.width,height:v.height,opacity:c.opacity??1,transform:ve,origin:Pa(_.anchorX??0,_.anchorY??0),x:k,y:T,z:A}}).filter(Boolean),r={cam_pos_x:Z.value.cam_pos_x,cam_pos_y:Z.value.cam_pos_y,cam_pos_z:Z.value.cam_pos_z,cam_yaw:Z.value.cam_yaw,cam_pitch:Z.value.cam_pitch,cam_roll:Z.value.cam_roll,cam_fov:Z.value.cam_fov};return ja(B,r)}),Te=je(()=>{const B=Z.value,r=[];return r.push("translate3d(0, 0, 0)"),B.cam_pitch&&r.push(`rotateX(${-B.cam_pitch}deg)`),B.cam_yaw&&r.push(`rotateY(${-B.cam_yaw}deg)`),B.cam_roll&&r.push(`rotateZ(${-B.cam_roll}deg)`),r.push("scale(0.6)"),{transform:r.join(" ")||void 0}}),Be=ba(t,l,h,G,q,E),{onMouseDown:ze,onMouseMove:De,onMouseUp:Xe,onWheel:Ue,onKeyDown:Ee,clearExtractSelection:pe,applyExtractSelection:Ge,drawExtractOverlayOnCtx:$e}=Be;z($e),Ct(()=>{R(),G()}),ca(()=>{$()});const Ve=Pe(0),_e=()=>{U.value?Ve.value++:G()};return yt(()=>[t.layers,t.currentLayer,t.currentTime],()=>{_e()},{deep:!0}),yt(()=>t.project,()=>{_e()},{deep:!0}),yt(()=>[t.project.cam_enable,t.project.cam_pos_x,t.project.cam_pos_y,t.project.cam_pos_z,t.project.cam_offset_x,t.project.cam_offset_y,t.project.cam_yaw,t.project.cam_pitch,t.project.cam_roll,t.project.cam_fov,t.project.pano_enable],()=>{_e()}),yt(()=>t.extractMode.enabled,()=>{_e()}),yt(()=>[t.maskMode.enabled,t.pathMode.enabled],()=>{_e()}),yt(U,B=>{B||G()}),n({clearExtractSelection:pe,applyExtractSelection:Ge}),(B,r)=>(ue(),le("div",{class:"canvas-preview",ref_key:"containerRef",ref:g},[i("div",Ma,[U.value?(ue(),le("div",{key:0,class:"css-preview",style:Ne(V.value)},[i("div",{class:"css-camera",style:Ne(L.value)},[(ue(!0),le(Ze,null,nt(Ye.value,(p,_)=>(ue(),le("div",{key:p.id,class:"css-layer",style:Ne({width:p.width+"px",height:p.height+"px",opacity:p.opacity,transform:p.transform,transformOrigin:p.origin,zIndex:_})},[i("img",{src:p.src,alt:p.id,draggable:"false"},null,8,ka)],4))),128))],4),i("div",{class:"axis-widget",style:Ne(Te.value)},[...r[7]||(r[7]=[la('<div class="axis axis-x" data-v-33c515a4></div><div class="axis axis-y" data-v-33c515a4></div><div class="axis axis-z" data-v-33c515a4></div><div class="axis-label axis-label-x" data-v-33c515a4>X</div><div class="axis-label axis-label-y" data-v-33c515a4>Y</div><div class="axis-label axis-label-z" data-v-33c515a4>Z</div>',6)])],4)],4)):He("",!0),i("canvas",{ref_key:"canvasRef",ref:l,width:M(t).project.width,height:M(t).project.height,class:Oe(["render-canvas",{"css-mode-hidden":U.value}])},null,10,Ta),i("canvas",{ref_key:"interactionCanvasRef",ref:h,width:M(t).project.width,height:M(t).project.height,class:Oe(["interaction-canvas",{"css-mode":U.value}]),onMousedown:r[0]||(r[0]=(...p)=>M(ze)&&M(ze)(...p)),onMousemove:r[1]||(r[1]=(...p)=>M(De)&&M(De)(...p)),onMouseup:r[2]||(r[2]=(...p)=>M(Xe)&&M(Xe)(...p)),onMouseleave:r[3]||(r[3]=(...p)=>M(Xe)&&M(Xe)(...p)),onWheel:r[4]||(r[4]=We((...p)=>M(Ue)&&M(Ue)(...p),["prevent"])),onContextmenu:r[5]||(r[5]=We(()=>{},["prevent"])),tabindex:"0",onKeydown:r[6]||(r[6]=(...p)=>M(Ee)&&M(Ee)(...p))},null,42,Ca),i("div",Sa,[M(t).currentLayer?(ue(),le("span",za," Layer "+he(M(t).currentLayerIndex+1)+" | X:"+he(Math.round(M(t).currentLayer.x||0))+" Y:"+he(Math.round(M(t).currentLayer.y||0))+" S:"+he((M(t).currentLayer.scale||1).toFixed(2))+" R:"+he(Math.round(M(t).currentLayer.rotation||0))+"° ",1)):(ue(),le("span",La,"No layer selected")),M(t).project.cam_enable?(ue(),le("span",Fa," 📷 3D Camera (Preview Approximation) ")):He("",!0)])])],512))}}),Ya=St(Ia,[["__scopeId","data-v-33c515a4"]]),Da={class:"project-settings"},Xa={class:"setting-row"},Ea=["value"],Ua={class:"setting-row"},Aa=["value"],Ba={class:"setting-row"},Ra=["value"],$a={class:"setting-row"},Va=["value"],Ka={class:"setting-row"},Oa=["checked"],Ga={key:0,class:"setting-note"},Za={class:"setting-row"},Wa=["checked"],Na={class:"setting-row"},qa=["value"],Ha={class:"setting-row"},Ja=["value"],Qa={class:"setting-row"},en=["value"],tn={class:"setting-row"},an=["value"],nn={class:"setting-row"},on=["value"],rn={class:"setting-row"},sn=["value"],cn={class:"setting-row"},ln=["value"],un={class:"setting-row"},mn=["value"],pn=Tt({__name:"ProjectSettings",setup(e){const n=zt(),t=Pe(!1);Ct(()=>{t.value=localStorage.getItem("timeline_disable_gpu")==="true"});function l(V){V.target.checked?(localStorage.removeItem("timeline_disable_gpu"),t.value=!1):(localStorage.setItem("timeline_disable_gpu","true"),t.value=!0),alert("GPU设置已更改，请刷新页面以应用更改。")}function h(V){n.setProject({width:parseInt(V.target.value)||1280})}function g(V){n.setProject({height:parseInt(V.target.value)||720})}function j(V){n.setProject({fps:parseInt(V.target.value)||30})}function R(V){n.setProject({total_frames:parseInt(V.target.value)||150})}function G(V){n.setProject({cam_enable:V.target.checked})}function E(V){n.setProject({cam_pos_x:parseFloat(V.target.value)||0})}function q(V){n.setProject({cam_pos_y:parseFloat(V.target.value)||0})}function z(V){n.setProject({cam_pos_z:parseFloat(V.target.value)||0})}function $(V){n.setProject({cam_yaw:parseFloat(V.target.value)||0})}function U(V){n.setProject({cam_pitch:parseFloat(V.target.value)||0})}function ee(V){n.setProject({cam_roll:parseFloat(V.target.value)||0})}function Z(V){n.setProject({cam_fov:parseFloat(V.target.value)||90})}function me(V){const L=V.target.value;n.setProject({preview_mode:L})}return(V,L)=>(ue(),le("div",Da,[L[21]||(L[21]=i("div",{class:"section-title"},"📐 项目",-1)),i("div",Xa,[L[0]||(L[0]=i("label",null,"宽度",-1)),i("input",{type:"number",value:M(n).project.width,onInput:h,min:"64",max:"8192"},null,40,Ea)]),i("div",Ua,[L[1]||(L[1]=i("label",null,"高度",-1)),i("input",{type:"number",value:M(n).project.height,onInput:g,min:"64",max:"8192"},null,40,Aa)]),i("div",Ba,[L[2]||(L[2]=i("label",null,"帧率",-1)),i("input",{type:"number",value:M(n).project.fps,onInput:j,min:"1",max:"120"},null,40,Ra)]),i("div",$a,[L[3]||(L[3]=i("label",null,"帧数",-1)),i("input",{type:"number",value:M(n).project.total_frames,onInput:R,min:"1",max:"9999"},null,40,Va)]),L[22]||(L[22]=i("div",{class:"section-title"},"🖥️ 预览渲染",-1)),i("div",Ka,[L[4]||(L[4]=i("label",null,"GPU加速",-1)),i("input",{type:"checkbox",checked:!t.value,onChange:l},null,40,Oa)]),t.value?(ue(),le("div",Ga,[...L[5]||(L[5]=[i("small",{style:{color:"#f90","font-size":"10px"}}," ⚠️ 已禁用GPU，使用Canvas 2D渲染 ",-1)])])):He("",!0),L[23]||(L[23]=i("div",{class:"section-title"},"🎥 3D 摄像机",-1)),i("div",Za,[L[6]||(L[6]=i("label",null,"启用",-1)),i("input",{type:"checkbox",checked:M(n).project.cam_enable,onChange:G},null,40,Wa)]),M(n).project.cam_enable?(ue(),le(Ze,{key:1},[L[16]||(L[16]=i("div",{class:"subsection-title"},"位置",-1)),i("div",Na,[L[7]||(L[7]=i("label",null,"X",-1)),i("input",{type:"number",value:M(n).project.cam_pos_x,onInput:E,step:"10"},null,40,qa)]),i("div",Ha,[L[8]||(L[8]=i("label",null,"Y",-1)),i("input",{type:"number",value:M(n).project.cam_pos_y,onInput:q,step:"10"},null,40,Ja)]),i("div",Qa,[L[9]||(L[9]=i("label",null,"Z (距离)",-1)),i("input",{type:"number",value:M(n).project.cam_pos_z,onInput:z,step:"50"},null,40,en)]),L[17]||(L[17]=i("div",{class:"subsection-title"},"旋转",-1)),i("div",tn,[L[10]||(L[10]=i("label",null,"Yaw (Y轴)",-1)),i("input",{type:"number",value:M(n).project.cam_yaw,onInput:$,step:"5"},null,40,an)]),i("div",nn,[L[11]||(L[11]=i("label",null,"Pitch (X轴)",-1)),i("input",{type:"number",value:M(n).project.cam_pitch,onInput:U,step:"5"},null,40,on)]),i("div",rn,[L[12]||(L[12]=i("label",null,"Roll (Z轴)",-1)),i("input",{type:"number",value:M(n).project.cam_roll,onInput:ee,step:"5"},null,40,sn)]),L[18]||(L[18]=i("div",{class:"subsection-title"},"投影",-1)),i("div",cn,[L[13]||(L[13]=i("label",null,"FOV",-1)),i("input",{type:"number",value:M(n).project.cam_fov,onInput:Z,min:"1",max:"179",step:"5"},null,40,ln)]),L[19]||(L[19]=i("div",{class:"subsection-title"},"预览模式",-1)),i("div",un,[L[15]||(L[15]=i("label",null,"模式",-1)),i("select",{value:M(n).project.preview_mode||"2d",onChange:me,style:{width:"80px",padding:"4px",background:"#1a1a1a",border:"1px solid #444","border-radius":"3px",color:"#fff","font-size":"11px"}},[...L[14]||(L[14]=[i("option",{value:"2d"},"2D 近似",-1),i("option",{value:"3d-css"},"3D CSS (实验性)",-1)])],40,mn)]),L[20]||(L[20]=i("div",{class:"setting-note"},[i("small",{style:{color:"#666","font-size":"10px","line-height":"1.4"}},[Wt(" ⚠️ 预览仅为近似效果"),i("br"),Wt(" 最终渲染使用完整3D透视 ")])],-1))],64)):He("",!0)]))}}),dn=St(pn,[["__scopeId","data-v-dd7a8f2f"]]),fn={class:"ae-timeline-root"},hn={class:"ae-header"},vn={class:"header-center"},yn={class:"project-info"},gn={class:"header-right"},_n={class:"project-inputs"},bn={class:"project-field"},xn=["value"],Pn={class:"project-field"},wn=["value"],jn={class:"project-field"},Mn=["value"],kn={class:"project-field"},Tn=["value"],Cn={class:"project-field pano-field"},Sn={class:"hdr-toggle"},zn={class:"hdr-toggle cam-enable"},Ln={class:"cam-row"},Fn=["value"],In=["value"],Yn=["value"],Dn=["value"],Xn={class:"cam-row cam-row-3d"},En=["value"],Un=["value"],An=["value"],Bn={class:"ae-main"},Rn={class:"ae-inspector"},$n={key:0,class:"inspector-card"},Vn={class:"card-header"},Kn={class:"layer-title"},On={class:"card-subtitle"},Gn={key:1,class:"inspector-card empty"},Zn={key:2,class:"inspector-section"},Wn={class:"property-list"},Nn={class:"property-row"},qn=["value"],Hn={class:"property-row"},Jn=["value"],Qn={class:"property-row"},eo=["value"],to={class:"property-row"},ao=["value"],no={class:"property-row"},oo=["value"],io={class:"property-row"},ro=["value"],so={class:"property-row"},co=["value"],lo={class:"property-row slider-row"},uo={class:"slider-header"},mo={class:"prop-value"},po=["value"],fo={class:"inspector-section"},ho={class:"tools-grid"},vo=["disabled"],yo={key:0,class:"tool-settings"},go={class:"slider-header"},_o={class:"prop-value"},bo={key:1,class:"tool-settings"},xo={class:"slider-header"},Po={class:"prop-value"},wo={class:"inspector-section"},jo={class:"inspector-section"},Mo={class:"fit-row"},ko={class:"ae-viewport"},To={class:"viewport-bar"},Co={class:"duration-text"},So={class:"viewport-actions"},zo={class:"time-text"},Lo={class:"zoom-control"},Fo={class:"prop-value"},Io={class:"viewport-canvas"},Yo={class:"ae-timeline"},Do={class:"timeline-controls"},Xo={class:"controls-left"},Eo=["disabled"],Uo=["disabled"],Ao={class:"controls-center"},Bo={class:"time-display"},Ro={class:"playback-btns"},$o={class:"timeline-body"},Vo={class:"layers-panel"},Ko={class:"layers-header"},Oo={class:"prop-label-small"},Go=["onClick"],Zo=["onClick"],Wo={class:"layer-name"},No={class:"layer-btns"},qo=["onClick"],Ho=["onClick"],Jo={class:"prop-label-small"},Qo={class:"tick-text"},ei=["title","onMousedown","onContextmenu"],ti=["onDblclick"],ai=["title","onMousedown","onContextmenu"],ni=["onClick"],oi=["onClick"],ii=["onDblclick"],ri=["title","onMousedown","onClick","onContextmenu"],_t=80,si=Tt({__name:"TimelineApp",props:{node:{}},setup(e){const n=e,t=zt(),l=Pe(null),h=Pe(),g=Pe(),j=Pe(),R=Pe(0);let G="foreground",E=!1,q=null;const z=s=>{var a,o;return(o=(a=n.node)==null?void 0:a.widgets)==null?void 0:o.find(u=>u.name===s)};function $(s,a){const o=typeof s=="number"?s:parseFloat(s);return Number.isFinite(o)?o:a}const U=Pe("fit"),ee=Pe(100),Z=je(()=>Math.max(.1,ee.value/100)),me=je({get:()=>!!t.project.cam_enable,set:s=>{t.setProject({cam_enable:s}),Y("cam_enable",s?1:0)}}),V=je({get:()=>t.project.pano_enable,set:s=>{t.setProject({pano_enable:s}),Y("pano_enable",s?1:0)}}),L=je({get:()=>t.project.cam_yaw,set:s=>{const a=Number.isFinite(s)?s:t.project.cam_yaw;t.setProject({cam_yaw:a}),Y("cam_yaw",a)}}),Ye=je({get:()=>t.project.cam_pitch,set:s=>{const a=Number.isFinite(s)?s:t.project.cam_pitch;t.setProject({cam_pitch:a}),Y("cam_pitch",a)}}),Te=je({get:()=>t.project.cam_roll,set:s=>{const a=Number.isFinite(s)?s:t.project.cam_roll;t.setProject({cam_roll:a}),Y("cam_roll",a)}}),Be=je({get:()=>t.project.cam_fov,set:s=>{const a=Number.isFinite(s)?s:t.project.cam_fov,o=Math.min(170,Math.max(10,a));t.setProject({cam_fov:o}),Y("cam_fov",o)}}),ze=je({get:()=>t.project.cam_pos_x||0,set:s=>{const a=Number.isFinite(s)?s:t.project.cam_pos_x||0;t.setProject({cam_pos_x:a}),Y("cam_pos_x",a)}}),De=je({get:()=>t.project.cam_pos_y||0,set:s=>{const a=Number.isFinite(s)?s:t.project.cam_pos_y||0;t.setProject({cam_pos_y:a}),Y("cam_pos_y",a)}}),Xe=je({get:()=>t.project.cam_pos_z||0,set:s=>{const a=Number.isFinite(s)?s:t.project.cam_pos_z||0;t.setProject({cam_pos_z:a}),Y("cam_pos_z",a)}});function Ue(s){var a;if(s.code==="Space"){const o=(a=s.target)==null?void 0:a.tagName;if(o==="INPUT"||o==="TEXTAREA"||o==="SELECT")return;s.preventDefault(),s.stopPropagation(),t.togglePlayback()}}const Ee=je(()=>{const s=Math.max(1,t.project.fps||1);return t.project.duration||t.project.total_frames/s||0}),pe=je(()=>{var u;const s=Math.max(.001,Ee.value||0),a=R.value||((u=j.value)==null?void 0:u.clientWidth)||0,o=a?a/s:_t;return Math.max(_t,o)}),Ge=je(()=>{var b;const o=Ee.value*pe.value+120,u=R.value||((b=j.value)==null?void 0:b.clientWidth)||0;return Math.max(o,u,800)});yt(()=>t.extractMode.enabled,s=>{var a,o;s||(o=(a=l.value)==null?void 0:a.clearExtractSelection)==null||o.call(a)});function $e(){var b;if(!j.value){setTimeout($e,100);return}const s=j.value.getBoundingClientRect(),a=((b=j.value.parentElement)==null?void 0:b.clientWidth)||s.width||0,o=typeof window<"u"?window.innerWidth:a,u=Math.max(a||o,800);u>0&&(R.value=u)}Ct(()=>{I(),$e(),typeof ResizeObserver<"u"&&j.value?(q=new ResizeObserver(s=>{const a=s[0];a!=null&&a.contentRect&&(R.value=a.contentRect.width)}),q.observe(j.value)):window.addEventListener("resize",$e),window.addEventListener("keydown",Ue,{capture:!0}),window.addEventListener("beforeunload",ft,{capture:!0})});let Ve=!1,_e=null;const B=Pe(new Set([0])),r=Pe(!1),p=Pe(null),_=[{key:"x",label:"X"},{key:"y",label:"Y"},{key:"z",label:"Z"},{key:"scale",label:"Scl"},{key:"rotation",label:"RotZ"},{key:"rotationX",label:"RotX"},{key:"rotationY",label:"RotY"},{key:"opacity",label:"Op"}],v=[{key:"cam_yaw",label:"Yaw"},{key:"cam_pitch",label:"Pitch"},{key:"cam_roll",label:"Roll"},{key:"cam_fov",label:"FOV"},{key:"cam_offset_x",label:"OffX"},{key:"cam_offset_y",label:"OffY"},{key:"cam_pos_x",label:"PosX"},{key:"cam_pos_y",label:"PosY"},{key:"cam_pos_z",label:"PosZ"}],P=je(()=>{const s=t.currentLayer;if(!s)return{x:0,y:0,z:0,scale:1,rotation:0,rotationX:0,rotationY:0,rotationZ:0,opacity:1};const a=t.currentTime,o=s.keyframes||{};return{x:x(o.x,a,s.x||0),y:x(o.y,a,s.y||0),z:x(o.z,a,s.z||0),scale:x(o.scale,a,s.scale||1),rotation:x(o.rotation,a,s.rotation||0),rotationX:x(o.rotationX,a,s.rotationX||0),rotationY:x(o.rotationY,a,s.rotationY||0),rotationZ:x(o.rotationZ,a,s.rotationZ||s.rotation||0),opacity:x(o.opacity,a,s.opacity??1)}});function x(s,a,o){if(!s||s.length===0)return o;const u=[...s].sort((b,X)=>b.time-X.time);if(a<=u[0].time)return u[0].value;if(a>=u[u.length-1].time)return u[u.length-1].value;for(let b=0;b<u.length-1;b++)if(a>=u[b].time&&a<=u[b+1].time){const X=(a-u[b].time)/(u[b+1].time-u[b].time);return u[b].value+(u[b+1].value-u[b].value)*X}return o}function c(s,a){const o=t.currentLayer;if(!o)return;const u=parseFloat(a.target.value);if(isNaN(u))return;const b=t.currentTime;if(o.keyframes&&o.keyframes[s]&&o.keyframes[s].length>0){const X=o.keyframes[s].findIndex(O=>Math.abs(O.time-b)<.05);X>=0?o.keyframes[s][X]={time:o.keyframes[s][X].time,value:u}:(o.keyframes[s].push({time:b,value:u}),o.keyframes[s].sort((O,ae)=>O.time-ae.time))}t.updateLayer(t.currentLayerIndex,{[s]:u})}function f(s){const a=t.currentLayer;if(!a)return;const o=parseFloat(s.target.value);if(isNaN(o))return;const u=o/100,b=t.currentTime;if(a.keyframes&&a.keyframes.scale&&a.keyframes.scale.length>0){const X=a.keyframes.scale.findIndex(O=>Math.abs(O.time-b)<.05);X>=0?a.keyframes.scale[X]={time:a.keyframes.scale[X].time,value:u}:(a.keyframes.scale.push({time:b,value:u}),a.keyframes.scale.sort((O,ae)=>O.time-ae.time))}t.updateLayer(t.currentLayerIndex,{scale:u})}function y(s){const a=Math.floor(s/60),o=Math.floor(s%60),u=Math.floor(s%1*t.project.fps);return`${a.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}:${u.toString().padStart(2,"0")}`}function C(s,a){return!s.keyframes||!s.keyframes[a]?[]:s.keyframes[a].map(o=>({time:o.time,value:o.value}))}function F(s){const a=[];if(!s.keyframes)return a;for(const o of _){const u=s.keyframes[o.key];u&&u.forEach(b=>a.push({time:b.time,prop:o.key}))}return a}function k(){const s=[],a=t.projectKeyframes;return v.forEach(o=>{const u=a[o.key];Array.isArray(u)&&u.forEach(b=>{typeof(b==null?void 0:b.time)=="number"&&s.push({time:b.time,prop:o.key,value:b.value??0})})}),s}function T(s,a){return a==="opacity"||a==="scale"?(s*100).toFixed(0)+"%":s.toFixed(1)}function A(s){B.value.has(s)?B.value.delete(s):B.value.add(s)}function oe(){r.value=!r.value}function ve(s){const o=t.projectKeyframes[s];return Array.isArray(o)?o.map(u=>({time:u.time,value:u.value??0})):[]}function ie(s,a){const o=ne(s),u=t.project[a]??0;t.setProjectKeyframe(a,o,u)}function H(s,a,o){if(s.button!==0)return;s.preventDefault();const u=s.clientX,b=o.time,X=o.value,O=N=>{const et=(N.clientX-u)/pe.value,Re=Math.max(0,Math.min(Ee.value,b+et));t.deleteProjectKeyframe(a,o.time),t.setProjectKeyframe(a,Re,X),o.time=Re,t.setCurrentTime(Re)},ae=()=>{document.removeEventListener("mousemove",O),document.removeEventListener("mouseup",ae)};document.addEventListener("mousemove",O),document.addEventListener("mouseup",ae)}function re(s){var a,o;s.hidden=!s.hidden,(o=(a=l.value)==null?void 0:a.scheduleRender)==null||o.call(a)}function ne(s){if(!j.value)return 0;const a=j.value.querySelector(".tracks-content");if(!a)return 0;const o=a.getBoundingClientRect(),u=j.value.scrollLeft,b=s.clientX-o.left+u,X=pe.value||_t;if(b<=10)return 0;const O=b/X;return Math.max(0,Math.min(O,Ee.value))}function de(s){s.preventDefault(),E=!0,t.setCurrentTime(ne(s));const a=u=>{E&&t.setCurrentTime(ne(u))},o=()=>{E=!1,document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",o)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",o)}function Ce(s){if(!t.currentLayer)return;const a=ne(s);t.setCurrentTime(a),t.addKeyframe()}function Me(s,a,o){const b=s.currentTarget.getBoundingClientRect(),X=s.clientX-b.left,O=pe.value||_t,ae=Math.max(0,X/O),N=t.layers[a];if(!N)return;const Ie=N[o]??(o==="scale"||o==="opacity"?1:0);N.keyframes||(N.keyframes={}),N.keyframes[o]||(N.keyframes[o]=[]),N.keyframes[o].find(Re=>Math.abs(Re.time-ae)<.05)||(N.keyframes[o].push({time:ae,value:Ie}),N.keyframes[o].sort((Re,tt)=>Re.time-tt.time))}function ye(s,a,o){p.value={layerIdx:s,prop:a,time:o},t.selectLayer(s),t.setCurrentTime(o)}function Le(s,a,o){const u=p.value;return u?u.layerIdx===s&&u.prop===a&&Math.abs(u.time-o)<.01:!1}function be(s,a,o,u){s.preventDefault(),Ve=!0,_e={layerIdx:a,prop:o,originalTime:u.time},ye(a,o,u.time);const b=s.clientX,X=u.time,O=pe.value||_t,ae=Ie=>{var ot;if(!Ve||!_e)return;const Re=(Ie.clientX-b)/O;let tt=Math.max(0,X+Re);const ut=t.layers[_e.layerIdx];if((ot=ut==null?void 0:ut.keyframes)!=null&&ot[_e.prop]){const at=ut.keyframes[_e.prop],mt=at.findIndex(jt=>Math.abs(jt.time-_e.originalTime)<.01);mt>=0&&(at[mt].time=tt,_e.originalTime=tt,p.value.time=tt,t.setCurrentTime(tt))}},N=()=>{var et;Ve=!1,_e=null,document.removeEventListener("mousemove",ae),document.removeEventListener("mouseup",N);const Ie=t.layers[a];(et=Ie==null?void 0:Ie.keyframes)!=null&&et[o]&&Ie.keyframes[o].sort((Re,tt)=>Re.time-tt.time)};document.addEventListener("mousemove",ae),document.addEventListener("mouseup",N)}function m(s,a,o){var b,X,O,ae;const u=t.layers[s];(b=u==null?void 0:u.keyframes)!=null&&b[a]&&(u.keyframes[a]=u.keyframes[a].filter(N=>Math.abs(N.time-o)>.01),((X=p.value)==null?void 0:X.layerIdx)===s&&((O=p.value)==null?void 0:O.prop)===a&&Math.abs(((ae=p.value)==null?void 0:ae.time)-o)<.01&&(p.value=null))}function d(s){if(j.value){const a=s.target,o=j.value.querySelector(".tracks-list");o&&(o.scrollTop=a.scrollTop)}}function w(s){const a=s.target,o=document.querySelector(".layers-list");o&&(o.scrollTop=a.scrollTop)}function I(){var Lt,Ft,It,Yt,Dt,Xt,Et,Ut,At,Bt,Rt,$t,Vt,Kt,Ot,Gt;if(!((Lt=n.node)!=null&&Lt.widgets))return;const s=$((Ft=z("width"))==null?void 0:Ft.value,t.project.width),a=$((It=z("height"))==null?void 0:It.value,t.project.height),o=Math.max(1,$((Yt=z("fps"))==null?void 0:Yt.value,t.project.fps)),u=Math.max(1,Math.round($((Dt=z("total_frames"))==null?void 0:Dt.value,t.project.total_frames))),b=$((Xt=z("mask_expansion"))==null?void 0:Xt.value,t.project.mask_expansion),X=$((Et=z("mask_feather"))==null?void 0:Et.value,t.project.mask_feather),O=!!$((Ut=z("pano_enable"))==null?void 0:Ut.value,t.project.pano_enable?1:0),ae=$((At=z("cam_yaw"))==null?void 0:At.value,t.project.cam_yaw),N=$((Bt=z("cam_pitch"))==null?void 0:Bt.value,t.project.cam_pitch),Ie=$((Rt=z("cam_roll"))==null?void 0:Rt.value,t.project.cam_roll),et=$(($t=z("cam_fov"))==null?void 0:$t.value,t.project.cam_fov),Re=$((Vt=z("cam_pos_x"))==null?void 0:Vt.value,t.project.cam_pos_x||0),tt=$((Kt=z("cam_pos_y"))==null?void 0:Kt.value,t.project.cam_pos_y||0),ut=$((Ot=z("cam_pos_z"))==null?void 0:Ot.value,t.project.cam_pos_z||0);let ot=[];const at=(Gt=z("layers_keyframes"))==null?void 0:Gt.value;let mt={};if(typeof at=="string"&&at.trim())try{const it=JSON.parse(at);Array.isArray(it)?ot=it:it&&typeof it=="object"&&(Array.isArray(it.layers)&&(ot=it.layers),it.project_keyframes&&typeof it.project_keyframes=="object"&&(mt=it.project_keyframes))}catch(it){console.warn("[AE Timeline] Failed to parse layers_keyframes widget",it)}else Array.isArray(at)&&(ot=at);const jt={width:s,height:a,fps:o,total_frames:u,duration:u/o,mask_expansion:b,mask_feather:X,pano_enable:O,cam_yaw:ae,cam_pitch:N,cam_roll:Ie,cam_fov:et,cam_pos_x:Re,cam_pos_y:tt,cam_pos_z:ut};t.loadAnimation({project:jt,layers:ot}),t.projectKeyframes.value=mt,t.layers.length>0&&t.currentLayerIndex<0&&t.selectLayer(0)}function D(s,a){return s.name?s.name:s.type==="background"?"Background":`Layer ${a+1}`}function S(){const s=t.exportAnimation(),a=new Blob([JSON.stringify(s,null,2)],{type:"application/json"}),o=URL.createObjectURL(a),u=document.createElement("a");u.href=o,u.download=`ae_project_${Date.now()}.json`,u.click(),URL.revokeObjectURL(o)}function W(){var s;(s=g.value)==null||s.click()}function K(s){var u;const a=(u=s.target.files)==null?void 0:u[0];if(!a)return;const o=new FileReader;o.onload=b=>{var X;try{const O=JSON.parse((X=b.target)==null?void 0:X.result);t.loadAnimation(O),console.log("Project loaded successfully")}catch(O){console.error("Failed to parse project file",O),alert("Project file is corrupted or has invalid format")}},o.readAsText(a),g.value&&(g.value.value="")}function Y(s,a){const u=(b=>{var X,O;return(O=(X=n.node)==null?void 0:X.widgets)==null?void 0:O.find(ae=>ae.name===b)})(s);u&&(u.value=a,u.inputEl&&(u.inputEl.value=a,u.inputEl.dispatchEvent(new Event("input"))),u.callback&&u.callback(a))}function se(s,a){const o=parseInt(a.target.value,10);if(Number.isNaN(o))return;let u=o;s==="fps"&&(u=Math.max(1,u)),s==="total_frames"&&(u=Math.max(1,u)),(s==="width"||s==="height")&&(u=Math.max(16,u)),t.setProject({[s]:u}),Y(s,u),t.setCurrentTime(t.currentTime)}function te(){var u,b,X,O,ae;if(!((u=n.node)!=null&&u.widgets)){console.error("[AE Timeline] Node or widgets not found!");return}console.log("[AE Timeline] Saving..."),t.layers.forEach(N=>{N.maskCanvas&&(N.customMask=N.maskCanvas.toDataURL(),console.log(`[AE Timeline] Layer ${N.id}: Saved mask (len=${N.customMask.length})`))});const s=t.exportAnimation();s.layers.forEach(N=>{N.bezierPath&&N.bezierPath.length>0&&console.log(`[AE Timeline] Layer ${N.id}: Exporting Path with ${N.bezierPath.length} points`)});const o=(N=>n.node.widgets.find(Ie=>Ie.name===N))("layers_keyframes");if(o){const N=JSON.stringify({layers:s.layers,project_keyframes:t.projectKeyframes,project:s.project});if(o.value=N,console.log(`[AE Timeline] Saved layers_keyframes (len=${N.length})`),o.inputEl&&(o.inputEl.value=N,o.inputEl.dispatchEvent(new Event("input"))),o.callback&&o.callback(N),n.node.widgets_values){const Ie=n.node.widgets.indexOf(o);Ie>=0&&(n.node.widgets_values[Ie]=N)}(X=(b=n.node).setDirtyCanvas)==null||X.call(b,!0,!1)}else console.error("[AE Timeline] Widget layers_keyframes not found!");Y("width",t.project.width),Y("height",t.project.height),Y("fps",t.project.fps),Y("total_frames",t.project.total_frames),Y("pano_enable",t.project.pano_enable?1:0),Y("cam_yaw",t.project.cam_yaw),Y("cam_pitch",t.project.cam_pitch),Y("cam_roll",t.project.cam_roll),Y("cam_fov",t.project.cam_fov),Y("cam_pos_x",t.project.cam_pos_x||0),Y("cam_pos_y",t.project.cam_pos_y||0),Y("cam_pos_z",t.project.cam_pos_z||0),Y("cam_pos_x",t.project.cam_pos_x||0),Y("cam_pos_y",t.project.cam_pos_y||0),Y("cam_pos_z",t.project.cam_pos_z||0),(ae=(O=n.node).setDirtyCanvas)==null||ae.call(O,!0,!1)}function Fe(){te();const s=document.querySelector(".ae-timeline-dialog");s&&s.close()}function ke(){t.addKeyframe()}function fe(){t.deleteKeyframe()}function Ke(){t.setCurrentTime(0)}function xe(){t.setCurrentTime(Ee.value)}function ge(){const s=t.currentTime,a=t.project,o=t.setProjectKeyframe;o&&v.forEach(u=>{const b=a[u.key]??0;o(u.key,s,b)})}function we(){const s=t.currentTime,a=t.deleteProjectKeyframe;a&&v.forEach(o=>a(o.key,s))}function ce(s,a){var o;(o=t.deleteProjectKeyframe)==null||o.call(t,s,a)}function J(s,a){const o=s.clientX,u=a.time,b=O=>{var Re;const N=(O.clientX-o)/pe.value,Ie=Math.max(0,u+N),et=a.value??t.project[a.prop]??0;(Re=t.setProjectKeyframe)==null||Re.call(t,a.prop,Ie,et)},X=()=>{window.removeEventListener("mousemove",b),window.removeEventListener("mouseup",X)};window.addEventListener("mousemove",b),window.addEventListener("mouseup",X)}function Ae(){t.selectCameraLayer(),r.value=!0}function rt(){var s;t.currentLayer&&confirm("Clear all keyframes on this layer?")&&((s=t.clearAllKeyframes)==null||s.call(t))}function Je(){t.layers.forEach((s,a)=>{a!==t.currentLayerIndex&&(s._cachedImage&&delete s._cachedImage,console.log(`[AE Timeline] Cleared cache for layer ${s.id}`))})}function ct(){var s,a;(a=(s=l.value)==null?void 0:s.scheduleRender)==null||a.call(s),console.log("[AE Timeline] Preview refreshed")}function lt(){var s,a;n.node&&n.node.graph&&window.app&&((a=(s=window.app).queuePrompt)==null||a.call(s,0))}function qe(s){var b,X;const a={mask:t.maskMode,path:t.pathMode,extract:t.extractMode},o=a[s],u=!o.enabled;if(s==="extract"&&u&&!t.layers.find(ae=>ae.type==="background")){alert("Add a background layer before using extract");return}Object.entries(a).forEach(([O,ae])=>{O!==s&&(ae.enabled=!1)}),(!u||s!=="extract")&&((X=(b=l.value)==null?void 0:b.clearExtractSelection)==null||X.call(b)),o.enabled=u}function Qe(){var s,a;(a=(s=l.value)==null?void 0:s.clearExtractSelection)==null||a.call(s)}function dt(){var b,X;const s=l.value;if(!s||typeof s.applyExtractSelection!="function")return;const a=s.applyExtractSelection();if(!a){alert("Draw an extract selection first");return}if("error"in a){alert(a.error);return}const o=new Image;o.onload=()=>{const O=t.layers.filter(ae=>{var N;return(N=ae.id)==null?void 0:N.startsWith("extracted_")}).length;t.addLayer({id:`extracted_${Date.now()}`,name:`Extract ${O+1}`,type:"foreground",image_data:a.foregroundDataUrl,img:o,x:0,y:0,scale:1,rotation:0,opacity:1,mask_size:0,keyframes:{}})},o.src=a.foregroundDataUrl;const u=t.layers.find(O=>O.type==="background");if(u&&a.backgroundDataUrl){const O=new Image;O.onload=()=>{u.image_data=a.backgroundDataUrl,u.img=O,t.updateLayer(t.layers.indexOf(u),{image_data:a.backgroundDataUrl})},O.src=a.backgroundDataUrl}t.extractMode.enabled=!1,(X=(b=l.value)==null?void 0:b.clearExtractSelection)==null||X.call(b)}function ft(){try{te()}catch(s){console.warn("[AE Timeline] autosave failed",s)}}function ht(){var s;G="foreground",(s=h.value)==null||s.click()}function st(){var s;G="background",(s=h.value)==null||s.click()}function bt(s){const a=s.target.files;a&&(Array.from(a).forEach((o,u)=>{const b=new FileReader;b.onload=X=>{var N;const O=(N=X.target)==null?void 0:N.result,ae=new Image;ae.onload=()=>{t.addLayer({id:"uploaded_"+Date.now()+"_"+u,name:o.name.replace(/\.[^/.]+$/,""),type:G,image_data:O,img:ae,x:0,y:0,scale:1,rotation:0,opacity:1,mask_size:0,keyframes:{},bg_mode:"fit"})},ae.src=O},b.readAsDataURL(o)}),h.value&&(h.value.value=""))}function xt(){vt(-1)}function Pt(){vt(1)}function vt(s){const a=t.currentLayerIndex;if(a<0)return;const o=a+s;if(o>=0&&o<t.layers.length){const u=t.layers[a];t.layers.splice(a,1),t.layers.splice(o,0,u),t.selectLayer(o)}}return ua(()=>{q&&j.value&&(q.disconnect(),q=null),window.removeEventListener("resize",$e),window.removeEventListener("keydown",Ue,{capture:!0}),te()}),(s,a)=>(ue(),le("div",fn,[i("header",hn,[i("div",{class:"header-left"},[a[34]||(a[34]=i("div",{class:"logo"},[i("div",{class:"logo-icon"},"AE"),i("span",{class:"logo-text"},"AE Animator")],-1)),a[35]||(a[35]=i("div",{class:"header-divider"},null,-1)),i("button",{class:"btn btn-ghost",onClick:S,title:"保存工程文件"},"Save"),i("button",{class:"btn btn-ghost",onClick:W,title:"加载工程文件"},"Load")]),i("div",vn,[i("span",yn,he(M(t).project.width)+"x"+he(M(t).project.height)+" @ "+he(M(t).project.fps)+" FPS",1)]),i("div",gn,[i("div",_n,[i("div",bn,[a[36]||(a[36]=i("span",{class:"field-label"},"W",-1)),i("input",{type:"number",min:"16",max:"8192",value:M(t).project.width,onInput:a[0]||(a[0]=o=>se("width",o))},null,40,xn)]),i("div",Pn,[a[37]||(a[37]=i("span",{class:"field-label"},"H",-1)),i("input",{type:"number",min:"16",max:"8192",value:M(t).project.height,onInput:a[1]||(a[1]=o=>se("height",o))},null,40,wn)]),i("div",jn,[a[38]||(a[38]=i("span",{class:"field-label"},"FPS",-1)),i("input",{type:"number",min:"1",max:"240",value:M(t).project.fps,onInput:a[2]||(a[2]=o=>se("fps",o))},null,40,Mn)]),i("div",kn,[a[39]||(a[39]=i("span",{class:"field-label"},"Frames",-1)),i("input",{type:"number",min:"1",value:M(t).project.total_frames,onInput:a[3]||(a[3]=o=>se("total_frames",o))},null,40,Tn)]),i("div",Cn,[i("label",Sn,[gt(i("input",{type:"checkbox","onUpdate:modelValue":a[4]||(a[4]=o=>V.value=o)},null,512),[[Nt,V.value]]),a[40]||(a[40]=i("span",null,"Pano",-1))]),i("label",zn,[gt(i("input",{type:"checkbox","onUpdate:modelValue":a[5]||(a[5]=o=>me.value=o)},null,512),[[Nt,me.value]]),a[41]||(a[41]=i("span",null,"Cam",-1))]),i("div",Ln,[i("input",{type:"number",step:"1",value:L.value,onInput:a[6]||(a[6]=o=>L.value=parseFloat(o.target.value)),title:"Yaw"},null,40,Fn),i("input",{type:"number",step:"1",value:Ye.value,onInput:a[7]||(a[7]=o=>Ye.value=parseFloat(o.target.value)),title:"Pitch"},null,40,In),i("input",{type:"number",step:"1",value:Te.value,onInput:a[8]||(a[8]=o=>Te.value=parseFloat(o.target.value)),title:"Roll"},null,40,Yn),i("input",{type:"number",step:"1",min:"10",max:"170",value:Be.value,onInput:a[9]||(a[9]=o=>Be.value=parseFloat(o.target.value)),title:"FOV"},null,40,Dn)]),i("div",Xn,[i("input",{type:"number",step:"1",value:ze.value,onInput:a[10]||(a[10]=o=>ze.value=parseFloat(o.target.value)),title:"Pos X"},null,40,En),i("input",{type:"number",step:"1",value:De.value,onInput:a[11]||(a[11]=o=>De.value=parseFloat(o.target.value)),title:"Pos Y"},null,40,Un),i("input",{type:"number",step:"1",value:Xe.value,onInput:a[12]||(a[12]=o=>Xe.value=parseFloat(o.target.value)),title:"Pos Z"},null,40,An)])])]),i("button",{class:"btn btn-primary",onClick:ht},"+ FG Layer"),i("button",{class:"btn btn-secondary",onClick:st},"+ BG Layer"),a[42]||(a[42]=i("div",{class:"header-divider"},null,-1)),i("button",{class:"btn btn-accent",onClick:te,title:"保存到节点"},"Save"),i("button",{class:"btn btn-close",onClick:Fe,title:"关闭"},"Close")])]),i("div",Bn,[i("aside",Rn,[M(t).currentLayer?(ue(),le("div",$n,[i("div",Vn,[i("span",Kn,he(D(M(t).currentLayer,M(t).currentLayerIndex)),1),i("span",{class:Oe(["layer-badge",M(t).currentLayer.type])},he(M(t).currentLayer.type==="background"?"BG":"FG"),3)]),i("div",On," Layer "+he(M(t).currentLayerIndex+1)+" - "+he(M(t).currentLayer.type==="background"?"Background":"Foreground"),1)])):(ue(),le("div",Gn,[...a[43]||(a[43]=[i("span",null,"请选择一个图层",-1)])])),M(t).currentLayer?(ue(),le("div",Zn,[a[56]||(a[56]=i("div",{class:"section-title"},"Transform",-1)),i("div",Wn,[i("div",Nn,[a[44]||(a[44]=i("span",{class:"prop-label"},"Position X",-1)),i("input",{type:"number",class:"prop-input",value:P.value.x.toFixed(0),onInput:a[13]||(a[13]=o=>c("x",o)),step:"1"},null,40,qn)]),i("div",Hn,[a[45]||(a[45]=i("span",{class:"prop-label"},"Position Y",-1)),i("input",{type:"number",class:"prop-input",value:P.value.y.toFixed(0),onInput:a[14]||(a[14]=o=>c("y",o)),step:"1"},null,40,Jn)]),i("div",Qn,[a[46]||(a[46]=i("span",{class:"prop-label"},"Position Z",-1)),i("input",{type:"number",class:"prop-input",value:P.value.z.toFixed(0),onInput:a[15]||(a[15]=o=>c("z",o)),step:"1"},null,40,eo)]),i("div",to,[a[47]||(a[47]=i("span",{class:"prop-label"},"Scale",-1)),i("input",{type:"number",class:"prop-input",value:(P.value.scale*100).toFixed(0),onInput:a[16]||(a[16]=o=>f(o)),step:"1"},null,40,ao),a[48]||(a[48]=i("span",{class:"prop-unit"},"%",-1))]),i("div",no,[a[49]||(a[49]=i("span",{class:"prop-label"},"Rot X",-1)),i("input",{type:"number",class:"prop-input",value:P.value.rotationX.toFixed(0),onInput:a[17]||(a[17]=o=>c("rotationX",o)),step:"1"},null,40,oo),a[50]||(a[50]=i("span",{class:"prop-unit"},"deg",-1))]),i("div",io,[a[51]||(a[51]=i("span",{class:"prop-label"},"Rot Y",-1)),i("input",{type:"number",class:"prop-input",value:P.value.rotationY.toFixed(0),onInput:a[18]||(a[18]=o=>c("rotationY",o)),step:"1"},null,40,ro),a[52]||(a[52]=i("span",{class:"prop-unit"},"deg",-1))]),i("div",so,[a[53]||(a[53]=i("span",{class:"prop-label"},"Rot Z",-1)),i("input",{type:"number",class:"prop-input",value:P.value.rotation.toFixed(0),onInput:a[19]||(a[19]=o=>c("rotation",o)),step:"1"},null,40,co),a[54]||(a[54]=i("span",{class:"prop-unit"},"deg",-1))]),i("div",lo,[i("div",uo,[a[55]||(a[55]=i("span",{class:"prop-label"},"Opacity",-1)),i("span",mo,he((P.value.opacity*100).toFixed(0))+"%",1)]),i("input",{type:"range",class:"prop-slider",value:P.value.opacity,onInput:a[20]||(a[20]=o=>c("opacity",o)),min:"0",max:"1",step:"0.01"},null,40,po)])])])):He("",!0),i("div",fo,[a[59]||(a[59]=i("div",{class:"section-title"},"Tools",-1)),i("div",ho,[i("button",{class:Oe(["tool-btn",{active:M(t).maskMode.enabled}]),onClick:a[21]||(a[21]=o=>qe("mask"))},"Mask Mode",2),i("button",{class:Oe(["tool-btn",{active:M(t).maskMode.enabled&&M(t).maskMode.erase}]),onClick:a[22]||(a[22]=o=>M(t).maskMode.erase=!M(t).maskMode.erase),disabled:!M(t).maskMode.enabled},"Eraser",10,vo),i("button",{class:Oe(["tool-btn",{active:M(t).pathMode.enabled}]),onClick:a[23]||(a[23]=o=>qe("path"))},"Path Tool",2),i("button",{class:Oe(["tool-btn",{active:M(t).extractMode.enabled}]),onClick:a[24]||(a[24]=o=>qe("extract"))},"AI Extract",2)]),M(t).maskMode.enabled?(ue(),le("div",yo,[i("div",go,[a[57]||(a[57]=i("span",{class:"prop-label"},"Brush Size",-1)),i("span",_o,he(M(t).maskMode.brush)+"px",1)]),gt(i("input",{type:"range",class:"prop-slider","onUpdate:modelValue":a[25]||(a[25]=o=>M(t).maskMode.brush=o),min:"1",max:"100",step:"1"},null,512),[[Mt,M(t).maskMode.brush,void 0,{number:!0}]])])):He("",!0),M(t).extractMode.enabled?(ue(),le("div",bo,[i("div",xo,[a[58]||(a[58]=i("span",{class:"prop-label"},"Brush Size",-1)),i("span",Po,he(M(t).extractMode.brush)+"px",1)]),gt(i("input",{type:"range",class:"prop-slider","onUpdate:modelValue":a[26]||(a[26]=o=>M(t).extractMode.brush=o),min:"5",max:"150",step:"1"},null,512),[[Mt,M(t).extractMode.brush,void 0,{number:!0}]]),i("div",{class:"extract-actions"},[i("button",{class:"btn btn-small btn-primary",onClick:dt},"Apply"),i("button",{class:"btn btn-small btn-ghost",onClick:Qe},"Clear")])])):He("",!0)]),i("div",wo,[qt(dn)]),i("div",jo,[a[62]||(a[62]=i("div",{class:"section-title"},"Actions",-1)),i("div",{class:"action-row"},[i("button",{class:"btn btn-small btn-ghost",onClick:Je},"Clear Cache"),i("button",{class:"btn btn-small btn-ghost",onClick:ct},"Refresh"),i("button",{class:"btn btn-small btn-accent",onClick:lt},"Run")]),i("div",Mo,[a[61]||(a[61]=i("span",{class:"prop-label"},"Fit Mode",-1)),gt(i("select",{class:"fit-select","onUpdate:modelValue":a[27]||(a[27]=o=>U.value=o)},[...a[60]||(a[60]=[i("option",{value:"fit"},"Fit",-1),i("option",{value:"fill"},"Fill",-1),i("option",{value:"stretch"},"Stretch",-1)])],512),[[ma,U.value]])])])]),i("main",ko,[i("div",To,[i("span",Co,"Duration: "+he(y(Ee.value)),1),i("div",So,[i("span",zo,he(y(M(t).currentTime)),1),i("div",Lo,[a[63]||(a[63]=i("span",{class:"prop-label"},"Zoom",-1)),gt(i("input",{type:"range",min:"25",max:"200",step:"5","onUpdate:modelValue":a[28]||(a[28]=o=>ee.value=o)},null,512),[[Mt,ee.value,void 0,{number:!0}]]),i("span",Fo,he(ee.value)+"%",1)])])]),i("div",Io,[i("div",{class:"canvas-zoom",style:Ne({transform:`scale(${Z.value})`})},[qt(Ya,{ref_key:"canvasPreviewRef",ref:l,fitMode:U.value},null,8,["fitMode"])],4)])])]),i("footer",Yo,[i("div",Do,[i("div",Xo,[i("button",{class:"btn btn-small btn-ghost",onClick:ke},"+ Keyframe"),i("button",{class:"btn btn-small btn-ghost",onClick:fe},"Del Key"),i("button",{class:"btn btn-small btn-ghost",onClick:rt},"Clear All"),i("button",{class:"btn btn-small btn-ghost",onClick:ge},"+ Cam KF"),i("button",{class:"btn btn-small btn-ghost",onClick:we},"Del Cam KF"),a[64]||(a[64]=i("div",{class:"controls-divider"},null,-1)),i("button",{class:"nav-btn",onClick:xt,disabled:!M(t).currentLayer},"Up",8,Eo),i("button",{class:"nav-btn",onClick:Pt,disabled:!M(t).currentLayer},"Down",8,Uo)]),i("div",Ao,[i("span",Bo,he(y(M(t).currentTime)),1),i("div",Ro,[i("button",{class:"pb-btn",onClick:Ke},"|<"),i("button",{class:Oe(["play-btn",{playing:M(t).isPlaying}]),onClick:a[29]||(a[29]=(...o)=>M(t).togglePlayback&&M(t).togglePlayback(...o))},he(M(t).isPlaying?"Pause":"Play"),3),i("button",{class:"pb-btn",onClick:xe},">|")])])]),i("div",$o,[i("div",Vo,[i("div",Ko,"Layers ("+he(M(t).layers.length)+")",1),i("div",{class:"layers-list",onScroll:d},[i("div",{class:Oe(["layer-item camera-layer",{active:M(t).cameraSelected}]),onClick:a[31]||(a[31]=o=>Ae())},[i("span",{class:"expand-icon",onClick:a[30]||(a[30]=We(o=>oe(),["stop"]))},he(r.value?"v":">"),1),a[65]||(a[65]=i("span",{class:"layer-type camera"},"C",-1)),a[66]||(a[66]=i("span",{class:"layer-name"},"Camera",-1))],2),r.value?(ue(),le(Ze,{key:0},nt(v,o=>i("div",{key:o.key,class:"layer-item prop-item camera-prop-item"},[a[67]||(a[67]=i("span",{class:"prop-indent"},null,-1)),i("span",Oo,he(o.label),1)])),64)):He("",!0),(ue(!0),le(Ze,null,nt(M(t).layers,(o,u)=>(ue(),le(Ze,{key:o.id},[i("div",{class:Oe(["layer-item",{active:u===M(t).currentLayerIndex}]),onClick:b=>M(t).selectLayer(u)},[i("span",{class:"expand-icon",onClick:We(b=>A(u),["stop"])},he(B.value.has(u)?"v":">"),9,Zo),i("span",{class:Oe(["layer-type",o.type])},he(o.type==="background"?"B":"F"),3),i("span",Wo,he(D(o,u)),1),i("span",No,[i("span",{class:Oe(["vis-icon",{off:o.hidden}]),onClick:We(b=>re(o),["stop"])},"eye",10,qo),i("span",{class:"del-icon",onClick:We(b=>M(t).removeLayer(u),["stop"])},"x",8,Ho)])],10,Go),B.value.has(u)?(ue(),le(Ze,{key:0},nt(_,b=>i("div",{key:`layer-${u}-${b.key}`,class:"layer-item prop-item"},[a[68]||(a[68]=i("span",{class:"prop-indent"},null,-1)),i("span",Jo,he(b.label),1)])),64)):He("",!0)],64))),128))],32)]),i("div",{class:"tracks-panel",ref_key:"timelineRef",ref:j},[i("div",{class:"tracks-content",style:Ne({width:Ge.value+"px"})},[i("div",{class:"ruler",onMousedown:de},[(ue(!0),le(Ze,null,nt(Math.ceil(Ee.value)+1,o=>(ue(),le("div",{key:o,class:"ruler-tick",style:Ne({left:(o-1)*pe.value+"px"})},[i("span",Qo,he(o-1)+"s",1)],4))),128)),i("div",{class:"playhead-top",style:Ne({left:M(t).currentTime*pe.value+"px"})},null,4)],32),i("div",{class:"tracks-list",onDblclick:Ce,onScroll:w},[i("div",{class:"track-row camera-row",onClick:a[32]||(a[32]=o=>Ae())},[i("div",{class:"track-bar camera",style:Ne({width:Ee.value*pe.value+"px"})},[r.value?He("",!0):(ue(!0),le(Ze,{key:0},nt(k(),o=>(ue(),le("div",{key:`cam-${o.prop}-${o.time}`,class:"mini-kf camera",style:Ne({left:o.time*pe.value+"px"}),title:`Camera ${o.prop} @ ${o.time.toFixed(2)}s`,onMousedown:We(u=>J(u,o),["stop"]),onContextmenu:We(u=>ce(o.prop,o.time),["prevent"])},null,44,ei))),128)),a[69]||(a[69]=i("span",{class:"track-label"},"Camera",-1))],4)]),r.value?(ue(),le(Ze,{key:0},nt(v,o=>i("div",{key:o.key,class:"prop-track-row camera-prop-track",onClick:a[33]||(a[33]=u=>Ae())},[i("div",{class:"prop-track",onDblclick:We(u=>ie(u,o.key),["stop"])},[(ue(!0),le(Ze,null,nt(ve(o.key),u=>(ue(),le("div",{key:u.time,class:"keyframe-dot camera",style:Ne({left:u.time*pe.value+"px"}),title:`${o.label}: ${u.value.toFixed(2)} @ ${u.time.toFixed(2)}s`,onMousedown:We(b=>H(b,o.key,u),["stop"]),onContextmenu:We(b=>ce(o.key,u.time),["prevent"])},null,44,ai))),128))],40,ti)])),64)):He("",!0),(ue(!0),le(Ze,null,nt(M(t).layers,(o,u)=>(ue(),le(Ze,{key:o.id},[i("div",{class:Oe(["track-row",{active:u===M(t).currentLayerIndex}]),onClick:b=>M(t).selectLayer(u)},[i("div",{class:Oe(["track-bar",o.type]),style:Ne({width:Ee.value*pe.value+"px"})},[B.value.has(u)?He("",!0):(ue(!0),le(Ze,{key:0},nt(F(o),b=>(ue(),le("div",{key:b.time+b.prop,class:"mini-kf",style:Ne({left:b.time*pe.value+"px"})},null,4))),128))],6)],10,ni),B.value.has(u)?(ue(),le(Ze,{key:0},nt(_,b=>i("div",{key:b.key,class:Oe(["prop-track-row",{active:u===M(t).currentLayerIndex}]),onClick:X=>M(t).selectLayer(u)},[i("div",{class:"prop-track",onDblclick:We(X=>Me(X,u,b.key),["stop"])},[(ue(!0),le(Ze,null,nt(C(o,b.key),X=>(ue(),le("div",{key:X.time,class:Oe(["keyframe-dot",{selected:Le(u,b.key,X.time)}]),style:Ne({left:X.time*pe.value+"px"}),title:`${b.label}: ${T(X.value,b.key)} @ ${X.time.toFixed(2)}s`,onMousedown:We(O=>be(O,u,b.key,X),["stop"]),onClick:We(O=>ye(u,b.key,X.time),["stop"]),onContextmenu:We(O=>m(u,b.key,X.time),["prevent"])},null,46,ri))),128))],40,ii)],10,oi)),64)):He("",!0)],64))),128))],32),i("div",{class:"playhead-line",style:Ne({left:M(t).currentTime*pe.value+"px"})},null,4)],4)],512)])]),i("input",{ref_key:"fileInput",ref:h,type:"file",accept:"image/*",multiple:"",style:{display:"none"},onChange:bt},null,544),i("input",{ref_key:"projectInput",ref:g,type:"file",accept:".json",style:{display:"none"},onChange:K},null,544)]))}}),ci=St(si,[["__scopeId","data-v-bffdf50d"]]);function li(e,n){const t=pa(ci,{node:n.node}),l=da();return t.use(l),t.mount(e),t}window.createTimelineApp=li;
