var Jt=Object.defineProperty;var Qt=(t,n,e)=>n in t?Jt(t,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[n]=e;var N=(t,n,e)=>Qt(t,typeof n!="symbol"?n+"":n,e);import{d as ea,r as xe,c as he,q as gt,W as $t,an as Ht,al as st,a1 as be,ag as ta,b2 as aa,bl as wt,bq as Pt,bi as na,w as mt,bm as ne,bn as oe,bp as r,bA as ot,bo as Ze,bv as tt,bw as it,bE as oa,bu as De,u as k,br as qe,bs as fe,bB as kt,bF as Ot,bz as ra,bG as ht,bH as Vt,bI as bt,bt as Gt,bJ as ia,bC as sa,bD as ca}from"./assets/_plugin-vue_export-helper.js";function xt(t){const n=Math.max(1,t.fps||1);return t.duration||t.total_frames/n}const Mt=ea("timeline",()=>{const t=xe({width:1280,height:720,fps:30,duration:5,total_frames:150,mask_expansion:0,mask_feather:0,hdr_enable:!1,hdr_exposure:0,pano_enable:!1,cam_enable:!1,cam_yaw:0,cam_pitch:0,cam_roll:0,cam_fov:90,cam_offset_x:0,cam_offset_y:0,cam_pos_x:0,cam_pos_y:0,cam_pos_z:1e3,preview_mode:"2d"}),n=xe({}),e=xe([]),l=xe(-1),v=xe(0),_=xe(0),w=xe(!1),I=xe({enabled:!1,drawing:!1,erase:!1,brush:20}),X=xe({enabled:!1,data:null}),C=xe({enabled:!1,drawing:!1,brush:30,blurType:"gaussian"}),B=he(()=>l.value>=0&&l.value<e.value.length?e.value[l.value]:null),z=he(()=>e.value.filter(c=>c.type==="foreground")),L=he(()=>e.value.find(c=>c.type==="background"));function G(c){const u=Math.max(1,c.fps??t.value.fps),p=typeof c.duration=="number",g=typeof c.total_frames=="number",b={...t.value,...c,fps:u};p&&!g?b.total_frames=Math.max(1,Math.round((b.duration||0)*u)):g&&!p?(b.total_frames=Math.max(1,Math.round(b.total_frames)),b.duration=b.total_frames/u):(b.total_frames=Math.max(1,Math.round(b.total_frames||b.duration*u)),b.duration=b.duration||b.total_frames/u),Object.assign(t.value,b)}function H(c,u,p){n.value[c]||(n.value[c]=[]);const g=n.value[c],b=g.find(y=>Math.abs(y.time-u)<.001);b?b.value=p:g.push({time:u,value:p}),g.sort((y,E)=>y.time-E.time)}function $(c,u){const p=n.value[c];p&&(n.value[c]=p.filter(g=>Math.abs(g.time-u)>.001))}function re(c,u,p){const g=n.value[c];if(!g||g.length===0)return p;const b=[...g].sort((y,E)=>y.time-E.time);if(u<=b[0].time)return b[0].value;if(u>=b[b.length-1].time)return b[b.length-1].value;for(let y=0;y<b.length-1;y++){const E=b[y],K=b[y+1];if(u>=E.time&&u<=K.time){const V=(u-E.time)/Math.max(1e-6,K.time-E.time);return E.value+(K.value-E.value)*V}}return p}function D(c){e.value.push({z:0,is3D:!1,rotationX:0,rotationY:0,rotationZ:0,scaleX:1,scaleY:1,scaleZ:1,anchorX:0,anchorY:0,perspective:1e3,...c}),l.value=e.value.length-1}function T(c){c>=0&&c<e.value.length&&(e.value.splice(c,1),l.value>=e.value.length&&(l.value=e.value.length-1))}function je(){e.value=[],l.value=-1}function Fe(c){c>=0&&c<e.value.length&&(l.value=c)}function Re(c,u){c>=0&&c<e.value.length&&Object.assign(e.value[c],u)}function Le(c){const u=xt(t.value);v.value=Math.max(0,Math.min(c,u)),_.value=Math.floor(v.value*t.value.fps)}function Ie(c){const u=Math.max(1,Math.round(t.value.total_frames||xt(t.value)*t.value.fps));_.value=Math.max(0,Math.min(c,u-1)),v.value=_.value/t.value.fps}let ge=null,ze=0;function Pe(){w.value=!w.value,w.value?ce():Ee()}function ce(){ge===null&&(ze=performance.now(),Be())}function Be(){if(!w.value)return;const c=performance.now(),u=(c-ze)/1e3;ze=c;let p=v.value+u;const g=xt(t.value);p>=g&&(p=0),Le(p),ge=requestAnimationFrame(Be)}function Ee(){ge!==null&&(cancelAnimationFrame(ge),ge=null)}function Te(){w.value=!1,Ee(),Le(0)}function Z(c){if(!c)return;const u=c.project||{},p=u.fps||t.value.fps||30,g=u.duration??(u.total_frames?u.total_frames/Math.max(1,p):t.value.duration),b=u.total_frames??Math.max(1,Math.round((g||t.value.duration)*p));G({width:u.width||1280,height:u.height||720,fps:p,duration:g,total_frames:b,mask_expansion:u.mask_expansion||0,mask_feather:u.mask_feather||0,hdr_enable:!!u.hdr_enable,hdr_exposure:u.hdr_exposure||0,pano_enable:!!u.pano_enable,cam_enable:u.cam_enable!==void 0?!!u.cam_enable:!!u.pano_enable,cam_yaw:u.cam_yaw||0,cam_pitch:u.cam_pitch||0,cam_roll:u.cam_roll||0,cam_fov:u.cam_fov||90,cam_offset_x:u.cam_offset_x||0,cam_offset_y:u.cam_offset_y||0,cam_pos_x:u.cam_pos_x||0,cam_pos_y:u.cam_pos_y||0,cam_pos_z:u.cam_pos_z!==void 0?u.cam_pos_z:1e3,preview_mode:u.preview_mode||"2d"}),n.value=u.project_keyframes||{},e.value=(c.layers||[]).map(y=>({id:y.id,name:y.name,type:y.type,image_data:y.image_data,x:y.x||0,y:y.y||0,z:y.z||0,scale:y.scale||1,rotation:y.rotation||0,opacity:y.opacity!==void 0?y.opacity:1,is3D:y.is3D||!1,rotationX:y.rotationX||0,rotationY:y.rotationY||0,rotationZ:y.rotationZ||0,scaleX:y.scaleX!==void 0?y.scaleX:y.scale||1,scaleY:y.scaleY!==void 0?y.scaleY:y.scale||1,scaleZ:y.scaleZ!==void 0?y.scaleZ:1,anchorX:y.anchorX||0,anchorY:y.anchorY||0,perspective:y.perspective||1e3,mask_size:y.mask_size||0,customMask:y.customMask,bezierPath:y.bezierPath,usePathAnimation:y.usePathAnimation||!1,keyframes:y.keyframes||{},bg_mode:y.bg_mode||"fit"}))}function S(){const c=B.value;if(!c)return;const u=["x","y","z","scale","rotation","opacity","mask_size","rotationX","rotationY","rotationZ","scaleX","scaleY","scaleZ","anchorX","anchorY","perspective"];c.keyframes||(c.keyframes={});for(const p of u){let g=c[p];g===void 0&&(p==="scale"||p==="opacity"?g=1:p==="perspective"?g=1e3:g=0),c.keyframes[p]||(c.keyframes[p]=[]),c.keyframes[p]=c.keyframes[p].filter(b=>b.time!==v.value),c.keyframes[p].push({time:v.value,value:g}),c.keyframes[p].sort((b,y)=>b.time-y.time)}}function o(){const c=B.value;if(!c||!c.keyframes)return;const u=["x","y","z","scale","rotation","opacity","mask_size","rotationX","rotationY","rotationZ","scaleX","scaleY","scaleZ","anchorX","anchorY","perspective"];for(const p of u)c.keyframes[p]&&(c.keyframes[p]=c.keyframes[p].filter(g=>g.time!==v.value))}function m(){const c=B.value;c&&(c.keyframes={})}function x(){return{project:{...t.value,project_keyframes:n.value},layers:e.value.map(c=>({id:c.id,name:c.name,type:c.type,image_data:c.image_data,x:c.x,y:c.y,z:c.z||0,scale:c.scale,rotation:c.rotation,opacity:c.opacity,is3D:c.is3D||!1,rotationX:c.rotationX,rotationY:c.rotationY,rotationZ:c.rotationZ,scaleX:c.scaleX,scaleY:c.scaleY,scaleZ:c.scaleZ,anchorX:c.anchorX,anchorY:c.anchorY,perspective:c.perspective,mask_size:c.mask_size,customMask:c.customMask,bezierPath:c.bezierPath,usePathAnimation:c.usePathAnimation,keyframes:c.keyframes,bg_mode:c.bg_mode}))}}return{project:t,layers:e,currentLayerIndex:l,currentTime:v,currentFrame:_,isPlaying:w,maskMode:I,pathMode:X,extractMode:C,projectKeyframes:n,currentLayer:B,foregroundLayers:z,backgroundLayer:L,setProject:G,addLayer:D,removeLayer:T,clearLayers:je,selectLayer:Fe,updateLayer:Re,setCurrentTime:Le,setCurrentFrame:Ie,togglePlayback:Pe,stopPlayback:Te,addKeyframe:S,deleteKeyframe:o,clearAllKeyframes:m,setProjectKeyframe:H,deleteProjectKeyframe:$,interpolateProjectValue:re,loadAnimation:Z,exportAnimation:x}});class la{constructor(n,e=100){N(this,"cache",new Map);N(this,"device");N(this,"maxCacheSize");this.device=n,this.maxCacheSize=e}loadImage(n,e){if(this.cache.has(n)){const _=this.cache.get(n);return _.lastUsed=Date.now(),_.refCount++,_.texture}this.evictLRU();const l=this.createTextureFromImage(e),v=l.createView();return this.cache.set(n,{texture:l,view:v,lastUsed:Date.now(),refCount:1,width:e.width,height:e.height}),l}getView(n){const e=this.cache.get(n);return e?(e.lastUsed=Date.now(),e.view):null}createTextureFromImage(n){const e=this.device.createTexture({size:[n.width,n.height],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});return this.device.queue.copyExternalImageToTexture({source:n},{texture:e},[n.width,n.height]),e}release(n){const e=this.cache.get(n);e&&(e.refCount--,e.refCount<=0&&(e.texture.destroy(),this.cache.delete(n)))}evictLRU(){if(this.cache.size<this.maxCacheSize)return;let n=null,e=1/0;for(const[l,v]of this.cache)v.refCount===0&&v.lastUsed<e&&(e=v.lastUsed,n=l);n?(this.cache.get(n).texture.destroy(),this.cache.delete(n),console.log(`[TextureCache] Evicted texture: ${n}`)):console.warn("[TextureCache] Cache full but no textures can be evicted")}has(n){return this.cache.has(n)}getStats(){let n=0,e=0;for(const l of this.cache.values())n+=l.refCount,l.refCount>0&&e++;return{size:this.cache.size,maxSize:this.maxCacheSize,activeTextures:e,totalRefCount:n}}cleanup(){for(const[n,e]of this.cache)e.texture.destroy();this.cache.clear(),console.log("[TextureCache] Cleaned up all textures")}evict(n){const e=this.cache.get(n);return e&&e.refCount===0?(e.texture.destroy(),this.cache.delete(n),!0):!1}setMaxCacheSize(n){for(this.maxCacheSize=n;this.cache.size>this.maxCacheSize;)this.evictLRU()}}class ua{constructor(n=60){N(this,"frameTimes",[]);N(this,"lastFrameTime",0);N(this,"frameCount",0);N(this,"droppedFrames",0);N(this,"startTime",0);N(this,"maxSamples",60);this.maxSamples=n,this.startTime=performance.now()}startFrame(){this.lastFrameTime=performance.now()}endFrame(){const e=performance.now()-this.lastFrameTime;this.frameTimes.push(e),this.frameTimes.length>this.maxSamples&&this.frameTimes.shift(),this.frameCount++,e>16.67&&this.droppedFrames++}getStats(){if(this.frameTimes.length===0)return{fps:0,frameTime:0,avgFrameTime:0,minFrameTime:0,maxFrameTime:0,totalFrames:0,droppedFrames:0};const n=this.frameTimes.reduce((_,w)=>_+w,0)/this.frameTimes.length,e=Math.min(...this.frameTimes),l=Math.max(...this.frameTimes),v=1e3/n;return{fps:Math.round(v*10)/10,frameTime:Math.round(this.frameTimes[this.frameTimes.length-1]*100)/100,avgFrameTime:Math.round(n*100)/100,minFrameTime:Math.round(e*100)/100,maxFrameTime:Math.round(l*100)/100,totalFrames:this.frameCount,droppedFrames:this.droppedFrames}}reset(){this.frameTimes=[],this.frameCount=0,this.droppedFrames=0,this.startTime=performance.now()}getFormattedStats(){const n=this.getStats();return`FPS: ${n.fps} | Frame: ${n.frameTime}ms | Avg: ${n.avgFrameTime}ms | Dropped: ${n.droppedFrames}`}isPerformanceGood(){return this.getStats().fps>=55}isPerformanceAcceptable(){return this.getStats().fps>=30}}const Kt=`
struct LayerUniforms {
  opacity: f32,
}

struct VertexOutput {
  @builtin(position) position: vec4<f32>,
  @location(0) uv: vec2<f32>,
  @location(1) opacity: f32,
}

@group(0) @binding(0) var<uniform> uniforms: LayerUniforms;

@vertex
fn vs(@location(0) pos: vec2<f32>, @location(1) uv: vec2<f32>) -> VertexOutput {
  var output: VertexOutput;
  output.position = vec4<f32>(pos, 0.0, 1.0);
  output.uv = uv;
  output.opacity = uniforms.opacity;
  return output;
}
`,Zt=`
struct VertexOutput {
  @builtin(position) position: vec4<f32>,
  @location(0) uv: vec2<f32>,
  @location(1) opacity: f32,
}

@group(1) @binding(0) var layerTexture: texture_2d<f32>;
@group(1) @binding(1) var layerSampler: sampler;

@fragment
fn fs(input: VertexOutput) -> @location(0) vec4<f32> {
  var color = textureSample(layerTexture, layerSampler, input.uv);
  
  // Apply opacity
  color.a *= input.opacity;
  
  // Return premultiplied alpha
  return vec4<f32>(color.rgb * color.a, color.a);
}
`,ma=`
struct PanoramaUniforms {
  yaw: f32,
  pitch: f32,
  roll: f32,
  fov: f32,
  aspectRatio: f32,
  padding: f32,
  screenSize: vec2<f32>,
}

struct VertexOutput {
  @builtin(position) position: vec4<f32>,
  @location(0) uv: vec2<f32>,
  @location(1) opacity: f32,
}

@group(0) @binding(0) var<uniform> uniforms: PanoramaUniforms;
@group(1) @binding(0) var panoTexture: texture_2d<f32>;
@group(1) @binding(1) var panoSampler: sampler;

fn screenToRay(screenPos: vec2<f32>) -> vec3<f32> {
  // Convert screen position to normalized coordinates [-1, 1]
  let nx = (screenPos.x / uniforms.screenSize.x) * 2.0 - 1.0;
  let ny = 1.0 - (screenPos.y / uniforms.screenSize.y) * 2.0;
  
  // Calculate ray direction based on FOV
  let tanHalfFov = tan(uniforms.fov * 0.5 * 0.01745329); // deg to rad
  let vx = nx * tanHalfFov * uniforms.aspectRatio;
  let vy = -ny * tanHalfFov;
  let vz = 1.0;
  
  // Normalize ray
  let len = sqrt(vx * vx + vy * vy + vz * vz);
  return vec3<f32>(vx / len, vy / len, vz / len);
}

fn applyCameraRotation(ray: vec3<f32>) -> vec3<f32> {
  // Convert degrees to radians
  let yawRad = uniforms.yaw * 0.01745329;
  let pitchRad = uniforms.pitch * 0.01745329;
  let rollRad = uniforms.roll * 0.01745329;
  
  // Build rotation matrix
  let cy = cos(yawRad);
  let sy = sin(yawRad);
  let cp = cos(pitchRad);
  let sp = sin(pitchRad);
  let cr = cos(rollRad);
  let sr = sin(rollRad);
  
  // Combined rotation matrix (yaw * pitch * roll)
  let r00 = cr * cy + sr * sp * sy;
  let r01 = sr * cp;
  let r02 = cr * -sy + sr * sp * cy;
  let r10 = -sr * cy + cr * sp * sy;
  let r11 = cr * cp;
  let r12 = -sr * -sy + cr * sp * cy;
  let r20 = cp * sy;
  let r21 = -sp;
  let r22 = cp * cy;
  
  // Apply rotation
  return vec3<f32>(
    r00 * ray.x + r01 * ray.y + r02 * ray.z,
    r10 * ray.x + r11 * ray.y + r12 * ray.z,
    r20 * ray.x + r21 * ray.y + r22 * ray.z
  );
}

fn rayToEquirectangular(ray: vec3<f32>) -> vec2<f32> {
  // Convert ray to spherical coordinates
  let lon = atan2(ray.x, ray.z);
  let lat = asin(clamp(ray.y, -1.0, 1.0));
  
  // Map to UV coordinates [0, 1]
  // Note: V coordinate is flipped to match texture orientation
  let u = (lon / (3.14159265 * 2.0)) + 0.5;
  let v = (lat / 3.14159265) + 0.5;  // Removed negation to fix upside-down
  
  return vec2<f32>(u, v);
}

@vertex
fn vs(@location(0) pos: vec2<f32>, @location(1) uv: vec2<f32>) -> VertexOutput {
  var output: VertexOutput;
  output.position = vec4<f32>(pos, 0.0, 1.0);
  output.uv = uv;
  output.opacity = 1.0;
  return output;
}

@fragment
fn fs(input: VertexOutput) -> @location(0) vec4<f32> {
  // Convert screen position to ray direction
  var ray = screenToRay(input.position.xy);
  
  // Apply camera rotation
  ray = applyCameraRotation(ray);
  
  // Convert ray to equirectangular UV
  let uv = rayToEquirectangular(ray);
  
  // Sample panorama texture
  var color = textureSample(panoTexture, panoSampler, uv);
  color.a *= input.opacity;
  
  // Return premultiplied alpha for correct blending
  return vec4<f32>(color.rgb * color.a, color.a);
}
`,Wt=`
struct LayerUniforms {
  opacity: f32,
  // Camera rotation matrix (3x3, stored as 3 vec4s for alignment)
  rotationRow0: vec4<f32>,  // [r00, r01, r02, padding]
  rotationRow1: vec4<f32>,  // [r10, r11, r12, padding]
  rotationRow2: vec4<f32>,  // [r20, r21, r22, padding]
}

struct VertexOutput {
  @builtin(position) position: vec4<f32>,
  @location(0) uv: vec2<f32>,
  @location(1) opacity: f32,
}

@group(0) @binding(0) var<uniform> uniforms: LayerUniforms;

@vertex
fn vs(@location(0) pos: vec2<f32>, @location(1) uv: vec2<f32>) -> VertexOutput {
  // Apply camera rotation to vertex position
  // Extract rotation matrix
  let r00 = uniforms.rotationRow0.x;
  let r01 = uniforms.rotationRow0.y;
  let r02 = uniforms.rotationRow0.z;
  let r10 = uniforms.rotationRow1.x;
  let r11 = uniforms.rotationRow1.y;
  let r12 = uniforms.rotationRow1.z;
  let r20 = uniforms.rotationRow2.x;
  let r21 = uniforms.rotationRow2.y;
  let r22 = uniforms.rotationRow2.z;
  
  // Apply rotation (pos is already in NDC space)
  let rotatedX = r00 * pos.x + r01 * pos.y;
  let rotatedY = r10 * pos.x + r11 * pos.y;
  
  var output: VertexOutput;
  output.position = vec4<f32>(rotatedX, rotatedY, 0.0, 1.0);
  output.uv = uv;
  output.opacity = uniforms.opacity;
  return output;
}
`,Nt=`
struct VertexOutput {
  @builtin(position) position: vec4<f32>,
  @location(0) uv: vec2<f32>,
  @location(1) opacity: f32,
}

@group(1) @binding(0) var layerTexture: texture_2d<f32>;
@group(1) @binding(1) var layerSampler: sampler;

@fragment
fn fs(input: VertexOutput) -> @location(0) vec4<f32> {
  var color = textureSample(layerTexture, layerSampler, input.uv);
  
  // Apply opacity
  color.a *= input.opacity;
  
  // Return premultiplied alpha
  return vec4<f32>(color.rgb * color.a, color.a);
}
`;class pa{constructor(n){N(this,"device");N(this,"presentationFormat");N(this,"width");N(this,"height");N(this,"enableCameraRotation",!1);N(this,"backgroundPipeline",null);N(this,"foregroundPipeline",null);N(this,"panoramaPipeline",null);N(this,"overlayPipeline",null);N(this,"advancedBackgroundPipeline",null);N(this,"advancedForegroundPipeline",null);N(this,"useAdvancedTransforms",!1);N(this,"uniformBindGroupLayout",null);N(this,"textureBindGroupLayout",null);N(this,"overlayBindGroupLayout",null);N(this,"uniformBuffer",null);N(this,"quadVertexBuffer",null);N(this,"indexBuffer",null);N(this,"textureCache");N(this,"sampler",null);N(this,"performanceMonitor");N(this,"lastUniformData",null);N(this,"uniformsDirty",!0);N(this,"lastCameraState",null);N(this,"lastLayerProps",new Map);N(this,"tempBuffers",[]);this.device=n.device,this.presentationFormat=n.presentationFormat,this.width=n.width,this.height=n.height,this.useAdvancedTransforms=n.useAdvancedTransforms??!1,this.textureCache=new la(this.device),this.performanceMonitor=new ua,this.initialize(),console.log("[GPUTimelineRenderer] Advanced transforms:",this.useAdvancedTransforms?"ENABLED":"DISABLED")}initialize(){this.createBindGroupLayouts(),this.createBuffers(),this.createSampler(),this.createPipelines()}createBindGroupLayouts(){this.uniformBindGroupLayout=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]}),this.textureBindGroupLayout=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),this.overlayBindGroupLayout=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]})}createBuffers(){this.uniformBuffer=this.device.createBuffer({size:256,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const n=new Float32Array([-1,-1,0,1,1,-1,1,1,1,1,1,0,-1,1,0,0]);this.quadVertexBuffer=this.device.createBuffer({size:n.byteLength,usage:GPUBufferUsage.VERTEX,mappedAtCreation:!0}),new Float32Array(this.quadVertexBuffer.getMappedRange()).set(n),this.quadVertexBuffer.unmap();const e=new Uint16Array([0,1,2,0,2,3]);this.indexBuffer=this.device.createBuffer({size:e.byteLength,usage:GPUBufferUsage.INDEX,mappedAtCreation:!0}),new Uint16Array(this.indexBuffer.getMappedRange()).set(e),this.indexBuffer.unmap()}createSampler(){this.sampler=this.device.createSampler({magFilter:"linear",minFilter:"linear",mipmapFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"})}createPipelines(){const n=this.device.createPipelineLayout({bindGroupLayouts:[this.uniformBindGroupLayout,this.textureBindGroupLayout]}),e={arrayStride:16,attributes:[{shaderLocation:0,offset:0,format:"float32x2"},{shaderLocation:1,offset:8,format:"float32x2"}]},l={color:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}};this.backgroundPipeline=this.device.createRenderPipeline({layout:n,vertex:{module:this.device.createShaderModule({code:Kt}),entryPoint:"vs",buffers:[e]},fragment:{module:this.device.createShaderModule({code:Zt}),entryPoint:"fs",targets:[{format:this.presentationFormat,blend:l}]},primitive:{topology:"triangle-list",cullMode:"none"}}),this.foregroundPipeline=this.device.createRenderPipeline({layout:n,vertex:{module:this.device.createShaderModule({code:Kt}),entryPoint:"vs",buffers:[e]},fragment:{module:this.device.createShaderModule({code:Zt}),entryPoint:"fs",targets:[{format:this.presentationFormat,blend:l}]},primitive:{topology:"triangle-list",cullMode:"none"}});const v=this.device.createShaderModule({code:ma});this.panoramaPipeline=this.device.createRenderPipeline({layout:n,vertex:{module:v,entryPoint:"vs",buffers:[e]},fragment:{module:v,entryPoint:"fs",targets:[{format:this.presentationFormat,blend:l}]},primitive:{topology:"triangle-list",cullMode:"none"}});const _=`
      @group(0) @binding(0) var<uniform> overlayColor: vec4<f32>;
      
      struct VertexOutput {
        @builtin(position) position: vec4<f32>,
        @location(0) uv: vec2<f32>
      }
      
      @vertex
      fn vs(@location(0) pos: vec2<f32>, @location(1) uv: vec2<f32>) -> VertexOutput {
        return VertexOutput(vec4<f32>(pos, 0.0, 1.0), uv);
      }
      
      @fragment
      fn fs(input: VertexOutput) -> @location(0) vec4<f32> {
        return overlayColor;
      }
    `,w=this.device.createPipelineLayout({bindGroupLayouts:[this.overlayBindGroupLayout]});this.overlayPipeline=this.device.createRenderPipeline({layout:w,vertex:{module:this.device.createShaderModule({code:_}),entryPoint:"vs",buffers:[e]},fragment:{module:this.device.createShaderModule({code:_}),entryPoint:"fs",targets:[{format:this.presentationFormat,blend:l}]},primitive:{topology:"triangle-list",cullMode:"none"}}),this.useAdvancedTransforms&&(this.advancedBackgroundPipeline=this.device.createRenderPipeline({layout:n,vertex:{module:this.device.createShaderModule({code:Wt}),entryPoint:"vs",buffers:[e]},fragment:{module:this.device.createShaderModule({code:Nt}),entryPoint:"fs",targets:[{format:this.presentationFormat,blend:l}]},primitive:{topology:"triangle-list",cullMode:"none"}}),this.advancedForegroundPipeline=this.device.createRenderPipeline({layout:n,vertex:{module:this.device.createShaderModule({code:Wt}),entryPoint:"vs",buffers:[e]},fragment:{module:this.device.createShaderModule({code:Nt}),entryPoint:"fs",targets:[{format:this.presentationFormat,blend:l}]},primitive:{topology:"triangle-list",cullMode:"none"}}),console.log("[GPUTimelineRenderer] Advanced pipelines created")),console.log("[GPUTimelineRenderer] Pipelines created successfully")}renderFrame(n,e,l,v){if(this.performanceMonitor.startFrame(),!this.backgroundPipeline||!this.foregroundPipeline){console.warn("[GPUTimelineRenderer] Pipelines not initialized");return}this.tempBuffers=[];const _=this.device.createCommandEncoder();_.beginRenderPass({colorAttachments:[{view:v,loadOp:"clear",clearValue:{r:0,g:0,b:0,a:1},storeOp:"store"}]}).end();const I=n.find(L=>L.type==="background");if(I&&I.img){const L=this.getLayerProps(I,e);if(l.panorama&&I.img.width>0&&I.img.height>0&&Math.abs(I.img.width/I.img.height-2)<.35)this.renderPanoramaLayer(_,I,l,v);else{const H=this.useAdvancedTransforms&&this.advancedBackgroundPipeline?this.advancedBackgroundPipeline:this.backgroundPipeline;this.renderLayerInternal(_,I,L,l,v,H)}}const X=n.filter(L=>L.type!=="background"),C=this.cullLayers(X,e,l),B=[],z=[];for(const L of C)L.maskCanvas?z.push(L):B.push(L);for(const L of B)if(L.img){const G=this.getLayerProps(L,e),H=this.useAdvancedTransforms&&this.advancedForegroundPipeline?this.advancedForegroundPipeline:this.foregroundPipeline;this.renderLayerInternal(_,L,G,l,v,H)}for(const L of z)if(L.img){const G=this.getLayerProps(L,e);this.renderLayerWithMask(_,L,G,l,v)}this.device.queue.submit([_.finish()]);for(const L of this.tempBuffers)L.destroy();this.tempBuffers=[],this.performanceMonitor.endFrame()}cullLayers(n,e,l){const v=[];for(const _ of n){if(!_.img)continue;const w=this.getLayerProps(_,e);if(w.opacity<=.001||Math.abs(w.scale)<.001)continue;const I=l.enabled?Math.max(.2,Math.min(4,1/(1+l.position.z*.001))):1,X=1/Math.max(.1,1+w.z*.001),C=w.scale*I*X,B=(_.img.width||0)*C,z=(_.img.height||0)*C,L=Math.max(B,z)*1.5,G=w.x+(l.enabled?l.offset.x:0),H=w.y+(l.enabled?l.offset.y:0);G+L<0||G-L>this.width||H+L<0||H-L>this.height||v.push(_)}return v}getPerformanceStats(){return this.performanceMonitor.getStats()}resetPerformanceStats(){this.performanceMonitor.reset()}getLayerProps(n,e){const l=`${n.id}_${e}`,v=this.lastLayerProps.get(l);if(v&&!n.keyframes&&!n.usePathAnimation)return v;const _=n.keyframes||{};let w=this.interpolateValue(_.x,e,n.x),I=this.interpolateValue(_.y,e,n.y);if(n.usePathAnimation&&n.bezierPath&&n.bezierPath.length>=2){const C=this.interpolateBezierPath(n.bezierPath,e,2);C&&(w=C.x,I=C.y)}const X={x:w,y:I,z:this.interpolateValue(_.z,e,n.z),scale:this.interpolateValue(_.scale,e,n.scale),rotation:this.interpolateValue(_.rotation,e,n.rotation),rotationX:this.interpolateValue(_.rotationX,e,n.rotationX),rotationY:this.interpolateValue(_.rotationY,e,n.rotationY),rotationZ:this.interpolateValue(_.rotationZ,e,n.rotationZ),opacity:this.interpolateValue(_.opacity,e,n.opacity??1),anchorX:this.interpolateValue(_.anchorX,e,n.anchorX),anchorY:this.interpolateValue(_.anchorY,e,n.anchorY),perspective:this.interpolateValue(_.perspective,e,n.perspective),mask_size:this.interpolateValue(_.mask_size,e,n.mask_size)};if(this.lastLayerProps.set(l,X),this.lastLayerProps.size>100){const C=this.lastLayerProps.keys().next().value;C&&this.lastLayerProps.delete(C)}return X}interpolateValue(n,e,l){if(!n||n.length===0)return l;const v=[...n].sort((_,w)=>_.time-w.time);if(e<=v[0].time)return v[0].value;if(e>=v[v.length-1].time)return v[v.length-1].value;for(let _=0;_<v.length-1;_++)if(e>=v[_].time&&e<=v[_+1].time){const w=(e-v[_].time)/(v[_+1].time-v[_].time);return v[_].value+(v[_+1].value-v[_].value)*w}return l}interpolateBezierPath(n,e,l){if(!n||n.length<2)return null;const v=e/l,w=n.length-1,I=Math.min(Math.floor(v*w),w-1),X=v*w-I,C=n[I],B=n[I+1];if(!C||!B)return null;const z=C.cp2x??C.x+(B.x-C.x)/3,L=C.cp2y??C.y+(B.y-C.y)/3,G=B.cp1x??C.x+(B.x-C.x)*2/3,H=B.cp1y??C.y+(B.y-C.y)*2/3,$=1-X,re=$*$,D=re*$,T=X*X,je=T*X;return{x:D*C.x+3*re*X*z+3*$*T*G+je*B.x,y:D*C.y+3*re*X*L+3*$*T*H+je*B.y}}calculateBackgroundScale(n,e,l){if(!n.img||n.type!=="background")return 1;const v=n.img.width,_=n.img.height;if(v===0||_===0)return 1;switch(n.bg_mode||"fit"){case"fit":return Math.min(e/v,l/_);case"fill":return Math.max(e/v,l/_);case"stretch":return Math.min(e/v,l/_);default:return 1}}renderPanoramaLayer(n,e,l,v){if(!e.img||!this.panoramaPipeline)return;const _=e.id;let w;try{w=this.textureCache.loadImage(_,e.img)}catch(G){console.error("[GPUTimelineRenderer] Failed to load panorama texture:",G);return}const I=new ArrayBuffer(256),X=new Float32Array(I);let C=0;X[C++]=l.rotation.yaw,X[C++]=l.rotation.pitch,X[C++]=l.rotation.roll,X[C++]=l.fov,X[C++]=this.width/Math.max(1,this.height),X[C++]=0,X[C++]=this.width,X[C++]=this.height,this.device.queue.writeBuffer(this.uniformBuffer,0,I);const B=this.device.createBindGroup({layout:this.uniformBindGroupLayout,entries:[{binding:0,resource:{buffer:this.uniformBuffer}}]}),z=this.device.createBindGroup({layout:this.textureBindGroupLayout,entries:[{binding:0,resource:w.createView()},{binding:1,resource:this.sampler}]}),L=n.beginRenderPass({colorAttachments:[{view:v,loadOp:"load",storeOp:"store"}]});L.setPipeline(this.panoramaPipeline),L.setBindGroup(0,B),L.setBindGroup(1,z),L.setVertexBuffer(0,this.quadVertexBuffer),L.setIndexBuffer(this.indexBuffer,"uint16"),L.drawIndexed(6),L.end()}renderLayerInternal(n,e,l,v,_,w){if(!e.img)return;const I=e.id;let X;try{X=this.textureCache.loadImage(I,e.img)}catch(p){console.error(`[GPUTimelineRenderer] Failed to load texture for layer ${e.id}:`,p);return}const C=v.panorama&&e.type!=="background";v.enabled&&!C&&Math.max(.2,Math.min(4,1/(1+v.position.z*.001)));const B=v.offset.x,z=v.offset.y,L=1/Math.max(.1,1+l.z*.001);let G=1;e.type==="background"&&(G=this.calculateBackgroundScale(e,this.width,this.height));const H=l.scale*G*L,$=e.img.width,re=e.img.height,D=this.width/2,T=this.height/2;let je=l.x,Fe=l.y;if(v.enabled&&!v.panorama&&(v.rotation.yaw!==0||v.rotation.pitch!==0)){const p=v.rotation.yaw*Math.PI/180,g=v.rotation.pitch*Math.PI/180,b=l.z||0,y=Math.max(100,v.position.z+b);je-=Math.tan(p)*y,Fe-=Math.tan(g)*y}const Le=D+je+B,Ie=T+Fe+z,ge=$*H,ze=re*H,Pe=(Le-ge/2)/this.width*2-1,ce=(Le+ge/2)/this.width*2-1,Be=1-(Ie-ze/2)/this.height*2,Ee=1-(Ie+ze/2)/this.height*2,Te=new Float32Array([Pe,Ee,0,1,ce,Ee,1,1,ce,Be,1,0,Pe,Be,0,0]),Z=this.device.createBuffer({size:Te.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});this.device.queue.writeBuffer(Z,0,Te),this.tempBuffers.push(Z);const S=new ArrayBuffer(256),o=new Float32Array(S);let m=0;if(o[m++]=l.opacity,this.useAdvancedTransforms&&v.enabled){const p=v.rotation.yaw*Math.PI/180,g=v.rotation.pitch*Math.PI/180,b=v.rotation.roll*Math.PI/180,y=Math.cos(p),E=Math.sin(p),K=Math.cos(g),V=Math.sin(g),R=Math.cos(b),q=Math.sin(b),ee=R*y+q*V*E,ie=q*K,le=R*-E+q*V*y,pe=-q*y+R*V*E,de=R*K,ve=-q*-E+R*V*y,Ye=K*E,$e=-V,Ue=K*y;o[m++]=ee,o[m++]=ie,o[m++]=le,o[m++]=0,o[m++]=pe,o[m++]=de,o[m++]=ve,o[m++]=0,o[m++]=Ye,o[m++]=$e,o[m++]=Ue,o[m++]=0}else o[m++]=1,o[m++]=0,o[m++]=0,o[m++]=0,o[m++]=0,o[m++]=1,o[m++]=0,o[m++]=0,o[m++]=0,o[m++]=0,o[m++]=1,o[m++]=0;this.device.queue.writeBuffer(this.uniformBuffer,0,S);const x=this.device.createBindGroup({layout:this.uniformBindGroupLayout,entries:[{binding:0,resource:{buffer:this.uniformBuffer}}]}),c=this.device.createBindGroup({layout:this.textureBindGroupLayout,entries:[{binding:0,resource:X.createView()},{binding:1,resource:this.sampler}]}),u=n.beginRenderPass({colorAttachments:[{view:_,loadOp:"load",storeOp:"store"}]});u.setPipeline(w),u.setBindGroup(0,x),u.setBindGroup(1,c),u.setVertexBuffer(0,Z),u.setIndexBuffer(this.indexBuffer,"uint16"),u.drawIndexed(6),u.end()}renderLayer(n,e,l){const v=this.device.createCommandEncoder(),_=n.type==="background"?this.backgroundPipeline:this.foregroundPipeline,w={enabled:!1,position:{x:0,y:0,z:0},offset:{x:0,y:0},rotation:{yaw:0,pitch:0,roll:0},fov:90,panorama:!1};this.renderLayerInternal(v,n,e,w,l,_),this.device.queue.submit([v.finish()])}renderLayerWithMask(n,e,l,v,_){if(!e.maskCanvas||!e.img){this.renderLayerInternal(n,e,l,v,_,this.foregroundPipeline);return}try{const w=`${e.id}_mask`,I=e.maskCanvas,X=this.textureCache.loadImage(w,I),C={...l};C.opacity*=.8,this.renderLayerInternal(n,e,C,v,_,this.foregroundPipeline)}catch(w){console.warn(`[GPUTimelineRenderer] Failed to apply mask for layer ${e.id}:`,w),this.renderLayerInternal(n,e,l,v,_,this.foregroundPipeline)}}renderOverlay(n,e,l){if(n==="none"||!this.overlayPipeline)return;const v=this.device.createCommandEncoder();let _=[1,0,0,.3];switch(n){case"mask":_=[1,0,0,.5];break;case"extract":_=[0,0,0,.6];break;case"path":_=[0,.5,1,.8];break}l!=null&&l.color&&(_=l.color);const w=this.device.createBuffer({size:16,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),I=new Float32Array(_);this.device.queue.writeBuffer(w,0,I);const X=this.device.createBindGroup({layout:this.overlayBindGroupLayout,entries:[{binding:0,resource:{buffer:w}}]}),C=v.beginRenderPass({colorAttachments:[{view:e,loadOp:"load",storeOp:"store"}]});C.setPipeline(this.overlayPipeline),C.setBindGroup(0,X),C.setVertexBuffer(0,this.quadVertexBuffer),C.setIndexBuffer(this.indexBuffer,"uint16"),C.drawIndexed(6),C.end(),this.device.queue.submit([v.finish()]),w.destroy()}renderPathOverlay(n,e,l){!n||n.length<2||this.renderOverlay("path",e,{color:[0,.5,1,.8]})}renderMaskOverlay(n,e,l){n.maskCanvas&&this.renderOverlay("mask",e,{color:[1,0,0,.5],layer:n})}renderExtractOverlay(n,e,l){this.renderOverlay("extract",e,{color:[0,0,0,.6],layer:n})}updateUniforms(n){if(this.lastUniformData){const e=new Uint8Array(this.lastUniformData),l=new Uint8Array(n);let v=!1;for(let _=0;_<Math.min(e.length,l.length);_++)if(e[_]!==l[_]){v=!0;break}if(!v)return}this.device.queue.writeBuffer(this.uniformBuffer,0,n),this.lastUniformData=n.slice(0)}cameraStateChanged(n){if(!this.lastCameraState)return this.lastCameraState={...n},!0;const e=this.lastCameraState.enabled!==n.enabled||this.lastCameraState.position.x!==n.position.x||this.lastCameraState.position.y!==n.position.y||this.lastCameraState.position.z!==n.position.z||this.lastCameraState.offset.x!==n.offset.x||this.lastCameraState.offset.y!==n.offset.y||this.lastCameraState.rotation.yaw!==n.rotation.yaw||this.lastCameraState.rotation.pitch!==n.rotation.pitch||this.lastCameraState.rotation.roll!==n.rotation.roll||this.lastCameraState.fov!==n.fov||this.lastCameraState.panorama!==n.panorama;return e&&(this.lastCameraState={...n}),e}resizeRenderTargets(n,e){this.width=n,this.height=e}cleanup(){var n,e,l;for(const v of this.tempBuffers)v.destroy();this.tempBuffers=[],(n=this.uniformBuffer)==null||n.destroy(),(e=this.quadVertexBuffer)==null||e.destroy(),(l=this.indexBuffer)==null||l.destroy(),this.textureCache.cleanup(),console.log("[GPUTimelineRenderer] Cleaned up all resources")}getCacheStats(){return this.textureCache.getStats()}}class da{constructor(n,e){N(this,"device");N(this,"adapter",null);this.device=n,this.adapter=e||null}async getDeviceInfo(){var v,_,w;const n={},e=[];if(this.device.limits)for(const[I,X]of Object.entries(this.device.limits))typeof X=="number"&&(n[I]=X);this.device.features&&this.device.features.forEach(I=>{e.push(I)});let l="Unknown";if(this.adapter)try{const I=await((_=(v=this.adapter).requestAdapterInfo)==null?void 0:_.call(v));l=(I==null?void 0:I.description)||(I==null?void 0:I.vendor)||"WebGPU Adapter"}catch{l="WebGPU Adapter"}return{adapter:l,device:"WebGPU Device",limits:n,features:e,canvasFormat:((w=navigator.gpu)==null?void 0:w.getPreferredCanvasFormat())||"unknown"}}async logDeviceInfo(){const n=await this.getDeviceInfo();console.group("[GPUDebugger] Device Information"),console.log("Adapter:",n.adapter),console.log("Device:",n.device),console.log("Canvas Format:",n.canvasFormat),console.log("Features:",n.features),console.log("Limits:",n.limits),console.groupEnd()}checkRequiredFeatures(){const n=[],e=[];for(const l of n)this.device.features.has(l)||e.push(l);return{supported:e.length===0,missing:e}}getMemoryEstimate(n,e){const _=n*e*4/(1024*1024);return`~${Math.round(_)}MB`}validatePipeline(n){return n?!0:(console.error("[GPUDebugger] Pipeline is null"),!1)}logCacheStats(n){console.group("[GPUDebugger] Texture Cache Stats"),console.log("Total Textures:",n.totalTextures),console.log("Cache Hits:",n.cacheHits),console.log("Cache Misses:",n.cacheMisses),console.log("Hit Rate:",`${n.hitRate}%`),console.log("Memory Usage:",n.memoryUsage),console.groupEnd()}logPerformanceStats(n){console.group("[GPUDebugger] Performance Stats"),console.log("FPS:",n.fps),console.log("Frame Time:",`${n.frameTime}ms`),console.log("Avg Frame Time:",`${n.avgFrameTime}ms`),console.log("Min Frame Time:",`${n.minFrameTime}ms`),console.log("Max Frame Time:",`${n.maxFrameTime}ms`),console.log("Total Frames:",n.totalFrames),console.log("Dropped Frames:",n.droppedFrames),console.groupEnd()}createDebugOverlay(n){const e=document.createElement("div");return e.style.position="absolute",e.style.top="10px",e.style.right="10px",e.style.padding="10px",e.style.backgroundColor="rgba(0, 0, 0, 0.7)",e.style.color="#00ff00",e.style.fontFamily="monospace",e.style.fontSize="12px",e.style.zIndex="10000",e.style.pointerEvents="none",n.appendChild(e),e}updateDebugOverlay(n,e,l){n.innerHTML=`
      <div><strong>GPU Timeline Renderer</strong></div>
      <div>FPS: ${e.fps}</div>
      <div>Frame: ${e.frameTime}ms</div>
      <div>Avg: ${e.avgFrameTime}ms</div>
      <div>Dropped: ${e.droppedFrames}</div>
      <div>---</div>
      <div>Textures: ${l.totalTextures}</div>
      <div>Hit Rate: ${l.hitRate}%</div>
    `}}(globalThis.__TYPEGPU_AUTONAME__??(t=>t))(gt({position:st,scale:st,rotation:be,opacity:be,screenSize:st,rotationX:be,rotationY:be,rotationZ:be,perspective:be,cameraOffset:st,cameraScale:be,cameraYaw:be,cameraPitch:be,cameraRoll:be,cameraFOV:be,zDepth:be,anchorOffset:st,backgroundMode:Ht}),"LayerUniforms");(globalThis.__TYPEGPU_AUTONAME__??(t=>t))(gt({position:ta,offset:st,yaw:be,pitch:be,roll:be,fov:be,scale:be,enabled:Ht}),"CameraUniforms");(globalThis.__TYPEGPU_AUTONAME__??(t=>t))(gt({yaw:be,pitch:be,roll:be,fov:be,aspectRatio:be,screenSize:st}),"PanoramaUniforms");(globalThis.__TYPEGPU_AUTONAME__??(t=>t))(gt({position:aa.position,uv:$t(0,st),opacity:$t(1,be)}),"VertexOutput");function fa(t,n,e){let l=null,v=null,_=!1,w=null,I=null,X=null,C=!1;const B=new Map,z={};async function L(){const o=localStorage.getItem("timeline_disable_gpu")==="true";if(localStorage.getItem("timeline_gpu_camera_rotation"),!o&&"gpu"in navigator&&n.value)try{console.log("[Timeline] Attempting WebGPU initialization...");const m=await navigator.gpu.requestAdapter();if(console.log("[Timeline] GPU adapter:",m),m){const x=await m.requestDevice();console.log("[Timeline] GPU device:",x);const c=n.value.getContext("webgpu");if(console.log("[Timeline] WebGPU context:",c),c){const u=navigator.gpu.getPreferredCanvasFormat();console.log("[Timeline] Presentation format:",u),c.configure({device:x,format:u,alphaMode:"premultiplied"});const p=localStorage.getItem("timeline_gpu_advanced")==="true";w=new pa({device:x,presentationFormat:u,width:t.project.width,height:t.project.height,useAdvancedTransforms:p}),X=new da(x,m),I=c,C=!0,console.log("[Timeline] ✅ WebGPU initialized successfully"),console.log("[Timeline] Canvas size:",t.project.width,"x",t.project.height),e.value&&(v=e.value.getContext("2d",{alpha:!0}));return}}}catch(m){console.warn("[Timeline] ❌ WebGPU initialization failed, falling back to Canvas 2D:",m)}else o?console.log("[Timeline] GPU rendering disabled by user preference"):"gpu"in navigator||console.log("[Timeline] WebGPU not supported in this browser");console.log("[Timeline] Using Canvas 2D renderer"),C=!1,n.value&&(l=n.value.getContext("2d",{alpha:!1,desynchronized:!0})),e.value&&(v=e.value.getContext("2d",{alpha:!0}))}function G(){_||(_=!0,requestAnimationFrame(()=>{_=!1,T()}))}function H(o){if(o.img)return o.img;if(!o.image_data)return null;const m=o.id;if(B.has(m)){const c=B.get(m);return c.complete?(o.img=c,c):null}const x=new Image;return x.onload=()=>{o.img=x,G()},x.src=o.image_data,B.set(m,x),null}function $(o,m,x){if(!o||o.length===0)return x;const c=[...o].sort((u,p)=>u.time-p.time);if(m<=c[0].time)return c[0].value;if(m>=c[c.length-1].time)return c[c.length-1].value;for(let u=0;u<c.length-1;u++)if(m>=c[u].time&&m<=c[u+1].time){const p=(m-c[u].time)/(c[u+1].time-c[u].time);return c[u].value+(c[u+1].value-c[u].value)*p}return x}function re(o,m,x){if(!o||o.length<2)return null;const c=m/x,p=o.length-1,g=Math.min(Math.floor(c*p),p-1),b=c*p-g,y=o[g],E=o[g+1];if(!y||!E)return null;const K=y.cp2x??y.x+(E.x-y.x)/3,V=y.cp2y??y.y+(E.y-y.y)/3,R=E.cp1x??y.x+(E.x-y.x)*2/3,q=E.cp1y??y.y+(E.y-y.y)*2/3,ee=1-b,ie=ee*ee,le=ie*ee,pe=b*b,de=pe*b;return{x:le*y.x+3*ie*b*K+3*ee*pe*R+de*E.x,y:le*y.y+3*ie*b*V+3*ee*pe*q+de*E.y}}function D(o){const m=t.currentTime,x=o.keyframes||{};let c=$(x.x,m,o.x||0),u=$(x.y,m,o.y||0);if(o.usePathAnimation&&o.bezierPath&&o.bezierPath.length>=2){const p=re(o.bezierPath,m,t.project.duration);p&&(c=p.x,u=p.y)}return{x:c,y:u,z:$(x.z,m,o.z||0),scale:$(x.scale,m,o.scale||1),rotation:$(x.rotation,m,o.rotation||0),opacity:$(x.opacity,m,o.opacity??1),mask_size:$(x.mask_size,m,o.mask_size||0),rotationX:$(x.rotationX,m,o.rotationX||0),rotationY:$(x.rotationY,m,o.rotationY||0),rotationZ:$(x.rotationZ,m,o.rotationZ||0),anchorX:$(x.anchorX,m,o.anchorX||0),anchorY:$(x.anchorY,m,o.anchorY||0),perspective:$(x.perspective,m,o.perspective||1e3)}}function T(){C&&w&&I?je():Fe(),Ie()}function je(){var c,u,p,g,b,y,E,K,V;if(!w||!I)return;let o=!0;for(const R of t.layers)R.image_data&&!R.img&&(H(R)||(o=!1));if(!o){Fe();return}const x={enabled:!!t.project.cam_enable&&!t.project.pano_enable,position:{x:((c=t.interpolateProjectValue)==null?void 0:c.call(t,"cam_pos_x",t.currentTime,t.project.cam_pos_x||0))??(t.project.cam_pos_x||0),y:((u=t.interpolateProjectValue)==null?void 0:u.call(t,"cam_pos_y",t.currentTime,t.project.cam_pos_y||0))??(t.project.cam_pos_y||0),z:((p=t.interpolateProjectValue)==null?void 0:p.call(t,"cam_pos_z",t.currentTime,t.project.cam_pos_z||0))??(t.project.cam_pos_z||0)},offset:{x:((g=t.interpolateProjectValue)==null?void 0:g.call(t,"cam_offset_x",t.currentTime,t.project.cam_offset_x||0))??(t.project.cam_offset_x||0),y:((b=t.interpolateProjectValue)==null?void 0:b.call(t,"cam_offset_y",t.currentTime,t.project.cam_offset_y||0))??(t.project.cam_offset_y||0)},rotation:{yaw:((y=t.interpolateProjectValue)==null?void 0:y.call(t,"cam_yaw",t.currentTime,t.project.cam_yaw||0))??(t.project.cam_yaw||0),pitch:((E=t.interpolateProjectValue)==null?void 0:E.call(t,"cam_pitch",t.currentTime,t.project.cam_pitch||0))??(t.project.cam_pitch||0),roll:((K=t.interpolateProjectValue)==null?void 0:K.call(t,"cam_roll",t.currentTime,t.project.cam_roll||0))??(t.project.cam_roll||0)},fov:((V=t.interpolateProjectValue)==null?void 0:V.call(t,"cam_fov",t.currentTime,t.project.cam_fov||90))??(t.project.cam_fov||90),panorama:!!t.project.pano_enable};try{const R=I.getCurrentTexture().createView();w.renderFrame(t.layers,t.currentTime,x,R)}catch(R){console.error("[Timeline] GPU rendering error:",R),C=!1,Fe()}}function Fe(){var u,p,g;if(!n.value||!l)return;l.fillStyle="#000",l.fillRect(0,0,t.project.width,t.project.height);const o=((u=t.interpolateProjectValue)==null?void 0:u.call(t,"cam_offset_x",t.currentTime,t.project.cam_offset_x??0))??t.project.cam_offset_x??0,m=((p=t.interpolateProjectValue)==null?void 0:p.call(t,"cam_offset_y",t.currentTime,t.project.cam_offset_y??0))??t.project.cam_offset_y??0;t.project.pano_enable;const x=!!t.project.cam_enable,c=t.layers.find(b=>b.type==="background");c&&l&&ze(l,c,o,m,1,x),l&&t.layers.filter(b=>b.type!=="background").forEach(b=>{Pe(l,b,o,m,x,1)}),t.pathMode.enabled&&((g=t.currentLayer)!=null&&g.bezierPath)&&l&&ce(l,t.currentLayer.bezierPath),t.extractMode.enabled}let Re=null;function Le(o){Re=o}function Ie(){var c,u;if(!e.value||!v)return;const o=v,m=t.project.width,x=t.project.height;o.clearRect(0,0,m,x),t.pathMode.enabled&&((c=t.currentLayer)!=null&&c.bezierPath)&&Be(o,t.currentLayer.bezierPath),t.extractMode.enabled&&Re&&Re(o),t.maskMode.enabled&&((u=t.currentLayer)!=null&&u.maskCanvas)&&Ee(o),t.currentLayer&&t.currentLayer.img&&Te(o)}function ge(o,m,x){if(o.maskCanvas||!o.customMask)return;const c=new Image;c.onload=()=>{const u=document.createElement("canvas");u.width=c.width||m,u.height=c.height||x;const p=u.getContext("2d");p&&(p.drawImage(c,0,0,u.width,u.height),o.maskCanvas=u,G())},c.src=o.customMask}function ze(o,m,x=0,c=0,u=1,p=!1){var le,pe,de,ve;const g=H(m);if(!g||g.width===0||g.height===0)return;const b=D(m),y=!!t.project.pano_enable;o.save(),o.globalAlpha=b.opacity;const E=m.bg_mode||"fit",K=t.project.width,V=t.project.height,R=g.width,q=g.height;let ee=1;if(y&&R>0&&q>0){const Ye=((le=t.interpolateProjectValue)==null?void 0:le.call(t,"cam_yaw",t.currentTime,t.project.cam_yaw||0))??(t.project.cam_yaw||0),$e=((pe=t.interpolateProjectValue)==null?void 0:pe.call(t,"cam_pitch",t.currentTime,t.project.cam_pitch||0))??(t.project.cam_pitch||0),Ue=((de=t.interpolateProjectValue)==null?void 0:de.call(t,"cam_roll",t.currentTime,t.project.cam_roll||0))??(t.project.cam_roll||0),Oe=Math.min(170,Math.max(10,((ve=t.interpolateProjectValue)==null?void 0:ve.call(t,"cam_fov",t.currentTime,t.project.cam_fov||90))??(t.project.cam_fov||90))),se=Math.PI/180,ue=1024;let f=K,h=V;const M=Math.max(1,Math.max(K,V)/ue);M>1.01&&(f=Math.max(1,Math.round(K/M)),h=Math.max(1,Math.round(V/M)));const j=`${f}x${h}|${R}x${q}|${Ye}|${$e}|${Ue}|${Oe}`;if(z.key!==j){const ae=document.createElement("canvas");ae.width=R,ae.height=q;const _e=ae.getContext("2d");_e?(_e.drawImage(g,0,0,R,q),z.srcData=_e.getImageData(0,0,R,q).data):z.srcData=void 0;const Xe=K/Math.max(1,V),Ve=Math.tan(Oe*se/2),Me=Ye*se,Ce=$e*se,me=Ue*se,ye=Math.cos(Me),We=Math.sin(Me),at=Math.cos(Ce),pt=Math.sin(Ce),dt=Math.cos(me),ct=Math.sin(me),lt=new Float32Array(f*h),ut=new Float32Array(f*h);for(let nt=0;nt<h;nt++){const ft=(nt+.5)/h*2-1;for(let He=0;He<f;He++){let a=((He+.5)/f*2-1)*Ve*Xe,i=-ft*Ve,d=1;const P=1/Math.hypot(a,i,d);a*=P,i*=P,d*=P;let F=ye*a+We*d,A=-We*a+ye*d;a=F,d=A;let Q=at*i-pt*d;A=pt*i+at*d,i=Q,d=A,F=dt*a-ct*i,Q=ct*a+dt*i,a=F,i=Q;const O=Math.atan2(a,d),Se=Math.asin(Math.max(-1,Math.min(1,i))),Je=(O/(Math.PI*2)+.5)*R,Ge=(.5-Se/Math.PI)*q;let Ke=Math.floor(Je)%R;Ke<0&&(Ke+=R);let Qe=Math.floor(Ge);Qe=Math.max(0,Math.min(q-1,Qe));const et=nt*f+He;lt[et]=Ke,ut[et]=Qe}}z.key=j,z.mapX=lt,z.mapY=ut,z.imgW=R,z.imgH=q,z.outW=f,z.outH=h,z.canvas=document.createElement("canvas"),z.canvas.width=f,z.canvas.height=h,z.ctx=z.canvas.getContext("2d")}const Y=z.srcData,W=z.mapX,J=z.mapY,te=z.canvas,we=z.ctx,ke=z.outW||0,Ae=z.outH||0;if(Y&&W&&J&&te&&we&&ke>0&&Ae>0){const ae=we.getImageData(0,0,ke,Ae),_e=ae.data,Xe=ke*Ae;for(let Ve=0;Ve<Xe;Ve++){const Me=W[Ve],me=(J[Ve]*R+Me)*4,ye=Ve*4;_e[ye]=Y[me],_e[ye+1]=Y[me+1],_e[ye+2]=Y[me+2],_e[ye+3]=255}we.putImageData(ae,0,0),o.drawImage(te,0,0,K,V),o.restore();return}else return o.restore(),ze(o,{...m,panoFallback:!0,type:m.type,bg_mode:m.bg_mode},x,c,1,!1)}else{R>0&&q>0&&(E==="fit"?ee=Math.min(K/R,V/q):E==="fill"?ee=Math.max(K/R,V/q):E==="stretch"&&(ee=Math.min(K/R,V/q))),(!Number.isFinite(ee)||ee<=0)&&(ee=1);let Ye=b.x,$e=b.y;const Ue=b.z||0,Oe=1/Math.max(.1,1+Ue*.001),se=K/2+Ye+x,ue=V/2+$e+c,f=(b.scale||1)*ee*Oe;if(!Number.isFinite(se)||!Number.isFinite(ue)||!Number.isFinite(f)||f<=0){o.restore();return}o.translate(se,ue);const h=b.rotationZ!==void 0&&b.rotationZ!==0?b.rotationZ:b.rotation;o.rotate((h||0)*Math.PI/180),o.scale(f,f),o.drawImage(g,-R/2,-q/2,R,q)}o.restore()}function Pe(o,m,x=0,c=0,u=!1,p=1){var $e,Ue,Oe;const g=H(m);if(!g||g.width===0||g.height===0)return;const b=D(m),y=g.width,E=g.height;ge(m,y,E),o.save();const K=!!t.project.pano_enable;let V=b.x,R=b.y;const q=b.z||0;if(u||K){const se=(($e=t.interpolateProjectValue)==null?void 0:$e.call(t,"cam_yaw",t.currentTime,t.project.cam_yaw??0))??t.project.cam_yaw??0,ue=((Ue=t.interpolateProjectValue)==null?void 0:Ue.call(t,"cam_pitch",t.currentTime,t.project.cam_pitch??0))??t.project.cam_pitch??0,f=((Oe=t.interpolateProjectValue)==null?void 0:Oe.call(t,"cam_fov",t.currentTime,t.project.cam_fov??90))??t.project.cam_fov??90;if(se!==0||ue!==0){const h=se*Math.PI/180,M=ue*Math.PI/180,j=Math.tan(f*Math.PI/180/2),U=t.project.width/(2*j);V-=Math.tan(h)*U,R-=Math.tan(M)*U}}const ee=1/Math.max(.1,1+q*.001),ie=t.project.width/2+V+x,le=t.project.height/2+R+c;if(!Number.isFinite(ie)||!Number.isFinite(le)){o.restore();return}if(o.translate(ie,le),b.rotationX!==0||b.rotationY!==0){const se=b.rotationX*Math.PI/180,ue=b.rotationY*Math.PI/180,f=Math.cos(se),h=Math.cos(ue);o.scale(h,f)}const pe=b.rotationZ!==void 0&&b.rotationZ!==0?b.rotationZ:b.rotation;o.rotate(pe*Math.PI/180);const de=b.scale*ee;o.scale(de,de),o.globalAlpha=b.opacity;const ve=(b.anchorX||0)*y,Ye=(b.anchorY||0)*E;if(m.maskCanvas){const se=document.createElement("canvas");se.width=y,se.height=E;const ue=se.getContext("2d");ue?(ue.clearRect(0,0,y,E),ue.drawImage(g,0,0,y,E),ue.globalCompositeOperation="destination-in",ue.drawImage(m.maskCanvas,0,0,y,E),o.drawImage(se,-y/2-ve,-E/2-Ye,y,E)):o.drawImage(g,-y/2-ve,-E/2-Ye,y,E)}else o.drawImage(g,-y/2-ve,-E/2-Ye,y,E);if(b.mask_size>0){o.strokeStyle="#3ac88e",o.lineWidth=2/b.scale,o.setLineDash([5/b.scale,5/b.scale]);const se=y*b.mask_size,ue=E*b.mask_size;o.strokeRect(-se/2,-ue/2,se,ue),o.setLineDash([])}o.restore()}function ce(o,m){if(!m||m.length===0)return;const x=t.project.width/2,c=t.project.height/2;o.save(),o.strokeStyle="#ff6b6b",o.lineWidth=2,o.setLineDash([5,5]),o.beginPath(),o.moveTo(x+m[0].x,c+m[0].y);for(let u=1;u<m.length;u++){const p=m[u-1],g=m[u],b=p.cp2x??p.x+(g.x-p.x)/3,y=p.cp2y??p.y+(g.y-p.y)/3,E=g.cp1x??p.x+(g.x-p.x)*2/3,K=g.cp1y??p.y+(g.y-p.y)*2/3;o.bezierCurveTo(x+b,c+y,x+E,c+K,x+g.x,c+g.y)}if(o.stroke(),o.setLineDash([]),m.forEach((u,p)=>{o.beginPath(),o.arc(x+u.x,c+u.y,6,0,Math.PI*2),o.fillStyle=p===0?"#4ecdc4":p===m.length-1?"#ff6b6b":"#ffe66d",o.fill(),o.strokeStyle="#fff",o.lineWidth=2,o.stroke()}),m.length>=2){const u=m.length-1,p=m[u-1],g=m[u],b=p.cp2x??p.x+(g.x-p.x)/3,y=p.cp2y??p.y+(g.y-p.y)/3,E=g.cp1x??p.x+(g.x-p.x)*2/3,K=g.cp1y??p.y+(g.y-p.y)*2/3,V=.99,R=1-V,q=3*R*R*(b-p.x)+6*R*V*(E-b)+3*V*V*(g.x-E),ee=3*R*R*(y-p.y)+6*R*V*(K-y)+3*V*V*(g.y-K),ie=Math.atan2(ee,q),le=x+g.x,pe=c+g.y,de=18;o.beginPath(),o.moveTo(le,pe),o.lineTo(le-de*Math.cos(ie-Math.PI/6),pe-de*Math.sin(ie-Math.PI/6)),o.moveTo(le,pe),o.lineTo(le-de*Math.cos(ie+Math.PI/6),pe-de*Math.sin(ie+Math.PI/6)),o.strokeStyle="#ff6b6b",o.lineWidth=2,o.stroke()}o.restore()}function Be(o,m){if(!m||m.length===0)return;const x=t.project.width/2,c=t.project.height/2;o.save(),o.strokeStyle="#ff6b6b",o.lineWidth=2,o.setLineDash([5,5]),o.beginPath(),o.moveTo(x+m[0].x,c+m[0].y);for(let u=1;u<m.length;u++){const p=m[u-1],g=m[u],b=p.cp2x??p.x+(g.x-p.x)/3,y=p.cp2y??p.y+(g.y-p.y)/3,E=g.cp1x??p.x+(g.x-p.x)*2/3,K=g.cp1y??p.y+(g.y-p.y)*2/3;o.bezierCurveTo(x+b,c+y,x+E,c+K,x+g.x,c+g.y)}o.stroke(),o.setLineDash([]),m.forEach((u,p)=>{o.beginPath(),o.arc(x+u.x,c+u.y,6,0,Math.PI*2),o.fillStyle=p===0?"#4ecdc4":p===m.length-1?"#ff6b6b":"#ffe66d",o.fill(),o.strokeStyle="#fff",o.lineWidth=2,o.stroke()}),o.restore()}function Ee(o){var pe,de;const m=t.currentLayer;if(!m||!m.maskCanvas||!m.img)return;const x=D(m),c=m.img.width,u=m.img.height,p=t.project.width,g=t.project.height,b=p/2,y=g/2,E=((pe=t.interpolateProjectValue)==null?void 0:pe.call(t,"cam_offset_x",t.currentTime,t.project.cam_offset_x??0))??t.project.cam_offset_x??0,K=((de=t.interpolateProjectValue)==null?void 0:de.call(t,"cam_offset_y",t.currentTime,t.project.cam_offset_y??0))??t.project.cam_offset_y??0,V=x.z||0,R=1/Math.max(.1,1+V*.001),q=x.x+E,ee=x.y+K,ie=x.scale*R;o.save(),o.globalAlpha=.5,o.translate(b+q,y+ee);const le=x.rotationZ!==void 0&&x.rotationZ!==0?x.rotationZ:x.rotation;o.rotate(le*Math.PI/180),o.scale(ie,ie),o.fillStyle="rgba(255, 0, 0, 0.3)",o.fillRect(-c/2,-u/2,c,u),o.globalCompositeOperation="destination-out",o.drawImage(m.maskCanvas,-c/2,-u/2,c,u),o.restore()}function Te(o){var Ue,Oe,se,ue,f;const m=t.currentLayer;if(!m||!m.img)return;const x=D(m),c=m.img.width,u=m.img.height,p=t.project.width,g=t.project.height,b=p/2,y=g/2,E=!!t.project.cam_enable,K=!!t.project.pano_enable,V=((Ue=t.interpolateProjectValue)==null?void 0:Ue.call(t,"cam_offset_x",t.currentTime,t.project.cam_offset_x??0))??t.project.cam_offset_x??0,R=((Oe=t.interpolateProjectValue)==null?void 0:Oe.call(t,"cam_offset_y",t.currentTime,t.project.cam_offset_y??0))??t.project.cam_offset_y??0,q=x.z||0,ee=1/Math.max(.1,1+q*.001);let ie=x.x,le=x.y;if((E||K)&&m.type!=="background"){const h=((se=t.interpolateProjectValue)==null?void 0:se.call(t,"cam_yaw",t.currentTime,t.project.cam_yaw??0))??t.project.cam_yaw??0,M=((ue=t.interpolateProjectValue)==null?void 0:ue.call(t,"cam_pitch",t.currentTime,t.project.cam_pitch??0))??t.project.cam_pitch??0,j=((f=t.interpolateProjectValue)==null?void 0:f.call(t,"cam_fov",t.currentTime,t.project.cam_fov??90))??t.project.cam_fov??90;if(h!==0||M!==0){const U=h*Math.PI/180,Y=M*Math.PI/180,W=Math.tan(j*Math.PI/180/2),J=p/(2*W);ie-=Math.tan(U)*J,le-=Math.tan(Y)*J}}let pe=ie+V,de=le+R,ve=x.scale*ee;if(m.type==="background"&&c>0&&u>0){const h=m.bg_mode||"fit";let M=1;h==="fit"?M=Math.min(p/c,g/u):h==="fill"?M=Math.max(p/c,g/u):M=Math.min(p/c,g/u),ve=x.scale*M*ee}(!Number.isFinite(ve)||ve<=0)&&(ve=1),o.save(),o.translate(b+pe,y+de);const Ye=x.rotationZ!==void 0&&x.rotationZ!==0?x.rotationZ:x.rotation;o.rotate(Ye*Math.PI/180),o.scale(ve,ve),o.strokeStyle="#3a7bc8",o.lineWidth=2/ve,o.strokeRect(-c/2,-u/2,c,u),o.fillStyle="#3a7bc8",[[-c/2,-u/2],[c/2,-u/2],[c/2,u/2],[-c/2,u/2]].forEach(([h,M])=>{o.fillRect(h-4/ve,M-4/ve,8/ve,8/ve)}),o.restore()}function Z(){B.clear(),w&&(w.cleanup(),w=null),I=null}function S(o){o?(localStorage.removeItem("timeline_disable_gpu"),console.log("[Timeline] GPU rendering will be enabled on next reload")):(localStorage.setItem("timeline_disable_gpu","true"),console.log("[Timeline] GPU rendering will be disabled on next reload"))}return{initContexts:L,scheduleRender:G,render:T,getCachedImage:H,getLayerProps:D,setDrawExtractOverlayOnCtx:Le,cleanup:Z,panoCache:z,imageCache:B,isUsingGPU:()=>C,toggleGPU:S,getGPUStats:()=>(w==null?void 0:w.getCacheStats())||null,getPerformanceStats:()=>(w==null?void 0:w.getPerformanceStats())||null,resetPerformanceStats:()=>w==null?void 0:w.resetPerformanceStats()}}function ha(t,n,e,l,v,_){let w=!1,I=0,X=0,C=0,B=0,z=!1,L=!1,G=0,H=0,$=0,re=0,D=0,T=0,je=!1,Fe=!1,Re=!1,Le=!1,Ie=0,ge=0,ze=0,Pe=0,ce=0,Be=0,Ee=0,Te=0,Z=!1,S=null,o=null,m=null,x=!1,c=null,u=!1,p=-1;function g(f){return!(!(!t.maskMode.enabled&&!t.extractMode.enabled&&!t.pathMode.enabled)||!t.project.cam_enable||t.project.pano_enable||f&&"ctrlKey"in f&&f.ctrlKey)}function b(f){const h=e.value||n.value;if(!h)return{x:0,y:0};const M=h.getBoundingClientRect(),j=t.project.width/M.width,U=t.project.height/M.height;return{x:(f.clientX-M.left)*j,y:(f.clientY-M.top)*U}}function y(f,h,M){const j=t.currentTime;if(f.keyframes&&f.keyframes[h]&&f.keyframes[h].length>0){const U=f.keyframes[h].findIndex(Y=>Math.abs(Y.time-j)<.05);U>=0?f.keyframes[h][U]={time:f.keyframes[h][U].time,value:M}:(f.keyframes[h].push({time:j,value:M}),f.keyframes[h].sort((Y,W)=>Y.time-W.time))}t.updateLayer(t.currentLayerIndex,{[h]:M})}function E(f){var Y;(Y=e.value)==null||Y.focus(),f.shiftKey,f.altKey;const h=b(f);if(g(f)){if(Ie=h.x,ge=h.y,ze=t.project.cam_pos_x||0,Pe=t.project.cam_pos_y||0,ce=t.project.cam_pos_z||0,Be=t.project.cam_yaw||0,Ee=t.project.cam_pitch||0,Te=t.project.cam_roll||0,f.button===0&&f.shiftKey){Le=!0;return}if(f.button===0){Fe=!0;return}if(f.button===1){je=!0;return}if(f.button===2){Re=!0;return}}if(t.project.pano_enable&&!t.maskMode.enabled&&!t.extractMode.enabled&&!t.pathMode.enabled){if(G=h.x,H=h.y,$=t.project.cam_yaw||0,re=t.project.cam_pitch||0,D=t.project.cam_offset_x||0,T=t.project.cam_offset_y||0,f.button===1||f.button===2){z=!0;return}else if(f.button===0&&(!t.currentLayer||f.altKey)){L=!0;return}}if(!t.currentLayer)return;if(t.extractMode.enabled){if(!le()){console.warn("[Timeline] Extract mode requires a background layer with image data");return}x=!0,pe(h.x,h.y,f.button===2||f.altKey);return}if(t.maskMode.enabled){Z=!0,ee(),ie(h.x,h.y);return}if(t.pathMode.enabled){Oe(h);return}w=!0,I=h.x,X=h.y;const U=v(t.currentLayer);C=U.x,B=U.y}function K(f){var W,J,te,we,ke,Ae,ae,_e,Xe,Ve;const h=b(f);if(Fe){const Me=h.x-Ie,Ce=h.y-ge,me=Be+Me*.25,ye=Math.max(-89,Math.min(89,Ee+Ce*.25));t.setProject({cam_yaw:me,cam_pitch:ye}),(W=t.setProjectKeyframe)==null||W.call(t,"cam_yaw",t.currentTime,me),(J=t.setProjectKeyframe)==null||J.call(t,"cam_pitch",t.currentTime,ye),l();return}if(je){const Me=h.x-Ie,Ce=h.y-ge,me=1+Math.max(0,(ce||0)/500),ye=ze+Me*me,We=Pe+Ce*me;t.setProject({cam_pos_x:ye,cam_pos_y:We}),(te=t.setProjectKeyframe)==null||te.call(t,"cam_pos_x",t.currentTime,ye),(we=t.setProjectKeyframe)==null||we.call(t,"cam_pos_y",t.currentTime,We),l();return}if(Re){const Me=h.y-ge,me=ce+Me*2;t.setProject({cam_pos_z:me}),(ke=t.setProjectKeyframe)==null||ke.call(t,"cam_pos_z",t.currentTime,me),l();return}if(Le){const Me=h.x-Ie,Ce=Te+Me*.25;t.setProject({cam_roll:Ce}),(Ae=t.setProjectKeyframe)==null||Ae.call(t,"cam_roll",t.currentTime,Ce),l();return}if(z){const Me=h.x-G,Ce=h.y-H,me=$+Me*.2,ye=Math.max(-89,Math.min(89,re+Ce*.2));t.setProject({cam_yaw:me,cam_pitch:ye}),(ae=t.setProjectKeyframe)==null||ae.call(t,"cam_yaw",t.currentTime,me),(_e=t.setProjectKeyframe)==null||_e.call(t,"cam_pitch",t.currentTime,ye),l();return}if(L){const Me=h.x-G,Ce=h.y-H,me=(D||0)+Me,ye=(T||0)+Ce;t.setProject({cam_offset_x:me,cam_offset_y:ye}),(Xe=t.setProjectKeyframe)==null||Xe.call(t,"cam_offset_x",t.currentTime,me),(Ve=t.setProjectKeyframe)==null||Ve.call(t,"cam_offset_y",t.currentTime,ye),l();return}if(t.extractMode.enabled&&x){pe(h.x,h.y,(f.buttons&2)===2||f.altKey);return}if(Z&&t.maskMode.enabled){ie(h.x,h.y);return}if(u&&p>=0){ue(h);return}if(!w||!t.currentLayer)return;let M=h.x-I,j=h.y-X;f.shiftKey&&(Math.abs(M)>Math.abs(j)?j=0:M=0);const U=C+M,Y=B+j;y(t.currentLayer,"x",U),y(t.currentLayer,"y",Y),l()}function V(){w=!1,Z=!1,x=!1,u=!1,p=-1,z=!1,L=!1,je=!1,Fe=!1,Re=!1,Le=!1}function R(f){var we,ke,Ae;const h=f.deltaY>0?-.05:.05;if(g(f)){const ae=t.project.cam_pos_z||0,_e=8,Xe=ae+(h>0?_e:-_e);t.setProject({cam_pos_z:Xe}),(we=t.setProjectKeyframe)==null||we.call(t,"cam_pos_z",t.currentTime,Xe),l();return}if(t.project.pano_enable&&!t.maskMode.enabled&&!t.extractMode.enabled&&!t.pathMode.enabled&&(!t.currentLayer||f.ctrlKey||f.altKey)){const ae=Math.min(170,Math.max(10,(t.project.cam_fov||90)+(h>0?2:-2)));t.setProject({cam_fov:ae}),(ke=t.setProjectKeyframe)==null||ke.call(t,"cam_fov",t.currentTime,ae),l();return}if(!!t.project.cam_enable&&!t.project.pano_enable&&!t.maskMode.enabled&&!t.extractMode.enabled&&!t.pathMode.enabled&&!t.currentLayer&&!t.currentLayer){const ae=t.project.cam_pos_z||0,_e=5,Xe=ae+(h>0?_e:-_e);t.setProject({cam_pos_z:Xe}),(Ae=t.setProjectKeyframe)==null||Ae.call(t,"cam_pos_z",t.currentTime,Xe),l();return}if(!t.currentLayer)return;const W=t.currentLayer,J=v(W),te=2;if(f.shiftKey&&!f.ctrlKey&&!f.altKey){const ae=J.rotationX+(h>0?te:-te);y(W,"rotationX",ae)}else if(f.ctrlKey&&!f.shiftKey&&!f.altKey){const ae=J.rotationY+(h>0?te:-te);y(W,"rotationY",ae)}else if(f.altKey&&!f.shiftKey&&!f.ctrlKey){const ae=(J.rotationZ||J.rotation||0)+(h>0?te:-te);y(W,"rotationZ",ae)}else{const ae=Math.max(.1,Math.min(5,J.scale+h));y(W,"scale",ae)}l()}function q(f){if(!t.currentLayer)return;const h=f.shiftKey?10:1,M=t.currentLayer,j=v(M);switch(f.key){case"ArrowLeft":y(M,"x",j.x-h),l(),f.preventDefault();break;case"ArrowRight":y(M,"x",j.x+h),l(),f.preventDefault();break;case"ArrowUp":y(M,"y",j.y-h),l(),f.preventDefault();break;case"ArrowDown":y(M,"y",j.y+h),l(),f.preventDefault();break;case"r":case"R":y(M,"x",0),y(M,"y",0),y(M,"scale",1),y(M,"rotation",0),y(M,"opacity",1),l(),f.preventDefault();break;case"Delete":case"Backspace":confirm("Delete current layer?")&&t.removeLayer(t.currentLayerIndex),f.preventDefault();break}}function ee(){const f=t.currentLayer;if(!(!f||!f.img)){if(f.maskCanvas)S=f.maskCanvas.getContext("2d");else if(f.maskCanvas=document.createElement("canvas"),f.maskCanvas.width=f.img.width,f.maskCanvas.height=f.img.height,S=f.maskCanvas.getContext("2d"),S)if(f.customMask){const h=new Image;h.onload=()=>{S==null||S.drawImage(h,0,0),l()},h.src=f.customMask}else S.globalCompositeOperation="source-over",S.fillStyle="white",S.fillRect(0,0,f.maskCanvas.width,f.maskCanvas.height)}}function ie(f,h){const M=t.currentLayer;if(!M||((!S||!M.maskCanvas)&&ee(),!M.img||!S||!M.maskCanvas))return;const j=v(M),U=t.project.width/2+j.x,Y=t.project.height/2+j.y,W=(f-U)/j.scale+M.img.width/2,J=(h-Y)/j.scale+M.img.height/2,te=t.maskMode.brush||20;S.save(),S.beginPath(),S.arc(W,J,te,0,Math.PI*2),t.maskMode.erase?(S.globalCompositeOperation="source-over",S.fillStyle="white"):(S.globalCompositeOperation="destination-out",S.fillStyle="black"),S.fill(),S.restore(),l()}function le(){const f=t.layers.find(M=>M.type==="background");if(!f)return null;const h=_(f);return h?((!o||!m||o.width!==h.width||o.height!==h.height||c!==f.id)&&(o=document.createElement("canvas"),o.width=h.width,o.height=h.height,m=o.getContext("2d"),m&&m.clearRect(0,0,h.width,h.height),c=f.id||null),{layer:f,img:h,ctx:m}):null}function pe(f,h,M=!1){const j=le();if(!j)return;const{layer:U,img:Y,ctx:W}=j,J=v(U),te=t.project.width/2+(J.x??0),we=t.project.height/2+(J.y??0),ke=J.scale??1,Ae=(f-te)/ke+Y.width/2,ae=(h-we)/ke+Y.height/2,_e=Math.max(1,t.extractMode.brush||30);W.beginPath(),W.arc(Ae,ae,_e,0,Math.PI*2),W.fillStyle=M?"black":"white",W.fill(),l()}function de(){m&&o&&(m.clearRect(0,0,o.width,o.height),l())}function ve(){if(!m||!o)return!1;const f=m.getImageData(0,0,o.width,o.height).data;for(let h=0;h<f.length;h+=4)if(f[h]>10)return!0;return!1}function Ye(f,h,M){const j=f.canvas,U=document.createElement("canvas");U.width=h,U.height=M;const Y=U.getContext("2d");if(!Y)return null;Y.drawImage(j,0,0);const W=20;Y.globalCompositeOperation="destination-over";for(let J=0;J<W;J++)Y.drawImage(U,1,0),Y.drawImage(U,-1,0),Y.drawImage(U,0,1),Y.drawImage(U,0,-1),J%2===0&&(Y.drawImage(U,1,1),Y.drawImage(U,-1,-1),Y.drawImage(U,1,-1),Y.drawImage(U,-1,1));for(let J=0;J<10;J++)Y.drawImage(U,2,0),Y.drawImage(U,-2,0),Y.drawImage(U,0,2),Y.drawImage(U,0,-2),Y.drawImage(U,2,2),Y.drawImage(U,-2,-2),Y.drawImage(U,2,-2),Y.drawImage(U,-2,2);return U.toDataURL("image/png")}function $e(){const f=le();if(!f||!o||!m)return{error:"Background layer not ready"};if(!ve())return null;const{img:h}=f,M=document.createElement("canvas");M.width=h.width,M.height=h.height;const j=M.getContext("2d");if(!j)return{error:"Cannot create temporary canvas"};j.drawImage(h,0,0),j.globalCompositeOperation="destination-in",j.drawImage(o,0,0);const U=M.toDataURL("image/png"),Y=document.createElement("canvas");Y.width=h.width,Y.height=h.height;const W=Y.getContext("2d");if(!W)return{error:"Cannot create background canvas"};W.drawImage(h,0,0),W.globalCompositeOperation="destination-out",W.drawImage(o,0,0),W.globalCompositeOperation="source-over";const J=Ye(W,h.width,h.height)||h.src,te=o.toDataURL("image/png");return{foregroundDataUrl:U,backgroundDataUrl:J,extractMaskDataUrl:te}}function Ue(f){var lt,ut,nt,ft,He;if(!t.extractMode.enabled||!o||!c)return;const h=t.layers.find(s=>s.id===c);if(!h)return;const M=_(h);if(!M)return;const j=v(h),U=t.project.width,Y=t.project.height,W=U/2,J=Y/2,te=M.width,we=M.height,ke=!!t.project.cam_enable,Ae=ke?((lt=t.interpolateProjectValue)==null?void 0:lt.call(t,"cam_pos_x",t.currentTime,t.project.cam_pos_x||0))??(t.project.cam_pos_x||0):0,ae=ke?((ut=t.interpolateProjectValue)==null?void 0:ut.call(t,"cam_pos_y",t.currentTime,t.project.cam_pos_y||0))??(t.project.cam_pos_y||0):0,_e=ke?((nt=t.interpolateProjectValue)==null?void 0:nt.call(t,"cam_pos_z",t.currentTime,t.project.cam_pos_z||0))??(t.project.cam_pos_z||0):0,Xe=((ft=t.interpolateProjectValue)==null?void 0:ft.call(t,"cam_offset_x",t.currentTime,t.project.cam_offset_x||0))??(t.project.cam_offset_x||0),Ve=((He=t.interpolateProjectValue)==null?void 0:He.call(t,"cam_offset_y",t.currentTime,t.project.cam_offset_y||0))??(t.project.cam_offset_y||0),Me=ke?Math.max(.2,Math.min(4,1/(1+_e*.001))):1,Ce=j.z||0,me=1/Math.max(.1,1+Ce*.001),ye=ke?me:1,We=ke?Me:1;let at=1;if(te>0&&we>0){const s=h.bg_mode||"fit";s==="fit"?at=Math.min(U/te,Y/we):s==="fill"?at=Math.max(U/te,Y/we):at=Math.min(U/te,Y/we)}const pt=((j.x??0)+(Xe+Ae)*ye)*We,dt=((j.y??0)+(Ve+ae)*ye)*We,ct=(j.scale??1)*at*We*me;f.save(),f.translate(W+pt,J+dt),f.rotate((j.rotation??0)*Math.PI/180),f.scale(ct,ct),f.fillStyle="rgba(0, 0, 0, 0.65)",f.fillRect(-te/2,-we/2,te,we),f.globalCompositeOperation="destination-out",f.drawImage(o,-te/2,-we/2,te,we),f.restore()}function Oe(f,h){const M=t.currentLayer;if(!M)return;M.bezierPath||(M.bezierPath=[]);const j=se(f);if(j>=0)p=j,u=!0;else{const U=t.project.width/2,Y=t.project.height/2;M.bezierPath.push({x:f.x-U,y:f.y-Y}),M.bezierPath.length>=2&&(M.usePathAnimation=!0),l()}}function se(f){const h=t.currentLayer;if(!h||!h.bezierPath)return-1;const M=t.project.width/2,j=t.project.height/2,U=10;for(let Y=0;Y<h.bezierPath.length;Y++){const W=h.bezierPath[Y],J=W.x+M-f.x,te=W.y+j-f.y;if(Math.sqrt(J*J+te*te)<U)return Y}return-1}function ue(f){const h=t.currentLayer;if(!h||!h.bezierPath||p<0)return;const M=t.project.width/2,j=t.project.height/2;h.bezierPath[p].x=f.x-M,h.bezierPath[p].y=f.y-j,l()}return{onMouseDown:E,onMouseMove:K,onMouseUp:V,onWheel:R,onKeyDown:q,getCanvasCoords:b,clearExtractSelection:de,applyExtractSelection:$e,drawExtractOverlayOnCtx:Ue}}function va(t,n,e){const{x:l,y:v,z:_,rotationX:w,rotationY:I,rotationZ:X,scaleX:C,scaleY:B,scaleZ:z,anchorX:L,anchorY:G}=t,H=L*n,$=G*e,re=[];return re.push(`translate3d(${l-H}px, ${v-$}px, ${_}px)`),w!==0&&re.push(`rotateX(${w}deg)`),I!==0&&re.push(`rotateY(${I}deg)`),X!==0&&re.push(`rotateZ(${X}deg)`),(C!==1||B!==1||z!==1)&&re.push(`scale3d(${C}, ${B}, ${z})`),re.join(" ")}function ya(t,n){const e=(.5+t)*100,l=(.5+n)*100;return`${e}% ${l}%`}function ga(t,n){const e=Math.max(1,Math.min(179,t))*Math.PI/180;return n/(2*Math.tan(e/2))}function qt(t,n,e,l){const{cam_pos_x:v,cam_pos_y:_,cam_pos_z:w,cam_yaw:I,cam_pitch:X}=l,C=t-v,B=n-_,z=e-w,L=I*Math.PI/180,G=X*Math.PI/180,H=Math.cos(L),$=Math.sin(L),re=Math.cos(G),D=Math.sin(G),T=C*$+z*H;return B*D+T*re}function _a(t,n){return[...t].sort((e,l)=>{const v=qt(e.x,e.y,e.z,n);return qt(l.x,l.y,l.z,n)-v})}const ba={class:"canvas-wrapper"},xa=["src","alt"],wa=["width","height"],Pa=["width","height"],ka={class:"canvas-info"},Ma={key:0},ja={key:1},Ta={key:2,style:{color:"#ff9800","margin-left":"10px"}},Ca=wt({__name:"CanvasPreview",setup(t,{expose:n}){const e=Mt(),l=xe(),v=xe(),_=xe(),w=fa(e,l,v),{initContexts:I,scheduleRender:X,getCachedImage:C,getLayerProps:B,setDrawExtractOverlayOnCtx:z,cleanup:L}=w,G=he(()=>e.project.preview_mode==="3d-css"),H=he(()=>({x:Math.max(0,(e.project.width||0)/2),y:Math.max(0,(e.project.height||0)/2)})),$=he(()=>({cam_pos_x:e.project.cam_pos_x??0,cam_pos_y:e.project.cam_pos_y??0,cam_pos_z:e.project.cam_pos_z??1e3,cam_yaw:e.project.cam_yaw??0,cam_pitch:e.project.cam_pitch??0,cam_roll:e.project.cam_roll??0,cam_fov:e.project.cam_fov??90})),re=he(()=>{const Z=Math.max(1,e.project.height||1);return ga($.value.cam_fov,Z)}),D=he(()=>({width:`${e.project.width}px`,height:`${e.project.height}px`,perspective:`${Math.round(re.value)}px`,perspectiveOrigin:"50% 50%",transformStyle:"preserve-3d"})),T=he(()=>{const Z=[],S=$.value,o=e.project.cam_offset_x||0,m=e.project.cam_offset_y||0;Z.push(`translate3d(${H.value.x}px, ${H.value.y}px, 0px)`);const x=-(S.cam_pos_x+o),c=-(S.cam_pos_y+m),u=-(S.cam_pos_z||0);if(Z.push(`translate3d(${x}px, ${c}px, ${u}px)`),e.project.cam_enable){S.cam_pitch!==0&&Z.push(`rotateX(${-S.cam_pitch}deg)`),S.cam_yaw!==0&&Z.push(`rotateY(${-S.cam_yaw}deg)`),S.cam_roll!==0&&Z.push(`rotateZ(${-S.cam_roll}deg)`);const p=Math.max(.2,Math.min(4,1/(1+(S.cam_pos_z??1e3)*.001)));p!==1&&Z.push(`scale(${p})`)}return{transform:Z.join(" ")||void 0,transformStyle:"preserve-3d"}}),je=he(()=>{if(!G.value)return[];const Z=e.layers.map(m=>{const x=C(m);if(!x||!x.complete)return null;const c=Math.max(1,e.project.width||1),u=Math.max(1,e.project.height||1),p=B(m);let g=1;if(m.type==="background"&&x.width&&x.height){const ie=m.bg_mode||"fit";ie==="fit"?g=Math.min(c/x.width,u/x.height):ie==="fill"?g=Math.max(c/x.width,u/x.height):g=Math.min(c/x.width,u/x.height),(!Number.isFinite(g)||g<=0)&&(g=1)}const b=(m.scaleX??p.scale??1)*g,y=(m.scaleY??p.scale??1)*g,E=m.scaleZ??1,K=p.x,V=p.y,R=p.z||0,q=p.rotationZ!==void 0&&p.rotationZ!==0?p.rotationZ:p.rotation,ee=va({x:K,y:V,z:R,rotationX:p.rotationX||0,rotationY:p.rotationY||0,rotationZ:q||0,scaleX:b,scaleY:y,scaleZ:E,anchorX:m.anchorX??0,anchorY:m.anchorY??0,opacity:p.opacity??1},x.width,x.height);return{id:m.id,type:m.type,src:x.src||m.image_data,width:x.width,height:x.height,opacity:p.opacity??1,transform:ee,origin:ya(m.anchorX??0,m.anchorY??0),x:K,y:V,z:R}}).filter(Boolean),S={cam_pos_x:$.value.cam_pos_x,cam_pos_y:$.value.cam_pos_y,cam_pos_z:$.value.cam_pos_z,cam_yaw:$.value.cam_yaw,cam_pitch:$.value.cam_pitch,cam_roll:$.value.cam_roll,cam_fov:$.value.cam_fov};return _a(Z,S)}),Fe=he(()=>{const Z=$.value,S=[];return S.push("translate3d(0, 0, 0)"),Z.cam_pitch&&S.push(`rotateX(${-Z.cam_pitch}deg)`),Z.cam_yaw&&S.push(`rotateY(${-Z.cam_yaw}deg)`),Z.cam_roll&&S.push(`rotateZ(${-Z.cam_roll}deg)`),S.push("scale(0.6)"),{transform:S.join(" ")||void 0}}),Re=ha(e,l,v,X,B,C),{onMouseDown:Le,onMouseMove:Ie,onMouseUp:ge,onWheel:ze,onKeyDown:Pe,clearExtractSelection:ce,applyExtractSelection:Be,drawExtractOverlayOnCtx:Ee}=Re;z(Ee),Pt(()=>{I(),X()}),na(()=>{L()});const Te=()=>{G.value||X()};return mt(()=>[e.layers,e.currentLayer,e.currentTime],()=>{Te()},{deep:!0}),mt(()=>e.project,()=>{Te()},{deep:!0}),mt(()=>[e.project.cam_enable,e.project.cam_pos_x,e.project.cam_pos_y,e.project.cam_pos_z,e.project.cam_offset_x,e.project.cam_offset_y,e.project.cam_yaw,e.project.cam_pitch,e.project.cam_roll,e.project.cam_fov,e.project.pano_enable],()=>{Te()}),mt(()=>e.extractMode.enabled,()=>{Te()}),mt(()=>[e.maskMode.enabled,e.pathMode.enabled],()=>{Te()}),mt(G,Z=>{Z||X()}),n({clearExtractSelection:ce,applyExtractSelection:Be}),(Z,S)=>(oe(),ne("div",{class:"canvas-preview",ref_key:"containerRef",ref:_},[r("div",ba,[G.value?(oe(),ne("div",{key:0,class:"css-preview",style:Ze(D.value)},[r("div",{class:"css-camera",style:Ze(T.value)},[(oe(!0),ne(tt,null,it(je.value,(o,m)=>(oe(),ne("div",{key:o.id,class:"css-layer",style:Ze({width:o.width+"px",height:o.height+"px",opacity:o.opacity,transform:o.transform,transformOrigin:o.origin,zIndex:m})},[r("img",{src:o.src,alt:o.id,draggable:"false"},null,8,xa)],4))),128))],4),r("div",{class:"axis-widget",style:Ze(Fe.value)},[...S[7]||(S[7]=[oa('<div class="axis axis-x" data-v-49eaa238></div><div class="axis axis-y" data-v-49eaa238></div><div class="axis axis-z" data-v-49eaa238></div><div class="axis-label axis-label-x" data-v-49eaa238>X</div><div class="axis-label axis-label-y" data-v-49eaa238>Y</div><div class="axis-label axis-label-z" data-v-49eaa238>Z</div>',6)])],4)],4)):ot("",!0),r("canvas",{ref_key:"canvasRef",ref:l,width:k(e).project.width,height:k(e).project.height,class:De(["render-canvas",{"css-mode-hidden":G.value}])},null,10,wa),r("canvas",{ref_key:"interactionCanvasRef",ref:v,width:k(e).project.width,height:k(e).project.height,class:De(["interaction-canvas",{"css-mode":G.value}]),onMousedown:S[0]||(S[0]=(...o)=>k(Le)&&k(Le)(...o)),onMousemove:S[1]||(S[1]=(...o)=>k(Ie)&&k(Ie)(...o)),onMouseup:S[2]||(S[2]=(...o)=>k(ge)&&k(ge)(...o)),onMouseleave:S[3]||(S[3]=(...o)=>k(ge)&&k(ge)(...o)),onWheel:S[4]||(S[4]=qe((...o)=>k(ze)&&k(ze)(...o),["prevent"])),onContextmenu:S[5]||(S[5]=qe(()=>{},["prevent"])),tabindex:"0",onKeydown:S[6]||(S[6]=(...o)=>k(Pe)&&k(Pe)(...o))},null,42,Pa),r("div",ka,[k(e).currentLayer?(oe(),ne("span",Ma," Layer "+fe(k(e).currentLayerIndex+1)+" | X:"+fe(Math.round(k(e).currentLayer.x||0))+" Y:"+fe(Math.round(k(e).currentLayer.y||0))+" S:"+fe((k(e).currentLayer.scale||1).toFixed(2))+" R:"+fe(Math.round(k(e).currentLayer.rotation||0))+"° ",1)):(oe(),ne("span",ja,"No layer selected")),k(e).project.cam_enable?(oe(),ne("span",Ta," 📷 3D Camera (Preview Approximation) ")):ot("",!0)])])],512))}}),Sa=kt(Ca,[["__scopeId","data-v-49eaa238"]]),La={class:"project-settings"},za={class:"setting-row"},Fa=["value"],Ia={class:"setting-row"},Ea=["value"],Ya={class:"setting-row"},Ua=["value"],Xa={class:"setting-row"},Ra=["value"],Aa={class:"setting-row"},Da=["checked"],Ba={key:0,class:"setting-note"},$a={class:"setting-row"},Oa=["checked"],Va={class:"setting-row"},Ga=["value"],Ka={class:"setting-row"},Za=["value"],Wa={class:"setting-row"},Na=["value"],qa={class:"setting-row"},Ha=["value"],Ja={class:"setting-row"},Qa=["value"],en={class:"setting-row"},tn=["value"],an={class:"setting-row"},nn=["value"],on={class:"setting-row"},rn=["value"],sn=wt({__name:"ProjectSettings",setup(t){const n=Mt(),e=xe(!1);Pt(()=>{e.value=localStorage.getItem("timeline_disable_gpu")==="true"});function l(D){D.target.checked?(localStorage.removeItem("timeline_disable_gpu"),e.value=!1):(localStorage.setItem("timeline_disable_gpu","true"),e.value=!0),alert("GPU设置已更改，请刷新页面以应用更改。")}function v(D){n.setProject({width:parseInt(D.target.value)||1280})}function _(D){n.setProject({height:parseInt(D.target.value)||720})}function w(D){n.setProject({fps:parseInt(D.target.value)||30})}function I(D){n.setProject({total_frames:parseInt(D.target.value)||150})}function X(D){n.setProject({cam_enable:D.target.checked})}function C(D){n.setProject({cam_pos_x:parseFloat(D.target.value)||0})}function B(D){n.setProject({cam_pos_y:parseFloat(D.target.value)||0})}function z(D){n.setProject({cam_pos_z:parseFloat(D.target.value)||0})}function L(D){n.setProject({cam_yaw:parseFloat(D.target.value)||0})}function G(D){n.setProject({cam_pitch:parseFloat(D.target.value)||0})}function H(D){n.setProject({cam_roll:parseFloat(D.target.value)||0})}function $(D){n.setProject({cam_fov:parseFloat(D.target.value)||90})}function re(D){const T=D.target.value;n.setProject({preview_mode:T})}return(D,T)=>(oe(),ne("div",La,[T[21]||(T[21]=r("div",{class:"section-title"},"📐 项目",-1)),r("div",za,[T[0]||(T[0]=r("label",null,"宽度",-1)),r("input",{type:"number",value:k(n).project.width,onInput:v,min:"64",max:"8192"},null,40,Fa)]),r("div",Ia,[T[1]||(T[1]=r("label",null,"高度",-1)),r("input",{type:"number",value:k(n).project.height,onInput:_,min:"64",max:"8192"},null,40,Ea)]),r("div",Ya,[T[2]||(T[2]=r("label",null,"帧率",-1)),r("input",{type:"number",value:k(n).project.fps,onInput:w,min:"1",max:"120"},null,40,Ua)]),r("div",Xa,[T[3]||(T[3]=r("label",null,"帧数",-1)),r("input",{type:"number",value:k(n).project.total_frames,onInput:I,min:"1",max:"9999"},null,40,Ra)]),T[22]||(T[22]=r("div",{class:"section-title"},"🖥️ 预览渲染",-1)),r("div",Aa,[T[4]||(T[4]=r("label",null,"GPU加速",-1)),r("input",{type:"checkbox",checked:!e.value,onChange:l},null,40,Da)]),e.value?(oe(),ne("div",Ba,[...T[5]||(T[5]=[r("small",{style:{color:"#f90","font-size":"10px"}}," ⚠️ 已禁用GPU，使用Canvas 2D渲染 ",-1)])])):ot("",!0),T[23]||(T[23]=r("div",{class:"section-title"},"🎥 3D 摄像机",-1)),r("div",$a,[T[6]||(T[6]=r("label",null,"启用",-1)),r("input",{type:"checkbox",checked:k(n).project.cam_enable,onChange:X},null,40,Oa)]),k(n).project.cam_enable?(oe(),ne(tt,{key:1},[T[16]||(T[16]=r("div",{class:"subsection-title"},"位置",-1)),r("div",Va,[T[7]||(T[7]=r("label",null,"X",-1)),r("input",{type:"number",value:k(n).project.cam_pos_x,onInput:C,step:"10"},null,40,Ga)]),r("div",Ka,[T[8]||(T[8]=r("label",null,"Y",-1)),r("input",{type:"number",value:k(n).project.cam_pos_y,onInput:B,step:"10"},null,40,Za)]),r("div",Wa,[T[9]||(T[9]=r("label",null,"Z (距离)",-1)),r("input",{type:"number",value:k(n).project.cam_pos_z,onInput:z,step:"50"},null,40,Na)]),T[17]||(T[17]=r("div",{class:"subsection-title"},"旋转",-1)),r("div",qa,[T[10]||(T[10]=r("label",null,"Yaw (Y轴)",-1)),r("input",{type:"number",value:k(n).project.cam_yaw,onInput:L,step:"5"},null,40,Ha)]),r("div",Ja,[T[11]||(T[11]=r("label",null,"Pitch (X轴)",-1)),r("input",{type:"number",value:k(n).project.cam_pitch,onInput:G,step:"5"},null,40,Qa)]),r("div",en,[T[12]||(T[12]=r("label",null,"Roll (Z轴)",-1)),r("input",{type:"number",value:k(n).project.cam_roll,onInput:H,step:"5"},null,40,tn)]),T[18]||(T[18]=r("div",{class:"subsection-title"},"投影",-1)),r("div",an,[T[13]||(T[13]=r("label",null,"FOV",-1)),r("input",{type:"number",value:k(n).project.cam_fov,onInput:$,min:"1",max:"179",step:"5"},null,40,nn)]),T[19]||(T[19]=r("div",{class:"subsection-title"},"预览模式",-1)),r("div",on,[T[15]||(T[15]=r("label",null,"模式",-1)),r("select",{value:k(n).project.preview_mode||"2d",onChange:re,style:{width:"80px",padding:"4px",background:"#1a1a1a",border:"1px solid #444","border-radius":"3px",color:"#fff","font-size":"11px"}},[...T[14]||(T[14]=[r("option",{value:"2d"},"2D 近似",-1),r("option",{value:"3d-css"},"3D CSS (实验性)",-1)])],40,rn)]),T[20]||(T[20]=r("div",{class:"setting-note"},[r("small",{style:{color:"#666","font-size":"10px","line-height":"1.4"}},[Ot(" ⚠️ 预览仅为近似效果"),r("br"),Ot(" 最终渲染使用完整3D透视 ")])],-1))],64)):ot("",!0)]))}}),cn=kt(sn,[["__scopeId","data-v-dd7a8f2f"]]),ln={class:"ae-timeline-root"},un={class:"ae-header"},mn={class:"header-center"},pn={class:"project-info"},dn={class:"header-right"},fn={class:"project-inputs"},hn={class:"project-field"},vn=["value"],yn={class:"project-field"},gn=["value"],_n={class:"project-field"},bn=["value"],xn={class:"project-field"},wn=["value"],Pn={class:"project-field pano-field"},kn={class:"hdr-toggle"},Mn={class:"hdr-toggle cam-enable"},jn={class:"cam-row"},Tn=["value"],Cn=["value"],Sn=["value"],Ln=["value"],zn={class:"cam-row cam-row-3d"},Fn=["value"],In=["value"],En=["value"],Yn={class:"ae-main"},Un={class:"ae-inspector"},Xn={key:0,class:"inspector-card"},Rn={class:"card-header"},An={class:"layer-title"},Dn={class:"card-subtitle"},Bn={key:1,class:"inspector-card empty"},$n={key:2,class:"inspector-section"},On={class:"property-list"},Vn={class:"property-row"},Gn=["value"],Kn={class:"property-row"},Zn=["value"],Wn={class:"property-row"},Nn=["value"],qn={class:"property-row"},Hn=["value"],Jn={class:"property-row"},Qn=["value"],eo={class:"property-row"},to=["value"],ao={class:"property-row"},no=["value"],oo={class:"property-row slider-row"},ro={class:"slider-header"},io={class:"prop-value"},so=["value"],co={class:"inspector-section"},lo={class:"tools-grid"},uo=["disabled"],mo={key:0,class:"tool-settings"},po={class:"slider-header"},fo={class:"prop-value"},ho={key:1,class:"tool-settings"},vo={class:"slider-header"},yo={class:"prop-value"},go={class:"inspector-section"},_o={class:"inspector-section"},bo={class:"fit-row"},xo={class:"ae-viewport"},wo={class:"viewport-bar"},Po={class:"duration-text"},ko={class:"viewport-actions"},Mo={class:"time-text"},jo={class:"zoom-control"},To={class:"prop-value"},Co={class:"viewport-canvas"},So={class:"ae-timeline"},Lo={class:"timeline-controls"},zo={class:"controls-left"},Fo=["disabled"],Io=["disabled"],Eo={class:"controls-center"},Yo={class:"time-display"},Uo={class:"playback-btns"},Xo={class:"timeline-body"},Ro={class:"layers-panel"},Ao={class:"layers-header"},Do=["onClick"],Bo=["onClick"],$o={class:"layer-name"},Oo={class:"layer-btns"},Vo=["onClick"],Go=["onClick"],Ko={class:"tick-text"},Zo=["title","onMousedown","onContextmenu"],Wo=["onClick"],No=["onClick"],qo=["onDblclick"],Ho=["title","onMousedown","onClick","onContextmenu"],yt=80,Jo=wt({__name:"TimelineApp",props:{node:{}},setup(t){const n=t,e=Mt(),l=xe(null),v=xe(),_=xe(),w=xe(),I=xe(0);let X="foreground",C=!1,B=null;const z=s=>{var a,i;return(i=(a=n.node)==null?void 0:a.widgets)==null?void 0:i.find(d=>d.name===s)};function L(s,a){const i=typeof s=="number"?s:parseFloat(s);return Number.isFinite(i)?i:a}const G=xe("fit"),H=xe(100),$=he(()=>Math.max(.1,H.value/100)),re=he({get:()=>!!e.project.cam_enable,set:s=>{e.setProject({cam_enable:s}),j("cam_enable",s?1:0)}}),D=he({get:()=>e.project.pano_enable,set:s=>{e.setProject({pano_enable:s}),j("pano_enable",s?1:0)}}),T=he({get:()=>e.project.cam_yaw,set:s=>{const a=Number.isFinite(s)?s:e.project.cam_yaw;e.setProject({cam_yaw:a}),j("cam_yaw",a)}}),je=he({get:()=>e.project.cam_pitch,set:s=>{const a=Number.isFinite(s)?s:e.project.cam_pitch;e.setProject({cam_pitch:a}),j("cam_pitch",a)}}),Fe=he({get:()=>e.project.cam_roll,set:s=>{const a=Number.isFinite(s)?s:e.project.cam_roll;e.setProject({cam_roll:a}),j("cam_roll",a)}}),Re=he({get:()=>e.project.cam_fov,set:s=>{const a=Number.isFinite(s)?s:e.project.cam_fov,i=Math.min(170,Math.max(10,a));e.setProject({cam_fov:i}),j("cam_fov",i)}}),Le=he({get:()=>e.project.cam_pos_x||0,set:s=>{const a=Number.isFinite(s)?s:e.project.cam_pos_x||0;e.setProject({cam_pos_x:a}),j("cam_pos_x",a)}}),Ie=he({get:()=>e.project.cam_pos_y||0,set:s=>{const a=Number.isFinite(s)?s:e.project.cam_pos_y||0;e.setProject({cam_pos_y:a}),j("cam_pos_y",a)}}),ge=he({get:()=>e.project.cam_pos_z||0,set:s=>{const a=Number.isFinite(s)?s:e.project.cam_pos_z||0;e.setProject({cam_pos_z:a}),j("cam_pos_z",a)}});function ze(s){var a;if(s.code==="Space"){const i=(a=s.target)==null?void 0:a.tagName;if(i==="INPUT"||i==="TEXTAREA"||i==="SELECT")return;s.preventDefault(),s.stopPropagation(),e.togglePlayback()}}const Pe=he(()=>{const s=Math.max(1,e.project.fps||1);return e.project.duration||e.project.total_frames/s||0}),ce=he(()=>{var d;const s=Math.max(.001,Pe.value||0),a=I.value||((d=w.value)==null?void 0:d.clientWidth)||0,i=a?a/s:yt;return Math.max(yt,i)}),Be=he(()=>{var P;const i=Pe.value*ce.value+120,d=I.value||((P=w.value)==null?void 0:P.clientWidth)||0;return Math.max(i,d,800)});mt(()=>e.extractMode.enabled,s=>{var a,i;s||(i=(a=l.value)==null?void 0:a.clearExtractSelection)==null||i.call(a)});function Ee(){var P;if(!w.value){setTimeout(Ee,100);return}const s=w.value.getBoundingClientRect(),a=((P=w.value.parentElement)==null?void 0:P.clientWidth)||s.width||0,i=typeof window<"u"?window.innerWidth:a,d=Math.max(a||i,800);d>0&&(I.value=d)}Pt(()=>{se(),Ee(),typeof ResizeObserver<"u"&&w.value?(B=new ResizeObserver(s=>{const a=s[0];a!=null&&a.contentRect&&(I.value=a.contentRect.width)}),B.observe(w.value)):window.addEventListener("resize",Ee),window.addEventListener("keydown",ze,{capture:!0}),window.addEventListener("beforeunload",dt,{capture:!0})});let Te=!1,Z=null;const S=xe(new Set([0])),o=xe(null),m=[{key:"x",label:"X"},{key:"y",label:"Y"},{key:"z",label:"Z"},{key:"scale",label:"Scl"},{key:"rotation",label:"RotZ"},{key:"rotationX",label:"RotX"},{key:"rotationY",label:"RotY"},{key:"opacity",label:"Op"}],x=[{key:"cam_yaw",label:"Yaw"},{key:"cam_pitch",label:"Pitch"},{key:"cam_roll",label:"Roll"},{key:"cam_fov",label:"FOV"},{key:"cam_offset_x",label:"OffX"},{key:"cam_offset_y",label:"OffY"},{key:"cam_pos_x",label:"PosX"},{key:"cam_pos_y",label:"PosY"},{key:"cam_pos_z",label:"PosZ"}],c=he(()=>{const s=e.currentLayer;if(!s)return{x:0,y:0,z:0,scale:1,rotation:0,rotationX:0,rotationY:0,rotationZ:0,opacity:1};const a=e.currentTime,i=s.keyframes||{};return{x:u(i.x,a,s.x||0),y:u(i.y,a,s.y||0),z:u(i.z,a,s.z||0),scale:u(i.scale,a,s.scale||1),rotation:u(i.rotation,a,s.rotation||0),rotationX:u(i.rotationX,a,s.rotationX||0),rotationY:u(i.rotationY,a,s.rotationY||0),rotationZ:u(i.rotationZ,a,s.rotationZ||s.rotation||0),opacity:u(i.opacity,a,s.opacity??1)}});function u(s,a,i){if(!s||s.length===0)return i;const d=[...s].sort((P,F)=>P.time-F.time);if(a<=d[0].time)return d[0].value;if(a>=d[d.length-1].time)return d[d.length-1].value;for(let P=0;P<d.length-1;P++)if(a>=d[P].time&&a<=d[P+1].time){const F=(a-d[P].time)/(d[P+1].time-d[P].time);return d[P].value+(d[P+1].value-d[P].value)*F}return i}function p(s,a){const i=e.currentLayer;if(!i)return;const d=parseFloat(a.target.value);if(isNaN(d))return;const P=e.currentTime;if(i.keyframes&&i.keyframes[s]&&i.keyframes[s].length>0){const F=i.keyframes[s].findIndex(A=>Math.abs(A.time-P)<.05);F>=0?i.keyframes[s][F]={time:i.keyframes[s][F].time,value:d}:(i.keyframes[s].push({time:P,value:d}),i.keyframes[s].sort((A,Q)=>A.time-Q.time))}e.updateLayer(e.currentLayerIndex,{[s]:d})}function g(s){const a=e.currentLayer;if(!a)return;const i=parseFloat(s.target.value);if(isNaN(i))return;const d=i/100,P=e.currentTime;if(a.keyframes&&a.keyframes.scale&&a.keyframes.scale.length>0){const F=a.keyframes.scale.findIndex(A=>Math.abs(A.time-P)<.05);F>=0?a.keyframes.scale[F]={time:a.keyframes.scale[F].time,value:d}:(a.keyframes.scale.push({time:P,value:d}),a.keyframes.scale.sort((A,Q)=>A.time-Q.time))}e.updateLayer(e.currentLayerIndex,{scale:d})}function b(s){const a=Math.floor(s/60),i=Math.floor(s%60),d=Math.floor(s%1*e.project.fps);return`${a.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}:${d.toString().padStart(2,"0")}`}function y(s,a){return!s.keyframes||!s.keyframes[a]?[]:s.keyframes[a].map(i=>({time:i.time,value:i.value}))}function E(s){const a=[];if(!s.keyframes)return a;for(const i of m){const d=s.keyframes[i.key];d&&d.forEach(P=>a.push({time:P.time,prop:i.key}))}return a}function K(){var i;const s=[],a=((i=e.projectKeyframes)==null?void 0:i.value)||e.projectKeyframes||{};return x.forEach(d=>{const P=a[d.key];Array.isArray(P)&&P.forEach(F=>{typeof(F==null?void 0:F.time)=="number"&&s.push({time:F.time,prop:d.key,value:F.value??0})})}),s}function V(s,a){return a==="opacity"||a==="scale"?(s*100).toFixed(0)+"%":s.toFixed(1)}function R(s){S.value.has(s)?S.value.delete(s):S.value.add(s)}function q(s){var a,i;s.hidden=!s.hidden,(i=(a=l.value)==null?void 0:a.scheduleRender)==null||i.call(a)}function ee(s){if(!w.value)return 0;const a=w.value.querySelector(".tracks-content");if(!a)return 0;const i=a.getBoundingClientRect(),d=w.value.scrollLeft,P=s.clientX-i.left+d,F=ce.value||yt;if(P<=10)return 0;const A=P/F;return Math.max(0,Math.min(A,Pe.value))}function ie(s){s.preventDefault(),C=!0,e.setCurrentTime(ee(s));const a=d=>{C&&e.setCurrentTime(ee(d))},i=()=>{C=!1,document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",i)}function le(s){if(!e.currentLayer)return;const a=ee(s);e.setCurrentTime(a),e.addKeyframe()}function pe(s,a,i){const P=s.currentTarget.getBoundingClientRect(),F=s.clientX-P.left,A=ce.value||yt,Q=Math.max(0,F/A),O=e.layers[a];if(!O)return;const Se=O[i]??(i==="scale"||i==="opacity"?1:0);O.keyframes||(O.keyframes={}),O.keyframes[i]||(O.keyframes[i]=[]),O.keyframes[i].find(Ge=>Math.abs(Ge.time-Q)<.05)||(O.keyframes[i].push({time:Q,value:Se}),O.keyframes[i].sort((Ge,Ke)=>Ge.time-Ke.time))}function de(s,a,i){o.value={layerIdx:s,prop:a,time:i},e.selectLayer(s),e.setCurrentTime(i)}function ve(s,a,i){const d=o.value;return d?d.layerIdx===s&&d.prop===a&&Math.abs(d.time-i)<.01:!1}function Ye(s,a,i,d){s.preventDefault(),Te=!0,Z={layerIdx:a,prop:i,originalTime:d.time},de(a,i,d.time);const P=s.clientX,F=d.time,A=ce.value||yt,Q=Se=>{var et;if(!Te||!Z)return;const Ge=(Se.clientX-P)/A;let Ke=Math.max(0,F+Ge);const Qe=e.layers[Z.layerIdx];if((et=Qe==null?void 0:Qe.keyframes)!=null&&et[Z.prop]){const rt=Qe.keyframes[Z.prop],vt=rt.findIndex(_t=>Math.abs(_t.time-Z.originalTime)<.01);vt>=0&&(rt[vt].time=Ke,Z.originalTime=Ke,o.value.time=Ke,e.setCurrentTime(Ke))}},O=()=>{var Je;Te=!1,Z=null,document.removeEventListener("mousemove",Q),document.removeEventListener("mouseup",O);const Se=e.layers[a];(Je=Se==null?void 0:Se.keyframes)!=null&&Je[i]&&Se.keyframes[i].sort((Ge,Ke)=>Ge.time-Ke.time)};document.addEventListener("mousemove",Q),document.addEventListener("mouseup",O)}function $e(s,a,i){var P,F,A,Q;const d=e.layers[s];(P=d==null?void 0:d.keyframes)!=null&&P[a]&&(d.keyframes[a]=d.keyframes[a].filter(O=>Math.abs(O.time-i)>.01),((F=o.value)==null?void 0:F.layerIdx)===s&&((A=o.value)==null?void 0:A.prop)===a&&Math.abs(((Q=o.value)==null?void 0:Q.time)-i)<.01&&(o.value=null))}function Ue(s){if(w.value){const a=s.target,i=w.value.querySelector(".tracks-list");i&&(i.scrollTop=a.scrollTop)}}function Oe(s){const a=s.target,i=document.querySelector(".layers-list");i&&(i.scrollTop=a.scrollTop)}function se(){var jt,Tt,Ct,St,Lt,zt,Ft,It,Et,Yt,Ut,Xt,Rt,At,Dt,Bt;if(!((jt=n.node)!=null&&jt.widgets))return;const s=L((Tt=z("width"))==null?void 0:Tt.value,e.project.width),a=L((Ct=z("height"))==null?void 0:Ct.value,e.project.height),i=Math.max(1,L((St=z("fps"))==null?void 0:St.value,e.project.fps)),d=Math.max(1,Math.round(L((Lt=z("total_frames"))==null?void 0:Lt.value,e.project.total_frames))),P=L((zt=z("mask_expansion"))==null?void 0:zt.value,e.project.mask_expansion),F=L((Ft=z("mask_feather"))==null?void 0:Ft.value,e.project.mask_feather),A=!!L((It=z("pano_enable"))==null?void 0:It.value,e.project.pano_enable?1:0),Q=L((Et=z("cam_yaw"))==null?void 0:Et.value,e.project.cam_yaw),O=L((Yt=z("cam_pitch"))==null?void 0:Yt.value,e.project.cam_pitch),Se=L((Ut=z("cam_roll"))==null?void 0:Ut.value,e.project.cam_roll),Je=L((Xt=z("cam_fov"))==null?void 0:Xt.value,e.project.cam_fov),Ge=L((Rt=z("cam_pos_x"))==null?void 0:Rt.value,e.project.cam_pos_x||0),Ke=L((At=z("cam_pos_y"))==null?void 0:At.value,e.project.cam_pos_y||0),Qe=L((Dt=z("cam_pos_z"))==null?void 0:Dt.value,e.project.cam_pos_z||0);let et=[];const rt=(Bt=z("layers_keyframes"))==null?void 0:Bt.value;let vt={};if(typeof rt=="string"&&rt.trim())try{const Ne=JSON.parse(rt);Array.isArray(Ne)?et=Ne:Ne&&typeof Ne=="object"&&(Array.isArray(Ne.layers)&&(et=Ne.layers),Ne.project_keyframes&&typeof Ne.project_keyframes=="object"&&(vt=Ne.project_keyframes))}catch(Ne){console.warn("[AE Timeline] Failed to parse layers_keyframes widget",Ne)}else Array.isArray(rt)&&(et=rt);const _t={width:s,height:a,fps:i,total_frames:d,duration:d/i,mask_expansion:P,mask_feather:F,pano_enable:A,cam_yaw:Q,cam_pitch:O,cam_roll:Se,cam_fov:Je,cam_pos_x:Ge,cam_pos_y:Ke,cam_pos_z:Qe};e.loadAnimation({project:_t,layers:et}),e.projectKeyframes.value=vt,e.layers.length>0&&e.currentLayerIndex<0&&e.selectLayer(0)}function ue(s,a){return s.name?s.name:s.type==="background"?"Background":`Layer ${a+1}`}function f(){const s=e.exportAnimation(),a=new Blob([JSON.stringify(s,null,2)],{type:"application/json"}),i=URL.createObjectURL(a),d=document.createElement("a");d.href=i,d.download=`ae_project_${Date.now()}.json`,d.click(),URL.revokeObjectURL(i)}function h(){var s;(s=_.value)==null||s.click()}function M(s){var d;const a=(d=s.target.files)==null?void 0:d[0];if(!a)return;const i=new FileReader;i.onload=P=>{var F;try{const A=JSON.parse((F=P.target)==null?void 0:F.result);e.loadAnimation(A),console.log("Project loaded successfully")}catch(A){console.error("Failed to parse project file",A),alert("Project file is corrupted or has invalid format")}},i.readAsText(a),_.value&&(_.value.value="")}function j(s,a){const d=(P=>{var F,A;return(A=(F=n.node)==null?void 0:F.widgets)==null?void 0:A.find(Q=>Q.name===P)})(s);d&&(d.value=a,d.inputEl&&(d.inputEl.value=a,d.inputEl.dispatchEvent(new Event("input"))),d.callback&&d.callback(a))}function U(s,a){const i=parseInt(a.target.value,10);if(Number.isNaN(i))return;let d=i;s==="fps"&&(d=Math.max(1,d)),s==="total_frames"&&(d=Math.max(1,d)),(s==="width"||s==="height")&&(d=Math.max(16,d)),e.setProject({[s]:d}),j(s,d),e.setCurrentTime(e.currentTime)}function Y(){var d,P,F,A,Q;if(!((d=n.node)!=null&&d.widgets)){console.error("[AE Timeline] Node or widgets not found!");return}console.log("[AE Timeline] Saving..."),e.layers.forEach(O=>{O.maskCanvas&&(O.customMask=O.maskCanvas.toDataURL(),console.log(`[AE Timeline] Layer ${O.id}: Saved mask (len=${O.customMask.length})`))});const s=e.exportAnimation();s.layers.forEach(O=>{O.bezierPath&&O.bezierPath.length>0&&console.log(`[AE Timeline] Layer ${O.id}: Exporting Path with ${O.bezierPath.length} points`)});const i=(O=>n.node.widgets.find(Se=>Se.name===O))("layers_keyframes");if(i){const O=JSON.stringify({layers:s.layers,project_keyframes:e.projectKeyframes,project:s.project});if(i.value=O,console.log(`[AE Timeline] Saved layers_keyframes (len=${O.length})`),i.inputEl&&(i.inputEl.value=O,i.inputEl.dispatchEvent(new Event("input"))),i.callback&&i.callback(O),n.node.widgets_values){const Se=n.node.widgets.indexOf(i);Se>=0&&(n.node.widgets_values[Se]=O)}(F=(P=n.node).setDirtyCanvas)==null||F.call(P,!0,!1)}else console.error("[AE Timeline] Widget layers_keyframes not found!");j("width",e.project.width),j("height",e.project.height),j("fps",e.project.fps),j("total_frames",e.project.total_frames),j("pano_enable",e.project.pano_enable?1:0),j("cam_yaw",e.project.cam_yaw),j("cam_pitch",e.project.cam_pitch),j("cam_roll",e.project.cam_roll),j("cam_fov",e.project.cam_fov),j("cam_pos_x",e.project.cam_pos_x||0),j("cam_pos_y",e.project.cam_pos_y||0),j("cam_pos_z",e.project.cam_pos_z||0),j("cam_pos_x",e.project.cam_pos_x||0),j("cam_pos_y",e.project.cam_pos_y||0),j("cam_pos_z",e.project.cam_pos_z||0),(Q=(A=n.node).setDirtyCanvas)==null||Q.call(A,!0,!1)}function W(){Y();const s=document.querySelector(".ae-timeline-dialog");s&&s.close()}function J(){e.addKeyframe()}function te(){e.deleteKeyframe()}function we(){e.setCurrentTime(0)}function ke(){e.setCurrentTime(Pe.value)}function Ae(){const s=e.currentTime,a=e.project,i=e.setProjectKeyframe;i&&x.forEach(d=>{const P=a[d.key]??0;i(d.key,s,P)})}function ae(){const s=e.currentTime,a=e.deleteProjectKeyframe;a&&x.forEach(i=>a(i.key,s))}function _e(s,a){var i;(i=e.deleteProjectKeyframe)==null||i.call(e,s,a)}function Xe(s,a){const i=s.clientX,d=a.time,P=A=>{var Ge;const O=(A.clientX-i)/ce.value,Se=Math.max(0,d+O),Je=a.value??e.project[a.prop]??0;(Ge=e.setProjectKeyframe)==null||Ge.call(e,a.prop,Se,Je)},F=()=>{window.removeEventListener("mousemove",P),window.removeEventListener("mouseup",F)};window.addEventListener("mousemove",P),window.addEventListener("mouseup",F)}function Ve(){}function Me(){var s;e.currentLayer&&confirm("Clear all keyframes on this layer?")&&((s=e.clearAllKeyframes)==null||s.call(e))}function Ce(){e.layers.forEach((s,a)=>{a!==e.currentLayerIndex&&(s._cachedImage&&delete s._cachedImage,console.log(`[AE Timeline] Cleared cache for layer ${s.id}`))})}function me(){var s,a;(a=(s=l.value)==null?void 0:s.scheduleRender)==null||a.call(s),console.log("[AE Timeline] Preview refreshed")}function ye(){var s,a;n.node&&n.node.graph&&window.app&&((a=(s=window.app).queuePrompt)==null||a.call(s,0))}function We(s){var P,F;const a={mask:e.maskMode,path:e.pathMode,extract:e.extractMode},i=a[s],d=!i.enabled;if(s==="extract"&&d&&!e.layers.find(Q=>Q.type==="background")){alert("Add a background layer before using extract");return}Object.entries(a).forEach(([A,Q])=>{A!==s&&(Q.enabled=!1)}),(!d||s!=="extract")&&((F=(P=l.value)==null?void 0:P.clearExtractSelection)==null||F.call(P)),i.enabled=d}function at(){var s,a;(a=(s=l.value)==null?void 0:s.clearExtractSelection)==null||a.call(s)}function pt(){var P,F;const s=l.value;if(!s||typeof s.applyExtractSelection!="function")return;const a=s.applyExtractSelection();if(!a){alert("Draw an extract selection first");return}if("error"in a){alert(a.error);return}const i=new Image;i.onload=()=>{const A=e.layers.filter(Q=>{var O;return(O=Q.id)==null?void 0:O.startsWith("extracted_")}).length;e.addLayer({id:`extracted_${Date.now()}`,name:`Extract ${A+1}`,type:"foreground",image_data:a.foregroundDataUrl,img:i,x:0,y:0,scale:1,rotation:0,opacity:1,mask_size:0,keyframes:{}})},i.src=a.foregroundDataUrl;const d=e.layers.find(A=>A.type==="background");if(d&&a.backgroundDataUrl){const A=new Image;A.onload=()=>{d.image_data=a.backgroundDataUrl,d.img=A,e.updateLayer(e.layers.indexOf(d),{image_data:a.backgroundDataUrl})},A.src=a.backgroundDataUrl}e.extractMode.enabled=!1,(F=(P=l.value)==null?void 0:P.clearExtractSelection)==null||F.call(P)}function dt(){try{Y()}catch(s){console.warn("[AE Timeline] autosave failed",s)}}function ct(){var s;X="foreground",(s=v.value)==null||s.click()}function lt(){var s;X="background",(s=v.value)==null||s.click()}function ut(s){const a=s.target.files;a&&(Array.from(a).forEach((i,d)=>{const P=new FileReader;P.onload=F=>{var O;const A=(O=F.target)==null?void 0:O.result,Q=new Image;Q.onload=()=>{e.addLayer({id:"uploaded_"+Date.now()+"_"+d,name:i.name.replace(/\.[^/.]+$/,""),type:X,image_data:A,img:Q,x:0,y:0,scale:1,rotation:0,opacity:1,mask_size:0,keyframes:{},bg_mode:"fit"})},Q.src=A},P.readAsDataURL(i)}),v.value&&(v.value.value=""))}function nt(){He(-1)}function ft(){He(1)}function He(s){const a=e.currentLayerIndex;if(a<0)return;const i=a+s;if(i>=0&&i<e.layers.length){const d=e.layers[a];e.layers.splice(a,1),e.layers.splice(i,0,d),e.selectLayer(i)}}return ra(()=>{B&&w.value&&(B.disconnect(),B=null),window.removeEventListener("resize",Ee),window.removeEventListener("keydown",ze,{capture:!0}),Y()}),(s,a)=>(oe(),ne("div",ln,[r("header",un,[r("div",{class:"header-left"},[a[31]||(a[31]=r("div",{class:"logo"},[r("div",{class:"logo-icon"},"AE"),r("span",{class:"logo-text"},"AE Animator")],-1)),a[32]||(a[32]=r("div",{class:"header-divider"},null,-1)),r("button",{class:"btn btn-ghost",onClick:f,title:"保存工程文件"},"Save"),r("button",{class:"btn btn-ghost",onClick:h,title:"加载工程文件"},"Load")]),r("div",mn,[r("span",pn,fe(k(e).project.width)+"x"+fe(k(e).project.height)+" @ "+fe(k(e).project.fps)+" FPS",1)]),r("div",dn,[r("div",fn,[r("div",hn,[a[33]||(a[33]=r("span",{class:"field-label"},"W",-1)),r("input",{type:"number",min:"16",max:"8192",value:k(e).project.width,onInput:a[0]||(a[0]=i=>U("width",i))},null,40,vn)]),r("div",yn,[a[34]||(a[34]=r("span",{class:"field-label"},"H",-1)),r("input",{type:"number",min:"16",max:"8192",value:k(e).project.height,onInput:a[1]||(a[1]=i=>U("height",i))},null,40,gn)]),r("div",_n,[a[35]||(a[35]=r("span",{class:"field-label"},"FPS",-1)),r("input",{type:"number",min:"1",max:"240",value:k(e).project.fps,onInput:a[2]||(a[2]=i=>U("fps",i))},null,40,bn)]),r("div",xn,[a[36]||(a[36]=r("span",{class:"field-label"},"Frames",-1)),r("input",{type:"number",min:"1",value:k(e).project.total_frames,onInput:a[3]||(a[3]=i=>U("total_frames",i))},null,40,wn)]),r("div",Pn,[r("label",kn,[ht(r("input",{type:"checkbox","onUpdate:modelValue":a[4]||(a[4]=i=>D.value=i)},null,512),[[Vt,D.value]]),a[37]||(a[37]=r("span",null,"Pano",-1))]),r("label",Mn,[ht(r("input",{type:"checkbox","onUpdate:modelValue":a[5]||(a[5]=i=>re.value=i)},null,512),[[Vt,re.value]]),a[38]||(a[38]=r("span",null,"Cam",-1))]),r("div",jn,[r("input",{type:"number",step:"1",value:T.value,onInput:a[6]||(a[6]=i=>T.value=parseFloat(i.target.value)),title:"Yaw"},null,40,Tn),r("input",{type:"number",step:"1",value:je.value,onInput:a[7]||(a[7]=i=>je.value=parseFloat(i.target.value)),title:"Pitch"},null,40,Cn),r("input",{type:"number",step:"1",value:Fe.value,onInput:a[8]||(a[8]=i=>Fe.value=parseFloat(i.target.value)),title:"Roll"},null,40,Sn),r("input",{type:"number",step:"1",min:"10",max:"170",value:Re.value,onInput:a[9]||(a[9]=i=>Re.value=parseFloat(i.target.value)),title:"FOV"},null,40,Ln)]),r("div",zn,[r("input",{type:"number",step:"1",value:Le.value,onInput:a[10]||(a[10]=i=>Le.value=parseFloat(i.target.value)),title:"Pos X"},null,40,Fn),r("input",{type:"number",step:"1",value:Ie.value,onInput:a[11]||(a[11]=i=>Ie.value=parseFloat(i.target.value)),title:"Pos Y"},null,40,In),r("input",{type:"number",step:"1",value:ge.value,onInput:a[12]||(a[12]=i=>ge.value=parseFloat(i.target.value)),title:"Pos Z"},null,40,En)])])]),r("button",{class:"btn btn-primary",onClick:ct},"+ FG Layer"),r("button",{class:"btn btn-secondary",onClick:lt},"+ BG Layer"),a[39]||(a[39]=r("div",{class:"header-divider"},null,-1)),r("button",{class:"btn btn-accent",onClick:Y,title:"保存到节点"},"Save"),r("button",{class:"btn btn-close",onClick:W,title:"关闭"},"Close")])]),r("div",Yn,[r("aside",Un,[k(e).currentLayer?(oe(),ne("div",Xn,[r("div",Rn,[r("span",An,fe(ue(k(e).currentLayer,k(e).currentLayerIndex)),1),r("span",{class:De(["layer-badge",k(e).currentLayer.type])},fe(k(e).currentLayer.type==="background"?"BG":"FG"),3)]),r("div",Dn," Layer "+fe(k(e).currentLayerIndex+1)+" - "+fe(k(e).currentLayer.type==="background"?"Background":"Foreground"),1)])):(oe(),ne("div",Bn,[...a[40]||(a[40]=[r("span",null,"请选择一个图层",-1)])])),k(e).currentLayer?(oe(),ne("div",$n,[a[53]||(a[53]=r("div",{class:"section-title"},"Transform",-1)),r("div",On,[r("div",Vn,[a[41]||(a[41]=r("span",{class:"prop-label"},"Position X",-1)),r("input",{type:"number",class:"prop-input",value:c.value.x.toFixed(0),onInput:a[13]||(a[13]=i=>p("x",i)),step:"1"},null,40,Gn)]),r("div",Kn,[a[42]||(a[42]=r("span",{class:"prop-label"},"Position Y",-1)),r("input",{type:"number",class:"prop-input",value:c.value.y.toFixed(0),onInput:a[14]||(a[14]=i=>p("y",i)),step:"1"},null,40,Zn)]),r("div",Wn,[a[43]||(a[43]=r("span",{class:"prop-label"},"Position Z",-1)),r("input",{type:"number",class:"prop-input",value:c.value.z.toFixed(0),onInput:a[15]||(a[15]=i=>p("z",i)),step:"1"},null,40,Nn)]),r("div",qn,[a[44]||(a[44]=r("span",{class:"prop-label"},"Scale",-1)),r("input",{type:"number",class:"prop-input",value:(c.value.scale*100).toFixed(0),onInput:a[16]||(a[16]=i=>g(i)),step:"1"},null,40,Hn),a[45]||(a[45]=r("span",{class:"prop-unit"},"%",-1))]),r("div",Jn,[a[46]||(a[46]=r("span",{class:"prop-label"},"Rot X",-1)),r("input",{type:"number",class:"prop-input",value:c.value.rotationX.toFixed(0),onInput:a[17]||(a[17]=i=>p("rotationX",i)),step:"1"},null,40,Qn),a[47]||(a[47]=r("span",{class:"prop-unit"},"deg",-1))]),r("div",eo,[a[48]||(a[48]=r("span",{class:"prop-label"},"Rot Y",-1)),r("input",{type:"number",class:"prop-input",value:c.value.rotationY.toFixed(0),onInput:a[18]||(a[18]=i=>p("rotationY",i)),step:"1"},null,40,to),a[49]||(a[49]=r("span",{class:"prop-unit"},"deg",-1))]),r("div",ao,[a[50]||(a[50]=r("span",{class:"prop-label"},"Rot Z",-1)),r("input",{type:"number",class:"prop-input",value:c.value.rotation.toFixed(0),onInput:a[19]||(a[19]=i=>p("rotation",i)),step:"1"},null,40,no),a[51]||(a[51]=r("span",{class:"prop-unit"},"deg",-1))]),r("div",oo,[r("div",ro,[a[52]||(a[52]=r("span",{class:"prop-label"},"Opacity",-1)),r("span",io,fe((c.value.opacity*100).toFixed(0))+"%",1)]),r("input",{type:"range",class:"prop-slider",value:c.value.opacity,onInput:a[20]||(a[20]=i=>p("opacity",i)),min:"0",max:"1",step:"0.01"},null,40,so)])])])):ot("",!0),r("div",co,[a[56]||(a[56]=r("div",{class:"section-title"},"Tools",-1)),r("div",lo,[r("button",{class:De(["tool-btn",{active:k(e).maskMode.enabled}]),onClick:a[21]||(a[21]=i=>We("mask"))},"Mask Mode",2),r("button",{class:De(["tool-btn",{active:k(e).maskMode.enabled&&k(e).maskMode.erase}]),onClick:a[22]||(a[22]=i=>k(e).maskMode.erase=!k(e).maskMode.erase),disabled:!k(e).maskMode.enabled},"Eraser",10,uo),r("button",{class:De(["tool-btn",{active:k(e).pathMode.enabled}]),onClick:a[23]||(a[23]=i=>We("path"))},"Path Tool",2),r("button",{class:De(["tool-btn",{active:k(e).extractMode.enabled}]),onClick:a[24]||(a[24]=i=>We("extract"))},"AI Extract",2)]),k(e).maskMode.enabled?(oe(),ne("div",mo,[r("div",po,[a[54]||(a[54]=r("span",{class:"prop-label"},"Brush Size",-1)),r("span",fo,fe(k(e).maskMode.brush)+"px",1)]),ht(r("input",{type:"range",class:"prop-slider","onUpdate:modelValue":a[25]||(a[25]=i=>k(e).maskMode.brush=i),min:"1",max:"100",step:"1"},null,512),[[bt,k(e).maskMode.brush,void 0,{number:!0}]])])):ot("",!0),k(e).extractMode.enabled?(oe(),ne("div",ho,[r("div",vo,[a[55]||(a[55]=r("span",{class:"prop-label"},"Brush Size",-1)),r("span",yo,fe(k(e).extractMode.brush)+"px",1)]),ht(r("input",{type:"range",class:"prop-slider","onUpdate:modelValue":a[26]||(a[26]=i=>k(e).extractMode.brush=i),min:"5",max:"150",step:"1"},null,512),[[bt,k(e).extractMode.brush,void 0,{number:!0}]]),r("div",{class:"extract-actions"},[r("button",{class:"btn btn-small btn-primary",onClick:pt},"Apply"),r("button",{class:"btn btn-small btn-ghost",onClick:at},"Clear")])])):ot("",!0)]),r("div",go,[Gt(cn)]),r("div",_o,[a[59]||(a[59]=r("div",{class:"section-title"},"Actions",-1)),r("div",{class:"action-row"},[r("button",{class:"btn btn-small btn-ghost",onClick:Ce},"Clear Cache"),r("button",{class:"btn btn-small btn-ghost",onClick:me},"Refresh"),r("button",{class:"btn btn-small btn-accent",onClick:ye},"Run")]),r("div",bo,[a[58]||(a[58]=r("span",{class:"prop-label"},"Fit Mode",-1)),ht(r("select",{class:"fit-select","onUpdate:modelValue":a[27]||(a[27]=i=>G.value=i)},[...a[57]||(a[57]=[r("option",{value:"fit"},"Fit",-1),r("option",{value:"fill"},"Fill",-1),r("option",{value:"stretch"},"Stretch",-1)])],512),[[ia,G.value]])])])]),r("main",xo,[r("div",wo,[r("span",Po,"Duration: "+fe(b(Pe.value)),1),r("div",ko,[r("span",Mo,fe(b(k(e).currentTime)),1),r("div",jo,[a[60]||(a[60]=r("span",{class:"prop-label"},"Zoom",-1)),ht(r("input",{type:"range",min:"25",max:"200",step:"5","onUpdate:modelValue":a[28]||(a[28]=i=>H.value=i)},null,512),[[bt,H.value,void 0,{number:!0}]]),r("span",To,fe(H.value)+"%",1)])])]),r("div",Co,[r("div",{class:"canvas-zoom",style:Ze({transform:`scale(${$.value})`})},[Gt(Sa,{ref_key:"canvasPreviewRef",ref:l,fitMode:G.value},null,8,["fitMode"])],4)])])]),r("footer",So,[r("div",Lo,[r("div",zo,[r("button",{class:"btn btn-small btn-ghost",onClick:J},"+ Keyframe"),r("button",{class:"btn btn-small btn-ghost",onClick:te},"Del Key"),r("button",{class:"btn btn-small btn-ghost",onClick:Me},"Clear All"),r("button",{class:"btn btn-small btn-ghost",onClick:Ae},"+ Cam KF"),r("button",{class:"btn btn-small btn-ghost",onClick:ae},"Del Cam KF"),a[61]||(a[61]=r("div",{class:"controls-divider"},null,-1)),r("button",{class:"nav-btn",onClick:nt,disabled:!k(e).currentLayer},"Up",8,Fo),r("button",{class:"nav-btn",onClick:ft,disabled:!k(e).currentLayer},"Down",8,Io)]),r("div",Eo,[r("span",Yo,fe(b(k(e).currentTime)),1),r("div",Uo,[r("button",{class:"pb-btn",onClick:we},"|<"),r("button",{class:De(["play-btn",{playing:k(e).isPlaying}]),onClick:a[29]||(a[29]=(...i)=>k(e).togglePlayback&&k(e).togglePlayback(...i))},fe(k(e).isPlaying?"Pause":"Play"),3),r("button",{class:"pb-btn",onClick:ke},">|")])])]),r("div",Xo,[r("div",Ro,[r("div",Ao,"Layers ("+fe(k(e).layers.length)+")",1),r("div",{class:"layers-list",onScroll:Ue},[a[62]||(a[62]=r("div",{class:"layer-item camera-layer"},[r("span",{class:"expand-icon"}),r("span",{class:"layer-type camera"},"C"),r("span",{class:"layer-name"},"Camera")],-1)),(oe(!0),ne(tt,null,it(k(e).layers,(i,d)=>(oe(),ne("div",{key:i.id,class:De(["layer-item",{active:d===k(e).currentLayerIndex}]),onClick:P=>k(e).selectLayer(d)},[r("span",{class:"expand-icon",onClick:qe(P=>R(d),["stop"])},fe(S.value.has(d)?"v":">"),9,Bo),r("span",{class:De(["layer-type",i.type])},fe(i.type==="background"?"B":"F"),3),r("span",$o,fe(ue(i,d)),1),r("span",Oo,[r("span",{class:De(["vis-icon",{off:i.hidden}]),onClick:qe(P=>q(i),["stop"])},"eye",10,Vo),r("span",{class:"del-icon",onClick:qe(P=>k(e).removeLayer(d),["stop"])},"x",8,Go)])],10,Do))),128))],32)]),r("div",{class:"tracks-panel",ref_key:"timelineRef",ref:w},[r("div",{class:"tracks-content",style:Ze({width:Be.value+"px"})},[r("div",{class:"ruler",onMousedown:ie},[(oe(!0),ne(tt,null,it(Math.ceil(Pe.value)+1,i=>(oe(),ne("div",{key:i,class:"ruler-tick",style:Ze({left:(i-1)*ce.value+"px"})},[r("span",Ko,fe(i-1)+"s",1)],4))),128)),r("div",{class:"playhead-top",style:Ze({left:k(e).currentTime*ce.value+"px"})},null,4)],32),r("div",{class:"tracks-list",onDblclick:le,onScroll:Oe},[r("div",{class:"track-row camera-row",onClick:a[30]||(a[30]=i=>void 0)},[r("div",{class:"track-bar camera",style:Ze({width:Pe.value*ce.value+"px"})},[(oe(!0),ne(tt,null,it(K(),i=>(oe(),ne("div",{key:`cam-${i.prop}-${i.time}`,class:"mini-kf camera",style:Ze({left:i.time*ce.value+"px"}),title:`Camera ${i.prop} @ ${i.time.toFixed(2)}s`,onMousedown:qe(d=>Xe(d,i),["stop"]),onContextmenu:qe(d=>_e(i.prop,i.time),["prevent"])},null,44,Zo))),128)),a[63]||(a[63]=r("span",{class:"track-label"},"Camera",-1))],4)]),(oe(!0),ne(tt,null,it(k(e).layers,(i,d)=>(oe(),ne(tt,{key:i.id},[r("div",{class:De(["track-row",{active:d===k(e).currentLayerIndex}]),onClick:P=>k(e).selectLayer(d)},[r("div",{class:De(["track-bar",i.type]),style:Ze({width:Pe.value*ce.value+"px"})},[S.value.has(d)?ot("",!0):(oe(!0),ne(tt,{key:0},it(E(i),P=>(oe(),ne("div",{key:P.time+P.prop,class:"mini-kf",style:Ze({left:P.time*ce.value+"px"})},null,4))),128))],6)],10,Wo),S.value.has(d)?(oe(),ne(tt,{key:0},it(m,P=>r("div",{key:P.key,class:De(["prop-track-row",{active:d===k(e).currentLayerIndex}]),onClick:F=>k(e).selectLayer(d)},[r("div",{class:"prop-track",onDblclick:qe(F=>pe(F,d,P.key),["stop"])},[(oe(!0),ne(tt,null,it(y(i,P.key),F=>(oe(),ne("div",{key:F.time,class:De(["keyframe-dot",{selected:ve(d,P.key,F.time)}]),style:Ze({left:F.time*ce.value+"px"}),title:`${P.label}: ${V(F.value,P.key)} @ ${F.time.toFixed(2)}s`,onMousedown:qe(A=>Ye(A,d,P.key,F),["stop"]),onClick:qe(A=>de(d,P.key,F.time),["stop"]),onContextmenu:qe(A=>$e(d,P.key,F.time),["prevent"])},null,46,Ho))),128))],40,qo)],10,No)),64)):ot("",!0)],64))),128))],32),r("div",{class:"playhead-line",style:Ze({left:k(e).currentTime*ce.value+"px"})},null,4)],4)],512)])]),r("input",{ref_key:"fileInput",ref:v,type:"file",accept:"image/*",multiple:"",style:{display:"none"},onChange:ut},null,544),r("input",{ref_key:"projectInput",ref:_,type:"file",accept:".json",style:{display:"none"},onChange:M},null,544)]))}}),Qo=kt(Jo,[["__scopeId","data-v-8b132f63"]]);function er(t,n){const e=sa(Qo,{node:n.node}),l=ca();return e.use(l),e.mount(t),e}window.createTimelineApp=er;
