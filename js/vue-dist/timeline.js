import{d as Ca,r as W,c as ye,b as la,k as ga,a as Ta,w as It,f as Z,h as q,j as s,C as ct,D as ya,u as v,l as $e,z as mt,t as N,q as Pe,_ as ua,F as Be,y as La,E as ha,G as ca,p as va,H as Ia,i as Ve,s as ut,A as Ea,B as Sa}from"./assets/_plugin-vue_export-helper.js";function ia(B){const x=Math.max(1,B.fps||1);return B.duration||B.total_frames/x}const ma=Ca("timeline",()=>{const B=W({width:1280,height:720,fps:30,duration:5,total_frames:150,mask_expansion:0,mask_feather:0,hdr_enable:!1,hdr_exposure:0,pano_enable:!1,cam_enable:!1,cam_yaw:0,cam_pitch:0,cam_roll:0,cam_fov:90,cam_offset_x:0,cam_offset_y:0,cam_pos_x:0,cam_pos_y:0,cam_pos_z:0}),x=W({}),e=W([]),$=W(-1),te=W(0),ue=W(0),K=W(!1),Ae=W({enabled:!1,drawing:!1,erase:!1,brush:20}),De=W({enabled:!1,data:null}),Ke=W({enabled:!1,drawing:!1,brush:30,blurType:"gaussian"}),ve=ye(()=>$.value>=0&&$.value<e.value.length?e.value[$.value]:null),ae=ye(()=>e.value.filter(d=>d.type==="foreground")),re=ye(()=>e.value.find(d=>d.type==="background"));function ce(d){const b=Math.max(1,d.fps??B.value.fps),C=typeof d.duration=="number",D=typeof d.total_frames=="number",E={...B.value,...d,fps:b};C&&!D?E.total_frames=Math.max(1,Math.round((E.duration||0)*b)):D&&!C?(E.total_frames=Math.max(1,Math.round(E.total_frames)),E.duration=E.total_frames/b):(E.total_frames=Math.max(1,Math.round(E.total_frames||E.duration*b)),E.duration=E.duration||E.total_frames/b),Object.assign(B.value,E)}function I(d,b,C){x.value[d]||(x.value[d]=[]);const D=x.value[d],E=D.find(P=>Math.abs(P.time-b)<.001);E?E.value=C:D.push({time:b,value:C}),D.sort((P,Ie)=>P.time-Ie.time)}function j(d,b){const C=x.value[d];C&&(x.value[d]=C.filter(D=>Math.abs(D.time-b)>.001))}function S(d,b,C){const D=x.value[d];if(!D||D.length===0)return C;const E=[...D].sort((P,Ie)=>P.time-Ie.time);if(b<=E[0].time)return E[0].value;if(b>=E[E.length-1].time)return E[E.length-1].value;for(let P=0;P<E.length-1;P++){const Ie=E[P],it=E[P+1];if(b>=Ie.time&&b<=it.time){const gt=(b-Ie.time)/Math.max(1e-6,it.time-Ie.time);return Ie.value+(it.value-Ie.value)*gt}}return C}function Me(d){e.value.push({z:0,is3D:!1,rotationX:0,rotationY:0,rotationZ:0,scaleX:1,scaleY:1,scaleZ:1,anchorX:0,anchorY:0,perspective:1e3,...d}),$.value=e.value.length-1}function Ze(d){d>=0&&d<e.value.length&&(e.value.splice(d,1),$.value>=e.value.length&&($.value=e.value.length-1))}function qe(){e.value=[],$.value=-1}function Ce(d){d>=0&&d<e.value.length&&($.value=d)}function Oe(d,b){d>=0&&d<e.value.length&&Object.assign(e.value[d],b)}function Te(d){const b=ia(B.value);te.value=Math.max(0,Math.min(d,b)),ue.value=Math.floor(te.value*B.value.fps)}function Re(d){const b=Math.max(1,Math.round(B.value.total_frames||ia(B.value)*B.value.fps));ue.value=Math.max(0,Math.min(d,b-1)),te.value=ue.value/B.value.fps}let ge=null,Ee=0;function H(){K.value=!K.value,K.value?J():Se()}function J(){ge===null&&(Ee=performance.now(),G())}function G(){if(!K.value)return;const d=performance.now(),b=(d-Ee)/1e3;Ee=d;let C=te.value+b;const D=ia(B.value);C>=D&&(C=0),Te(C),ge=requestAnimationFrame(G)}function Se(){ge!==null&&(cancelAnimationFrame(ge),ge=null)}function Ne(){K.value=!1,Se(),Te(0)}function be(d){if(!d)return;const b=d.project||{},C=b.fps||B.value.fps||30,D=b.duration??(b.total_frames?b.total_frames/Math.max(1,C):B.value.duration),E=b.total_frames??Math.max(1,Math.round((D||B.value.duration)*C));ce({width:b.width||1280,height:b.height||720,fps:C,duration:D,total_frames:E,mask_expansion:b.mask_expansion||0,mask_feather:b.mask_feather||0,hdr_enable:!!b.hdr_enable,hdr_exposure:b.hdr_exposure||0,pano_enable:!!b.pano_enable,cam_enable:b.cam_enable!==void 0?!!b.cam_enable:!!b.pano_enable,cam_yaw:b.cam_yaw||0,cam_pitch:b.cam_pitch||0,cam_roll:b.cam_roll||0,cam_fov:b.cam_fov||90,cam_offset_x:b.cam_offset_x||0,cam_offset_y:b.cam_offset_y||0,cam_pos_x:b.cam_pos_x||0,cam_pos_y:b.cam_pos_y||0,cam_pos_z:b.cam_pos_z||0}),x.value=b.project_keyframes||{},e.value=(d.layers||[]).map(P=>({id:P.id,name:P.name,type:P.type,image_data:P.image_data,x:P.x||0,y:P.y||0,z:P.z||0,scale:P.scale||1,rotation:P.rotation||0,opacity:P.opacity!==void 0?P.opacity:1,is3D:P.is3D||!1,rotationX:P.rotationX||0,rotationY:P.rotationY||0,rotationZ:P.rotationZ||0,scaleX:P.scaleX!==void 0?P.scaleX:P.scale||1,scaleY:P.scaleY!==void 0?P.scaleY:P.scale||1,scaleZ:P.scaleZ!==void 0?P.scaleZ:1,anchorX:P.anchorX||0,anchorY:P.anchorY||0,perspective:P.perspective||1e3,mask_size:P.mask_size||0,customMask:P.customMask,bezierPath:P.bezierPath,usePathAnimation:P.usePathAnimation||!1,keyframes:P.keyframes||{},bg_mode:P.bg_mode||"fit"}))}function ze(){const d=ve.value;if(!d)return;const b=["x","y","z","scale","rotation","opacity","mask_size","rotationX","rotationY","rotationZ","scaleX","scaleY","scaleZ","anchorX","anchorY","perspective"];d.keyframes||(d.keyframes={});for(const C of b){let D=d[C];D===void 0&&(C==="scale"||C==="opacity"?D=1:C==="perspective"?D=1e3:D=0),d.keyframes[C]||(d.keyframes[C]=[]),d.keyframes[C]=d.keyframes[C].filter(E=>E.time!==te.value),d.keyframes[C].push({time:te.value,value:D}),d.keyframes[C].sort((E,P)=>E.time-P.time)}}function Le(){const d=ve.value;if(!d||!d.keyframes)return;const b=["x","y","z","scale","rotation","opacity","mask_size","rotationX","rotationY","rotationZ","scaleX","scaleY","scaleZ","anchorX","anchorY","perspective"];for(const C of b)d.keyframes[C]&&(d.keyframes[C]=d.keyframes[C].filter(D=>D.time!==te.value))}function He(){const d=ve.value;d&&(d.keyframes={})}function Je(){return{project:{...B.value,project_keyframes:x.value},layers:e.value.map(d=>({id:d.id,name:d.name,type:d.type,image_data:d.image_data,x:d.x,y:d.y,z:d.z||0,scale:d.scale,rotation:d.rotation,opacity:d.opacity,is3D:d.is3D||!1,rotationX:d.rotationX,rotationY:d.rotationY,rotationZ:d.rotationZ,scaleX:d.scaleX,scaleY:d.scaleY,scaleZ:d.scaleZ,anchorX:d.anchorX,anchorY:d.anchorY,perspective:d.perspective,mask_size:d.mask_size,customMask:d.customMask,bezierPath:d.bezierPath,usePathAnimation:d.usePathAnimation,keyframes:d.keyframes,bg_mode:d.bg_mode}))}}return{project:B,layers:e,currentLayerIndex:$,currentTime:te,currentFrame:ue,isPlaying:K,maskMode:Ae,pathMode:De,extractMode:Ke,projectKeyframes:x,currentLayer:ve,foregroundLayers:ae,backgroundLayer:re,setProject:ce,addLayer:Me,removeLayer:Ze,clearLayers:qe,selectLayer:Ce,updateLayer:Oe,setCurrentTime:Te,setCurrentFrame:Re,togglePlayback:H,stopPlayback:Ne,addKeyframe:ze,deleteKeyframe:Le,clearAllKeyframes:He,setProjectKeyframe:I,deleteProjectKeyframe:j,interpolateProjectValue:S,loadAnimation:be,exportAnimation:Je}}),za={class:"canvas-wrapper"},Xa=["width","height"],Ya=["width","height"],Fa=["width","height"],Da={class:"canvas-info"},Ra={key:0},Ua={key:1},$a=["title"],Aa=la({__name:"CanvasPreview",setup(B,{expose:x}){const e=ma(),$=W(),te=W(),ue=W();let K=null;const Ae=W();let De=!1,Ke=0,ve=0,ae=0,re=0;const ce=W(!1),I=W(!1),j=W(!1);let S=null,Me=null,Ze="bgra8unorm",qe=!1,Ce=null;const Oe=new Map,Te=new Map,Re=new Set;let ge=null,Ee=null,H=null,J=null;const G={};let Se=!1,Ne=!1,be=0,ze=0,Le=0,He=0,Je=0,d=0,b=!1,C=0,D=0,E=0,P=0;ga(async()=>{$.value&&(Ce=$.value.getContext("2d",{alpha:!1,desynchronized:!0})),ue.value&&(K=ue.value.getContext("2d",{alpha:!0})),await Ie(),R()}),Ta(()=>{Oe.clear(),gt()});async function Ie(){try{if(!navigator.gpu){console.log("[Timeline GPU] WebGPU not supported, using Canvas 2D"),ce.value=!1;return}const t=await navigator.gpu.requestAdapter();if(!t){console.log("[Timeline GPU] No GPU adapter found, using Canvas 2D"),ce.value=!1;return}if(S=await t.requestDevice(),!S||!te.value){console.log("[Timeline GPU] Failed to get GPU device, using Canvas 2D"),ce.value=!1;return}if(Me=te.value.getContext("webgpu"),!Me){console.log("[Timeline GPU] Failed to get WebGPU context, using Canvas 2D"),ce.value=!1;return}if(Ze=navigator.gpu.getPreferredCanvasFormat(),Me.configure({device:S,format:Ze,alphaMode:"premultiplied"}),ge=S.createSampler({magFilter:"linear",minFilter:"linear"}),H=S.createBuffer({size:80,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),J=S.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{type:"filtering"}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}}]}),Ee=it(),!Ee){console.log("[Timeline GPU] Failed to create pipeline, using Canvas 2D"),ce.value=!1;return}I.value=!0,ce.value=j.value,console.log("[Timeline GPU] WebGPU initialized successfully, enabled:",j.value)}catch(t){console.warn("[Timeline GPU] WebGPU init failed:",t),ce.value=!1}}function it(){if(!S||!J)return null;const t=`
    struct Uniforms {
      transform: mat4x4<f32>,
      opacity: f32,
    }
    @group(0) @binding(0) var<uniform> uniforms: Uniforms;
    @group(0) @binding(1) var texSampler: sampler;
    @group(0) @binding(2) var tex: texture_2d<f32>;

    struct VSOut { @builtin(position) pos: vec4f, @location(0) uv: vec2f }

    @vertex fn vs(@builtin(vertex_index) i: u32) -> VSOut {
      var p = array<vec2f, 6>(vec2f(-1,-1), vec2f(1,-1), vec2f(1,1), vec2f(-1,-1), vec2f(1,1), vec2f(-1,1));
      var u = array<vec2f, 6>(vec2f(0,1), vec2f(1,1), vec2f(1,0), vec2f(0,1), vec2f(1,0), vec2f(0,0));
      var o: VSOut;
      o.pos = uniforms.transform * vec4f(p[i], 0, 1);
      o.uv = u[i];
      return o;
    }

    @fragment fn fs(@location(0) uv: vec2f) -> @location(0) vec4f {
      let c = textureSample(tex, texSampler, uv);
      return vec4f(c.rgb, c.a * uniforms.opacity);
    }
  `;return S.createRenderPipeline({layout:S.createPipelineLayout({bindGroupLayouts:[J]}),vertex:{module:S.createShaderModule({code:t}),entryPoint:"vs"},fragment:{module:S.createShaderModule({code:t}),entryPoint:"fs",targets:[{format:Ze,blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list"}})}function gt(){for(const t of Te.values())t.destroy();Te.clear(),Re.clear(),H==null||H.destroy(),S=null,Me=null}function R(){qe||(qe=!0,requestAnimationFrame(()=>{qe=!1,Gt()}))}It(()=>[e.layers,e.currentLayer,e.currentTime],()=>{R()},{deep:!0}),It(()=>e.project,()=>{R()},{deep:!0}),It(()=>e.extractMode.enabled,()=>{dt=!1,R()}),It(()=>[e.maskMode.enabled,e.pathMode.enabled],()=>{R()});function $t(){if(!S||!Me||!Ee||!ge||!H||!J){et();return}const t=!!e.project.pano_enable,n=e.layers.find(i=>i.type==="background");if(t&&(n==null?void 0:n.img)&&Math.abs(n.img.width/n.img.height-2)<.35){_t();return}try{const i=S.createCommandEncoder(),u=Me.getCurrentTexture().createView(),l=[],p=[];for(const h of e.layers){if(!h.image_data&&!h.img)continue;const g=Te.get(h.id);if(g&&h.img){const _={layer:h,texture:g,props:we(h)};h.type==="background"?l.push(_):p.push(_)}else Et(h)}const f=i.beginRenderPass({colorAttachments:[{view:u,loadOp:"clear",clearValue:{r:0,g:0,b:0,a:1},storeOp:"store"}]});f.setPipeline(Ee);for(const{layer:h,texture:g,props:_}of l){const k=bt(_,h.img.width,h.img.height,h),w=new Float32Array(20);w.set(k),w[16]=_.opacity,S.queue.writeBuffer(H,0,w);const M=S.createBindGroup({layout:J,entries:[{binding:0,resource:{buffer:H}},{binding:1,resource:ge},{binding:2,resource:g.createView()}]});f.setBindGroup(0,M),f.draw(6)}for(const{layer:h,texture:g,props:_}of p){const k=bt(_,h.img.width,h.img.height,h),w=new Float32Array(20);w.set(k),w[16]=_.opacity,S.queue.writeBuffer(H,0,w);const M=S.createBindGroup({layout:J,entries:[{binding:0,resource:{buffer:H}},{binding:1,resource:ge},{binding:2,resource:g.createView()}]});f.setBindGroup(0,M),f.draw(6)}f.end(),S.queue.submit([i.finish()])}catch(i){console.warn("[Timeline GPU] Render error:",i),ce.value=!1,et()}}async function _t(){var w,M,L,z,Y;if(!S||!Me||!te.value){et();return}const t=document.createElement("canvas");t.width=e.project.width,t.height=e.project.height;const n=t.getContext("2d");if(!n){et();return}n.fillStyle="#000",n.fillRect(0,0,e.project.width,e.project.height);const c=!!e.project.cam_enable,i=((w=e.interpolateProjectValue)==null?void 0:w.call(e,"cam_offset_x",e.currentTime,e.project.cam_offset_x||0))??(e.project.cam_offset_x||0),u=((M=e.interpolateProjectValue)==null?void 0:M.call(e,"cam_offset_y",e.currentTime,e.project.cam_offset_y||0))??(e.project.cam_offset_y||0),l=c?((L=e.interpolateProjectValue)==null?void 0:L.call(e,"cam_pos_x",e.currentTime,e.project.cam_pos_x||0))??(e.project.cam_pos_x||0):0,p=c?((z=e.interpolateProjectValue)==null?void 0:z.call(e,"cam_pos_y",e.currentTime,e.project.cam_pos_y||0))??(e.project.cam_pos_y||0):0,f=c?((Y=e.interpolateProjectValue)==null?void 0:Y.call(e,"cam_pos_z",e.currentTime,e.project.cam_pos_z||0))??(e.project.cam_pos_z||0):0,h=c?Math.max(.2,Math.min(4,1/(1+f*.001))):1,g=i+l,_=u+p,k=e.layers.find(F=>F.type==="background");k&&tt(n,k,g,_,h,c);try{const F=S.createCommandEncoder(),O=Me.getCurrentTexture().createView(),me=S.createTexture({size:[e.project.width,e.project.height],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT}),he=await createImageBitmap(t);S.queue.copyExternalImageToTexture({source:he},{texture:me},[e.project.width,e.project.height]);const oe=F.beginRenderPass({colorAttachments:[{view:O,loadOp:"clear",clearValue:{r:0,g:0,b:0,a:1},storeOp:"store"}]});oe.setPipeline(Ee);const ie=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),se=new Float32Array(20);se.set(ie),se[16]=1,S.queue.writeBuffer(H,0,se);const pe=S.createBindGroup({layout:J,entries:[{binding:0,resource:{buffer:H}},{binding:1,resource:ge},{binding:2,resource:me.createView()}]});oe.setBindGroup(0,pe),oe.draw(6);for(const A of e.layers){if(A.type==="background"||!A.image_data&&!A.img)continue;const U=Te.get(A.id);if(!U||!A.img){Et(A);continue}const Q=we(A),X=bt(Q,A.img.width,A.img.height,A),T=new Float32Array(20);T.set(X),T[16]=Q.opacity,S.queue.writeBuffer(H,0,T);const le=S.createBindGroup({layout:J,entries:[{binding:0,resource:{buffer:H}},{binding:1,resource:ge},{binding:2,resource:U.createView()}]});oe.setBindGroup(0,le),oe.draw(6)}oe.end(),S.queue.submit([F.finish()]),me.destroy()}catch(F){console.warn("[Timeline GPU] Pano render error:",F),et()}}async function Et(t){if(!(!S||Te.has(t.id)||Re.has(t.id))){Re.add(t.id);try{const n=t.img||await At(t.image_data);if(!n||!S){Re.delete(t.id);return}t.img=n;const c=S.createTexture({size:[n.width,n.height],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT}),i=await createImageBitmap(n,{premultiplyAlpha:"premultiply"});S.queue.copyExternalImageToTexture({source:i,flipY:!1},{texture:c,premultipliedAlpha:!0},[n.width,n.height]),Te.set(t.id,c),Re.delete(t.id),console.log("[Timeline GPU] Texture loaded for layer:",t.id,t.type),R()}catch(n){Re.delete(t.id),console.warn("[Timeline GPU] Texture load error:",n)}}}function At(t){return new Promise(n=>{const c=new Image;c.onload=()=>n(c),c.onerror=()=>n(null),c.src=t})}function bt(t,n,c,i){var le,xe,Ue,de,ke,je,Ye;const u=e.project.width,l=e.project.height,p=!!e.project.cam_enable,f=p?((le=e.interpolateProjectValue)==null?void 0:le.call(e,"cam_pos_x",e.currentTime,e.project.cam_pos_x||0))??(e.project.cam_pos_x||0):0,h=p?((xe=e.interpolateProjectValue)==null?void 0:xe.call(e,"cam_pos_y",e.currentTime,e.project.cam_pos_y||0))??(e.project.cam_pos_y||0):0,g=p?((Ue=e.interpolateProjectValue)==null?void 0:Ue.call(e,"cam_pos_z",e.currentTime,e.project.cam_pos_z||0))??(e.project.cam_pos_z||0):0,_=((de=e.interpolateProjectValue)==null?void 0:de.call(e,"cam_offset_x",e.currentTime,e.project.cam_offset_x||0))??(e.project.cam_offset_x||0),k=((ke=e.interpolateProjectValue)==null?void 0:ke.call(e,"cam_offset_y",e.currentTime,e.project.cam_offset_y||0))??(e.project.cam_offset_y||0),w=p?((je=e.interpolateProjectValue)==null?void 0:je.call(e,"cam_yaw",e.currentTime,e.project.cam_yaw||0))??(e.project.cam_yaw||0):0,M=p?((Ye=e.interpolateProjectValue)==null?void 0:Ye.call(e,"cam_pitch",e.currentTime,e.project.cam_pitch||0))??(e.project.cam_pitch||0):0,L=p?Math.max(.2,Math.min(4,1/(1+g*.001))):1,z=t.z||0,Y=1/Math.max(.1,1+z*.001),F=p?Y:1;let O=1;if(i.type==="background"&&n>0&&c>0){const Fe=i.bg_mode||"fit";Fe==="fit"?O=Math.min(u/n,l/c):Fe==="fill"?O=Math.max(u/n,l/c):Fe==="stretch"&&(O=Math.min(u/n,l/c))}let me=t.x,he=t.y;if(p&&(w!==0||M!==0)){const Fe=w*Math.PI/180,kt=M*Math.PI/180,yt=i.type==="background"?(z+1e3)*.3:(z+500)*.5;me-=Math.tan(Fe)*yt,he-=Math.tan(kt)*yt}const oe=(me+(_+f)*F)*L,ie=(he+(k+h)*F)*L,se=oe/u*2,pe=-ie/l*2,A=t.scale*O*L*Y,U=n*A/u,Q=c*A/l,X=Math.cos(t.rotation*Math.PI/180),T=Math.sin(t.rotation*Math.PI/180);return new Float32Array([U*X,U*T,0,0,-Q*T,Q*X,0,0,0,0,1,0,se,pe,0,1])}function Qe(t){if(t.img)return t.img;if(!t.image_data)return null;const n=t.id;if(Oe.has(n)){const i=Oe.get(n);return i.complete?(t.img=i,i):null}const c=new Image;return c.onload=()=>{t.img=c,R()},c.src=t.image_data,Oe.set(n,c),null}function _e(t,n,c){if(!t||t.length===0)return c;const i=[...t].sort((u,l)=>u.time-l.time);if(n<=i[0].time)return i[0].value;if(n>=i[i.length-1].time)return i[i.length-1].value;for(let u=0;u<i.length-1;u++)if(n>=i[u].time&&n<=i[u+1].time){const l=(n-i[u].time)/(i[u+1].time-i[u].time);return i[u].value+(i[u+1].value-i[u].value)*l}return c}function Kt(t,n,c){if(!t||t.length<2)return null;const i=n/c,l=t.length-1,p=Math.min(Math.floor(i*l),l-1),f=i*l-p,h=t[p],g=t[p+1];if(!h||!g)return null;const _=h.cp2x??h.x+(g.x-h.x)/3,k=h.cp2y??h.y+(g.y-h.y)/3,w=g.cp1x??h.x+(g.x-h.x)*2/3,M=g.cp1y??h.y+(g.y-h.y)*2/3,L=1-f,z=L*L,Y=z*L,F=f*f,O=F*f;return{x:Y*h.x+3*z*f*_+3*L*F*w+O*g.x,y:Y*h.y+3*z*f*k+3*L*F*M+O*g.y}}function we(t){const n=e.currentTime,c=t.keyframes||{};let i=_e(c.x,n,t.x||0),u=_e(c.y,n,t.y||0);if(t.usePathAnimation&&t.bezierPath&&t.bezierPath.length>=2){const l=Kt(t.bezierPath,n,e.project.duration);l&&(i=l.x,u=l.y)}return{x:i,y:u,z:_e(c.z,n,t.z||0),scale:_e(c.scale,n,t.scale||1),rotation:_e(c.rotation,n,t.rotation||0),opacity:_e(c.opacity,n,t.opacity??1),mask_size:_e(c.mask_size,n,t.mask_size||0),rotationX:_e(c.rotationX,n,t.rotationX||0),rotationY:_e(c.rotationY,n,t.rotationY||0),rotationZ:_e(c.rotationZ,n,t.rotationZ||0),anchorX:_e(c.anchorX,n,t.anchorX||0),anchorY:_e(c.anchorY,n,t.anchorY||0),perspective:_e(c.perspective,n,t.perspective||1e3)}}function Gt(){const t=I.value&&j.value;ce.value=t,t?$t():et(),Vt()}function Vt(){var i;if(!ue.value||!K)return;const t=K,n=e.project.width,c=e.project.height;t.clearRect(0,0,n,c),e.pathMode.enabled&&((i=e.currentLayer)!=null&&i.bezierPath)&&St(t,e.currentLayer.bezierPath),e.extractMode.enabled&&Nt(t),e.currentLayer&&e.currentLayer.img&&Ot(t)}function Ot(t){var X,T,le,xe,Ue,de,ke;const n=e.currentLayer;if(!n||!n.img)return;const c=we(n),i=n.img.width,u=n.img.height,l=e.project.width,p=e.project.height,f=l/2,h=p/2,g=!!e.project.cam_enable,_=g?((X=e.interpolateProjectValue)==null?void 0:X.call(e,"cam_pos_x",e.currentTime,e.project.cam_pos_x||0))??(e.project.cam_pos_x||0):0,k=g?((T=e.interpolateProjectValue)==null?void 0:T.call(e,"cam_pos_y",e.currentTime,e.project.cam_pos_y||0))??(e.project.cam_pos_y||0):0,w=g?((le=e.interpolateProjectValue)==null?void 0:le.call(e,"cam_pos_z",e.currentTime,e.project.cam_pos_z||0))??(e.project.cam_pos_z||0):0,M=((xe=e.interpolateProjectValue)==null?void 0:xe.call(e,"cam_offset_x",e.currentTime,e.project.cam_offset_x||0))??(e.project.cam_offset_x||0),L=((Ue=e.interpolateProjectValue)==null?void 0:Ue.call(e,"cam_offset_y",e.currentTime,e.project.cam_offset_y||0))??(e.project.cam_offset_y||0),z=g?((de=e.interpolateProjectValue)==null?void 0:de.call(e,"cam_yaw",e.currentTime,e.project.cam_yaw||0))??(e.project.cam_yaw||0):0,Y=g?((ke=e.interpolateProjectValue)==null?void 0:ke.call(e,"cam_pitch",e.currentTime,e.project.cam_pitch||0))??(e.project.cam_pitch||0):0,F=g?Math.max(.2,Math.min(4,1/(1+w*.001))):1,O=c.z||0,me=1/Math.max(.1,1+O*.001),he=g?me:1;let oe=1;if(n.type==="background"&&i>0&&u>0){const je=n.bg_mode||"fit";je==="fit"?oe=Math.min(l/i,p/u):je==="fill"?oe=Math.max(l/i,p/u):oe=Math.min(l/i,p/u)}let ie=c.x,se=c.y;if(g&&(z!==0||Y!==0)){const je=z*Math.PI/180,Ye=Y*Math.PI/180,Fe=n.type==="background"?(O+1e3)*.3:(O+500)*.5;ie-=Math.tan(je)*Fe,se-=Math.tan(Ye)*Fe}const pe=(ie+(M+_)*he)*F,A=(se+(L+k)*he)*F,U=c.scale*oe*F*me;t.save(),t.translate(f+pe,h+A),t.rotate(c.rotation*Math.PI/180),t.scale(U,U),t.strokeStyle="#3a7bc8",t.lineWidth=2/U,t.strokeRect(-i/2-2,-u/2-2,i+4,u+4),t.fillStyle="#3a7bc8",[[-i/2,-u/2],[i/2,-u/2],[i/2,u/2],[-i/2,u/2]].forEach(([je,Ye])=>{t.fillRect(je-4/U,Ye-4/U,8/U,8/U)}),t.restore()}function St(t,n){if(!n||n.length===0)return;const c=e.project.width/2,i=e.project.height/2;t.save(),t.strokeStyle="#ff6b6b",t.lineWidth=2,t.setLineDash([5,5]),t.beginPath(),t.moveTo(c+n[0].x,i+n[0].y);for(let u=1;u<n.length;u++){const l=n[u-1],p=n[u],f=l.cp2x??l.x+(p.x-l.x)/3,h=l.cp2y??l.y+(p.y-l.y)/3,g=p.cp1x??l.x+(p.x-l.x)*2/3,_=p.cp1y??l.y+(p.y-l.y)*2/3;t.bezierCurveTo(c+f,i+h,c+g,i+_,c+p.x,i+p.y)}t.stroke(),t.setLineDash([]),n.forEach((u,l)=>{t.beginPath(),t.arc(c+u.x,i+u.y,6,0,Math.PI*2),t.fillStyle=l===0?"#4ecdc4":l===n.length-1?"#ff6b6b":"#ffe66d",t.fill(),t.strokeStyle="#fff",t.lineWidth=2,t.stroke()}),t.restore()}function Nt(t){if(!e.extractMode.enabled||!ee||!at)return;const n=e.layers.find(p=>p.id===at);if(!n)return;const c=Qe(n);if(!c)return;const i=we(n);t.save(),t.translate(e.project.width/2+(i.x??0),e.project.height/2+(i.y??0)),t.rotate((i.rotation??0)*Math.PI/180),t.scale(i.scale??1,i.scale??1);const u=-c.width/2,l=-c.height/2;t.fillStyle="rgba(0, 0, 0, 0.65)",t.fillRect(u,l,c.width,c.height),t.globalCompositeOperation="destination-out",t.drawImage(ee,u,l,c.width,c.height),t.restore()}function Wt(){j.value=!j.value,ce.value=I.value&&j.value,console.log("[Timeline GPU] Toggle - gpuAvailable:",I.value,"gpuEnabled:",j.value,"useGPU:",ce.value),R()}function et(){var _,k,w,M,L,z;if(!$.value||!Ce)return;Ce.fillStyle="#000",Ce.fillRect(0,0,e.project.width,e.project.height),e.project.pano_enable;const t=!!e.project.cam_enable,n=((_=e.interpolateProjectValue)==null?void 0:_.call(e,"cam_offset_x",e.currentTime,e.project.cam_offset_x||0))??(e.project.cam_offset_x||0),c=((k=e.interpolateProjectValue)==null?void 0:k.call(e,"cam_offset_y",e.currentTime,e.project.cam_offset_y||0))??(e.project.cam_offset_y||0),i=((w=e.interpolateProjectValue)==null?void 0:w.call(e,"cam_pos_x",e.currentTime,e.project.cam_pos_x||0))??(e.project.cam_pos_x||0),u=((M=e.interpolateProjectValue)==null?void 0:M.call(e,"cam_pos_y",e.currentTime,e.project.cam_pos_y||0))??(e.project.cam_pos_y||0),l=((L=e.interpolateProjectValue)==null?void 0:L.call(e,"cam_pos_z",e.currentTime,e.project.cam_pos_z||0))??(e.project.cam_pos_z||0),p=t?Math.max(.2,Math.min(4,1/(1+l*.001))):1,f=t?n+i:n,h=t?c+u:c,g=e.layers.find(Y=>Y.type==="background");g&&tt(Ce,g,f,h,p,t),e.layers.filter(Y=>Y.type!=="background").forEach(Y=>{Bt(Ce,Y,f,h,t,p)}),e.pathMode.enabled&&((z=e.currentLayer)!=null&&z.bezierPath)&&V(Ce,e.currentLayer.bezierPath),e.extractMode.enabled&&Jt(Ce)}function V(t,n){if(!n||n.length===0)return;const c=e.project.width/2,i=e.project.height/2;t.save(),t.strokeStyle="#ff6b6b",t.lineWidth=2,t.setLineDash([5,5]),t.beginPath(),t.moveTo(c+n[0].x,i+n[0].y);for(let u=1;u<n.length;u++){const l=n[u-1],p=n[u],f=l.cp2x??l.x+(p.x-l.x)/3,h=l.cp2y??l.y+(p.y-l.y)/3,g=p.cp1x??l.x+(p.x-l.x)*2/3,_=p.cp1y??l.y+(p.y-l.y)*2/3;t.bezierCurveTo(c+f,i+h,c+g,i+_,c+p.x,i+p.y)}if(t.stroke(),t.setLineDash([]),n.forEach((u,l)=>{t.beginPath(),t.arc(c+u.x,i+u.y,6,0,Math.PI*2),t.fillStyle=l===0?"#4ecdc4":l===n.length-1?"#ff6b6b":"#ffe66d",t.fill(),t.strokeStyle="#fff",t.lineWidth=2,t.stroke()}),n.length>=2){const u=n.length-1,l=n[u-1],p=n[u],f=l.cp2x??l.x+(p.x-l.x)/3,h=l.cp2y??l.y+(p.y-l.y)/3,g=p.cp1x??l.x+(p.x-l.x)*2/3,_=p.cp1y??l.y+(p.y-l.y)*2/3,k=.99,w=1-k,M=3*w*w*(f-l.x)+6*w*k*(g-f)+3*k*k*(p.x-g),L=3*w*w*(h-l.y)+6*w*k*(_-h)+3*k*k*(p.y-_),z=Math.atan2(L,M),Y=c+p.x,F=i+p.y,O=18;t.beginPath(),t.moveTo(Y,F),t.lineTo(Y-O*Math.cos(z-Math.PI/6),F-O*Math.sin(z-Math.PI/6)),t.moveTo(Y,F),t.lineTo(Y-O*Math.cos(z+Math.PI/6),F-O*Math.sin(z+Math.PI/6)),t.strokeStyle="#ff6b6b",t.lineWidth=2,t.stroke()}t.restore()}function pt(t,n,c){if(t.maskCanvas||!t.customMask)return;const i=new Image;i.onload=()=>{const u=document.createElement("canvas");u.width=i.width||n,u.height=i.height||c;const l=u.getContext("2d");l&&(l.drawImage(i,0,0,u.width,u.height),t.maskCanvas=u,R())},i.src=t.customMask}function tt(t,n,c=0,i=0,u=1,l=!1){var Y,F,O,me,he,oe;const p=Qe(n);if(!p||p.width===0||p.height===0)return;const f=we(n),h=e.project.pano_enable;t.save(),t.globalAlpha=f.opacity;const g=n.bg_mode||"fit",_=e.project.width,k=e.project.height,w=p.width,M=p.height;let L=1;if(h&&w>0&&M>0&&Math.abs(w/M-2)<.35){const ie=((Y=e.interpolateProjectValue)==null?void 0:Y.call(e,"cam_yaw",e.currentTime,e.project.cam_yaw||0))??(e.project.cam_yaw||0),se=((F=e.interpolateProjectValue)==null?void 0:F.call(e,"cam_pitch",e.currentTime,e.project.cam_pitch||0))??(e.project.cam_pitch||0),pe=((O=e.interpolateProjectValue)==null?void 0:O.call(e,"cam_roll",e.currentTime,e.project.cam_roll||0))??(e.project.cam_roll||0),A=Math.min(170,Math.max(10,((me=e.interpolateProjectValue)==null?void 0:me.call(e,"cam_fov",e.currentTime,e.project.cam_fov||90))??(e.project.cam_fov||90))),U=Math.PI/180,Q=1024;let X=_,T=k;const le=Math.max(1,Math.max(_,k)/Q);le>1.01&&(X=Math.max(1,Math.round(_/le)),T=Math.max(1,Math.round(k/le)));const xe=`${X}x${T}|${w}x${M}|${ie}|${se}|${pe}|${A}`;if(G.key!==xe){const ht=document.createElement("canvas");ht.width=w,ht.height=M;const ot=ht.getContext("2d");ot?(ot.drawImage(p,0,0,w,M),G.srcData=ot.getImageData(0,0,w,M).data):G.srcData=void 0;const na=_/Math.max(1,k),st=Math.tan(A*U/2),lt=Math.cos(ie*U),vt=Math.sin(ie*U),rt=Math.cos(se*U),Ge=Math.sin(se*U),jt=Math.cos(pe*U),Pt=Math.sin(pe*U),We=[jt*lt+Pt*Ge*vt,Pt*rt,jt*-vt+Pt*Ge*lt,-Pt*lt+jt*Ge*vt,jt*rt,-Pt*-vt+jt*Ge*lt,rt*vt,-Ge,rt*lt],pa=new Float32Array(X*T),da=new Float32Array(X*T);for(let Rt=0;Rt<T;Rt++){const _a=(Rt+.5)/T*2-1;for(let Ut=0;Ut<X;Ut++){let Mt=((Ut+.5)/X*2-1)*st*na,Ct=-_a*st,Tt=1;const oa=1/Math.hypot(Mt,Ct,Tt);Mt*=oa,Ct*=oa,Tt*=oa;const ba=We[0]*Mt+We[1]*Ct+We[2]*Tt,wa=We[3]*Mt+We[4]*Ct+We[5]*Tt,xa=We[6]*Mt+We[7]*Ct+We[8]*Tt,ka=Math.atan2(ba,xa),ja=Math.asin(Math.max(-1,Math.min(1,wa))),Pa=(ka/(Math.PI*2)+.5)*w,Ma=(-ja/Math.PI+.5)*M;let sa=Math.floor(Pa)%w;sa<0&&(sa+=w);let ra=Math.floor(Ma);ra=Math.max(0,Math.min(M-1,ra));const fa=Rt*X+Ut;pa[fa]=sa,da[fa]=ra}}G.key=xe,G.mapX=pa,G.mapY=da,G.imgW=w,G.imgH=M,G.outW=X,G.outH=T,G.canvas=document.createElement("canvas"),G.canvas.width=X,G.canvas.height=T,G.ctx=G.canvas.getContext("2d")}const de=G.srcData,ke=G.mapX,je=G.mapY,Ye=G.canvas,Fe=G.ctx,kt=G.outW||0,yt=G.outH||0;if(de&&ke&&je&&Ye&&Fe&&kt>0&&yt>0){const ht=Fe.getImageData(0,0,kt,yt),ot=ht.data,na=kt*yt;for(let st=0;st<na;st++){const lt=ke[st],rt=(je[st]*w+lt)*4,Ge=st*4;ot[Ge]=de[rt],ot[Ge+1]=de[rt+1],ot[Ge+2]=de[rt+2],ot[Ge+3]=255}Fe.putImageData(ht,0,0),t.translate(_/2+c*u,k/2+i*u),t.scale(u,u),t.drawImage(Ye,-_/2,-k/2,_,k)}else return t.restore(),tt(t,{...n,panoFallback:!0,type:n.type,bg_mode:n.bg_mode},c,i,u,l)}else{w>0&&M>0&&(g==="fit"?L=Math.min(_/w,k/M):g==="fill"?L=Math.max(_/w,k/M):g==="stretch"&&(L=Math.min(_/w,k/M))),(!Number.isFinite(L)||L<=0)&&(L=1);const ie=l?((he=e.interpolateProjectValue)==null?void 0:he.call(e,"cam_yaw",e.currentTime,e.project.cam_yaw||0))??(e.project.cam_yaw||0):0,se=l?((oe=e.interpolateProjectValue)==null?void 0:oe.call(e,"cam_pitch",e.currentTime,e.project.cam_pitch||0))??(e.project.cam_pitch||0):0,pe=1/Math.max(.1,1+(f.z||0)*.001),A=l?u:1,U=l?c:0,Q=l?i:0,X=l?pe:1;let T=f.x,le=f.y;if(l&&(ie!==0||se!==0)){const ke=ie*Math.PI/180,je=se*Math.PI/180,Ye=f.z||0;T-=Math.tan(ke)*(Ye+1e3)*.3,le-=Math.tan(je)*(Ye+1e3)*.3}const xe=_/2+(T+U*X)*A,Ue=k/2+(le+Q*X)*A,de=(f.scale||1)*L*A*pe;if(!Number.isFinite(xe)||!Number.isFinite(Ue)||!Number.isFinite(de)||de<=0){t.restore();return}t.translate(xe,Ue),t.rotate((f.rotation||0)*Math.PI/180),t.scale(de,de),t.drawImage(p,-w/2,-M/2,w,M)}t.restore()}function Bt(t,n,c=0,i=0,u=!1,l=1){var pe,A,U;const p=Qe(n);if(!p||p.width===0||p.height===0)return;const f=we(n),h=p.width,g=p.height;pt(n,h,g),t.save();const _=u?((pe=e.interpolateProjectValue)==null?void 0:pe.call(e,"cam_yaw",e.currentTime,e.project.cam_yaw||0))??(e.project.cam_yaw||0):0,k=u?((A=e.interpolateProjectValue)==null?void 0:A.call(e,"cam_pitch",e.currentTime,e.project.cam_pitch||0))??(e.project.cam_pitch||0):0;u&&(((U=e.interpolateProjectValue)==null?void 0:U.call(e,"cam_fov",e.currentTime,e.project.cam_fov||90))??e.project.cam_fov);const w=1/Math.max(.1,1+(f.z||0)*.001),M=u?l:1,L=u?c:0,z=u?i:0,Y=u?w:1;let F=f.x,O=f.y;if(u&&(_!==0||k!==0)){const Q=_*Math.PI/180,X=k*Math.PI/180,T=f.z||0;F-=Math.tan(Q)*(T+500)*.5,O-=Math.tan(X)*(T+500)*.5}const me=e.project.width/2+(F+L*Y)*M,he=e.project.height/2+(O+z*Y)*M;if(!Number.isFinite(me)||!Number.isFinite(he)){t.restore();return}if(t.translate(me,he),f.rotationX!==0||f.rotationY!==0){const Q=f.perspective||1e3,X=f.rotationX*Math.PI/180,T=f.rotationY*Math.PI/180,le=Math.cos(X),xe=Math.sin(X),Ue=Math.cos(T),de=Math.sin(T),ke=1/(1+(de*h/2+xe*g/2)/Q);t.transform(Ue*ke,xe*de*ke,0,le*ke,0,0)}t.rotate(f.rotation*Math.PI/180);const oe=f.scale*M*w;t.scale(oe,oe),t.globalAlpha=f.opacity;const ie=(f.anchorX||0)*h,se=(f.anchorY||0)*g;if(n.maskCanvas){const Q=document.createElement("canvas");Q.width=h,Q.height=g;const X=Q.getContext("2d");X?(X.clearRect(0,0,h,g),X.drawImage(p,0,0,h,g),X.globalCompositeOperation="destination-in",X.drawImage(n.maskCanvas,0,0,h,g),t.drawImage(Q,-h/2-ie,-g/2-se,h,g)):t.drawImage(p,-h/2-ie,-g/2-se,h,g)}else t.drawImage(p,-h/2-ie,-g/2-se,h,g);if(f.mask_size>0){t.strokeStyle="#3ac88e",t.lineWidth=2/f.scale,t.setLineDash([5/f.scale,5/f.scale]);const Q=n.img?n.img.width:512,X=n.img?n.img.height:512,T=Q*f.mask_size,le=X*f.mask_size;t.strokeRect(-T/2,-le/2,T,le),t.setLineDash([])}t.restore()}function Zt(){return ce.value?te.value||null:$.value||null}function zt(t){const n=ue.value||Zt();if(!n)return{x:0,y:0};const c=n.getBoundingClientRect(),i=e.project.width/c.width,u=e.project.height/c.height;return{x:(t.clientX-c.left)*i,y:(t.clientY-c.top)*u}}let wt=!1,ne=null,ee=null,Xe=null,dt=!1,at=null,Xt=!1,nt=-1;function qt(t){var p;(p=ue.value)==null||p.focus(),t.shiftKey,t.altKey;const n=zt(t);if(e.project.pano_enable&&!e.maskMode.enabled&&!e.extractMode.enabled&&!e.pathMode.enabled){if(be=n.x,ze=n.y,Le=e.project.cam_yaw||0,He=e.project.cam_pitch||0,Je=e.project.cam_offset_x||0,d=e.project.cam_offset_y||0,t.button===1||t.button===2){Se=!0;return}else if(t.button===0&&(!e.currentLayer||t.altKey)){Ne=!0;return}}if(!!e.project.cam_enable&&!e.project.pano_enable&&!e.maskMode.enabled&&!e.extractMode.enabled&&!e.pathMode.enabled){if(C=n.x,D=n.y,E=e.project.cam_pos_x||0,P=e.project.cam_pos_y||0,e.project.cam_pos_z,Le=e.project.cam_yaw||0,He=e.project.cam_pitch||0,t.button===1||t.button===2){Se=!0;return}if(t.button===0&&!e.currentLayer){b=!0;return}}if(!e.currentLayer)return;if(e.extractMode.enabled){if(!xt()){console.warn("[Timeline] Extract mode requires a background layer with image data");return}dt=!0,Ft(n.x,n.y,t.button===2||t.altKey);return}if(e.maskMode.enabled){wt=!0,ft(),Yt(n.x,n.y);return}if(e.pathMode.enabled){Dt(n);return}De=!0,Ke=n.x,ve=n.y;const l=we(e.currentLayer);ae=l.x,re=l.y}function Ht(t){var p,f,h,g,_,k;const n=zt(t);if(Se){const w=n.x-be,M=n.y-ze,L=Le+w*.2,z=Math.max(-89,Math.min(89,He+M*.2));e.setProject({cam_yaw:L,cam_pitch:z}),(p=e.setProjectKeyframe)==null||p.call(e,"cam_yaw",e.currentTime,L),(f=e.setProjectKeyframe)==null||f.call(e,"cam_pitch",e.currentTime,z),R();return}if(b){const w=n.x-C,M=n.y-D,L=E+w,z=P+M;e.setProject({cam_pos_x:L,cam_pos_y:z}),(h=e.setProjectKeyframe)==null||h.call(e,"cam_pos_x",e.currentTime,L),(g=e.setProjectKeyframe)==null||g.call(e,"cam_pos_y",e.currentTime,z),R();return}if(Ne){const w=n.x-be,M=n.y-ze,L=(Je||0)+w,z=(d||0)+M;e.setProject({cam_offset_x:L,cam_offset_y:z}),(_=e.setProjectKeyframe)==null||_.call(e,"cam_offset_x",e.currentTime,L),(k=e.setProjectKeyframe)==null||k.call(e,"cam_offset_y",e.currentTime,z),R();return}if(e.extractMode.enabled&&dt){Ft(n.x,n.y,(t.buttons&2)===2||t.altKey);return}if(wt&&e.maskMode.enabled){Yt(n.x,n.y);return}if(Xt&&nt>=0){a(n);return}if(!De||!e.currentLayer)return;let c=n.x-Ke,i=n.y-ve;t.shiftKey&&(Math.abs(c)>Math.abs(i)?i=0:c=0);const u=ae+c,l=re+i;fe(e.currentLayer,"x",u),fe(e.currentLayer,"y",l),R()}function fe(t,n,c){const i=e.currentTime;if(t.keyframes&&t.keyframes[n]&&t.keyframes[n].length>0){const u=t.keyframes[n].findIndex(l=>Math.abs(l.time-i)<.05);u>=0?t.keyframes[n][u]={time:t.keyframes[n][u].time,value:c}:(t.keyframes[n].push({time:i,value:c}),t.keyframes[n].sort((l,p)=>l.time-p.time))}e.updateLayer(e.currentLayerIndex,{[n]:c})}function ft(){const t=e.currentLayer;if(!(!t||!t.img)){if(t.maskCanvas)ne=t.maskCanvas.getContext("2d");else if(t.maskCanvas=document.createElement("canvas"),t.maskCanvas.width=t.img.width,t.maskCanvas.height=t.img.height,ne=t.maskCanvas.getContext("2d"),ne)if(t.customMask){const n=new Image;n.onload=()=>{ne==null||ne.drawImage(n,0,0),R()},n.src=t.customMask}else ne.globalCompositeOperation="source-over",ne.fillStyle="white",ne.fillRect(0,0,t.maskCanvas.width,t.maskCanvas.height)}}function Yt(t,n){const c=e.currentLayer;if(!c||((!ne||!c.maskCanvas)&&ft(),!c.img||!ne||!c.maskCanvas))return;const i=we(c),u=e.project.width/2+i.x,l=e.project.height/2+i.y,p=(t-u)/i.scale+c.img.width/2,f=(n-l)/i.scale+c.img.height/2,h=e.maskMode.brush||20;ne.save(),ne.beginPath(),ne.arc(p,f,h,0,Math.PI*2),e.maskMode.erase?(ne.globalCompositeOperation="source-over",ne.fillStyle="white"):(ne.globalCompositeOperation="destination-out",ne.fillStyle="black"),ne.fill(),ne.restore(),R()}function xt(){const t=e.layers.find(c=>c.type==="background");if(!t)return null;const n=Qe(t);return n?((!ee||!Xe||ee.width!==n.width||ee.height!==n.height||at!==t.id)&&(ee=document.createElement("canvas"),ee.width=n.width,ee.height=n.height,Xe=ee.getContext("2d"),Xe&&Xe.clearRect(0,0,n.width,n.height),at=t.id||null),{layer:t,img:n,ctx:Xe}):null}function Ft(t,n,c=!1){const i=xt();if(!i)return;const{layer:u,img:l,ctx:p}=i,f=we(u),h=e.project.width/2+(f.x??0),g=e.project.height/2+(f.y??0),_=f.scale??1,k=(t-h)/_+l.width/2,w=(n-g)/_+l.height/2,M=Math.max(1,e.extractMode.brush||30);p.beginPath(),p.arc(k,w,M,0,Math.PI*2),p.fillStyle=c?"black":"white",p.fill(),R()}function Jt(t){if(!e.extractMode.enabled||!ee||!at)return;const n=e.layers.find(p=>p.id===at);if(!n)return;const c=Qe(n);if(!c)return;const i=we(n);t.save(),t.translate(e.project.width/2+(i.x??0),e.project.height/2+(i.y??0)),t.rotate((i.rotation??0)*Math.PI/180),t.scale(i.scale??1,i.scale??1);const u=-c.width/2,l=-c.height/2;t.fillStyle="rgba(0, 0, 0, 0.65)",t.fillRect(u,l,c.width,c.height),t.globalCompositeOperation="destination-out",t.drawImage(ee,u,l,c.width,c.height),t.restore()}function Qt(){Xe&&ee&&(Xe.clearRect(0,0,ee.width,ee.height),R())}function ea(){if(!Xe||!ee)return!1;const t=Xe.getImageData(0,0,ee.width,ee.height).data;for(let n=0;n<t.length;n+=4)if(t[n]>10)return!0;return!1}function ta(t,n,c){const i=t.canvas,u=document.createElement("canvas");u.width=n,u.height=c;const l=u.getContext("2d");if(!l)return null;l.drawImage(i,0,0);const p=20;l.globalCompositeOperation="destination-over";for(let f=0;f<p;f++)l.drawImage(u,1,0),l.drawImage(u,-1,0),l.drawImage(u,0,1),l.drawImage(u,0,-1),f%2===0&&(l.drawImage(u,1,1),l.drawImage(u,-1,-1),l.drawImage(u,1,-1),l.drawImage(u,-1,1));for(let f=0;f<10;f++)l.drawImage(u,2,0),l.drawImage(u,-2,0),l.drawImage(u,0,2),l.drawImage(u,0,-2),l.drawImage(u,2,2),l.drawImage(u,-2,-2),l.drawImage(u,2,-2),l.drawImage(u,-2,2);return u.toDataURL("image/png")}function aa(){const t=xt();if(!t||!ee||!Xe)return{error:"Background layer not ready"};if(!ea())return null;const{img:n}=t,c=document.createElement("canvas");c.width=n.width,c.height=n.height;const i=c.getContext("2d");if(!i)return{error:"Cannot create temporary canvas"};i.drawImage(n,0,0),i.globalCompositeOperation="destination-in",i.drawImage(ee,0,0);const u=c.toDataURL("image/png"),l=document.createElement("canvas");l.width=n.width,l.height=n.height;const p=l.getContext("2d");if(!p)return{error:"Cannot create background canvas"};p.drawImage(n,0,0),p.globalCompositeOperation="destination-out",p.drawImage(ee,0,0),p.globalCompositeOperation="source-over";const f=ta(p,n.width,n.height)||n.src,h=ee.toDataURL("image/png");return{foregroundDataUrl:u,backgroundDataUrl:f,extractMaskDataUrl:h}}function Dt(t,n){const c=e.currentLayer;if(!c)return;c.bezierPath||(c.bezierPath=[]);const i=r(t);if(i>=0)nt=i,Xt=!0;else{const u=e.project.width/2,l=e.project.height/2;c.bezierPath.push({x:t.x-u,y:t.y-l}),c.bezierPath.length>=2&&(c.usePathAnimation=!0),R()}}function r(t){const n=e.currentLayer;if(!n||!n.bezierPath)return-1;const c=e.project.width/2,i=e.project.height/2,u=10;for(let l=0;l<n.bezierPath.length;l++){const p=n.bezierPath[l],f=p.x+c-t.x,h=p.y+i-t.y;if(Math.sqrt(f*f+h*h)<u)return l}return-1}function a(t){const n=e.currentLayer;if(!n||!n.bezierPath||nt<0)return;const c=e.project.width/2,i=e.project.height/2;n.bezierPath[nt].x=t.x-c,n.bezierPath[nt].y=t.y-i,R()}function o(){De=!1,wt=!1,dt=!1,Xt=!1,nt=-1,Se=!1,Ne=!1,b=!1}function m(t){var h,g;const n=t.deltaY>0?-.05:.05;if(e.project.pano_enable&&!e.maskMode.enabled&&!e.extractMode.enabled&&!e.pathMode.enabled&&(!e.currentLayer||t.ctrlKey||t.altKey)){const _=Math.min(170,Math.max(10,(e.project.cam_fov||90)+(n>0?2:-2)));e.setProject({cam_fov:_}),(h=e.setProjectKeyframe)==null||h.call(e,"cam_fov",e.currentTime,_),R();return}if(!!e.project.cam_enable&&!e.project.pano_enable&&!e.maskMode.enabled&&!e.extractMode.enabled&&!e.pathMode.enabled&&!e.currentLayer&&!e.currentLayer){const _=e.project.cam_pos_z||0,k=5,w=_+(n>0?k:-k);e.setProject({cam_pos_z:w}),(g=e.setProjectKeyframe)==null||g.call(e,"cam_pos_z",e.currentTime,w),R();return}if(!e.currentLayer)return;const l=e.currentLayer,p=we(l),f=2;if(t.shiftKey&&!t.ctrlKey&&!t.altKey){const _=p.rotationX+(n>0?f:-f);fe(l,"rotationX",_)}else if(t.ctrlKey&&!t.shiftKey&&!t.altKey){const _=p.rotationY+(n>0?f:-f);fe(l,"rotationY",_)}else if(t.altKey&&!t.shiftKey&&!t.ctrlKey){const _=(p.rotationZ||p.rotation||0)+(n>0?f:-f);fe(l,"rotationZ",_)}else{const _=Math.max(.1,Math.min(5,p.scale+n));fe(l,"scale",_)}R()}function y(t){if(!e.currentLayer)return;const n=t.shiftKey?10:1,c=e.currentLayer,i=we(c);switch(t.key){case"ArrowLeft":fe(c,"x",i.x-n),R(),t.preventDefault();break;case"ArrowRight":fe(c,"x",i.x+n),R(),t.preventDefault();break;case"ArrowUp":fe(c,"y",i.y-n),R(),t.preventDefault();break;case"ArrowDown":fe(c,"y",i.y+n),R(),t.preventDefault();break;case"r":case"R":fe(c,"x",0),fe(c,"y",0),fe(c,"scale",1),fe(c,"rotation",0),fe(c,"opacity",1),R(),t.preventDefault();break;case"Delete":case"Backspace":confirm("Delete current layer?")&&e.removeLayer(e.currentLayerIndex),t.preventDefault();break}}return x({clearExtractSelection:Qt,applyExtractSelection:aa}),(t,n)=>(q(),Z("div",{class:"canvas-preview",ref_key:"containerRef",ref:Ae},[s("div",za,[ct(s("canvas",{ref_key:"gpuCanvasRef",ref:te,width:v(e).project.width,height:v(e).project.height,class:"render-canvas"},null,8,Xa),[[ya,j.value&&I.value]]),ct(s("canvas",{ref_key:"canvasRef",ref:$,width:v(e).project.width,height:v(e).project.height,class:"render-canvas"},null,8,Ya),[[ya,!j.value||!I.value]]),s("canvas",{ref_key:"interactionCanvasRef",ref:ue,width:v(e).project.width,height:v(e).project.height,class:"interaction-canvas",onMousedown:qt,onMousemove:Ht,onMouseup:o,onMouseleave:o,onWheel:$e(m,["prevent"]),onContextmenu:n[0]||(n[0]=$e(()=>{},["prevent"])),tabindex:"0",onKeydown:y},null,40,Fa),s("div",Da,[v(e).currentLayer?(q(),Z("span",Ra," Layer "+N(v(e).currentLayerIndex+1)+" | X:"+N(Math.round(v(e).currentLayer.x||0))+" Y:"+N(Math.round(v(e).currentLayer.y||0))+" S:"+N((v(e).currentLayer.scale||1).toFixed(2))+" R:"+N(Math.round(v(e).currentLayer.rotation||0))+"Â° ",1)):(q(),Z("span",Ua,"No layer selected")),I.value?(q(),Z("button",{key:2,class:Pe(["gpu-toggle",{active:j.value}]),onClick:Wt,title:j.value?"å…³é—­GPUåŠ é€Ÿ":"å¼€å¯GPUåŠ é€Ÿ"}," GPU "+N(j.value?"ON":"OFF"),11,$a)):mt("",!0)])])],512))}}),Ka=ua(Aa,[["__scopeId","data-v-6c956e51"]]),Ga={class:"project-settings"},Va={class:"setting-row"},Oa=["value"],Na={class:"setting-row"},Wa=["value"],Ba={class:"setting-row"},Za=["value"],qa={class:"setting-row"},Ha=["value"],Ja={class:"setting-row"},Qa=["checked"],en={class:"setting-row"},tn=["value"],an={class:"setting-row"},nn=["value"],on={class:"setting-row"},sn=["value"],rn={class:"setting-row"},cn=["value"],ln={class:"setting-row"},un=["value"],mn={class:"setting-row"},pn=["value"],dn={class:"setting-row"},fn=["value"],yn=la({__name:"ProjectSettings",setup(B){const x=ma();function e(I){x.setProject({width:parseInt(I.target.value)||1280})}function $(I){x.setProject({height:parseInt(I.target.value)||720})}function te(I){x.setProject({fps:parseInt(I.target.value)||30})}function ue(I){x.setProject({total_frames:parseInt(I.target.value)||150})}function K(I){x.setProject({cam_enable:I.target.checked})}function Ae(I){x.setProject({cam_pos_x:parseFloat(I.target.value)||0})}function De(I){x.setProject({cam_pos_y:parseFloat(I.target.value)||0})}function Ke(I){x.setProject({cam_pos_z:parseFloat(I.target.value)||0})}function ve(I){x.setProject({cam_yaw:parseFloat(I.target.value)||0})}function ae(I){x.setProject({cam_pitch:parseFloat(I.target.value)||0})}function re(I){x.setProject({cam_roll:parseFloat(I.target.value)||0})}function ce(I){x.setProject({cam_fov:parseFloat(I.target.value)||90})}return(I,j)=>(q(),Z("div",Ga,[j[15]||(j[15]=s("div",{class:"section-title"},"ðŸ“ é¡¹ç›®",-1)),s("div",Va,[j[0]||(j[0]=s("label",null,"å®½åº¦",-1)),s("input",{type:"number",value:v(x).project.width,onInput:e,min:"64",max:"8192"},null,40,Oa)]),s("div",Na,[j[1]||(j[1]=s("label",null,"é«˜åº¦",-1)),s("input",{type:"number",value:v(x).project.height,onInput:$,min:"64",max:"8192"},null,40,Wa)]),s("div",Ba,[j[2]||(j[2]=s("label",null,"å¸§çŽ‡",-1)),s("input",{type:"number",value:v(x).project.fps,onInput:te,min:"1",max:"120"},null,40,Za)]),s("div",qa,[j[3]||(j[3]=s("label",null,"å¸§æ•°",-1)),s("input",{type:"number",value:v(x).project.total_frames,onInput:ue,min:"1",max:"9999"},null,40,Ha)]),j[16]||(j[16]=s("div",{class:"section-title"},"ðŸŽ¥ 3D æ‘„åƒæœº",-1)),s("div",Ja,[j[4]||(j[4]=s("label",null,"å¯ç”¨",-1)),s("input",{type:"checkbox",checked:v(x).project.cam_enable,onChange:K},null,40,Qa)]),v(x).project.cam_enable?(q(),Z(Be,{key:0},[j[12]||(j[12]=s("div",{class:"subsection-title"},"ä½ç½®",-1)),s("div",en,[j[5]||(j[5]=s("label",null,"X",-1)),s("input",{type:"number",value:v(x).project.cam_pos_x,onInput:Ae,step:"10"},null,40,tn)]),s("div",an,[j[6]||(j[6]=s("label",null,"Y",-1)),s("input",{type:"number",value:v(x).project.cam_pos_y,onInput:De,step:"10"},null,40,nn)]),s("div",on,[j[7]||(j[7]=s("label",null,"Z (è·ç¦»)",-1)),s("input",{type:"number",value:v(x).project.cam_pos_z,onInput:Ke,step:"50"},null,40,sn)]),j[13]||(j[13]=s("div",{class:"subsection-title"},"æ—‹è½¬",-1)),s("div",rn,[j[8]||(j[8]=s("label",null,"Yaw (Yè½´)",-1)),s("input",{type:"number",value:v(x).project.cam_yaw,onInput:ve,step:"5"},null,40,cn)]),s("div",ln,[j[9]||(j[9]=s("label",null,"Pitch (Xè½´)",-1)),s("input",{type:"number",value:v(x).project.cam_pitch,onInput:ae,step:"5"},null,40,un)]),s("div",mn,[j[10]||(j[10]=s("label",null,"Roll (Zè½´)",-1)),s("input",{type:"number",value:v(x).project.cam_roll,onInput:re,step:"5"},null,40,pn)]),j[14]||(j[14]=s("div",{class:"subsection-title"},"æŠ•å½±",-1)),s("div",dn,[j[11]||(j[11]=s("label",null,"FOV",-1)),s("input",{type:"number",value:v(x).project.cam_fov,onInput:ce,min:"1",max:"179",step:"5"},null,40,fn)])],64)):mt("",!0)]))}}),hn=ua(yn,[["__scopeId","data-v-8f5efc89"]]),vn={class:"ae-timeline-root"},gn={class:"ae-header"},_n={class:"header-center"},bn={class:"project-info"},wn={class:"header-right"},xn={class:"project-inputs"},kn={class:"project-field"},jn=["value"],Pn={class:"project-field"},Mn=["value"],Cn={class:"project-field"},Tn=["value"],Ln={class:"project-field"},In=["value"],En={class:"project-field pano-field"},Sn={class:"hdr-toggle"},zn={class:"hdr-toggle cam-enable"},Xn={class:"cam-row"},Yn=["value"],Fn=["value"],Dn=["value"],Rn=["value"],Un={class:"cam-row cam-row-3d"},$n=["value"],An=["value"],Kn=["value"],Gn={class:"ae-main"},Vn={class:"ae-inspector"},On={key:0,class:"inspector-card"},Nn={class:"card-header"},Wn={class:"layer-title"},Bn={class:"card-subtitle"},Zn={key:1,class:"inspector-card empty"},qn={key:2,class:"inspector-section"},Hn={class:"property-list"},Jn={class:"property-row"},Qn=["value"],eo={class:"property-row"},to=["value"],ao={class:"property-row"},no=["value"],oo={class:"property-row"},so=["value"],ro={class:"property-row"},co=["value"],io={class:"property-row"},lo=["value"],uo={class:"property-row"},mo=["value"],po={class:"property-row slider-row"},fo={class:"slider-header"},yo={class:"prop-value"},ho=["value"],vo={class:"inspector-section"},go={class:"tools-grid"},_o=["disabled"],bo={key:0,class:"tool-settings"},wo={class:"slider-header"},xo={class:"prop-value"},ko={key:1,class:"tool-settings"},jo={class:"slider-header"},Po={class:"prop-value"},Mo={class:"inspector-section"},Co={class:"inspector-section"},To={class:"fit-row"},Lo={class:"ae-viewport"},Io={class:"viewport-bar"},Eo={class:"duration-text"},So={class:"viewport-actions"},zo={class:"time-text"},Xo={class:"zoom-control"},Yo={class:"prop-value"},Fo={class:"viewport-canvas"},Do={class:"ae-timeline"},Ro={class:"timeline-controls"},Uo={class:"controls-left"},$o=["disabled"],Ao=["disabled"],Ko={class:"controls-center"},Go={class:"time-display"},Vo={class:"playback-btns"},Oo={class:"timeline-body"},No={class:"layers-panel"},Wo={class:"layers-header"},Bo=["onClick"],Zo=["onClick"],qo={class:"layer-name"},Ho={class:"layer-btns"},Jo=["onClick"],Qo=["onClick"],es={class:"tick-text"},ts=["title","onMousedown","onContextmenu"],as=["onClick"],ns=["onClick"],os=["onDblclick"],ss=["title","onMousedown","onClick","onContextmenu"],Lt=80,rs=la({__name:"TimelineApp",props:{node:{}},setup(B){const x=B,e=ma(),$=W(null),te=W(),ue=W(),K=W(),Ae=W(0);let De="foreground",Ke=!1,ve=null;const ae=r=>{var a,o;return(o=(a=x.node)==null?void 0:a.widgets)==null?void 0:o.find(m=>m.name===r)};function re(r,a){const o=typeof r=="number"?r:parseFloat(r);return Number.isFinite(o)?o:a}const ce=W("fit"),I=W(100),j=ye(()=>Math.max(.1,I.value/100)),S=ye({get:()=>!!e.project.cam_enable,set:r=>{e.setProject({cam_enable:r}),V("cam_enable",r?1:0)}}),Me=ye({get:()=>e.project.pano_enable,set:r=>{e.setProject({pano_enable:r}),V("pano_enable",r?1:0)}}),Ze=ye({get:()=>e.project.cam_yaw,set:r=>{const a=Number.isFinite(r)?r:e.project.cam_yaw;e.setProject({cam_yaw:a}),V("cam_yaw",a)}}),qe=ye({get:()=>e.project.cam_pitch,set:r=>{const a=Number.isFinite(r)?r:e.project.cam_pitch;e.setProject({cam_pitch:a}),V("cam_pitch",a)}}),Ce=ye({get:()=>e.project.cam_roll,set:r=>{const a=Number.isFinite(r)?r:e.project.cam_roll;e.setProject({cam_roll:a}),V("cam_roll",a)}}),Oe=ye({get:()=>e.project.cam_fov,set:r=>{const a=Number.isFinite(r)?r:e.project.cam_fov,o=Math.min(170,Math.max(10,a));e.setProject({cam_fov:o}),V("cam_fov",o)}}),Te=ye({get:()=>e.project.cam_pos_x||0,set:r=>{const a=Number.isFinite(r)?r:e.project.cam_pos_x||0;e.setProject({cam_pos_x:a}),V("cam_pos_x",a)}}),Re=ye({get:()=>e.project.cam_pos_y||0,set:r=>{const a=Number.isFinite(r)?r:e.project.cam_pos_y||0;e.setProject({cam_pos_y:a}),V("cam_pos_y",a)}}),ge=ye({get:()=>e.project.cam_pos_z||0,set:r=>{const a=Number.isFinite(r)?r:e.project.cam_pos_z||0;e.setProject({cam_pos_z:a}),V("cam_pos_z",a)}});function Ee(r){var a;if(r.code==="Space"){const o=(a=r.target)==null?void 0:a.tagName;if(o==="INPUT"||o==="TEXTAREA"||o==="SELECT")return;r.preventDefault(),r.stopPropagation(),e.togglePlayback()}}const H=ye(()=>{const r=Math.max(1,e.project.fps||1);return e.project.duration||e.project.total_frames/r||0}),J=ye(()=>{var m;const r=Math.max(.001,H.value||0),a=Ae.value||((m=K.value)==null?void 0:m.clientWidth)||0,o=a?a/r:Lt;return Math.max(Lt,o)}),G=ye(()=>{var y;const o=H.value*J.value+120,m=Ae.value||((y=K.value)==null?void 0:y.clientWidth)||0;return Math.max(o,m,800)});It(()=>e.extractMode.enabled,r=>{var a,o;r||(o=(a=$.value)==null?void 0:a.clearExtractSelection)==null||o.call(a)});function Se(){var y;if(!K.value){setTimeout(Se,100);return}const r=K.value.getBoundingClientRect(),a=((y=K.value.parentElement)==null?void 0:y.clientWidth)||r.width||0,o=typeof window<"u"?window.innerWidth:a,m=Math.max(a||o,800);m>0&&(Ae.value=m)}ga(()=>{Ot(),Se(),typeof ResizeObserver<"u"&&K.value?(ve=new ResizeObserver(r=>{const a=r[0];a!=null&&a.contentRect&&(Ae.value=a.contentRect.width)}),ve.observe(K.value)):window.addEventListener("resize",Se),window.addEventListener("keydown",Ee,{capture:!0}),window.addEventListener("beforeunload",Ft,{capture:!0})});let Ne=!1,be=null;const ze=W(new Set([0])),Le=W(null),He=[{key:"x",label:"X"},{key:"y",label:"Y"},{key:"z",label:"Z"},{key:"scale",label:"Scl"},{key:"rotation",label:"RotZ"},{key:"rotationX",label:"RotX"},{key:"rotationY",label:"RotY"},{key:"opacity",label:"Op"}],Je=[{key:"cam_yaw",label:"Yaw"},{key:"cam_pitch",label:"Pitch"},{key:"cam_roll",label:"Roll"},{key:"cam_fov",label:"FOV"},{key:"cam_offset_x",label:"OffX"},{key:"cam_offset_y",label:"OffY"},{key:"cam_pos_x",label:"PosX"},{key:"cam_pos_y",label:"PosY"},{key:"cam_pos_z",label:"PosZ"}],d=ye(()=>{const r=e.currentLayer;if(!r)return{x:0,y:0,z:0,scale:1,rotation:0,rotationX:0,rotationY:0,rotationZ:0,opacity:1};const a=e.currentTime,o=r.keyframes||{};return{x:b(o.x,a,r.x||0),y:b(o.y,a,r.y||0),z:b(o.z,a,r.z||0),scale:b(o.scale,a,r.scale||1),rotation:b(o.rotation,a,r.rotation||0),rotationX:b(o.rotationX,a,r.rotationX||0),rotationY:b(o.rotationY,a,r.rotationY||0),rotationZ:b(o.rotationZ,a,r.rotationZ||r.rotation||0),opacity:b(o.opacity,a,r.opacity??1)}});function b(r,a,o){if(!r||r.length===0)return o;const m=[...r].sort((y,t)=>y.time-t.time);if(a<=m[0].time)return m[0].value;if(a>=m[m.length-1].time)return m[m.length-1].value;for(let y=0;y<m.length-1;y++)if(a>=m[y].time&&a<=m[y+1].time){const t=(a-m[y].time)/(m[y+1].time-m[y].time);return m[y].value+(m[y+1].value-m[y].value)*t}return o}function C(r,a){const o=e.currentLayer;if(!o)return;const m=parseFloat(a.target.value);if(isNaN(m))return;const y=e.currentTime;if(o.keyframes&&o.keyframes[r]&&o.keyframes[r].length>0){const t=o.keyframes[r].findIndex(n=>Math.abs(n.time-y)<.05);t>=0?o.keyframes[r][t]={time:o.keyframes[r][t].time,value:m}:(o.keyframes[r].push({time:y,value:m}),o.keyframes[r].sort((n,c)=>n.time-c.time))}e.updateLayer(e.currentLayerIndex,{[r]:m})}function D(r){const a=e.currentLayer;if(!a)return;const o=parseFloat(r.target.value);if(isNaN(o))return;const m=o/100,y=e.currentTime;if(a.keyframes&&a.keyframes.scale&&a.keyframes.scale.length>0){const t=a.keyframes.scale.findIndex(n=>Math.abs(n.time-y)<.05);t>=0?a.keyframes.scale[t]={time:a.keyframes.scale[t].time,value:m}:(a.keyframes.scale.push({time:y,value:m}),a.keyframes.scale.sort((n,c)=>n.time-c.time))}e.updateLayer(e.currentLayerIndex,{scale:m})}function E(r){const a=Math.floor(r/60),o=Math.floor(r%60),m=Math.floor(r%1*e.project.fps);return`${a.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}`}function P(r,a){return!r.keyframes||!r.keyframes[a]?[]:r.keyframes[a].map(o=>({time:o.time,value:o.value}))}function Ie(r){const a=[];if(!r.keyframes)return a;for(const o of He){const m=r.keyframes[o.key];m&&m.forEach(y=>a.push({time:y.time,prop:o.key}))}return a}function it(){var o;const r=[],a=((o=e.projectKeyframes)==null?void 0:o.value)||e.projectKeyframes||{};return Je.forEach(m=>{const y=a[m.key];Array.isArray(y)&&y.forEach(t=>{typeof(t==null?void 0:t.time)=="number"&&r.push({time:t.time,prop:m.key,value:t.value??0})})}),r}function gt(r,a){return a==="opacity"||a==="scale"?(r*100).toFixed(0)+"%":r.toFixed(1)}function R(r){ze.value.has(r)?ze.value.delete(r):ze.value.add(r)}function $t(r){var a,o;r.hidden=!r.hidden,(o=(a=$.value)==null?void 0:a.scheduleRender)==null||o.call(a)}function _t(r){if(!K.value)return 0;const a=K.value.querySelector(".tracks-content");if(!a)return 0;const o=a.getBoundingClientRect(),m=K.value.scrollLeft,y=r.clientX-o.left+m,t=J.value||Lt;if(y<=10)return 0;const n=y/t;return Math.max(0,Math.min(n,H.value))}function Et(r){r.preventDefault(),Ke=!0,e.setCurrentTime(_t(r));const a=m=>{Ke&&e.setCurrentTime(_t(m))},o=()=>{Ke=!1,document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",o)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",o)}function At(r){if(!e.currentLayer)return;const a=_t(r);e.setCurrentTime(a),e.addKeyframe()}function bt(r,a,o){const y=r.currentTarget.getBoundingClientRect(),t=r.clientX-y.left,n=J.value||Lt,c=Math.max(0,t/n),i=e.layers[a];if(!i)return;const u=i[o]??(o==="scale"||o==="opacity"?1:0);i.keyframes||(i.keyframes={}),i.keyframes[o]||(i.keyframes[o]=[]),i.keyframes[o].find(p=>Math.abs(p.time-c)<.05)||(i.keyframes[o].push({time:c,value:u}),i.keyframes[o].sort((p,f)=>p.time-f.time))}function Qe(r,a,o){Le.value={layerIdx:r,prop:a,time:o},e.selectLayer(r),e.setCurrentTime(o)}function _e(r,a,o){const m=Le.value;return m?m.layerIdx===r&&m.prop===a&&Math.abs(m.time-o)<.01:!1}function Kt(r,a,o,m){r.preventDefault(),Ne=!0,be={layerIdx:a,prop:o,originalTime:m.time},Qe(a,o,m.time);const y=r.clientX,t=m.time,n=J.value||Lt,c=u=>{var g;if(!Ne||!be)return;const p=(u.clientX-y)/n;let f=Math.max(0,t+p);const h=e.layers[be.layerIdx];if((g=h==null?void 0:h.keyframes)!=null&&g[be.prop]){const _=h.keyframes[be.prop],k=_.findIndex(w=>Math.abs(w.time-be.originalTime)<.01);k>=0&&(_[k].time=f,be.originalTime=f,Le.value.time=f,e.setCurrentTime(f))}},i=()=>{var l;Ne=!1,be=null,document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",i);const u=e.layers[a];(l=u==null?void 0:u.keyframes)!=null&&l[o]&&u.keyframes[o].sort((p,f)=>p.time-f.time)};document.addEventListener("mousemove",c),document.addEventListener("mouseup",i)}function we(r,a,o){var y,t,n,c;const m=e.layers[r];(y=m==null?void 0:m.keyframes)!=null&&y[a]&&(m.keyframes[a]=m.keyframes[a].filter(i=>Math.abs(i.time-o)>.01),((t=Le.value)==null?void 0:t.layerIdx)===r&&((n=Le.value)==null?void 0:n.prop)===a&&Math.abs(((c=Le.value)==null?void 0:c.time)-o)<.01&&(Le.value=null))}function Gt(r){if(K.value){const a=r.target,o=K.value.querySelector(".tracks-list");o&&(o.scrollTop=a.scrollTop)}}function Vt(r){const a=r.target,o=document.querySelector(".layers-list");o&&(o.scrollTop=a.scrollTop)}function Ot(){var M,L,z,Y,F,O,me,he,oe,ie,se,pe,A,U,Q,X;if(!((M=x.node)!=null&&M.widgets))return;const r=re((L=ae("width"))==null?void 0:L.value,e.project.width),a=re((z=ae("height"))==null?void 0:z.value,e.project.height),o=Math.max(1,re((Y=ae("fps"))==null?void 0:Y.value,e.project.fps)),m=Math.max(1,Math.round(re((F=ae("total_frames"))==null?void 0:F.value,e.project.total_frames))),y=re((O=ae("mask_expansion"))==null?void 0:O.value,e.project.mask_expansion),t=re((me=ae("mask_feather"))==null?void 0:me.value,e.project.mask_feather),n=!!re((he=ae("pano_enable"))==null?void 0:he.value,e.project.pano_enable?1:0),c=re((oe=ae("cam_yaw"))==null?void 0:oe.value,e.project.cam_yaw),i=re((ie=ae("cam_pitch"))==null?void 0:ie.value,e.project.cam_pitch),u=re((se=ae("cam_roll"))==null?void 0:se.value,e.project.cam_roll),l=re((pe=ae("cam_fov"))==null?void 0:pe.value,e.project.cam_fov),p=re((A=ae("cam_pos_x"))==null?void 0:A.value,e.project.cam_pos_x||0),f=re((U=ae("cam_pos_y"))==null?void 0:U.value,e.project.cam_pos_y||0),h=re((Q=ae("cam_pos_z"))==null?void 0:Q.value,e.project.cam_pos_z||0);let g=[];const _=(X=ae("layers_keyframes"))==null?void 0:X.value;let k={};if(typeof _=="string"&&_.trim())try{const T=JSON.parse(_);Array.isArray(T)?g=T:T&&typeof T=="object"&&(Array.isArray(T.layers)&&(g=T.layers),T.project_keyframes&&typeof T.project_keyframes=="object"&&(k=T.project_keyframes))}catch(T){console.warn("[AE Timeline] Failed to parse layers_keyframes widget",T)}else Array.isArray(_)&&(g=_);const w={width:r,height:a,fps:o,total_frames:m,duration:m/o,mask_expansion:y,mask_feather:t,pano_enable:n,cam_yaw:c,cam_pitch:i,cam_roll:u,cam_fov:l,cam_pos_x:p,cam_pos_y:f,cam_pos_z:h};e.loadAnimation({project:w,layers:g}),e.projectKeyframes.value=k,e.layers.length>0&&e.currentLayerIndex<0&&e.selectLayer(0)}function St(r,a){return r.name?r.name:r.type==="background"?"Background":`Layer ${a+1}`}function Nt(){const r=e.exportAnimation(),a=new Blob([JSON.stringify(r,null,2)],{type:"application/json"}),o=URL.createObjectURL(a),m=document.createElement("a");m.href=o,m.download=`ae_project_${Date.now()}.json`,m.click(),URL.revokeObjectURL(o)}function Wt(){var r;(r=ue.value)==null||r.click()}function et(r){var m;const a=(m=r.target.files)==null?void 0:m[0];if(!a)return;const o=new FileReader;o.onload=y=>{var t;try{const n=JSON.parse((t=y.target)==null?void 0:t.result);e.loadAnimation(n),console.log("Project loaded successfully")}catch(n){console.error("Failed to parse project file",n),alert("Project file is corrupted or has invalid format")}},o.readAsText(a),ue.value&&(ue.value.value="")}function V(r,a){const m=(y=>{var t,n;return(n=(t=x.node)==null?void 0:t.widgets)==null?void 0:n.find(c=>c.name===y)})(r);m&&(m.value=a,m.inputEl&&(m.inputEl.value=a,m.inputEl.dispatchEvent(new Event("input"))),m.callback&&m.callback(a))}function pt(r,a){const o=parseInt(a.target.value,10);if(Number.isNaN(o))return;let m=o;r==="fps"&&(m=Math.max(1,m)),r==="total_frames"&&(m=Math.max(1,m)),(r==="width"||r==="height")&&(m=Math.max(16,m)),e.setProject({[r]:m}),V(r,m),e.setCurrentTime(e.currentTime)}function tt(){var m,y,t,n,c;if(!((m=x.node)!=null&&m.widgets)){console.error("[AE Timeline] Node or widgets not found!");return}console.log("[AE Timeline] Saving..."),e.layers.forEach(i=>{i.maskCanvas&&(i.customMask=i.maskCanvas.toDataURL(),console.log(`[AE Timeline] Layer ${i.id}: Saved mask (len=${i.customMask.length})`))});const r=e.exportAnimation();r.layers.forEach(i=>{i.bezierPath&&i.bezierPath.length>0&&console.log(`[AE Timeline] Layer ${i.id}: Exporting Path with ${i.bezierPath.length} points`)});const o=(i=>x.node.widgets.find(u=>u.name===i))("layers_keyframes");if(o){const i=JSON.stringify({layers:r.layers,project_keyframes:e.projectKeyframes,project:r.project});if(o.value=i,console.log(`[AE Timeline] Saved layers_keyframes (len=${i.length})`),o.inputEl&&(o.inputEl.value=i,o.inputEl.dispatchEvent(new Event("input"))),o.callback&&o.callback(i),x.node.widgets_values){const u=x.node.widgets.indexOf(o);u>=0&&(x.node.widgets_values[u]=i)}(t=(y=x.node).setDirtyCanvas)==null||t.call(y,!0,!1)}else console.error("[AE Timeline] Widget layers_keyframes not found!");V("width",e.project.width),V("height",e.project.height),V("fps",e.project.fps),V("total_frames",e.project.total_frames),V("pano_enable",e.project.pano_enable?1:0),V("cam_yaw",e.project.cam_yaw),V("cam_pitch",e.project.cam_pitch),V("cam_roll",e.project.cam_roll),V("cam_fov",e.project.cam_fov),V("cam_pos_x",e.project.cam_pos_x||0),V("cam_pos_y",e.project.cam_pos_y||0),V("cam_pos_z",e.project.cam_pos_z||0),V("cam_pos_x",e.project.cam_pos_x||0),V("cam_pos_y",e.project.cam_pos_y||0),V("cam_pos_z",e.project.cam_pos_z||0),(c=(n=x.node).setDirtyCanvas)==null||c.call(n,!0,!1)}function Bt(){tt();const r=document.querySelector(".ae-timeline-dialog");r&&r.close()}function Zt(){e.addKeyframe()}function zt(){e.deleteKeyframe()}function wt(){e.setCurrentTime(0)}function ne(){e.setCurrentTime(H.value)}function ee(){const r=e.currentTime,a=e.project,o=e.setProjectKeyframe;o&&Je.forEach(m=>{const y=a[m.key]??0;o(m.key,r,y)})}function Xe(){const r=e.currentTime,a=e.deleteProjectKeyframe;a&&Je.forEach(o=>a(o.key,r))}function dt(r,a){var o;(o=e.deleteProjectKeyframe)==null||o.call(e,r,a)}function at(r,a){const o=r.clientX,m=a.time,y=n=>{var p;const i=(n.clientX-o)/J.value,u=Math.max(0,m+i),l=a.value??e.project[a.prop]??0;(p=e.setProjectKeyframe)==null||p.call(e,a.prop,u,l)},t=()=>{window.removeEventListener("mousemove",y),window.removeEventListener("mouseup",t)};window.addEventListener("mousemove",y),window.addEventListener("mouseup",t)}function Xt(){}function nt(){var r;e.currentLayer&&confirm("Clear all keyframes on this layer?")&&((r=e.clearAllKeyframes)==null||r.call(e))}function qt(){e.layers.forEach((r,a)=>{a!==e.currentLayerIndex&&(r._cachedImage&&delete r._cachedImage,console.log(`[AE Timeline] Cleared cache for layer ${r.id}`))})}function Ht(){var r,a;(a=(r=$.value)==null?void 0:r.scheduleRender)==null||a.call(r),console.log("[AE Timeline] Preview refreshed")}function fe(){var r,a;x.node&&x.node.graph&&window.app&&((a=(r=window.app).queuePrompt)==null||a.call(r,0))}function ft(r){var y,t;const a={mask:e.maskMode,path:e.pathMode,extract:e.extractMode},o=a[r],m=!o.enabled;if(r==="extract"&&m&&!e.layers.find(c=>c.type==="background")){alert("Add a background layer before using extract");return}Object.entries(a).forEach(([n,c])=>{n!==r&&(c.enabled=!1)}),(!m||r!=="extract")&&((t=(y=$.value)==null?void 0:y.clearExtractSelection)==null||t.call(y)),o.enabled=m}function Yt(){var r,a;(a=(r=$.value)==null?void 0:r.clearExtractSelection)==null||a.call(r)}function xt(){var y,t;const r=$.value;if(!r||typeof r.applyExtractSelection!="function")return;const a=r.applyExtractSelection();if(!a){alert("Draw an extract selection first");return}if("error"in a){alert(a.error);return}const o=new Image;o.onload=()=>{const n=e.layers.filter(c=>{var i;return(i=c.id)==null?void 0:i.startsWith("extracted_")}).length;e.addLayer({id:`extracted_${Date.now()}`,name:`Extract ${n+1}`,type:"foreground",image_data:a.foregroundDataUrl,img:o,x:0,y:0,scale:1,rotation:0,opacity:1,mask_size:0,keyframes:{}})},o.src=a.foregroundDataUrl;const m=e.layers.find(n=>n.type==="background");if(m&&a.backgroundDataUrl){const n=new Image;n.onload=()=>{m.image_data=a.backgroundDataUrl,m.img=n,e.updateLayer(e.layers.indexOf(m),{image_data:a.backgroundDataUrl})},n.src=a.backgroundDataUrl}e.extractMode.enabled=!1,(t=(y=$.value)==null?void 0:y.clearExtractSelection)==null||t.call(y)}function Ft(){try{tt()}catch(r){console.warn("[AE Timeline] autosave failed",r)}}function Jt(){var r;De="foreground",(r=te.value)==null||r.click()}function Qt(){var r;De="background",(r=te.value)==null||r.click()}function ea(r){const a=r.target.files;a&&(Array.from(a).forEach((o,m)=>{const y=new FileReader;y.onload=t=>{var i;const n=(i=t.target)==null?void 0:i.result,c=new Image;c.onload=()=>{e.addLayer({id:"uploaded_"+Date.now()+"_"+m,name:o.name.replace(/\.[^/.]+$/,""),type:De,image_data:n,img:c,x:0,y:0,scale:1,rotation:0,opacity:1,mask_size:0,keyframes:{},bg_mode:"fit"})},c.src=n},y.readAsDataURL(o)}),te.value&&(te.value.value=""))}function ta(){Dt(-1)}function aa(){Dt(1)}function Dt(r){const a=e.currentLayerIndex;if(a<0)return;const o=a+r;if(o>=0&&o<e.layers.length){const m=e.layers[a];e.layers.splice(a,1),e.layers.splice(o,0,m),e.selectLayer(o)}}return La(()=>{ve&&K.value&&(ve.disconnect(),ve=null),window.removeEventListener("resize",Se),window.removeEventListener("keydown",Ee,{capture:!0}),tt()}),(r,a)=>(q(),Z("div",vn,[s("header",gn,[s("div",{class:"header-left"},[a[31]||(a[31]=s("div",{class:"logo"},[s("div",{class:"logo-icon"},"AE"),s("span",{class:"logo-text"},"AE Animator")],-1)),a[32]||(a[32]=s("div",{class:"header-divider"},null,-1)),s("button",{class:"btn btn-ghost",onClick:Nt,title:"ä¿å­˜å·¥ç¨‹æ–‡ä»¶"},"Save"),s("button",{class:"btn btn-ghost",onClick:Wt,title:"åŠ è½½å·¥ç¨‹æ–‡ä»¶"},"Load")]),s("div",_n,[s("span",bn,N(v(e).project.width)+"x"+N(v(e).project.height)+" @ "+N(v(e).project.fps)+" FPS",1)]),s("div",wn,[s("div",xn,[s("div",kn,[a[33]||(a[33]=s("span",{class:"field-label"},"W",-1)),s("input",{type:"number",min:"16",max:"8192",value:v(e).project.width,onInput:a[0]||(a[0]=o=>pt("width",o))},null,40,jn)]),s("div",Pn,[a[34]||(a[34]=s("span",{class:"field-label"},"H",-1)),s("input",{type:"number",min:"16",max:"8192",value:v(e).project.height,onInput:a[1]||(a[1]=o=>pt("height",o))},null,40,Mn)]),s("div",Cn,[a[35]||(a[35]=s("span",{class:"field-label"},"FPS",-1)),s("input",{type:"number",min:"1",max:"240",value:v(e).project.fps,onInput:a[2]||(a[2]=o=>pt("fps",o))},null,40,Tn)]),s("div",Ln,[a[36]||(a[36]=s("span",{class:"field-label"},"Frames",-1)),s("input",{type:"number",min:"1",value:v(e).project.total_frames,onInput:a[3]||(a[3]=o=>pt("total_frames",o))},null,40,In)]),s("div",En,[s("label",Sn,[ct(s("input",{type:"checkbox","onUpdate:modelValue":a[4]||(a[4]=o=>Me.value=o)},null,512),[[ha,Me.value]]),a[37]||(a[37]=s("span",null,"Pano",-1))]),s("label",zn,[ct(s("input",{type:"checkbox","onUpdate:modelValue":a[5]||(a[5]=o=>S.value=o)},null,512),[[ha,S.value]]),a[38]||(a[38]=s("span",null,"Cam",-1))]),s("div",Xn,[s("input",{type:"number",step:"1",value:Ze.value,onInput:a[6]||(a[6]=o=>Ze.value=parseFloat(o.target.value)),title:"Yaw"},null,40,Yn),s("input",{type:"number",step:"1",value:qe.value,onInput:a[7]||(a[7]=o=>qe.value=parseFloat(o.target.value)),title:"Pitch"},null,40,Fn),s("input",{type:"number",step:"1",value:Ce.value,onInput:a[8]||(a[8]=o=>Ce.value=parseFloat(o.target.value)),title:"Roll"},null,40,Dn),s("input",{type:"number",step:"1",min:"10",max:"170",value:Oe.value,onInput:a[9]||(a[9]=o=>Oe.value=parseFloat(o.target.value)),title:"FOV"},null,40,Rn)]),s("div",Un,[s("input",{type:"number",step:"1",value:Te.value,onInput:a[10]||(a[10]=o=>Te.value=parseFloat(o.target.value)),title:"Pos X"},null,40,$n),s("input",{type:"number",step:"1",value:Re.value,onInput:a[11]||(a[11]=o=>Re.value=parseFloat(o.target.value)),title:"Pos Y"},null,40,An),s("input",{type:"number",step:"1",value:ge.value,onInput:a[12]||(a[12]=o=>ge.value=parseFloat(o.target.value)),title:"Pos Z"},null,40,Kn)])])]),s("button",{class:"btn btn-primary",onClick:Jt},"+ FG Layer"),s("button",{class:"btn btn-secondary",onClick:Qt},"+ BG Layer"),a[39]||(a[39]=s("div",{class:"header-divider"},null,-1)),s("button",{class:"btn btn-accent",onClick:tt,title:"ä¿å­˜åˆ°èŠ‚ç‚¹"},"Save"),s("button",{class:"btn btn-close",onClick:Bt,title:"å…³é—­"},"Close")])]),s("div",Gn,[s("aside",Vn,[v(e).currentLayer?(q(),Z("div",On,[s("div",Nn,[s("span",Wn,N(St(v(e).currentLayer,v(e).currentLayerIndex)),1),s("span",{class:Pe(["layer-badge",v(e).currentLayer.type])},N(v(e).currentLayer.type==="background"?"BG":"FG"),3)]),s("div",Bn," Layer "+N(v(e).currentLayerIndex+1)+" - "+N(v(e).currentLayer.type==="background"?"Background":"Foreground"),1)])):(q(),Z("div",Zn,[...a[40]||(a[40]=[s("span",null,"è¯·é€‰æ‹©ä¸€ä¸ªå›¾å±‚",-1)])])),v(e).currentLayer?(q(),Z("div",qn,[a[53]||(a[53]=s("div",{class:"section-title"},"Transform",-1)),s("div",Hn,[s("div",Jn,[a[41]||(a[41]=s("span",{class:"prop-label"},"Position X",-1)),s("input",{type:"number",class:"prop-input",value:d.value.x.toFixed(0),onInput:a[13]||(a[13]=o=>C("x",o)),step:"1"},null,40,Qn)]),s("div",eo,[a[42]||(a[42]=s("span",{class:"prop-label"},"Position Y",-1)),s("input",{type:"number",class:"prop-input",value:d.value.y.toFixed(0),onInput:a[14]||(a[14]=o=>C("y",o)),step:"1"},null,40,to)]),s("div",ao,[a[43]||(a[43]=s("span",{class:"prop-label"},"Position Z",-1)),s("input",{type:"number",class:"prop-input",value:d.value.z.toFixed(0),onInput:a[15]||(a[15]=o=>C("z",o)),step:"1"},null,40,no)]),s("div",oo,[a[44]||(a[44]=s("span",{class:"prop-label"},"Scale",-1)),s("input",{type:"number",class:"prop-input",value:(d.value.scale*100).toFixed(0),onInput:a[16]||(a[16]=o=>D(o)),step:"1"},null,40,so),a[45]||(a[45]=s("span",{class:"prop-unit"},"%",-1))]),s("div",ro,[a[46]||(a[46]=s("span",{class:"prop-label"},"Rot X",-1)),s("input",{type:"number",class:"prop-input",value:d.value.rotationX.toFixed(0),onInput:a[17]||(a[17]=o=>C("rotationX",o)),step:"1"},null,40,co),a[47]||(a[47]=s("span",{class:"prop-unit"},"deg",-1))]),s("div",io,[a[48]||(a[48]=s("span",{class:"prop-label"},"Rot Y",-1)),s("input",{type:"number",class:"prop-input",value:d.value.rotationY.toFixed(0),onInput:a[18]||(a[18]=o=>C("rotationY",o)),step:"1"},null,40,lo),a[49]||(a[49]=s("span",{class:"prop-unit"},"deg",-1))]),s("div",uo,[a[50]||(a[50]=s("span",{class:"prop-label"},"Rot Z",-1)),s("input",{type:"number",class:"prop-input",value:d.value.rotation.toFixed(0),onInput:a[19]||(a[19]=o=>C("rotation",o)),step:"1"},null,40,mo),a[51]||(a[51]=s("span",{class:"prop-unit"},"deg",-1))]),s("div",po,[s("div",fo,[a[52]||(a[52]=s("span",{class:"prop-label"},"Opacity",-1)),s("span",yo,N((d.value.opacity*100).toFixed(0))+"%",1)]),s("input",{type:"range",class:"prop-slider",value:d.value.opacity,onInput:a[20]||(a[20]=o=>C("opacity",o)),min:"0",max:"1",step:"0.01"},null,40,ho)])])])):mt("",!0),s("div",vo,[a[56]||(a[56]=s("div",{class:"section-title"},"Tools",-1)),s("div",go,[s("button",{class:Pe(["tool-btn",{active:v(e).maskMode.enabled}]),onClick:a[21]||(a[21]=o=>ft("mask"))},"Mask Mode",2),s("button",{class:Pe(["tool-btn",{active:v(e).maskMode.enabled&&v(e).maskMode.erase}]),onClick:a[22]||(a[22]=o=>v(e).maskMode.erase=!v(e).maskMode.erase),disabled:!v(e).maskMode.enabled},"Eraser",10,_o),s("button",{class:Pe(["tool-btn",{active:v(e).pathMode.enabled}]),onClick:a[23]||(a[23]=o=>ft("path"))},"Path Tool",2),s("button",{class:Pe(["tool-btn",{active:v(e).extractMode.enabled}]),onClick:a[24]||(a[24]=o=>ft("extract"))},"AI Extract",2)]),v(e).maskMode.enabled?(q(),Z("div",bo,[s("div",wo,[a[54]||(a[54]=s("span",{class:"prop-label"},"Brush Size",-1)),s("span",xo,N(v(e).maskMode.brush)+"px",1)]),ct(s("input",{type:"range",class:"prop-slider","onUpdate:modelValue":a[25]||(a[25]=o=>v(e).maskMode.brush=o),min:"1",max:"100",step:"1"},null,512),[[ca,v(e).maskMode.brush,void 0,{number:!0}]])])):mt("",!0),v(e).extractMode.enabled?(q(),Z("div",ko,[s("div",jo,[a[55]||(a[55]=s("span",{class:"prop-label"},"Brush Size",-1)),s("span",Po,N(v(e).extractMode.brush)+"px",1)]),ct(s("input",{type:"range",class:"prop-slider","onUpdate:modelValue":a[26]||(a[26]=o=>v(e).extractMode.brush=o),min:"5",max:"150",step:"1"},null,512),[[ca,v(e).extractMode.brush,void 0,{number:!0}]]),s("div",{class:"extract-actions"},[s("button",{class:"btn btn-small btn-primary",onClick:xt},"Apply"),s("button",{class:"btn btn-small btn-ghost",onClick:Yt},"Clear")])])):mt("",!0)]),s("div",Mo,[va(hn)]),s("div",Co,[a[59]||(a[59]=s("div",{class:"section-title"},"Actions",-1)),s("div",{class:"action-row"},[s("button",{class:"btn btn-small btn-ghost",onClick:qt},"Clear Cache"),s("button",{class:"btn btn-small btn-ghost",onClick:Ht},"Refresh"),s("button",{class:"btn btn-small btn-accent",onClick:fe},"Run")]),s("div",To,[a[58]||(a[58]=s("span",{class:"prop-label"},"Fit Mode",-1)),ct(s("select",{class:"fit-select","onUpdate:modelValue":a[27]||(a[27]=o=>ce.value=o)},[...a[57]||(a[57]=[s("option",{value:"fit"},"Fit",-1),s("option",{value:"fill"},"Fill",-1),s("option",{value:"stretch"},"Stretch",-1)])],512),[[Ia,ce.value]])])])]),s("main",Lo,[s("div",Io,[s("span",Eo,"Duration: "+N(E(H.value)),1),s("div",So,[s("span",zo,N(E(v(e).currentTime)),1),s("div",Xo,[a[60]||(a[60]=s("span",{class:"prop-label"},"Zoom",-1)),ct(s("input",{type:"range",min:"25",max:"200",step:"5","onUpdate:modelValue":a[28]||(a[28]=o=>I.value=o)},null,512),[[ca,I.value,void 0,{number:!0}]]),s("span",Yo,N(I.value)+"%",1)])])]),s("div",Fo,[s("div",{class:"canvas-zoom",style:Ve({transform:`scale(${j.value})`})},[va(Ka,{ref_key:"canvasPreviewRef",ref:$,fitMode:ce.value},null,8,["fitMode"])],4)])])]),s("footer",Do,[s("div",Ro,[s("div",Uo,[s("button",{class:"btn btn-small btn-ghost",onClick:Zt},"+ Keyframe"),s("button",{class:"btn btn-small btn-ghost",onClick:zt},"Del Key"),s("button",{class:"btn btn-small btn-ghost",onClick:nt},"Clear All"),s("button",{class:"btn btn-small btn-ghost",onClick:ee},"+ Cam KF"),s("button",{class:"btn btn-small btn-ghost",onClick:Xe},"Del Cam KF"),a[61]||(a[61]=s("div",{class:"controls-divider"},null,-1)),s("button",{class:"nav-btn",onClick:ta,disabled:!v(e).currentLayer},"Up",8,$o),s("button",{class:"nav-btn",onClick:aa,disabled:!v(e).currentLayer},"Down",8,Ao)]),s("div",Ko,[s("span",Go,N(E(v(e).currentTime)),1),s("div",Vo,[s("button",{class:"pb-btn",onClick:wt},"|<"),s("button",{class:Pe(["play-btn",{playing:v(e).isPlaying}]),onClick:a[29]||(a[29]=(...o)=>v(e).togglePlayback&&v(e).togglePlayback(...o))},N(v(e).isPlaying?"Pause":"Play"),3),s("button",{class:"pb-btn",onClick:ne},">|")])])]),s("div",Oo,[s("div",No,[s("div",Wo,"Layers ("+N(v(e).layers.length)+")",1),s("div",{class:"layers-list",onScroll:Gt},[a[62]||(a[62]=s("div",{class:"layer-item camera-layer"},[s("span",{class:"expand-icon"}),s("span",{class:"layer-type camera"},"C"),s("span",{class:"layer-name"},"Camera")],-1)),(q(!0),Z(Be,null,ut(v(e).layers,(o,m)=>(q(),Z("div",{key:o.id,class:Pe(["layer-item",{active:m===v(e).currentLayerIndex}]),onClick:y=>v(e).selectLayer(m)},[s("span",{class:"expand-icon",onClick:$e(y=>R(m),["stop"])},N(ze.value.has(m)?"v":">"),9,Zo),s("span",{class:Pe(["layer-type",o.type])},N(o.type==="background"?"B":"F"),3),s("span",qo,N(St(o,m)),1),s("span",Ho,[s("span",{class:Pe(["vis-icon",{off:o.hidden}]),onClick:$e(y=>$t(o),["stop"])},"eye",10,Jo),s("span",{class:"del-icon",onClick:$e(y=>v(e).removeLayer(m),["stop"])},"x",8,Qo)])],10,Bo))),128))],32)]),s("div",{class:"tracks-panel",ref_key:"timelineRef",ref:K},[s("div",{class:"tracks-content",style:Ve({width:G.value+"px"})},[s("div",{class:"ruler",onMousedown:Et},[(q(!0),Z(Be,null,ut(Math.ceil(H.value)+1,o=>(q(),Z("div",{key:o,class:"ruler-tick",style:Ve({left:(o-1)*J.value+"px"})},[s("span",es,N(o-1)+"s",1)],4))),128)),s("div",{class:"playhead-top",style:Ve({left:v(e).currentTime*J.value+"px"})},null,4)],32),s("div",{class:"tracks-list",onDblclick:At,onScroll:Vt},[s("div",{class:"track-row camera-row",onClick:a[30]||(a[30]=o=>void 0)},[s("div",{class:"track-bar camera",style:Ve({width:H.value*J.value+"px"})},[(q(!0),Z(Be,null,ut(it(),o=>(q(),Z("div",{key:`cam-${o.prop}-${o.time}`,class:"mini-kf camera",style:Ve({left:o.time*J.value+"px"}),title:`Camera ${o.prop} @ ${o.time.toFixed(2)}s`,onMousedown:$e(m=>at(m,o),["stop"]),onContextmenu:$e(m=>dt(o.prop,o.time),["prevent"])},null,44,ts))),128)),a[63]||(a[63]=s("span",{class:"track-label"},"Camera",-1))],4)]),(q(!0),Z(Be,null,ut(v(e).layers,(o,m)=>(q(),Z(Be,{key:o.id},[s("div",{class:Pe(["track-row",{active:m===v(e).currentLayerIndex}]),onClick:y=>v(e).selectLayer(m)},[s("div",{class:Pe(["track-bar",o.type]),style:Ve({width:H.value*J.value+"px"})},[ze.value.has(m)?mt("",!0):(q(!0),Z(Be,{key:0},ut(Ie(o),y=>(q(),Z("div",{key:y.time+y.prop,class:"mini-kf",style:Ve({left:y.time*J.value+"px"})},null,4))),128))],6)],10,as),ze.value.has(m)?(q(),Z(Be,{key:0},ut(He,y=>s("div",{key:y.key,class:Pe(["prop-track-row",{active:m===v(e).currentLayerIndex}]),onClick:t=>v(e).selectLayer(m)},[s("div",{class:"prop-track",onDblclick:$e(t=>bt(t,m,y.key),["stop"])},[(q(!0),Z(Be,null,ut(P(o,y.key),t=>(q(),Z("div",{key:t.time,class:Pe(["keyframe-dot",{selected:_e(m,y.key,t.time)}]),style:Ve({left:t.time*J.value+"px"}),title:`${y.label}: ${gt(t.value,y.key)} @ ${t.time.toFixed(2)}s`,onMousedown:$e(n=>Kt(n,m,y.key,t),["stop"]),onClick:$e(n=>Qe(m,y.key,t.time),["stop"]),onContextmenu:$e(n=>we(m,y.key,t.time),["prevent"])},null,46,ss))),128))],40,os)],10,ns)),64)):mt("",!0)],64))),128))],32),s("div",{class:"playhead-line",style:Ve({left:v(e).currentTime*J.value+"px"})},null,4)],4)],512)])]),s("input",{ref_key:"fileInput",ref:te,type:"file",accept:"image/*",multiple:"",style:{display:"none"},onChange:ea},null,544),s("input",{ref_key:"projectInput",ref:ue,type:"file",accept:".json",style:{display:"none"},onChange:et},null,544)]))}}),cs=ua(rs,[["__scopeId","data-v-8b132f63"]]);function is(B,x){const e=Ea(cs,{node:x.node}),$=Sa();return e.use($),e.mount(B),e}window.createTimelineApp=is;
