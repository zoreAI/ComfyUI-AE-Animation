import{d as sa,r as q,c as ie,b as Wt,k as Ht,a as ra,w as At,f as B,h as G,j as s,C as Be,D as Nt,l as ge,u as v,z as tt,E as ia,t as N,_ as Zt,F as Ke,y as ca,G as Bt,q as _e,H as $t,p as Gt,I as la,i as Se,s as et,A as ua,B as ma}from"./assets/_plugin-vue_export-helper.js";function Kt(V){const k=Math.max(1,V.fps||1);return V.duration||V.total_frames/k}const Ut=sa("timeline",()=>{const V=q({width:1280,height:720,fps:30,duration:5,total_frames:150,mask_expansion:0,mask_feather:0,hdr_enable:!1,hdr_exposure:0,pano_enable:!1,cam_enable:!1,cam_yaw:0,cam_pitch:0,cam_roll:0,cam_fov:90,cam_offset_x:0,cam_offset_y:0,cam_pos_x:0,cam_pos_y:0,cam_pos_z:0}),k=q({}),e=q([]),$=q(-1),ae=q(0),fe=q(0),K=q(!1),xe=q({enabled:!1,drawing:!1,erase:!1,brush:20}),Ie=q({enabled:!1,data:null}),Ee=q({enabled:!1,drawing:!1,brush:30,blurType:"gaussian"}),ce=ie(()=>$.value>=0&&$.value<e.value.length?e.value[$.value]:null),U=ie(()=>e.value.filter(u=>u.type==="foreground")),J=ie(()=>e.value.find(u=>u.type==="background"));function se(u){const h=Math.max(1,u.fps??V.value.fps),L=typeof u.duration=="number",R=typeof u.total_frames=="number",T={...V.value,...u,fps:h};L&&!R?T.total_frames=Math.max(1,Math.round((T.duration||0)*h)):R&&!L?(T.total_frames=Math.max(1,Math.round(T.total_frames)),T.duration=T.total_frames/h):(T.total_frames=Math.max(1,Math.round(T.total_frames||T.duration*h)),T.duration=T.duration||T.total_frames/h),Object.assign(V.value,T)}function Y(u,h,L){k.value[u]||(k.value[u]=[]);const R=k.value[u],T=R.find(x=>Math.abs(x.time-h)<.001);T?T.value=L:R.push({time:h,value:L}),R.sort((x,pe)=>x.time-pe.time)}function I(u,h){const L=k.value[u];L&&(k.value[u]=L.filter(R=>Math.abs(R.time-h)>.001))}function A(u,h,L){const R=k.value[u];if(!R||R.length===0)return L;const T=[...R].sort((x,pe)=>x.time-pe.time);if(h<=T[0].time)return T[0].value;if(h>=T[T.length-1].time)return T[T.length-1].value;for(let x=0;x<T.length-1;x++){const pe=T[x],Je=T[x+1];if(h>=pe.time&&h<=Je.time){const at=(h-pe.time)/Math.max(1e-6,Je.time-pe.time);return pe.value+(Je.value-pe.value)*at}}return L}function De(u){e.value.push({z:0,is3D:!1,rotationX:0,rotationY:0,rotationZ:0,scaleX:1,scaleY:1,scaleZ:1,anchorX:0,anchorY:0,perspective:1e3,...u}),$.value=e.value.length-1}function Ae(u){u>=0&&u<e.value.length&&(e.value.splice(u,1),$.value>=e.value.length&&($.value=e.value.length-1))}function We(){e.value=[],$.value=-1}function Ze(u){u>=0&&u<e.value.length&&($.value=u)}function Ue(u,h){u>=0&&u<e.value.length&&Object.assign(e.value[u],h)}function Te(u){const h=Kt(V.value);ae.value=Math.max(0,Math.min(u,h)),fe.value=Math.floor(ae.value*V.value.fps)}function Ge(u){const h=Math.max(1,Math.round(V.value.total_frames||Kt(V.value)*V.value.fps));fe.value=Math.max(0,Math.min(u,h-1)),ae.value=fe.value/V.value.fps}let je=null,ze=0;function ye(){K.value=!K.value,K.value?oe():Xe()}function oe(){je===null&&(ze=performance.now(),He())}function He(){if(!K.value)return;const u=performance.now(),h=(u-ze)/1e3;ze=u;let L=ae.value+h;const R=Kt(V.value);L>=R&&(L=0),Te(L),je=requestAnimationFrame(He)}function Xe(){je!==null&&(cancelAnimationFrame(je),je=null)}function qe(){K.value=!1,Xe(),Te(0)}function be(u){if(!u)return;const h=u.project||{},L=h.fps||V.value.fps||30,R=h.duration??(h.total_frames?h.total_frames/Math.max(1,L):V.value.duration),T=h.total_frames??Math.max(1,Math.round((R||V.value.duration)*L));se({width:h.width||1280,height:h.height||720,fps:L,duration:R,total_frames:T,mask_expansion:h.mask_expansion||0,mask_feather:h.mask_feather||0,hdr_enable:!!h.hdr_enable,hdr_exposure:h.hdr_exposure||0,pano_enable:!!h.pano_enable,cam_enable:h.cam_enable!==void 0?!!h.cam_enable:!!h.pano_enable,cam_yaw:h.cam_yaw||0,cam_pitch:h.cam_pitch||0,cam_roll:h.cam_roll||0,cam_fov:h.cam_fov||90,cam_offset_x:h.cam_offset_x||0,cam_offset_y:h.cam_offset_y||0,cam_pos_x:h.cam_pos_x||0,cam_pos_y:h.cam_pos_y||0,cam_pos_z:h.cam_pos_z||0}),k.value=h.project_keyframes||{},e.value=(u.layers||[]).map(x=>({id:x.id,name:x.name,type:x.type,image_data:x.image_data,x:x.x||0,y:x.y||0,z:x.z||0,scale:x.scale||1,rotation:x.rotation||0,opacity:x.opacity!==void 0?x.opacity:1,is3D:x.is3D||!1,rotationX:x.rotationX||0,rotationY:x.rotationY||0,rotationZ:x.rotationZ||0,scaleX:x.scaleX!==void 0?x.scaleX:x.scale||1,scaleY:x.scaleY!==void 0?x.scaleY:x.scale||1,scaleZ:x.scaleZ!==void 0?x.scaleZ:1,anchorX:x.anchorX||0,anchorY:x.anchorY||0,perspective:x.perspective||1e3,mask_size:x.mask_size||0,customMask:x.customMask,bezierPath:x.bezierPath,usePathAnimation:x.usePathAnimation||!1,keyframes:x.keyframes||{},bg_mode:x.bg_mode||"fit"}))}function D(){const u=ce.value;if(!u)return;const h=["x","y","z","scale","rotation","opacity","mask_size","rotationX","rotationY","rotationZ","scaleX","scaleY","scaleZ","anchorX","anchorY","perspective"];u.keyframes||(u.keyframes={});for(const L of h){let R=u[L];R===void 0&&(L==="scale"||L==="opacity"?R=1:L==="perspective"?R=1e3:R=0),u.keyframes[L]||(u.keyframes[L]=[]),u.keyframes[L]=u.keyframes[L].filter(T=>T.time!==ae.value),u.keyframes[L].push({time:ae.value,value:R}),u.keyframes[L].sort((T,x)=>T.time-x.time)}}function Me(){const u=ce.value;if(!u||!u.keyframes)return;const h=["x","y","z","scale","rotation","opacity","mask_size","rotationX","rotationY","rotationZ","scaleX","scaleY","scaleZ","anchorX","anchorY","perspective"];for(const L of h)u.keyframes[L]&&(u.keyframes[L]=u.keyframes[L].filter(R=>R.time!==ae.value))}function Fe(){const u=ce.value;u&&(u.keyframes={})}function ne(){return{project:{...V.value,project_keyframes:k.value},layers:e.value.map(u=>({id:u.id,name:u.name,type:u.type,image_data:u.image_data,x:u.x,y:u.y,z:u.z||0,scale:u.scale,rotation:u.rotation,opacity:u.opacity,is3D:u.is3D||!1,rotationX:u.rotationX,rotationY:u.rotationY,rotationZ:u.rotationZ,scaleX:u.scaleX,scaleY:u.scaleY,scaleZ:u.scaleZ,anchorX:u.anchorX,anchorY:u.anchorY,perspective:u.perspective,mask_size:u.mask_size,customMask:u.customMask,bezierPath:u.bezierPath,usePathAnimation:u.usePathAnimation,keyframes:u.keyframes,bg_mode:u.bg_mode}))}}return{project:V,layers:e,currentLayerIndex:$,currentTime:ae,currentFrame:fe,isPlaying:K,maskMode:xe,pathMode:Ie,extractMode:Ee,projectKeyframes:k,currentLayer:ce,foregroundLayers:U,backgroundLayer:J,setProject:se,addLayer:De,removeLayer:Ae,clearLayers:We,selectLayer:Ze,updateLayer:Ue,setCurrentTime:Te,setCurrentFrame:Ge,togglePlayback:ye,stopPlayback:qe,addKeyframe:D,deleteKeyframe:Me,clearAllKeyframes:Fe,setProjectKeyframe:Y,deleteProjectKeyframe:I,interpolateProjectValue:A,loadAnimation:be,exportAnimation:ne}}),pa={class:"canvas-wrapper"},da=["width","height"],fa=["width","height"],ya={class:"canvas-info"},va={key:0},ha={key:0,class:"gpu-badge"},_a={key:1},ga=Wt({__name:"CanvasPreview",setup(V,{expose:k}){const e=Ut(),$=q(),ae=q(),fe=q();let K=!1,xe=0,Ie=0,Ee=0,ce=0;const U=q(!1);let J=!1,se=null;const Y=new Map,I=new Map,A={};let De=!1,Ae=!1,We=0,Ze=0,Ue=0,Te=0,Ge=0,je=0,ze=!1,ye=0,oe=0,He=0,Xe=0;Ht(async()=>{$.value&&(se=$.value.getContext("2d",{alpha:!1,desynchronized:!0})),await qe(),D()}),ra(()=>{Y.clear(),be()});async function qe(){console.log("[Timeline GPU] GPU rendering disabled, using Canvas 2D for stability"),U.value=!1}function be(){for(const n of I.values())n.destroy();I.clear()}function D(){J||(J=!0,requestAnimationFrame(()=>{J=!1,L()}))}At(()=>[e.layers,e.currentLayer,e.currentTime],()=>{D()},{deep:!0}),At(()=>e.extractMode.enabled,()=>{nt=!1,D()});function Me(){{R();return}}function Fe(n){if(n.img)return n.img;if(!n.image_data)return null;const r=n.id;if(Y.has(r)){const p=Y.get(r);return p.complete?(n.img=p,p):null}const l=new Image;return l.onload=()=>{n.img=l,D()},l.src=n.image_data,Y.set(r,l),null}function ne(n,r,l){if(!n||n.length===0)return l;const p=[...n].sort((m,c)=>m.time-c.time);if(r<=p[0].time)return p[0].value;if(r>=p[p.length-1].time)return p[p.length-1].value;for(let m=0;m<p.length-1;m++)if(r>=p[m].time&&r<=p[m+1].time){const c=(r-p[m].time)/(p[m+1].time-p[m].time);return p[m].value+(p[m+1].value-p[m].value)*c}return l}function u(n,r,l){if(!n||n.length<2)return null;const p=r/l,c=n.length-1,y=Math.min(Math.floor(p*c),c-1),f=p*c-y,w=n[y],P=n[y+1];if(!w||!P)return null;const C=w.cp2x??w.x+(P.x-w.x)/3,X=w.cp2y??w.y+(P.y-w.y)/3,j=P.cp1x??w.x+(P.x-w.x)*2/3,z=P.cp1y??w.y+(P.y-w.y)*2/3,S=1-f,O=S*S,Q=O*S,o=f*f,t=o*f;return{x:Q*w.x+3*O*f*C+3*S*o*j+t*P.x,y:Q*w.y+3*O*f*X+3*S*o*z+t*P.y}}function h(n){const r=e.currentTime,l=n.keyframes||{};let p=ne(l.x,r,n.x||0),m=ne(l.y,r,n.y||0);if(n.usePathAnimation&&n.bezierPath&&n.bezierPath.length>=2){const c=u(n.bezierPath,r,e.project.duration);c&&(p=c.x,m=c.y)}return{x:p,y:m,z:ne(l.z,r,n.z||0),scale:ne(l.scale,r,n.scale||1),rotation:ne(l.rotation,r,n.rotation||0),opacity:ne(l.opacity,r,n.opacity??1),mask_size:ne(l.mask_size,r,n.mask_size||0),rotationX:ne(l.rotationX,r,n.rotationX||0),rotationY:ne(l.rotationY,r,n.rotationY||0),rotationZ:ne(l.rotationZ,r,n.rotationZ||0),anchorX:ne(l.anchorX,r,n.anchorX||0),anchorY:ne(l.anchorY,r,n.anchorY||0),perspective:ne(l.perspective,r,n.perspective||1e3)}}function L(){if(U.value){Me();return}R()}function R(){var C,X,j,z,S,O;if(!$.value||!se)return;se.fillStyle="#000",se.fillRect(0,0,e.project.width,e.project.height),e.project.pano_enable;const n=!!e.project.cam_enable,r=((C=e.interpolateProjectValue)==null?void 0:C.call(e,"cam_offset_x",e.currentTime,e.project.cam_offset_x||0))??(e.project.cam_offset_x||0),l=((X=e.interpolateProjectValue)==null?void 0:X.call(e,"cam_offset_y",e.currentTime,e.project.cam_offset_y||0))??(e.project.cam_offset_y||0),p=((j=e.interpolateProjectValue)==null?void 0:j.call(e,"cam_pos_x",e.currentTime,e.project.cam_pos_x||0))??(e.project.cam_pos_x||0),m=((z=e.interpolateProjectValue)==null?void 0:z.call(e,"cam_pos_y",e.currentTime,e.project.cam_pos_y||0))??(e.project.cam_pos_y||0),c=((S=e.interpolateProjectValue)==null?void 0:S.call(e,"cam_pos_z",e.currentTime,e.project.cam_pos_z||0))??(e.project.cam_pos_z||0),y=n?Math.max(.2,Math.min(4,1/(1+c*.001))):1,f=n?r+p:r,w=n?l+m:l,P=e.layers.find(Q=>Q.type==="background");P&&pe(se,P,f,w,y,n),e.layers.filter(Q=>Q.type!=="background").forEach(Q=>{Je(se,Q,f,w,n,y)}),e.pathMode.enabled&&((O=e.currentLayer)!=null&&O.bezierPath)&&T(se,e.currentLayer.bezierPath),e.extractMode.enabled&&Tt(se)}function T(n,r){if(!r||r.length===0)return;const l=e.project.width/2,p=e.project.height/2;n.save(),n.strokeStyle="#ff6b6b",n.lineWidth=2,n.setLineDash([5,5]),n.beginPath(),n.moveTo(l+r[0].x,p+r[0].y);for(let m=1;m<r.length;m++){const c=r[m-1],y=r[m],f=c.cp2x??c.x+(y.x-c.x)/3,w=c.cp2y??c.y+(y.y-c.y)/3,P=y.cp1x??c.x+(y.x-c.x)*2/3,C=y.cp1y??c.y+(y.y-c.y)*2/3;n.bezierCurveTo(l+f,p+w,l+P,p+C,l+y.x,p+y.y)}if(n.stroke(),n.setLineDash([]),r.forEach((m,c)=>{n.beginPath(),n.arc(l+m.x,p+m.y,6,0,Math.PI*2),n.fillStyle=c===0?"#4ecdc4":c===r.length-1?"#ff6b6b":"#ffe66d",n.fill(),n.strokeStyle="#fff",n.lineWidth=2,n.stroke()}),r.length>=2){const m=r.length-1,c=r[m-1],y=r[m],f=c.cp2x??c.x+(y.x-c.x)/3,w=c.cp2y??c.y+(y.y-c.y)/3,P=y.cp1x??c.x+(y.x-c.x)*2/3,C=y.cp1y??c.y+(y.y-c.y)*2/3,X=.99,j=1-X,z=3*j*j*(f-c.x)+6*j*X*(P-f)+3*X*X*(y.x-P),S=3*j*j*(w-c.y)+6*j*X*(C-w)+3*X*X*(y.y-C),O=Math.atan2(S,z),Q=l+y.x,o=p+y.y,t=18;n.beginPath(),n.moveTo(Q,o),n.lineTo(Q-t*Math.cos(O-Math.PI/6),o-t*Math.sin(O-Math.PI/6)),n.moveTo(Q,o),n.lineTo(Q-t*Math.cos(O+Math.PI/6),o-t*Math.sin(O+Math.PI/6)),n.strokeStyle="#ff6b6b",n.lineWidth=2,n.stroke()}n.restore()}function x(n,r,l){if(n.maskCanvas||!n.customMask)return;const p=new Image;p.onload=()=>{const m=document.createElement("canvas");m.width=p.width||r,m.height=p.height||l;const c=m.getContext("2d");c&&(c.drawImage(p,0,0,m.width,m.height),n.maskCanvas=m,D())},p.src=n.customMask}function pe(n,r,l=0,p=0,m=1,c=!1){var Q,o,t,a,i,d;const y=Fe(r);if(!y||y.width===0||y.height===0)return;const f=h(r),w=e.project.pano_enable;n.save(),n.globalAlpha=f.opacity;const P=r.bg_mode||"fit",C=e.project.width,X=e.project.height,j=y.width,z=y.height;let S=1;if(w&&j>0&&z>0&&Math.abs(j/z-2)<.35){const _=((Q=e.interpolateProjectValue)==null?void 0:Q.call(e,"cam_yaw",e.currentTime,e.project.cam_yaw||0))??(e.project.cam_yaw||0),b=((o=e.interpolateProjectValue)==null?void 0:o.call(e,"cam_pitch",e.currentTime,e.project.cam_pitch||0))??(e.project.cam_pitch||0),E=((t=e.interpolateProjectValue)==null?void 0:t.call(e,"cam_roll",e.currentTime,e.project.cam_roll||0))??(e.project.cam_roll||0),g=Math.min(170,Math.max(10,((a=e.interpolateProjectValue)==null?void 0:a.call(e,"cam_fov",e.currentTime,e.project.cam_fov||90))??(e.project.cam_fov||90))),M=Math.PI/180,ee=1024;let F=C,Z=X;const le=Math.max(1,Math.max(C,X)/ee);le>1.01&&(F=Math.max(1,Math.round(C/le)),Z=Math.max(1,Math.round(X/le)));const ue=`${F}x${Z}|${j}x${z}|${_}|${b}|${E}|${g}`;if(A.key!==ue){const Re=document.createElement("canvas");Re.width=j,Re.height=z;const Pe=Re.getContext("2d");Pe?(Pe.drawImage(y,0,0,j,z),A.srcData=Pe.getImageData(0,0,j,z).data):A.srcData=void 0;const mt=C/Math.max(1,X),Ce=Math.tan(g*M/2),Ye=Math.cos(_*M),$e=Math.sin(_*M),Le=Math.cos(b*M),he=Math.sin(b*M),Oe=Math.cos(E*M),Ne=Math.sin(E*M),we=[Oe*Ye+Ne*he*$e,Ne*Le,Oe*-$e+Ne*he*Ye,-Ne*Ye+Oe*he*$e,Oe*Le,-Ne*-$e+Oe*he*Ye,Le*$e,-he,Le*Ye],de=new Float32Array(F*Z),Vt=new Float32Array(F*Z);for(let It=0;It<Z;It++){const qt=(It+.5)/Z*2-1;for(let Et=0;Et<F;Et++){let _t=((Et+.5)/F*2-1)*Ce*mt,gt=-qt*Ce,bt=1;const Dt=1/Math.hypot(_t,gt,bt);_t*=Dt,gt*=Dt,bt*=Dt;const Jt=we[0]*_t+we[1]*gt+we[2]*bt,Qt=we[3]*_t+we[4]*gt+we[5]*bt,ea=we[6]*_t+we[7]*gt+we[8]*bt,ta=Math.atan2(Jt,ea),aa=Math.asin(Math.max(-1,Math.min(1,Qt))),na=(ta/(Math.PI*2)+.5)*j,oa=(-aa/Math.PI+.5)*z;let Ft=Math.floor(na)%j;Ft<0&&(Ft+=j);let Rt=Math.floor(oa);Rt=Math.max(0,Math.min(z-1,Rt));const Ot=It*F+Et;de[Ot]=Ft,Vt[Ot]=Rt}}A.key=ue,A.mapX=de,A.mapY=Vt,A.imgW=j,A.imgH=z,A.outW=F,A.outH=Z,A.canvas=document.createElement("canvas"),A.canvas.width=F,A.canvas.height=Z,A.ctx=A.canvas.getContext("2d")}const ve=A.srcData,it=A.mapX,vt=A.mapY,ht=A.canvas,ct=A.ctx,lt=A.outW||0,ut=A.outH||0;if(ve&&it&&vt&&ht&&ct&&lt>0&&ut>0){const Re=ct.getImageData(0,0,lt,ut),Pe=Re.data,mt=lt*ut;for(let Ce=0;Ce<mt;Ce++){const Ye=it[Ce],Le=(vt[Ce]*j+Ye)*4,he=Ce*4;Pe[he]=ve[Le],Pe[he+1]=ve[Le+1],Pe[he+2]=ve[Le+2],Pe[he+3]=255}ct.putImageData(Re,0,0),n.translate(C/2+l*m,X/2+p*m),n.scale(m,m),n.drawImage(ht,-C/2,-X/2,C,X)}else return n.restore(),pe(n,{...r,panoFallback:!0,type:r.type,bg_mode:r.bg_mode},l,p,m,c)}else{j>0&&z>0&&(P==="fit"?S=Math.min(C/j,X/z):P==="fill"?S=Math.max(C/j,X/z):P==="stretch"&&(S=Math.min(C/j,X/z))),(!Number.isFinite(S)||S<=0)&&(S=1);const _=c?((i=e.interpolateProjectValue)==null?void 0:i.call(e,"cam_yaw",e.currentTime,e.project.cam_yaw||0))??(e.project.cam_yaw||0):0,b=c?((d=e.interpolateProjectValue)==null?void 0:d.call(e,"cam_pitch",e.currentTime,e.project.cam_pitch||0))??(e.project.cam_pitch||0):0,E=1/Math.max(.1,1+(f.z||0)*.001),g=c?m:1,M=c?l:0,ee=c?p:0,F=c?E:1;let Z=f.x,le=f.y;if(c&&(_!==0||b!==0)){const ue=_*Math.PI/180,me=b*Math.PI/180,ve=f.z||0;Z-=Math.tan(ue)*(ve+1e3)*.3,le-=Math.tan(me)*(ve+1e3)*.3}n.translate(C/2+(Z+M*F)*g,X/2+(le+ee*F)*g),n.rotate(f.rotation*Math.PI/180),n.scale(f.scale*S*g*E,f.scale*S*g*E),n.drawImage(y,-j/2,-z/2,j,z)}!c&&r===e.currentLayer&&(n.strokeStyle="#3a7bc8",n.lineWidth=2/(f.scale*S),n.strokeRect(-j/2-2,-z/2-2,j+4,z+4)),n.restore()}function Je(n,r,l=0,p=0,m=!1,c=1){var _,b,E;const y=Fe(r);if(!y||y.width===0||y.height===0)return;const f=h(r),w=y.width,P=y.height;x(r,w,P),n.save();const C=m?((_=e.interpolateProjectValue)==null?void 0:_.call(e,"cam_yaw",e.currentTime,e.project.cam_yaw||0))??(e.project.cam_yaw||0):0,X=m?((b=e.interpolateProjectValue)==null?void 0:b.call(e,"cam_pitch",e.currentTime,e.project.cam_pitch||0))??(e.project.cam_pitch||0):0;m&&(((E=e.interpolateProjectValue)==null?void 0:E.call(e,"cam_fov",e.currentTime,e.project.cam_fov||90))??e.project.cam_fov);const j=1/Math.max(.1,1+(f.z||0)*.001),z=m?c:1,S=m?l:0,O=m?p:0,Q=m?j:1;let o=f.x,t=f.y;if(m&&(C!==0||X!==0)){const g=C*Math.PI/180,M=X*Math.PI/180,ee=f.z||0;o-=Math.tan(g)*(ee+500)*.5,t-=Math.tan(M)*(ee+500)*.5}if(n.translate(e.project.width/2+(o+S*Q)*z,e.project.height/2+(t+O*Q)*z),f.rotationX!==0||f.rotationY!==0){const g=f.perspective||1e3,M=f.rotationX*Math.PI/180,ee=f.rotationY*Math.PI/180,F=Math.cos(M),Z=Math.sin(M),le=Math.cos(ee),ue=Math.sin(ee),me=1/(1+(ue*w/2+Z*P/2)/g);n.transform(le*me,Z*ue*me,0,F*me,0,0)}n.rotate(f.rotation*Math.PI/180);const a=f.scale*z*j;n.scale(a,a),n.globalAlpha=f.opacity;const i=(f.anchorX||0)*w,d=(f.anchorY||0)*P;if(r.maskCanvas){const g=document.createElement("canvas");g.width=w,g.height=P;const M=g.getContext("2d");M?(M.clearRect(0,0,w,P),M.drawImage(y,0,0,w,P),M.globalCompositeOperation="destination-in",M.drawImage(r.maskCanvas,0,0,w,P),n.drawImage(g,-w/2-i,-P/2-d,w,P)):n.drawImage(y,-w/2-i,-P/2-d,w,P)}else n.drawImage(y,-w/2-i,-P/2-d,w,P);if(r===e.currentLayer&&r.img){n.strokeStyle="#3a7bc8",n.lineWidth=2/f.scale;const g=r.img.width,M=r.img.height;n.strokeRect(-g/2-2,-M/2-2,g+4,M+4),n.fillStyle="#3a7bc8",[[-g/2,-M/2],[g/2,-M/2],[g/2,M/2],[-g/2,M/2]].forEach(([F,Z])=>{n.fillRect(F-4/f.scale,Z-4/f.scale,8/f.scale,8/f.scale)})}if(f.mask_size>0){n.strokeStyle="#3ac88e",n.lineWidth=2/f.scale,n.setLineDash([5/f.scale,5/f.scale]);const g=r.img?r.img.width:512,M=r.img?r.img.height:512,ee=g*f.mask_size,F=M*f.mask_size;n.strokeRect(-ee/2,-F/2,ee,F),n.setLineDash([])}n.restore()}function at(){return U.value?ae.value||null:$.value||null}function wt(n){const r=at();if(!r)return{x:0,y:0};const l=r.getBoundingClientRect(),p=e.project.width/l.width,m=e.project.height/l.height;return{x:(n.clientX-l.left)*p,y:(n.clientY-l.top)*m}}let pt=!1,H=null,te=null,ke=null,nt=!1,Qe=null,dt=!1,Ve=-1;function xt(n){var y;(y=at())==null||y.focus(),n.shiftKey,n.altKey;const r=wt(n);if(e.project.pano_enable&&!e.maskMode.enabled&&!e.extractMode.enabled&&!e.pathMode.enabled){if(We=r.x,Ze=r.y,Ue=e.project.cam_yaw||0,Te=e.project.cam_pitch||0,Ge=e.project.cam_offset_x||0,je=e.project.cam_offset_y||0,n.button===1||n.button===2){De=!0;return}else if(n.button===0&&(!e.currentLayer||n.altKey)){Ae=!0;return}}if(!!e.project.cam_enable&&!e.project.pano_enable&&!e.maskMode.enabled&&!e.extractMode.enabled&&!e.pathMode.enabled){if(ye=r.x,oe=r.y,He=e.project.cam_pos_x||0,Xe=e.project.cam_pos_y||0,e.project.cam_pos_z,Ue=e.project.cam_yaw||0,Te=e.project.cam_pitch||0,n.button===1||n.button===2){De=!0;return}if(n.button===0&&!e.currentLayer){ze=!0;return}}if(!e.currentLayer)return;if(e.extractMode.enabled){if(!yt()){console.warn("[Timeline] Extract mode requires a background layer with image data");return}nt=!0,Pt(r.x,r.y,n.button===2||n.altKey);return}if(e.maskMode.enabled){pt=!0,Mt(),ft(r.x,r.y);return}if(e.pathMode.enabled){Xt(r);return}K=!0,xe=r.x,Ie=r.y;const c=h(e.currentLayer);Ee=c.x,ce=c.y}function jt(n){var y,f,w,P,C,X;const r=wt(n);if(De){const j=r.x-We,z=r.y-Ze,S=Ue+j*.2,O=Math.max(-89,Math.min(89,Te+z*.2));e.setProject({cam_yaw:S,cam_pitch:O}),(y=e.setProjectKeyframe)==null||y.call(e,"cam_yaw",e.currentTime,S),(f=e.setProjectKeyframe)==null||f.call(e,"cam_pitch",e.currentTime,O),D();return}if(ze){const j=r.x-ye,z=r.y-oe,S=He+j,O=Xe+z;e.setProject({cam_pos_x:S,cam_pos_y:O}),(w=e.setProjectKeyframe)==null||w.call(e,"cam_pos_x",e.currentTime,S),(P=e.setProjectKeyframe)==null||P.call(e,"cam_pos_y",e.currentTime,O),D();return}if(Ae){const j=r.x-We,z=r.y-Ze,S=(Ge||0)+j,O=(je||0)+z;e.setProject({cam_offset_x:S,cam_offset_y:O}),(C=e.setProjectKeyframe)==null||C.call(e,"cam_offset_x",e.currentTime,S),(X=e.setProjectKeyframe)==null||X.call(e,"cam_offset_y",e.currentTime,O),D();return}if(e.extractMode.enabled&&nt){Pt(r.x,r.y,(n.buttons&2)===2||n.altKey);return}if(pt&&e.maskMode.enabled){ft(r.x,r.y);return}if(dt&&Ve>=0){St(r);return}if(!K||!e.currentLayer)return;let l=r.x-xe,p=r.y-Ie;n.shiftKey&&(Math.abs(l)>Math.abs(p)?p=0:l=0);const m=Ee+l,c=ce+p;re(e.currentLayer,"x",m),re(e.currentLayer,"y",c),D()}function re(n,r,l){const p=e.currentTime;if(n.keyframes&&n.keyframes[r]&&n.keyframes[r].length>0){const m=n.keyframes[r].findIndex(c=>Math.abs(c.time-p)<.05);m>=0?n.keyframes[r][m]={time:n.keyframes[r][m].time,value:l}:(n.keyframes[r].push({time:p,value:l}),n.keyframes[r].sort((c,y)=>c.time-y.time))}e.updateLayer(e.currentLayerIndex,{[r]:l})}function Mt(){const n=e.currentLayer;if(!(!n||!n.img)){if(n.maskCanvas)H=n.maskCanvas.getContext("2d");else if(n.maskCanvas=document.createElement("canvas"),n.maskCanvas.width=n.img.width,n.maskCanvas.height=n.img.height,H=n.maskCanvas.getContext("2d"),H)if(n.customMask){const r=new Image;r.onload=()=>{H==null||H.drawImage(r,0,0),D()},r.src=n.customMask}else H.globalCompositeOperation="source-over",H.fillStyle="white",H.fillRect(0,0,n.maskCanvas.width,n.maskCanvas.height)}}function ft(n,r){const l=e.currentLayer;if(!l||((!H||!l.maskCanvas)&&Mt(),!l.img||!H||!l.maskCanvas))return;const p=h(l),m=e.project.width/2+p.x,c=e.project.height/2+p.y,y=(n-m)/p.scale+l.img.width/2,f=(r-c)/p.scale+l.img.height/2,w=e.maskMode.brush||20;H.save(),H.beginPath(),H.arc(y,f,w,0,Math.PI*2),e.maskMode.erase?(H.globalCompositeOperation="source-over",H.fillStyle="white"):(H.globalCompositeOperation="destination-out",H.fillStyle="black"),H.fill(),H.restore(),D()}function yt(){const n=e.layers.find(l=>l.type==="background");if(!n)return null;const r=Fe(n);return r?((!te||!ke||te.width!==r.width||te.height!==r.height||Qe!==n.id)&&(te=document.createElement("canvas"),te.width=r.width,te.height=r.height,ke=te.getContext("2d"),ke&&ke.clearRect(0,0,r.width,r.height),Qe=n.id||null),{layer:n,img:r,ctx:ke}):null}function Pt(n,r,l=!1){const p=yt();if(!p)return;const{layer:m,img:c,ctx:y}=p,f=h(m),w=e.project.width/2+(f.x??0),P=e.project.height/2+(f.y??0),C=f.scale??1,X=(n-w)/C+c.width/2,j=(r-P)/C+c.height/2,z=Math.max(1,e.extractMode.brush||30);y.beginPath(),y.arc(X,j,z,0,Math.PI*2),y.fillStyle=l?"black":"white",y.fill(),D()}function Tt(n){if(!e.extractMode.enabled||!te||!Qe)return;const r=e.layers.find(y=>y.id===Qe);if(!r)return;const l=Fe(r);if(!l)return;const p=h(r);n.save(),n.translate(e.project.width/2+(p.x??0),e.project.height/2+(p.y??0)),n.rotate((p.rotation??0)*Math.PI/180),n.scale(p.scale??1,p.scale??1);const m=-l.width/2,c=-l.height/2;n.fillStyle="rgba(0, 0, 0, 0.65)",n.fillRect(m,c,l.width,l.height),n.globalCompositeOperation="destination-out",n.drawImage(te,m,c,l.width,l.height),n.restore()}function W(){ke&&te&&(ke.clearRect(0,0,te.width,te.height),D())}function ot(){if(!ke||!te)return!1;const n=ke.getImageData(0,0,te.width,te.height).data;for(let r=0;r<n.length;r+=4)if(n[r]>10)return!0;return!1}function st(n,r,l){const p=n.canvas,m=document.createElement("canvas");m.width=r,m.height=l;const c=m.getContext("2d");if(!c)return null;c.drawImage(p,0,0);const y=20;c.globalCompositeOperation="destination-over";for(let f=0;f<y;f++)c.drawImage(m,1,0),c.drawImage(m,-1,0),c.drawImage(m,0,1),c.drawImage(m,0,-1),f%2===0&&(c.drawImage(m,1,1),c.drawImage(m,-1,-1),c.drawImage(m,1,-1),c.drawImage(m,-1,1));for(let f=0;f<10;f++)c.drawImage(m,2,0),c.drawImage(m,-2,0),c.drawImage(m,0,2),c.drawImage(m,0,-2),c.drawImage(m,2,2),c.drawImage(m,-2,-2),c.drawImage(m,2,-2),c.drawImage(m,-2,2);return m.toDataURL("image/png")}function zt(){const n=yt();if(!n||!te||!ke)return{error:"Background layer not ready"};if(!ot())return null;const{img:r}=n,l=document.createElement("canvas");l.width=r.width,l.height=r.height;const p=l.getContext("2d");if(!p)return{error:"Cannot create temporary canvas"};p.drawImage(r,0,0),p.globalCompositeOperation="destination-in",p.drawImage(te,0,0);const m=l.toDataURL("image/png"),c=document.createElement("canvas");c.width=r.width,c.height=r.height;const y=c.getContext("2d");if(!y)return{error:"Cannot create background canvas"};y.drawImage(r,0,0),y.globalCompositeOperation="destination-out",y.drawImage(te,0,0),y.globalCompositeOperation="source-over";const f=st(y,r.width,r.height)||r.src,w=te.toDataURL("image/png");return{foregroundDataUrl:m,backgroundDataUrl:f,extractMaskDataUrl:w}}function Xt(n,r){const l=e.currentLayer;if(!l)return;l.bezierPath||(l.bezierPath=[]);const p=Yt(n);if(p>=0)Ve=p,dt=!0;else{const m=e.project.width/2,c=e.project.height/2;l.bezierPath.push({x:n.x-m,y:n.y-c}),l.bezierPath.length>=2&&(l.usePathAnimation=!0),D()}}function Yt(n){const r=e.currentLayer;if(!r||!r.bezierPath)return-1;const l=e.project.width/2,p=e.project.height/2,m=10;for(let c=0;c<r.bezierPath.length;c++){const y=r.bezierPath[c],f=y.x+l-n.x,w=y.y+p-n.y;if(Math.sqrt(f*f+w*w)<m)return c}return-1}function St(n){const r=e.currentLayer;if(!r||!r.bezierPath||Ve<0)return;const l=e.project.width/2,p=e.project.height/2;r.bezierPath[Ve].x=n.x-l,r.bezierPath[Ve].y=n.y-p,D()}function rt(){K=!1,pt=!1,nt=!1,dt=!1,Ve=-1,De=!1,Ae=!1,ze=!1}function Ct(n){var w,P;const r=n.deltaY>0?-.05:.05;if(e.project.pano_enable&&!e.maskMode.enabled&&!e.extractMode.enabled&&!e.pathMode.enabled&&(!e.currentLayer||n.ctrlKey||n.altKey)){const C=Math.min(170,Math.max(10,(e.project.cam_fov||90)+(r>0?2:-2)));e.setProject({cam_fov:C}),(w=e.setProjectKeyframe)==null||w.call(e,"cam_fov",e.currentTime,C),D();return}if(!!e.project.cam_enable&&!e.project.pano_enable&&!e.maskMode.enabled&&!e.extractMode.enabled&&!e.pathMode.enabled&&!e.currentLayer&&!e.currentLayer){const C=e.project.cam_pos_z||0,X=5,j=C+(r>0?X:-X);e.setProject({cam_pos_z:j}),(P=e.setProjectKeyframe)==null||P.call(e,"cam_pos_z",e.currentTime,j),D();return}if(!e.currentLayer)return;const c=e.currentLayer,y=h(c),f=2;if(n.shiftKey&&!n.ctrlKey&&!n.altKey){const C=y.rotationX+(r>0?f:-f);re(c,"rotationX",C)}else if(n.ctrlKey&&!n.shiftKey&&!n.altKey){const C=y.rotationY+(r>0?f:-f);re(c,"rotationY",C)}else if(n.altKey&&!n.shiftKey&&!n.ctrlKey){const C=(y.rotationZ||y.rotation||0)+(r>0?f:-f);re(c,"rotationZ",C)}else{const C=Math.max(.1,Math.min(5,y.scale+r));re(c,"scale",C)}D()}function Lt(n){if(!e.currentLayer)return;const r=n.shiftKey?10:1,l=e.currentLayer,p=h(l);switch(n.key){case"ArrowLeft":re(l,"x",p.x-r),D(),n.preventDefault();break;case"ArrowRight":re(l,"x",p.x+r),D(),n.preventDefault();break;case"ArrowUp":re(l,"y",p.y-r),D(),n.preventDefault();break;case"ArrowDown":re(l,"y",p.y+r),D(),n.preventDefault();break;case"r":case"R":re(l,"x",0),re(l,"y",0),re(l,"scale",1),re(l,"rotation",0),re(l,"opacity",1),D(),n.preventDefault();break;case"Delete":case"Backspace":confirm("Delete current layer?")&&e.removeLayer(e.currentLayerIndex),n.preventDefault();break}}return k({clearExtractSelection:W,applyExtractSelection:zt}),(n,r)=>(G(),B("div",{class:"canvas-preview",ref_key:"containerRef",ref:fe},[s("div",pa,[Be(s("canvas",{ref_key:"gpuCanvasRef",ref:ae,width:v(e).project.width,height:v(e).project.height,onMousedown:xt,onMousemove:jt,onMouseup:rt,onMouseleave:rt,onWheel:ge(Ct,["prevent"]),onContextmenu:r[0]||(r[0]=ge(()=>{},["prevent"])),tabindex:"0",onKeydown:Lt},null,40,da),[[Nt,U.value]]),Be(s("canvas",{ref_key:"canvasRef",ref:$,width:v(e).project.width,height:v(e).project.height,onMousedown:xt,onMousemove:jt,onMouseup:rt,onMouseleave:rt,onWheel:ge(Ct,["prevent"]),onContextmenu:r[1]||(r[1]=ge(()=>{},["prevent"])),tabindex:"0",onKeydown:Lt},null,40,fa),[[Nt,!U.value]]),s("div",ya,[v(e).currentLayer?(G(),B("span",va,[U.value?(G(),B("span",ha,"GPU")):tt("",!0),ia(" Layer "+N(v(e).currentLayerIndex+1)+" | X:"+N(Math.round(v(e).currentLayer.x||0))+" Y:"+N(Math.round(v(e).currentLayer.y||0))+" S:"+N((v(e).currentLayer.scale||1).toFixed(2))+" R:"+N(Math.round(v(e).currentLayer.rotation||0))+"Â° ",1)])):(G(),B("span",_a,"No layer selected"))])])],512))}}),ba=Zt(ga,[["__scopeId","data-v-6645290d"]]),ka={class:"project-settings"},wa={class:"setting-row"},xa=["value"],ja={class:"setting-row"},Ma=["value"],Pa={class:"setting-row"},Ca=["value"],La={class:"setting-row"},Ia=["value"],Ea={class:"setting-row"},Ta=["checked"],za={class:"setting-row"},Xa=["value"],Ya={class:"setting-row"},Sa=["value"],Da={class:"setting-row"},Fa=["value"],Ra={class:"setting-row"},$a=["value"],Ka={class:"setting-row"},Aa=["value"],Wa={class:"setting-row"},Za=["value"],Ua={class:"setting-row"},Va=["value"],Oa=Wt({__name:"ProjectSettings",setup(V){const k=Ut();function e(Y){k.setProject({width:parseInt(Y.target.value)||1280})}function $(Y){k.setProject({height:parseInt(Y.target.value)||720})}function ae(Y){k.setProject({fps:parseInt(Y.target.value)||30})}function fe(Y){k.setProject({total_frames:parseInt(Y.target.value)||150})}function K(Y){k.setProject({cam_enable:Y.target.checked})}function xe(Y){k.setProject({cam_pos_x:parseFloat(Y.target.value)||0})}function Ie(Y){k.setProject({cam_pos_y:parseFloat(Y.target.value)||0})}function Ee(Y){k.setProject({cam_pos_z:parseFloat(Y.target.value)||0})}function ce(Y){k.setProject({cam_yaw:parseFloat(Y.target.value)||0})}function U(Y){k.setProject({cam_pitch:parseFloat(Y.target.value)||0})}function J(Y){k.setProject({cam_roll:parseFloat(Y.target.value)||0})}function se(Y){k.setProject({cam_fov:parseFloat(Y.target.value)||90})}return(Y,I)=>(G(),B("div",ka,[I[15]||(I[15]=s("div",{class:"section-title"},"ðŸ“ é¡¹ç›®",-1)),s("div",wa,[I[0]||(I[0]=s("label",null,"å®½åº¦",-1)),s("input",{type:"number",value:v(k).project.width,onInput:e,min:"64",max:"8192"},null,40,xa)]),s("div",ja,[I[1]||(I[1]=s("label",null,"é«˜åº¦",-1)),s("input",{type:"number",value:v(k).project.height,onInput:$,min:"64",max:"8192"},null,40,Ma)]),s("div",Pa,[I[2]||(I[2]=s("label",null,"å¸§çŽ‡",-1)),s("input",{type:"number",value:v(k).project.fps,onInput:ae,min:"1",max:"120"},null,40,Ca)]),s("div",La,[I[3]||(I[3]=s("label",null,"å¸§æ•°",-1)),s("input",{type:"number",value:v(k).project.total_frames,onInput:fe,min:"1",max:"9999"},null,40,Ia)]),I[16]||(I[16]=s("div",{class:"section-title"},"ðŸŽ¥ 3D æ‘„åƒæœº",-1)),s("div",Ea,[I[4]||(I[4]=s("label",null,"å¯ç”¨",-1)),s("input",{type:"checkbox",checked:v(k).project.cam_enable,onChange:K},null,40,Ta)]),v(k).project.cam_enable?(G(),B(Ke,{key:0},[I[12]||(I[12]=s("div",{class:"subsection-title"},"ä½ç½®",-1)),s("div",za,[I[5]||(I[5]=s("label",null,"X",-1)),s("input",{type:"number",value:v(k).project.cam_pos_x,onInput:xe,step:"10"},null,40,Xa)]),s("div",Ya,[I[6]||(I[6]=s("label",null,"Y",-1)),s("input",{type:"number",value:v(k).project.cam_pos_y,onInput:Ie,step:"10"},null,40,Sa)]),s("div",Da,[I[7]||(I[7]=s("label",null,"Z (è·ç¦»)",-1)),s("input",{type:"number",value:v(k).project.cam_pos_z,onInput:Ee,step:"50"},null,40,Fa)]),I[13]||(I[13]=s("div",{class:"subsection-title"},"æ—‹è½¬",-1)),s("div",Ra,[I[8]||(I[8]=s("label",null,"Yaw (Yè½´)",-1)),s("input",{type:"number",value:v(k).project.cam_yaw,onInput:ce,step:"5"},null,40,$a)]),s("div",Ka,[I[9]||(I[9]=s("label",null,"Pitch (Xè½´)",-1)),s("input",{type:"number",value:v(k).project.cam_pitch,onInput:U,step:"5"},null,40,Aa)]),s("div",Wa,[I[10]||(I[10]=s("label",null,"Roll (Zè½´)",-1)),s("input",{type:"number",value:v(k).project.cam_roll,onInput:J,step:"5"},null,40,Za)]),I[14]||(I[14]=s("div",{class:"subsection-title"},"æŠ•å½±",-1)),s("div",Ua,[I[11]||(I[11]=s("label",null,"FOV",-1)),s("input",{type:"number",value:v(k).project.cam_fov,onInput:se,min:"1",max:"179",step:"5"},null,40,Va)])],64)):tt("",!0)]))}}),Na=Zt(Oa,[["__scopeId","data-v-8f5efc89"]]),Ba={class:"ae-timeline-root"},Ga={class:"ae-header"},Ha={class:"header-center"},qa={class:"project-info"},Ja={class:"header-right"},Qa={class:"project-inputs"},en={class:"project-field"},tn=["value"],an={class:"project-field"},nn=["value"],on={class:"project-field"},sn=["value"],rn={class:"project-field"},cn=["value"],ln={class:"project-field pano-field"},un={class:"hdr-toggle"},mn={class:"hdr-toggle cam-enable"},pn={class:"cam-row"},dn=["value"],fn=["value"],yn=["value"],vn=["value"],hn={class:"cam-row cam-row-3d"},_n=["value"],gn=["value"],bn=["value"],kn={class:"ae-main"},wn={class:"ae-inspector"},xn={key:0,class:"inspector-card"},jn={class:"card-header"},Mn={class:"layer-title"},Pn={class:"card-subtitle"},Cn={key:1,class:"inspector-card empty"},Ln={key:2,class:"inspector-section"},In={class:"property-list"},En={class:"property-row"},Tn=["value"],zn={class:"property-row"},Xn=["value"],Yn={class:"property-row"},Sn=["value"],Dn={class:"property-row"},Fn=["value"],Rn={class:"property-row"},$n=["value"],Kn={class:"property-row"},An=["value"],Wn={class:"property-row"},Zn=["value"],Un={class:"property-row slider-row"},Vn={class:"slider-header"},On={class:"prop-value"},Nn=["value"],Bn={class:"inspector-section"},Gn={class:"tools-grid"},Hn=["disabled"],qn={key:0,class:"tool-settings"},Jn={class:"slider-header"},Qn={class:"prop-value"},eo={key:1,class:"tool-settings"},to={class:"slider-header"},ao={class:"prop-value"},no={class:"inspector-section"},oo={class:"inspector-section"},so={class:"fit-row"},ro={class:"ae-viewport"},io={class:"viewport-bar"},co={class:"duration-text"},lo={class:"viewport-actions"},uo={class:"time-text"},mo={class:"zoom-control"},po={class:"prop-value"},fo={class:"viewport-canvas"},yo={class:"ae-timeline"},vo={class:"timeline-controls"},ho={class:"controls-left"},_o=["disabled"],go=["disabled"],bo={class:"controls-center"},ko={class:"time-display"},wo={class:"playback-btns"},xo={class:"timeline-body"},jo={class:"layers-panel"},Mo={class:"layers-header"},Po=["onClick"],Co=["onClick"],Lo={class:"layer-name"},Io={class:"layer-btns"},Eo=["onClick"],To=["onClick"],zo={class:"tick-text"},Xo=["title","onMousedown","onContextmenu"],Yo=["onClick"],So=["onClick"],Do=["onDblclick"],Fo=["title","onMousedown","onClick","onContextmenu"],kt=80,Ro=Wt({__name:"TimelineApp",props:{node:{}},setup(V){const k=V,e=Ut(),$=q(null),ae=q(),fe=q(),K=q(),xe=q(0);let Ie="foreground",Ee=!1,ce=null;const U=o=>{var t,a;return(a=(t=k.node)==null?void 0:t.widgets)==null?void 0:a.find(i=>i.name===o)};function J(o,t){const a=typeof o=="number"?o:parseFloat(o);return Number.isFinite(a)?a:t}const se=q("fit"),Y=q(100),I=ie(()=>Math.max(.1,Y.value/100)),A=ie({get:()=>!!e.project.cam_enable,set:o=>{e.setProject({cam_enable:o}),W("cam_enable",o?1:0)}}),De=ie({get:()=>e.project.pano_enable,set:o=>{e.setProject({pano_enable:o}),W("pano_enable",o?1:0)}}),Ae=ie({get:()=>e.project.cam_yaw,set:o=>{const t=Number.isFinite(o)?o:e.project.cam_yaw;e.setProject({cam_yaw:t}),W("cam_yaw",t)}}),We=ie({get:()=>e.project.cam_pitch,set:o=>{const t=Number.isFinite(o)?o:e.project.cam_pitch;e.setProject({cam_pitch:t}),W("cam_pitch",t)}}),Ze=ie({get:()=>e.project.cam_roll,set:o=>{const t=Number.isFinite(o)?o:e.project.cam_roll;e.setProject({cam_roll:t}),W("cam_roll",t)}}),Ue=ie({get:()=>e.project.cam_fov,set:o=>{const t=Number.isFinite(o)?o:e.project.cam_fov,a=Math.min(170,Math.max(10,t));e.setProject({cam_fov:a}),W("cam_fov",a)}}),Te=ie({get:()=>e.project.cam_pos_x||0,set:o=>{const t=Number.isFinite(o)?o:e.project.cam_pos_x||0;e.setProject({cam_pos_x:t}),W("cam_pos_x",t)}}),Ge=ie({get:()=>e.project.cam_pos_y||0,set:o=>{const t=Number.isFinite(o)?o:e.project.cam_pos_y||0;e.setProject({cam_pos_y:t}),W("cam_pos_y",t)}}),je=ie({get:()=>e.project.cam_pos_z||0,set:o=>{const t=Number.isFinite(o)?o:e.project.cam_pos_z||0;e.setProject({cam_pos_z:t}),W("cam_pos_z",t)}});function ze(o){var t;if(o.code==="Space"){const a=(t=o.target)==null?void 0:t.tagName;if(a==="INPUT"||a==="TEXTAREA"||a==="SELECT")return;o.preventDefault(),o.stopPropagation(),e.togglePlayback()}}const ye=ie(()=>{const o=Math.max(1,e.project.fps||1);return e.project.duration||e.project.total_frames/o||0}),oe=ie(()=>{var i;const o=Math.max(.001,ye.value||0),t=xe.value||((i=K.value)==null?void 0:i.clientWidth)||0,a=t?t/o:kt;return Math.max(kt,a)}),He=ie(()=>{var d;const a=ye.value*oe.value+120,i=xe.value||((d=K.value)==null?void 0:d.clientWidth)||0;return Math.max(a,i,800)});At(()=>e.extractMode.enabled,o=>{var t,a;o||(a=(t=$.value)==null?void 0:t.clearExtractSelection)==null||a.call(t)});function Xe(){var d;if(!K.value){setTimeout(Xe,100);return}const o=K.value.getBoundingClientRect(),t=((d=K.value.parentElement)==null?void 0:d.clientWidth)||o.width||0,a=typeof window<"u"?window.innerWidth:t,i=Math.max(t||a,800);i>0&&(xe.value=i)}Ht(()=>{Mt(),Xe(),typeof ResizeObserver<"u"&&K.value?(ce=new ResizeObserver(o=>{const t=o[0];t!=null&&t.contentRect&&(xe.value=t.contentRect.width)}),ce.observe(K.value)):window.addEventListener("resize",Xe),window.addEventListener("keydown",ze,{capture:!0}),window.addEventListener("beforeunload",C,{capture:!0})});let qe=!1,be=null;const D=q(new Set([0])),Me=q(null),Fe=[{key:"x",label:"X"},{key:"y",label:"Y"},{key:"z",label:"Z"},{key:"scale",label:"Scl"},{key:"rotation",label:"RotZ"},{key:"rotationX",label:"RotX"},{key:"rotationY",label:"RotY"},{key:"opacity",label:"Op"}],ne=[{key:"cam_yaw",label:"Yaw"},{key:"cam_pitch",label:"Pitch"},{key:"cam_roll",label:"Roll"},{key:"cam_fov",label:"FOV"},{key:"cam_offset_x",label:"OffX"},{key:"cam_offset_y",label:"OffY"},{key:"cam_pos_x",label:"PosX"},{key:"cam_pos_y",label:"PosY"},{key:"cam_pos_z",label:"PosZ"}],u=ie(()=>{const o=e.currentLayer;if(!o)return{x:0,y:0,z:0,scale:1,rotation:0,rotationX:0,rotationY:0,rotationZ:0,opacity:1};const t=e.currentTime,a=o.keyframes||{};return{x:h(a.x,t,o.x||0),y:h(a.y,t,o.y||0),z:h(a.z,t,o.z||0),scale:h(a.scale,t,o.scale||1),rotation:h(a.rotation,t,o.rotation||0),rotationX:h(a.rotationX,t,o.rotationX||0),rotationY:h(a.rotationY,t,o.rotationY||0),rotationZ:h(a.rotationZ,t,o.rotationZ||o.rotation||0),opacity:h(a.opacity,t,o.opacity??1)}});function h(o,t,a){if(!o||o.length===0)return a;const i=[...o].sort((d,_)=>d.time-_.time);if(t<=i[0].time)return i[0].value;if(t>=i[i.length-1].time)return i[i.length-1].value;for(let d=0;d<i.length-1;d++)if(t>=i[d].time&&t<=i[d+1].time){const _=(t-i[d].time)/(i[d+1].time-i[d].time);return i[d].value+(i[d+1].value-i[d].value)*_}return a}function L(o,t){const a=e.currentLayer;if(!a)return;const i=parseFloat(t.target.value);if(isNaN(i))return;const d=e.currentTime;if(a.keyframes&&a.keyframes[o]&&a.keyframes[o].length>0){const _=a.keyframes[o].findIndex(b=>Math.abs(b.time-d)<.05);_>=0?a.keyframes[o][_]={time:a.keyframes[o][_].time,value:i}:(a.keyframes[o].push({time:d,value:i}),a.keyframes[o].sort((b,E)=>b.time-E.time))}e.updateLayer(e.currentLayerIndex,{[o]:i})}function R(o){const t=e.currentLayer;if(!t)return;const a=parseFloat(o.target.value);if(isNaN(a))return;const i=a/100,d=e.currentTime;if(t.keyframes&&t.keyframes.scale&&t.keyframes.scale.length>0){const _=t.keyframes.scale.findIndex(b=>Math.abs(b.time-d)<.05);_>=0?t.keyframes.scale[_]={time:t.keyframes.scale[_].time,value:i}:(t.keyframes.scale.push({time:d,value:i}),t.keyframes.scale.sort((b,E)=>b.time-E.time))}e.updateLayer(e.currentLayerIndex,{scale:i})}function T(o){const t=Math.floor(o/60),a=Math.floor(o%60),i=Math.floor(o%1*e.project.fps);return`${t.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}function x(o,t){return!o.keyframes||!o.keyframes[t]?[]:o.keyframes[t].map(a=>({time:a.time,value:a.value}))}function pe(o){const t=[];if(!o.keyframes)return t;for(const a of Fe){const i=o.keyframes[a.key];i&&i.forEach(d=>t.push({time:d.time,prop:a.key}))}return t}function Je(){var a;const o=[],t=((a=e.projectKeyframes)==null?void 0:a.value)||e.projectKeyframes||{};return ne.forEach(i=>{const d=t[i.key];Array.isArray(d)&&d.forEach(_=>{typeof(_==null?void 0:_.time)=="number"&&o.push({time:_.time,prop:i.key,value:_.value??0})})}),o}function at(o,t){return t==="opacity"||t==="scale"?(o*100).toFixed(0)+"%":o.toFixed(1)}function wt(o){D.value.has(o)?D.value.delete(o):D.value.add(o)}function pt(o){var t,a;o.hidden=!o.hidden,(a=(t=$.value)==null?void 0:t.scheduleRender)==null||a.call(t)}function H(o){if(!K.value)return 0;const t=K.value.querySelector(".tracks-content");if(!t)return 0;const a=t.getBoundingClientRect(),i=K.value.scrollLeft,d=o.clientX-a.left+i,_=oe.value||kt;if(d<=10)return 0;const b=d/_;return Math.max(0,Math.min(b,ye.value))}function te(o){o.preventDefault(),Ee=!0,e.setCurrentTime(H(o));const t=i=>{Ee&&e.setCurrentTime(H(i))},a=()=>{Ee=!1,document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",t),document.addEventListener("mouseup",a)}function ke(o){if(!e.currentLayer)return;const t=H(o);e.setCurrentTime(t),e.addKeyframe()}function nt(o,t,a){const d=o.currentTarget.getBoundingClientRect(),_=o.clientX-d.left,b=oe.value||kt,E=Math.max(0,_/b),g=e.layers[t];if(!g)return;const M=g[a]??(a==="scale"||a==="opacity"?1:0);g.keyframes||(g.keyframes={}),g.keyframes[a]||(g.keyframes[a]=[]),g.keyframes[a].find(F=>Math.abs(F.time-E)<.05)||(g.keyframes[a].push({time:E,value:M}),g.keyframes[a].sort((F,Z)=>F.time-Z.time))}function Qe(o,t,a){Me.value={layerIdx:o,prop:t,time:a},e.selectLayer(o),e.setCurrentTime(a)}function dt(o,t,a){const i=Me.value;return i?i.layerIdx===o&&i.prop===t&&Math.abs(i.time-a)<.01:!1}function Ve(o,t,a,i){o.preventDefault(),qe=!0,be={layerIdx:t,prop:a,originalTime:i.time},Qe(t,a,i.time);const d=o.clientX,_=i.time,b=oe.value||kt,E=M=>{var ue;if(!qe||!be)return;const F=(M.clientX-d)/b;let Z=Math.max(0,_+F);const le=e.layers[be.layerIdx];if((ue=le==null?void 0:le.keyframes)!=null&&ue[be.prop]){const me=le.keyframes[be.prop],ve=me.findIndex(it=>Math.abs(it.time-be.originalTime)<.01);ve>=0&&(me[ve].time=Z,be.originalTime=Z,Me.value.time=Z,e.setCurrentTime(Z))}},g=()=>{var ee;qe=!1,be=null,document.removeEventListener("mousemove",E),document.removeEventListener("mouseup",g);const M=e.layers[t];(ee=M==null?void 0:M.keyframes)!=null&&ee[a]&&M.keyframes[a].sort((F,Z)=>F.time-Z.time)};document.addEventListener("mousemove",E),document.addEventListener("mouseup",g)}function xt(o,t,a){var d,_,b,E;const i=e.layers[o];(d=i==null?void 0:i.keyframes)!=null&&d[t]&&(i.keyframes[t]=i.keyframes[t].filter(g=>Math.abs(g.time-a)>.01),((_=Me.value)==null?void 0:_.layerIdx)===o&&((b=Me.value)==null?void 0:b.prop)===t&&Math.abs(((E=Me.value)==null?void 0:E.time)-a)<.01&&(Me.value=null))}function jt(o){if(K.value){const t=o.target,a=K.value.querySelector(".tracks-list");a&&(a.scrollTop=t.scrollTop)}}function re(o){const t=o.target,a=document.querySelector(".layers-list");a&&(a.scrollTop=t.scrollTop)}function Mt(){var vt,ht,ct,lt,ut,Re,Pe,mt,Ce,Ye,$e,Le,he,Oe,Ne,we;if(!((vt=k.node)!=null&&vt.widgets))return;const o=J((ht=U("width"))==null?void 0:ht.value,e.project.width),t=J((ct=U("height"))==null?void 0:ct.value,e.project.height),a=Math.max(1,J((lt=U("fps"))==null?void 0:lt.value,e.project.fps)),i=Math.max(1,Math.round(J((ut=U("total_frames"))==null?void 0:ut.value,e.project.total_frames))),d=J((Re=U("mask_expansion"))==null?void 0:Re.value,e.project.mask_expansion),_=J((Pe=U("mask_feather"))==null?void 0:Pe.value,e.project.mask_feather),b=!!J((mt=U("pano_enable"))==null?void 0:mt.value,e.project.pano_enable?1:0),E=J((Ce=U("cam_yaw"))==null?void 0:Ce.value,e.project.cam_yaw),g=J((Ye=U("cam_pitch"))==null?void 0:Ye.value,e.project.cam_pitch),M=J(($e=U("cam_roll"))==null?void 0:$e.value,e.project.cam_roll),ee=J((Le=U("cam_fov"))==null?void 0:Le.value,e.project.cam_fov),F=J((he=U("cam_pos_x"))==null?void 0:he.value,e.project.cam_pos_x||0),Z=J((Oe=U("cam_pos_y"))==null?void 0:Oe.value,e.project.cam_pos_y||0),le=J((Ne=U("cam_pos_z"))==null?void 0:Ne.value,e.project.cam_pos_z||0);let ue=[];const me=(we=U("layers_keyframes"))==null?void 0:we.value;let ve={};if(typeof me=="string"&&me.trim())try{const de=JSON.parse(me);Array.isArray(de)?ue=de:de&&typeof de=="object"&&(Array.isArray(de.layers)&&(ue=de.layers),de.project_keyframes&&typeof de.project_keyframes=="object"&&(ve=de.project_keyframes))}catch(de){console.warn("[AE Timeline] Failed to parse layers_keyframes widget",de)}else Array.isArray(me)&&(ue=me);const it={width:o,height:t,fps:a,total_frames:i,duration:i/a,mask_expansion:d,mask_feather:_,pano_enable:b,cam_yaw:E,cam_pitch:g,cam_roll:M,cam_fov:ee,cam_pos_x:F,cam_pos_y:Z,cam_pos_z:le};e.loadAnimation({project:it,layers:ue}),e.projectKeyframes.value=ve,e.layers.length>0&&e.currentLayerIndex<0&&e.selectLayer(0)}function ft(o,t){return o.name?o.name:o.type==="background"?"Background":`Layer ${t+1}`}function yt(){const o=e.exportAnimation(),t=new Blob([JSON.stringify(o,null,2)],{type:"application/json"}),a=URL.createObjectURL(t),i=document.createElement("a");i.href=a,i.download=`ae_project_${Date.now()}.json`,i.click(),URL.revokeObjectURL(a)}function Pt(){var o;(o=fe.value)==null||o.click()}function Tt(o){var i;const t=(i=o.target.files)==null?void 0:i[0];if(!t)return;const a=new FileReader;a.onload=d=>{var _;try{const b=JSON.parse((_=d.target)==null?void 0:_.result);e.loadAnimation(b),console.log("Project loaded successfully")}catch(b){console.error("Failed to parse project file",b),alert("Project file is corrupted or has invalid format")}},a.readAsText(t),fe.value&&(fe.value.value="")}function W(o,t){const i=(d=>{var _,b;return(b=(_=k.node)==null?void 0:_.widgets)==null?void 0:b.find(E=>E.name===d)})(o);i&&(i.value=t,i.inputEl&&(i.inputEl.value=t,i.inputEl.dispatchEvent(new Event("input"))),i.callback&&i.callback(t))}function ot(o,t){const a=parseInt(t.target.value,10);if(Number.isNaN(a))return;let i=a;o==="fps"&&(i=Math.max(1,i)),o==="total_frames"&&(i=Math.max(1,i)),(o==="width"||o==="height")&&(i=Math.max(16,i)),e.setProject({[o]:i}),W(o,i),e.setCurrentTime(e.currentTime)}function st(){var i,d,_,b,E;if(!((i=k.node)!=null&&i.widgets)){console.error("[AE Timeline] Node or widgets not found!");return}console.log("[AE Timeline] Saving..."),e.layers.forEach(g=>{g.maskCanvas&&(g.customMask=g.maskCanvas.toDataURL(),console.log(`[AE Timeline] Layer ${g.id}: Saved mask (len=${g.customMask.length})`))});const o=e.exportAnimation();o.layers.forEach(g=>{g.bezierPath&&g.bezierPath.length>0&&console.log(`[AE Timeline] Layer ${g.id}: Exporting Path with ${g.bezierPath.length} points`)});const a=(g=>k.node.widgets.find(M=>M.name===g))("layers_keyframes");if(a){const g=JSON.stringify({layers:o.layers,project_keyframes:e.projectKeyframes,project:o.project});if(a.value=g,console.log(`[AE Timeline] Saved layers_keyframes (len=${g.length})`),a.inputEl&&(a.inputEl.value=g,a.inputEl.dispatchEvent(new Event("input"))),a.callback&&a.callback(g),k.node.widgets_values){const M=k.node.widgets.indexOf(a);M>=0&&(k.node.widgets_values[M]=g)}(_=(d=k.node).setDirtyCanvas)==null||_.call(d,!0,!1)}else console.error("[AE Timeline] Widget layers_keyframes not found!");W("width",e.project.width),W("height",e.project.height),W("fps",e.project.fps),W("total_frames",e.project.total_frames),W("pano_enable",e.project.pano_enable?1:0),W("cam_yaw",e.project.cam_yaw),W("cam_pitch",e.project.cam_pitch),W("cam_roll",e.project.cam_roll),W("cam_fov",e.project.cam_fov),W("cam_pos_x",e.project.cam_pos_x||0),W("cam_pos_y",e.project.cam_pos_y||0),W("cam_pos_z",e.project.cam_pos_z||0),W("cam_pos_x",e.project.cam_pos_x||0),W("cam_pos_y",e.project.cam_pos_y||0),W("cam_pos_z",e.project.cam_pos_z||0),(E=(b=k.node).setDirtyCanvas)==null||E.call(b,!0,!1)}function zt(){st();const o=document.querySelector(".ae-timeline-dialog");o&&o.close()}function Xt(){e.addKeyframe()}function Yt(){e.deleteKeyframe()}function St(){e.setCurrentTime(0)}function rt(){e.setCurrentTime(ye.value)}function Ct(){const o=e.currentTime,t=e.project,a=e.setProjectKeyframe;a&&ne.forEach(i=>{const d=t[i.key]??0;a(i.key,o,d)})}function Lt(){const o=e.currentTime,t=e.deleteProjectKeyframe;t&&ne.forEach(a=>t(a.key,o))}function n(o,t){var a;(a=e.deleteProjectKeyframe)==null||a.call(e,o,t)}function r(o,t){const a=o.clientX,i=t.time,d=b=>{var F;const g=(b.clientX-a)/oe.value,M=Math.max(0,i+g),ee=t.value??e.project[t.prop]??0;(F=e.setProjectKeyframe)==null||F.call(e,t.prop,M,ee)},_=()=>{window.removeEventListener("mousemove",d),window.removeEventListener("mouseup",_)};window.addEventListener("mousemove",d),window.addEventListener("mouseup",_)}function l(){}function p(){var o;e.currentLayer&&confirm("Clear all keyframes on this layer?")&&((o=e.clearAllKeyframes)==null||o.call(e))}function m(){e.layers.forEach((o,t)=>{t!==e.currentLayerIndex&&(o._cachedImage&&delete o._cachedImage,console.log(`[AE Timeline] Cleared cache for layer ${o.id}`))})}function c(){var o,t;(t=(o=$.value)==null?void 0:o.scheduleRender)==null||t.call(o),console.log("[AE Timeline] Preview refreshed")}function y(){var o,t;k.node&&k.node.graph&&window.app&&((t=(o=window.app).queuePrompt)==null||t.call(o,0))}function f(o){var d,_;const t={mask:e.maskMode,path:e.pathMode,extract:e.extractMode},a=t[o],i=!a.enabled;if(o==="extract"&&i&&!e.layers.find(E=>E.type==="background")){alert("Add a background layer before using extract");return}Object.entries(t).forEach(([b,E])=>{b!==o&&(E.enabled=!1)}),(!i||o!=="extract")&&((_=(d=$.value)==null?void 0:d.clearExtractSelection)==null||_.call(d)),a.enabled=i}function w(){var o,t;(t=(o=$.value)==null?void 0:o.clearExtractSelection)==null||t.call(o)}function P(){var d,_;const o=$.value;if(!o||typeof o.applyExtractSelection!="function")return;const t=o.applyExtractSelection();if(!t){alert("Draw an extract selection first");return}if("error"in t){alert(t.error);return}const a=new Image;a.onload=()=>{const b=e.layers.filter(E=>{var g;return(g=E.id)==null?void 0:g.startsWith("extracted_")}).length;e.addLayer({id:`extracted_${Date.now()}`,name:`Extract ${b+1}`,type:"foreground",image_data:t.foregroundDataUrl,img:a,x:0,y:0,scale:1,rotation:0,opacity:1,mask_size:0,keyframes:{}})},a.src=t.foregroundDataUrl;const i=e.layers.find(b=>b.type==="background");if(i&&t.backgroundDataUrl){const b=new Image;b.onload=()=>{i.image_data=t.backgroundDataUrl,i.img=b,e.updateLayer(e.layers.indexOf(i),{image_data:t.backgroundDataUrl})},b.src=t.backgroundDataUrl}e.extractMode.enabled=!1,(_=(d=$.value)==null?void 0:d.clearExtractSelection)==null||_.call(d)}function C(){try{st()}catch(o){console.warn("[AE Timeline] autosave failed",o)}}function X(){var o;Ie="foreground",(o=ae.value)==null||o.click()}function j(){var o;Ie="background",(o=ae.value)==null||o.click()}function z(o){const t=o.target.files;t&&(Array.from(t).forEach((a,i)=>{const d=new FileReader;d.onload=_=>{var g;const b=(g=_.target)==null?void 0:g.result,E=new Image;E.onload=()=>{e.addLayer({id:"uploaded_"+Date.now()+"_"+i,name:a.name.replace(/\.[^/.]+$/,""),type:Ie,image_data:b,img:E,x:0,y:0,scale:1,rotation:0,opacity:1,mask_size:0,keyframes:{},bg_mode:"fit"})},E.src=b},d.readAsDataURL(a)}),ae.value&&(ae.value.value=""))}function S(){Q(-1)}function O(){Q(1)}function Q(o){const t=e.currentLayerIndex;if(t<0)return;const a=t+o;if(a>=0&&a<e.layers.length){const i=e.layers[t];e.layers.splice(t,1),e.layers.splice(a,0,i),e.selectLayer(a)}}return ca(()=>{ce&&K.value&&(ce.disconnect(),ce=null),window.removeEventListener("resize",Xe),window.removeEventListener("keydown",ze,{capture:!0}),st()}),(o,t)=>(G(),B("div",Ba,[s("header",Ga,[s("div",{class:"header-left"},[t[31]||(t[31]=s("div",{class:"logo"},[s("div",{class:"logo-icon"},"AE"),s("span",{class:"logo-text"},"AE Animator")],-1)),t[32]||(t[32]=s("div",{class:"header-divider"},null,-1)),s("button",{class:"btn btn-ghost",onClick:yt,title:"ä¿å­˜å·¥ç¨‹æ–‡ä»¶"},"Save"),s("button",{class:"btn btn-ghost",onClick:Pt,title:"åŠ è½½å·¥ç¨‹æ–‡ä»¶"},"Load")]),s("div",Ha,[s("span",qa,N(v(e).project.width)+"x"+N(v(e).project.height)+" @ "+N(v(e).project.fps)+" FPS",1)]),s("div",Ja,[s("div",Qa,[s("div",en,[t[33]||(t[33]=s("span",{class:"field-label"},"W",-1)),s("input",{type:"number",min:"16",max:"8192",value:v(e).project.width,onInput:t[0]||(t[0]=a=>ot("width",a))},null,40,tn)]),s("div",an,[t[34]||(t[34]=s("span",{class:"field-label"},"H",-1)),s("input",{type:"number",min:"16",max:"8192",value:v(e).project.height,onInput:t[1]||(t[1]=a=>ot("height",a))},null,40,nn)]),s("div",on,[t[35]||(t[35]=s("span",{class:"field-label"},"FPS",-1)),s("input",{type:"number",min:"1",max:"240",value:v(e).project.fps,onInput:t[2]||(t[2]=a=>ot("fps",a))},null,40,sn)]),s("div",rn,[t[36]||(t[36]=s("span",{class:"field-label"},"Frames",-1)),s("input",{type:"number",min:"1",value:v(e).project.total_frames,onInput:t[3]||(t[3]=a=>ot("total_frames",a))},null,40,cn)]),s("div",ln,[s("label",un,[Be(s("input",{type:"checkbox","onUpdate:modelValue":t[4]||(t[4]=a=>De.value=a)},null,512),[[Bt,De.value]]),t[37]||(t[37]=s("span",null,"Pano",-1))]),s("label",mn,[Be(s("input",{type:"checkbox","onUpdate:modelValue":t[5]||(t[5]=a=>A.value=a)},null,512),[[Bt,A.value]]),t[38]||(t[38]=s("span",null,"Cam",-1))]),s("div",pn,[s("input",{type:"number",step:"1",value:Ae.value,onInput:t[6]||(t[6]=a=>Ae.value=parseFloat(a.target.value)),title:"Yaw"},null,40,dn),s("input",{type:"number",step:"1",value:We.value,onInput:t[7]||(t[7]=a=>We.value=parseFloat(a.target.value)),title:"Pitch"},null,40,fn),s("input",{type:"number",step:"1",value:Ze.value,onInput:t[8]||(t[8]=a=>Ze.value=parseFloat(a.target.value)),title:"Roll"},null,40,yn),s("input",{type:"number",step:"1",min:"10",max:"170",value:Ue.value,onInput:t[9]||(t[9]=a=>Ue.value=parseFloat(a.target.value)),title:"FOV"},null,40,vn)]),s("div",hn,[s("input",{type:"number",step:"1",value:Te.value,onInput:t[10]||(t[10]=a=>Te.value=parseFloat(a.target.value)),title:"Pos X"},null,40,_n),s("input",{type:"number",step:"1",value:Ge.value,onInput:t[11]||(t[11]=a=>Ge.value=parseFloat(a.target.value)),title:"Pos Y"},null,40,gn),s("input",{type:"number",step:"1",value:je.value,onInput:t[12]||(t[12]=a=>je.value=parseFloat(a.target.value)),title:"Pos Z"},null,40,bn)])])]),s("button",{class:"btn btn-primary",onClick:X},"+ FG Layer"),s("button",{class:"btn btn-secondary",onClick:j},"+ BG Layer"),t[39]||(t[39]=s("div",{class:"header-divider"},null,-1)),s("button",{class:"btn btn-accent",onClick:st,title:"ä¿å­˜åˆ°èŠ‚ç‚¹"},"Save"),s("button",{class:"btn btn-close",onClick:zt,title:"å…³é—­"},"Close")])]),s("div",kn,[s("aside",wn,[v(e).currentLayer?(G(),B("div",xn,[s("div",jn,[s("span",Mn,N(ft(v(e).currentLayer,v(e).currentLayerIndex)),1),s("span",{class:_e(["layer-badge",v(e).currentLayer.type])},N(v(e).currentLayer.type==="background"?"BG":"FG"),3)]),s("div",Pn," Layer "+N(v(e).currentLayerIndex+1)+" - "+N(v(e).currentLayer.type==="background"?"Background":"Foreground"),1)])):(G(),B("div",Cn,[...t[40]||(t[40]=[s("span",null,"è¯·é€‰æ‹©ä¸€ä¸ªå›¾å±‚",-1)])])),v(e).currentLayer?(G(),B("div",Ln,[t[53]||(t[53]=s("div",{class:"section-title"},"Transform",-1)),s("div",In,[s("div",En,[t[41]||(t[41]=s("span",{class:"prop-label"},"Position X",-1)),s("input",{type:"number",class:"prop-input",value:u.value.x.toFixed(0),onInput:t[13]||(t[13]=a=>L("x",a)),step:"1"},null,40,Tn)]),s("div",zn,[t[42]||(t[42]=s("span",{class:"prop-label"},"Position Y",-1)),s("input",{type:"number",class:"prop-input",value:u.value.y.toFixed(0),onInput:t[14]||(t[14]=a=>L("y",a)),step:"1"},null,40,Xn)]),s("div",Yn,[t[43]||(t[43]=s("span",{class:"prop-label"},"Position Z",-1)),s("input",{type:"number",class:"prop-input",value:u.value.z.toFixed(0),onInput:t[15]||(t[15]=a=>L("z",a)),step:"1"},null,40,Sn)]),s("div",Dn,[t[44]||(t[44]=s("span",{class:"prop-label"},"Scale",-1)),s("input",{type:"number",class:"prop-input",value:(u.value.scale*100).toFixed(0),onInput:t[16]||(t[16]=a=>R(a)),step:"1"},null,40,Fn),t[45]||(t[45]=s("span",{class:"prop-unit"},"%",-1))]),s("div",Rn,[t[46]||(t[46]=s("span",{class:"prop-label"},"Rot X",-1)),s("input",{type:"number",class:"prop-input",value:u.value.rotationX.toFixed(0),onInput:t[17]||(t[17]=a=>L("rotationX",a)),step:"1"},null,40,$n),t[47]||(t[47]=s("span",{class:"prop-unit"},"deg",-1))]),s("div",Kn,[t[48]||(t[48]=s("span",{class:"prop-label"},"Rot Y",-1)),s("input",{type:"number",class:"prop-input",value:u.value.rotationY.toFixed(0),onInput:t[18]||(t[18]=a=>L("rotationY",a)),step:"1"},null,40,An),t[49]||(t[49]=s("span",{class:"prop-unit"},"deg",-1))]),s("div",Wn,[t[50]||(t[50]=s("span",{class:"prop-label"},"Rot Z",-1)),s("input",{type:"number",class:"prop-input",value:u.value.rotation.toFixed(0),onInput:t[19]||(t[19]=a=>L("rotation",a)),step:"1"},null,40,Zn),t[51]||(t[51]=s("span",{class:"prop-unit"},"deg",-1))]),s("div",Un,[s("div",Vn,[t[52]||(t[52]=s("span",{class:"prop-label"},"Opacity",-1)),s("span",On,N((u.value.opacity*100).toFixed(0))+"%",1)]),s("input",{type:"range",class:"prop-slider",value:u.value.opacity,onInput:t[20]||(t[20]=a=>L("opacity",a)),min:"0",max:"1",step:"0.01"},null,40,Nn)])])])):tt("",!0),s("div",Bn,[t[56]||(t[56]=s("div",{class:"section-title"},"Tools",-1)),s("div",Gn,[s("button",{class:_e(["tool-btn",{active:v(e).maskMode.enabled}]),onClick:t[21]||(t[21]=a=>f("mask"))},"Mask Mode",2),s("button",{class:_e(["tool-btn",{active:v(e).maskMode.enabled&&v(e).maskMode.erase}]),onClick:t[22]||(t[22]=a=>v(e).maskMode.erase=!v(e).maskMode.erase),disabled:!v(e).maskMode.enabled},"Eraser",10,Hn),s("button",{class:_e(["tool-btn",{active:v(e).pathMode.enabled}]),onClick:t[23]||(t[23]=a=>f("path"))},"Path Tool",2),s("button",{class:_e(["tool-btn",{active:v(e).extractMode.enabled}]),onClick:t[24]||(t[24]=a=>f("extract"))},"AI Extract",2)]),v(e).maskMode.enabled?(G(),B("div",qn,[s("div",Jn,[t[54]||(t[54]=s("span",{class:"prop-label"},"Brush Size",-1)),s("span",Qn,N(v(e).maskMode.brush)+"px",1)]),Be(s("input",{type:"range",class:"prop-slider","onUpdate:modelValue":t[25]||(t[25]=a=>v(e).maskMode.brush=a),min:"1",max:"100",step:"1"},null,512),[[$t,v(e).maskMode.brush,void 0,{number:!0}]])])):tt("",!0),v(e).extractMode.enabled?(G(),B("div",eo,[s("div",to,[t[55]||(t[55]=s("span",{class:"prop-label"},"Brush Size",-1)),s("span",ao,N(v(e).extractMode.brush)+"px",1)]),Be(s("input",{type:"range",class:"prop-slider","onUpdate:modelValue":t[26]||(t[26]=a=>v(e).extractMode.brush=a),min:"5",max:"150",step:"1"},null,512),[[$t,v(e).extractMode.brush,void 0,{number:!0}]]),s("div",{class:"extract-actions"},[s("button",{class:"btn btn-small btn-primary",onClick:P},"Apply"),s("button",{class:"btn btn-small btn-ghost",onClick:w},"Clear")])])):tt("",!0)]),s("div",no,[Gt(Na)]),s("div",oo,[t[59]||(t[59]=s("div",{class:"section-title"},"Actions",-1)),s("div",{class:"action-row"},[s("button",{class:"btn btn-small btn-ghost",onClick:m},"Clear Cache"),s("button",{class:"btn btn-small btn-ghost",onClick:c},"Refresh"),s("button",{class:"btn btn-small btn-accent",onClick:y},"Run")]),s("div",so,[t[58]||(t[58]=s("span",{class:"prop-label"},"Fit Mode",-1)),Be(s("select",{class:"fit-select","onUpdate:modelValue":t[27]||(t[27]=a=>se.value=a)},[...t[57]||(t[57]=[s("option",{value:"fit"},"Fit",-1),s("option",{value:"fill"},"Fill",-1),s("option",{value:"stretch"},"Stretch",-1)])],512),[[la,se.value]])])])]),s("main",ro,[s("div",io,[s("span",co,"Duration: "+N(T(ye.value)),1),s("div",lo,[s("span",uo,N(T(v(e).currentTime)),1),s("div",mo,[t[60]||(t[60]=s("span",{class:"prop-label"},"Zoom",-1)),Be(s("input",{type:"range",min:"25",max:"200",step:"5","onUpdate:modelValue":t[28]||(t[28]=a=>Y.value=a)},null,512),[[$t,Y.value,void 0,{number:!0}]]),s("span",po,N(Y.value)+"%",1)])])]),s("div",fo,[s("div",{class:"canvas-zoom",style:Se({transform:`scale(${I.value})`})},[Gt(ba,{ref_key:"canvasPreviewRef",ref:$,fitMode:se.value},null,8,["fitMode"])],4)])])]),s("footer",yo,[s("div",vo,[s("div",ho,[s("button",{class:"btn btn-small btn-ghost",onClick:Xt},"+ Keyframe"),s("button",{class:"btn btn-small btn-ghost",onClick:Yt},"Del Key"),s("button",{class:"btn btn-small btn-ghost",onClick:p},"Clear All"),s("button",{class:"btn btn-small btn-ghost",onClick:Ct},"+ Cam KF"),s("button",{class:"btn btn-small btn-ghost",onClick:Lt},"Del Cam KF"),t[61]||(t[61]=s("div",{class:"controls-divider"},null,-1)),s("button",{class:"nav-btn",onClick:S,disabled:!v(e).currentLayer},"Up",8,_o),s("button",{class:"nav-btn",onClick:O,disabled:!v(e).currentLayer},"Down",8,go)]),s("div",bo,[s("span",ko,N(T(v(e).currentTime)),1),s("div",wo,[s("button",{class:"pb-btn",onClick:St},"|<"),s("button",{class:_e(["play-btn",{playing:v(e).isPlaying}]),onClick:t[29]||(t[29]=(...a)=>v(e).togglePlayback&&v(e).togglePlayback(...a))},N(v(e).isPlaying?"Pause":"Play"),3),s("button",{class:"pb-btn",onClick:rt},">|")])])]),s("div",xo,[s("div",jo,[s("div",Mo,"Layers ("+N(v(e).layers.length)+")",1),s("div",{class:"layers-list",onScroll:jt},[t[62]||(t[62]=s("div",{class:"layer-item camera-layer"},[s("span",{class:"expand-icon"}),s("span",{class:"layer-type camera"},"C"),s("span",{class:"layer-name"},"Camera")],-1)),(G(!0),B(Ke,null,et(v(e).layers,(a,i)=>(G(),B("div",{key:a.id,class:_e(["layer-item",{active:i===v(e).currentLayerIndex}]),onClick:d=>v(e).selectLayer(i)},[s("span",{class:"expand-icon",onClick:ge(d=>wt(i),["stop"])},N(D.value.has(i)?"v":">"),9,Co),s("span",{class:_e(["layer-type",a.type])},N(a.type==="background"?"B":"F"),3),s("span",Lo,N(ft(a,i)),1),s("span",Io,[s("span",{class:_e(["vis-icon",{off:a.hidden}]),onClick:ge(d=>pt(a),["stop"])},"eye",10,Eo),s("span",{class:"del-icon",onClick:ge(d=>v(e).removeLayer(i),["stop"])},"x",8,To)])],10,Po))),128))],32)]),s("div",{class:"tracks-panel",ref_key:"timelineRef",ref:K},[s("div",{class:"tracks-content",style:Se({width:He.value+"px"})},[s("div",{class:"ruler",onMousedown:te},[(G(!0),B(Ke,null,et(Math.ceil(ye.value)+1,a=>(G(),B("div",{key:a,class:"ruler-tick",style:Se({left:(a-1)*oe.value+"px"})},[s("span",zo,N(a-1)+"s",1)],4))),128)),s("div",{class:"playhead-top",style:Se({left:v(e).currentTime*oe.value+"px"})},null,4)],32),s("div",{class:"tracks-list",onDblclick:ke,onScroll:re},[s("div",{class:"track-row camera-row",onClick:t[30]||(t[30]=a=>void 0)},[s("div",{class:"track-bar camera",style:Se({width:ye.value*oe.value+"px"})},[(G(!0),B(Ke,null,et(Je(),a=>(G(),B("div",{key:`cam-${a.prop}-${a.time}`,class:"mini-kf camera",style:Se({left:a.time*oe.value+"px"}),title:`Camera ${a.prop} @ ${a.time.toFixed(2)}s`,onMousedown:ge(i=>r(i,a),["stop"]),onContextmenu:ge(i=>n(a.prop,a.time),["prevent"])},null,44,Xo))),128)),t[63]||(t[63]=s("span",{class:"track-label"},"Camera",-1))],4)]),(G(!0),B(Ke,null,et(v(e).layers,(a,i)=>(G(),B(Ke,{key:a.id},[s("div",{class:_e(["track-row",{active:i===v(e).currentLayerIndex}]),onClick:d=>v(e).selectLayer(i)},[s("div",{class:_e(["track-bar",a.type]),style:Se({width:ye.value*oe.value+"px"})},[D.value.has(i)?tt("",!0):(G(!0),B(Ke,{key:0},et(pe(a),d=>(G(),B("div",{key:d.time+d.prop,class:"mini-kf",style:Se({left:d.time*oe.value+"px"})},null,4))),128))],6)],10,Yo),D.value.has(i)?(G(),B(Ke,{key:0},et(Fe,d=>s("div",{key:d.key,class:_e(["prop-track-row",{active:i===v(e).currentLayerIndex}]),onClick:_=>v(e).selectLayer(i)},[s("div",{class:"prop-track",onDblclick:ge(_=>nt(_,i,d.key),["stop"])},[(G(!0),B(Ke,null,et(x(a,d.key),_=>(G(),B("div",{key:_.time,class:_e(["keyframe-dot",{selected:dt(i,d.key,_.time)}]),style:Se({left:_.time*oe.value+"px"}),title:`${d.label}: ${at(_.value,d.key)} @ ${_.time.toFixed(2)}s`,onMousedown:ge(b=>Ve(b,i,d.key,_),["stop"]),onClick:ge(b=>Qe(i,d.key,_.time),["stop"]),onContextmenu:ge(b=>xt(i,d.key,_.time),["prevent"])},null,46,Fo))),128))],40,Do)],10,So)),64)):tt("",!0)],64))),128))],32),s("div",{class:"playhead-line",style:Se({left:v(e).currentTime*oe.value+"px"})},null,4)],4)],512)])]),s("input",{ref_key:"fileInput",ref:ae,type:"file",accept:"image/*",multiple:"",style:{display:"none"},onChange:z},null,544),s("input",{ref_key:"projectInput",ref:fe,type:"file",accept:".json",style:{display:"none"},onChange:Tt},null,544)]))}}),$o=Zt(Ro,[["__scopeId","data-v-8b132f63"]]);function Ko(V,k){const e=ua($o,{node:k.node}),$=ma();return e.use($),e.mount(V),e}window.createTimelineApp=Ko;
