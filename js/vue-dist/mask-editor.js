var kc=Object.defineProperty;var Fi=e=>{throw TypeError(e)};var _c=(e,t,r)=>t in e?kc(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var y=(e,t,r)=>_c(e,typeof t!="symbol"?t+"":t,r),As=(e,t,r)=>t.has(e)||Fi("Cannot "+r);var g=(e,t,r)=>(As(e,t,"read from private field"),r?r.call(e):t.get(e)),W=(e,t,r)=>t.has(e)?Fi("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),N=(e,t,r,n)=>(As(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r),xr=(e,t,r)=>(As(e,t,"access private method"),r);var Gi=(e,t,r,n)=>({set _(a){N(e,t,a,r)},get _(){return g(e,t,n)}});import{r as k,c as Me,d as Ts,w as pr,e as Bc,g as Pc,o as zc,u as I,W as Jt,q as Ia,a as qn,Y as Fl,b as Pr,D as C,f as J,k as Be,h as yi,m as Ve,i as v,_ as Ic,R as gi,t as es,I as Ua,j as Tt,C as $s,M as vi,l as ft,x as M,n as Gl,p as Uc,S as Ec,s as Di,P as B,A as Os,v as Vi,y as pt,z as ji,B as Ni,E as fr,U as Xs,F as qi,G as Wn,H as Ie,J as $,K as Ct,L as wi,N as Dl,O as ua,Q as Rc,T as Hs,V as Gr,X as at,Z as he,$ as $t,a0 as Ir,a1 as b,a2 as qe,a3 as st,a4 as zr,a5 as Vl,a6 as sr,a7 as Yn,a8 as Ae,a9 as ze,aa as hr,ab as S,ac as Zn,ad as dt,ae as Gt,af as mr,ag as Ke,ah as Xn,ai as cr,aj as bt,ak as yr,al as ke,am as Ea,an as te,ao as St,ap as xi,aq as ls,ar as Ra,as as Dt,at as us,au as Wi,av as Qe,aw as Ss,ax as bi,ay as We,az as Vt,aA as Va,aB as Cc,aC as jl,aD as Ac,aE as Oc,aF as Yi,aG as bn,aH as Zi,aI as Xi,aJ as Lc,aK as Fc,aL as Gc,aM as Dc,aN as Nn,aO as cs,aP as Hi,aQ as wa,aR as _r,aS as ht,aT as ve,aU as Vc,aV as xa,aW as Nl,aX as jc,aY as Qr,aZ as Nc,a_ as qc,a$ as Ks,b0 as Ki,b1 as Ms,b2 as ql,b3 as Ti,b4 as Wl,b5 as Wc,b6 as Qs,b7 as Yc,b8 as Qi,b9 as Ji,ba as Zc,bb as Xc,bc as Hc,bd as Kc,be as eo,bf as ps,bg as Qc,bh as Jc,bi as ep,bj as tp,bk as Ls,bl as mt,bm as je,bn as xe,bo as Mr,bp as A,bq as $i,br as wn,bs as Pe,bt as tt,bu as fs,bv as Yl,bw as Zl,bx as Tn,by as rp,bz as np,bA as ca,bB as ap,bC as sp,bD as ip}from"./assets/_plugin-vue_export-helper.js";function op(e,t,{signal:r,edges:n}={}){let a,s=null;const i=n!=null&&n.includes("leading"),o=n==null||n.includes("trailing"),l=()=>{s!==null&&(e.apply(a,s),a=void 0,s=null)},u=()=>{o&&l(),h()};let c=null;const p=()=>{c!=null&&clearTimeout(c),c=setTimeout(()=>{c=null,u()},t)},d=()=>{c!==null&&(clearTimeout(c),c=null)},h=()=>{d(),a=void 0,s=null},f=()=>{l()},m=function(...T){if(r!=null&&r.aborted)return;a=this,s=T;const _=c==null;p(),i&&_&&l()};return m.schedule=p,m.cancel=h,m.flush=f,r==null||r.addEventListener("abort",h,{once:!0}),m}function lp(){}function Nt(e,t,r){return r==null?Math.min(e,t):Math.min(Math.max(e,t),r)}function Si(e){return e==null||typeof e!="object"&&typeof e!="function"}function Mi(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)}function up(e){if(Si(e))return e;if(Array.isArray(e)||Mi(e)||e instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&e instanceof SharedArrayBuffer)return e.slice(0);const t=Object.getPrototypeOf(e),r=t.constructor;if(e instanceof Date||e instanceof Map||e instanceof Set)return new r(e);if(e instanceof RegExp){const n=new r(e);return n.lastIndex=e.lastIndex,n}if(e instanceof DataView)return new r(e.buffer.slice(0));if(e instanceof Error){const n=new r(e.message);return n.stack=e.stack,n.name=e.name,n.cause=e.cause,n}if(typeof File<"u"&&e instanceof File)return new r([e],e.name,{type:e.type,lastModified:e.lastModified});if(typeof e=="object"){const n=Object.create(t);return Object.assign(n,e)}return e}function Xl(e){return Object.getOwnPropertySymbols(e).filter(t=>Object.prototype.propertyIsEnumerable.call(e,t))}function Hl(e){return e==null?e===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(e)}const cp="[object RegExp]",Kl="[object String]",Ql="[object Number]",Jl="[object Boolean]",eu="[object Arguments]",pp="[object Symbol]",fp="[object Date]",dp="[object Map]",hp="[object Set]",mp="[object Array]",yp="[object ArrayBuffer]",gp="[object Object]",vp="[object DataView]",wp="[object Uint8Array]",xp="[object Uint8ClampedArray]",bp="[object Uint16Array]",Tp="[object Uint32Array]",$p="[object Int8Array]",Sp="[object Int16Array]",Mp="[object Int32Array]",kp="[object Float32Array]",_p="[object Float64Array]";function Bp(e,t){return $n(e,void 0,e,new Map,t)}function $n(e,t,r,n=new Map,a=void 0){const s=a==null?void 0:a(e,t,r,n);if(s!==void 0)return s;if(Si(e))return e;if(n.has(e))return n.get(e);if(Array.isArray(e)){const i=new Array(e.length);n.set(e,i);for(let o=0;o<e.length;o++)i[o]=$n(e[o],o,r,n,a);return Object.hasOwn(e,"index")&&(i.index=e.index),Object.hasOwn(e,"input")&&(i.input=e.input),i}if(e instanceof Date)return new Date(e.getTime());if(e instanceof RegExp){const i=new RegExp(e.source,e.flags);return i.lastIndex=e.lastIndex,i}if(e instanceof Map){const i=new Map;n.set(e,i);for(const[o,l]of e)i.set(o,$n(l,o,r,n,a));return i}if(e instanceof Set){const i=new Set;n.set(e,i);for(const o of e)i.add($n(o,void 0,r,n,a));return i}if(typeof Buffer<"u"&&Buffer.isBuffer(e))return e.subarray();if(Mi(e)){const i=new(Object.getPrototypeOf(e)).constructor(e.length);n.set(e,i);for(let o=0;o<e.length;o++)i[o]=$n(e[o],o,r,n,a);return i}if(e instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&e instanceof SharedArrayBuffer)return e.slice(0);if(e instanceof DataView){const i=new DataView(e.buffer.slice(0),e.byteOffset,e.byteLength);return n.set(e,i),Xt(i,e,r,n,a),i}if(typeof File<"u"&&e instanceof File){const i=new File([e],e.name,{type:e.type});return n.set(e,i),Xt(i,e,r,n,a),i}if(typeof Blob<"u"&&e instanceof Blob){const i=new Blob([e],{type:e.type});return n.set(e,i),Xt(i,e,r,n,a),i}if(e instanceof Error){const i=new e.constructor;return n.set(e,i),i.message=e.message,i.name=e.name,i.stack=e.stack,i.cause=e.cause,Xt(i,e,r,n,a),i}if(e instanceof Boolean){const i=new Boolean(e.valueOf());return n.set(e,i),Xt(i,e,r,n,a),i}if(e instanceof Number){const i=new Number(e.valueOf());return n.set(e,i),Xt(i,e,r,n,a),i}if(e instanceof String){const i=new String(e.valueOf());return n.set(e,i),Xt(i,e,r,n,a),i}if(typeof e=="object"&&Pp(e)){const i=Object.create(Object.getPrototypeOf(e));return n.set(e,i),Xt(i,e,r,n,a),i}return e}function Xt(e,t,r=e,n,a){const s=[...Object.keys(t),...Xl(t)];for(let i=0;i<s.length;i++){const o=s[i],l=Object.getOwnPropertyDescriptor(e,o);(l==null||l.writable)&&(e[o]=$n(t[o],o,r,n,a))}}function Pp(e){switch(Hl(e)){case eu:case mp:case yp:case vp:case Jl:case fp:case kp:case _p:case $p:case Sp:case Mp:case dp:case Ql:case gp:case cp:case hp:case Kl:case pp:case wp:case xp:case bp:case Tp:return!0;default:return!1}}function zp(e){return e==="__proto__"}function Ip(e){var r;if(typeof e!="object"||e==null)return!1;if(Object.getPrototypeOf(e)===null)return!0;if(Object.prototype.toString.call(e)!=="[object Object]"){const n=e[Symbol.toStringTag];return n==null||!((r=Object.getOwnPropertyDescriptor(e,Symbol.toStringTag))!=null&&r.writable)?!1:e.toString()===`[object ${n}]`}let t=e;for(;Object.getPrototypeOf(t)!==null;)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}var He=(e=>(e.Arc="arc",e.Rect="rect",e))(He||{}),se=(e=>(e.MaskPen="mask-pen",e.Eraser="eraser",e.PaintPen="paint-pen",e.MaskBucket="mask-bucket",e.MaskColorFill="mask-color-fill",e))(se||{});const Up=["mask-pen","eraser","paint-pen","mask-bucket","mask-color-fill"];var xt=(e=>(e.Black="black",e.White="white",e.Negative="negative",e))(xt||{}),Hr=(e=>(e.Simple="simple",e.Lab="lab",e))(Hr||{}),zt=(e=>(e.SourceOver="source-over",e.DestinationOut="destination-out",e))(zt||{});function Ep(e=20){const t=Ye(),r=k([]),n=k(-1),a=k(!1),s=Me(()=>r.value.length>1&&n.value>0),i=Me(()=>r.value.length>1&&n.value<r.value.length-1),o=()=>{const h=t.maskCtx,f=t.rgbCtx,m=t.maskCanvas,T=t.rgbCanvas;if(!h||!f||!m||!T){requestAnimationFrame(o);return}if(!m.width||!T.width){requestAnimationFrame(o);return}r.value=[];const _=h.getImageData(0,0,m.width,m.height),O=f.getImageData(0,0,T.width,T.height);r.value.push({mask:_,rgb:O}),n.value=0,a.value=!0},l=(h,f)=>{const m=t.maskCtx,T=t.rgbCtx,_=t.maskCanvas,O=t.rgbCanvas;if(!m||!T||!_||!O)return;if(!a.value||n.value===-1){o();return}r.value=r.value.slice(0,n.value+1);let ne,Z;if(h&&f?(ne=h,Z=f):(ne=m.getImageData(0,0,_.width,_.height),Z=T.getImageData(0,0,O.width,O.height)),r.value.push({mask:ne,rgb:Z}),n.value++,r.value.length>e){const V=r.value.shift();V&&(V.mask instanceof ImageBitmap&&V.mask.close(),V.rgb instanceof ImageBitmap&&V.rgb.close()),n.value--}},u=()=>{if(!s.value){alert("No more undo states available");return}n.value--,p(r.value[n.value])},c=()=>{if(!i.value){alert("No more redo states available");return}n.value++,p(r.value[n.value])},p=h=>{const f=t.maskCtx,m=t.rgbCtx;!f||!m||(h.mask instanceof ImageBitmap?(f.clearRect(0,0,h.mask.width,h.mask.height),f.drawImage(h.mask,0,0)):f.putImageData(h.mask,0,0),h.rgb instanceof ImageBitmap?(m.clearRect(0,0,h.rgb.width,h.rgb.height),m.drawImage(h.rgb,0,0)):m.putImageData(h.rgb,0,0))};return{canUndo:s,canRedo:i,currentStateIndex:n,saveInitialState:o,saveState:l,undo:u,redo:c,clearStates:()=>{r.value.forEach(h=>{h.mask instanceof ImageBitmap&&h.mask.close(),h.rgb instanceof ImageBitmap&&h.rgb.close()}),r.value=[],n.value=-1,a.value=!1}}}const Ye=Ts("maskEditor",()=>{const e=k({type:He.Arc,size:10,opacity:.7,hardness:1,stepSize:10}),t=k(xt.Black),r=k("mask"),n=k("#FF0000"),a=k(se.MaskPen),s=k(!1),i=k(5),o=k(100),l=k(20),u=k(!1),c=k(Hr.Simple),p=k(!1),d=k(!1),h=k(0),f=k(100),m=k(1),T=k(1),_=k({x:0,y:0}),O=k({x:0,y:0}),ne=k(0),Z=k(0),V=k(null),E=k(null),G=k(null),j=k(null),H=k(null),le=k(null),pe=k(null),Ue=k(null),be=k(null),Le=k(null),it=k(.8),yt=k(!0),gt=k(!1),Qn=k(!1),Rt=Ep(20),Jn=k(null);pr(V,w=>{w&&(E.value=w.getContext("2d",{willReadFrequently:!0}))}),pr(G,w=>{w&&(j.value=w.getContext("2d",{willReadFrequently:!0}))}),pr(H,w=>{w&&(le.value=w.getContext("2d",{willReadFrequently:!0}))});const ea=Me(()=>Rt.canUndo.value),R=Me(()=>Rt.canRedo.value),K=Me(()=>{switch(t.value){case xt.Black:return{r:0,g:0,b:0};case xt.White:return{r:255,g:255,b:255};case xt.Negative:return{r:255,g:255,b:255};default:return{r:0,g:0,b:0}}});function ue(w){e.value.size=Nt(w,1,500)}function Re(w){e.value.opacity=Nt(w,0,1)}function Fe(w){e.value.hardness=Nt(w,0,1)}function Ce(w){e.value.stepSize=Nt(w,1,100)}function Xe(){e.value.type=He.Arc,e.value.size=10,e.value.opacity=.7,e.value.hardness=1,e.value.stepSize=10}function Je(w){i.value=Nt(w,0,255)}function rt(w){o.value=Nt(w,0,100)}function Mt(w){l.value=Nt(w,0,255)}function ot(w){h.value=Nt(w,0,255)}function et(w){f.value=Nt(w,0,100)}function lt(w){m.value=Math.max(.1,Math.min(10,w))}function kt(w){_.value={...w}}function ta(w){O.value={...w}}function tn(){ne.value++}function vr(){Z.value++}function rn(w){it.value=Nt(w,0,1)}function x(){e.value={type:He.Arc,size:10,opacity:.7,hardness:1,stepSize:5},t.value=xt.Black,r.value="mask",n.value="#FF0000",a.value=se.MaskPen,s.value=!1,i.value=5,o.value=100,l.value=20,u.value=!1,c.value=Hr.Simple,p.value=!1,d.value=!1,h.value=0,f.value=100,m.value=1,_.value={x:0,y:0},O.value={x:0,y:0},it.value=.8}return{brushSettings:e,maskBlendMode:t,activeLayer:r,rgbColor:n,currentTool:a,isAdjustingBrush:s,paintBucketTolerance:i,fillOpacity:o,colorSelectTolerance:l,colorSelectLivePreview:u,colorComparisonMethod:c,applyWholeImage:p,maskBoundary:d,maskTolerance:h,selectionOpacity:f,zoomRatio:m,displayZoomRatio:T,panOffset:_,cursorPoint:O,resetZoomTrigger:ne,maskCanvas:V,maskCtx:E,rgbCanvas:G,rgbCtx:j,imgCanvas:H,imgCtx:le,canvasContainer:pe,canvasBackground:Ue,pointerZone:be,image:Le,maskOpacity:it,canUndo:ea,canRedo:R,maskColor:K,brushVisible:yt,isPanning:gt,brushPreviewGradientVisible:Qn,canvasHistory:Rt,tgpuRoot:Jn,setBrushSize:ue,setBrushOpacity:Re,setBrushHardness:Fe,setBrushStepSize:Ce,resetBrushToDefault:Xe,setPaintBucketTolerance:Je,setFillOpacity:rt,setColorSelectTolerance:Mt,setMaskTolerance:ot,setSelectionOpacity:et,setZoomRatio:lt,setPanOffset:kt,setCursorPoint:ta,resetZoom:tn,triggerClear:vr,clearTrigger:Z,setMaskOpacity:rn,resetState:x}}),ki=Ts("maskEditorData",()=>{const e=k(null),t=k(null),r=k(null),n=k(!1),a=k(null),s=Me(()=>e.value!==null),i=Me(()=>t.value!==null),o=Me(()=>s.value&&!n.value);return{inputData:e,outputData:t,sourceNode:r,isLoading:n,loadError:a,hasValidInput:s,hasValidOutput:i,isReady:o,reset:()=>{e.value=null,t.value=null,r.value=null,n.value=!1,a.value=null},setLoading:(c,p)=>{n.value=c,p&&(a.value=p)}}});function Rp(e){return Pc()?(zc(e),!0):!1}function tu(e){let t=0,r,n;const a=()=>{t-=1,n&&t<=0&&(n.stop(),r=void 0,n=void 0)};return(...s)=>(t+=1,n||(n=Bc(!0),r=n.run(()=>e(...s))),Rp(a),r)}typeof WorkerGlobalScope<"u"&&globalThis instanceof WorkerGlobalScope;function ru(){const e=Ye(),t=async(s,i,o)=>{const l=e.maskColor;o.drawImage(s,0,0,i.width,i.height);const u=o.getImageData(0,0,i.width,i.height);for(let c=0;c<u.data.length;c+=4){const p=u.data[c+3];u.data[c]=l.r,u.data[c+1]=l.g,u.data[c+2]=l.b,u.data[c+3]=255-p}o.globalCompositeOperation="source-over",o.putImageData(u,0,0)},r=async(s,i,o)=>{const{imgCanvas:l,maskCanvas:u,rgbCanvas:c,imgCtx:p,maskCtx:d,rgbCtx:h}=e;if(!l||!u||!c||!p||!d||!h)throw new Error("Canvas elements or contexts not available");l.width=s.width,l.height=s.height,u.width=s.width,u.height=s.height,c.width=s.width,c.height=s.height,p.drawImage(s,0,0,s.width,s.height),o&&h.drawImage(o,0,0,o.width,o.height),await t(i,u,d)},n=()=>{const s=e.canvasBackground;s&&(e.maskBlendMode===xt.Black?s.style.backgroundColor="rgba(0,0,0,1)":(e.maskBlendMode===xt.White||e.maskBlendMode===xt.Negative)&&(s.style.backgroundColor="rgba(255,255,255,1)"))};return{invalidateCanvas:r,updateMaskColor:async()=>{const{maskCanvas:s,maskCtx:i,maskColor:o,maskBlendMode:l,maskOpacity:u}=e;if(!s||!i)return;l===xt.Negative?(s.style.mixBlendMode="difference",s.style.opacity="1"):(s.style.mixBlendMode="initial",s.style.opacity=String(u)),i.fillStyle=`rgb(${o.r}, ${o.g}, ${o.b})`,n();const c=i.getImageData(0,0,s.width,s.height);for(let p=0;p<c.data.length;p+=4)c.data[p]=o.r,c.data[p+1]=o.g,c.data[p+2]=o.b;i.putImageData(c,0,0)}}}function Cp(){const e=Ye(),t=ki(),r=ru();return{loadImages:async()=>{var h;const a=t.inputData;if(!a)throw new Error("No input data available in dataStore");const{imgCanvas:s,maskCanvas:i,rgbCanvas:o,imgCtx:l,maskCtx:u}=e;if(!s||!i||!o||!l||!u)throw new Error("Canvas elements or contexts not available");l.clearRect(0,0,s.width,s.height),u.clearRect(0,0,i.width,i.height);const c=a.baseLayer.image,p=a.maskLayer.image,d=(h=a.paintLayer)==null?void 0:h.image;return i.width=c.width,i.height=c.height,o.width=c.width,o.height=c.height,e.image=c,await r.invalidateCanvas(c,p,d||null),await r.updateMaskColor(),c}}}const Ap=tu(Cp);function Op(){const e=Ye(),t=k([]),r=l=>t.value.includes(l),n=()=>{t.value=[]},a=l=>{if(t.value.includes(l.key)||t.value.push(l.key),l.key===" "){l.preventDefault();const u=document.activeElement;u&&u.blur&&u.blur()}if((l.ctrlKey||l.metaKey)&&!l.altKey){const u=l.key.toUpperCase();u==="Y"&&!l.shiftKey||u==="Z"&&l.shiftKey?e.canvasHistory.redo():u==="Z"&&!l.shiftKey&&e.canvasHistory.undo()}},s=l=>{t.value=t.value.filter(u=>u!==l.key)};return{isKeyDown:r,addListeners:()=>{document.addEventListener("keydown",a),document.addEventListener("keyup",s),window.addEventListener("blur",n)},removeListeners:()=>{document.removeEventListener("keydown",a),document.removeEventListener("keyup",s),window.removeEventListener("blur",n)}}}class Lp{apiURL(t){return`${window.location.origin}${t}`}async fetchApi(t,r){return fetch(this.apiURL(t),r)}}const ds=new Lp;class Fp{constructor(){y(this,"graph",{setDirtyCanvas:()=>{}});y(this,"nodeOutputs",{});y(this,"nodePreviewImages",{})}getPreviewFormatParam(){return"&preview=true"}getRandParam(){return`&rand=${Math.random()}`}}const Kr=new Fp,Gp=Ts("nodeOutput",()=>{function e(a){return Kr.nodeOutputs[String(a.id)]}function t(a){return Kr.nodePreviewImages[String(a.id)]}function r(a){var l;const s=t(a);if(s!=null&&s.length)return s;const i=e(a);if(!((l=i==null?void 0:i.images)!=null&&l.length))return;const o=Kr.getRandParam();return i.images.map(u=>{const c=new URLSearchParams(u);return ds.apiURL(`/view?${c}${o}`)})}function n(a){}return{getNodeOutputs:e,getNodePreviews:t,getNodeImageUrls:r,updateNodeImages:n}}),Dp=!1,Fs="clipspace-painted-masked-";function Vp(e){if(!e.startsWith(Fs))return;const r=e.slice(Fs.length),n=parseInt(r.split(".")[0],10);return{maskedImage:`clipspace-mask-${n}.png`,paint:`clipspace-paint-${n}.png`,paintedImage:`clipspace-painted-${n}.png`,paintedMaskedImage:`${Fs}${n}.png`}}function Gs(e){return{filename:e,subfolder:"clipspace",type:"input"}}function ja(e){const t=new URLSearchParams;t.set("filename",e.ref.filename),e.ref.subfolder&&t.set("subfolder",e.ref.subfolder),e.ref.type&&t.set("type",e.ref.type);const r=ds.apiURL("/view?"+t.toString()+Kr.getPreviewFormatParam()+Kr.getRandParam()),n=new Image;return n.crossOrigin="anonymous",n.src=r,n.src}function jp(){const e=ki(),t=Gp(),r=async u=>{e.setLoading(!0);try{n(u);let c=a(u),p=s(c),d;if(u.widgets){const E=u.widgets.find(G=>G.name==="image");E&&(typeof E.value=="string"?d=E.value:typeof E.value=="object"&&E.value&&"filename"in E.value&&typeof E.value.filename=="string"&&(d=E.value.filename))}if(d)try{let E=d,G,j="input";const H=E.match(/ \[([^\]]+)\]$/);H&&(j=H[1],E=E.substring(0,E.length-H[0].length));const le=E.lastIndexOf("/");le!==-1&&(G=E.substring(0,le),E=E.substring(le+1)),p={filename:E,type:j,subfolder:G},c=ja({ref:p})}catch(E){console.warn("Failed to parse widget filename as ref",E)}const h=d||p.filename;let f,m=Vp(p.filename);if(f){const E=f.painted_masked||f.painted;E&&(m={maskedImage:E,paint:f.paint||"",paintedImage:f.painted||"",paintedMaskedImage:f.painted_masked||E})}const T=m!=null&&m.maskedImage?ja({ref:Gs(m.maskedImage)}):c,_=m!=null&&m.maskedImage?s(T):p;let O=null;f!=null&&f.paint?O=ja({ref:Gs(f.paint)}):m!=null&&m.paint&&(O=ja({ref:Gs(m.paint)}));const[ne,Z,V]=await Promise.all([i(T,"rgb"),i(T,"a"),O?l(O):Promise.resolve(void 0)]);e.inputData={baseLayer:ne,maskLayer:Z,paintLayer:V,sourceRef:_,nodeId:u.id},e.sourceNode=u,e.setLoading(!1)}catch(c){const p=c instanceof Error?c.message:"Failed to load from node";throw console.error("[MaskEditorLoader]",p,c),e.setLoading(!1,p),c}};function n(u){var p;if(!u)throw new Error("Node is null or undefined");if(!(((p=u.imgs)==null?void 0:p.length)||u.previewMediaType==="image"))throw new Error("Node has no images")}function a(u){var p,d,h;if((p=u.images)!=null&&p[0]){const f=u.images[0],m=new URLSearchParams({filename:f.filename,type:f.type||"output",subfolder:f.subfolder||""});return ds.apiURL(`/view?${m.toString()}`)}const c=t.getNodeOutputs(u);if((d=c==null?void 0:c.images)!=null&&d[0]){const f=c.images[0];if(!f.filename)throw new Error("nodeOutputStore image missing filename");const m=new URLSearchParams;return m.set("filename",f.filename),m.set("type",f.type||"output"),m.set("subfolder",f.subfolder||""),ds.apiURL(`/view?${m.toString()}`)}if((h=u.imgs)!=null&&h.length){const f=u.imageIndex??0,m=u.imgs[f].src;if(m&&!m.startsWith("data:"))return m}throw new Error("Unable to get image URL from node")}function s(u){try{const c=new URL(u),p=c.searchParams.get("filename");if(!p)throw new Error("Image URL missing filename parameter");return{filename:p,subfolder:c.searchParams.get("subfolder")||void 0,type:c.searchParams.get("type")||void 0}}catch{try{const p=new URL(u,window.location.origin),d=p.searchParams.get("filename");if(!d)throw new Error("Image URL missing filename parameter");return{filename:d,subfolder:p.searchParams.get("subfolder")||void 0,type:p.searchParams.get("type")||void 0}}catch{throw new Error(`Invalid image URL: ${u}`)}}}async function i(u,c){let p;try{p=new URL(u)}catch{p=new URL(u,window.location.origin)}c&&(p.searchParams.delete("channel"),p.searchParams.set("channel",c));const d=p.toString();return{image:await o(d),url:d}}function o(u){return new Promise((c,p)=>{const d=new Image;d.crossOrigin="anonymous",d.onload=()=>c(d),d.onerror=()=>p(new Error(`Failed to load image: ${u}`)),d.src=u})}async function l(u){let c;try{c=new URL(u)}catch{c=new URL(u,window.location.origin)}const p=c.toString();return{image:await o(p),url:p}}return{loadFromNode:r}}function Np(){const e=Ye(),t=300,r=k(0),n=k(!1),a=k(0),s=k({x:0,y:0}),i=k({x:0,y:0}),o=k(1),l=k(1),u=k({x:0,y:0}),c=k(null),p=k({x:0,y:0}),d=k(null),h=k(null),f=k(null),m=k(null),T=k(null),_=k(null),O=k(null),ne=k(0),Z=k(0),V=k({x:0,y:0}),E=k([]),G=R=>{const K=R[0].clientX-R[1].clientX,ue=R[0].clientY-R[1].clientY;return Math.sqrt(K*K+ue*ue)},j=R=>({x:(R[0].clientX+R[1].clientX)/2,y:(R[0].clientY+R[1].clientY)/2}),H=R=>{const K=R.x-u.value.x,ue=R.y-u.value.y;V.value={x:K,y:ue},e.setCursorPoint({x:K,y:ue})},le=()=>{e.canvasHistory.undo()},pe=async()=>{var ue,Re;if(!((ue=O.value)!=null&&ue.width)||!((Re=O.value)!=null&&Re.height)||!u.value||!o.value){console.warn("Missing required properties for pan/zoom");return}const R=O.value.width*o.value,K=O.value.height*o.value;d.value||(d.value=e.canvasContainer),d.value&&(Object.assign(d.value.style,{width:`${R}px`,height:`${K}px`,left:`${u.value.x}px`,top:`${u.value.y}px`}),f.value||(f.value=e.rgbCanvas),f.value&&((f.value.width!==O.value.width||f.value.height!==O.value.height)&&(f.value.width=O.value.width,f.value.height=O.value.height),f.value.style.width=`${R}px`,f.value.style.height=`${K}px`),e.setPanOffset(u.value),e.setZoomRatio(o.value))},Ue=R=>{c.value={x:R.clientX,y:R.clientY},e.isPanning=!0,p.value={...u.value}},be=async R=>{if(c.value===null)throw new Error("mouseDownPoint is null");const K=c.value.x-R.clientX,ue=c.value.y-R.clientY,Re=p.value.x-K,Fe=p.value.y-ue;u.value={x:Re,y:Fe},await pe()},Le=async R=>{if(i.value===null){i.value={x:R.clientX,y:R.clientY};return}const K=R.clientX-i.value.x,ue=R.clientY-i.value.y;u.value.x+=K,u.value.y+=ue,await pe(),i.value={x:R.clientX,y:R.clientY}},it=R=>{if(R.preventDefault(),!(E.value.length>0))if(e.brushVisible=!1,R.touches.length===2){const K=new Date().getTime();K-r.value<t?(le(),r.value=0):(r.value=K,n.value=!0,a.value=G(R.touches),s.value=j(R.touches))}else R.touches.length===1&&(i.value={x:R.touches[0].clientX,y:R.touches[0].clientY})},yt=async R=>{if(R.preventDefault(),!(E.value.length>0))if(r.value=0,n.value&&R.touches.length===2){const K=G(R.touches),ue=K/a.value,Re=o.value;o.value=Math.max(.2,Math.min(10,o.value*ue));const Fe=o.value,Ce=j(R.touches);if(s.value){const ot=Ce.x-s.value.x,et=Ce.y-s.value.y;u.value.x+=ot,u.value.y+=et}if(h.value===null&&(h.value=e.maskCanvas),!h.value)return;const Xe=h.value.getBoundingClientRect(),Je=Ce.x-Xe.left,rt=Ce.y-Xe.top,Mt=Fe/Re;u.value.x+=Je-Je*Mt,u.value.y+=rt-rt*Mt,await pe(),a.value=K,s.value=Ce}else R.touches.length===1&&await Le(R.touches[0])},gt=R=>{R.preventDefault();const K=R.touches[0];K?i.value={x:K.clientX,y:K.clientY}:(n.value=!1,s.value={x:0,y:0})},Qn=async R=>{const K={x:R.clientX,y:R.clientY},ue=o.value,Re=R.deltaY<0?1.1:.9;o.value=Math.max(.2,Math.min(10,o.value*Re));const Fe=o.value;if(h.value||(h.value=e.maskCanvas),!h.value)return;const Ce=h.value.getBoundingClientRect(),Xe=K.x-Ce.left,Je=K.y-Ce.top,rt=Fe/ue;u.value.x+=Xe-Xe*rt,u.value.y+=Je-Je*rt,await pe();const ot=h.value.clientWidth/ne.value;l.value=ot,e.displayZoomRatio=ot,H(K)},Rt=()=>{var ue,Re;const R=((ue=T.value)==null?void 0:ue.getBoundingClientRect().width)||64;return{sidePanelWidth:((Re=_.value)==null?void 0:Re.getBoundingClientRect().width)||220,toolPanelWidth:R}},Jn=async(R=500)=>{if(!O.value||!m.value)return;const K=o.value,ue={...u.value},{sidePanelWidth:Re,toolPanelWidth:Fe}=Rt(),Ce=m.value.clientWidth-Re-Fe,Xe=m.value.clientHeight,Je=Ce/O.value.width,rt=Xe/O.value.height,Mt=Math.min(Je,rt),ot=O.value.width/O.value.height;let et,lt;const kt={x:Fe,y:0};rt>Je?(et=Ce,lt=et/ot,kt.y=(Xe-lt)/2):(lt=Xe,et=lt*ot,kt.x=(Ce-et)/2+Fe);const ta=performance.now(),tn=async vr=>{const rn=vr-ta,x=Math.min(rn/R,1),w=1-Math.pow(1-x,3);o.value=K+(Mt-K)*w,u.value.x=ue.x+(kt.x-ue.x)*w,u.value.y=ue.y+(kt.y-ue.y)*w,await pe();const P=K+(1-K)*w;e.displayZoomRatio=P,x<1&&requestAnimationFrame(tn)};requestAnimationFrame(tn),l.value=1},ea=async(R,K,ue,Re)=>{m.value=K,T.value=ue||null,_.value=Re||null;const{sidePanelWidth:Fe,toolPanelWidth:Ce}=Rt(),Xe=K.clientWidth-Fe-Ce,Je=K.clientHeight,rt=Xe/R.width,Mt=Je/R.height,ot=R.width/R.height;let et,lt;const kt={x:Ce,y:0};Mt>rt?(et=Xe,lt=et/ot,kt.y=(Je-lt)/2):(lt=Je,et=lt*ot,kt.x=(Xe-et)/2+Ce),O.value===null&&(O.value=R),ne.value=et,Z.value=lt,o.value=Math.min(rt,Mt),u.value=kt,E.value=[],await pe()};return pr(()=>e.resetZoomTrigger,async()=>{l.value!==1&&await Jn()}),{initializeCanvasPanZoom:ea,handlePanStart:Ue,handlePanMove:be,handleTouchStart:it,handleTouchMove:yt,handleTouchEnd:gt,updateCursorPosition:H,zoom:Qn,invalidatePanZoom:pe}}function qp(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}class Wp{constructor(t={}){if(!(t.maxSize&&t.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof t.maxAge=="number"&&t.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=t.maxSize,this.maxAge=t.maxAge||1/0,this.onEviction=t.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(t){if(typeof this.onEviction=="function")for(const[r,n]of t)this.onEviction(r,n.value)}_deleteIfExpired(t,r){return typeof r.expiry=="number"&&r.expiry<=Date.now()?(typeof this.onEviction=="function"&&this.onEviction(t,r.value),this.delete(t)):!1}_getOrDeleteIfExpired(t,r){if(this._deleteIfExpired(t,r)===!1)return r.value}_getItemValue(t,r){return r.expiry?this._getOrDeleteIfExpired(t,r):r.value}_peek(t,r){const n=r.get(t);return this._getItemValue(t,n)}_set(t,r){this.cache.set(t,r),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(t,r){this.oldCache.delete(t),this._set(t,r)}*_entriesAscending(){for(const t of this.oldCache){const[r,n]=t;this.cache.has(r)||this._deleteIfExpired(r,n)===!1&&(yield t)}for(const t of this.cache){const[r,n]=t;this._deleteIfExpired(r,n)===!1&&(yield t)}}get(t){if(this.cache.has(t)){const r=this.cache.get(t);return this._getItemValue(t,r)}if(this.oldCache.has(t)){const r=this.oldCache.get(t);if(this._deleteIfExpired(t,r)===!1)return this._moveToRecent(t,r),r.value}}set(t,r,{maxAge:n=this.maxAge===1/0?void 0:Date.now()+this.maxAge}={}){this.cache.has(t)?this.cache.set(t,{value:r,maxAge:n}):this._set(t,{value:r,expiry:n})}has(t){return this.cache.has(t)?!this._deleteIfExpired(t,this.cache.get(t)):this.oldCache.has(t)?!this._deleteIfExpired(t,this.oldCache.get(t)):!1}peek(t){if(this.cache.has(t))return this._peek(t,this.cache);if(this.oldCache.has(t))return this._peek(t,this.oldCache)}delete(t){const r=this.cache.delete(t);return r&&this._size--,this.oldCache.delete(t)||r}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(t){if(!(t&&t>0))throw new TypeError("`maxSize` must be a number greater than 0");const r=[...this._entriesAscending()],n=r.length-t;n<0?(this.cache=new Map(r),this.oldCache=new Map,this._size=r.length):(n>0&&this._emitEvictions(r.slice(0,n)),this.oldCache=new Map(r.slice(n)),this.cache=new Map,this._size=0),this.maxSize=t}*keys(){for(const[t]of this)yield t}*values(){for(const[,t]of this)yield t}*[Symbol.iterator](){for(const t of this.cache){const[r,n]=t;this._deleteIfExpired(r,n)===!1&&(yield[r,n.value])}for(const t of this.oldCache){const[r,n]=t;this.cache.has(r)||this._deleteIfExpired(r,n)===!1&&(yield[r,n.value])}}*entriesDescending(){let t=[...this.cache];for(let r=t.length-1;r>=0;--r){const n=t[r],[a,s]=n;this._deleteIfExpired(a,s)===!1&&(yield[a,s.value])}t=[...this.oldCache];for(let r=t.length-1;r>=0;--r){const n=t[r],[a,s]=n;this.cache.has(a)||this._deleteIfExpired(a,s)===!1&&(yield[a,s.value])}}*entriesAscending(){for(const[t,r]of this._entriesAscending())yield[t,r.value]}get size(){if(!this._size)return this.oldCache.size;let t=0;for(const r of this.oldCache.keys())this.cache.has(r)||t++;return Math.min(this._size+t,this.maxSize)}}var Yp=Wp;const Zp=qp(Yp);function Xp(e,t){return Bp(e,(r,n,a,s)=>{if(typeof e=="object")switch(Object.prototype.toString.call(e)){case Ql:case Kl:case Jl:{const i=new e.constructor(e==null?void 0:e.valueOf());return Xt(i,e),i}case eu:{const i={};return Xt(i,e),i.length=e.length,i[Symbol.iterator]=e[Symbol.iterator],i}default:return}})}function to(e){return Xp(e)}function ro(e){return e!==null&&typeof e=="object"&&Hl(e)==="[object Arguments]"}function no(e){return typeof e=="object"&&e!==null}function Hp(e,t=0,r={}){typeof r!="object"&&(r={});const{leading:n=!1,trailing:a=!0,maxWait:s}=r,i=Array(2);n&&(i[0]="leading"),a&&(i[1]="trailing");let o,l=null;const u=op(function(...d){o=e.apply(this,d),l=null},t,{edges:i}),c=function(...d){return s!=null&&(l===null&&(l=Date.now()),Date.now()-l>=s)?(o=e.apply(this,d),l=Date.now(),u.cancel(),u.schedule(),o):(u.apply(this,d),o)},p=()=>(u.flush(),o);return c.cancel=u.cancel,c.flush=p,c}function _i(e,t){if(typeof e!="function"||t!=null&&typeof t!="function")throw new TypeError("Expected a function");const r=function(...a){const s=t?t.apply(this,a):a[0],i=r.cache;if(i.has(s))return i.get(s);const o=e.apply(this,a);return r.cache=i.set(s,o)||i,o},n=_i.Cache||Map;return r.cache=new n,r}_i.Cache=Map;function Kp(e){return Mi(e)}function Qp(e,...t){const r=t.slice(0,-1),n=t[t.length-1];let a=e;for(let s=0;s<r.length;s++){const i=r[s];a=ts(a,i,n,new Map)}return a}function ts(e,t,r,n){if(Si(e)&&(e=Object(e)),t==null||typeof t!="object")return e;if(n.has(t))return up(n.get(t));if(n.set(t,e),Array.isArray(t)){t=t.slice();for(let s=0;s<t.length;s++)t[s]=t[s]??void 0}const a=[...Object.keys(t),...Xl(t)];for(let s=0;s<a.length;s++){const i=a[s];if(zp(i))continue;let o=t[i],l=e[i];if(ro(o)&&(o={...o}),ro(l)&&(l={...l}),typeof Buffer<"u"&&Buffer.isBuffer(o)&&(o=to(o)),Array.isArray(o))if(typeof l=="object"&&l!=null){const c=[],p=Reflect.ownKeys(l);for(let d=0;d<p.length;d++){const h=p[d];c[h]=l[h]}l=c}else l=[];const u=r(l,o,i,e,t,n);u!==void 0?e[i]=u:Array.isArray(o)||no(l)&&no(o)?e[i]=ts(l,o,r,n):l==null&&Ip(o)?e[i]=ts({},o,r,n):l==null&&Kp(o)?e[i]=to(o):(l===void 0||o!==void 0)&&(e[i]=o)}return e}function Jp(e,...t){return Qp(e,...t,lp)}function ao({r:e,g:t,b:r}){e/=255,t/=255,r/=255;const n=Math.max(e,t,r),a=Math.min(e,t,r);let s=0,i=0;const o=(n+a)/2;if(n!==a){const l=n-a;switch(i=o>.5?l/(2-n-a):l/(n+a),n){case e:s=(t-r)/l+(t<r?6:0);break;case t:s=(r-e)/l+2;break;case r:s=(e-t)/l+4;break}s/=6}return{h:s,s:i,l:o}}function nu(e){let t=0,r=0,n=0;return e.length==4?(t=parseInt(e[1]+e[1],16),r=parseInt(e[2]+e[2],16),n=parseInt(e[3]+e[3],16)):e.length==7&&(t=parseInt(e.slice(1,3),16),r=parseInt(e.slice(3,5),16),n=parseInt(e.slice(5,7),16)),{r:t,g:r,b:n}}function Na(e){const t=au(e);if(!t)return{r:0,g:0,b:0};const r=iu(e,t);if(!su(r))return{r:0,g:0,b:0};const n=r.h/360,a=r.s/100,s=r.l/100,i=(1-Math.abs(2*s-1))*a,o=i*(1-Math.abs(n*6%2-1)),l=s-i/2;let u=0,c=0,p=0;return n<1/6?(u=i,c=o,p=0):n<2/6?(u=o,c=i,p=0):n<3/6?(u=0,c=i,p=o):n<4/6?(u=0,c=o,p=i):n<5/6?(u=o,c=0,p=i):(u=i,c=0,p=o),{r:Math.round((u+l)*255),g:Math.round((c+l)*255),b:Math.round((p+l)*255)}}const au=e=>e?e.startsWith("#")&&(e.length===4||e.length===7)?"hex":/rgba?\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*/.test(e)?e.includes("rgba")?"rgba":"rgb":/hsla?\(\s*\d+(\.\d+)?\s*,\s*\d+(\.\d+)?%\s*,\s*\d+(\.\d+)?%/.test(e)?e.includes("hsla")?"hsla":"hsl":null:null,su=e=>typeof e!="object"||e===null?!1:["h","s","l","a"].every(t=>typeof e[t]=="number"&&!isNaN(e[t]));function iu(e,t){let r;switch(t){case"hex":{const n=ao(nu(e));return{h:Math.round(n.h*360),s:+(n.s*100).toFixed(1),l:+(n.l*100).toFixed(1),a:1}}case"rgb":case"rgba":{if(r=e.match(/\d+(\.\d+)?/g),!r||r.length<3)return null;const[n,a,s]=r.map(Number),i=ao({r:n,g:a,b:s}),o=t==="rgba"&&r[3]?parseFloat(r[3]):1;return{h:Math.round(i.h*360),s:+(i.s*100).toFixed(1),l:+(i.l*100).toFixed(1),a:o}}case"hsl":case"hsla":{if(r=e.match(/\d+(\.\d+)?/g),!r||r.length<3)return null;const[n,a,s]=r.map(Number),i=t==="hsla"&&r[3]?parseFloat(r[3]):1;return{h:n,s:a,l:s,a:i}}default:return null}}const ef=(e,t)=>{if(!Object.keys(t).length)return e;const r=au(e);if(!r)return console.warn(`Unsupported color format in color palette: ${e}`),e;const n=iu(e,r);return su(n)?(t.lightness&&(n.l=Math.max(0,Math.min(100,n.l+t.lightness*100))),t.opacity&&(n.a=Math.max(0,Math.min(1,t.opacity))),`hsla(${n.h}, ${n.s}%, ${n.l}%, ${n.a})`):(console.warn(`Invalid color values in color palette: ${e}`),e)};_i(ef,(e,t)=>`${e}-${JSON.stringify(t)}`);function tf(e,t){try{const r=localStorage.getItem(e);return r?JSON.parse(r):t}catch{return t}}function rf(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(r){console.warn("Failed to save to localStorage:",r)}}function nf(){const e=Ye();return{screenToCanvas:n=>{const a=I(e.pointerZone),s=I(e.canvasContainer),i=I(e.maskCanvas);if(!a||!s||!i)return console.warn("screenToCanvas called before elements are available"),{x:0,y:0};const o=a.getBoundingClientRect(),l=s.getBoundingClientRect(),u=i.getBoundingClientRect(),c=o.left+n.x,p=o.top+n.y,d=c-l.left,h=p-l.top,f=i.width/u.width,m=i.height/u.height,T=d*f,_=h*m;return{x:T,y:_}},canvasToScreen:n=>{const a=I(e.pointerZone),s=I(e.canvasContainer),i=I(e.maskCanvas);if(!a||!s||!i)return console.warn("canvasToScreen called before elements are available"),{x:0,y:0};const o=a.getBoundingClientRect(),l=s.getBoundingClientRect(),u=i.getBoundingClientRect(),c=u.width/i.width,p=u.height/i.height,d=n.x*c,h=n.y*p,f=l.left+d,m=l.top+h,T=f-o.left,_=m-o.top;return{x:T,y:_}}}}const ou=tu(nf);function af(e,t,r,n,a){const i=(ne,Z,V)=>{const E=Math.hypot(V.x-Z.x,V.y-Z.y);return ne+Math.pow(E,.5)},l=i(0,e,t),u=i(l,t,r),c=i(u,r,n),p=l+(u-l)*a,d=(ne,Z,V,E,G)=>{if(Math.abs(E-V)<1e-4)return ne;const j=(G-V)/(E-V);return sf(so(ne,1-j),so(Z,j))},h=d(e,t,0,l,p),f=d(t,r,l,u,p),m=d(r,n,u,c,p),T=d(h,f,0,u,p),_=d(f,m,l,c,p);return d(T,_,l,u,p)}function sf(e,t){return{x:e.x+t.x,y:e.y+t.y}}function so(e,t){return{x:e.x*t,y:e.y*t}}function lu(e,t,r){if(e.length===0)return{points:[],remainder:r};const n=[];let a=0,s=r;for(let o=0;o<e.length-1;o++){const l=e[o],u=e[o+1],c=u.x-l.x,p=u.y-l.y,d=Math.hypot(c,p);if(d<1e-4){for(;s<=a;)n.push(l),s+=t;continue}for(;s<=a+d;){const h=(s-a)/d,f=l.x+h*c,m=l.y+h*p;n.push({x:f,y:m}),s+=t}a+=d}const i=s-a;return{points:n,remainder:i}}var of={block:0,binaryExpr:1,assignmentExpr:2,logicalExpr:3,unaryExpr:4,numericLiteral:5,call:6,memberAccess:7,indexAccess:8,return:10,if:11,let:12,const:13,for:14,while:15,continue:16,break:17,arrayExpr:100,preUpdate:101,postUpdate:102,stringLiteral:103,objectExpr:104},Js={identifier:"i",destructuredObject:"d"},lf=1;const uf=Object.freeze(Object.defineProperty({__proto__:null,FORMAT_VERSION:lf,FuncParameterType:Js,NodeTypeCatalog:of},Symbol.toStringTag,{value:"Module"}));function da(e,t){for(let[r,n]of Object.entries(t))e[r]=n,n&&(typeof n=="object"||typeof n=="function")&&C(n)===void 0&&Be(n,r)}function cf(e,t,r){let n=[...e.matchAll(/:\s*(?<arg>.*?)\s*[,)]/g)].map(a=>a?a[1]:void 0);r(Object.fromEntries(t.flatMap((a,s)=>{let i=n?n[s]:void 0;return Tt(a)&&i!==void 0?[[i,a]]:[]})))}function uu(e,t,r){var s;let n=e.match(/->\s(?<output>[\w\d_]+)\s{/),a=n?(s=n[1])==null?void 0:s.trim():void 0;Tt(t)&&a&&!/\s/g.test(a)&&r({[a]:t})}function pf(e){return new RegExp(`(?<![\\w\\$_.])${e.replaceAll(".","\\.").replaceAll("$","\\$")}(?![\\w\\$_])`,"g")}function ks(e,t,r){return Object.entries(t).reduce((n,[a,s])=>{let i=pf(a);if(r&&a!=="Out"&&a!=="In"&&!i.test(r)&&console.warn(`The external '${a}' wasn't used in the resolved template.`),Ic(s)||gi(s)||es(s))return n.replaceAll(i,e.resolve(s).value);if(s!==null&&typeof s=="object"){let o=[...r.matchAll(new RegExp(`${a.replaceAll(".","\\.").replaceAll("$","\\$")}\\.(?<prop>.*?)(?![\\w\\$_])`,"g"))].map(l=>l[1]);return[...new Set(o)].reduce((l,u)=>u&&u in s?ks(e,{[`${a}.${u}`]:s[u]},l):l,n)}return console.warn(`During resolution, the external '${a}' has been omitted. Only primitives, TGPU resources and plain JS objects can be used as externals.`),n},r)}function ff(e){let{strippedCode:t,argRange:r}=df(e),n=new cu(t);n.consume("(");let a=[];for(;!n.isAt(")");){let i=[];for(;n.isAt("@");)n.parseUntil(io,oo),n.consume(")"),i.push(n.lastParsed);n.parseUntil(mf);let o=n.lastParsed,l;n.isAt(":")&&(n.consume(":"),n.parseUntil(yf,vf),l=n.lastParsed),a.push({identifier:o,attributes:i,type:l}),n.isAt(",")&&n.consume(",")}n.consume(")");let s;if(n.isAt("->")){n.consume("->");let i=[];for(;n.isAt("@");)n.parseUntil(io,oo),n.consume(")"),i.push(n.lastParsed);s={type:n.str.slice(n.pos),attributes:i}}return{args:a,ret:s,range:{begin:r[0],end:r[1]}}}function df(e){let t=new cu(e),r="",n;for(;!t.isFinished();){if(t.isAt(hf)){t.advanceBy(1);continue}if(t.isAt("//")){t.consume("//"),t.parseUntil(pu),t.advanceBy(1);continue}if(t.isAt("/*")){t.parseUntil(gf,wf),t.consume("*/");continue}if(t.isAt("{"))return{strippedCode:r,argRange:[n,t.pos]};t.isAt("(")&&n===void 0&&(n=t.pos),n!==void 0&&(r+=t.str[t.pos]),t.advanceBy(1)}throw new Error("Invalid wgsl code!")}var _n,nt,Lo,cu=(Lo=class{constructor(t){W(this,_n);W(this,nt);this.str=t,N(this,nt,0)}get pos(){return g(this,nt)}get lastParsed(){if(g(this,_n)===void 0)throw new Error("Parse was not called yet!");return this.str.slice(g(this,_n),this.pos)}isFinished(){return g(this,nt)>=this.str.length}isAt(t){if(typeof t=="string"){for(let r=0;r<t.length;r++)if(this.str[g(this,nt)+r]!==t[r])return!1;return!0}for(let r of t)if(this.isAt(r))return!0;return!1}parseUntil(t,r){N(this,_n,g(this,nt));let n=0;for(;g(this,nt)<this.str.length;){if(r&&this.isAt(r[0])&&(n+=1),r&&this.isAt(r[1])&&(n-=1),n===0&&this.isAt(t))return g(this,nt);N(this,nt,g(this,nt)+1)}throw new Error("Reached the end of the string without finding a match!")}advanceBy(t){N(this,nt,g(this,nt)+t)}consume(t){if(!this.isAt(t))throw new Error(`Expected '${t}' at position ${g(this,nt)}, but found '${this.str.slice(g(this,nt),g(this,nt)+t.length)}'`);this.advanceBy(t.length)}},_n=new WeakMap,nt=new WeakMap,Lo),pu=new Set([`
`,"\v","\f","\r","","\u2028","\u2029"]),hf=new Set([...pu," ","	","‎","‏"]),io=new Set([")"]),mf=new Set([":",",",")"]),yf=new Set([",",")"]),gf=new Set(["*/"]),oo=["(",")"],vf=["<",">"],wf=["/*","*/"];function Ca(e,t=""){let r=[],n={applyExternals(s){r.push(s)},resolve(s,i,o){var ne;let l={};for(let Z of r)da(l,Z);let u=s.getUniqueName(this);if(typeof e=="string"){if(!o)throw new Error("Explicit return type is required for string implementation");let Z=ks(s,l,e),V="",E="";if(t!==""){let G=Tt(i[0])?`(in: ${s.resolve(i[0]).value})`:"()",j=$s(o)?vi(o):"",H=o!==ft?Tt(o)?`-> ${s.resolve(o).value}`:`-> ${j!==""?j:"@location(0)"} ${s.resolve(o).value}`:"";V=`${G} ${H} `,E=Z}else{let G=ff(Z);if(G.args.length!==i.length)throw new Error(`WGSL implementation has ${G.args.length} arguments, while the shell has ${i.length} arguments.`);let j=G.args.map((le,pe)=>`${le.identifier}: ${lo(s,`parameter ${le.identifier}`,le.type,i[pe])}`).join(", "),H=o===ft?"":`-> ${lo(s,"return type",(ne=G.ret)==null?void 0:ne.type,o)}`;V=`(${j}) ${H}`,E=Z.slice(G.range.end)}return s.addDeclaration(`${t}fn ${u}${V}${E}`),M(u,o)}let c=Gl(e);if(c!=null&&c.externals){let Z=Object.fromEntries(Object.entries(c.externals).filter(([V])=>!(V in l)));da(l,Z)}let p=c==null?void 0:c.ast;if(!p)throw new Error("Missing metadata for tgpu.fn function body (either missing 'use gpu' directive, or misconfigured `unplugin-typegpu`)");let d=p.externalNames.filter(Z=>!(Z in l));if(d.length>0)throw new Uc(C(this),d);let h=p.params[1];h&&h.type==="i"&&t!==""&&da(l,{[h.name]:Ec(o)});let f=[],m=[];for(let[Z,V]of i.entries()){let E=p.params[Z];switch(E==null?void 0:E.type){case Js.identifier:{let G=E.name,j=M(s.makeNameValid(G),V);f.push(j),j.value!==G&&m.push([G,j]);break}case Js.destructuredObject:{f.push(M(`_arg_${Z}`,V)),m.push(...E.props.map(({name:G,alias:j})=>[j,M(`_arg_${Z}.${G}`,i[Z].propTypes[G])]));break}case void 0:f.push(M(`_arg_${Z}`,V))}}let{head:T,body:_,returnType:O}=s.fnToWgsl({args:f,argAliases:Object.fromEntries(m),returnType:o,body:p.body,externalMap:l});return s.addDeclaration(`${t}fn ${u}${s.resolve(T).value}${s.resolve(_).value}`),M(u,O)}},a=C(e);return a!==void 0&&Be(n,a),n}function lo(e,t,r,n){let a=e.resolve(n).value.replace(/\s/g,"");if(!r)return a;let s=r.replace(/\s/g,"");if(s!==a)throw new Error(`Type mismatch between TGPU shell and WGSL code string: ${t}, JS type "${a}", WGSL type "${s}".`);return r}function xf(e,t={}){let r=0,n=new Set;return Object.fromEntries(Object.entries(e??{}).map(([a,s])=>{let i=Pr(s);if(i!==void 0){if(n.has(i))throw new Error("Duplicate custom location attributes found");n.add(i)}return[a,s]}).map(([a,s])=>{if(Ua(s))return[a,s];if(Pr(s)!==void 0)return[a,s];if(t[a])return[a,Jt(t[a],s)];for(;n.has(r);)r++;return[a,Jt(r++,s)]}))}function Aa(e,t={}){return qn(e)?Fl(e)||Pr(e)!==void 0?e:Jt(0,e):Ia(xf(e,t))}function _s(e,...t){return bf(e)?Tf(e,...t):e}function bf(e){return Array.isArray(e)&&"raw"in e&&Array.isArray(e.raw)&&e.raw.every(t=>typeof t=="string")}function Tf(e,...t){return e.slice(1).reduce((r,n,a)=>`${r}${t[a]}${n}`,e[0])}function $f(e){if(Object.keys(e.out).length===0)throw new Error("A vertexFn output cannot be empty since it must include the 'position' builtin.");let t={in:e.in,out:e.out,argTypes:e.in&&Object.keys(e.in).length!==0?[Aa(e.in)]:[],isEntry:!0},r=(n,...a)=>Sf(t,_s(n,...a));return Object.assign(Object.assign(r,t),{does:r})}function Sf(e,t){let r=Ca(t,"@vertex "),n=e.argTypes[0];return{shell:e,$uses(a){return r.applyExternals(a),this},[v]:!0,[Ve]:r,$name(a){return Be(r,a),yi(n)&&n.$name(`${a}_Input`),this},[J](a){let s=Aa(e.out,a.varyingLocations).$name(`${C(this)??""}_Output`);return typeof t=="string"&&(n&&r.applyExternals({In:n}),r.applyExternals({Out:s})),r.resolve(a,e.argTypes,s)},toString(){return`vertexFn:${C(r)??"<unnamed>"}`}}}var Bi=class{};function Pi(e){let t=Qe((...n)=>{let a=[];for(let s of n)if(typeof s=="number")a.push(s);else for(let i=0;i<s.length;++i)a.push(s[i]);if(a.length!==0&&a.length!==e.columns*e.rows)throw new Error(`'${e.type}' constructor called with invalid number of arguments.`);for(let s=a.length;s<e.columns*e.rows;++s)a.push(0);return new e.MatImpl(...a)},(...n)=>M($`${e.type}(${n})`,r),e.type),r=Object.assign(t,{type:e.type,identity:Rf[e.columns],translation:e.columns===4?Cf:void 0,scaling:e.columns===4?Af:void 0,rotationX:e.columns===4?Of:void 0,rotationY:e.columns===4?Lf:void 0,rotationZ:e.columns===4?Ff:void 0});return r}var Fo,Mf=class extends Bi{constructor(...r){super();y(this,Fo,!0);y(this,"columns");y(this,"length",4);this.columns=[this.makeColumn(r[0],r[1]),this.makeColumn(r[2],r[3])]}get 0(){return this.columns[0].x}get 1(){return this.columns[0].y}get 2(){return this.columns[1].x}get 3(){return this.columns[1].y}set 0(r){this.columns[0].x=r}set 1(r){this.columns[0].y=r}set 2(r){this.columns[1].x=r}set 3(r){this.columns[1].y=r}*[(Fo=v,Symbol.iterator)](){yield this[0],yield this[1],yield this[2],yield this[3]}[J](){return M(`${this.kind}(${Array.from({length:this.length}).map((r,n)=>this[n]).join(", ")})`,tr)}toString(){return this[J]().value}},kf=class extends Mf{constructor(){super(...arguments);y(this,"kind","mat2x2f")}makeColumn(r,n){return ke(r,n)}},Go,_f=class extends Bi{constructor(...t){super();y(this,Go,!0);y(this,"columns");y(this,"length",12);this.columns=[this.makeColumn(t[0],t[1],t[2]),this.makeColumn(t[3],t[4],t[5]),this.makeColumn(t[6],t[7],t[8])]}get 0(){return this.columns[0].x}get 1(){return this.columns[0].y}get 2(){return this.columns[0].z}get 3(){return 0}get 4(){return this.columns[1].x}get 5(){return this.columns[1].y}get 6(){return this.columns[1].z}get 7(){return 0}get 8(){return this.columns[2].x}get 9(){return this.columns[2].y}get 10(){return this.columns[2].z}get 11(){return 0}set 0(t){this.columns[0].x=t}set 1(t){this.columns[0].y=t}set 2(t){this.columns[0].z=t}set 3(t){}set 4(t){this.columns[1].x=t}set 5(t){this.columns[1].y=t}set 6(t){this.columns[1].z=t}set 7(t){}set 8(t){this.columns[2].x=t}set 9(t){this.columns[2].y=t}set 10(t){this.columns[2].z=t}set 11(t){}*[(Go=v,Symbol.iterator)](){for(let t=0;t<12;t++)yield this[t]}[J](){return M(`${this.kind}(${this[0]}, ${this[1]}, ${this[2]}, ${this[4]}, ${this[5]}, ${this[6]}, ${this[8]}, ${this[9]}, ${this[10]})`,rr)}toString(){return this[J]().value}},Bf=class extends _f{constructor(){super(...arguments);y(this,"kind","mat3x3f")}makeColumn(t,r,n){return Ke(t,r,n)}},Do,Pf=class extends Bi{constructor(...t){super();y(this,Do,!0);y(this,"columns");y(this,"length",16);this.columns=[this.makeColumn(t[0],t[1],t[2],t[3]),this.makeColumn(t[4],t[5],t[6],t[7]),this.makeColumn(t[8],t[9],t[10],t[11]),this.makeColumn(t[12],t[13],t[14],t[15])]}get 0(){return this.columns[0].x}get 1(){return this.columns[0].y}get 2(){return this.columns[0].z}get 3(){return this.columns[0].w}get 4(){return this.columns[1].x}get 5(){return this.columns[1].y}get 6(){return this.columns[1].z}get 7(){return this.columns[1].w}get 8(){return this.columns[2].x}get 9(){return this.columns[2].y}get 10(){return this.columns[2].z}get 11(){return this.columns[2].w}get 12(){return this.columns[3].x}get 13(){return this.columns[3].y}get 14(){return this.columns[3].z}get 15(){return this.columns[3].w}set 0(t){this.columns[0].x=t}set 1(t){this.columns[0].y=t}set 2(t){this.columns[0].z=t}set 3(t){this.columns[0].w=t}set 4(t){this.columns[1].x=t}set 5(t){this.columns[1].y=t}set 6(t){this.columns[1].z=t}set 7(t){this.columns[1].w=t}set 8(t){this.columns[2].x=t}set 9(t){this.columns[2].y=t}set 10(t){this.columns[2].z=t}set 11(t){this.columns[2].w=t}set 12(t){this.columns[3].x=t}set 13(t){this.columns[3].y=t}set 14(t){this.columns[3].z=t}set 15(t){this.columns[3].w=t}*[(Do=v,Symbol.iterator)](){for(let t=0;t<16;t++)yield this[t]}[J](){return M(`${this.kind}(${Array.from({length:this.length}).map((t,r)=>this[r]).join(", ")})`,Oe)}toString(){return this[J]().value}},zf=class extends Pf{constructor(){super(...arguments);y(this,"kind","mat4x4f")}makeColumn(r,n,a,s){return S(r,n,a,s)}},If=Qe(()=>tr(1,0,0,1),()=>M("mat2x2f(1, 0, 0, 1)",tr),"identity2"),Uf=Qe(()=>rr(1,0,0,0,1,0,0,0,1),()=>M("mat3x3f(1, 0, 0, 0, 1, 0, 0, 0, 1)",rr),"identity3"),Ef=Qe(()=>Oe(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),()=>M("mat4x4f(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1)",Oe),"identity4"),Rf={2:If,3:Uf,4:Ef},Cf=Qe(e=>Oe(1,0,0,0,0,1,0,0,0,0,1,0,e.x,e.y,e.z,1),e=>M($`mat4x4f(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, ${e}.x, ${e}.y, ${e}.z, 1)`,Oe),"translation4"),Af=Qe(e=>Oe(e.x,0,0,0,0,e.y,0,0,0,0,e.z,0,0,0,0,1),e=>M($`mat4x4f(${e}.x, 0, 0, 0, 0, ${e}.y, 0, 0, 0, 0, ${e}.z, 0, 0, 0, 0, 1)`,Oe),"scaling4"),Of=Qe(e=>Oe(1,0,0,0,0,Math.cos(e),Math.sin(e),0,0,-Math.sin(e),Math.cos(e),0,0,0,0,1),e=>M($`mat4x4f(1, 0, 0, 0, 0, cos(${e}), sin(${e}), 0, 0, -sin(${e}), cos(${e}), 0, 0, 0, 0, 1)`,Oe),"rotationX4"),Lf=Qe(e=>Oe(Math.cos(e),0,-Math.sin(e),0,0,1,0,0,Math.sin(e),0,Math.cos(e),0,0,0,0,1),e=>M($`mat4x4f(cos(${e}), 0, -sin(${e}), 0, 0, 1, 0, 0, sin(${e}), 0, cos(${e}), 0, 0, 0, 0, 1)`,Oe),"rotationY4"),Ff=Qe(e=>Oe(Math.cos(e),Math.sin(e),0,0,-Math.sin(e),Math.cos(e),0,0,0,0,1,0,0,0,0,1),e=>M($`mat4x4f(cos(${e}), sin(${e}), 0, 0, -sin(${e}), cos(${e}), 0, 0, 0, 0, 1, 0, 0, 0, 0, 1)`,Oe),"rotationZ4"),tr=Pi({type:"mat2x2f",rows:2,columns:2,MatImpl:kf}),rr=Pi({type:"mat3x3f",rows:3,columns:3,MatImpl:Bf}),Oe=Pi({type:"mat4x4f",rows:4,columns:4,MatImpl:zf});function Gf(e){return e==null?void 0:e[he]}var Df={f:{1:b,2:ke,3:Ke,4:S},h:{1:St,2:yr,3:mr,4:hr},i:{1:qe,2:bt,3:Gt,4:ze},u:{1:te,2:cr,3:dt,4:Ae},b:{1:at,2:Xn,3:Zn,4:Yn}},Vf={vec2f:ke,vec2h:yr,vec2i:bt,vec2u:cr,"vec2<bool>":Xn,vec3f:Ke,vec3h:mr,vec3i:Gt,vec3u:dt,"vec3<bool>":Zn,vec4f:S,vec4h:hr,vec4i:ze,vec4u:Ae,"vec4<bool>":Yn,mat2x2f:tr,mat3x3f:rr,mat4x4f:Oe};function ei(e,t){if(Tt(e)||Ea(e))return e.propTypes[t]??pt;if(e===at||zr(e))return pt;let r=t.length;if(Wn(e)&&r>=1&&r<=4){let n=e.type.includes("bool")?"b":e.type[4],a=Df[n][r];if(a)return a}return pt}var uo={mat2x2f:ke,mat3x3f:Ke,mat4x4f:S};function Ds(e){return fr(e)||xi(e)?e.elementType:Wn(e)?e.primitive:e.type in uo?uo[e.type]:pt}function hs(e){return e>=2**63||e<-9223372036854776e3?M(e,Dt):Number.isInteger(e)?(Number.isSafeInteger(e)||console.warn(`The integer ${e} exceeds the safe integer range and may have lost precision.`),M(e,Ss)):M(e,Dt)}function ba(e){return e.type==="abstractFloat"?b:e.type==="abstractInt"?qe:e}function jf(e){return e.map(t=>M(t.value,ba(t.dataType)))}function rs(e){return Dl(e)?e:Vl(e)||(Ie(e)||sr(e)?M(e,Vf[e.kind]):typeof e=="string"||typeof e=="function"||typeof e=="object"||typeof e=="symbol"||typeof e>"u"||e===null?M(e,pt):typeof e=="number"?hs(e):typeof e=="boolean"?M(e,at):M(e,pt))}var jt={get(e,t){if(t in e)return Reflect.get(e,t);if(t==="toString"||t===Symbol.toStringTag||t===Symbol.toPrimitive)return()=>e.toString();if(typeof t=="symbol")return;let r=Vl(e).dataType,n=ei(r,String(t));if(n.type!=="unknown")return new Proxy({[v]:!0,[J]:a=>M(`${a.resolve(e).value}.${String(t)}`,n),get[$t](){return M(this,n)},toString:()=>`${String(e)}.${t}`},jt)}};function Bs(e){let t=e;for(;;){let r=Gf(t);if(!r)break;t=r}return t}function ti(e,t){return new Nf(e,t)}var Vo,Bn,jo,Nf=(jo=class{constructor(e,t){y(this,Vo,{});W(this,Bn);this.dataType=e,N(this,Bn,t)}$name(e){return Be(this,e),this}[(Vo=v,J)](e){let t=e.getUniqueName(this),r=e.resolve(this.dataType).value,n=e.resolve(g(this,Bn),this.dataType).value;return e.addDeclaration(`const ${t}: ${r} = ${n};`),M(t,this.dataType)}toString(){return`const:${C(this)??"<unnamed>"}`}get[he](){let e=this.dataType;return new Proxy({[v]:!0,get[$t](){return M(this,e)},[J]:t=>t.resolve(this),toString:()=>`const:${C(this)??"<unnamed>"}.$`},jt)}get value(){return Ir()?this[he]:g(this,Bn)}get $(){return this.value}},Bn=new WeakMap,jo);function fu(){return{[v]:!0,type:"sampler",[Ra]:void 0}}function du(){return{[v]:!0,type:"sampler_comparison",[Ra]:void 0}}function qf(e){return!!e[v]&&e.type==="sampler"}function Wf(e){return!!e[v]&&e.type==="sampler_comparison"}function ri(e){if("multisampled"in e){if(e.multisampled){if(e.dimension==="2d")return Xf(e.sampleType);throw new Error(`Multisampled textures only support '2d' dimension, got '${e.dimension}'`)}switch(e.dimension){case"1d":return Yf(e.sampleType);case"2d":return Zf(e.sampleType);case"2d-array":return Hf(e.sampleType);case"3d":return Jf(e.sampleType);case"cube":return Kf(e.sampleType);case"cube-array":return Qf(e.sampleType);default:throw new Error(`Unsupported texture dimension: '${e.dimension}'`)}}if(!("access"in e))throw new Error("Descriptor is neither a sampled nor a storage texture");switch(e.dimension){case"1d":return ed(e.format,e.access);case"2d":return td(e.format,e.access);case"2d-array":return rd(e.format,e.access);case"3d":return nd(e.format,e.access);default:throw new Error(`Unsupported storage texture dimension: '${e.dimension}'`)}}function Jr(e,t){let r=e.startsWith("texture_depth")?["depth","float","unfilterable-float"]:t.sampleType.type==="i32"?["sint"]:t.sampleType.type==="u32"?["uint"]:["float","unfilterable-float"];return{[v]:!0,[Ra]:void 0,type:e,bindingSampleType:r,...t}}function Ps(e,t){return{[v]:!0,[Ra]:void 0,type:e,...t}}var co=new Map,Oa={"write-only":"write","read-only":"read","read-write":"read_write"};function Et(e,t){let r=co.get(e);return r||(r=t(),co.set(e,r)),r}function Yf(e){let t=e||b,r=`texture_1d<${t.type}>`;return Et(r,()=>Jr("texture_1d",{dimension:"1d",sampleType:t,multisampled:!1}))}function Zf(e){let t=e||b,r=`texture_2d<${t.type}>`;return Et(r,()=>Jr("texture_2d",{dimension:"2d",sampleType:t,multisampled:!1}))}function Xf(e){let t=e||b,r=`texture_multisampled_2d<${t.type}>`;return Et(r,()=>Jr("texture_multisampled_2d",{dimension:"2d",sampleType:t,multisampled:!0}))}function Hf(e){let t=e||b,r=`texture_2d_array<${t.type}>`;return Et(r,()=>Jr("texture_2d_array",{dimension:"2d-array",sampleType:t,multisampled:!1}))}function Kf(e){let t=e||b,r=`texture_cube<${t.type}>`;return Et(r,()=>Jr("texture_cube",{dimension:"cube",sampleType:t,multisampled:!1}))}function Qf(e){let t=e||b,r=`texture_cube_array<${t.type}>`;return Et(r,()=>Jr("texture_cube_array",{dimension:"cube-array",sampleType:t,multisampled:!1}))}function Jf(e){let t=e||b,r=`texture_3d<${t.type}>`;return Et(r,()=>Jr("texture_3d",{dimension:"3d",sampleType:t,multisampled:!1}))}function ed(e,t){let r=t||"write-only",n=`texture_storage_1d<${e}, ${Oa[r]}>`;return Et(n,()=>Ps("texture_storage_1d",{dimension:"1d",format:e,access:r}))}function td(e,t){let r=t||"write-only",n=`texture_storage_2d<${e}, ${Oa[r]}>`;return Et(n,()=>Ps("texture_storage_2d",{dimension:"2d",format:e,access:r}))}function rd(e,t){let r=t||"write-only",n=`texture_storage_2d_array<${e}, ${Oa[r]}>`;return Et(n,()=>Ps("texture_storage_2d_array",{dimension:"2d-array",format:e,access:r}))}function nd(e,t){let r=t||"write-only",n=`texture_storage_3d<${e}, ${Oa[r]}>`;return Et(n,()=>Ps("texture_storage_3d",{dimension:"3d",format:e,access:r}))}function ad(){return Et("texture_external",()=>({[v]:!0,[Ra]:void 0,type:"texture_external",dimension:"2d"}))}function sd(e){return!!e[v]&&typeof e.multisampled=="boolean"}function ni(e){return!!e[v]&&typeof e.format=="string"&&typeof e.access=="string"}function id(e){return new od(e)}var No,od=(No=v,class{constructor(e){y(this,No,!0);y(this,"type","atomic");this.inner=e}}),Or=(e,t,r)=>{if(e===t)return 0;let n=ae((r-e)/(t-e),0,1);return n*n*(3-2*n)},ae=(e,t,r)=>Math.min(Math.max(t,e),r),an=(e,t)=>t===0?e:Math.trunc(e/t);function Wt(e){let t=new DataView(new ArrayBuffer(4));return t.setUint32(0,e,!0),t.getFloat32(0,!0)}function Yt(e){let t=new DataView(new ArrayBuffer(4));return t.setUint32(0,e,!0),t.getInt32(0,!0)}var _t=Xn[v].jsImpl,It=ke[v].jsImpl,ir=yr[v].jsImpl,Sn=bt[v].jsImpl,ha=cr[v].jsImpl,Bt=Zn[v].jsImpl,vt=Ke[v].jsImpl,Ht=mr[v].jsImpl,Mn=Gt[v].jsImpl,ma=dt[v].jsImpl,Pt=Yn[v].jsImpl,Ut=S[v].jsImpl,or=hr[v].jsImpl,kn=ze[v].jsImpl,ya=Ae[v].jsImpl,sn=e=>Math.sqrt(e.x**2+e.y**2),on=e=>Math.sqrt(e.x**2+e.y**2+e.z**2),ln=e=>Math.sqrt(e.x**2+e.y**2+e.z**2+e.w**2),qa=(e,t)=>e.x*t.x+e.y*t.y,Wa=(e,t)=>e.x*t.x+e.y*t.y+e.z*t.z,Ya=(e,t)=>e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w,we=e=>t=>It(e(t.x),e(t.y)),Te=e=>t=>ir(e(t.x),e(t.y)),un=e=>t=>Sn(e(t.x),e(t.y)),aa=e=>t=>ha(e(t.x),e(t.y)),ge=e=>t=>vt(e(t.x),e(t.y),e(t.z)),$e=e=>t=>Ht(e(t.x),e(t.y),e(t.z)),cn=e=>t=>Mn(e(t.x),e(t.y),e(t.z)),sa=e=>t=>ma(e(t.x),e(t.y),e(t.z)),me=e=>t=>Ut(e(t.x),e(t.y),e(t.z),e(t.w)),Se=e=>t=>or(e(t.x),e(t.y),e(t.z),e(t.w)),pn=e=>t=>kn(e(t.x),e(t.y),e(t.z),e(t.w)),ia=e=>t=>ya(e(t.x),e(t.y),e(t.z),e(t.w)),po=e=>t=>{let r=t.columns;return tr(we(e)(r[0]),we(e)(r[1]))},fo=e=>t=>{let r=t.columns;return rr(ge(e)(r[0]),ge(e)(r[1]),ge(e)(r[2]))},ho=e=>t=>{let r=t.columns;return Oe(me(e)(r[0]),me(e)(r[1]),me(e)(r[2]),me(e)(r[3]))},ar=e=>(t,r)=>It(e(t.x,r.x),e(t.y,r.y)),Rr=e=>(t,r)=>ir(e(t.x,r.x),e(t.y,r.y)),fn=e=>(t,r)=>Sn(e(t.x,r.x),e(t.y,r.y)),dn=e=>(t,r)=>ha(e(t.x,r.x),e(t.y,r.y)),Kt=e=>(t,r)=>vt(e(t.x,r.x),e(t.y,r.y),e(t.z,r.z)),Cr=e=>(t,r)=>Ht(e(t.x,r.x),e(t.y,r.y),e(t.z,r.z)),hn=e=>(t,r)=>Mn(e(t.x,r.x),e(t.y,r.y),e(t.z,r.z)),mn=e=>(t,r)=>ma(e(t.x,r.x),e(t.y,r.y),e(t.z,r.z)),Ft=e=>(t,r)=>Ut(e(t.x,r.x),e(t.y,r.y),e(t.z,r.z),e(t.w,r.w)),Ar=e=>(t,r)=>or(e(t.x,r.x),e(t.y,r.y),e(t.z,r.z),e(t.w,r.w)),yn=e=>(t,r)=>kn(e(t.x,r.x),e(t.y,r.y),e(t.z,r.z),e(t.w,r.w)),gn=e=>(t,r)=>ya(e(t.x,r.x),e(t.y,r.y),e(t.z,r.z),e(t.w,r.w)),ld=e=>(t,r)=>{let n=t.columns,a=r.columns;return tr(ar(e)(n[0],a[0]),ar(e)(n[1],a[1]))},ud=e=>(t,r)=>{let n=t.columns,a=r.columns;return rr(Kt(e)(n[0],a[0]),Kt(e)(n[1],a[1]),Kt(e)(n[2],a[2]))},cd=e=>(t,r)=>{let n=t.columns,a=r.columns;return Oe(Ft(e)(n[0],a[0]),Ft(e)(n[1],a[1]),Ft(e)(n[2],a[2]),Ft(e)(n[3],a[3]))},pd=e=>(t,r,n)=>It(e(t.x,r.x,n.x),e(t.y,r.y,n.y)),fd=e=>(t,r,n)=>ir(e(t.x,r.x,n.x),e(t.y,r.y,n.y)),dd=e=>(t,r,n)=>vt(e(t.x,r.x,n.x),e(t.y,r.y,n.y),e(t.z,r.z,n.z)),hd=e=>(t,r,n)=>Ht(e(t.x,r.x,n.x),e(t.y,r.y,n.y),e(t.z,r.z,n.z)),md=e=>(t,r,n)=>Ut(e(t.x,r.x,n.x),e(t.y,r.y,n.y),e(t.z,r.z,n.z),e(t.w,r.w,n.w)),yd=e=>(t,r,n)=>or(e(t.x,r.x,n.x),e(t.y,r.y,n.y),e(t.z,r.z,n.z),e(t.w,r.w,n.w)),F={eq:{vec2f:(e,t)=>_t(e.x===t.x,e.y===t.y),vec2h:(e,t)=>_t(e.x===t.x,e.y===t.y),vec2i:(e,t)=>_t(e.x===t.x,e.y===t.y),vec2u:(e,t)=>_t(e.x===t.x,e.y===t.y),"vec2<bool>":(e,t)=>_t(e.x===t.x,e.y===t.y),vec3f:(e,t)=>Bt(e.x===t.x,e.y===t.y,e.z===t.z),vec3h:(e,t)=>Bt(e.x===t.x,e.y===t.y,e.z===t.z),vec3i:(e,t)=>Bt(e.x===t.x,e.y===t.y,e.z===t.z),vec3u:(e,t)=>Bt(e.x===t.x,e.y===t.y,e.z===t.z),"vec3<bool>":(e,t)=>Bt(e.x===t.x,e.y===t.y,e.z===t.z),vec4f:(e,t)=>Pt(e.x===t.x,e.y===t.y,e.z===t.z,e.w===t.w),vec4h:(e,t)=>Pt(e.x===t.x,e.y===t.y,e.z===t.z,e.w===t.w),vec4i:(e,t)=>Pt(e.x===t.x,e.y===t.y,e.z===t.z,e.w===t.w),vec4u:(e,t)=>Pt(e.x===t.x,e.y===t.y,e.z===t.z,e.w===t.w),"vec4<bool>":(e,t)=>Pt(e.x===t.x,e.y===t.y,e.z===t.z,e.w===t.w)},lt:{vec2f:(e,t)=>_t(e.x<t.x,e.y<t.y),vec2h:(e,t)=>_t(e.x<t.x,e.y<t.y),vec2i:(e,t)=>_t(e.x<t.x,e.y<t.y),vec2u:(e,t)=>_t(e.x<t.x,e.y<t.y),vec3f:(e,t)=>Bt(e.x<t.x,e.y<t.y,e.z<t.z),vec3h:(e,t)=>Bt(e.x<t.x,e.y<t.y,e.z<t.z),vec3i:(e,t)=>Bt(e.x<t.x,e.y<t.y,e.z<t.z),vec3u:(e,t)=>Bt(e.x<t.x,e.y<t.y,e.z<t.z),vec4f:(e,t)=>Pt(e.x<t.x,e.y<t.y,e.z<t.z,e.w<t.w),vec4h:(e,t)=>Pt(e.x<t.x,e.y<t.y,e.z<t.z,e.w<t.w),vec4i:(e,t)=>Pt(e.x<t.x,e.y<t.y,e.z<t.z,e.w<t.w),vec4u:(e,t)=>Pt(e.x<t.x,e.y<t.y,e.z<t.z,e.w<t.w)},or:{"vec2<bool>":(e,t)=>_t(e.x||t.x,e.y||t.y),"vec3<bool>":(e,t)=>Bt(e.x||t.x,e.y||t.y,e.z||t.z),"vec4<bool>":(e,t)=>Pt(e.x||t.x,e.y||t.y,e.z||t.z,e.w||t.w)},all:{"vec2<bool>":e=>e.x&&e.y,"vec3<bool>":e=>e.x&&e.y&&e.z,"vec4<bool>":e=>e.x&&e.y&&e.z&&e.w},abs:{vec2f:we(Math.abs),vec2h:Te(Math.abs),vec2i:un(Math.abs),vec2u:aa(Math.abs),vec3f:ge(Math.abs),vec3h:$e(Math.abs),vec3i:cn(Math.abs),vec3u:sa(Math.abs),vec4f:me(Math.abs),vec4h:Se(Math.abs),vec4i:pn(Math.abs),vec4u:ia(Math.abs)},atan2:{vec2f:ar(Math.atan2),vec2h:Rr(Math.atan2),vec3f:Kt(Math.atan2),vec3h:Cr(Math.atan2),vec4f:Ft(Math.atan2),vec4h:Ar(Math.atan2)},acos:{vec2f:we(Math.acos),vec2h:Te(Math.acos),vec2i:un(Math.acos),vec2u:aa(Math.acos),vec3f:ge(Math.acos),vec3h:$e(Math.acos),vec3i:cn(Math.acos),vec3u:sa(Math.acos),vec4f:me(Math.acos),vec4h:Se(Math.acos),vec4i:pn(Math.acos),vec4u:ia(Math.acos)},acosh:{vec2f:we(Math.acosh),vec2h:Te(Math.acosh),vec3f:ge(Math.acosh),vec3h:$e(Math.acosh),vec4f:me(Math.acosh),vec4h:Se(Math.acosh)},asin:{vec2f:we(Math.asin),vec2h:Te(Math.asin),vec3f:ge(Math.asin),vec3h:$e(Math.asin),vec4f:me(Math.asin),vec4h:Se(Math.asin)},asinh:{vec2f:we(Math.asinh),vec2h:Te(Math.asinh),vec3f:ge(Math.asinh),vec3h:$e(Math.asinh),vec4f:me(Math.asinh),vec4h:Se(Math.asinh)},atan:{vec2f:we(Math.atan),vec2h:Te(Math.atan),vec3f:ge(Math.atan),vec3h:$e(Math.atan),vec4f:me(Math.atan),vec4h:Se(Math.atan)},atanh:{vec2f:we(Math.atanh),vec2h:Te(Math.atanh),vec3f:ge(Math.atanh),vec3h:$e(Math.atanh),vec4f:me(Math.atanh),vec4h:Se(Math.atanh)},ceil:{vec2f:we(Math.ceil),vec2h:Te(Math.ceil),vec3f:ge(Math.ceil),vec3h:$e(Math.ceil),vec4f:me(Math.ceil),vec4h:Se(Math.ceil)},clamp:{vec2f:(e,t,r)=>It(ae(e.x,t.x,r.x),ae(e.y,t.y,r.y)),vec2h:(e,t,r)=>ir(ae(e.x,t.x,r.x),ae(e.y,t.y,r.y)),vec2i:(e,t,r)=>Sn(ae(e.x,t.x,r.x),ae(e.y,t.y,r.y)),vec2u:(e,t,r)=>ha(ae(e.x,t.x,r.x),ae(e.y,t.y,r.y)),vec3f:(e,t,r)=>vt(ae(e.x,t.x,r.x),ae(e.y,t.y,r.y),ae(e.z,t.z,r.z)),vec3h:(e,t,r)=>Ht(ae(e.x,t.x,r.x),ae(e.y,t.y,r.y),ae(e.z,t.z,r.z)),vec3i:(e,t,r)=>Mn(ae(e.x,t.x,r.x),ae(e.y,t.y,r.y),ae(e.z,t.z,r.z)),vec3u:(e,t,r)=>ma(ae(e.x,t.x,r.x),ae(e.y,t.y,r.y),ae(e.z,t.z,r.z)),vec4f:(e,t,r)=>Ut(ae(e.x,t.x,r.x),ae(e.y,t.y,r.y),ae(e.z,t.z,r.z),ae(e.w,t.w,r.w)),vec4h:(e,t,r)=>or(ae(e.x,t.x,r.x),ae(e.y,t.y,r.y),ae(e.z,t.z,r.z),ae(e.w,t.w,r.w)),vec4i:(e,t,r)=>kn(ae(e.x,t.x,r.x),ae(e.y,t.y,r.y),ae(e.z,t.z,r.z),ae(e.w,t.w,r.w)),vec4u:(e,t,r)=>ya(ae(e.x,t.x,r.x),ae(e.y,t.y,r.y),ae(e.z,t.z,r.z),ae(e.w,t.w,r.w))},length:{vec2f:sn,vec2h:sn,vec3f:on,vec3h:on,vec4f:ln,vec4h:ln},add:{vec2f:ar((e,t)=>e+t),vec2h:Rr((e,t)=>e+t),vec2i:fn((e,t)=>e+t),vec2u:dn((e,t)=>e+t),vec3f:Kt((e,t)=>e+t),vec3h:Cr((e,t)=>e+t),vec3i:hn((e,t)=>e+t),vec3u:mn((e,t)=>e+t),vec4f:Ft((e,t)=>e+t),vec4h:Ar((e,t)=>e+t),vec4i:yn((e,t)=>e+t),vec4u:gn((e,t)=>e+t),mat2x2f:ld((e,t)=>e+t),mat3x3f:ud((e,t)=>e+t),mat4x4f:cd((e,t)=>e+t)},smoothstep:{vec2f:pd(Or),vec2h:fd(Or),vec3f:dd(Or),vec3h:hd(Or),vec4f:md(Or),vec4h:yd(Or)},addMixed:{vec2f:(e,t)=>we(r=>r+t)(e),vec2h:(e,t)=>Te(r=>r+t)(e),vec2i:(e,t)=>un(r=>r+t)(e),vec2u:(e,t)=>aa(r=>r+t)(e),vec3f:(e,t)=>ge(r=>r+t)(e),vec3h:(e,t)=>$e(r=>r+t)(e),vec3i:(e,t)=>cn(r=>r+t)(e),vec3u:(e,t)=>sa(r=>r+t)(e),vec4f:(e,t)=>me(r=>r+t)(e),vec4h:(e,t)=>Se(r=>r+t)(e),vec4i:(e,t)=>pn(r=>r+t)(e),vec4u:(e,t)=>ia(r=>r+t)(e),mat2x2f:(e,t)=>po(r=>r+t)(e),mat3x3f:(e,t)=>fo(r=>r+t)(e),mat4x4f:(e,t)=>ho(r=>r+t)(e)},mulSxV:{vec2f:(e,t)=>we(r=>e*r)(t),vec2h:(e,t)=>Te(r=>e*r)(t),vec2i:(e,t)=>un(r=>e*r)(t),vec2u:(e,t)=>aa(r=>e*r)(t),vec3f:(e,t)=>ge(r=>e*r)(t),vec3h:(e,t)=>$e(r=>e*r)(t),vec3i:(e,t)=>cn(r=>e*r)(t),vec3u:(e,t)=>sa(r=>e*r)(t),vec4f:(e,t)=>me(r=>e*r)(t),vec4h:(e,t)=>Se(r=>e*r)(t),vec4i:(e,t)=>pn(r=>e*r)(t),vec4u:(e,t)=>ia(r=>e*r)(t),mat2x2f:(e,t)=>po(r=>e*r)(t),mat3x3f:(e,t)=>fo(r=>e*r)(t),mat4x4f:(e,t)=>ho(r=>e*r)(t)},mulVxV:{vec2f:ar((e,t)=>e*t),vec2h:Rr((e,t)=>e*t),vec2i:fn((e,t)=>e*t),vec2u:dn((e,t)=>e*t),vec3f:Kt((e,t)=>e*t),vec3h:Cr((e,t)=>e*t),vec3i:hn((e,t)=>e*t),vec3u:mn((e,t)=>e*t),vec4f:Ft((e,t)=>e*t),vec4h:Ar((e,t)=>e*t),vec4i:yn((e,t)=>e*t),vec4u:gn((e,t)=>e*t),mat2x2f:(e,t)=>{let r=e.columns,n=t.columns;return tr(r[0].x*n[0].x+r[1].x*n[0].y,r[0].y*n[0].x+r[1].y*n[0].y,r[0].x*n[1].x+r[1].x*n[1].y,r[0].y*n[1].x+r[1].y*n[1].y)},mat3x3f:(e,t)=>{let r=e.columns,n=t.columns;return rr(r[0].x*n[0].x+r[1].x*n[0].y+r[2].x*n[0].z,r[0].y*n[0].x+r[1].y*n[0].y+r[2].y*n[0].z,r[0].z*n[0].x+r[1].z*n[0].y+r[2].z*n[0].z,r[0].x*n[1].x+r[1].x*n[1].y+r[2].x*n[1].z,r[0].y*n[1].x+r[1].y*n[1].y+r[2].y*n[1].z,r[0].z*n[1].x+r[1].z*n[1].y+r[2].z*n[1].z,r[0].x*n[2].x+r[1].x*n[2].y+r[2].x*n[2].z,r[0].y*n[2].x+r[1].y*n[2].y+r[2].y*n[2].z,r[0].z*n[2].x+r[1].z*n[2].y+r[2].z*n[2].z)},mat4x4f:(e,t)=>{let r=e.columns,n=t.columns;return Oe(r[0].x*n[0].x+r[1].x*n[0].y+r[2].x*n[0].z+r[3].x*n[0].w,r[0].y*n[0].x+r[1].y*n[0].y+r[2].y*n[0].z+r[3].y*n[0].w,r[0].z*n[0].x+r[1].z*n[0].y+r[2].z*n[0].z+r[3].z*n[0].w,r[0].w*n[0].x+r[1].w*n[0].y+r[2].w*n[0].z+r[3].w*n[0].w,r[0].x*n[1].x+r[1].x*n[1].y+r[2].x*n[1].z+r[3].x*n[1].w,r[0].y*n[1].x+r[1].y*n[1].y+r[2].y*n[1].z+r[3].y*n[1].w,r[0].z*n[1].x+r[1].z*n[1].y+r[2].z*n[1].z+r[3].z*n[1].w,r[0].w*n[1].x+r[1].w*n[1].y+r[2].w*n[1].z+r[3].w*n[1].w,r[0].x*n[2].x+r[1].x*n[2].y+r[2].x*n[2].z+r[3].x*n[2].w,r[0].y*n[2].x+r[1].y*n[2].y+r[2].y*n[2].z+r[3].y*n[2].w,r[0].z*n[2].x+r[1].z*n[2].y+r[2].z*n[2].z+r[3].z*n[2].w,r[0].w*n[2].x+r[1].w*n[2].y+r[2].w*n[2].z+r[3].w*n[2].w,r[0].x*n[3].x+r[1].x*n[3].y+r[2].x*n[3].z+r[3].x*n[3].w,r[0].y*n[3].x+r[1].y*n[3].y+r[2].y*n[3].z+r[3].y*n[3].w,r[0].z*n[3].x+r[1].z*n[3].y+r[2].z*n[3].z+r[3].z*n[3].w,r[0].w*n[3].x+r[1].w*n[3].y+r[2].w*n[3].z+r[3].w*n[3].w)}},mulMxV:{mat2x2f:(e,t)=>{let r=e.columns;return It(r[0].x*t.x+r[1].x*t.y,r[0].y*t.x+r[1].y*t.y)},mat3x3f:(e,t)=>{let r=e.columns;return vt(r[0].x*t.x+r[1].x*t.y+r[2].x*t.z,r[0].y*t.x+r[1].y*t.y+r[2].y*t.z,r[0].z*t.x+r[1].z*t.y+r[2].z*t.z)},mat4x4f:(e,t)=>{let r=e.columns;return Ut(r[0].x*t.x+r[1].x*t.y+r[2].x*t.z+r[3].x*t.w,r[0].y*t.x+r[1].y*t.y+r[2].y*t.z+r[3].y*t.w,r[0].z*t.x+r[1].z*t.y+r[2].z*t.z+r[3].z*t.w,r[0].w*t.x+r[1].w*t.y+r[2].w*t.z+r[3].w*t.w)}},mulVxM:{mat2x2f:(e,t)=>{let r=t.columns;return It(e.x*r[0].x+e.y*r[0].y,e.x*r[1].x+e.y*r[1].y)},mat3x3f:(e,t)=>{let r=t.columns;return vt(e.x*r[0].x+e.y*r[0].y+e.z*r[0].z,e.x*r[1].x+e.y*r[1].y+e.z*r[1].z,e.x*r[2].x+e.y*r[2].y+e.z*r[2].z)},mat4x4f:(e,t)=>{let r=t.columns;return Ut(e.x*r[0].x+e.y*r[0].y+e.z*r[0].z+e.w*r[0].w,e.x*r[1].x+e.y*r[1].y+e.z*r[1].z+e.w*r[1].w,e.x*r[2].x+e.y*r[2].y+e.z*r[2].z+e.w*r[2].w,e.x*r[3].x+e.y*r[3].y+e.z*r[3].z+e.w*r[3].w)}},div:{vec2f:ar((e,t)=>e/t),vec2h:Rr((e,t)=>e/t),vec2i:fn(an),vec2u:dn(an),vec3f:Kt((e,t)=>e/t),vec3h:Cr((e,t)=>e/t),vec3i:hn(an),vec3u:mn(an),vec4f:Ft((e,t)=>e/t),vec4h:Ar((e,t)=>e/t),vec4i:yn(an),vec4u:gn(an)},dot:{vec2f:qa,vec2h:qa,vec2i:qa,vec2u:qa,vec3f:Wa,vec3h:Wa,vec3i:Wa,vec3u:Wa,vec4f:Ya,vec4h:Ya,vec4i:Ya,vec4u:Ya},normalize:{vec2f:e=>{let t=sn(e);return It(e.x/t,e.y/t)},vec2h:e=>{let t=sn(e);return ir(e.x/t,e.y/t)},vec2i:e=>{let t=sn(e);return Sn(e.x/t,e.y/t)},vec2u:e=>{let t=sn(e);return ha(e.x/t,e.y/t)},vec3f:e=>{let t=on(e);return vt(e.x/t,e.y/t,e.z/t)},vec3h:e=>{let t=on(e);return Ht(e.x/t,e.y/t,e.z/t)},vec3i:e=>{let t=on(e);return Mn(e.x/t,e.y/t,e.z/t)},vec3u:e=>{let t=on(e);return ma(e.x/t,e.y/t,e.z/t)},vec4f:e=>{let t=ln(e);return Ut(e.x/t,e.y/t,e.z/t,e.w/t)},vec4h:e=>{let t=ln(e);return or(e.x/t,e.y/t,e.z/t,e.w/t)},vec4i:e=>{let t=ln(e);return kn(e.x/t,e.y/t,e.z/t,e.w/t)},vec4u:e=>{let t=ln(e);return ya(e.x/t,e.y/t,e.z/t,e.w/t)}},cross:{vec3f:(e,t)=>vt(e.y*t.z-e.z*t.y,e.z*t.x-e.x*t.z,e.x*t.y-e.y*t.x),vec3h:(e,t)=>Ht(e.y*t.z-e.z*t.y,e.z*t.x-e.x*t.z,e.x*t.y-e.y*t.x)},mod:{vec2f:ar((e,t)=>e%t),vec2h:Rr((e,t)=>e%t),vec2i:fn((e,t)=>e%t),vec2u:dn((e,t)=>e%t),vec3f:Kt((e,t)=>e%t),vec3h:Cr((e,t)=>e%t),vec3i:hn((e,t)=>e%t),vec3u:mn((e,t)=>e%t),vec4f:Ft((e,t)=>e%t),vec4h:Ar((e,t)=>e%t),vec4i:yn((e,t)=>e%t),vec4u:gn((e,t)=>e%t)},floor:{vec2f:we(Math.floor),vec2h:Te(Math.floor),vec3f:ge(Math.floor),vec3h:$e(Math.floor),vec4f:me(Math.floor),vec4h:Se(Math.floor)},max:{vec2f:ar(Math.max),vec2h:Rr(Math.max),vec2i:fn(Math.max),vec2u:dn(Math.max),vec3f:Kt(Math.max),vec3h:Cr(Math.max),vec3i:hn(Math.max),vec3u:mn(Math.max),vec4f:Ft(Math.max),vec4h:Ar(Math.max),vec4i:yn(Math.max),vec4u:gn(Math.max)},min:{vec2f:ar(Math.min),vec2h:Rr(Math.min),vec2i:fn(Math.min),vec2u:dn(Math.min),vec3f:Kt(Math.min),vec3h:Cr(Math.min),vec3i:hn(Math.min),vec3u:mn(Math.min),vec4f:Ft(Math.min),vec4h:Ar(Math.min),vec4i:yn(Math.min),vec4u:gn(Math.min)},pow:{vec2f:(e,t)=>It(e.x**t.x,e.y**t.y),vec2h:(e,t)=>ir(e.x**t.x,e.y**t.y),vec3f:(e,t)=>vt(e.x**t.x,e.y**t.y,e.z**t.z),vec3h:(e,t)=>Ht(e.x**t.x,e.y**t.y,e.z**t.z),vec4f:(e,t)=>Ut(e.x**t.x,e.y**t.y,e.z**t.z,e.w**t.w),vec4h:(e,t)=>or(e.x**t.x,e.y**t.y,e.z**t.z,e.w**t.w)},sign:{vec2f:we(Math.sign),vec2h:Te(Math.sign),vec2i:un(Math.sign),vec3f:ge(Math.sign),vec3h:$e(Math.sign),vec3i:cn(Math.sign),vec4f:me(Math.sign),vec4h:Se(Math.sign),vec4i:pn(Math.sign)},sqrt:{vec2f:we(Math.sqrt),vec2h:Te(Math.sqrt),vec3f:ge(Math.sqrt),vec3h:$e(Math.sqrt),vec4f:me(Math.sqrt),vec4h:Se(Math.sqrt)},mix:{vec2f:(e,t,r)=>typeof r=="number"?It(e.x*(1-r)+t.x*r,e.y*(1-r)+t.y*r):It(e.x*(1-r.x)+t.x*r.x,e.y*(1-r.y)+t.y*r.y),vec2h:(e,t,r)=>typeof r=="number"?ir(e.x*(1-r)+t.x*r,e.y*(1-r)+t.y*r):ir(e.x*(1-r.x)+t.x*r.x,e.y*(1-r.y)+t.y*r.y),vec3f:(e,t,r)=>typeof r=="number"?vt(e.x*(1-r)+t.x*r,e.y*(1-r)+t.y*r,e.z*(1-r)+t.z*r):vt(e.x*(1-r.x)+t.x*r.x,e.y*(1-r.y)+t.y*r.y,e.z*(1-r.z)+t.z*r.z),vec3h:(e,t,r)=>typeof r=="number"?Ht(e.x*(1-r)+t.x*r,e.y*(1-r)+t.y*r,e.z*(1-r)+t.z*r):Ht(e.x*(1-r.x)+t.x*r.x,e.y*(1-r.y)+t.y*r.y,e.z*(1-r.z)+t.z*r.z),vec4f:(e,t,r)=>typeof r=="number"?Ut(e.x*(1-r)+t.x*r,e.y*(1-r)+t.y*r,e.z*(1-r)+t.z*r,e.w*(1-r)+t.w*r):Ut(e.x*(1-r.x)+t.x*r.x,e.y*(1-r.y)+t.y*r.y,e.z*(1-r.z)+t.z*r.z,e.w*(1-r.w)+t.w*r.w),vec4h:(e,t,r)=>typeof r=="number"?or(e.x*(1-r)+t.x*r,e.y*(1-r)+t.y*r,e.z*(1-r)+t.z*r,e.w*(1-r)+t.w*r):or(e.x*(1-r.x)+t.x*r.x,e.y*(1-r.y)+t.y*r.y,e.z*(1-r.z)+t.z*r.z,e.w*(1-r.w)+t.w*r.w)},sin:{vec2f:we(Math.sin),vec2h:Te(Math.sin),vec3f:ge(Math.sin),vec3h:$e(Math.sin),vec4f:me(Math.sin),vec4h:Se(Math.sin)},cos:{vec2f:we(Math.cos),vec2h:Te(Math.cos),vec3f:ge(Math.cos),vec3h:$e(Math.cos),vec4f:me(Math.cos),vec4h:Se(Math.cos)},cosh:{vec2f:we(Math.cosh),vec2h:Te(Math.cosh),vec3f:ge(Math.cosh),vec3h:$e(Math.cosh),vec4f:me(Math.cosh),vec4h:Se(Math.cosh)},exp:{vec2f:we(Math.exp),vec2h:Te(Math.exp),vec3f:ge(Math.exp),vec3h:$e(Math.exp),vec4f:me(Math.exp),vec4h:Se(Math.exp)},exp2:{vec2f:we(e=>2**e),vec2h:Te(e=>2**e),vec3f:ge(e=>2**e),vec3h:$e(e=>2**e),vec4f:me(e=>2**e),vec4h:Se(e=>2**e)},log:{vec2f:we(Math.log),vec2h:Te(Math.log),vec3f:ge(Math.log),vec3h:$e(Math.log),vec4f:me(Math.log),vec4h:Se(Math.log)},log2:{vec2f:we(Math.log2),vec2h:Te(Math.log2),vec3f:ge(Math.log2),vec3h:$e(Math.log2),vec4f:me(Math.log2),vec4h:Se(Math.log2)},fract:{vec2f:we(e=>e-Math.floor(e)),vec2h:Te(e=>e-Math.floor(e)),vec3f:ge(e=>e-Math.floor(e)),vec3h:$e(e=>e-Math.floor(e)),vec4f:me(e=>e-Math.floor(e)),vec4h:Se(e=>e-Math.floor(e))},isCloseToZero:{vec2f:(e,t)=>Math.abs(e.x)<=t&&Math.abs(e.y)<=t,vec2h:(e,t)=>Math.abs(e.x)<=t&&Math.abs(e.y)<=t,vec3f:(e,t)=>Math.abs(e.x)<=t&&Math.abs(e.y)<=t&&Math.abs(e.z)<=t,vec3h:(e,t)=>Math.abs(e.x)<=t&&Math.abs(e.y)<=t&&Math.abs(e.z)<=t,vec4f:(e,t)=>Math.abs(e.x)<=t&&Math.abs(e.y)<=t&&Math.abs(e.z)<=t&&Math.abs(e.w)<=t,vec4h:(e,t)=>Math.abs(e.x)<=t&&Math.abs(e.y)<=t&&Math.abs(e.z)<=t&&Math.abs(e.w)<=t},neg:{vec2f:we(e=>-e),vec2h:Te(e=>-e),vec2i:un(e=>-e),vec2u:aa(e=>-e),"vec2<bool>":e=>_t(!e.x,!e.y),vec3f:ge(e=>-e),vec3h:$e(e=>-e),vec3i:cn(e=>-e),vec3u:sa(e=>-e),"vec3<bool>":e=>Bt(!e.x,!e.y,!e.z),vec4f:me(e=>-e),vec4h:Se(e=>-e),vec4i:pn(e=>-e),vec4u:ia(e=>-e),"vec4<bool>":e=>Pt(!e.x,!e.y,!e.z,!e.w)},select:{vec2f:(e,t,r)=>It(r.x?t.x:e.x,r.y?t.y:e.y),vec2h:(e,t,r)=>ir(r.x?t.x:e.x,r.y?t.y:e.y),vec2i:(e,t,r)=>Sn(r.x?t.x:e.x,r.y?t.y:e.y),vec2u:(e,t,r)=>ha(r.x?t.x:e.x,r.y?t.y:e.y),"vec2<bool>":(e,t,r)=>_t(r.x?t.x:e.x,r.y?t.y:e.y),vec3f:(e,t,r)=>vt(r.x?t.x:e.x,r.y?t.y:e.y,r.z?t.z:e.z),vec3h:(e,t,r)=>Ht(r.x?t.x:e.x,r.y?t.y:e.y,r.z?t.z:e.z),vec3i:(e,t,r)=>Mn(r.x?t.x:e.x,r.y?t.y:e.y,r.z?t.z:e.z),vec3u:(e,t,r)=>ma(r.x?t.x:e.x,r.y?t.y:e.y,r.z?t.z:e.z),"vec3<bool>":(e,t,r)=>Bt(r.x?t.x:e.x,r.y?t.y:e.y,r.z?t.z:e.z),vec4f:(e,t,r)=>Ut(r.x?t.x:e.x,r.y?t.y:e.y,r.z?t.z:e.z,r.w?t.w:e.w),vec4h:(e,t,r)=>or(r.x?t.x:e.x,r.y?t.y:e.y,r.z?t.z:e.z,r.w?t.w:e.w),vec4i:(e,t,r)=>kn(r.x?t.x:e.x,r.y?t.y:e.y,r.z?t.z:e.z,r.w?t.w:e.w),vec4u:(e,t,r)=>ya(r.x?t.x:e.x,r.y?t.y:e.y,r.z?t.z:e.z,r.w?t.w:e.w),"vec4<bool>":(e,t,r)=>Pt(r.x?t.x:e.x,r.y?t.y:e.y,r.z?t.z:e.z,r.w?t.w:e.w)},tanh:{vec2f:we(Math.tanh),vec2h:Te(Math.tanh),vec3f:ge(Math.tanh),vec3h:$e(Math.tanh),vec4f:me(Math.tanh),vec4h:Se(Math.tanh)},bitcastU32toF32:{vec2u:e=>It(Wt(e.x),Wt(e.y)),vec3u:e=>vt(Wt(e.x),Wt(e.y),Wt(e.z)),vec4u:e=>Ut(Wt(e.x),Wt(e.y),Wt(e.z),Wt(e.w))},bitcastU32toI32:{vec2u:e=>Sn(Yt(e.x),Yt(e.y)),vec3u:e=>Mn(Yt(e.x),Yt(e.y),Yt(e.z)),vec4u:e=>kn(Yt(e.x),Yt(e.y),Yt(e.z),Yt(e.w))}};function hu(e,t){if(typeof e=="number"&&typeof t=="number")return e+t;if(typeof e=="number"&&Ie(t))return F.addMixed[t.kind](t,e);if(Ie(e)&&typeof t=="number")return F.addMixed[e.kind](e,t);if(Ie(e)&&Ie(t)||sr(e)&&sr(t))return F.add[e.kind](e,t);throw new Error("Add/Sub called with invalid arguments.")}var mu=B({name:"add",signature:(...e)=>{let t=st(e)??e;return{argTypes:t,returnType:zr(t[0])?t[1]:t[0]}},normalImpl:hu,codegenImpl:(e,t)=>$`(${e} + ${t})`});function gd(e,t){return hu(e,yu(-1,t))}var La=B({name:"sub",signature:(...e)=>{let t=st(e)??e;return{argTypes:t,returnType:zr(t[0])?t[1]:t[0]}},normalImpl:gd,codegenImpl:(e,t)=>$`(${e} - ${t})`});function yu(e,t){if(typeof e=="number"&&typeof t=="number")return e*t;if(typeof e=="number"&&(Ie(t)||sr(t)))return F.mulSxV[t.kind](e,t);if((Ie(e)||sr(e))&&typeof t=="number")return F.mulSxV[e.kind](t,e);if(Ie(e)&&Ie(t))return F.mulVxV[e.kind](e,t);if(Wi(e)&&sr(t))return F.mulVxM[t.kind](e,t);if(sr(e)&&Wi(t))return F.mulMxV[e.kind](e,t);if(sr(e)&&sr(t))return F.mulVxV[e.kind](e,t);throw new Error("Mul called with invalid arguments.")}var zi=B({name:"mul",signature:(...e)=>{let t=st(e)??e,r=zr(t[0])?t[1]:zr(t[1])||t[0].type.startsWith("vec")?t[0]:t[1].type.startsWith("vec")?t[1]:t[0];return{argTypes:t,returnType:r}},normalImpl:yu,codegenImpl:(e,t)=>$`(${e} * ${t})`});function vd(e,t){if(typeof e=="number"&&typeof t=="number")return e/t;if(typeof e=="number"&&Ie(t)){let r=us[t.kind][v].jsImpl;return F.div[t.kind](r(e),t)}if(Ie(e)&&typeof t=="number"){let r=us[e.kind][v].jsImpl;return F.div[e.kind](e,r(t))}if(Ie(e)&&Ie(t))return F.div[e.kind](e,t);throw new Error("Div called with invalid arguments.")}var gu=B({name:"div",signature:(...e)=>{let t=st(e,[b,St,Dt])??e;return{argTypes:t,returnType:zr(t[0])?t[1]:t[0]}},normalImpl:vd,codegenImpl:(e,t)=>$`(${e} / ${t})`,ignoreImplicitCastWarning:!0});B({name:"mod",signature:(...e)=>{let t=st(e)??e;return{argTypes:t,returnType:zr(t[0])?t[1]:t[0]}},normalImpl(e,t){if(typeof e=="number"&&typeof t=="number")return e%t;if(typeof e=="number"&&Ie(t)){let r=us[t.kind];return F.mod[t.kind](r(e),t)}if(Ie(e)&&typeof t=="number"){let r=us[e.kind];return F.mod[e.kind](e,r(t))}if(Ie(e)&&Ie(t))return F.mod[e.kind](e,t);throw new Error("Mod called with invalid arguments, expected types: number or vector.")},codegenImpl:(e,t)=>$`(${e} % ${t})`});function wd(e){return typeof e=="number"?-e:F.neg[e.kind](e)}B({name:"neg",signature:e=>({argTypes:[e],returnType:e}),normalImpl:wd,codegenImpl:e=>$`-(${e})`});function xd(e){return typeof e=="number"?Math.abs(e):F.abs[e.kind](e)}B({name:"abs",signature:e=>({argTypes:[e],returnType:e}),normalImpl:xd,codegenImpl:e=>$`abs(${e})`});function bd(e){return typeof e=="number"?Math.acos(e):F.acos[e.kind](e)}B({name:"acos",signature:e=>({argTypes:[e],returnType:e}),normalImpl:bd,codegenImpl:e=>$`acos(${e})`});function Td(e){return typeof e=="number"?Math.acosh(e):F.acosh[e.kind](e)}B({name:"acosh",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Td,codegenImpl:e=>$`acosh(${e})`});function $d(e){return typeof e=="number"?Math.asin(e):F.asin[e.kind](e)}B({name:"asin",signature:e=>({argTypes:[e],returnType:e}),normalImpl:$d,codegenImpl:e=>$`asin(${e})`});function Sd(e){return typeof e=="number"?Math.asinh(e):F.asinh[e.kind](e)}B({name:"asinh",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Sd,codegenImpl:e=>$`asinh(${e})`});function Md(e){return typeof e=="number"?Math.atan(e):F.atan[e.kind](e)}B({name:"atan",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Md,codegenImpl:e=>$`atan(${e})`});function kd(e){return typeof e=="number"?Math.atanh(e):F.atanh[e.kind](e)}B({name:"atanh",signature:e=>({argTypes:[e],returnType:e}),normalImpl:kd,codegenImpl:e=>$`atanh(${e})`});function _d(e,t){return typeof e=="number"&&typeof t=="number"?Math.atan2(e,t):F.atan2[e.kind](e,t)}B({name:"atan2",signature:(...e)=>{let t=st(e,[b,St,Dt])??e;return{argTypes:t,returnType:t[0]}},normalImpl:_d,codegenImpl:(e,t)=>$`atan2(${e}, ${t})`});function Bd(e){return typeof e=="number"?Math.ceil(e):F.ceil[e.kind](e)}var Pd=B({name:"ceil",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Bd,codegenImpl:e=>$`ceil(${e})`});function zd(e,t,r){return typeof e=="number"?Math.min(Math.max(t,e),r):F.clamp[e.kind](e,t,r)}B({name:"clamp",signature:(...e)=>{let t=st(e)??e;return{argTypes:t,returnType:t[0]}},normalImpl:zd,codegenImpl:(e,t,r)=>$`clamp(${e}, ${t}, ${r})`});function Id(e){return typeof e=="number"?Math.cos(e):F.cos[e.kind](e)}B({name:"cos",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Id,codegenImpl:e=>$`cos(${e})`});function Ud(e){return typeof e=="number"?Math.cosh(e):F.cosh[e.kind](e)}B({name:"cosh",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Ud,codegenImpl:e=>$`cosh(${e})`});B({name:"countLeadingZeros",signature:e=>({argTypes:[e],returnType:e}),normalImpl:"CPU implementation for countLeadingZeros not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>$`countLeadingZeros(${e})`});B({name:"countOneBits",signature:e=>({argTypes:[e],returnType:e}),normalImpl:"CPU implementation for countOneBits not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>$`countOneBits(${e})`});B({name:"countTrailingZeros",signature:e=>({argTypes:[e],returnType:e}),normalImpl:"CPU implementation for countTrailingZeros not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>$`countTrailingZeros(${e})`});B({name:"cross",signature:(e,t)=>({argTypes:[e,t],returnType:e}),normalImpl:(e,t)=>F.cross[e.kind](e,t),codegenImpl:(e,t)=>$`cross(${e}, ${t})`});function Ed(e){if(typeof e=="number")return e*180/Math.PI;throw new Vt("CPU implementation for degrees on vectors not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")}B({name:"degrees",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Ed,codegenImpl:e=>$`degrees(${e})`});B({name:"determinant",signature:e=>({argTypes:[e],returnType:b}),normalImpl:"CPU implementation for determinant not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>$`determinant(${e})`});function Rd(e,t){return typeof e=="number"&&typeof t=="number"?Math.abs(e-t):Nd(La(e,t))}B({name:"distance",signature:(e,t)=>({argTypes:[e,t],returnType:bi(e)?St:b}),normalImpl:Rd,codegenImpl:(e,t)=>$`distance(${e}, ${t})`});var Cd=B({name:"dot",signature:(e,t)=>({argTypes:[e,t],returnType:e.primitive}),normalImpl:(e,t)=>F.dot[e.kind](e,t),codegenImpl:(e,t)=>$`dot(${e}, ${t})`});B({name:"dot4U8Packed",signature:(e,t)=>({argTypes:[te,te],returnType:te}),normalImpl:"CPU implementation for dot4U8Packed not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:(e,t)=>$`dot4U8Packed(${e}, ${t})`});B({name:"dot4I8Packed",signature:(e,t)=>({argTypes:[te,te],returnType:qe}),normalImpl:"CPU implementation for dot4I8Packed not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:(e,t)=>$`dot4I8Packed(${e}, ${t})`});function Ad(e){return typeof e=="number"?Math.exp(e):F.exp[e.kind](e)}B({name:"exp",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Ad,codegenImpl:e=>$`exp(${e})`});function Od(e){return typeof e=="number"?2**e:F.exp2[e.kind](e)}B({name:"exp2",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Od,codegenImpl:e=>$`exp2(${e})`});B({name:"extractBits",signature:(e,t,r)=>({argTypes:[e,te,te],returnType:e}),normalImpl:"CPU implementation for extractBits not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:(e,t,r)=>$`extractBits(${e}, ${t}, ${r})`});B({name:"faceForward",signature:(e,t,r)=>({argTypes:[e,t,r],returnType:e}),normalImpl:"CPU implementation for faceForward not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:(e,t,r)=>$`faceForward(${e}, ${t}, ${r})`});B({name:"firstLeadingBit",signature:e=>({argTypes:[e],returnType:e}),normalImpl:"CPU implementation for firstLeadingBit not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>$`firstLeadingBit(${e})`});B({name:"firstTrailingBit",signature:e=>({argTypes:[e],returnType:e}),normalImpl:"CPU implementation for firstTrailingBit not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>$`firstTrailingBit(${e})`});function Ld(e){return typeof e=="number"?Math.floor(e):F.floor[e.kind](e)}B({name:"floor",signature:(...e)=>({argTypes:e,returnType:e[0]}),normalImpl:Ld,codegenImpl:e=>$`floor(${e})`});function Fd(e,t,r){if(typeof e=="number")return e*t+r;throw new Vt("CPU implementation for fma on vectors not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")}B({name:"fma",signature:(e,t,r)=>({argTypes:[e,t,r],returnType:e}),normalImpl:Fd,codegenImpl:(e,t,r)=>$`fma(${e}, ${t}, ${r})`});function Gd(e){return typeof e=="number"?e-Math.floor(e):F.fract[e.kind](e)}B({name:"fract",signature:(...e)=>({argTypes:e,returnType:e[0]}),normalImpl:Gd,codegenImpl:e=>$`fract(${e})`});var Dd={f32:We({fract:b,exp:qe}),f16:We({fract:St,exp:qe}),abstractFloat:We({fract:Dt,exp:Ss}),vec2f:We({fract:ke,exp:bt}),vec3f:We({fract:Ke,exp:Gt}),vec4f:We({fract:S,exp:ze}),vec2h:We({fract:yr,exp:bt}),vec3h:We({fract:mr,exp:Gt}),vec4h:We({fract:hr,exp:ze})};Qe(e=>{throw new Vt("CPU implementation for frexp not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")},e=>{let t=Dd[e.dataType.type];if(!t)throw new Error(`Unsupported data type for frexp: ${e.dataType.type}. Supported types are f32, f16, abstractFloat, vec2f, vec3f, vec4f, vec2h, vec3h, vec4h.`);return M($`frexp(${e})`,t)},"frexp");B({name:"insertBits",signature:(e,t,r,n)=>({argTypes:[e,t,te,te],returnType:e}),normalImpl:"CPU implementation for insertBits not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:(e,t,r,n)=>$`insertBits(${e}, ${t}, ${r}, ${n})`});function Vd(e){if(typeof e=="number")return 1/Math.sqrt(e);throw new Vt("CPU implementation for inverseSqrt on vectors not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")}B({name:"inverseSqrt",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Vd,codegenImpl:e=>$`inverseSqrt(${e})`});B({name:"ldexp",signature:(e,t)=>{switch(e.type){case"abstractFloat":return{argTypes:[Dt,Ss],returnType:e};case"f32":case"f16":return{argTypes:[e,qe],returnType:e};case"vec2f":case"vec2h":return{argTypes:[e,bt],returnType:e};case"vec3f":case"vec3h":return{argTypes:[e,Gt],returnType:e};case"vec4f":case"vec4h":return{argTypes:[e,ze],returnType:e};default:throw new Error(`Unsupported data type for ldexp: ${e.type}. Supported types are abstractFloat, f32, f16, vec2f, vec2h, vec3f, vec3h, vec4f, vec4h.`)}},normalImpl:"CPU implementation for ldexp not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:(e,t)=>$`ldexp(${e}, ${t})`});function jd(e){return typeof e=="number"?Math.abs(e):F.length[e.kind](e)}var Nd=B({name:"length",signature:e=>({argTypes:[e],returnType:bi(e)?St:b}),normalImpl:jd,codegenImpl:e=>$`length(${e})`});function qd(e){return typeof e=="number"?Math.log(e):F.log[e.kind](e)}B({name:"log",signature:e=>({argTypes:[e],returnType:e}),normalImpl:qd,codegenImpl:e=>$`log(${e})`});function Wd(e){return typeof e=="number"?Math.log2(e):F.log2[e.kind](e)}B({name:"log2",signature:e=>({argTypes:[e],returnType:e}),normalImpl:Wd,codegenImpl:e=>$`log2(${e})`});function Yd(e,t){return typeof e=="number"?Math.max(e,t):F.max[e.kind](e,t)}B({name:"max",signature:(...e)=>{let t=st(e)??e;return{argTypes:t,returnType:t[0]}},normalImpl:Yd,codegenImpl:(e,t)=>$`max(${e}, ${t})`});function Zd(e,t){return typeof e=="number"?Math.min(e,t):F.min[e.kind](e,t)}B({name:"min",signature:(...e)=>{let t=st(e)??e;return{argTypes:t,returnType:t[0]}},normalImpl:Zd,codegenImpl:(e,t)=>$`min(${e}, ${t})`});function Xd(e,t,r){if(typeof e=="number"){if(typeof r!="number"||typeof t!="number")throw new Error("When e1 and e2 are numbers, the blend factor must be a number.");return e*(1-r)+t*r}if(typeof e=="number"||typeof t=="number")throw new Error("e1 and e2 need to both be vectors of the same kind.");return F.mix[e.kind](e,t,r)}B({name:"mix",signature:(e,t,r)=>({argTypes:[e,t,r],returnType:e}),normalImpl:Xd,codegenImpl:(e,t,r)=>$`mix(${e}, ${t}, ${r})`});var Hd={f32:We({fract:b,whole:b}),f16:We({fract:St,whole:St}),abstractFloat:We({fract:Dt,whole:Dt}),vec2f:We({fract:ke,whole:ke}),vec3f:We({fract:Ke,whole:Ke}),vec4f:We({fract:S,whole:S}),vec2h:We({fract:yr,whole:yr}),vec3h:We({fract:mr,whole:mr}),vec4h:We({fract:hr,whole:hr})};B({name:"modf",signature:e=>{let t=Hd[e.type];if(!t)throw new Error(`Unsupported data type for modf: ${e.type}. Supported types are f32, f16, abstractFloat, vec2f, vec3f, vec4f, vec2h, vec3h, vec4h.`);return{argTypes:[e],returnType:t}},normalImpl:"CPU implementation for modf not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>$`modf(${e})`});B({name:"normalize",signature:e=>({argTypes:[e],returnType:e}),normalImpl:e=>F.normalize[e.kind](e),codegenImpl:e=>$`normalize(${e})`});function Kd(e,t){if(typeof e=="number"&&typeof t=="number")return e**t;if(Ie(e)&&Ie(t))return F.pow[e.kind](e,t);throw new Error("Invalid arguments to pow()")}var Qd=B({name:"pow",signature:(...e)=>{let t=st(e,[b,St,Dt])??e;return{argTypes:t,returnType:zr(t[0])?t[1]:t[0]}},normalImpl:Kd,codegenImpl:(e,t)=>$`pow(${e}, ${t})`});B({name:"quantizeToF16",signature:e=>({argTypes:[e],returnType:e}),normalImpl:"CPU implementation for quantizeToF16 not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>$`quantizeToF16(${e})`});function Jd(e){if(typeof e=="number")return e*Math.PI/180;throw new Vt("CPU implementation for radians on vectors not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")}B({name:"radians",signature:(...e)=>{let t=st(e,[b,St,Dt])??e;return{argTypes:t,returnType:t[0]}},normalImpl:Jd,codegenImpl:e=>$`radians(${e})`});B({name:"reflect",signature:(e,t)=>({argTypes:[e,t],returnType:e}),normalImpl:(e,t)=>La(e,zi(2*Cd(t,e),t)),codegenImpl:(e,t)=>$`reflect(${e}, ${t})`});Qe((e,t,r)=>{throw new Vt("CPU implementation for refract not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")},(e,t,r)=>M($`refract(${e}, ${t}, ${r})`,e.dataType),"refract",(e,t,r)=>[e.dataType,t.dataType,bi(e)?St:b]);B({name:"reverseBits",signature:e=>({argTypes:[e],returnType:e}),normalImpl:"CPU implementation for reverseBits not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>$`reverseBits(${e})`});function eh(e){if(typeof e=="number")return Math.round(e);throw new Vt("CPU implementation for round on vectors not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")}B({name:"round",signature:e=>({argTypes:[e],returnType:e}),normalImpl:eh,codegenImpl:e=>$`round(${e})`});function th(e){if(typeof e=="number")return Math.max(0,Math.min(1,e));throw new Vt("CPU implementation for saturate on vectors not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")}B({name:"saturate",signature:e=>({argTypes:[e],returnType:e}),normalImpl:th,codegenImpl:e=>$`saturate(${e})`});function rh(e){return typeof e=="number"?Math.sign(e):F.sign[e.kind](e)}B({name:"sign",signature:e=>({argTypes:[e],returnType:e}),normalImpl:rh,codegenImpl:e=>$`sign(${e})`});function nh(e){return typeof e=="number"?Math.sin(e):F.sin[e.kind](e)}B({name:"sin",signature:e=>({argTypes:[e],returnType:e}),normalImpl:nh,codegenImpl:e=>$`sin(${e})`});function ah(e){if(typeof e=="number")return Math.sinh(e);throw new Vt("CPU implementation for sinh on vectors not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")}B({name:"sinh",signature:e=>({argTypes:[e],returnType:e}),normalImpl:ah,codegenImpl:e=>$`sinh(${e})`});function sh(e,t,r){return typeof r=="number"?Or(e,t,r):F.smoothstep[r.kind](e,t,r)}B({name:"smoothstep",signature:(e,t,r)=>({argTypes:[e,t,r],returnType:r}),normalImpl:sh,codegenImpl:(e,t,r)=>$`smoothstep(${e}, ${t}, ${r})`});function ih(e){return typeof e=="number"?Math.sqrt(e):F.sqrt[e.kind](e)}B({name:"sqrt",signature:e=>({argTypes:[e],returnType:e}),normalImpl:ih,codegenImpl:e=>$`sqrt(${e})`});function oh(e,t){if(typeof e=="number")return e<=t?1:0;throw new Vt("CPU implementation for step on vectors not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")}B({name:"step",signature:(...e)=>{let t=st(e,[b,St,Dt])??e;return{argTypes:t,returnType:t[0]}},normalImpl:oh,codegenImpl:(e,t)=>$`step(${e}, ${t})`});function lh(e){if(typeof e=="number")return Math.tan(e);throw new Vt("CPU implementation for tan on vectors not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues")}B({name:"tan",signature:e=>({argTypes:[e],returnType:e}),normalImpl:lh,codegenImpl:e=>$`tan(${e})`});function uh(e){return typeof e=="number"?Math.tanh(e):F.tanh[e.kind](e)}B({name:"tanh",signature:e=>({argTypes:[e],returnType:e}),normalImpl:uh,codegenImpl:e=>$`tanh(${e})`});B({name:"transpose",signature:e=>({argTypes:[e],returnType:e}),normalImpl:"CPU implementation for transpose not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>$`transpose(${e})`});B({name:"trunc",signature:e=>({argTypes:[e],returnType:e}),normalImpl:"CPU implementation for trunc not implemented yet. Please submit an issue at https://github.com/software-mansion/TypeGPU/issues",codegenImpl:e=>$`trunc(${e})`});var{NodeTypeCatalog:ye}=uf,ch=["==","!=","<","<=",">",">=","<<",">>","+","-","*","/","%","|","^","&","&&","||"],ph=["&&","||","==","!=","<","<=",">",">="],fh=["vec2f","vec3f","vec4f","vec2h","vec3h","vec4h","vec2i","vec3i","vec4i","vec2u","vec3u","vec4u","mat2x2f","mat3x3f","mat4x4f"],mo={add:mu,sub:La,mul:zi,div:gu};function yo(e,t,r){return r?ph.includes(t)?at:t==="="?r:e:t==="!"||t==="~"?at:e}var dh={"+":mu[v].gpuImpl,"-":La[v].gpuImpl,"*":zi[v].gpuImpl,"/":gu[v].gpuImpl,"**":Qd[v].gpuImpl},Pn,qo,hh=(qo=class{constructor(){W(this,Pn)}initGenerator(e){N(this,Pn,e)}get ctx(){if(!g(this,Pn))throw new Error("WGSL Generator has not yet been initialized. Please call initialize(ctx) before using the generator.");return g(this,Pn)}block([e,t]){this.ctx.pushBlockScope();try{this.ctx.indent();let r=t.map(n=>this.statement(n)).join(`
`);return this.ctx.dedent(),`{
${r}
${this.ctx.pre}}`}finally{this.ctx.popBlockScope()}}blockVariable(e,t){let r=M(this.ctx.makeNameValid(e),t);return this.ctx.defineVariable(e,r),r}identifier(e){if(!e)throw new Error("Cannot resolve an empty identifier");let t=this.ctx.getById(e);if(!t)throw new Error(`Identifier ${e} not found`);return t}typedExpression(e,t){let r=this.ctx.expectedType;this.ctx.expectedType=t;try{let n=this.expression(e);return Di(n,t)}finally{this.ctx.expectedType=r}}expression(e){var t,r;if(typeof e=="string")return this.identifier(e);if(typeof e=="boolean")return M(e,at);if(e[0]===ye.logicalExpr||e[0]===ye.binaryExpr||e[0]===ye.assignmentExpr){let[n,a,s,i]=e,o=this.expression(a),l=this.expression(i),u=dh[s];if(u)return u(o,l);let c=e[0]===ye.assignmentExpr?o.dataType.type==="ptr"?[o.dataType.inner]:[o.dataType]:void 0,[p,d]=Os([o,l],c)??[o,l],h=this.ctx.resolve(p.value,p.dataType).value,f=this.ctx.resolve(d.value,d.dataType).value,m=yo(p.dataType,s,d.dataType);return M(ch.includes(s)?`(${h} ${s} ${f})`:`${h} ${s} ${f}`,m)}if(e[0]===ye.postUpdate){let[n,a,s]=e,i=this.expression(s),o=this.ctx.resolve(i.value,i.dataType).value;return M(`${o}${a}`,i.dataType)}if(e[0]===ye.unaryExpr){let[n,a,s]=e,i=this.expression(s),o=this.ctx.resolve(i.value,i.dataType).value,l=yo(i.dataType,a);return M(`${a}${o}`,l)}if(e[0]===ye.memberAccess){let[n,a,s]=e,i=this.expression(a);if(i.value===console)return M(new Vi(s),pt);if(fh.includes(i.dataType.type)&&s in mo)return{value:new ji(s,i,mo[s][v].gpuImpl),dataType:pt};if(i.dataType.type==="unknown"){let o=i.value[s];return rs(o)}return Ni(i.dataType)?M(`(*${this.ctx.resolve(i.value).value}).${s}`,ei(i.dataType.inner,s)):fr(i.dataType)&&s==="length"?i.dataType.elementCount===0?M(`arrayLength(&${this.ctx.resolve(i.value).value})`,te):M(String(i.dataType.elementCount),Ss):Xs(i.dataType)&&s==="columns"?M(new qi(i),pt):Wn(i.dataType)&&Ie(i.value)?rs(i.value[s]):M(`${this.ctx.resolve(i.value).value}.${s}`,ei(i.dataType,s))}if(e[0]===ye.indexAccess){let[n,a,s]=e,i=this.expression(a),o=this.expression(s),l=this.ctx.resolve(o.value,o.dataType).value;if(i.value instanceof qi)return M($`${i.value.matrix}[${l}]`,Ds(i.value.matrix.dataType));let u=this.ctx.resolve(i.value,i.dataType).value;if(i.dataType.type==="unknown"){if(Array.isArray(s)&&s[0]===ye.numericLiteral)return rs(i.value[s[1]]);throw new Error(`Unable to index a value of unknown type with index ${l}. If the value is an array, to address this, consider one of the following approaches: (1) declare the array using 'tgpu.const', (2) store the array in a buffer, or (3) define the array within the GPU function scope.`)}if(Xs(i.dataType))throw new Error("The only way of accessing matrix elements in TGSL is through the 'columns' property.");return Ni(i.dataType)?M(`(*${u})[${l}]`,Ds(i.dataType.inner)):M(`${u}[${l}]`,qn(i.dataType)?Ds(i.dataType):pt)}if(e[0]===ye.numericLiteral){let n=typeof e[1]=="string"?hs(yh(e[1])):hs(e[1]);if(!n)throw new Error(`Invalid numeric literal ${e[1]}`);return n}if(e[0]===ye.call){let[n,a,s]=e,i=this.expression(a);if(Tt(i.value)||fr(i.value)){if(s.length>1)throw new Ct("Array and struct schemas should always be called with at most 1 argument");if(!s[0])return M(`${this.ctx.resolve(i.value).value}()`,i.value);let l=this.typedExpression(s[0],i.value);return M(this.ctx.resolve(l.value,i.value).value,i.value)}if(i.value===ti)throw new Error("Constants cannot be defined within TypeGPU function scope. To address this, move the constant definition outside the function scope.");if(i.value instanceof ji){if(!s[0])throw new Ct(`An infix operator '${i.value.name}' was called without any arguments`);let l=this.expression(s[0]);return i.value.operator(i.value.lhs,l)}if(!wi(i.value)){let l=s.map(c=>this.expression(c)),u=this.ctx.shelllessRepo.get(i.value,l);if(u)return this.ctx.withResetIndentLevel(()=>{let c=this.ctx.resolve(u);return M($`${c.value}(${l})`,c.dataType)});throw new Error(`Function '${C(i.value)??String(i.value)}' is not marked with the 'use gpu' directive and cannot be used in a shader`)}let o=((t=i.value[v])==null?void 0:t.argConversionHint)??"keep";try{let l;if(Array.isArray(o))l=s.map((c,p)=>{let d=o[p];if(!d)throw new Ct(`Function '${C(i.value)}' was called with too many arguments`);return this.typedExpression(c,d)});else{let c=s.map(p=>this.expression(p));o==="keep"?l=c:o==="unify"?l=Os(c)??c:l=o(...c).map((p,d)=>[p,c[d]]).map(([p,d])=>Di(d,p))}if(i.value instanceof Vi)return this.ctx.generateLog(i.value.op,l);let u=i.value(...l);if(!Dl(u))throw new Error("Functions running in codegen mode must return snippets");return u}catch(l){throw new ua(l,[{toString:()=>C(i.value)}])}}if(e[0]===ye.objectExpr){let n=e[1],a=this.ctx.expectedType;if(!a||!Tt(a))throw new Ct(`No target type could be inferred for object with keys [${Object.keys(n).join(", ")}], please wrap the object in the corresponding schema.`);let s=Object.fromEntries(Object.entries(a.propTypes).map(([o,l])=>{let u=n[o];if(u===void 0)throw new Ct(`Missing property ${o} in object literal for struct ${a}`);let c=this.typedExpression(u,l);return[o,c]})),i=Rc(a,s);return M($`${this.ctx.resolve(a).value}(${i})`,a)}if(e[0]===ye.arrayExpr){let[n,a]=e,s=this.ctx.expectedType,i,o;if(fr(s)){if(i=s.elementType,o=a.map(u=>this.typedExpression(u,i)),o.length!==s.elementCount)throw new Ct(`Cannot create value of type '${s}' from an array of length: ${o.length}`)}else{let u=a.map(p=>this.expression(p));if(u.length===0)throw new Ct("Cannot infer the type of an empty array literal.");let c=Os(u);if(!c)throw new Ct("The given values cannot be automatically converted to a common type. Consider wrapping the array in an appropriate schema");o=c,i=ba((r=o[0])==null?void 0:r.dataType)}let l=`array<${this.ctx.resolve(i).value}, ${o.length}>`;return M($`${l}(${o})`,Hs[v].jsImpl(i,o.length))}if(e[0]===ye.stringLiteral)return M(e[1],pt);if(e[0]===ye.preUpdate)throw new Error("Cannot use pre-updates in TGSL.");mh(e)}functionDefinition(e){return this.block(e)}statement(e){if(typeof e=="string")return`${this.ctx.pre}${this.ctx.resolve(this.identifier(e).value).value};`;if(typeof e=="boolean")return`${this.ctx.pre}${e?"true":"false"};`;if(e[0]===ye.return){let t=e[1];if(t!==void 0){let r=this.ctx.topFunctionReturnType,n=r?this.typedExpression(t,r):this.expression(t);return Gr(n.dataType.type!=="unknown"),this.ctx.reportReturnType(n.dataType),$`${this.ctx.pre}return ${n};`}return`${this.ctx.pre}return;`}if(e[0]===ye.if){let[t,r,n,a]=e,s=this.typedExpression(r,at),i=s.value===!1?void 0:this.block(Za(n)),o=s.value===!0||!a?void 0:this.block(Za(a));return s.value===!0?`${this.ctx.pre}${i}`:s.value===!1?o?`${this.ctx.pre}${o}`:"":o?$`\
${this.ctx.pre}if (${s}) ${i}
${this.ctx.pre}else ${o}`:$`${this.ctx.pre}if (${s}) ${i}`}if(e[0]===ye.let||e[0]===ye.const){let[t,r,n]=e,a=n!==void 0?this.expression(n):void 0;if(!a)throw new Error(`Cannot create variable '${r}' without an initial value.`);if(gi(a.dataType))throw new Error(`Cannot create variable '${r}' with loose data type.`);let s=this.blockVariable(r,ba(a.dataType));return $`${this.ctx.pre}var ${s.value} = ${a};`}if(e[0]===ye.block)return this.block(e);if(e[0]===ye.for){let[t,r,n,a,s]=e,[i,o,l]=this.ctx.withResetIndentLevel(()=>[r?this.statement(r):void 0,n?this.typedExpression(n,at):void 0,a?this.statement(a):void 0]),u=i?i.slice(0,-1):"",c=l?l.slice(0,-1):"",p=this.block(Za(s));return $`${this.ctx.pre}for (${u}; ${o}; ${c}) ${p}`}if(e[0]===ye.while){let[t,r,n]=e,a=this.typedExpression(r,at),s=this.ctx.resolve(a.value).value,i=this.block(Za(n));return`${this.ctx.pre}while (${s}) ${i}`}return e[0]===ye.continue?`${this.ctx.pre}continue;`:e[0]===ye.break?`${this.ctx.pre}break;`:`${this.ctx.pre}${this.ctx.resolve(this.expression(e).value).value};`}},Pn=new WeakMap,qo);function mh(e){throw new Error(`'${ls(e)}' was not handled by the WGSL generator.`)}function yh(e){return/^0x[0-9a-f]+$/i.test(e)?Number.parseInt(e):/^0b[01]+$/i.test(e)?Number.parseInt(e.slice(2),2):Number.parseFloat(e)}function Za(e){return typeof e!="object"||e[0]!==ye.block?[ye.block,[e]]:e}var gh=new hh,vu=gh,wu=Object.defineProperty,vh=(e,t,r)=>t in e?wu(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,wh=(e,t)=>{for(var r in t)wu(e,r,{get:t[r],enumerable:!0})},ie=(e,t,r)=>vh(e,typeof t!="symbol"?t+"":t,r),xh={};wh(xh,{BufferReader:()=>Br,BufferWriter:()=>en,MaxValue:()=>Ee,Measurer:()=>_e,UnresolvedReferenceError:()=>Lr,ValidationError:()=>zs,arrayOf:()=>Mh,bool:()=>_h,byte:()=>Eh,chars:()=>Yh,concat:()=>Kh,dynamicArrayOf:()=>Jh,f16:()=>jh,f32:()=>qh,f32Array:()=>mm,f64Array:()=>ym,generic:()=>Xh,genericEnum:()=>Hh,i16:()=>Ch,i16Array:()=>dm,i32:()=>Fh,i32Array:()=>hm,i8:()=>Ih,i8Array:()=>fm,keyed:()=>rm,object:()=>Zh,optional:()=>am,string:()=>Ph,tupleOf:()=>om,u16:()=>Oh,u16Array:()=>cm,u32:()=>Dh,u32Array:()=>pm,u8:()=>Su,u8Array:()=>lm,u8ClampedArray:()=>um});var Lr=class xu extends Error{constructor(t){super(t),Object.setPrototypeOf(this,xu.prototype)}},zs=class bu extends Error{constructor(t){super(t),Object.setPrototypeOf(this,bu.prototype)}},bh=class{constructor(){ie(this,"size",Number.NaN),ie(this,"unbounded",this),ie(this,"isUnbounded",!0)}add(){return this}fork(){return this}},Th=new bh,_e=class Tu{constructor(){ie(this,"size",0),ie(this,"unbounded",Th),ie(this,"isUnbounded",!1)}add(t){return this.size+=t,this}fork(){const t=new Tu;return t.size=this.size,t}},Ee=Symbol("The biggest (in amount of bytes needed) value a schema can represent"),Ze=class{constructor(){ie(this,"__unwrapped")}resolveReferences(e){}seekProperty(e,t){return null}},$h=class{constructor(e){this.key=e}},ga={STRING:"string",ENUM:"enum"},Sh=class extends Ze{constructor(e,t){super(),this._unstableElementSchema=e,this.length=t,ie(this,"elementSchema"),this.elementSchema=e}resolveReferences(e){this.elementSchema=e.resolve(this._unstableElementSchema)}write(e,t){if(t.length!==this.length)throw new zs(`Expected array of length ${this.length}, got ${t.length}`);for(const r of t)this.elementSchema.write(e,r)}read(e){const t=[];for(let r=0;r<this.length;++r)t.push(this.elementSchema.read(e));return t}get maxSize(){return this.elementSchema.measure(Ee).size*this.length}measure(e,t=new _e){for(let r=0;r<this.length;++r)this.elementSchema.measure(e===Ee?Ee:e[r],t);return t}};function Mh(e,t){return new Sh(e,t)}var kh=class extends Ze{constructor(){super(...arguments),ie(this,"maxSize",1)}read(e){return e.readBool()}write(e,t){e.writeBool(t)}measure(e,t=new _e){return t.add(1)}},_h=new kh,$u=class pa extends Ze{static get _encoder(){return pa._cachedEncoder||(pa._cachedEncoder=new TextEncoder),pa._cachedEncoder}read(t){return t.readString()}write(t,r){t.writeString(r)}measure(t,r=new _e){if(t===Ee)return r.unbounded;const n=pa._encoder.encode(t);return r.add(n.byteLength+1)}};ie($u,"_cachedEncoder");var Bh=$u,Ph=new Bh,zh=class extends Ze{constructor(){super(...arguments),ie(this,"maxSize",1)}read(e){return e.readInt8()}write(e,t){e.writeInt8(t)}measure(e,t=new _e){return t.add(1)}},Ih=new zh,Uh=class extends Ze{constructor(){super(...arguments),ie(this,"maxSize",1)}read(e){return e.readUint8()}write(e,t){e.writeUint8(t)}measure(e,t=new _e){return t.add(1)}},Su=new Uh,Eh=Su,Rh=class extends Ze{constructor(){super(...arguments),ie(this,"maxSize",2)}read(e){return e.readInt16()}write(e,t){e.writeInt16(t)}measure(e,t=new _e){return t.add(2)}},Ch=new Rh,Ah=class extends Ze{constructor(){super(...arguments),ie(this,"maxSize",2)}read(e){return e.readUint16()}write(e,t){e.writeUint16(t)}measure(e,t=new _e){return t.add(2)}},Oh=new Ah,Lh=class extends Ze{constructor(){super(...arguments),ie(this,"maxSize",4)}read(e){return e.readInt32()}write(e,t){e.writeInt32(t)}measure(e,t=new _e){return t.add(4)}},Fh=new Lh,Gh=class extends Ze{constructor(){super(...arguments),ie(this,"maxSize",4)}read(e){return e.readUint32()}write(e,t){e.writeUint32(t)}measure(e,t=new _e){return t.add(4)}},Dh=new Gh,Vh=class extends Ze{constructor(){super(...arguments),ie(this,"maxSize",2)}read(e){return e.readFloat16()}write(e,t){e.writeFloat16(t)}measure(e,t=new _e){return t.add(2)}},jh=new Vh,Nh=class extends Ze{constructor(){super(...arguments),ie(this,"maxSize",4)}read(e){return e.readFloat32()}write(e,t){e.writeFloat32(t)}measure(e,t=new _e){return t.add(4)}},qh=new Nh,Wh=class extends Ze{constructor(e){super(),this.length=e}write(e,t){if(t.length!==this.length)throw new zs(`Expected char-string of length ${this.length}, got ${t.length}`);for(let r=0;r<t.length;++r)e.writeUint8(t.charCodeAt(r))}read(e){let t="";for(let r=0;r<this.length;++r)t+=String.fromCharCode(e.readByte());return t}measure(e,t=new _e){return t.add(this.length)}};function Yh(e){return new Wh(e)}function kr(e){return Object.entries(e)}function Mu(e,t){const r={};for(const[n,a]of kr(t))r[n]=e.resolve(a);return r}var Ii=class extends Ze{constructor(e){super(),this._properties=e,ie(this,"properties"),this.properties=e}resolveReferences(e){this.properties=Mu(e,this._properties)}write(e,t){for(const[r,n]of kr(this.properties))n.write(e,t[r])}read(e){const t={};for(const[r,n]of kr(this.properties))t[r]=n.read(e);return t}get maxSize(){const e=new _e;for(const t of Object.values(this.properties))t.measure(Ee,e);return e.size}measure(e,t=new _e){for(const[r,n]of kr(this.properties))n.measure(e===Ee?Ee:e[r],t);return t}seekProperty(e,t){let r=0;for(const[n,a]of kr(this.properties)){if(n===t)return{bufferOffset:r,schema:a};r+=a.measure(e).size}return null}};function Zh(e){return new Ii(e)}var ku=class extends Ze{constructor(e,t,r){super(),this.keyedBy=e,this._subTypeMap=r,ie(this,"_baseObject"),ie(this,"subTypeMap"),this._baseObject=new Ii(t),this.subTypeMap=r}resolveReferences(e){this._baseObject.resolveReferences(e),this.subTypeMap=Mu(e,this._subTypeMap)}write(e,t){const r=t.type,n=this.subTypeMap[r]||null;if(n===null)throw new Error(`Unknown sub-type '${r.toString()}' in among '${JSON.stringify(Object.keys(this.subTypeMap))}'`);this.keyedBy===ga.ENUM?e.writeUint8(t.type):e.writeString(t.type),this._baseObject.write(e,t);for(const[a,s]of kr(n.properties))s.write(e,t[a])}read(e){const t=this.keyedBy===ga.ENUM?e.readByte():e.readString(),r=this.subTypeMap[t]||null;if(r===null)throw new Error(`Unknown sub-type '${t}' in among '${JSON.stringify(Object.keys(this.subTypeMap))}'`);const n=this._baseObject.read(e);if(n.type=t,r!==null)for(const[a,s]of kr(r.properties))n[a]=s.read(e);return n}measure(e,t=new _e){if(this._baseObject.measure(e,t),this.keyedBy===ga.ENUM)t.add(1);else if(e!==Ee)t.add(e.type.length+1);else return t.unbounded;if(e===Ee){const r=Object.values(this.subTypeMap).map(n=>{const a=t.fork();for(const s of Object.values(n.properties))s.measure(Ee,a);return[n,a.size]}).reduce((n,a)=>n[1]>a[1]?n:a)[0];for(const n of Object.values(r.properties))n.measure(Ee,t)}else{const r=e.type,n=this.subTypeMap[r]||null;if(n===null)throw new Error(`Unknown sub-type '${r.toString()}', expected one of '${JSON.stringify(Object.keys(this.subTypeMap))}'`);for(const[a,s]of kr(n.properties))s.measure(e[a],t)}return t}};function Xh(e,t){return new ku(ga.STRING,e,t)}function Hh(e,t){return new ku(ga.ENUM,e,t)}function Kh(e){return new Ii(Object.fromEntries(e.flatMap(({properties:t})=>Object.entries(t))))}var Qh=class extends Ze{constructor(e){super(),this._unstableElementType=e,ie(this,"elementType"),this.elementType=e}resolveReferences(e){this.elementType=e.resolve(this._unstableElementType)}write(e,t){e.writeUint32(t.length);for(const r of t)this.elementType.write(e,r)}read(e){const t=[],r=e.readUint32();for(let n=0;n<r;++n)t.push(this.elementType.read(e));return t}get maxSize(){return this.measure(Ee).size}measure(e,t=new _e){if(e===Ee)return t.unbounded;t.add(4);for(const r of e)this.elementType.measure(r,t);return t}seekProperty(e,t){if(typeof t=="symbol")return null;const r=Number.parseInt(String(t),10);if(Number.isNaN(r))return null;if(e===Ee)return{bufferOffset:this.elementType.measure(Ee).size*r,schema:this.elementType};if(r>=e.length)return null;const n=new _e;for(let a=0;a<r;++a)this.elementType.measure(e[a],n);return{bufferOffset:n.size,schema:this.elementType}}};function Jh(e){return new Qh(e)}var _u=class{constructor(e){ie(this,"__unwrapped"),ie(this,"ref"),this.ref=new $h(e)}resolveReferences(){throw new Lr("Tried to resolve a reference directly. Do it through a RefResolver instead.")}read(){throw new Lr("Tried to read a reference directly. Resolve it instead.")}write(){throw new Lr("Tried to write a reference directly. Resolve it instead.")}measure(){throw new Lr("Tried to measure size of a reference directly. Resolve it instead.")}seekProperty(){throw new Lr("Tried to seek property of a reference directly. Resolve it instead.")}},em=class{constructor(){ie(this,"registry",{})}hasKey(e){return this.registry[e]!==void 0}register(e,t){this.registry[e]=t}resolve(e){if(e instanceof _u){const r=e.ref.key;if(this.registry[r]!==void 0)return this.registry[r];throw new Lr(`Couldn't resolve reference to ${r}. Unknown key.`)}return e.resolveReferences(this),e}},tm=class{constructor(e,t){this.key=e,ie(this,"__unwrapped"),ie(this,"__keyDefinition"),ie(this,"innerType"),this.innerType=t(new _u(e)),this.resolveReferences(new em)}resolveReferences(e){e.hasKey(this.key)||(e.register(this.key,this.innerType),this.innerType.resolveReferences(e))}read(e){return this.innerType.read(e)}write(e,t){this.innerType.write(e,t)}get maxSize(){return this.measure(Ee).size}measure(e,t=new _e){return this.innerType.measure(e,t)}seekProperty(e,t){return this.innerType.seekProperty(e,t)}};function rm(e,t){return new tm(e,t)}var nm=class extends Ze{constructor(e){super(),this._innerUnstableSchema=e,ie(this,"innerSchema"),this.innerSchema=e}resolveReferences(e){this.innerSchema=e.resolve(this._innerUnstableSchema)}write(e,t){t!=null?(e.writeBool(!0),this.innerSchema.write(e,t)):e.writeBool(!1)}read(e){if(e.readBool())return this.innerSchema.read(e)}get maxSize(){return this.measure(Ee).size}measure(e,t=new _e){return e!==void 0&&this.innerSchema.measure(e,t),t.add(1)}};function am(e){return new nm(e)}function sm(e,t){return t.map(r=>e.resolve(r))}var im=class extends Ze{constructor(e){super(),this._unstableSchemas=e,ie(this,"schemas"),this.schemas=e}resolveReferences(e){this.schemas=sm(e,this._unstableSchemas)}write(e,t){if(t.length!==this.schemas.length)throw new zs(`Expected tuple of length ${this.schemas.length}, got ${t.length}`);for(let r=0;r<this.schemas.length;++r)this.schemas[r].write(e,t[r])}read(e){const t=[];for(let r=0;r<this.schemas.length;++r)t.push(this.schemas[r].read(e));return t}get maxSize(){return this.measure(Ee).size}measure(e,t=new _e){for(let r=0;r<this.schemas.length;++r)this.schemas[r].measure(e===Ee?Ee:e[r],t);return t}};function om(e){return new im(e)}var gr=class extends Ze{constructor(e,t){super(),this.length=e,this._arrayConstructor=t,ie(this,"byteLength"),this.byteLength=e*t.BYTES_PER_ELEMENT}write(e,t){e.writeSlice(t)}read(e){const t=new ArrayBuffer(this.byteLength),r=new this._arrayConstructor(t,0,this.length);return e.readSlice(r,0,this.byteLength),r}measure(e,t=new _e){return t.add(this.byteLength)}},lm=e=>new gr(e,Uint8Array),um=e=>new gr(e,Uint8ClampedArray),cm=e=>new gr(e,Uint16Array),pm=e=>new gr(e,Uint32Array),fm=e=>new gr(e,Int8Array),dm=e=>new gr(e,Int16Array),hm=e=>new gr(e,Int32Array),mm=e=>new gr(e,Float32Array),ym=e=>new gr(e,Float64Array);function gm(){const e=new Uint8Array(4),t=new Uint32Array(e.buffer);return t[0]=1,e[0]===0}function Bu(){return gm()?"big":"little"}function Ui(e){let t=0,r=e;return r&&"buffer"in r&&"byteOffset"in r&&(t+=r.byteOffset,r=r.buffer),{buffer:r,byteOffset:t,byteLength:e.byteLength}}var Pu=class{constructor(e,t){ie(this,"dataView"),ie(this,"littleEndian"),ie(this,"byteOffset",0),ie(this,"endianness");const{byteOffset:r=0,endianness:n="system"}=t??{};this.byteOffset=r;const a=Bu();this.endianness=n==="system"?a:n,this.littleEndian=this.endianness==="little";const s=Ui(e);this.byteOffset+=s.byteOffset,this.dataView=new DataView(s.buffer)}get currentByteOffset(){return this.byteOffset}seekTo(e){this.byteOffset=e}skipBytes(e){this.byteOffset+=e}};function vm(e){if(e===0)return 0;if(Number.isNaN(e))return 32256;if(!Number.isFinite(e))return e>0?31744:64512;const t=e<0?1:0,r=Math.abs(e),n=Math.floor(Math.log2(r)),a=r/2**n-1,s=n+15,i=Math.floor(a*1024);return t<<15|s<<10|i}function wm(e){const t=(e&32768)>>15,r=(e&31744)>>10,n=e&1023;return r===0?t===0?n/1024:-n/1024:r===31?n===0?t===0?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:Number.NaN:(t===0?1:-1)*(1+n/1024)*2**(r-15)}var Br=class extends Pu{constructor(){super(...arguments),ie(this,"_cachedTextDecoder")}get _textDecoder(){return this._cachedTextDecoder||(this._cachedTextDecoder=new TextDecoder(void 0,{fatal:!0})),this._cachedTextDecoder}readBool(){return this.dataView.getUint8(this.byteOffset++)!==0}readByte(){return this.dataView.getUint8(this.byteOffset++)}readInt8(){return this.dataView.getInt8(this.byteOffset++)}readUint8(){return this.dataView.getUint8(this.byteOffset++)}readInt16(){const e=this.dataView.getInt16(this.byteOffset,this.littleEndian);return this.byteOffset+=2,e}readUint16(){const e=this.dataView.getUint16(this.byteOffset,this.littleEndian);return this.byteOffset+=2,e}readInt32(){const e=this.dataView.getInt32(this.byteOffset,this.littleEndian);return this.byteOffset+=4,e}readUint32(){const e=this.dataView.getUint32(this.byteOffset,this.littleEndian);return this.byteOffset+=4,e}readFloat16(){const e=this.dataView.getUint16(this.byteOffset,this.littleEndian);return this.byteOffset+=2,wm(e)}readFloat32(){const e=this.dataView.getFloat32(this.byteOffset,this.littleEndian);return this.byteOffset+=4,e}readString(){let e=0;for(;this.byteOffset+e<this.dataView.byteLength&&this.dataView.getUint8(this.byteOffset+e++)!==0;);const t=this._textDecoder.decode(new Uint8Array(this.dataView.buffer,this.byteOffset,e-1));return this.byteOffset+=e,t}readSlice(e,t,r){const n=Ui(e),a=new Uint8Array(n.buffer,n.byteOffset+t);for(let s=0;s<r;++s)a[s]=this.dataView.getUint8(this.byteOffset++)}},en=class extends Pu{constructor(){super(...arguments),ie(this,"_cachedTextEncoder")}get _textEncoder(){return this._cachedTextEncoder||(this._cachedTextEncoder=new TextEncoder),this._cachedTextEncoder}writeBool(e){this.dataView.setUint8(this.byteOffset++,e?1:0)}writeByte(e){this.dataView.setUint8(this.byteOffset++,e)}writeInt8(e){this.dataView.setInt8(this.byteOffset++,e)}writeUint8(e){this.dataView.setUint8(this.byteOffset++,e)}writeInt16(e){this.dataView.setInt16(this.byteOffset,e,this.littleEndian),this.byteOffset+=2}writeUint16(e){this.dataView.setUint16(this.byteOffset,e,this.littleEndian),this.byteOffset+=2}writeInt32(e){this.dataView.setInt32(this.byteOffset,e,this.littleEndian),this.byteOffset+=4}writeUint32(e){this.dataView.setUint32(this.byteOffset,e,this.littleEndian),this.byteOffset+=4}writeFloat16(e){this.dataView.setUint16(this.byteOffset,vm(e),this.littleEndian),this.byteOffset+=2}writeFloat32(e){this.dataView.setFloat32(this.byteOffset,e,this.littleEndian),this.byteOffset+=4}writeString(e){const t=this._textEncoder.encodeInto(e,new Uint8Array(this.dataView.buffer,this.byteOffset));this.byteOffset+=t.written,this.dataView.setUint8(this.byteOffset++,0)}writeSlice(e){const t=Ui(e),r=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);for(const n of r)this.dataView.setUint8(this.byteOffset++,n)}},xm=B({name:"bitcastU32toF32",normalImpl:e=>typeof e=="number"?Wt(e):F.bitcastU32toF32[e.kind](e),codegenImpl:e=>$`bitcast<f32>(${e})`,signature:(...e)=>{let t=st(e,[te])??e;return{argTypes:t,returnType:Wn(t[0])?t[0].type==="vec2u"?ke:t[0].type==="vec3u"?Ke:S:b}}}),bm=B({name:"bitcastU32toI32",normalImpl:e=>typeof e=="number"?Yt(e):F.bitcastU32toI32[e.kind](e),codegenImpl:e=>$`bitcast<i32>(${e})`,signature:(...e)=>{let t=st(e,[te])??e;return{argTypes:t,returnType:Wn(t[0])?t[0].type==="vec2u"?bt:t[0].type==="vec3u"?Gt:ze:qe}}}),Tm=Qe(e=>{let t=new ArrayBuffer(4);new en(t).writeUint32(e);let r=new Br(t);return ke(r.readFloat16(),r.readFloat16())},e=>M($`unpack2x16float(${e})`,ke),"unpack2x16float");Qe(e=>{let t=new ArrayBuffer(4),r=new en(t);r.writeFloat16(e.x),r.writeFloat16(e.y);let n=new Br(t);return te(n.readUint32())},e=>M($`pack2x16float(${e})`,te),"pack2x16float");Qe(e=>{let t=new ArrayBuffer(4);new en(t).writeUint32(e);let r=new Br(t);return S(r.readUint8()/255,r.readUint8()/255,r.readUint8()/255,r.readUint8()/255)},e=>M($`unpack4x8unorm(${e})`,S),"unpack4x8unorm");Qe(e=>{let t=new ArrayBuffer(4),r=new en(t);r.writeUint8(e.x*255),r.writeUint8(e.y*255),r.writeUint8(e.z*255),r.writeUint8(e.w*255);let n=new Br(t);return te(n.readUint32())},e=>M($`pack4x8unorm(${e})`,te),"pack4x8unorm");function Hn(e){return e.type.includes("2")?Xn:e.type.includes("3")?Zn:Yn}var $m=B({name:"allEq",signature:(...e)=>({argTypes:e,returnType:at}),normalImpl:(e,t)=>Ri(Fa(e,t)),codegenImpl:(e,t)=>$`all(${e} == ${t})`}),Fa=(e,t)=>F.eq[e.kind](e,t);B({name:"eq",signature:(...e)=>({argTypes:e,returnType:Hn(e[0])}),normalImpl:Fa,codegenImpl:(e,t)=>$`(${e} == ${t})`});B({name:"ne",signature:(...e)=>({argTypes:e,returnType:Hn(e[0])}),normalImpl:(e,t)=>dr(Fa(e,t)),codegenImpl:(e,t)=>$`(${e} != ${t})`});var Is=(e,t)=>F.lt[e.kind](e,t);B({name:"lt",signature:(...e)=>({argTypes:e,returnType:Hn(e[0])}),normalImpl:Is,codegenImpl:(e,t)=>$`(${e} < ${t})`});B({name:"le",signature:(...e)=>({argTypes:e,returnType:Hn(e[0])}),normalImpl:(e,t)=>Ei(Is(e,t),Fa(e,t)),codegenImpl:(e,t)=>$`(${e} <= ${t})`});B({name:"gt",signature:(...e)=>({argTypes:e,returnType:Hn(e[0])}),normalImpl:(e,t)=>zu(dr(Is(e,t)),dr(Fa(e,t))),codegenImpl:(e,t)=>$`(${e} > ${t})`});B({name:"ge",signature:(...e)=>({argTypes:e,returnType:Hn(e[0])}),normalImpl:(e,t)=>dr(Is(e,t)),codegenImpl:(e,t)=>$`(${e} >= ${t})`});var dr=e=>F.neg[e.kind](e);B({name:"not",signature:(...e)=>({argTypes:e,returnType:e[0]}),normalImpl:dr,codegenImpl:e=>$`!(${e})`});var Ei=(e,t)=>F.or[e.kind](e,t);B({name:"or",signature:(...e)=>({argTypes:e,returnType:e[0]}),normalImpl:Ei,codegenImpl:(e,t)=>$`(${e} | ${t})`});var zu=(e,t)=>dr(Ei(dr(e),dr(t)));B({name:"and",signature:(...e)=>({argTypes:e,returnType:e[0]}),normalImpl:zu,codegenImpl:(e,t)=>$`(${e} & ${t})`});var Ri=e=>F.all[e.kind](e);B({name:"all",signature:(...e)=>({argTypes:e,returnType:at}),normalImpl:Ri,codegenImpl:e=>$`all(${e})`});B({name:"any",signature:(...e)=>({argTypes:e,returnType:at}),normalImpl:e=>!Ri(dr(e)),codegenImpl:e=>$`any(${e})`});B({name:"isCloseTo",signature:(...e)=>({argTypes:e,returnType:at}),normalImpl:(e,t,r=.01)=>typeof e=="number"&&typeof t=="number"?Math.abs(e-t)<r:Ie(e)&&Ie(t)?F.isCloseToZero[e.kind](La[v].jsImpl(e,t),r):!1,codegenImpl:(e,t,r=M(.01,b))=>Va(e)&&Va(t)?$`(abs(f32(${e}) - f32(${t})) <= ${r})`:!Va(e)&&!Va(t)?$`all(abs(${e} - ${t}) <= (${e} - ${e}) + ${r})`:"false"});function Sm(e,t,r){return typeof r=="boolean"?r?t:e:F.select[e.kind](e,t,r)}B({name:"select",signature:(e,t,r)=>{let[n,a]=st([e,t])??[e,t];return{argTypes:[n,a,r],returnType:n}},normalImpl:Sm,codegenImpl:(e,t,r)=>$`select(${e}, ${t}, ${r})`});var Ga={r8unorm:{channelType:b,vectorType:S,texelSize:1,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:["write-only","read-only","read-write"]},r8snorm:{channelType:b,vectorType:S,texelSize:1,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:["write-only","read-only"]},r8uint:{channelType:te,vectorType:Ae,texelSize:1,sampleTypes:["uint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},r8sint:{channelType:qe,vectorType:ze,texelSize:1,sampleTypes:["sint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},rg8unorm:{channelType:b,vectorType:S,texelSize:2,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:["write-only","read-only"]},rg8snorm:{channelType:b,vectorType:S,texelSize:2,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:["write-only","read-only"]},rg8uint:{channelType:te,vectorType:Ae,texelSize:2,sampleTypes:["uint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},rg8sint:{channelType:qe,vectorType:ze,texelSize:2,sampleTypes:["sint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},rgba8unorm:{channelType:b,vectorType:S,texelSize:4,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:["write-only","read-only","read-write"]},"rgba8unorm-srgb":{channelType:b,vectorType:S,texelSize:4,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:null},rgba8snorm:{channelType:b,vectorType:S,texelSize:4,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},rgba8uint:{channelType:te,vectorType:Ae,texelSize:4,sampleTypes:["uint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},rgba8sint:{channelType:qe,vectorType:ze,texelSize:4,sampleTypes:["sint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},bgra8unorm:{channelType:b,vectorType:S,texelSize:4,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:["write-only"]},"bgra8unorm-srgb":{channelType:b,vectorType:S,texelSize:4,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:null},r16unorm:{channelType:b,vectorType:S,texelSize:2,sampleTypes:["unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},r16snorm:{channelType:b,vectorType:S,texelSize:2,sampleTypes:["unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},r16uint:{channelType:te,vectorType:Ae,texelSize:2,sampleTypes:["uint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},r16sint:{channelType:qe,vectorType:ze,texelSize:2,sampleTypes:["sint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},r16float:{channelType:b,vectorType:S,texelSize:2,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:["write-only","read-only","read-write"]},rg16unorm:{channelType:b,vectorType:S,texelSize:4,sampleTypes:["unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},rg16snorm:{channelType:b,vectorType:S,texelSize:4,sampleTypes:["unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},rg16uint:{channelType:te,vectorType:Ae,texelSize:4,sampleTypes:["uint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},rg16sint:{channelType:qe,vectorType:ze,texelSize:4,sampleTypes:["sint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},rg16float:{channelType:b,vectorType:S,texelSize:4,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:["write-only","read-only"]},rgba16unorm:{channelType:b,vectorType:S,texelSize:8,sampleTypes:["unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},rgba16snorm:{channelType:b,vectorType:S,texelSize:8,sampleTypes:["unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},rgba16uint:{channelType:te,vectorType:Ae,texelSize:8,sampleTypes:["uint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},rgba16sint:{channelType:qe,vectorType:ze,texelSize:8,sampleTypes:["sint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},rgba16float:{channelType:b,vectorType:S,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:["write-only","read-only","read-write"]},r32uint:{channelType:te,vectorType:Ae,texelSize:4,sampleTypes:["uint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},r32sint:{channelType:qe,vectorType:ze,texelSize:4,sampleTypes:["sint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},r32float:{channelType:b,vectorType:S,texelSize:4,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},rg32uint:{channelType:te,vectorType:Ae,texelSize:8,sampleTypes:["uint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:["write-only","read-only"]},rg32sint:{channelType:qe,vectorType:ze,texelSize:8,sampleTypes:["sint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:["write-only","read-only"]},rg32float:{channelType:b,vectorType:S,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!1,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},rgba32uint:{channelType:te,vectorType:Ae,texelSize:16,sampleTypes:["uint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},rgba32sint:{channelType:qe,vectorType:ze,texelSize:16,sampleTypes:["sint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},rgba32float:{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!1,canResolve:!1,storageBindings:["write-only","read-only","read-write"]},rgb10a2uint:{channelType:te,vectorType:Ae,texelSize:4,sampleTypes:["uint"],aspects:["color"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:["write-only","read-only"]},rgb10a2unorm:{channelType:b,vectorType:S,texelSize:4,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:["write-only","read-only"]},rg11b10ufloat:{channelType:b,vectorType:S,texelSize:4,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!0,canBlend:!0,canMultisample:!0,canResolve:!0,storageBindings:["write-only","read-only"]},rgb9e5ufloat:{channelType:b,vectorType:S,texelSize:4,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},stencil8:{channelType:te,vectorType:Ae,texelSize:1,sampleTypes:["uint"],aspects:["stencil"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:null},depth16unorm:{channelType:b,vectorType:S,texelSize:2,sampleTypes:["depth","unfilterable-float"],aspects:["depth"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:null},depth24plus:{channelType:b,vectorType:S,texelSize:4,sampleTypes:["depth","unfilterable-float"],aspects:["depth"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:null},"depth24plus-stencil8":{channelType:b,vectorType:S,texelSize:4,sampleTypes:["depth","unfilterable-float"],aspects:["depth","stencil"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:null},depth32float:{channelType:b,vectorType:S,texelSize:4,sampleTypes:["depth","unfilterable-float"],aspects:["depth"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:null},"depth32float-stencil8":{channelType:b,vectorType:S,texelSize:4,sampleTypes:["depth","unfilterable-float"],aspects:["depth","stencil"],canRenderAttachment:!0,canBlend:!1,canMultisample:!0,canResolve:!1,storageBindings:null},"bc1-rgba-unorm":{channelType:b,vectorType:S,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc1-rgba-unorm-srgb":{channelType:b,vectorType:S,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc2-rgba-unorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc2-rgba-unorm-srgb":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc3-rgba-unorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc3-rgba-unorm-srgb":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc4-r-unorm":{channelType:b,vectorType:S,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc4-r-snorm":{channelType:b,vectorType:S,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc5-rg-unorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc5-rg-snorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc6h-rgb-ufloat":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc6h-rgb-float":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc7-rgba-unorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"bc7-rgba-unorm-srgb":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"etc2-rgb8unorm":{channelType:b,vectorType:S,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"etc2-rgb8unorm-srgb":{channelType:b,vectorType:S,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"etc2-rgb8a1unorm":{channelType:b,vectorType:S,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"etc2-rgb8a1unorm-srgb":{channelType:b,vectorType:S,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"etc2-rgba8unorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"etc2-rgba8unorm-srgb":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"eac-r11unorm":{channelType:b,vectorType:S,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"eac-r11snorm":{channelType:b,vectorType:S,texelSize:8,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"eac-rg11unorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"eac-rg11snorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-4x4-unorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-4x4-unorm-srgb":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-5x4-unorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-5x4-unorm-srgb":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-5x5-unorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-5x5-unorm-srgb":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-6x5-unorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-6x5-unorm-srgb":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-6x6-unorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-6x6-unorm-srgb":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-8x5-unorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-8x5-unorm-srgb":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-8x6-unorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-8x6-unorm-srgb":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-8x8-unorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-8x8-unorm-srgb":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-10x5-unorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-10x5-unorm-srgb":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-10x6-unorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-10x6-unorm-srgb":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-10x8-unorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-10x8-unorm-srgb":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-10x10-unorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-10x10-unorm-srgb":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-12x10-unorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-12x10-unorm-srgb":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-12x12-unorm":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null},"astc-12x12-unorm-srgb":{channelType:b,vectorType:S,texelSize:16,sampleTypes:["float","unfilterable-float"],aspects:["color"],canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1,storageBindings:null}};function Iu(e,t){let r=Ga[e];if(!r)throw new Error(`Unknown texture format: ${e}`);let n={...r};switch(e){case"r32float":case"rg32float":case"rgba32float":t.features.has("float32-filterable")||(n={...n,sampleTypes:r.sampleTypes.filter(a=>a!=="float")}),t.features.has("float32-blendable")||(n={...n,canBlend:!1});break;case"bgra8unorm":t.features.has("bgra8unorm-storage")||(n={...n,storageBindings:null});break;case"rg11b10ufloat":t.features.has("rg11b10ufloat-renderable")||(n={...n,canRenderAttachment:!1,canBlend:!1,canMultisample:!1,canResolve:!1});break}if(n.storageBindings){let a=t.features.has("texture-formats-tier1"),s=t.features.has("texture-formats-tier2"),i=[...n.storageBindings],o=["r8unorm","r8uint","r8sint","r16uint","r16sint","r16float","rgba8unorm","rgba8uint","rgba8sint","rgba16uint","rgba16sint","rgba16float","r32uint","r32sint","r32float","rgba32uint","rgba32sint","rgba32float"],l=["r8snorm","rg8unorm","rg8snorm","rg8uint","rg8sint","rgba8snorm","r16unorm","r16snorm","rg16unorm","rg16snorm","rg16uint","rg16sint","rg16float","rgba16unorm","rgba16snorm","rgb10a2uint","rgb10a2unorm","rg11b10ufloat"];o.includes(e)&&!s&&(i=i.filter(u=>u!=="read-write")),l.includes(e)&&!a&&(i=i.filter(u=>u!=="write-only"&&u!=="read-only")),n={...n,storageBindings:i.length>0?i:null}}return n}var Uu=["f16","clip_distances","dual_source_blending","subgroups","primitive_index"],Eu={f16:"shader-f16",clip_distances:"clip-distances",dual_source_blending:"dual-source-blending",subgroups:"subgroups",primitive_index:"primitive-index"};function Mm(e){return new km(e)}var Wo,km=class{constructor(e){y(this,Wo,!0);y(this,"externalsToApply",[]);this.declaration=e}$uses(e){return this.externalsToApply.push(e),this}[(Wo=v,J)](e){let t={};for(let n of this.externalsToApply)da(t,n);let r=ks(e,t,this.declaration);return e.addDeclaration(r),M("",ft)}toString(){return`declare: ${this.declaration}`}};function Ru(e){let t={argTypes:e.in&&Object.keys(e.in).length!==0?[Aa(e.in)]:[],returnType:ft,workgroupSize:[e.workgroupSize[0]??1,e.workgroupSize[1]??1,e.workgroupSize[2]??1],isEntry:!0},r=(n,...a)=>_m(t,e.workgroupSize,_s(n,...a));return Object.assign(Object.assign(r,t),{does:r})}function _m(e,t,r){let n=Ca(r,`@compute @workgroup_size(${t.join(", ")}) `),a=e.argTypes[0];return{shell:e,$uses(s){return n.applyExternals(s),this},[v]:!0,[Ve]:n,$name(s){return Be(n,s),yi(a)&&a.$name(`${s}_Input`),this},[J](s){return n.resolve(s,e.argTypes,e.returnType)},toString(){return`computeFn:${C(n)??"<unnamed>"}`}}}function fe(e,t){let r={[v]:!0,argTypes:e,returnType:t??ft,isEntry:!1};return Object.assign((n,...a)=>Pm(r,_s(n,...a)),r)}function Cu(e){return wi(e)&&(e==null?void 0:e.resourceType)==="function"}function Bm([e,t]){return`${C(e)??"<unnamed>"}=${t}`}function Pm(e,t){let r=Ca(t,""),n={shell:e,resourceType:"function",$uses(i){return r.applyExternals(i),this},[Ve]:r,$name(i){return Be(r,i),this},with(i,o){return Au(s,[[Ms(i)?i.slot:i,o]])},[J](i){return typeof t=="string"&&(cf(t,e.argTypes,r.applyExternals),uu(t,e.returnType,r.applyExternals)),r.resolve(i,e.argTypes,e.returnType)}},a=Qe((...i)=>Vc(()=>{try{if(typeof t=="string")throw new Error("Cannot execute on the CPU functions constructed with raw WGSL");let o=i.map((u,c)=>Ks(e.argTypes[c],u)),l=t(...o);return Ks(e.returnType,l)}catch(o){throw o instanceof Ki?o.appendToTrace(s):new Ki(o,[s])}}),(...i)=>M(new Ou(s,i),e.returnType),"tgpuFnCall",e.argTypes),s=Object.assign(a,n);return s[v].implementation=t,Object.defineProperty(s,"toString",{value(){return`fn:${C(r)??"<unnamed>"}`}}),s}function Au(e,t){let r={resourceType:"function",shell:e.shell,[bn]:{inner:e,pairs:t},$uses(s){return e.$uses(s),this},[Ve]:e,$name(s){return e.$name(s),this},with(s,i){return Au(a,[...t,[Ms(s)?s.slot:s,i]])}},n=Qe((...s)=>e(...s),(...s)=>M(new Ou(a,s),e.shell.returnType),"tgpuFnCall",e.shell.argTypes),a=Object.assign(n,r);return a[v].implementation=e[v].implementation,Object.defineProperty(a,"toString",{value(){return`fn:${C(e)??"<unnamed>"}[${t.map(Bm).join(", ")}]`}}),a[v].implementation=e[v].implementation,a}var Yo,Zo,Xo,Dr,$a,Ho,Ou=(Ho=class{constructor(e,t){y(this,Xo,!0);y(this,Zo);y(this,Yo);W(this,Dr);W(this,$a);N(this,Dr,e),N(this,$a,t),this[Ve]=e,this[$t]=M(this,g(this,Dr).shell.returnType)}[(Xo=v,Zo=$t,Yo=Ve,J)](e){return e.withResetIndentLevel(()=>M($`${e.resolve(g(this,Dr)).value}(${g(this,$a)})`,g(this,Dr).shell.returnType))}toString(){return`call:${C(this)??"<unnamed>"}`}},Dr=new WeakMap,$a=new WeakMap,Ho);function zm(e){let t={in:e.in,out:e.out,returnType:Aa(e.out),isEntry:!0},r=(n,...a)=>Im(t,_s(n,...a));return Object.assign(Object.assign(r,t),{does:r})}function Im(e,t){let r=Ca(t,"@fragment "),n=e.returnType;return typeof t=="string"&&uu(t,n,a=>r.applyExternals(a)),{shell:e,outputType:n,$uses(a){return r.applyExternals(a),this},[v]:!0,[Ve]:r,$name(a){return Be(r,a),yi(n)&&n.$name(`${a}_Output`),this},[J](a){let s=e.in?Aa(e.in,a.varyingLocations).$name(`${C(this)??""}_Input`):void 0;return s&&r.applyExternals({In:s}),r.applyExternals({Out:n}),r.resolve(a,s?[s]:[],e.returnType)},toString(){return`fragmentFn:${C(r)??"<unnamed>"}`}}}var Lu=new Set(["alias","break","case","const","const_assert","continue","continuing","default","diagnostic","discard","else","enable","false","fn","for","if","let","loop","override","requires","return","struct","switch","true","var","while","NULL","Self","abstract","active","alignas","alignof","as","asm","asm_fragment","async","attribute","auto","await","become","cast","catch","class","co_await","co_return","co_yield","coherent","column_major","common","compile","compile_fragment","concept","const_cast","consteval","constexpr","constinit","crate","debugger","decltype","delete","demote","demote_to_helper","do","dynamic_cast","enum","explicit","export","extends","extern","external","fallthrough","filter","final","finally","friend","from","fxgroup","get","goto","groupshared","highp","impl","implements","import","inline","instanceof","interface","layout","lowp","macro","macro_rules","match","mediump","meta","mod","module","move","mut","mutable","namespace","new","nil","noexcept","noinline","nointerpolation","non_coherent","noncoherent","noperspective","null","nullptr","of","operator","package","packoffset","partition","pass","patch","pixelfragment","precise","precision","premerge","priv","protected","pub","public","readonly","ref","regardless","register","reinterpret_cast","require","resource","restrict","self","set","shared","sizeof","smooth","snorm","static","static_assert","static_cast","std","subroutine","super","target","template","this","thread_local","throw","trait","try","type","typedef","typeid","typename","typeof","union","unless","unorm","unsafe","unsized","use","using","varying","virtual","volatile","wgsl","where","with","writeonly","yield"]);function Fu(e){if(e==="_"||e.startsWith("__")||/\s/.test(e))throw new Error(`Invalid identifier '${e}'. Choose an identifier without whitespaces or leading underscores.`);let t=e.split("_")[0];return!Lu.has(t)}var Gu=class{makeValid(e){return Fu(e)?e:this.makeUnique(e)}},Um=class extends Gu{constructor(){super(...arguments);y(this,"lastUniqueId",0)}makeUnique(t){let r;return t?(r=t.replaceAll(/\s/g,"_"),r=r.replaceAll(/[^\w\d]/g,"")):r="item",`${r}_${this.lastUniqueId++}`}},Em=class extends Gu{constructor(){super(...arguments);y(this,"_usedNames",new Set(Lu))}makeUnique(t){if(t===void 0)throw new Error("Unnamed item found when using a strict name registry");let r=0,n=t;for(;this._usedNames.has(n);)r++,n=`${t}_${r}`;return this._usedNames.add(n),n}};function Rm(e,t){let r=Ca(t,"");return{[v]:!0,[Ve]:r,resourceType:"shellless-impl",[J](n){return r.resolve(n,e,void 0)},toString(){return`fn*:${C(r)??"<unnamed>"}`}}}var Cm=class{constructor(){y(this,"cache",new Map)}get(e,t){let r=Gl(e);if(!(r!=null&&r.ast))return;if(!t&&r.ast.params.length>0)throw new Error(`Cannot resolve '${C(e)}' directly, because it expects arguments. Either call it from another function, or wrap it in a shell`);let n=(t??[]).map(i=>ba(i.dataType)),a=this.cache.get(e);if(a){let i=a.find(o=>o.argTypes.every((l,u)=>l===n[u]));if(i)return i.value}else a=[],this.cache.set(e,a);let s=Rm(n,e);return a.push({argTypes:n,value:s}),s}},Ko,Am=(Ko=v,class{constructor(e){y(this,Ko);this[v]={nameRegistry:e,shelllessRepo:new Cm,memoizedResolves:new WeakMap,memoizedDerived:new WeakMap,listeners:{name:new Set}}}on(e,t){if(e==="name"){let r=this[v].listeners.name;return r.add(t),()=>r.delete(t)}throw new Error(`Unsupported event: ${e}`)}});function Om(e,t){let r=e.nameRegistry.makeUnique(C(t));for(let n of e.listeners.name)n({target:t,name:r});return r}function Da(e){let{names:t="random"}=e||{};return new Am(t==="strict"?new Em:new Um)}function Us(e){return typeof(e==null?void 0:e.format)=="string"}function Lm(e,t){let r=[];if(qn(e)){if(!Us(t))throw new Error("Shader expected a single attribute, not a record of attributes to be passed in.");return r.push(t._layout),{usedVertexLayouts:r,bufferDefinitions:[{arrayStride:t._layout.stride,stepMode:t._layout.stepMode,attributes:[{format:t.format,offset:t.offset,shaderLocation:Pr(e)??0}]}]}}let n=[],a=new WeakMap,s=0;for(let[i,o]of Object.entries(e)){if(Ua(o))continue;let l=t[i];if(!l)throw new Error(`An attribute by the name of '${i}' was not provided to the shader.`);let u=l._layout,c=a.get(u);c||(r.push(u),c=[],n.push({arrayStride:u.stride,stepMode:u.stepMode,attributes:c}),a.set(u,c)),s=Pr(o)??s,c.push({format:l.format,offset:l.offset,shaderLocation:s++})}return{usedVertexLayouts:r,bufferDefinitions:n}}var Fm=["bool","f32","f16","i32","u32","vec2f","vec3f","vec4f","vec2h","vec3h","vec4h","vec2i","vec3i","vec4i","vec2u","vec3u","vec4u","vec2<bool>","vec3<bool>","vec4<bool>","mat2x2f","mat3x3f","mat4x4f","texture_external"];function Gm(e){return Fm.includes(e.type)}function ai(e,[t,r]){if(!Fu(t))throw new Error(`Property key '${t}' is a reserved WGSL word. Choose a different name.`);return`  ${vi(r)}${t}: ${e.resolve(r).value},
`}function Dm(e,t){if(t[v].isAbstruct)throw new Error("Cannot resolve abstract struct types to WGSL.");let r=e.getUniqueName(t);return e.addDeclaration(`struct ${r} {
${Object.entries(t.propTypes).map(n=>ai(e,n)).join("")}}`),r}function Vm(e,t){let r=e.getUniqueName(t);return e.addDeclaration(`struct ${r} {
${Object.entries(t.propTypes).map(n=>Us(n[1])?ai(e,[n[0],xa[n[1].format]]):ai(e,n)).join("")}
}`),r}function jm(e,t){let r=e.resolve(t.elementType).value;return t.elementCount===0?`array<${r}>`:`array<${r}, ${t.elementCount}>`}function Nm(e,t){let r=e.resolve(Us(t.elementType)?xa[t.elementType.format]:t.elementType).value;return t.elementCount===0?`array<${r}>`:`array<${r}, ${t.elementCount}>`}function Du(e,t){if(gi(t))return t.type==="unstruct"?Vm(e,t):t.type==="disarray"?Nm(e,t):t.type==="loose-decorated"?e.resolve(Us(t.inner)?xa[t.inner.format]:t.inner).value:e.resolve(xa[t.type]).value;if(Gm(t))return t.type;if(t.type==="struct")return Dm(e,t);if(t.type==="array")return jm(e,t);if(t.type==="atomic")return`atomic<${Du(e,t.inner)}>`;if(t.type==="decorated")return e.resolve(t.inner).value;if(t.type==="ptr")return t.addressSpace==="storage"?`ptr<storage, ${e.resolve(t.inner).value}, ${t.access==="read-write"?"read_write":t.access}>`:`ptr<${t.addressSpace}, ${e.resolve(t.inner).value}>`;if(t.type==="abstractInt"||t.type==="abstractFloat"||t.type==="void"||t.type==="u16")throw new Error(`${t.type} has no representation in WGSL`);if(ni(t))return`${t.type}<${t.format}, ${Oa[t.access]}>`;if(sd(t))return t.type.startsWith("texture_depth")?t.type:`${t.type}<${t.sampleType.type}>`;if(Wf(t)||qf(t))return t.type;wa(t,"resolveData")}var Vu=class si{constructor(t){this.bindings=t}with(t,r){return new si([...this.bindings,[Ms(t)?t.slot:t,r]])}pipe(t){let r=t(this);return new si([...this.bindings,...r.bindings])}};function*qm(e){let t=0;for(;;)e.has(t)||(yield t),t++}function Wm(e,t){let r="size"in e?e.size:e.currentByteOffset,n=t-1,a=r&n;"skipBytes"in e?e.skipBytes(t-a&n):e.add(t-a&n)}var De=Wm,go=new WeakMap;function ju(e){let t=go.get(e);if(t)return t;let r=new _e,n={},a;for(let s in e.propTypes){let i=e.propTypes[s];if(i===void 0)throw new Error(`Property ${s} is undefined in struct`);let o=r.size;De(r,Ea(e)?Qr(i):ht(i)),a&&(a.padding=r.size-o);let l=ve(i);n[s]={offset:r.size,size:l},a=n[s],r.add(l)}return a&&(a.padding=_r(ve(e),ht(e))-r.size),go.set(e,n),n}var Ym=(()=>{try{return new Function("return true"),!0}catch{return!1}})(),Vs=new WeakMap,Xa={u32:"u32",vec2u:"u32",vec3u:"u32",vec4u:"u32",u16:"u16",i32:"i32",vec2i:"i32",vec3i:"i32",vec4i:"i32",f32:"f32",vec2f:"f32",vec3f:"f32",vec4f:"f32",f16:"f16",vec2h:"f16",vec3h:"f16",vec4h:"f16",mat2x2f:"f32",mat3x3f:"f32",mat4x4f:"f32"},Zm={uint8:"u8",uint8x2:"u8",uint8x4:"u8",sint8:"i8",sint8x2:"i8",sint8x4:"i8",unorm8:"u8",unorm8x2:"u8",unorm8x4:"u8",snorm8:"i8",snorm8x2:"i8",snorm8x4:"i8",uint16:"u16",uint16x2:"u16",uint16x4:"u16",sint16:"i16",sint16x2:"i16",sint16x4:"i16",unorm16:"u16",unorm16x2:"u16",unorm16x4:"u16",snorm16:"i16",snorm16x2:"i16",snorm16x4:"i16",float16:"f16",float16x2:"f16",float16x4:"f16",float32:"f32",float32x2:"f32",float32x3:"f32",float32x4:"f32",uint32:"u32",uint32x2:"u32",uint32x3:"u32",uint32x4:"u32",sint32:"i32",sint32x2:"i32",sint32x3:"i32",sint32x4:"i32"},Ha={u32:"setUint32",i32:"setInt32",f32:"setFloat32",u16:"setUint16",i16:"setInt16",f16:"setFloat16",u8:"setUint8",i8:"setInt8"},Xm={unorm8:e=>`Math.round(${e} * 255)`,unorm8x2:e=>`Math.round(${e} * 255)`,unorm8x4:e=>`Math.round(${e} * 255)`,snorm8:e=>`Math.round(${e} * 127)`,snorm8x2:e=>`Math.round(${e} * 127)`,snorm8x4:e=>`Math.round(${e} * 127)`,unorm16:e=>`Math.round(${e} * 65535)`,unorm16x2:e=>`Math.round(${e} * 65535)`,unorm16x4:e=>`Math.round(${e} * 65535)`,snorm16:e=>`Math.round(${e} * 32767)`,snorm16x2:e=>`Math.round(${e} * 32767)`,snorm16x4:e=>`Math.round(${e} * 32767)`},vo={"unorm10-10-10-2":{writeFunction:"setUint32",generator:(e,t)=>`output.setUint32(${e}, ((${t}.x*1023&0x3FF)<<22)|((${t}.y*1023&0x3FF)<<12)|((${t}.z*1023&0x3FF)<<2)|(${t}.w*3&3), littleEndian);
`},"unorm8x4-bgra":{writeFunction:"setUint8",generator:(e,t)=>{let r=["z","y","x","w"],n="";for(let a=0;a<4;a++)n+=`output.setUint8((${e} + ${a}), Math.round(${t}.${r[a]} * 255), littleEndian);
`;return n}}};function ns(e,t,r,n=0){let a=["i","j","k"][n]||`i${n}`;if(Yc(e)||Nl(e))return ns(e.inner,t,r,n);if(Tt(e)||Ea(e)){let i=ju(e),o="";for(let[l,u]of Object.entries(i)){let c=e.propTypes[l];c&&(o+=ns(c,`(${t} + ${u.offset})`,`${r}.${l}`,n))}return o}if(fr(e)||xi(e)){let i=_r(ve(e.elementType),ht(e)),o="";return o+=`for (let ${a} = 0; ${a} < ${e.elementCount}; ${a}++) {
`,o+=ns(e.elementType,`(${t} + ${a} * ${i})`,`${r}[${a}]`,n+1),o+=`}
`,o}if(Wn(e)){let i=Xa[e.type],o="",l=Ha[i],u=["x","y","z","w"],c=Qi(e)?2:Ji(e)?3:4;for(let p=0;p<c;p++)o+=`output.${l}((${t} + ${p*4}), ${r}.${u[p]}, littleEndian);
`;return o}if(Xs(e)){let i=Xa[e.type],o=Ha[i],l=Zc(e)?2:Xc(e)?3:4,u=l*l,c=_r(l*4,8),p="";for(let d=0;d<u;d++){let h=Math.floor(d/l),f=d%l,m=h*c+f*4;p+=`output.${o}((${t} + ${m}), ${r}.columns[${h}].${["x","y","z","w"][f]}, littleEndian);
`}return p}if(Hc(e)){let i=e.type;if(i in vo)return vo[i].generator(t,r);let o=Zm[i],l=Ha[o],u=xa[i],c=Kc(u)?4:Ji(u)?3:Qi(u)?2:1,p=o==="u8"||o==="i8"?1:o==="u16"||o==="i16"||o==="f16"?2:4,d=["x","y","z","w"],h=Xm[i],f="";for(let m=0;m<c;m++){let T=c===1?r:`${r}.${d[m]}`,_=h?h(T):T;f+=`output.${l}((${t} + ${m*p}), ${_}, littleEndian);
`}return f}if(!Object.hasOwn(Xa,e.type))throw new Error(`Primitive ${e.type} is unsupported by compiled writer`);let s=Xa[e.type];return`output.${Ha[s]}(${t}, ${r}, littleEndian);
`}function wo(e){if(!Ym){console.warn("This environment does not allow eval - using default writer as fallback");return}if(Vs.has(e))return Vs.get(e);try{let t=ns(e,"offset","value",0),r=new Function("output","offset","value","littleEndian=true",t);return Vs.set(e,r),r}catch(t){console.warn(`Failed to compile writer for schema: ${e}
Reason: ${t instanceof Error?t.message:String(t)}
Falling back to default writer`)}}var ut={bool(){throw new Error("Booleans are not host-shareable")},f32(e,t,r){e.writeFloat32(r)},f16(e,t,r){e.writeFloat16(r)},i32(e,t,r){e.writeInt32(r)},u32(e,t,r){e.writeUint32(r)},u16(e,t,r){e.writeUint16(r)},vec2f(e,t,r){e.writeFloat32(r.x),e.writeFloat32(r.y)},vec2h(e,t,r){e.writeFloat16(r.x),e.writeFloat16(r.y)},vec2i(e,t,r){e.writeInt32(r.x),e.writeInt32(r.y)},vec2u(e,t,r){e.writeUint32(r.x),e.writeUint32(r.y)},"vec2<bool>"(){throw new Error("Booleans are not host-shareable")},vec3f(e,t,r){e.writeFloat32(r.x),e.writeFloat32(r.y),e.writeFloat32(r.z)},vec3h(e,t,r){e.writeFloat16(r.x),e.writeFloat16(r.y),e.writeFloat16(r.z)},vec3i(e,t,r){e.writeInt32(r.x),e.writeInt32(r.y),e.writeInt32(r.z)},vec3u(e,t,r){e.writeUint32(r.x),e.writeUint32(r.y),e.writeUint32(r.z)},"vec3<bool>"(){throw new Error("Booleans are not host-shareable")},vec4f(e,t,r){e.writeFloat32(r.x),e.writeFloat32(r.y),e.writeFloat32(r.z),e.writeFloat32(r.w)},vec4h(e,t,r){e.writeFloat16(r.x),e.writeFloat16(r.y),e.writeFloat16(r.z),e.writeFloat16(r.w)},vec4i(e,t,r){e.writeInt32(r.x),e.writeInt32(r.y),e.writeInt32(r.z),e.writeInt32(r.w)},vec4u(e,t,r){e.writeUint32(r.x),e.writeUint32(r.y),e.writeUint32(r.z),e.writeUint32(r.w)},"vec4<bool>"(){throw new Error("Booleans are not host-shareable")},mat2x2f(e,t,r){for(let n=0;n<r.length;++n)e.writeFloat32(r[n])},mat3x3f(e,t,r){for(let n=0;n<r.length;++n)e.writeFloat32(r[n])},mat4x4f(e,t,r){for(let n=0;n<r.length;++n)e.writeFloat32(r[n])},struct(e,t,r){let n=ht(t);De(e,n);for(let[a,s]of Object.entries(t.propTypes))De(e,ht(s)),ms(e,s,r[a]);De(e,n)},array(e,t,r){if(t.elementCount===0)throw new Error("Cannot write using a runtime-sized schema.");let n=ht(t);De(e,n);let a=e.currentByteOffset;for(let s=0;s<Math.min(t.elementCount,r.length);s++)De(e,n),ms(e,t.elementType,r[s]);e.seekTo(a+ve(t))},ptr(){throw new Error("Pointers are not host-shareable")},atomic(e,t,r){var n;(n=ut[t.inner.type])==null||n.call(ut,e,t,r)},decorated(e,t,r){var s,i;let n=Qr(t);De(e,n);let a=e.currentByteOffset;(i=ut[(s=t.inner)==null?void 0:s.type])==null||i.call(ut,e,t.inner,r),e.seekTo(a+ve(t))},uint8(e,t,r){e.writeUint8(r)},uint8x2(e,t,r){e.writeUint8(r.x),e.writeUint8(r.y)},uint8x4(e,t,r){e.writeUint8(r.x),e.writeUint8(r.y),e.writeUint8(r.z),e.writeUint8(r.w)},sint8(e,t,r){e.writeInt8(r)},sint8x2(e,t,r){e.writeInt8(r.x),e.writeInt8(r.y)},sint8x4(e,t,r){e.writeInt8(r.x),e.writeInt8(r.y),e.writeInt8(r.z),e.writeInt8(r.w)},unorm8(e,t,r){e.writeUint8(Math.round(r*255))},unorm8x2(e,t,r){e.writeUint8(Math.round(r.x*255)),e.writeUint8(Math.round(r.y*255))},unorm8x4(e,t,r){e.writeUint8(Math.round(r.x*255)),e.writeUint8(Math.round(r.y*255)),e.writeUint8(Math.round(r.z*255)),e.writeUint8(Math.round(r.w*255))},snorm8(e,t,r){e.writeInt8(Math.round(r*127))},snorm8x2(e,t,r){e.writeInt8(Math.round(r.x*127)),e.writeInt8(Math.round(r.y*127))},snorm8x4(e,t,r){e.writeInt8(Math.round(r.x*127)),e.writeInt8(Math.round(r.y*127)),e.writeInt8(Math.round(r.z*127)),e.writeInt8(Math.round(r.w*127))},uint16(e,t,r){e.writeUint16(r)},uint16x2(e,t,r){e.writeUint16(r.x),e.writeUint16(r.y)},uint16x4(e,t,r){e.writeUint16(r.x),e.writeUint16(r.y),e.writeUint16(r.z),e.writeUint16(r.w)},sint16(e,t,r){e.writeInt16(r)},sint16x2(e,t,r){e.writeInt16(r.x),e.writeInt16(r.y)},sint16x4(e,t,r){e.writeInt16(r.x),e.writeInt16(r.y),e.writeInt16(r.z),e.writeInt16(r.w)},unorm16(e,t,r){e.writeUint16(r*65535)},unorm16x2(e,t,r){e.writeUint16(r.x*65535),e.writeUint16(r.y*65535)},unorm16x4(e,t,r){e.writeUint16(r.x*65535),e.writeUint16(r.y*65535),e.writeUint16(r.z*65535),e.writeUint16(r.w*65535)},snorm16(e,t,r){e.writeInt16(Math.round(r*32767))},snorm16x2(e,t,r){e.writeInt16(Math.round(r.x*32767)),e.writeInt16(Math.round(r.y*32767))},snorm16x4(e,t,r){e.writeInt16(Math.round(r.x*32767)),e.writeInt16(Math.round(r.y*32767)),e.writeInt16(Math.round(r.z*32767)),e.writeInt16(Math.round(r.w*32767))},float16(e,t,r){e.writeFloat16(r)},float16x2(e,t,r){e.writeFloat16(r.x),e.writeFloat16(r.y)},float16x4(e,t,r){e.writeFloat16(r.x),e.writeFloat16(r.y),e.writeFloat16(r.z),e.writeFloat16(r.w)},float32(e,t,r){e.writeFloat32(r)},float32x2(e,t,r){e.writeFloat32(r.x),e.writeFloat32(r.y)},float32x3(e,t,r){e.writeFloat32(r.x),e.writeFloat32(r.y),e.writeFloat32(r.z)},float32x4(e,t,r){e.writeFloat32(r.x),e.writeFloat32(r.y),e.writeFloat32(r.z),e.writeFloat32(r.w)},uint32(e,t,r){e.writeUint32(r)},uint32x2(e,t,r){e.writeUint32(r.x),e.writeUint32(r.y)},uint32x3(e,t,r){e.writeUint32(r.x),e.writeUint32(r.y),e.writeUint32(r.z)},uint32x4(e,t,r){e.writeUint32(r.x),e.writeUint32(r.y),e.writeUint32(r.z),e.writeUint32(r.w)},sint32(e,t,r){e.writeInt32(r)},sint32x2(e,t,r){e.writeInt32(r.x),e.writeInt32(r.y)},sint32x3(e,t,r){e.writeInt32(r.x),e.writeInt32(r.y),e.writeInt32(r.z)},sint32x4(e,t,r){e.writeInt32(r.x),e.writeInt32(r.y),e.writeInt32(r.z),e.writeInt32(r.w)},"unorm10-10-10-2"(e,t,r){let n=0;n|=(r.x*1023&1023)<<22,n|=(r.y*1023&1023)<<12,n|=(r.z*1023&1023)<<2,n|=r.w*3&3,e.writeUint32(n)},"unorm8x4-bgra"(e,t,r){e.writeUint8(r.z*255),e.writeUint8(r.y*255),e.writeUint8(r.x*255),e.writeUint8(r.w*255)},disarray(e,t,r){var s,i;let n=ht(t);De(e,n);let a=e.currentByteOffset;for(let o=0;o<Math.min(t.elementCount,r.length);o++)De(e,n),(i=ut[(s=t.elementType)==null?void 0:s.type])==null||i.call(ut,e,t.elementType,r[o]);e.seekTo(a+ve(t))},unstruct(e,t,r){var a;let n=t.propTypes;for(let[s,i]of Object.entries(n))(a=ut[i.type])==null||a.call(ut,e,i,r[s])},"loose-decorated"(e,t,r){var i;let n=Qr(t);De(e,n);let a=e.currentByteOffset,s=ut[(i=t.inner)==null?void 0:i.type];return s==null||s(e,t.inner,r),e.seekTo(a+ve(t)),r}};function ms(e,t,r){let n=ut[t.type];if(!n)throw new Error(`Cannot write data of type '${t.type}'.`);n(e,t,r)}var Hm={bool(){throw new Error("Booleans are not host-shareable")},f32(e){return e.readFloat32()},f16(e){return e.readFloat16()},i32(e){return e.readInt32()},u32(e){return e.readUint32()},u16(e){return e.readUint16()},vec2f(e){return ke(e.readFloat32(),e.readFloat32())},vec3f(e){return Ke(e.readFloat32(),e.readFloat32(),e.readFloat32())},vec4f(e){return S(e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32())},vec2h(e){return yr(e.readFloat16(),e.readFloat16())},vec3h(e){return mr(e.readFloat16(),e.readFloat16(),e.readFloat16())},vec4h(e){return hr(e.readFloat16(),e.readFloat16(),e.readFloat16(),e.readFloat16())},vec2i(e){return bt(e.readInt32(),e.readInt32())},vec3i(e){return Gt(e.readInt32(),e.readInt32(),e.readInt32())},vec4i(e){return ze(e.readInt32(),e.readInt32(),e.readInt32(),e.readInt32())},vec2u(e){return cr(e.readUint32(),e.readUint32())},vec3u(e){return dt(e.readUint32(),e.readUint32(),e.readUint32())},vec4u(e){return Ae(e.readUint32(),e.readUint32(),e.readUint32(),e.readUint32())},"vec2<bool>"(){throw new Error("Booleans are not host-shareable")},"vec3<bool>"(){throw new Error("Booleans are not host-shareable")},"vec4<bool>"(){throw new Error("Booleans are not host-shareable")},mat2x2f(e){return tr(e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32())},mat3x3f(e){let t=()=>{let r=e.readFloat32();return e.readFloat32(),r};return rr(e.readFloat32(),e.readFloat32(),t(),e.readFloat32(),e.readFloat32(),t(),e.readFloat32(),e.readFloat32(),t())},mat4x4f(e){return Oe(e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32())},struct(e,t){let r=ht(t);De(e,r);let n={},a=t.propTypes;for(let[s,i]of Object.entries(a))De(e,ht(i)),n[s]=Qt(e,i);return De(e,r),n},array(e,t){if(t.elementCount===0)throw new Error("Cannot read using a runtime-sized schema.");let r=ht(t),n=[];for(let a=0;a<t.elementCount;a++){De(e,r);let s=t.elementType,i=Qt(e,s);n.push(i)}return De(e,r),n},ptr(){throw new Error("Pointers are not host-shareable")},atomic(e,t){return Qt(e,t.inner)},decorated(e,t){let r=Qr(t);De(e,r);let n=e.currentByteOffset,a=Qt(e,t.inner);return e.seekTo(n+ve(t)),a},uint8:e=>e.readUint8(),uint8x2:e=>cr(e.readUint8(),e.readUint8()),uint8x4:e=>Ae(e.readUint8(),e.readUint8(),e.readUint8(),e.readUint8()),sint8:e=>e.readInt8(),sint8x2:e=>bt(e.readInt8(),e.readInt8()),sint8x4:e=>ze(e.readInt8(),e.readInt8(),e.readInt8(),e.readInt8()),unorm8:e=>e.readUint8()/255,unorm8x2:e=>ke(e.readUint8()/255,e.readUint8()/255),unorm8x4:e=>S(e.readUint8()/255,e.readUint8()/255,e.readUint8()/255,e.readUint8()/255),snorm8:e=>e.readInt8()/127,snorm8x2:e=>ke(e.readInt8()/127,e.readInt8()/127),snorm8x4:e=>S(e.readInt8()/127,e.readInt8()/127,e.readInt8()/127,e.readInt8()/127),uint16:e=>e.readUint16(),uint16x2:e=>cr(e.readUint16(),e.readUint16()),uint16x4:e=>Ae(e.readUint16(),e.readUint16(),e.readUint16(),e.readUint16()),sint16:e=>e.readInt16(),sint16x2:e=>bt(e.readInt16(),e.readInt16()),sint16x4:e=>ze(e.readInt16(),e.readInt16(),e.readInt16(),e.readInt16()),unorm16:e=>e.readUint16()/65535,unorm16x2:e=>ke(e.readUint16()/65535,e.readUint16()/65535),unorm16x4:e=>S(e.readUint16()/65535,e.readUint16()/65535,e.readUint16()/65535,e.readUint16()/65535),snorm16:e=>e.readInt16()/32767,snorm16x2:e=>ke(e.readInt16()/32767,e.readInt16()/32767),snorm16x4:e=>S(e.readInt16()/32767,e.readInt16()/32767,e.readInt16()/32767,e.readInt16()/32767),float16(e){return e.readFloat16()},float16x2:e=>ke(e.readFloat16(),e.readFloat16()),float16x4:e=>S(e.readFloat16(),e.readFloat16(),e.readFloat16(),e.readFloat16()),float32:e=>e.readFloat32(),float32x2:e=>ke(e.readFloat32(),e.readFloat32()),float32x3:e=>Ke(e.readFloat32(),e.readFloat32(),e.readFloat32()),float32x4:e=>S(e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32()),uint32:e=>e.readUint32(),uint32x2:e=>cr(e.readUint32(),e.readUint32()),uint32x3:e=>dt(e.readUint32(),e.readUint32(),e.readUint32()),uint32x4:e=>Ae(e.readUint32(),e.readUint32(),e.readUint32(),e.readUint32()),sint32:e=>e.readInt32(),sint32x2:e=>bt(e.readInt32(),e.readInt32()),sint32x3:e=>Gt(e.readInt32(),e.readInt32(),e.readInt32()),sint32x4:e=>ze(e.readInt32(),e.readInt32(),e.readInt32(),e.readInt32()),"unorm10-10-10-2"(e){let t=e.readUint32(),r=(t>>22)/1023,n=(t>>12&1023)/1023,a=(t>>2&1023)/1023,s=(t&3)/3;return S(r,n,a,s)},"unorm8x4-bgra"(e){let t=e.readByte()/255,r=e.readByte()/255,n=e.readByte()/255,a=e.readByte()/255;return S(n,r,t,a)},unstruct(e,t){let r={},n=t.propTypes;for(let[a,s]of Object.entries(n))r[a]=Qt(e,s);return r},disarray(e,t){let r=ht(t),n=[];for(let a=0;a<t.elementCount;a++)De(e,r),n.push(Qt(e,t.elementType));return De(e,r),n},"loose-decorated"(e,t){De(e,Qr(t));let r=e.currentByteOffset,n=Qt(e,t.inner);return e.seekTo(r+ve(t)),n}};function Qt(e,t){let r=Hm[t.type];if(!r)throw new Error(`Cannot read data of type '${t.type}'.`);return r(e,t)}function Km(e,t){let r=ve(e);if(r===0||t===void 0||t===null)return[];let n=new ArrayBuffer(r),a=new en(n),s=[];function i(u,c,p,d){if(c!=null){if(Tt(u)||Ea(u)){let h=ju(u);for(let[f,m]of Object.entries(h)){let T=u.propTypes[f];if(!T)continue;let _=c[f];_!==void 0&&i(T,_,p+m.offset,m.padding??d)}return}if(fr(u)||xi(u)){let h=u,f=_r(ve(h.elementType),ht(h.elementType));if(!Array.isArray(c))throw new Error("Partial value for array must be an array");let m=c??[];m.sort((T,_)=>T.idx-_.idx);for(let{idx:T,value:_}of m)i(h.elementType,_,p+T*f,f-ve(h.elementType))}else{let h=ve(u);a.seekTo(p),ms(a,u,c),s.push({start:p,end:p+h,padding:d})}}}if(i(e,t,0),s.length===0)return[];let o=[],l=s[0];for(let u=1;u<s.length;u++){let c=s[u];if(!c||!l)throw new Error("Internal error: missing segment");c.start===l.end+(l.padding??0)?(l.end=c.end,l.padding=c.padding):(o.push({data:new Uint8Array(n,l.start,l.end-l.start)}),l=c)}if(!l)throw new Error("Internal error: missing segment");return o.push({data:new Uint8Array(n,l.start,l.end-l.start)}),o}function ys(e){return!!(e!=null&&e.usableAsStorage)}var xo=class Nu extends Error{constructor(t){super(`Resource '${C(t)??"<unnamed>"}' cannot be bound as 'storage'. Use .$usage('storage') to allow it.`),Object.setPrototypeOf(this,Nu.prototype)}};function qu(e){return!!e.usableAsUniform}var Wu={uniform:"uniform",mutable:"storage, read_write",readonly:"storage, read"},Qo,Jo,Ci=class{constructor(e,t){y(this,"resourceType","buffer-usage");y(this,Jo);y(this,Qo);this.usage=e,this.buffer=t,this[v]={dataType:t.dataType},this[Ve]=t}$name(e){return this.buffer.$name(e),this}[(Jo=v,Qo=Ve,J)](e){let t=this.buffer.dataType,r=e.getUniqueName(this),{group:n,binding:a}=e.allocateFixedEntry(this.usage==="uniform"?{uniform:t}:{storage:t,access:this.usage},this.buffer),s=Wu[this.usage];return e.addDeclaration(`@group(${n}) @binding(${a}) var<${s}> ${r}: ${e.resolve(t).value};`),M(r,t)}toString(){return`${this.usage}:${C(this)??"<unnamed>"}`}get[he](){let e=this.buffer.dataType;return new Proxy({[v]:!0,get[$t](){return M(this,e)},[J]:t=>t.resolve(this),toString:()=>`${this.usage}:${C(this)??"<unnamed>"}.$`},jt)}get $(){let e=cs(),t=ps();if(e.type==="normal")throw new eo(t?`Cannot access ${String(this.buffer)}. TypeGPU functions that depends on GPU resources need to be part of a compute dispatch, draw call or simulation`:".$ and .value are inaccessible during normal JS execution. Try `.read()`");return e.type==="codegen"?this[he]:e.type==="simulate"?(e.buffers.has(this.buffer)||e.buffers.set(this.buffer,Ks(this.buffer.dataType,this.buffer.initial)),e.buffers.get(this.buffer)):wa(e,"bufferUsage.ts#TgpuFixedBufferImpl/$")}get value(){return this.$}set $(e){let t=cs(),r=ps();if(t.type==="normal")throw new eo(r?`Cannot access ${String(this.buffer)}. TypeGPU functions that depends on GPU resources need to be part of a compute dispatch, draw call or simulation`:".$ and .value are inaccessible during normal JS execution. Try `.write()`");if(t.type==="codegen")throw new Error("Unreachable bufferUsage.ts#TgpuFixedBufferImpl/$");if(t.type==="simulate"){t.buffers.set(this.buffer,e);return}wa(t,"bufferUsage.ts#TgpuFixedBufferImpl/$")}set value(e){this.$=e}},el,zn,tl,bo=(tl=class{constructor(e,t,r){y(this,el);y(this,"resourceType","buffer-usage");W(this,zn);this.usage=e,this.dataType=t,this[v]={dataType:t},N(this,zn,r),Be(this,r.key)}[(el=v,J)](e){let t=this.dataType,r=e.getUniqueName(this),n=e.allocateLayoutEntry(g(this,zn).layout),a=Wu[this.usage];return e.addDeclaration(`@group(${n}) @binding(${g(this,zn).idx}) var<${a}> ${r}: ${e.resolve(t).value};`),M(r,t)}toString(){return`${this.usage}:${C(this)??"<unnamed>"}`}get[he](){let e=this.dataType;return new Proxy({[v]:!0,get[$t](){return M(this,e)},[J]:t=>t.resolve(this),toString:()=>`${this.usage}:${C(this)??"<unnamed>"}.$`},jt)}get $(){if(Ir())return this[he];throw new Error("Direct access to buffer values is possible only as part of a compute dispatch or draw call. Try .read() or .write() instead")}get value(){return this.$}},zn=new WeakMap,tl),To=new WeakMap;function Qm(e){if(!ys(e))throw new Error(`Cannot pass ${e} to asMutable, as it is not allowed to be used as storage. To allow it, call .$usage('storage') when creating the buffer.`);let t=To.get(e);return t||(t=new Ci("mutable",e),To.set(e,t)),t}var $o=new WeakMap;function Jm(e){if(!ys(e))throw new Error(`Cannot pass ${e} to asReadonly, as it is not allowed to be used as storage. To allow it, call .$usage('storage') when creating the buffer.`);let t=$o.get(e);return t||(t=new Ci("readonly",e),$o.set(e,t)),t}var So=new WeakMap;function ey(e){if(!qu(e))throw new Error(`Cannot pass ${e} to asUniform, as it is not allowed to be used as a uniform. To allow it, call .$usage('uniform') when creating the buffer.`);let t=So.get(e);return t||(t=new Ci("uniform",e),So.set(e,t)),t}var js={uniform:ey,mutable:Qm,readonly:Jm};function Ka(e,t,r){return $s(t)?new Mo(e,t,r):new Mo(e,t,r,["storage","uniform"])}function va(e){return e.resourceType==="buffer"}var ty=Bu(),rl,ct,nl,Mo=(rl=v,nl=class{constructor(e,t,r,n){y(this,rl,!0);y(this,"resourceType","buffer");y(this,"flags",GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC);W(this,ct);y(this,"_buffer",null);y(this,"_ownBuffer");y(this,"_destroyed",!1);y(this,"_hostBuffer");y(this,"initial");y(this,"usableAsUniform",!1);y(this,"usableAsStorage",!1);y(this,"usableAsVertex",!1);y(this,"usableAsIndex",!1);this.dataType=t,this.initialOrBuffer=r,this._disallowedUsages=n,N(this,ct,e.device),Qs(r)?(this._ownBuffer=!1,this._buffer=r):(this._ownBuffer=!0,this.initial=r)}get buffer(){if(this._destroyed)throw new Error("This buffer has been destroyed");return this._buffer||(this._buffer=g(this,ct).createBuffer({size:ve(this.dataType),usage:this.flags,mappedAtCreation:!!this.initial,label:C(this)??"<unnamed>"}),this.initial&&(this._writeToTarget(this._buffer.getMappedRange(),this.initial),this._buffer.unmap())),this._buffer}get destroyed(){return this._destroyed}$name(e){return Be(this,e),this._buffer&&(this._buffer.label=e),this}$usage(...e){var t;for(let r of e){if((t=this._disallowedUsages)!=null&&t.includes(r))throw new Error(`Buffer of type ${this.dataType.type} cannot be used as ${r}`);this.flags|=r==="uniform"?GPUBufferUsage.UNIFORM:0,this.flags|=r==="storage"?GPUBufferUsage.STORAGE:0,this.flags|=r==="vertex"?GPUBufferUsage.VERTEX:0,this.flags|=r==="index"?GPUBufferUsage.INDEX:0,this.usableAsUniform=this.usableAsUniform||r==="uniform",this.usableAsStorage=this.usableAsStorage||r==="storage",this.usableAsVertex=this.usableAsVertex||r==="vertex",this.usableAsIndex=this.usableAsIndex||r==="index"}return this}$addFlags(e){if(!this._ownBuffer)throw new Error("Cannot add flags to a buffer that is not managed by TypeGPU.");return e&GPUBufferUsage.MAP_READ?(this.flags=GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ,this):e&GPUBufferUsage.MAP_WRITE?(this.flags=GPUBufferUsage.COPY_SRC|GPUBufferUsage.MAP_WRITE,this):(this.flags|=e,this)}compileWriter(){wo(this.dataType)}_writeToTarget(e,t){let r=wo(this.dataType);if(r)try{r(new DataView(e),0,t,ty==="little");return}catch(n){console.error(`Error when using compiled writer for buffer ${C(this)??"<unnamed>"} - this is likely a bug, please submit an issue at https://github.com/software-mansion/TypeGPU/issues
Using fallback writer instead.`,n)}ms(new en(e),this.dataType,t)}write(e){let t=this.buffer;if(t.mapState==="mapped"){let n=t.getMappedRange();this._writeToTarget(n,e);return}let r=ve(this.dataType);this._hostBuffer||(this._hostBuffer=new ArrayBuffer(r)),this._writeToTarget(this._hostBuffer,e),g(this,ct).queue.writeBuffer(t,0,this._hostBuffer,0,r)}writePartial(e){let t=this.buffer,r=Km(this.dataType,e);if(t.mapState==="mapped"){let n=t.getMappedRange(),a=new Uint8Array(n);for(let s of r)a.set(s.data,s.data.byteOffset)}else for(let n of r)g(this,ct).queue.writeBuffer(t,n.data.byteOffset,n.data,0,n.data.byteLength)}clear(){let e=this.buffer;if(e.mapState==="mapped"){new Uint8Array(e.getMappedRange()).fill(0);return}let t=g(this,ct).createCommandEncoder();t.clearBuffer(e),g(this,ct).queue.submit([t.finish()])}copyFrom(e){if(this.buffer.mapState==="mapped")throw new Error("Cannot copy to a mapped buffer.");let t=ve(this.dataType),r=g(this,ct).createCommandEncoder();r.copyBufferToBuffer(e.buffer,0,this.buffer,0,t),g(this,ct).queue.submit([r.finish()])}async read(){let e=this.buffer;if(e.mapState==="mapped"){let a=e.getMappedRange();return Qt(new Br(a),this.dataType)}if(e.usage&GPUBufferUsage.MAP_READ){await e.mapAsync(GPUMapMode.READ);let a=e.getMappedRange(),s=Qt(new Br(a),this.dataType);return e.unmap(),s}let t=(globalThis.__TYPEGPU_AUTONAME__??(a=>a))(g(this,ct).createBuffer({size:ve(this.dataType),usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),"r"),r=g(this,ct).createCommandEncoder();r.copyBufferToBuffer(e,0,t,0,ve(this.dataType)),g(this,ct).queue.submit([r.finish()]),await t.mapAsync(GPUMapMode.READ,0,ve(this.dataType));let n=Qt(new Br(t.getMappedRange()),this.dataType);return t.unmap(),t.destroy(),n}as(e){var t;return(t=js[e])==null?void 0:t.call(js,this)}destroy(){var e;this._destroyed||(this._destroyed=!0,this._ownBuffer&&((e=this._buffer)==null||e.destroy()))}toString(){return`buffer:${C(this)??"<unnamed>"}`}},ct=new WeakMap,nl);function ry(e,t){return new Xu(fu(),e,t)}function ny(e,t){return new Xu(du(),e,t)}function Yu(e){let t=e;return(t==null?void 0:t.resourceType)==="sampler"&&!!t[v]}function Zu(e){let t=e;return(t==null?void 0:t.resourceType)==="sampler-comparison"&&!!t[v]}var al,In,sl,ay=(sl=class{constructor(e,t){y(this,al,{unwrap:void 0});y(this,"resourceType");W(this,In);this.schema=e,N(this,In,t),this.resourceType=e.type==="sampler_comparison"?"sampler-comparison":"sampler",Be(this,t.key)}[(al=v,J)](e){let t=e.getUniqueName(this),r=e.allocateLayoutEntry(g(this,In).layout);return e.addDeclaration(`@group(${r}) @binding(${g(this,In).idx}) var ${t}: ${e.resolve(this.schema).value};`),M(t,this.schema)}get[he](){let e=this.schema;return new Proxy({[v]:!0,get[$t](){return M(this,e)},[J]:t=>t.resolve(this),toString:()=>`${this.toString()}.$`},jt)}get $(){if(Ir())return this[he];throw new Error("Direct access to sampler values is possible only as part of a compute dispatch or draw call.")}get value(){return this.$}toString(){return`${this.resourceType}:${C(this)??"<unnamed>"}`}},In=new WeakMap,sl),il,Sa,Un,Ma,ka,ol,Xu=(ol=class{constructor(e,t,r){y(this,il);y(this,"resourceType");W(this,Sa);W(this,Un,null);W(this,Ma);W(this,ka);this.schema=e,N(this,Ma,t),N(this,ka,r),this.resourceType=e.type==="sampler_comparison"?"sampler-comparison":"sampler",this[v]={unwrap:()=>(g(this,Un)||N(this,Un,g(this,ka).device.createSampler({...g(this,Ma),label:C(this)??"<unnamed>"})),g(this,Un))},N(this,Sa,t.minFilter==="linear"||t.magFilter==="linear"||t.mipmapFilter==="linear")}[(il=v,J)](e){let t=e.getUniqueName(this),{group:r,binding:n}=e.allocateFixedEntry(this.schema.type==="sampler_comparison"?{sampler:"comparison"}:{sampler:g(this,Sa)?"filtering":"non-filtering"},this);return e.addDeclaration(`@group(${r}) @binding(${n}) var ${t}: ${e.resolve(this.schema).value};`),M(t,this.schema)}get[he](){let e=this.schema;return new Proxy({[v]:!0,get[$t](){return M(this,e)},[J]:t=>t.resolve(this),toString:()=>`${this.toString()}.$`},jt)}get $(){if(Ir())return this[he];throw new Error("Direct access to sampler values is possible only as part of a compute dispatch or draw call.")}get value(){return this.$}$name(e){return Be(this,e),this}toString(){return`${this.resourceType}:${C(this)??"<unnamed>"}`}},Sa=new WeakMap,Un=new WeakMap,Ma=new WeakMap,ka=new WeakMap,ol),ll,En,ul,sy=(ul=class{constructor(e,t){y(this,"resourceType","external-texture");y(this,ll,!0);W(this,En);this.schema=e,N(this,En,t),Be(this,t.key)}[(ll=v,J)](e){let t=e.getUniqueName(this),r=e.allocateLayoutEntry(g(this,En).layout);return e.addDeclaration(`@group(${r}) @binding(${g(this,En).idx}) var ${t}: ${e.resolve(this.schema).value};`),M(t,ad())}get[he](){let e=this.schema;return new Proxy({[v]:!0,get[$t](){return M(this,e)},[J]:t=>t.resolve(this),toString:()=>`textureExternal:${C(this)??"<unnamed>"}.$`},jt)}get $(){if(Ir())return this[he];throw new Error("Direct access to texture views values is possible only as part of a compute dispatch or draw call. Try .read() or .write() instead")}get value(){return this.$}toString(){return`textureExternal:${C(this)??"<unnamed>"}`}},En=new WeakMap,ul);function ii(e){let{videoWidth:t,videoHeight:r}=e;if(t&&r)return{width:t,height:r};let{naturalWidth:n,naturalHeight:a}=e;if(n&&a)return{width:n,height:a};let{codedWidth:s,codedHeight:i}=e;if(s&&i)return{width:s,height:i};let{width:o,height:l}=e||HTMLCanvasElement||OffscreenCanvas||HTMLImageElement||ImageData;if(!o||!l)throw new Error("Cannot determine dimensions of the provided image source.");return{width:o,height:l}}var oi=new WeakMap;function Hu(e){let t=oi.get(e);return t||(t=new Map,oi.set(e,t)),t}function iy(e){let t=oi.get(e);t&&t.clear()}function oy(e,t,r=0,n){if(t.dimension!=="2d")throw new Error("Cannot generate mipmaps for non-2D textures: only 2D textures are currently supported.");let a=n??t.mipLevelCount-r,s=Iu(t.format,e);if(![...s.sampleTypes].some(i=>i==="float"||i==="unfilterable-float"))throw new Error(`Cannot generate mipmaps for format '${t.format}': only float and unfilterable-float formats are currently supported.`);if(!s.canRenderAttachment)throw new Error(`Cannot generate mipmaps for format '${t.format}': format does not support render attachments.`);for(let i=0;i<t.depthOrArrayLayers;i++)for(let o=r;o<r+a-1;o++){let l=o,u=o+1;cy(e,t,l,u,i)}}function ly(e,t,r,n){if(t.dimension==="3d")throw new Error("Cannot resample to 3D textures: only 2D textures are currently supported.");let a=Ga[t.format];if(![...a.sampleTypes].some(s=>s==="float"||s==="unfilterable-float"))throw new Error(`Cannot resample to format '${t.format}': only float and unfilterable-float formats are currently supported.`);if(!a.canRenderAttachment)throw new Error(`Cannot resample to format '${t.format}': format does not support render attachments.`);return uy(e,t,r,n)}function uy(e,t,r,n=0){let a=[...Ga[t.format].sampleTypes].includes("float"),s=`${a?"filterable":"unfilterable"}`,i=Hu(e),o=i.get(s);if(!o){let T=e.createShaderModule({code:`
struct VertexOutput {
  @builtin(position) pos: vec4f,
  @location(0) uv: vec2f,
}

@vertex
fn vs_main(@builtin(vertex_index) vertexIndex: u32) -> VertexOutput {
  let pos = array<vec2f, 3>(vec2f(-1, -1), vec2f(3, -1), vec2f(-1, 3));
  let uv = array<vec2f, 3>(vec2f(0, 1), vec2f(2, 1), vec2f(0, -1));

  var output: VertexOutput;
  output.pos = vec4f(pos[vertexIndex], 0, 1);
  output.uv = uv[vertexIndex];
  return output;
}
      `}),_=(globalThis.__TYPEGPU_AUTONAME__??(V=>V))(e.createSampler({magFilter:a?"linear":"nearest",minFilter:a?"linear":"nearest"}),"R"),O=e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{type:a?"filtering":"non-filtering"}}]}),ne=e.createPipelineLayout({bindGroupLayouts:[O]}),Z=e.createShaderModule({code:`
@group(0) @binding(0) var inputTexture: texture_2d<f32>;
@group(0) @binding(1) var inputSampler: sampler;

@fragment
fn fs_main(@location(0) uv: vec2f) -> @location(0) vec4f {
  ${a?"return textureSample(inputTexture, inputSampler, uv);":`let texelCoord = vec2u(uv * vec2f(textureDimensions(inputTexture)));
        return textureLoad(inputTexture, texelCoord, 0);`}
}
      `});o={vertexShader:T,fragmentShader:Z,bindGroupLayout:O,pipelineLayout:ne,sampler:_},i.set(s,o)}let l=(globalThis.__TYPEGPU_AUTONAME__??(T=>T))(e.createTexture({size:[...Object.values(ii(r))],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_DST}),"l"),{width:u,height:c}=ii(r);e.queue.copyExternalImageToTexture({source:r},{texture:l},[u,c,1]);let p=(globalThis.__TYPEGPU_AUTONAME__??(T=>T))(e.createTexture({size:[t.width,t.height,1],format:t.format,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC}),"f"),d=e.createRenderPipeline({layout:o.pipelineLayout,vertex:{module:o.vertexShader},fragment:{module:o.fragmentShader,targets:[{format:t.format}]},primitive:{topology:"triangle-list"}}),h=e.createBindGroup({layout:o.bindGroupLayout,entries:[{binding:0,resource:l.createView()},{binding:1,resource:o.sampler}]}),f=e.createCommandEncoder(),m=f.beginRenderPass({colorAttachments:[{view:p.createView(),loadOp:"clear",storeOp:"store"}]});m.setPipeline(d),m.setBindGroup(0,h),m.draw(3),m.end(),f.copyTextureToTexture({texture:p},{texture:t,origin:{x:0,y:0,z:n}},{width:t.width,height:t.height,depthOrArrayLayers:1}),e.queue.submit([f.finish()]),l.destroy(),p.destroy()}function cy(e,t,r,n,a){let s=[...Iu(t.format,e).sampleTypes].includes("float"),i=`${s?"filterable":"unfilterable"}`,o=Hu(e),l=o.get(i);if(!l){let m=e.createShaderModule({code:`
struct VertexOutput {
  @builtin(position) pos: vec4f,
  @location(0) uv: vec2f,
}

@vertex
fn vs_main(@builtin(vertex_index) vertexIndex: u32) -> VertexOutput {
  let pos = array<vec2f, 3>(vec2f(-1, -1), vec2f(3, -1), vec2f(-1, 3));
  let uv = array<vec2f, 3>(vec2f(0, 1), vec2f(2, 1), vec2f(0, -1));

  var output: VertexOutput;
  output.pos = vec4f(pos[vertexIndex], 0, 1);
  output.uv = uv[vertexIndex];
  return output;
}
      `}),T=e.createShaderModule({code:`
@group(0) @binding(0) var inputTexture: texture_2d<f32>;
@group(0) @binding(1) var inputSampler: sampler;

@fragment
fn fs_main(@location(0) uv: vec2f) -> @location(0) vec4f {
  return textureSample(inputTexture, inputSampler, uv);
}
      `}),_=(globalThis.__TYPEGPU_AUTONAME__??(Z=>Z))(e.createSampler({magFilter:s?"linear":"nearest",minFilter:s?"linear":"nearest"}),"R"),O=e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:s?"float":"unfilterable-float"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{type:s?"filtering":"non-filtering"}}]}),ne=e.createPipelineLayout({bindGroupLayouts:[O]});l={vertexShader:m,fragmentShader:T,bindGroupLayout:O,pipelineLayout:ne,sampler:_},o.set(i,l)}let u=e.createRenderPipeline({layout:l.pipelineLayout,vertex:{module:l.vertexShader},fragment:{module:l.fragmentShader,targets:[{format:t.format}]},primitive:{topology:"triangle-list"}}),c=t.createView({baseMipLevel:r,dimension:"2d",mipLevelCount:1,...a!==void 0&&{baseArrayLayer:a,arrayLayerCount:1}}),p=t.createView({baseMipLevel:n,dimension:"2d",mipLevelCount:1,...a!==void 0&&{baseArrayLayer:a,arrayLayerCount:1}}),d=e.createBindGroup({layout:l.bindGroupLayout,entries:[{binding:0,resource:c},{binding:1,resource:l.sampler}]}),h=e.createCommandEncoder(),f=h.beginRenderPass({colorAttachments:[{view:p,loadOp:"clear",storeOp:"store"}]});f.setPipeline(u),f.setBindGroup(0,d),f.draw(3),f.end(),e.queue.submit([h.finish()])}function py(e){return{dimension:e.dimension??"2d",sampleType:Ga[e.format].channelType,multisampled:(e.sampleCount??1)!==1}}function fy(e){return e==="depth24plus-stencil8"||e==="depth32float-stencil8"?["depth","stencil"]:e==="depth16unorm"||e==="depth24plus"||e==="depth32float"?["depth"]:e==="stencil8"?["stencil"]:["color"]}function dy(e,t){return new hy(e,t)}function Ta(e){return(e==null?void 0:e.resourceType)==="texture"&&!!e[v]}function gs(e){return(e==null?void 0:e.resourceType)==="texture-view"&&!!e[v]}var cl,lr,bs,Vr,jr,Nr,At,nr,li,Ku,ui,pl,hy=(cl=v,pl=class{constructor(e,t){W(this,nr);y(this,cl);y(this,"resourceType","texture");y(this,"aspects");y(this,"usableAsSampled",!1);y(this,"usableAsStorage",!1);y(this,"usableAsRender",!1);W(this,lr);W(this,bs);W(this,Vr,!1);W(this,jr,GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC);W(this,Nr,null);W(this,At);this.props=e;let r=e.format;N(this,At,t),N(this,lr,Ga[r]),N(this,bs,e.size[0]*(e.size[1]??1)*(e.size[2]??1)*g(this,lr).texelSize),this.aspects=fy(r),this[v]={unwrap:()=>{if(g(this,Vr))throw new Error("This texture has been destroyed");return g(this,Nr)||N(this,Nr,t.device.createTexture({label:C(this)??"<unnamed>",format:e.format,size:e.size,usage:g(this,jr),dimension:e.dimension??"2d",viewFormats:e.viewFormats??[],mipLevelCount:e.mipLevelCount??1,sampleCount:e.sampleCount??1})),g(this,Nr)}}}$name(e){return Be(this,e),this}$usage(...e){let t=e.includes("storage"),r=e.includes("sampled"),n=e.includes("render");return N(this,jr,g(this,jr)|(r?GPUTextureUsage.TEXTURE_BINDING:0)),N(this,jr,g(this,jr)|(t?GPUTextureUsage.STORAGE_BINDING:0)),N(this,jr,g(this,jr)|(n?GPUTextureUsage.RENDER_ATTACHMENT:0)),this.usableAsStorage||(this.usableAsStorage=t),this.usableAsSampled||(this.usableAsSampled=r),this.usableAsRender||(this.usableAsRender=n),this}createView(e,t){return new my(e??ri(py(this.props)),this,t)}clear(e="all"){if(e==="all"){let t=this.props.mipLevelCount??1;for(let r=0;r<t;r++)xr(this,nr,li).call(this,r)}else xr(this,nr,li).call(this,e)}generateMipmaps(e=0,t){if(this.usableAsRender===!1)throw new Error("generateMipmaps called without specifying 'render' usage. Add it via the $usage('render') method.");let r=t??(this.props.mipLevelCount??1)-e;if(r<=1){console.warn(`generateMipmaps is a no-op: would generate ${r} mip levels (base: ${e}, total: ${this.props.mipLevelCount??1})`);return}if(e>=(this.props.mipLevelCount??1))throw new Error(`Base mip level ${e} is out of range. Texture has ${this.props.mipLevelCount??1} mip levels.`);oy(g(this,At).device,this[v].unwrap(),e,r)}write(e,t=0){if(e instanceof ArrayBuffer||ArrayBuffer.isView(e)){xr(this,nr,Ku).call(this,e,t);return}let r=this.props.dimension??"2d";if(!Array.isArray(e)){xr(this,nr,ui).call(this,e,r==="3d"?0:void 0);return}let n=this.props.size[2]??1;e.length>n&&console.warn(`Too many image sources provided. Expected ${n} layers, got ${e.length}. Extra sources will be ignored.`);for(let a=0;a<Math.min(e.length,n);a++){let s=e[a];s&&xr(this,nr,ui).call(this,s,a)}}copyFrom(e){if(e.props.format!==this.props.format)throw new Error(`Texture format mismatch. Source texture has format ${e.props.format}, target texture has format ${this.props.format}`);if(e.props.size[0]!==this.props.size[0]||(e.props.size[1]??1)!==(this.props.size[1]??1)||(e.props.size[2]??1)!==(this.props.size[2]??1))throw new Error(`Texture size mismatch. Source texture has size ${e.props.size.join("x")}, target texture has size ${this.props.size.join("x")}`);let t=g(this,At).device.createCommandEncoder();t.copyTextureToTexture({texture:e[v].unwrap()},{texture:this[v].unwrap()},e.props.size),g(this,At).device.queue.submit([t.finish()])}get destroyed(){return g(this,Vr)}destroy(){var e;g(this,Vr)||(N(this,Vr,!0),(e=g(this,Nr))==null||e.destroy())}},lr=new WeakMap,bs=new WeakMap,Vr=new WeakMap,jr=new WeakMap,Nr=new WeakMap,At=new WeakMap,nr=new WeakSet,li=function(e=0){let t=2**e,[r,n,a]=[Math.max(1,Math.floor((this.props.size[0]??1)/t)),Math.max(1,Math.floor((this.props.size[1]??1)/t)),Math.max(1,Math.floor((this.props.size[2]??1)/t))];g(this,At).device.queue.writeTexture({texture:this[v].unwrap(),mipLevel:e},new Uint8Array(r*n*a*g(this,lr).texelSize),{bytesPerRow:g(this,lr).texelSize*r,rowsPerImage:n},[r,n,a])},Ku=function(e,t){let r=Math.max(1,this.props.size[0]>>t),n=Math.max(1,(this.props.size[1]??1)>>t),a=Math.max(1,(this.props.size[2]??1)>>t),s=r*n*a*g(this,lr).texelSize,i=e.byteLength??e.byteLength;if(i!==s)throw new Error(`Buffer size mismatch. Expected ${s} bytes for mip level ${t}, got ${i} bytes.`);g(this,At).device.queue.writeTexture({texture:this[v].unwrap(),mipLevel:t},e,{bytesPerRow:g(this,lr).texelSize*r,rowsPerImage:n},[r,n,a])},ui=function(e,t){let r=this.props.size[0],n=this.props.size[1]??1,{width:a,height:s}=ii(e);if(a!==r||s!==n){ly(g(this,At).device,this[v].unwrap(),e,t);return}g(this,At).device.queue.copyExternalImageToTexture({source:e},{texture:this[v].unwrap(),...t!==void 0&&{origin:{x:0,y:0,z:t}}},t!==void 0?[r,n,1]:this.props.size)},pl),fl,Rn,Tr,Ot,dl,my=(dl=class{constructor(e,t,r){y(this,fl);y(this,"resourceType","texture-view");W(this,Rn);W(this,Tr);W(this,Ot);this.schema=e,N(this,Rn,t),N(this,Ot,r),this[v]={unwrap:()=>{var n,a,s,i;if(!g(this,Tr)){let o=this.schema,l;ni(o)?l={label:C(this)??"<unnamed>",format:((n=g(this,Ot))==null?void 0:n.format)??o.format,dimension:o.dimension}:l={label:C(this)??"<unnamed>",format:((a=g(this,Ot))==null?void 0:a.format)??g(this,Rn).props.format,dimension:o.dimension},((s=g(this,Ot))==null?void 0:s.mipLevelCount)!==void 0&&(l.mipLevelCount=g(this,Ot).mipLevelCount),((i=g(this,Ot))==null?void 0:i.arrayLayerCount)!==void 0&&(l.arrayLayerCount=g(this,Ot).arrayLayerCount),N(this,Tr,g(this,Rn)[v].unwrap().createView(l))}return g(this,Tr)}}}$name(e){return Be(this,e),g(this,Tr)&&(g(this,Tr).label=e),this}get[(fl=v,he)](){let e=this.schema;return new Proxy({[v]:!0,get[$t](){return M(this,e)},[J]:t=>t.resolve(this),toString:()=>`${this.toString()}.$`},jt)}get $(){if(Ir())return this[he];throw new Error("Direct access to texture view values is possible only as part of a compute dispatch or draw call. Try .read() or .write() instead")}get value(){return this.$}toString(){return`textureView:${C(this)??"<unnamed>"}`}[J](e){var a;let t=e.getUniqueName(this),{group:r,binding:n}=e.allocateFixedEntry(ni(this.schema)?{storageTexture:this.schema}:{texture:this.schema,sampleType:((a=g(this,Ot))==null?void 0:a.sampleType)??this.schema.bindingSampleType[0]},this);return e.addDeclaration(`@group(${r}) @binding(${n}) var ${t}: ${e.resolve(this.schema).value};`),M(t,this.schema)}},Rn=new WeakMap,Tr=new WeakMap,Ot=new WeakMap,dl),hl,Cn,ml,ko=(ml=class{constructor(e,t){y(this,hl,{unwrap:void 0});y(this,"resourceType","texture-view");W(this,Cn);this.schema=e,N(this,Cn,t),Be(this,t.key)}toString(){return`textureView:${C(this)??"<unnamed>"}`}[(hl=v,J)](e){let t=e.getUniqueName(this),r=e.allocateLayoutEntry(g(this,Cn).layout);return e.addDeclaration(`@group(${r}) @binding(${g(this,Cn).idx}) var ${t}: ${e.resolve(this.schema).value};`),M(t,this.schema)}get[he](){let e=this.schema;return new Proxy({[v]:!0,get[$t](){return M(this,e)},[J]:t=>t.resolve(this),toString:()=>`${this.toString()}.$`},jt)}get $(){if(Ir())return this[he];throw new Error("Direct access to texture views values is possible only as part of a compute dispatch or draw call. Try .read() or .write() instead")}get value(){return this.$}},Cn=new WeakMap,ml);function yy(e){return!!(e!=null&&e.usableAsSampled)}var gy=class Qu extends Error{constructor(t){super(`Resource '${C(t)??"<unnamed>"}' cannot be bound as 'sampled'. Use .$usage('sampled') to allow it.`),Object.setPrototypeOf(this,Qu.prototype)}};function vy(e){let t={};for(let[r,n]of Object.entries(e)){if(n===null){t[r]=null;continue}if("texture"in n&&typeof n.texture=="string"){let a=n.texture;t[r]={...n,texture:ri({dimension:n.viewDimension??"2d",sampleType:a==="sint"?qe:a==="uint"?te:b,multisampled:n.multisampled??!1})}}else if("storageTexture"in n&&typeof n.storageTexture=="string"){let a={readonly:"read-only",writeonly:"write-only",mutable:"read-write"};t[r]={...n,storageTexture:ri({access:a[n.access??"writeonly"],format:n.storageTexture,dimension:n.viewDimension??"2d"})}}else"externalTexture"in n&&Object.keys(n.externalTexture).length===0?t[r]={...n,externalTexture:{type:"texture_external",dimension:"2d"}}:t[r]=n}return t}function Ju(e){let t=vy(e);return new xy(t)}function ec(e){return!!e&&e.resourceType==="bind-group-layout"}function vs(e){return!!e&&e.resourceType==="bind-group"}var wy=class tc extends Error{constructor(t,r){super(`Bind group '${t??"<unnamed>"}' is missing a required binding '${r}'`),Object.setPrototypeOf(this,tc.prototype)}},_o=["compute","fragment"],oa=["compute","vertex","fragment"],yl,xy=class{constructor(e){y(this,yl,!0);y(this,"_index");y(this,"resourceType","bind-group-layout");y(this,"bound",{});y(this,"value",{});y(this,"$",this.value);this.entries=e;let t=0;for(let[r,n]of Object.entries(e)){if(n===null){t++;continue}let a={layout:this,key:r,idx:t};if("uniform"in n&&(this.bound[r]=new bo("uniform",n.uniform,a)),"storage"in n){let s="type"in n.storage?n.storage:n.storage(0);this.bound[r]=new bo(n.access??"readonly",s,a)}"texture"in n&&(this.bound[r]=new ko(n.texture,a)),"storageTexture"in n&&(this.bound[r]=new ko(n.storageTexture,a)),"externalTexture"in n&&(this.bound[r]=new sy(n.externalTexture,a)),"sampler"in n&&(this.bound[r]=new ay(n.sampler==="comparison"?du():fu(),a)),Object.defineProperty(this.value,r,{get:()=>this.bound[r].value}),t++}}get[(yl=v,he)](){return this.$}toString(){return`bindGroupLayout:${C(this)??"<unnamed>"}`}get index(){return this._index}$name(e){return Be(this,e),this}$idx(e){return this._index=e,this}unwrap(e){return e.device.createBindGroupLayout({label:C(this)??"<unnamed>",entries:Object.values(this.entries).map((t,r)=>{if(t===null)return null;let n=t.visibility,a={binding:r,visibility:0};if("uniform"in t)n=n??oa,a.buffer={type:"uniform"};else if("storage"in t)n=n??(t.access==="mutable"?_o:oa),a.buffer={type:t.access==="mutable"?"storage":"read-only-storage"};else if("sampler"in t)n=n??oa,a.sampler={type:t.sampler};else if("texture"in t){n=n??oa;let{multisampled:s,dimension:i,bindingSampleType:o}=t.texture;a.texture={sampleType:t.sampleType??o[0],viewDimension:i,multisampled:s}}else if("storageTexture"in t){n=n??_o;let{dimension:s,access:i,format:o}=t.storageTexture;a.storageTexture={access:i,format:o,viewDimension:s}}else"externalTexture"in t&&(n=n??oa,a.externalTexture={});return n!=null&&n.includes("compute")&&(a.visibility|=GPUShaderStage.COMPUTE),n!=null&&n.includes("vertex")&&(a.visibility|=GPUShaderStage.VERTEX),n!=null&&n.includes("fragment")&&(a.visibility|=GPUShaderStage.FRAGMENT),a}).filter(t=>t!==null)})}},rc=class{constructor(e,t){y(this,"resourceType","bind-group");this.layout=e,this.entries=t;for(let r of Object.keys(e.entries))if(e.entries[r]!==null&&!(r in t))throw new wy(C(e),r)}unwrap(e){return e.device.createBindGroup({label:C(this.layout)??"<unnamed>",layout:e.unwrap(this.layout),entries:Object.entries(this.layout.entries).map(([t,r],n)=>{if(r===null)return null;let a=this.entries[t];if(a===void 0)throw new Error(`'${t}' is a resource required to populate bind group layout '${C(this.layout)??"<unnamed>"}'.`);if("uniform"in r){let s;if(va(a)){if(!qu(a))throw new Wc(a);s={buffer:e.unwrap(a)}}else s={buffer:a};return{binding:n,resource:s}}if("storage"in r){let s;if(va(a)){if(!ys(a))throw new xo(a);s={buffer:e.unwrap(a)}}else s={buffer:a};return{binding:n,resource:s}}if("texture"in r){let s;if(Ta(a)){if(!yy(a))throw new gy(a);s=e.unwrap(a.createView(r.texture))}else gs(a)?s=e.unwrap(a):s=a;return{binding:n,resource:s}}if("storageTexture"in r){let s;if(Ta(a)){if(!ys(a))throw new xo(a);s=e.unwrap(a.createView(r.storageTexture))}else gs(a)?s=e.unwrap(a):s=a;return{binding:n,resource:s}}if("sampler"in r)return Zu(a)||Yu(a)?{binding:n,resource:e.unwrap(a)}:{binding:n,resource:a};if("externalTexture"in r)return{binding:n,resource:a};throw new Error(`Malformed bind group entry: ${ls(a)}`)}).filter(t=>t!==null)})}};function ws(e){return new by(e)}var gl,by=class{constructor(e=void 0){y(this,gl,!0);y(this,"resourceType","slot");this.defaultValue=e}$name(e){return Be(this,e),this}areEqual(e,t){return Object.is(e,t)}toString(){return`slot:${C(this)??"<unnamed>"}`}get[(gl=v,he)](){let e=Nn();if(!e)throw new Error("Cannot access tgpu.slot's value outside of resolution.");return Bs(e.unwrap(this))}get value(){return this[he]}get $(){return this.value}};function xs(e,t){return new nc("private",e,t)}function Bo(e){return new nc("workgroup",e)}var vl,ur,$r,qr,wl,nc=(wl=class{constructor(e,t,r){y(this,vl,{});W(this,ur);W(this,$r);W(this,qr);N(this,ur,e),N(this,$r,t),N(this,qr,r)}[(vl=v,J)](e){let t=e.getUniqueName(this),r=`var<${g(this,ur)}> ${t}: ${e.resolve(g(this,$r)).value}`;return g(this,qr)?e.addDeclaration(`${r} = ${e.resolve(g(this,qr),g(this,$r)).value};`):e.addDeclaration(`${r};`),M(t,g(this,$r))}$name(e){return Be(this,e),this}toString(){return`var:${C(this)??"<unnamed>"}`}get[he](){let e=g(this,$r);return new Proxy({[v]:!0,get[$t](){return M(this,e)},[J]:t=>t.resolve(this),toString:()=>`var:${C(this)??"<unnamed>"}.$`},jt)}get $(){let e=cs(),t=ps();if(e.type==="normal")throw new Hi(t?`Cannot access variable '${C(this)??"<unnamed>"}'. TypeGPU functions that depends on GPU resources need to be part of a compute dispatch, draw call or simulation`:"TypeGPU variables are inaccessible during normal JS execution. If you wanted to simulate GPU behavior, try `tgpu.simulate()`");return e.type==="codegen"?this[he]:e.type==="simulate"?(e.vars[g(this,ur)].has(this)||e.vars[g(this,ur)].set(this,g(this,qr)),e.vars[g(this,ur)].get(this)):wa(e,"tgpuVariable.ts#TgpuVarImpl/$")}set $(e){let t=cs(),r=ps();if(t.type==="normal")throw new Hi(r?`Cannot access ${String(this)}. TypeGPU functions that depends on GPU resources need to be part of a compute dispatch, draw call or simulation`:"TypeGPU variables are inaccessible during normal JS execution. If you wanted to simulate GPU behavior, try `tgpu.simulate()`");if(t.type==="codegen")throw new Error("Unreachable tgpuVariable.ts#TgpuVarImpl/$");if(t.type==="simulate"){t.vars[g(this,ur)].set(this,e);return}wa(t,"tgpuVariable.ts#TgpuVarImpl/$")}get value(){return this.$}set value(e){this.$=e}},ur=new WeakMap,$r=new WeakMap,qr=new WeakMap,wl),ac=xs(te,0).$name("dataBlockIndex"),sc=xs(te,0).$name("dataByteIndex"),ic=ws().$name("dataBuffer"),Ty=fe([],te)`() {
  let i = dataByteIndex;
  dataByteIndex = dataByteIndex + 1u;
  return i;
}`.$uses({dataByteIndex:sc}).$name("nextByteIndex"),z="dataBuffer[dataBlockIndex].serializedData[nextByteIndex()]",oc={f32:fe([b])`(n) => {
  ${z} = bitcast<u32>(n);
}`,f16:fe([St])`(n) => {
  ${z} = pack2x16float(vec2f(f32(n), 0.0));
}`,i32:fe([qe])`(n) => {
  ${z} = bitcast<u32>(n);
}`,u32:fe([te])`(n) => {
  ${z} = n;
}`,bool:fe([at])`(b) => {
  ${z} = u32(b);
}`,vec2f:fe([ke])`(v) => {
  ${z} = bitcast<u32>(v.x);
  ${z} = bitcast<u32>(v.y);
}`,vec3f:fe([Ke])`(v) => {
  ${z} = bitcast<u32>(v.x);
  ${z} = bitcast<u32>(v.y);
  ${z} = bitcast<u32>(v.z);
}`,vec4f:fe([S])`(v) => {
  ${z} = bitcast<u32>(v.x);
  ${z} = bitcast<u32>(v.y);
  ${z} = bitcast<u32>(v.z);
  ${z} = bitcast<u32>(v.w);
}`,vec2h:fe([yr])`(v) => {
  ${z} = pack2x16float(vec2f(f32(v.x), f32(v.y)));
}`,vec3h:fe([mr])`(v) => {
  ${z} = pack2x16float(vec2f(f32(v.x), f32(v.y)));
  ${z} = pack2x16float(vec2f(f32(v.z), 0.0));
}`,vec4h:fe([hr])`(v) => {
  ${z} = pack2x16float(vec2f(f32(v.x), f32(v.y)));
  ${z} = pack2x16float(vec2f(f32(v.z), f32(v.w)));
}`,vec2i:fe([bt])`(v) => {
  ${z} = bitcast<u32>(v.x);
  ${z} = bitcast<u32>(v.y);
}`,vec3i:fe([Gt])`(v) => {
  ${z} = bitcast<u32>(v.x);
  ${z} = bitcast<u32>(v.y);
  ${z} = bitcast<u32>(v.z);
}`,vec4i:fe([ze])`(v) => {
  ${z} = bitcast<u32>(v.x);
  ${z} = bitcast<u32>(v.y);
  ${z} = bitcast<u32>(v.z);
  ${z} = bitcast<u32>(v.w);
}`,vec2u:fe([cr])`(v) => {
  ${z} = v.x;
  ${z} = v.y;
}`,vec3u:fe([dt])`(v) => {
  ${z} = v.x;
  ${z} = v.y;
  ${z} = v.z;
}`,vec4u:fe([Ae])`(v) => {
  ${z} = v.x;
  ${z} = v.y;
  ${z} = v.z;
  ${z} = v.w;
}`,"vec2<bool>":fe([Xn])`(v) => {
  ${z} = u32(v.x);
  ${z} = u32(v.y);
}`,"vec3<bool>":fe([Zn])`(v) => {
  ${z} = u32(v.x);
  ${z} = u32(v.y);
  ${z} = u32(v.z);
}`,"vec4<bool>":fe([Yn])`(v) => {
  ${z} = u32(v.x);
  ${z} = u32(v.y);
  ${z} = u32(v.z);
  ${z} = u32(v.w);
}`,mat2x2f:fe([tr])`(m) => {
  ${z} = bitcast<u32>(m[0][0]);
  ${z} = bitcast<u32>(m[0][1]);
  ${z} = bitcast<u32>(m[1][0]);
  ${z} = bitcast<u32>(m[1][1]);
}`,mat3x3f:fe([rr])`(m) => {
  ${z} = bitcast<u32>(m[0][0]);
  ${z} = bitcast<u32>(m[0][1]);
  ${z} = bitcast<u32>(m[0][2]);
  ${z} = 0u;
  ${z} = bitcast<u32>(m[1][0]);
  ${z} = bitcast<u32>(m[1][1]);
  ${z} = bitcast<u32>(m[1][2]);
  ${z} = 0u;
  ${z} = bitcast<u32>(m[2][0]);
  ${z} = bitcast<u32>(m[2][1]);
  ${z} = bitcast<u32>(m[2][2]);
  ${z} = 0u;
}`,mat4x4f:fe([Oe])`(m) => {
  ${z} = bitcast<u32>(m[0][0]);
  ${z} = bitcast<u32>(m[0][1]);
  ${z} = bitcast<u32>(m[0][2]);
  ${z} = bitcast<u32>(m[0][3]);
  ${z} = bitcast<u32>(m[1][0]);
  ${z} = bitcast<u32>(m[1][1]);
  ${z} = bitcast<u32>(m[1][2]);
  ${z} = bitcast<u32>(m[1][3]);
  ${z} = bitcast<u32>(m[2][0]);
  ${z} = bitcast<u32>(m[2][1]);
  ${z} = bitcast<u32>(m[2][2]);
  ${z} = bitcast<u32>(m[2][3]);
  ${z} = bitcast<u32>(m[3][0]);
  ${z} = bitcast<u32>(m[3][1]);
  ${z} = bitcast<u32>(m[3][2]);
  ${z} = bitcast<u32>(m[3][3]);
}`};for(let[e,t]of Object.entries(oc))t.$name(`serialize${e[0].toLocaleUpperCase()}${e.slice(1)}`).$uses({dataBlockIndex:ac,nextByteIndex:Ty,dataBuffer:ic});function lc(e){return`(${e.map((t,r)=>`_arg_${r}`).join(", ")})`}function uc(e,t){let r=oc[e.type];if(r)return r.with(ic,t);if(Tt(e)){let n=Object.keys(e.propTypes),a=Object.values(e.propTypes),s=cc(a,t);return fe([e])`(arg) {\n  propsSerializer(${n.map(i=>`arg.${i}`).join(", ")});\n}`.$uses({propsSerializer:s}).$name(`${C(e)??"struct"}Serializer`)}if(fr(e)){let n=e.elementType,a=e.elementCount,s=uc(n,t);return fe([e])`(arg) {\n${Array.from({length:a},(i,o)=>`  elementSerializer(arg[${o}]);`).join(`
`)}\n}`.$uses({elementSerializer:s}).$name("arraySerializer")}throw new Error(`Cannot serialize data of type ${e.type}`)}function cc(e,t){let r={},n=fe(e),a=lc(e),s=e.map((i,o)=>(r[`serializer${o}`]=uc(i,t),`  serializer${o}(_arg_${o});`)).join(`
`);return n`${a} {\n${s}\n}`.$uses(r).$name("compoundSerializer")}function $y(e,t,r,n,a){let s=t.map(ve).reduce((l,u)=>l+u,0);if(s>a.logSizeLimit)throw new Error(`Logged data needs to fit in ${a.logSizeLimit} bytes (one of the logs requires ${s} bytes). Consider increasing the limit by passing appropriate options to tgpu.init().`);let i=cc(t,r).$name(`log${e}serializer`),o=lc(t);return fe(t)`${o} {
  dataBlockIndex = atomicAdd(&indexBuffer, 1);
  if (dataBlockIndex >= ${a.logCountLimit}) {
    return;
  }
  dataBuffer[dataBlockIndex].id = ${e};
  dataByteIndex = 0;

  compoundSerializer${o};
}`.$uses({indexBuffer:n,dataBuffer:r,dataBlockIndex:ac,dataByteIndex:sc,compoundSerializer:i}).$name(`log${e}`)}var Sy=["log","debug","info","warn","error","clear"],My={logCountLimit:64,logSizeLimit:252,messagePrefix:" GPU "},pc=M("/* console.log() */",ft),ky=class{get logResources(){}generateLog(){return console.warn("'console.log' is currently only supported in compute pipelines."),pc}},Sr,An,_a,On,Ln,xl,_y=(xl=class{constructor(e){W(this,Sr);W(this,An);W(this,_a,1);W(this,On);W(this,Ln);N(this,Sr,{...My,...e[v].logOptions}),N(this,An,new Map);let t=Ia({id:te,serializedData:Hs(te,Math.ceil(g(this,Sr).logSizeLimit/4))}).$name("SerializedLogData");N(this,Ln,e.createMutable(Hs(t,g(this,Sr).logCountLimit)).$name("dataBuffer")),N(this,On,e.createMutable(id(te)).$name("indexBuffer"))}generateLog(e,t,r){if(!Sy.includes(t))return console.warn(`Unsupported log method '${t}' was used in TGSL.`),pc;let n=jf(r),a=Gi(this,_a)._++,s=n.filter(l=>l.dataType!==pt),i=$y(a,s.map(l=>l.dataType),g(this,Ln),g(this,On),g(this,Sr)),o=n.map(l=>l.dataType===pt?l.value:l.dataType);return g(this,An).set(a,{op:t,argTypes:o}),M($`${e.resolve(i).value}(${s})`,ft)}get logResources(){return g(this,_a)===1?void 0:{dataBuffer:g(this,Ln),indexBuffer:g(this,On),options:g(this,Sr),logIdToMeta:g(this,An)}}},Sr=new WeakMap,An=new WeakMap,_a=new WeakMap,On=new WeakMap,Ln=new WeakMap,xl),fc="#CATCHALL#",By=class{constructor(){y(this,"_stack",[]);y(this,"_itemDepth",0)}get itemDepth(){return this._itemDepth}get topItem(){let e=this._stack[this._stack.length-1];if(!e||e.type!=="item")throw new Error("Internal error, expected item layer to be on top.");return e}get topFunctionScope(){return this._stack.findLast(e=>e.type==="functionScope")}pushItem(){this._itemDepth++,this._stack.push({type:"item",usedSlots:new Set})}popItem(){this.pop("item")}pushSlotBindings(e){this._stack.push({type:"slotBinding",bindingMap:new WeakMap(e)})}popSlotBindings(){this.pop("slotBinding")}pushFunctionScope(e,t,r,n){let a={type:"functionScope",args:e,argAliases:t,returnType:r,externalMap:n,reportedReturnTypes:new Set};return this._stack.push(a),a}popFunctionScope(){this.pop("functionScope")}pushBlockScope(){this._stack.push({type:"blockScope",declarations:new Map})}popBlockScope(){this.pop("blockScope")}pop(e){let t=this._stack[this._stack.length-1];if(!t||e&&t.type!==e)throw new Error(`Internal error, expected a ${e} layer to be on top.`);this._stack.pop(),e==="item"&&this._itemDepth--}readSlot(e){for(let t=this._stack.length-1;t>=0;--t){let r=this._stack[t];if((r==null?void 0:r.type)==="item")r.usedSlots.add(e);else if((r==null?void 0:r.type)==="slotBinding"){let n=r.bindingMap.get(e);if(n!==void 0)return n}else if(!((r==null?void 0:r.type)==="functionScope"||(r==null?void 0:r.type)==="blockScope"))throw new Error("Unknown layer type.")}return e.defaultValue}getSnippetById(e){for(let t=this._stack.length-1;t>=0;--t){let r=this._stack[t];if((r==null?void 0:r.type)==="functionScope"){let n=r.args.find(s=>s.value===e);if(n!==void 0)return n;if(r.argAliases[e])return r.argAliases[e];let a=r.externalMap[e];return a!=null?rs(a):void 0}if((r==null?void 0:r.type)==="blockScope"){let n=r.declarations.get(e);if(n!==void 0)return n}}}defineBlockVariable(e,t){if(t.dataType.type==="unknown")throw Error(`Tried to define variable '${e}' of unknown type`);for(let r=this._stack.length-1;r>=0;--r){let n=this._stack[r];if((n==null?void 0:n.type)==="blockScope"){n.declarations.set(e,t);return}}throw new Error("No block scope found to define a variable in.")}},as=["","  ","    ","      ","        ","          ","            ","              ","                "],Ns=as.length-1,Py=class{constructor(){y(this,"identLevel",0)}get pre(){return as[this.identLevel]??as[Ns].repeat(this.identLevel/Ns)+as[this.identLevel%Ns]}indent(){let e=this.pre;return this.identLevel++,e}dedent(){return this.identLevel--,this.pre}withResetLevel(e){let t=this.identLevel;this.identLevel=0;try{return e()}finally{this.identLevel=t}}},bl,wt,Fn,Wr,Ba,Gn,Tl,dc=(bl=v,Tl=class{constructor(e){W(this,wt);W(this,Fn);y(this,"_indentController",new Py);y(this,"_itemStateStack",new By);W(this,Wr,[]);y(this,"_declarations",[]);y(this,"_varyingLocations");W(this,Ba,new WeakSet);W(this,Gn);y(this,bl,{itemStateStack:this._itemStateStack});y(this,"bindGroupLayoutsToPlaceholderMap",new Map);y(this,"_nextFreeLayoutPlaceholderIdx",0);y(this,"fixedBindings",[]);y(this,"enableExtensions");y(this,"expectedType");this.enableExtensions=e.enableExtensions,N(this,Fn,e.shaderGenerator??vu),N(this,Gn,e.root?new _y(e.root):new ky),N(this,wt,e.namespace[v])}get varyingLocations(){return this._varyingLocations}getUniqueName(e){return Om(g(this,wt),e)}makeNameValid(e){return g(this,wt).nameRegistry.makeValid(e)}get pre(){return this._indentController.pre}get topFunctionReturnType(){let e=this._itemStateStack.topFunctionScope;return Gr(e),e.returnType}get shelllessRepo(){return g(this,wt).shelllessRepo}indent(){return this._indentController.indent()}dedent(){return this._indentController.dedent()}withResetIndentLevel(e){return this._indentController.withResetLevel(e)}getById(e){let t=this._itemStateStack.getSnippetById(e);return t===void 0?null:t}defineVariable(e,t){this._itemStateStack.defineBlockVariable(e,t)}reportReturnType(e){let t=this._itemStateStack.topFunctionScope;Gr(t),t.reportedReturnTypes.add(e)}pushBlockScope(){this._itemStateStack.pushBlockScope()}popBlockScope(){this._itemStateStack.popBlockScope()}generateLog(e,t){return g(this,Gn).generateLog(this,e,t)}get logResources(){return g(this,Gn).logResources}fnToWgsl(e){let t=this._itemStateStack.pushFunctionScope(e.args,e.argAliases,e.returnType,e.externalMap);try{g(this,Fn).initGenerator(this);let r=g(this,Fn).functionDefinition(e.body),n=e.returnType;if(!n){let a=[...t.reportedReturnTypes];if(a.length===0)n=ft;else{let s=Ac(a);s&&!s.hasImplicitConversions&&(n=s.targetType)}if(!n)throw new Error(`Expected function to have a single return type, got [${a.join(", ")}]. Cast explicitly to the desired type.`);n=ba(n)}return{head:zy(this,e.args,n),body:r,returnType:n}}finally{this._itemStateStack.popFunctionScope()}}addDeclaration(e){this._declarations.push(e)}allocateLayoutEntry(e){let t=this.bindGroupLayoutsToPlaceholderMap,r=t.get(e);return r||(r=`#BIND_GROUP_LAYOUT_${this._nextFreeLayoutPlaceholderIdx++}#`,t.set(e,r)),r}allocateFixedEntry(e,t){let r=this.fixedBindings.length;return this.fixedBindings.push({layoutEntry:e,resource:t}),{group:fc,binding:r}}readSlot(e){let t=this._itemStateStack.readSlot(e);if(t===void 0)throw new Oc(e);return t}withSlots(e,t){this._itemStateStack.pushSlotBindings(e);try{return t()}finally{this._itemStateStack.popSlotBindings()}}withVaryingLocations(e,t){this._varyingLocations=e;try{return t()}finally{this._varyingLocations=void 0}}unwrap(e){if(Yi(e))return this.withSlots(e[bn].pairs,()=>this.unwrap(e[bn].inner));let t=e;for(;;)if(Zi(t))t=this.readSlot(t);else if(Xi(t))t=this._getOrCompute(t);else break;return t}_getOrCompute(e){let t=g(this,wt).memoizedDerived.get(e)??[];this._itemStateStack.pushItem();try{for(let a of t)if([...a.slotToValueMap.entries()].every(([s,i])=>s.areEqual(this._itemStateStack.readSlot(s),i)))return a.result;this.pushMode(new Lc);let r;try{r=e["~compute"]()}finally{this.popMode("normal")}let n=new Map;for(let a of this._itemStateStack.topItem.usedSlots)n.set(a,this._itemStateStack.readSlot(a));return t.push({slotToValueMap:n,result:r}),g(this,wt).memoizedDerived.set(e,t),r}catch(r){throw r instanceof ua?r.appendToTrace(e):new ua(r,[e])}finally{this._itemStateStack.popItem()}}_getOrInstantiate(e){let t=g(this,wt).memoizedResolves.get(e)??[];this._itemStateStack.pushItem();try{for(let a of t)if([...a.slotToValueMap.entries()].every(([s,i])=>s.areEqual(this._itemStateStack.readSlot(s),i)))return a.result;let r;if(qn(e))r=M(Du(this,e),ft);else if(Xi(e)||Zi(e))r=this.resolve(this.unwrap(e));else if(Fc(e))r=e[J](this);else if(es(e)){let a=g(this,wt).shelllessRepo.get(e,void 0);if(!a)throw new Error(`Couldn't resolve ${e.name}. Make sure it's a function that accepts no arguments, or call it from another TypeGPU function.`);return this.withResetIndentLevel(()=>this.resolve(a))}else throw new TypeError(`Unresolvable internal value: ${ls(e)}`);let n=new Map;for(let a of this._itemStateStack.topItem.usedSlots)n.set(a,this._itemStateStack.readSlot(a));return t.push({slotToValueMap:n,result:r}),g(this,wt).memoizedResolves.set(e,t),r}catch(r){throw r instanceof ua?r.appendToTrace(e):new ua(r,[e])}finally{this._itemStateStack.popItem()}}resolve(e,t){if(Cu(e)||es(e)){if(g(this,Ba).has(e)&&!g(this,wt).memoizedResolves.has(e))throw new Error(`Recursive function ${e} detected. Recursion is not allowed on the GPU.`);g(this,Ba).add(e)}if(Yi(e))return this.withSlots(e[bn].pairs,()=>this.resolve(e[bn].inner,t));if(wi(e)||es(e)){if(this._itemStateStack.itemDepth===0)try{this.pushMode(new Gc);let r=jl(this,()=>this._getOrInstantiate(e));return M(`${[...this._declarations].join(`

`)}${r.value}`,ft)}finally{this.popMode("codegen")}return this._getOrInstantiate(e)}if(typeof e=="number"){let r=t??hs(e).dataType;if(Gr(r.type!=="unknown"),r.type==="abstractInt")return M(`${e}`,r);if(r.type==="u32")return M(`${e}u`,r);if(r.type==="i32")return M(`${e}i`,r);let n=e.toExponential(),a=r.type==="abstractFloat"&&Number.isInteger(e)?`${e}.`:`${e}`,s=n.length<a.length?n:a;return r.type==="f32"?M(`${s}f`,r):r.type==="f16"?M(`${s}h`,r):M(s,r)}if(typeof e=="boolean")return M(e?"true":"false",at);if(typeof e=="string")return M(e,ft);if(t&&fr(t)){if(!Array.isArray(e))throw new Ct(`Cannot coerce ${e} into value of type '${t}'`);if(t.elementCount!==e.length)throw new Ct(`Cannot create value of type '${t}' from an array of length: ${e.length}`);let r=this.resolve(t.elementType);return M($`array<${r}, ${t.elementCount}>(${e.map(n=>M(n,t.elementType))})`,t)}if(Array.isArray(e))return M($`array(${e.map(r=>this.resolve(r))})`,pt);if(t&&Tt(t))return M($`${this.resolve(t)}(${Object.entries(t.propTypes).map(([r,n])=>M(e[r],n))})`,t);throw new Ct(`Value ${e} (as json: ${ls(e)}) is not resolvable${t?` to type ${t.type}`:""}`)}pushMode(e){g(this,Wr).push(e)}popMode(e){let t=g(this,Wr).pop();e!==void 0&&Gr((t==null?void 0:t.type)===e)}get mode(){return g(this,Wr)[g(this,Wr).length-1]??Dc}},wt=new WeakMap,Fn=new WeakMap,Wr=new WeakMap,Ba=new WeakMap,Gn=new WeakMap,Tl);function Ai(e,t){let r=new dc(t),n=(t.config?r.withSlots(t.config(new Vu([])).bindings,()=>r.resolve(e)):r.resolve(e)).value,a=r.bindGroupLayoutsToPlaceholderMap,s=[],i=new Set([...a.keys()].map(p=>p.index).filter(p=>p!==void 0)),o=qm(i),l=r.fixedBindings.map((p,d)=>[String(d),p.layoutEntry]),u=()=>{let p=o.next().value,d=Ju(Object.fromEntries(l));return s[p]=d,n=n.replaceAll(fc,String(p)),[p,new rc(d,Object.fromEntries(r.fixedBindings.map((h,f)=>[String(f),h.resource])))]},c=l.length>0?u():void 0;for(let[p,d]of a.entries()){let h=p.index??o.next().value;s[h]=p,n=n.replaceAll(d,String(h))}return t.enableExtensions&&t.enableExtensions.length>0&&(n=`${t.enableExtensions.map(p=>`enable ${p};`).join(`
`)}

${n}`),{code:n,usedBindGroupLayouts:s,catchall:c,logResources:r.logResources}}function zy(e,t,r){let n=t.map(a=>`${a.value}: ${e.resolve(a.dataType).value}`).join(", ");return r.type!=="void"?`(${n}) -> ${vi(r)}${e.resolve(r).value} `:`(${n}) `}function hc(e){let t=e;return(t==null?void 0:t.resourceType)==="compute-pipeline"&&!!t[v]}function mc(e){let t=e;return(t==null?void 0:t.resourceType)==="render-pipeline"&&!!t[v]}function Iy(e){return mc(e)||hc(e)}function yc(e){var c;let{externals:t,shaderGenerator:r,template:n,names:a="random",config:s,enableExtensions:i}=e,o={};da(o,t??{});let l={[v]:!0,[J](p){return M(ks(p,o,n??""),ft)},toString:()=>"<root>"},u=Object.values(t).filter(Iy);if(u.length>1)throw new Error(`Found ${u.length} pipelines but can only resolve one at a time.`);return Ai(l,{namespace:typeof a=="string"?Da({names:a}):a,enableExtensions:i,shaderGenerator:r,config:s,root:(c=u[0])==null?void 0:c[v].branch})}function Uy(e){return yc(e).code}function Ey(e){let t=Nn()??new dc({namespace:Da(),shaderGenerator:vu}),r=[1,1,1],n=[1,1,1],a=[r[0]*n[0],r[1]*n[1],r[2]*n[2]],s=new Map,i=Array.from({length:r[0]},()=>Array.from({length:r[1]},()=>Array.from({length:r[2]},()=>new Map))),o=Array.from({length:a[0]},()=>Array.from({length:a[1]},()=>Array.from({length:a[2]},()=>new Map))),l=Array.from({length:a[0]},(u,c)=>Array.from({length:a[1]},(p,d)=>Array.from({length:a[2]},(h,f)=>{let m=Math.floor(c/n[0]),T=Math.floor(d/n[1]),_=Math.floor(f/n[2]);return new Cc(s,{private:o[c][d][f],workgroup:i[m][T][_]})})));t.pushMode(l[0][0][0]);try{return{value:jl(t,e),buffers:s,privateVars:o,workgroupVars:i}}finally{t.popMode("simulate")}}function Ry(e,t,r,n){return new Cy(e,t,r,n)}function Oi(e){let t=e;return(t==null?void 0:t.resourceType)==="query-set"&&!!t[v]}var Lt,$l,Cy=($l=class{constructor(e,t,r,n){y(this,"resourceType","query-set");W(this,Lt);y(this,"_querySet",null);y(this,"_ownQuerySet");y(this,"_destroyed",!1);y(this,"_available",!0);y(this,"_readBuffer",null);y(this,"_resolveBuffer",null);this.type=t,this.count=r,this.rawQuerySet=n,N(this,Lt,e.device),this._ownQuerySet=!n,this._querySet=n||null}get querySet(){if(this._destroyed)throw new Error("This QuerySet has been destroyed.");return this.rawQuerySet?this.rawQuerySet:this._querySet?this._querySet:(this._querySet=g(this,Lt).createQuerySet({type:this.type,count:this.count}),this._querySet)}get destroyed(){return this._destroyed}get available(){return this._available}get[v](){let e=this;return{get readBuffer(){return e._readBuffer||(e._readBuffer=g(e,Lt).createBuffer({size:e.count*BigUint64Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})),e._readBuffer},get resolveBuffer(){return e._resolveBuffer||(e._resolveBuffer=g(e,Lt).createBuffer({size:e.count*BigUint64Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC})),e._resolveBuffer}}}$name(e){return Be(this,e),this._querySet&&(this._querySet.label=e),this}resolve(){if(this._destroyed)throw new Error("This QuerySet has been destroyed.");if(!this._available)throw new Error("This QuerySet is busy resolving or reading.");let e=g(this,Lt).createCommandEncoder();e.resolveQuerySet(this.querySet,0,this.count,this[v].resolveBuffer,0),g(this,Lt).queue.submit([e.finish()])}async read(){if(!this._resolveBuffer)throw new Error("QuerySet must be resolved before reading.");this._available=!1;try{let e=g(this,Lt).createCommandEncoder();e.copyBufferToBuffer(this[v].resolveBuffer,0,this[v].readBuffer,0,this.count*BigUint64Array.BYTES_PER_ELEMENT),g(this,Lt).queue.submit([e.finish()]);let t=this[v].readBuffer;await t.mapAsync(GPUMapMode.READ);let r=new BigUint64Array(t.getMappedRange().slice());return t.unmap(),Array.from(r)}finally{this._available=!0}}destroy(){var e,t;this._destroyed||(this._destroyed=!0,this._querySet&&this._ownQuerySet&&this._querySet.destroy(),(e=this._readBuffer)==null||e.destroy(),(t=this._resolveBuffer)==null||t.destroy(),this._readBuffer=this._resolveBuffer=null)}},Lt=new WeakMap,$l),Po=class{constructor(e){y(this,"_map",new WeakMap);this._make=e}getOrMake(e,...t){if(this._map.has(e))return this._map.get(e);let r=this._make(e,...t);return this._map.set(e,r),r}},Sl,Ml,Yr,kl,qs=(kl=class{constructor(e,t){y(this,Ml,!0);y(this,Sl);W(this,Yr);this.resourceType=e,this.buffer=t,this[Ve]=t,N(this,Yr,this.buffer.as(this.resourceType))}$name(e){return Be(this[Ve],e),this}write(e){this.buffer.write(e)}writePartial(e){this.buffer.writePartial(e)}read(){return this.buffer.read()}get[(Ml=v,Sl=Ve,he)](){return g(this,Yr).$}get $(){return g(this,Yr).$}get value(){return this.$}[J](e){return e.resolve(g(this,Yr))}},Yr=new WeakMap,kl),re=e=>xm(e??0),qt=e=>bm(e??0),vn=e=>Tm(e??0),Ay={f32:e=>re(e[0]),f16:e=>vn(e[0]).x,i32:e=>qt(e[0]),u32:e=>e[0]??0,bool:e=>!!e[0],vec2f:e=>ke(re(e[0]),re(e[1])),vec3f:e=>Ke(re(e[0]),re(e[1]),re(e[2])),vec4f:e=>S(re(e[0]),re(e[1]),re(e[2]),re(e[3])),vec2h(e){let t=vn(e[0]);return yr(t.x,t.y)},vec3h(e){let t=vn(e[0]),r=vn(e[1]);return mr(t.x,t.y,r.x)},vec4h(e){let t=vn(e[0]),r=vn(e[1]);return hr(t.x,t.y,r.x,r.y)},vec2i:e=>bt(qt(e[0]),qt(e[1])),vec3i:e=>Gt(qt(e[0]),qt(e[1]),qt(e[2])),vec4i:e=>ze(qt(e[0]),qt(e[1]),qt(e[2]),qt(e[3])),vec2u:e=>cr(e[0]??0,e[1]??0),vec3u:e=>dt(e[0]??0,e[1]??0,e[2]??0),vec4u:e=>Ae(e[0]??0,e[1]??0,e[2]??0,e[3]??0),"vec2<bool>":e=>Xn(!!e[0],!!e[1]),"vec3<bool>":e=>Zn(!!e[0],!!e[1],!!e[2]),"vec4<bool>":e=>Yn(!!e[0],!!e[1],!!e[2],!!e[3]),mat2x2f:e=>tr(re(e[0]),re(e[1]),re(e[2]),re(e[3])),mat3x3f:e=>rr(re(e[0]),re(e[1]),re(e[2]),re(e[4]),re(e[5]),re(e[6]),re(e[8]),re(e[9]),re(e[10])),mat4x4f:e=>Oe(re(e[0]),re(e[1]),re(e[2]),re(e[3]),re(e[4]),re(e[5]),re(e[6]),re(e[7]),re(e[8]),re(e[9]),re(e[10]),re(e[11]),re(e[12]),re(e[13]),re(e[14]),re(e[15]))};function Oy(e,t){let r=Ay[t.type];if(r)return r(e);if(Tt(t)){let n=Object.keys(t.propTypes),a=Object.values(t.propTypes),s=ci(e,a);return Object.fromEntries(n.map((i,o)=>[i,s[o]]))}if(fr(t)){let n=t.elementType,a=t.elementCount;return ci(e,Array.from({length:a},()=>n))}throw new Error(`Cannot deserialize data of type ${t.type}`)}function ci(e,t){let r=0;return t.map(n=>{if(!$s(n))return n;let a=Math.ceil(ve(n)/4),s=Oy(e.subarray(r,r+a),n);return r+=a,s})}function Ly(e,t){return ci(e,t).map(Qc)}function pi(e){let{indexBuffer:t,dataBuffer:r,logIdToMeta:n,options:a}=e;r.read().then(s=>{s.filter(i=>i.id).forEach(({id:i,serializedData:o})=>{let{argTypes:l,op:u}=n.get(i),c=Ly(new Uint32Array(o),l);c.length===0&&c.push(""),console[u](`%c${a.messagePrefix}%c ${c[0]}`,"background: #936ff5; color: white;","color: inherit; background: none",...c.slice(1))})}),t.read().then(s=>{s>a.logCountLimit&&console.warn(`Log count limit per dispatch (${a.logCountLimit}) exceeded by ${s-a.logCountLimit} calls. Consider increasing the limit by passing appropriate options to tgpu.init().`)}),r.buffer.clear(),t.buffer.clear()}function gc(e,t,r){if(!r.enabledFeatures.has("timestamp-query"))throw new Error('Performance callback requires the "timestamp-query" feature to be enabled on GPU device.');return e.timestampWrites?{...e,performanceCallback:t}:{...e,performanceCallback:t,hasAutoQuerySet:!0,timestampWrites:{querySet:(globalThis.__TYPEGPU_AUTONAME__??(n=>n))(r.createQuerySet("timestamp",2),"querySet"),beginningOfPassWriteIndex:0,endOfPassWriteIndex:1}}}function vc(e,t,r){if(!r.enabledFeatures.has("timestamp-query"))throw new Error('Timestamp writes require the "timestamp-query" feature to be enabled on GPU device.');e.hasAutoQuerySet&&e.timestampWrites&&e.timestampWrites.querySet.destroy();let n={querySet:t.querySet};return t.beginningOfPassWriteIndex!==void 0&&(n.beginningOfPassWriteIndex=t.beginningOfPassWriteIndex),t.endOfPassWriteIndex!==void 0&&(n.endOfPassWriteIndex=t.endOfPassWriteIndex),{...e,hasAutoQuerySet:!1,timestampWrites:n}}function wc(e,t){if(!e.timestampWrites)return{};let{querySet:r,beginningOfPassWriteIndex:n,endOfPassWriteIndex:a}=e.timestampWrites,s={querySet:Oi(r)?t.unwrap(r):r};return n!==void 0&&(s.beginningOfPassWriteIndex=n),a!==void 0&&(s.endOfPassWriteIndex=a),{timestampWrites:s}}function fi({root:e,priors:t}){var s;let r=(s=t.timestampWrites)==null?void 0:s.querySet,n=t.performanceCallback;if(!r)throw new Error("Cannot dispatch workgroups with performance callback without a query set.");if(!Oi(r))throw new Error("Performance callback with raw GPUQuerySet is not supported. Use TgpuQuerySet instead.");let a=e.device.createCommandEncoder();a.resolveQuerySet(e.unwrap(r),0,r.count,r[v].resolveBuffer,0),e.device.queue.submit([a.finish()]),e.device.queue.onSubmittedWorkDone().then(async()=>{var u,c;if(!r.available)return;let i=await r.read(),o=i[((u=t.timestampWrites)==null?void 0:u.beginningOfPassWriteIndex)??0],l=i[((c=t.timestampWrites)==null?void 0:c.endOfPassWriteIndex)??1];if(o===void 0||l===void 0)throw new Error("QuerySet did not return valid timestamps.");await n(o,l)})}function Fy(e,t,r){return new Gy(new Dy(e,t,r),{})}var _l,Bl,Gy=class fa{constructor(t,r){y(this,Bl);y(this,"resourceType","compute-pipeline");y(this,_l);this._core=t,this._priors=r,this[v]={get rawPipeline(){return t.unwrap().pipeline},get priors(){return r},get branch(){return t.branch}},this[Ve]=t}[(Bl=v,_l=Ve,J)](t){return t.resolve(this._core)}toString(){return`computePipeline:${C(this)??"<unnamed>"}`}get rawPipeline(){return this._core.unwrap().pipeline}with(t,r){return vs(t)?new fa(this._core,{...this._priors,bindGroupLayoutMap:new Map([...this._priors.bindGroupLayoutMap??[],[t.layout,t]])}):new fa(this._core,{...this._priors,bindGroupLayoutMap:new Map([...this._priors.bindGroupLayoutMap??[],[t,r]])})}withPerformanceCallback(t){let r=gc(this._priors,t,this._core.branch);return new fa(this._core,r)}withTimestampWrites(t){let r=vc(this._priors,t,this._core.branch);return new fa(this._core,r)}dispatchWorkgroups(t,r,n){let a=this._core.unwrap(),{branch:s}=this._core,i={label:C(this._core)??"<unnamed>",...wc(this._priors,s)},o=s.device.createCommandEncoder(),l=o.beginComputePass(i);l.setPipeline(a.pipeline);let u=new Set(a.usedBindGroupLayouts);if(a.usedBindGroupLayouts.forEach((c,p)=>{var d;if(a.catchall&&p===a.catchall[0])l.setBindGroup(p,s.unwrap(a.catchall[1])),u.delete(c);else{let h=(d=this._priors.bindGroupLayoutMap)==null?void 0:d.get(c);h!==void 0&&(u.delete(c),l.setBindGroup(p,s.unwrap(h)))}}),u.size>0)throw new Ti(u);l.dispatchWorkgroups(t,r,n),l.end(),s.device.queue.submit([o.finish()]),a.logResources&&pi(a.logResources),this._priors.performanceCallback&&fi({root:s,priors:this._priors})}$name(t){return Be(this._core,t),this}},Pl,Dy=class{constructor(e,t,r){y(this,Pl,!0);y(this,"_memo");this.branch=e,this._slotBindings=t,this._entryFn=r}[(Pl=v,J)](e){return e.withSlots(this._slotBindings,()=>(e.resolve(this._entryFn),M("",ft)))}toString(){return"computePipelineCore"}unwrap(){var e;if(this._memo===void 0){let t=this.branch.device,r=Uu.filter(c=>this.branch.enabledFeatures.has(Eu[c])),n,a=Da({names:this.branch.nameRegistrySetting});n=Ai(this,{namespace:a,enableExtensions:r,shaderGenerator:this.branch.shaderGenerator,root:this.branch});let{code:s,usedBindGroupLayouts:i,catchall:o,logResources:l}=n;o!==void 0&&((e=i[o[0]])==null||e.$name(`${C(this)??"<unnamed>"} - Automatic Bind Group & Layout`));let u=t.createShaderModule({label:`${C(this)??"<unnamed>"} - Shader`,code:s});this._memo={pipeline:t.createComputePipeline({label:C(this)??"<unnamed>",layout:t.createPipelineLayout({label:`${C(this)??"<unnamed>"} - Pipeline Layout`,bindGroupLayouts:i.map(c=>this.branch.unwrap(c))}),compute:{module:u}}),usedBindGroupLayouts:i,catchall:o,logResources:l}}return this._memo}};function zo(e,t="vertex"){return new Vy(e,t)}function xc(e){return(e==null?void 0:e.resourceType)==="vertex-layout"}var di=Symbol("defaultAttribEntry");function ss(e,t,r,n,a){if(Nl(t)||jc(t)){let s=Pr(t);return s!==void 0&&(n[a??di]=s),ss(e,t.inner,_r(r,Qr(t)),n)}if(Tt(t)){let s=r,i=t.propTypes;return Object.fromEntries(Object.entries(i).map(([o,l])=>{s=_r(s,ht(l));let u=[o,ss(e,l,s,n,o)];return s+=ve(l),u}))}if(Ea(t)){let s=r,i=t.propTypes;return Object.fromEntries(Object.entries(i).map(([o,l])=>{s=_r(s,Qr(l));let u=[o,ss(e,l,s,n,o)];return s+=ve(l),u}))}if("type"in t&&typeof t.type=="string"){if(Nc.includes(t.type))return{_layout:e,format:t.type,offset:r};let s=qc[t.type];if(s)return{_layout:e,format:s,offset:r}}throw new Error(`Unsupported data used in vertex layout: ${String(t)}`)}var zl,Vy=(zl=v,class{constructor(e,t){y(this,zl,!0);y(this,"resourceType","vertex-layout");y(this,"stride");y(this,"attrib");y(this,"_customLocationMap",{});this.schemaForCount=e,this.stepMode=t;let r=e(0);this.stride=_r(ve(r.elementType),ht(r)),this.attrib=ss(this,r.elementType,0,this._customLocationMap)}get vertexLayout(){if(this._customLocationMap[di]!==void 0){if(typeof this.attrib.format!="string"||typeof this.attrib.offset!="number")throw new Error("Single attribute vertex layouts must have a format and offset.");return{arrayStride:this.stride,stepMode:this.stepMode,attributes:[{format:this.attrib.format,offset:this.attrib.offset,shaderLocation:this._customLocationMap[di]}]}}if(!Object.keys(this.attrib).every(e=>this._customLocationMap[e]!==void 0))throw new Error("All attributes must have custom locations in order to unwrap a vertex layout.");return{arrayStride:this.stride,stepMode:this.stepMode,attributes:[...Object.entries(this.attrib).map(([e,t])=>({format:t.format,offset:t.offset,shaderLocation:this._customLocationMap[e]}))]}}$name(e){return Be(this,e),this}});function jy(e){return typeof(e==null?void 0:e.loadOp)=="string"}function Ny(e,t){if(qn(e)){if(!jy(t))throw new Error("Expected a single color attachment, not a record.");return[t]}let r=[];for(let n of Object.keys(e)){let a=e[n];if(Ua(a))continue;let s=t[n];if(!s)throw new Error(`A color attachment by the name of '${n}' was not provided to the shader.`);r.push(s)}return r}function qy(e){return typeof(e==null?void 0:e.format)=="string"}function Wy(e,t){if(qn(e)){if(Fl(e))return[];if(!qy(t))throw new Error("Expected a single color target configuration, not a record.");return[t]}let r=[];for(let n of Object.keys(e)){let a=e[n];if(Ua(a))continue;let s=t[n];if(!s)throw new Error(`A color target by the name of '${n}' was not provided to the shader.`);r.push(s)}return r}function bc(e){return new Yy(new Zy(e),{})}var Il,Ul,Yy=class Zt{constructor(t,r){y(this,Ul);y(this,"resourceType","render-pipeline");y(this,Il);y(this,"hasIndexBuffer",!1);this[v]={core:t,priors:r,branch:t.options.branch},this[Ve]=t}[(Ul=v,Il=Ve,J)](t){return t.resolve(this[v].core)}toString(){return`renderPipeline:${C(this)??"<unnamed>"}`}$name(t){return Be(this[v].core,t),this}with(t,r){let n=this[v];if(vs(t))return new Zt(n.core,{...n.priors,bindGroupLayoutMap:new Map([...n.priors.bindGroupLayoutMap??[],[t.layout,t]])});if(ec(t))return new Zt(n.core,{...n.priors,bindGroupLayoutMap:new Map([...n.priors.bindGroupLayoutMap??[],[t,r]])});if(xc(t))return new Zt(n.core,{...n.priors,vertexLayoutMap:new Map([...n.priors.vertexLayoutMap??[],[t,r]])});throw new Error("Unsupported value passed into .with()")}withPerformanceCallback(t){let r=this[v],n=gc(r.priors,t,r.core.options.branch);return new Zt(r.core,n)}withTimestampWrites(t){let r=this[v],n=vc(r.priors,t,r.core.options.branch);return new Zt(r.core,n)}withColorAttachment(t){let r=this[v];return new Zt(r.core,{...r.priors,colorAttachment:t})}withDepthStencilAttachment(t){let r=this[v];return new Zt(r.core,{...r.priors,depthStencilAttachment:t})}withIndexBuffer(t,r,n,a){let s=this[v];if(Qs(t)){if(typeof r!="string")throw new Error("If a GPUBuffer is passed, indexFormat must be provided.");return new Zt(s.core,{...s.priors,indexBuffer:{buffer:t,indexFormat:r,offsetBytes:n,sizeBytes:a}})}let i={u32:"uint32",u16:"uint16"},o=t.dataType.elementType;return new Zt(s.core,{...s.priors,indexBuffer:{buffer:t,indexFormat:i[o.type],offsetBytes:r!==void 0?r*ve(o):void 0,sizeBytes:a!==void 0?a*ve(o):void 0}})}setupRenderPass(t){let r=this[v],n=r.core.unwrap(),{branch:a,fragmentFn:s}=r.core.options,i=s?Ny(s.shell.out,r.priors.colorAttachment??{}).map(p=>Ta(p.view)?{...p,view:a.unwrap(p.view).createView()}:gs(p.view)?{...p,view:a.unwrap(p.view)}:p):[null],o={label:C(r.core)??"<unnamed>",colorAttachments:i,...wc(r.priors,a)};if(r.priors.depthStencilAttachment!==void 0){let p=r.priors.depthStencilAttachment;Ta(p.view)?o.depthStencilAttachment={...p,view:a.unwrap(p.view).createView()}:o.depthStencilAttachment=p}let l=t.beginRenderPass(o);l.setPipeline(n.pipeline);let u=new Set(n.usedBindGroupLayouts);n.usedBindGroupLayouts.forEach((p,d)=>{var h;if(n.catchall&&d===n.catchall[0])l.setBindGroup(d,a.unwrap(n.catchall[1])),u.delete(p);else{let f=(h=r.priors.bindGroupLayoutMap)==null?void 0:h.get(p);f!==void 0&&(u.delete(p),l.setBindGroup(d,a.unwrap(f)))}});let c=new Set(r.core.usedVertexLayouts);if(r.core.usedVertexLayouts.forEach((p,d)=>{var f;let h=(f=r.priors.vertexLayoutMap)==null?void 0:f.get(p);h&&(c.delete(p),l.setVertexBuffer(d,a.unwrap(h)))}),u.size>0)throw new Ti(u);if(c.size>0)throw new Wl(c);return l}draw(t,r,n,a){let s=this[v],{branch:i}=s.core.options,{logResources:o}=s.core.unwrap(),l=i.device.createCommandEncoder(),u=this.setupRenderPass(l);u.draw(t,r,n,a),u.end(),i.device.queue.submit([l.finish()]),o&&pi(o),s.priors.performanceCallback&&fi({root:i,priors:s.priors})}drawIndexed(t,r,n,a,s){let i=this[v];if(!i.priors.indexBuffer)throw new Error("No index buffer set for this render pipeline.");let{logResources:o}=i.core.unwrap(),{branch:l}=i.core.options,{buffer:u,indexFormat:c,offsetBytes:p,sizeBytes:d}=i.priors.indexBuffer,h=l.device.createCommandEncoder(),f=this.setupRenderPass(h);Qs(u)?f.setIndexBuffer(u,c,p,d):f.setIndexBuffer(l.unwrap(u),c,p,d),f.drawIndexed(t,r,n,a,s),f.end(),l.device.queue.submit([h.finish()]),o&&pi(o),i.priors.performanceCallback&&fi({root:l,priors:i.priors})}},El,Zy=class{constructor(e){y(this,El,!0);y(this,"usedVertexLayouts");y(this,"_memo");y(this,"_vertexBufferLayouts");y(this,"_targets");this.options=e;let t=Lm(e.vertexFn.shell.in??{},e.vertexAttribs);this._vertexBufferLayouts=t.bufferDefinitions,this.usedVertexLayouts=t.usedVertexLayouts,this._targets=e.fragmentFn&&e.targets?Wy(e.fragmentFn.shell.out,e.targets):[null]}[(El=v,J)](e){let{vertexFn:t,fragmentFn:r,slotBindings:n}=this.options,a=Xy(t.shell.out,r==null?void 0:r.shell.in,C(t)??"<unnamed>",C(r)??"<unnamed>");return e.withVaryingLocations(a,()=>e.withSlots(n,()=>(e.resolve(t),r&&e.resolve(r),M("",ft))))}toString(){return"renderPipelineCore"}unwrap(){var e;if(this._memo===void 0){let{branch:t,primitiveState:r,depthStencilState:n,multisampleState:a}=this.options,s=t.device,i=Uu.filter(T=>t.enabledFeatures.has(Eu[T])),o,l=Da({names:t.nameRegistrySetting});o=Ai(this,{namespace:l,enableExtensions:i,shaderGenerator:t.shaderGenerator,root:t});let{code:u,usedBindGroupLayouts:c,catchall:p,logResources:d}=o;p!==void 0&&((e=c[p[0]])==null||e.$name(`${C(this)??"<unnamed>"} - Automatic Bind Group & Layout`));let h=s.createShaderModule({label:`${C(this)??"<unnamed>"} - Shader`,code:u}),f={layout:s.createPipelineLayout({label:`${C(this)??"<unnamed>"} - Pipeline Layout`,bindGroupLayouts:c.map(T=>t.unwrap(T))}),vertex:{module:h,buffers:this._vertexBufferLayouts}},m=C(this);m!==void 0&&(f.label=m),this.options.fragmentFn&&(f.fragment={module:h,targets:this._targets}),r&&($s(r.stripIndexFormat)?f.primitive={...r,stripIndexFormat:{u32:"uint32",u16:"uint16"}[r.stripIndexFormat.type]}:f.primitive=r),n&&(f.depthStencil=n),a&&(f.multisample=a),this._memo={pipeline:s.createRenderPipeline(f),usedBindGroupLayouts:c,catchall:p,logResources:d}}return this._memo}};function Xy(e,t,r,n){let a={},s=new Set;function i(l,u){a[l]=u,s.add(u)}for(let[l,u]of Object.entries(e)){let c=Pr(u);c!==void 0&&i(l,c)}for(let[l,u]of Object.entries(t??{})){let c=Pr(u);c!==void 0&&(a[l]===void 0?i(l,c):a[l]!==c&&console.warn(`Mismatched location between vertexFn (${r}) output (${a[l]}) and fragmentFn (${n}) input (${c}) for the key "${l}", using the location set on vertex output.`))}let o=0;for(let l of Object.keys(e??{}))if(!(Ua(e[l])||a[l]!==void 0)){for(;s.has(o);)o++;i(l,o)}return a}function Hy(e){if(e.includes(0))throw new Error("Size and workgroupSize cannot contain zeroes.");return dt(e[0]??1,e[1]??1,e[2]??1)}var Ky=[dt(1,1,1),dt(256,1,1),dt(16,16,1),dt(8,8,4)],Pa,Zr,Xr,Dn,Vn,jn,Qy=(jn=class{constructor(t,r,n,a){W(this,Pa);W(this,Zr);W(this,Xr);W(this,Dn);W(this,Vn);N(this,Pa,t),N(this,Zr,r),N(this,Xr,n),N(this,Dn,a),N(this,Vn,dt())}with(t){return new jn(g(this,Pa),g(this,Zr).with(t),g(this,Xr),g(this,Dn))}dispatchThreads(...t){let r=Hy(t),n=Pd(Ke(r).div(Ke(g(this,Dn))));$m(r,g(this,Vn))||(N(this,Vn,r),g(this,Xr).write(r)),g(this,Zr).dispatchWorkgroups(n.x,n.y,n.z)}get pipeline(){return g(this,Zr)}get sizeUniform(){return g(this,Xr)}},Pa=new WeakMap,Zr=new WeakMap,Xr=new WeakMap,Dn=new WeakMap,Vn=new WeakMap,jn),Jy=class hi{constructor(t,r){this._getRoot=t,this._slotBindings=r}with(t,r){return new hi(this._getRoot,[...this._slotBindings,[Ms(t)?t.slot:t,r]])}withCompute(t){return new eg(this._getRoot(),this._slotBindings,t)}createGuardedComputePipeline(t){let r=this._getRoot();if(t.length>=4)throw new Error("Guarded compute callback only supports up to three dimensions.");let n=Ky[t.length],a=fe([te,te,te])(t),s=(globalThis.__TYPEGPU_AUTONAME__??(l=>l))(r.createUniform(dt),"o"),i=Ru({workgroupSize:n,in:{id:ql.globalInvocationId}})`{
  if (any(in.id >= sizeUniform)) {
    return;
  }
  wrappedCallback(in.id.x, in.id.y, in.id.z);
}`.$uses({sizeUniform:s,wrappedCallback:a}),o=(globalThis.__TYPEGPU_AUTONAME__??(l=>l))(this.withCompute(i).createPipeline(),"i");return new Qy(r,o,s,n)}withVertex(t,r){return new tg({branch:this._getRoot(),primitiveState:void 0,depthStencilState:void 0,slotBindings:this._slotBindings,vertexFn:t,vertexAttribs:r,multisampleState:void 0})}pipe(t){let r=t(new Vu([]));return new hi(this._getRoot,[...this._slotBindings,...r.bindings])}},eg=class{constructor(e,t,r){this._root=e,this._slotBindings=t,this._entryFn=r}createPipeline(){return Fy(this._root,this._slotBindings,this._entryFn)}},tg=class is{constructor(t){this._options=t}withFragment(t,r,n){return Gr(typeof t!="string"),Gr(typeof r!="string"),new rg({...this._options,fragmentFn:t,targets:r})}withPrimitive(t){return new is({...this._options,primitiveState:t})}withDepthStencil(t){return new is({...this._options,depthStencilState:t})}withMultisample(t){return new is({...this._options,multisampleState:t})}createPipeline(){return bc({...this._options,fragmentFn:null,targets:null})}},rg=class os{constructor(t){this._options=t}withPrimitive(t){return new os({...this._options,primitiveState:t})}withDepthStencil(t){return new os({...this._options,depthStencilState:t})}withMultisample(t){return new os({...this._options,multisampleState:t})}createPipeline(){return bc(this._options)}},Rl,Cl,Tc=class extends(Cl=Jy,Rl=v,Cl){constructor(t,r,n,a,s){super(()=>this,[]);y(this,"~unstable");y(this,"_unwrappedBindGroupLayouts",new Po(t=>t.unwrap(this)));y(this,"_unwrappedBindGroups",new Po(t=>t.unwrap(this)));y(this,Rl);this.device=t,this.nameRegistrySetting=r,this._ownDevice=n,this.shaderGenerator=s,this["~unstable"]=this,this[v]={logOptions:a}}get enabledFeatures(){return new Set(this.device.features)}createBuffer(t,r){return Ka(this,t,r)}createUniform(t,r){let n=Ka(this,t,r).$usage("uniform");return new qs("uniform",n)}createMutable(t,r){let n=Ka(this,t,r).$usage("storage");return new qs("mutable",n)}createReadonly(t,r){let n=Ka(this,t,r).$usage("storage");return new qs("readonly",n)}createQuerySet(t,r,n){return Ry(this,t,r,n)}createBindGroup(t,r){return new rc(t,r)}destroy(){iy(this.device),this._ownDevice&&this.device.destroy()}createTexture(t){return dy(t,this)}createSampler(t){return ry(t,this)}createComparisonSampler(t){return ny(t,this)}unwrap(t){if(hc(t))return t[v].rawPipeline;if(mc(t))return t[v].core.unwrap().pipeline;if(ec(t))return this._unwrappedBindGroupLayouts.getOrMake(t);if(vs(t))return this._unwrappedBindGroups.getOrMake(t);if(va(t))return t.buffer;if(Ta(t))return t[v].unwrap();if(gs(t)){if(!t[v].unwrap)throw new Error("Cannot unwrap laid-out texture view as it has no underlying resource.");return t[v].unwrap()}if(xc(t))return t.vertexLayout;if(Yu(t)||Zu(t)){if(t[v].unwrap)return t[v].unwrap();throw new Error("Cannot unwrap laid-out sampler.")}if(Oi(t))return t.querySet;throw new Error(`Unknown resource type: ${t}`)}beginRenderPass(t,r){let n=this.device.createCommandEncoder(),a=n.beginRenderPass(t),s=new Map,i=new Map,o,l=()=>{if(!o)throw new Error("Cannot draw without a call to pass.setPipeline");let{core:u,priors:c}=o[v],p=u.unwrap();a.setPipeline(p.pipeline);let d=new Set(p.usedBindGroupLayouts);p.usedBindGroupLayouts.forEach((f,m)=>{var T;if(p.catchall&&m===p.catchall[0])a.setBindGroup(m,this.unwrap(p.catchall[1])),d.delete(f);else{let _=((T=c.bindGroupLayoutMap)==null?void 0:T.get(f))??s.get(f);_!==void 0&&(d.delete(f),vs(_)?a.setBindGroup(m,this.unwrap(_)):a.setBindGroup(m,_))}});let h=new Set;if(u.usedVertexLayouts.forEach((f,m)=>{var O;let T=(O=c.vertexLayoutMap)==null?void 0:O.get(f),_=T?{buffer:T,offset:void 0,size:void 0}:i.get(f);!_||!_.buffer?h.add(f):va(_.buffer)?a.setVertexBuffer(m,this.unwrap(_.buffer),_.offset,_.size):a.setVertexBuffer(m,_.buffer,_.offset,_.size)}),d.size>0)throw new Ti(d);if(h.size>0)throw new Wl(h)};r({setViewport(...u){a.setViewport(...u)},setScissorRect(...u){a.setScissorRect(...u)},setBlendConstant(...u){a.setBlendConstant(...u)},setStencilReference(...u){a.setStencilReference(...u)},beginOcclusionQuery(...u){a.beginOcclusionQuery(...u)},endOcclusionQuery(...u){a.endOcclusionQuery(...u)},executeBundles(...u){a.executeBundles(...u)},setPipeline(u){o=u},setIndexBuffer:(u,c,p,d)=>{va(u)?a.setIndexBuffer(this.unwrap(u),c,p,d):a.setIndexBuffer(u,c,p,d)},setVertexBuffer(u,c,p,d){i.set(u,{buffer:c,offset:p,size:d})},setBindGroup(u,c){s.set(u,c)},draw(u,c,p,d){l(),a.draw(u,c,p,d)},drawIndexed(...u){l(),a.drawIndexed(...u)},drawIndirect(...u){l(),a.drawIndirect(...u)},drawIndexedIndirect(...u){l(),a.drawIndexedIndirect(...u)}}),a.end(),this.device.queue.submit([n.finish()])}flush(){console.warn("flush() has been deprecated, and has no effect.")}};async function ng(e){let{adapter:t,device:r,unstable_names:n="random",unstable_logOptions:a}=e??{};if(!navigator.gpu)throw new Error("WebGPU is not supported by this browser.");let s=await navigator.gpu.requestAdapter(t);if(!s)throw new Error("Could not find a compatible GPU");let i=[];for(let l of(r==null?void 0:r.requiredFeatures)??[]){if(!s.features.has(l))throw new Error(`Requested feature "${l}" is not supported by the adapter.`);i.push(l)}for(let l of(r==null?void 0:r.optionalFeatures)??[])s.features.has(l)?i.push(l):console.warn(`Optional feature "${l}" is not supported by the adapter.`);let o=await s.requestDevice({...r,requiredFeatures:i});return new Tc(o,n,!0,a??{},e==null?void 0:e.shaderGenerator)}function ag(e){let{device:t,unstable_names:r="random",unstable_logOptions:n}=e??{};return new Tc(t,r,!1,n??{},e==null?void 0:e.shaderGenerator)}function sg(e,t){return new ig(e,t)}var Al,Ol,za,mi,Ll,ig=(Ll=class{constructor(e,t=void 0){W(this,za);y(this,Ol,!0);y(this,Al);y(this,"resourceType","accessor");y(this,"slot");this.schema=e,this.defaultValue=t,this.slot=ws(t),this[Ve]=this.slot}get[(Ol=v,Al=Ve,he)](){return new Proxy({[v]:!0,[$t]:xr(this,za,mi).call(this),[J]:e=>e.resolve(this),toString:()=>`accessor:${C(this)??"<unnamed>"}.$`},jt)}$name(e){return this.slot.$name(e),this}toString(){return`accessor:${C(this)??"<unnamed>"}`}get value(){if(Ir())return this[he];throw new Error("`tgpu.accessor` relies on GPU resources and cannot be accessed outside of a compute dispatch or draw call")}get $(){return this.value}[J](e){let t=xr(this,za,mi).call(this);return M(e.resolve(t.value,t.dataType).value,t.dataType)}},za=new WeakSet,mi=function(){let e=Nn(),t=Bs(e.unwrap(this.slot));return Cu(t)?t[v].gpuImpl():M(t,this.schema)},Ll);function og(e){return ug(e)}function lg([e,t]){return`${C(e)??"<unnamed>"}=${t}`}function ug(e){if(Nn())throw new Error("Cannot create tgpu.derived objects at the resolution stage.");return{[v]:!0,resourceType:"derived","~compute":e,get[he](){let t=Nn();if(!t)throw new Error("Cannot access tgpu.derived's value outside of resolution.");return Bs(t.unwrap(this))},get value(){return this[he]},get $(){return this.value},with(t,r){return $c(this,[[t,r]])},toString(){return"derived"}}}function $c(e,t){return{[v]:!0,resourceType:"derived","~compute"(){throw new Error("'~compute' should never be read on bound derived items.")},[bn]:{inner:e,pairs:t},get[he](){let r=Nn();if(!r)throw new Error("Cannot access tgpu.derived's value outside of resolution.");return Bs(r.unwrap(this))},get value(){return this[he]},get $(){return this.value},with(r,n){return $c(e,[...t,[r,n]])},toString(){return`derived[${t.map(lg).join(", ")}]`}}}var cg={fn:fe,bindGroupLayout:Ju,vertexLayout:zo,slot:ws,init:ng,initFromDevice:ag,resolve:Uy,resolveWithContext:yc,privateVar:xs,workgroupVar:Bo,const:ti,"~unstable":{fn:fe,fragmentFn:zm,vertexFn:$f,computeFn:Ru,vertexLayout:zo,namespace:Da,derived:og,slot:ws,accessor:sg,privateVar:xs,workgroupVar:Bo,const:ti,declare:Mm,simulate:Ey}},Kn=cg;const Li=(globalThis.__TYPEGPU_AUTONAME__??(e=>e))(Ia({brushColor:Ke,brushOpacity:b,hardness:b,screenSize:ke,brushShape:te}),"BrushUniforms"),pg=(globalThis.__TYPEGPU_AUTONAME__??(e=>e))(Ia({pos:Jt(0,ke),size:Jt(1,b),pressure:Jt(2,b)}),"StrokePoint"),Sc=(globalThis.__TYPEGPU_AUTONAME__??(e=>e))(Ia({position:ql.position,localUV:Jt(0,ke),color:Jt(1,Ke),opacity:Jt(2,b),hardness:Jt(3,b)}),"VertexOutput"),fg=`
@group(0) @binding(0) var<uniform> globals: BrushUniforms;

@vertex
fn vs(
  @location(0) quadPos: vec2<f32>,
  @location(1) pos: vec2<f32>,
  @location(2) size: f32,
  @location(3) pressure: f32
) -> VertexOutput {
  // Convert diameter to radius
  let radius = size * pressure;
  let pixelPos = pos + (quadPos * radius);
  
  // Convert pixel coordinates to Normalized Device Coordinates (NDC)
  let ndcX = (pixelPos.x / globals.screenSize.x) * 2.0 - 1.0;
  let ndcY = 1.0 - ((pixelPos.y / globals.screenSize.y) * 2.0);  // Flip Y axis for WebGPU coordinate system

  return VertexOutput(
    vec4<f32>(ndcX, ndcY, 0.0, 1.0),
    quadPos,
    globals.brushColor,
    pressure * globals.brushOpacity,
    globals.hardness
  );
}
`,dg=Kn.resolve({template:fg,externals:{BrushUniforms:Li,VertexOutput:Sc}}),hg=`
@group(0) @binding(0) var<uniform> globals: BrushUniforms;

@fragment
fn fs(v: VertexOutput) -> @location(0) vec4<f32> {
  var dist: f32;
  if (globals.brushShape == 1u) {
    // Calculate Chebyshev distance for square shape
    dist = max(abs(v.localUV.x), abs(v.localUV.y));
  } else {
    // Calculate Euclidean distance for circle shape
    dist = length(v.localUV);
  }

  if (dist > 1.0) { discard; }

  // Calculate alpha with hardness and anti-aliasing
  let edgeWidth = fwidth(dist);
  let startFade = min(v.hardness, 1.0 - edgeWidth * 2.0);
  let linearAlpha = 1.0 - smoothstep(startFade, 1.0, dist);
  // Apply quadratic falloff for smoother edges
  let alphaShape = pow(linearAlpha, 2.0);
  
  // Return premultiplied alpha color
  let alpha = alphaShape * v.opacity;
  return vec4<f32>(v.color * alpha, alpha);
}
`,mg=Kn.resolve({template:hg,externals:{VertexOutput:Sc,BrushUniforms:Li}}),yg=`
@vertex fn vs(@builtin(vertex_index) vIdx: u32) -> @builtin(position) vec4<f32> {
  var pos = array<vec2<f32>, 3>(
    vec2<f32>(-1.0, -1.0), vec2<f32>(3.0, -1.0), vec2<f32>(-1.0, 3.0)
  );
  return vec4<f32>(pos[vIdx], 0.0, 1.0);
}

@group(0) @binding(0) var myTexture: texture_2d<f32>;

@fragment fn fs(@builtin(position) pos: vec4<f32>) -> @location(0) vec4<f32> {
  let c = textureLoad(myTexture, vec2<i32>(pos.xy), 0);
  // Treat texture as premultiplied to prevent double-darkening on overlaps
  return c;
}
`,Io=Kn.resolve({template:yg,externals:{}}),gg=`
@vertex fn vs(@builtin(vertex_index) vIdx: u32) -> @builtin(position) vec4<f32> {
  var pos = array<vec2<f32>, 3>(
    vec2<f32>(-1.0, -1.0), vec2<f32>(3.0, -1.0), vec2<f32>(-1.0, 3.0)
  );
  return vec4<f32>(pos[vIdx], 0.0, 1.0);
}

@group(0) @binding(0) var myTexture: texture_2d<f32>;
@group(1) @binding(0) var<uniform> globals: BrushUniforms;

@fragment fn fs(@builtin(position) pos: vec4<f32>) -> @location(0) vec4<f32> {
  let sampled = textureLoad(myTexture, vec2<i32>(pos.xy), 0);
  // Apply global brush opacity to accumulated coverage
  return sampled * globals.brushOpacity;
}
`,br=Kn.resolve({template:gg,externals:{BrushUniforms:Li}}),vg=`
@group(0) @binding(0) var inputTex: texture_2d<f32>;
@group(0) @binding(1) var<storage, read_write> outputBuf: array<u32>;

@compute @workgroup_size(8, 8)
fn main(@builtin(global_invocation_id) id: vec3<u32>) {
  let dims = textureDimensions(inputTex);
  if (id.x >= dims.x || id.y >= dims.y) { return; }

  let color = textureLoad(inputTex, vec2<i32>(id.xy), 0);
  
  var r = color.r;
  var g = color.g;
  var b = color.b;
  let a = color.a;

  if (a > 0.0) {
    r = r / a;
    g = g / a;
    b = b / a;
  }

  let ir = u32(clamp(r * 255.0, 0.0, 255.0));
  let ig = u32(clamp(g * 255.0, 0.0, 255.0));
  let ib = u32(clamp(b * 255.0, 0.0, 255.0));
  let ia = u32(clamp(a * 255.0, 0.0, 255.0));

  // Pack RGBA channels into a single u32 (Little Endian)
  let packed = ir | (ig << 8u) | (ib << 16u) | (ia << 24u);

  let index = id.y * dims.x + id.x;
  outputBuf[index] = packed;
}
`,wg=Kn.resolve({template:vg,externals:{}}),Uo=new Float32Array([-1,-1,1,-1,1,1,-1,1]),Eo=new Uint16Array([0,1,2,0,2,3]),Qa=48,xg=Jc(pg),Ro=1e4;class bg{constructor(t,r="rgba8unorm"){y(this,"device");y(this,"quadVertexBuffer");y(this,"indexBuffer");y(this,"instanceBuffer");y(this,"uniformBuffer");y(this,"renderPipeline");y(this,"accumulatePipeline");y(this,"blitPipeline");y(this,"compositePipeline");y(this,"compositePipelinePreview");y(this,"erasePipeline");y(this,"erasePipelinePreview");y(this,"readbackPipeline");y(this,"uniformBindGroupLayout");y(this,"textureBindGroupLayout");y(this,"mainUniformBindGroup");y(this,"currentStrokeTexture",null);y(this,"currentStrokeView",null);y(this,"compositeTextureBindGroup",null);y(this,"previewTextureBindGroup",null);y(this,"lastReadbackTexture",null);y(this,"lastReadbackBuffer",null);y(this,"readbackBindGroup",null);y(this,"lastBackgroundTexture",null);y(this,"backgroundBindGroup",null);this.device=t,this.quadVertexBuffer=t.createBuffer({size:Uo.byteLength,usage:GPUBufferUsage.VERTEX,mappedAtCreation:!0}),new Float32Array(this.quadVertexBuffer.getMappedRange()).set(Uo),this.quadVertexBuffer.unmap(),this.indexBuffer=t.createBuffer({size:Eo.byteLength,usage:GPUBufferUsage.INDEX,mappedAtCreation:!0}),new Uint16Array(this.indexBuffer.getMappedRange()).set(Eo),this.indexBuffer.unmap(),this.instanceBuffer=t.createBuffer({size:Ro*xg,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),this.uniformBuffer=t.createBuffer({size:Qa,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const n=t.createShaderModule({code:dg}),a=t.createShaderModule({code:mg});this.uniformBindGroupLayout=t.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]}),this.textureBindGroupLayout=t.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}}]}),this.mainUniformBindGroup=t.createBindGroup({layout:this.uniformBindGroupLayout,entries:[{binding:0,resource:{buffer:this.uniformBuffer}}]});const s=t.createPipelineLayout({bindGroupLayouts:[this.uniformBindGroupLayout]});this.renderPipeline=t.createRenderPipeline({layout:s,vertex:{module:n,entryPoint:"vs",buffers:[{arrayStride:8,stepMode:"vertex",attributes:[{shaderLocation:0,offset:0,format:"float32x2"}]},{arrayStride:16,stepMode:"instance",attributes:[{shaderLocation:1,offset:0,format:"float32x2"},{shaderLocation:2,offset:8,format:"float32"},{shaderLocation:3,offset:12,format:"float32"}]}]},fragment:{module:a,entryPoint:"fs",targets:[{format:"rgba8unorm",blend:{color:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list"}}),this.accumulatePipeline=t.createRenderPipeline({layout:s,vertex:{module:n,entryPoint:"vs",buffers:[{arrayStride:8,stepMode:"vertex",attributes:[{shaderLocation:0,offset:0,format:"float32x2"}]},{arrayStride:16,stepMode:"instance",attributes:[{shaderLocation:1,offset:0,format:"float32x2"},{shaderLocation:2,offset:8,format:"float32"},{shaderLocation:3,offset:12,format:"float32"}]}]},fragment:{module:a,entryPoint:"fs",targets:[{format:"rgba8unorm",blend:{color:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list"}});const i=t.createPipelineLayout({bindGroupLayouts:[this.textureBindGroupLayout]});this.blitPipeline=t.createRenderPipeline({layout:i,vertex:{module:t.createShaderModule({code:Io}),entryPoint:"vs"},fragment:{module:t.createShaderModule({code:Io}),entryPoint:"fs",targets:[{format:r,blend:{color:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list"}});const o=t.createPipelineLayout({bindGroupLayouts:[this.textureBindGroupLayout,this.uniformBindGroupLayout]});this.compositePipeline=t.createRenderPipeline({layout:o,vertex:{module:t.createShaderModule({code:br}),entryPoint:"vs"},fragment:{module:t.createShaderModule({code:br}),entryPoint:"fs",targets:[{format:"rgba8unorm",blend:{color:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list"}}),this.compositePipelinePreview=t.createRenderPipeline({layout:o,vertex:{module:t.createShaderModule({code:br}),entryPoint:"vs"},fragment:{module:t.createShaderModule({code:br}),entryPoint:"fs",targets:[{format:r,blend:{color:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list"}}),this.erasePipeline=t.createRenderPipeline({layout:o,vertex:{module:t.createShaderModule({code:br}),entryPoint:"vs"},fragment:{module:t.createShaderModule({code:br}),entryPoint:"fs",targets:[{format:"rgba8unorm",blend:{color:{srcFactor:"zero",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"zero",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list"}}),this.erasePipelinePreview=t.createRenderPipeline({layout:o,vertex:{module:t.createShaderModule({code:br}),entryPoint:"vs"},fragment:{module:t.createShaderModule({code:br}),entryPoint:"fs",targets:[{format:r,blend:{color:{srcFactor:"zero",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"zero",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list"}}),this.readbackPipeline=t.createComputePipeline({layout:"auto",compute:{module:t.createShaderModule({code:wg}),entryPoint:"main"}})}prepareStroke(t,r){(!this.currentStrokeTexture||this.currentStrokeTexture.width!==t||this.currentStrokeTexture.height!==r)&&(this.currentStrokeTexture&&this.currentStrokeTexture.destroy(),this.currentStrokeTexture=this.device.createTexture({size:[t,r],format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC}),this.currentStrokeView=this.currentStrokeTexture.createView(),this.compositeTextureBindGroup=null,this.previewTextureBindGroup=null,this.lastReadbackTexture===this.currentStrokeTexture&&(this.readbackBindGroup=null,this.lastReadbackTexture=null));const n=this.device.createCommandEncoder();n.beginRenderPass({colorAttachments:[{view:this.currentStrokeView,loadOp:"clear",clearValue:{r:0,g:0,b:0,a:0},storeOp:"store"}]}).end(),this.device.queue.submit([n.finish()])}renderStrokeToAccumulator(t,r){this.currentStrokeView&&this.renderStrokeInternal(this.currentStrokeView,this.accumulatePipeline,t,r)}compositeStroke(t,r){if(!this.currentStrokeTexture)return;const n=new ArrayBuffer(Qa),a=new Float32Array(n),s=new Uint32Array(n);a[0]=r.color[0],a[1]=r.color[1],a[2]=r.color[2],a[3]=r.opacity,a[4]=r.hardness,a[5]=0,a[6]=r.screenSize[0],a[7]=r.screenSize[1],s[8]=r.brushShape,this.device.queue.writeBuffer(this.uniformBuffer,0,n);const i=this.device.createCommandEncoder(),o=r.isErasing?this.erasePipeline:this.compositePipeline;this.compositeTextureBindGroup||(this.compositeTextureBindGroup=this.device.createBindGroup({layout:this.textureBindGroupLayout,entries:[{binding:0,resource:this.currentStrokeTexture.createView()}]}));const l=i.beginRenderPass({colorAttachments:[{view:t,loadOp:"load",storeOp:"store"}]});l.setPipeline(o),l.setBindGroup(0,this.compositeTextureBindGroup),l.setBindGroup(1,this.mainUniformBindGroup),l.draw(3),l.end(),this.device.queue.submit([i.finish()])}renderStroke(t,r,n){this.renderStrokeInternal(t,this.renderPipeline,r,n)}renderStrokeInternal(t,r,n,a){if(n.length===0)return;const s=new ArrayBuffer(Qa),i=new Float32Array(s),o=new Uint32Array(s);i[0]=a.color[0],i[1]=a.color[1],i[2]=a.color[2],i[3]=a.opacity,i[4]=a.hardness,i[5]=0,i[6]=a.width,i[7]=a.height,o[8]=a.brushShape,this.device.queue.writeBuffer(this.uniformBuffer,0,s);let l=0;for(;l<n.length;){const u=Math.min(n.length-l,Ro),c=new Float32Array(u*4);for(let h=0;h<u;h++){const f=n[l+h];c[h*4+0]=f.x,c[h*4+1]=f.y,c[h*4+2]=a.size,c[h*4+3]=f.pressure}this.device.queue.writeBuffer(this.instanceBuffer,0,c);const p=this.device.createCommandEncoder(),d=p.beginRenderPass({colorAttachments:[{view:t,loadOp:"load",storeOp:"store"}]});d.setPipeline(r),d.setBindGroup(0,this.mainUniformBindGroup),d.setVertexBuffer(0,this.quadVertexBuffer),d.setVertexBuffer(1,this.instanceBuffer),d.setIndexBuffer(this.indexBuffer,"uint16"),d.drawIndexed(6,u),d.end(),this.device.queue.submit([p.finish()]),l+=u}}blitToCanvas(t,r,n){const a=this.device.createCommandEncoder(),s=t.getCurrentTexture().createView();if(n){(this.lastBackgroundTexture!==n||!this.backgroundBindGroup)&&(this.backgroundBindGroup=this.device.createBindGroup({layout:this.textureBindGroupLayout,entries:[{binding:0,resource:n.createView()}]}),this.lastBackgroundTexture=n);const i=a.beginRenderPass({colorAttachments:[{view:s,loadOp:"clear",clearValue:{r:0,g:0,b:0,a:0},storeOp:"store"}]});i.setPipeline(this.blitPipeline),i.setBindGroup(0,this.backgroundBindGroup),i.draw(3),i.end()}else a.beginRenderPass({colorAttachments:[{view:s,loadOp:"clear",clearValue:{r:0,g:0,b:0,a:0},storeOp:"store"}]}).end();if(this.currentStrokeTexture){const i=new ArrayBuffer(Qa),o=new Float32Array(i),l=new Uint32Array(i);o[0]=r.color[0],o[1]=r.color[1],o[2]=r.color[2],o[3]=r.opacity,o[4]=r.hardness,o[5]=0,o[6]=r.screenSize[0],o[7]=r.screenSize[1],l[8]=r.brushShape,this.device.queue.writeBuffer(this.uniformBuffer,0,i);const u=r.isErasing?this.erasePipelinePreview:this.compositePipelinePreview;this.previewTextureBindGroup||(this.previewTextureBindGroup=this.device.createBindGroup({layout:this.textureBindGroupLayout,entries:[{binding:0,resource:this.currentStrokeTexture.createView()}]}));const c=a.beginRenderPass({colorAttachments:[{view:s,loadOp:"load",storeOp:"store"}]});c.setPipeline(u),c.setBindGroup(0,this.previewTextureBindGroup),c.setBindGroup(1,this.mainUniformBindGroup),c.draw(3),c.end()}this.device.queue.submit([a.finish()])}clearPreview(t){const r=this.device.createCommandEncoder();r.beginRenderPass({colorAttachments:[{view:t.getCurrentTexture().createView(),loadOp:"clear",clearValue:{r:0,g:0,b:0,a:0},storeOp:"store"}]}).end(),this.device.queue.submit([r.finish()])}prepareReadback(t,r){(this.lastReadbackTexture!==t||this.lastReadbackBuffer!==r||!this.readbackBindGroup)&&(this.readbackBindGroup=this.device.createBindGroup({layout:this.readbackPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:t.createView()},{binding:1,resource:{buffer:r}}]}),this.lastReadbackTexture=t,this.lastReadbackBuffer=r);const n=this.device.createCommandEncoder(),a=n.beginComputePass();a.setPipeline(this.readbackPipeline),a.setBindGroup(0,this.readbackBindGroup);const s=t.width,i=t.height;a.dispatchWorkgroups(Math.ceil(s/8),Math.ceil(i/8)),a.end(),this.device.queue.submit([n.finish()])}destroy(){this.quadVertexBuffer.destroy(),this.indexBuffer.destroy(),this.instanceBuffer.destroy(),this.uniformBuffer.destroy(),this.currentStrokeTexture&&this.currentStrokeTexture.destroy(),this.compositeTextureBindGroup=null,this.previewTextureBindGroup=null,this.readbackBindGroup=null,this.backgroundBindGroup=null,this.lastReadbackTexture=null,this.lastReadbackBuffer=null,this.lastBackgroundTexture=null}}class Tg{constructor(t){y(this,"controlPoints",[]);y(this,"remainder",0);y(this,"spacing");y(this,"isFirstPoint",!0);y(this,"hasProcessedSegment",!1);this.spacing=t}addPoint(t){if(this.isFirstPoint)return this.controlPoints.push(t),this.controlPoints.push(t),this.isFirstPoint=!1,[];if(this.controlPoints.push(t),this.controlPoints.length<4)return[];const r=this.controlPoints[0],n=this.controlPoints[1],a=this.controlPoints[2],s=this.controlPoints[3],i=this.processSegment(r,n,a,s);return this.controlPoints.shift(),i}endStroke(){if(this.controlPoints.length<2)return[];const t=[];for(;this.controlPoints.length>=3;){const r=this.controlPoints[0],n=this.controlPoints[1],a=this.controlPoints[2],s=a,i=this.processSegment(r,n,a,s);t.push(...i),this.controlPoints.shift()}if(!this.hasProcessedSegment&&this.controlPoints.length>=2){const r=this.controlPoints[1],n=this.processSegment(r,r,r,r);t.push(...n)}return t}processSegment(t,r,n,a){this.hasProcessedSegment=!0;const s=[],i=Math.hypot(n.x-r.x,n.y-r.y),o=Math.max(5,Math.ceil(i));for(let c=0;c<o;c++){const p=c/o;s.push(af(t,r,n,a,p))}s.push(n);const{points:l,remainder:u}=lu(s,this.spacing,this.remainder);return this.remainder=u,l}}function Fr(e,t){const n=1+(1-t)*.5;return e*n}function xn(e,t,r){return r<=0?0:e*t/r}const $g=Hp(function(e,t){try{const r=JSON.stringify(t);rf(e,r)}catch(r){console.error("Failed to save brush to cache:",r)}},300);function Sg(e){try{const t=tf(e);return t?JSON.parse(t):null}catch(t){return console.error("Failed to load brush from cache:",t),null}}function Mg(e){const t=Ye(),r=ou();let n=null,a=null,s=null,i=null,o=null,l=null,u=null,c=null,p=null,d=null,h=0;const f=k(!1),m=new Zp({maxSize:20});function T(x,w,P,U){const D=`${x}_${w}_${P}_${U}`;if(m.has(D))return m.get(D);const q=Math.ceil(x*2),L=document.createElement("canvas"),Y=L.getContext("2d");L.width=q,L.height=q;const Q=q/2,oe=q/2,ce=x*w,X=Y.createImageData(q,q),ee=X.data,{r:Ne,g:Ge,b:wr}=Na(P),Es=x-ce;for(let Ur=0;Ur<q;Ur++){const ra=Ur+.5-oe;for(let Er=0;Er<q;Er++){const Rs=Er+.5-Q,nn=(Ur*q+Er)*4,na=Math.max(Math.abs(Rs),Math.abs(ra));let Cs=0;if(na<=ce)Cs=U;else if(na<=x){const Mc=(na-ce)/Es;Cs=U*Math.pow(1-Mc,2)}ee[nn]=Ne,ee[nn+1]=Ge,ee[nn+2]=wr,ee[nn+3]=Cs*255}}return Y.putImageData(X,0,0),m.set(D,L),L}const _=k(!1),O=k(!1),ne=k(null),Z=k(0),V=k(new Date),E=k(!0),G=k({minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0});function j(){G.value={minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function H(x,w,P){G.value.minX=Math.min(G.value.minX,x-P-2),G.value.minY=Math.min(G.value.minY,w-P-2),G.value.maxX=Math.max(G.value.maxX,x+P+2),G.value.maxY=Math.max(G.value.maxY,w+P+2)}let le=null;const pe=k(null),Ue=k((e==null?void 0:e.useDominantAxis)??!1),be=k((e==null?void 0:e.brushAdjustmentSpeed)??1),Le=Sg("maskeditor_brush_settings");Le&&(t.setBrushSize(Le.size),t.setBrushOpacity(Le.opacity),t.setBrushHardness(Le.hardness),t.brushSettings.type=Le.type,t.setBrushStepSize(Le.stepSize??5)),pr(()=>t.clearTrigger,()=>{rn()}),pr(()=>t.canvasHistory.currentStateIndex,async()=>{f.value||(await gt(),i&&o&&i.clearPreview(o))}),ep(()=>{i&&(i.destroy(),i=null),n&&(n.destroy(),n=null),a&&(a.destroy(),a=null),u&&(u.destroy(),u=null),c&&(c.destroy(),c=null),p&&(p.destroy(),p=null),d&&(d.destroy(),d=null)});async function it(){if(t.tgpuRoot){s=t.tgpuRoot.device;return}try{const x=await Kn.init();t.tgpuRoot=x,s=x.device,console.warn("✅ TypeGPU initialized! Root:",x),console.warn("Device info:",x.device.limits)}catch(x){console.warn("Failed to initialize TypeGPU:",x.message)}}function yt(x){for(let w=0;w<x.length;w+=4){const P=x[w+3]/255;x[w]=Math.round(x[w]*P),x[w+1]=Math.round(x[w+1]*P),x[w+2]=Math.round(x[w+2]*P)}}async function gt(){if(!s||!n||!a||!t.maskCanvas||!t.rgbCtx)return;const x=t.maskCanvas.width,w=t.maskCanvas.height,P=t.maskCtx.getImageData(0,0,x,w);yt(P.data),s.queue.writeTexture({texture:n},P.data,{bytesPerRow:x*4},{width:x,height:w});const U=t.rgbCtx.getImageData(0,0,x,w);yt(U.data),s.queue.writeTexture({texture:a},U.data,{bytesPerRow:x*4},{width:x,height:w})}async function Qn(){if(await it(),!t.tgpuRoot||!s){console.warn("TypeGPU not initialized, skipping GPU resource setup");return}if(!t.maskCanvas||!t.rgbCanvas||!t.maskCtx||!t.rgbCtx){console.warn("Canvas contexts not ready, skipping GPU resource setup");return}const x=t.maskCanvas.width,w=t.maskCanvas.height;try{console.warn(`🎨 Initializing GPU resources for ${x}x${w} canvas`),n=(globalThis.__TYPEGPU_AUTONAME__??(U=>U))(s.createTexture({size:[x,w],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC}),"maskTexture"),a=(globalThis.__TYPEGPU_AUTONAME__??(U=>U))(s.createTexture({size:[x,w],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC}),"rgbTexture"),await gt(),console.warn("✅ GPU resources initialized successfully");const P=navigator.gpu.getPreferredCanvasFormat();i=new bg(s,P),console.warn("✅ Brush renderer initialized")}catch(P){console.error("Failed to initialize GPU resources:",P),n=null,a=null}}function Rt(x,w){const P=t.brushSettings,U=t.maskCtx,D=t.rgbCtx;if(!U||!D)throw new Error("Canvas contexts are required");const q=P.type,L=P.size,Y=P.hardness,Q=w??P.opacity,oe=U.globalCompositeOperation==="destination-out",ce=t.currentTool;if(t.activeLayer==="rgb"&&ce&&(ce===se.Eraser||ce===se.PaintPen)){const Ge=Fr(L,Y),wr=xn(L,Y,Ge);Jn(D,x,q,Ge,wr,Q);return}const ee=Fr(L,Y),Ne=xn(L,Y,ee);ea(U,x,q,ee,Ne,Q,oe),H(x.x,x.y,ee)}function Jn(x,w,P,U,D,q){const{x:L,y:Y}=w,Q=t.rgbColor;if(P===He.Rect&&D<1){const ce=K(Q,q),X=T(U,D,ce,q);x.drawImage(X,L-U,Y-U),H(L,Y,U);return}if(D===1){const ce=K(Q,q);x.fillStyle=ce,R(x,P,L,Y,U),H(L,Y,U);return}const oe=ue(x,L,Y,U,D,Q,q,!1);x.fillStyle=oe,R(x,P,L,Y,U),H(L,Y,U)}function ea(x,w,P,U,D,q,L){const{x:Y,y:Q}=w,oe=t.maskColor;if(P===He.Rect&&D<1){const ee=L?`rgba(255, 255, 255, ${q})`:`rgba(${oe.r}, ${oe.g}, ${oe.b}, ${q})`,Ne=T(U,D,ee,q);x.drawImage(Ne,Y-U,Q-U),H(Y,Q,U);return}if(D===1){x.fillStyle=L?`rgba(255, 255, 255, ${q})`:`rgba(${oe.r}, ${oe.g}, ${oe.b}, ${q})`,R(x,P,Y,Q,U),H(Y,Q,U);return}const ce=`rgb(${oe.r}, ${oe.g}, ${oe.b})`,X=ue(x,Y,Q,U,D,ce,q,L);x.fillStyle=X,R(x,P,Y,Q,U),H(Y,Q,U)}function R(x,w,P,U,D){x.beginPath(),w===He.Rect?x.rect(P-D,U-D,D*2,D*2):x.arc(P,U,D,0,Math.PI*2,!1),x.fill()}function K(x,w){const{r:P,g:U,b:D}=nu(x);return`rgba(${P}, ${U}, ${D}, ${w})`}function ue(x,w,P,U,D,q,L,Y){if(!Number.isFinite(w)||!Number.isFinite(P)||!Number.isFinite(U))return x.createRadialGradient(0,0,0,0,0,0);const Q=x.createRadialGradient(w,P,0,w,P,U);if(Y)Q.addColorStop(0,`rgba(255, 255, 255, ${L})`),Q.addColorStop(D,`rgba(255, 255, 255, ${L})`),Q.addColorStop(1,"rgba(255, 255, 255, 0)");else{const{r:oe,g:ce,b:X}=Na(q);Q.addColorStop(0,`rgba(${oe}, ${ce}, ${X}, ${L})`),Q.addColorStop(D,`rgba(${oe}, ${ce}, ${X}, ${L})`),Q.addColorStop(1,`rgba(${oe}, ${ce}, ${X}, 0)`)}return Q}async function Re(x){if(!le)return;const w=le.addPoint(x);if(w.length===0){i&&E.value&&vr([],!0);return}if(i)vr(w,!0);else for(const P of w)Rt(P);E.value=!1}function Fe(x){const w=t.maskBlendMode,P=t.maskCtx,U=t.rgbCtx;if(!P||!U)throw new Error("Canvas contexts are required");P.beginPath(),U.beginPath(),x===zt.SourceOver?(P.fillStyle=w,P.globalCompositeOperation=zt.SourceOver,U.globalCompositeOperation=zt.SourceOver):x===zt.DestinationOut&&(P.globalCompositeOperation=zt.DestinationOut,U.globalCompositeOperation=zt.DestinationOut)}async function Ce(x,w,P,U){const{points:D,remainder:q}=lu([x,w],U,Z.value);if(Z.value=q,Fe(P),i)vr(D);else for(const L of D)Rt(L,1)}async function Xe(x){_.value=!0,j();try{i&&t.maskCanvas&&i.prepareStroke(t.maskCanvas.width,t.maskCanvas.height);let w;const P=t.currentTool,U={x:x.offsetX,y:x.offsetY},D=r.screenToCanvas(U);P==="eraser"||x.buttons===2?w=zt.DestinationOut:w=zt.SourceOver;const q=t.brushSettings.stepSize/100,L=Math.max(1,t.brushSettings.size*q);if(x.shiftKey&&ne.value?(O.value=!0,await Ce(ne.value,D,w,L)):(O.value=!1,Fe(w),Z.value=L),ne.value=D,i){const Y=t.activeLayer==="rgb";Y&&t.rgbCanvas?(t.rgbCanvas.style.opacity="0",l&&(l.style.opacity="1")):!Y&&t.maskCanvas&&(t.maskCanvas.style.opacity="0",l&&(l.style.opacity=String(t.maskOpacity)))}le=new Tg(L),await Re(D),V.value=new Date}catch(w){console.error("[useBrushDrawing] Failed to start drawing:",w),_.value=!1,O.value=!1}}async function Je(x){const w=performance.now()-V.value.getTime(),P={x:x.offsetX,y:x.offsetY},U=r.screenToCanvas(P),D=t.currentTool;w>20&&!_.value?requestAnimationFrame(async()=>{if(_.value)try{Fe(zt.SourceOver),await ta(U)}catch(q){console.error("[useBrushDrawing] Drawing error:",q)}}):requestAnimationFrame(async()=>{if(_.value)try{D==="eraser"||x.buttons===2?Fe(zt.DestinationOut):Fe(zt.SourceOver),await Re(U)}catch(q){console.error("[useBrushDrawing] Drawing error:",q)}}),V.value=new Date}async function rt(x){var U;const w={x:x.offsetX,y:x.offsetY},P=r.screenToCanvas(w);if(_.value){if(_.value=!1,ne.value=P,E.value=!0,le){const L=le.endStroke();if(L.length>0)if(i)vr(L,!0);else for(const Y of L)Rt(Y);le=null}if(i&&n&&a){const Y=t.activeLayer==="rgb"?a:n,Q=t.brushSettings.size,oe=t.brushSettings.hardness,ce=Fr(Q,oe),X=xn(Q,oe,ce),ee=t.currentTool==="eraser"||((U=t.maskCtx)==null?void 0:U.globalCompositeOperation)==="destination-out",Ne=t.brushSettings.type===He.Rect?1:0;i.compositeStroke(Y.createView(),{opacity:t.brushSettings.opacity,color:[0,0,0],hardness:X,screenSize:[t.maskCanvas.width,t.maskCanvas.height],brushShape:Ne,isErasing:ee})}let D,q;if(i&&n&&a)try{const L=await lt();D=L.maskData,q=L.rgbData}catch(L){console.warn("GPU readback failed, falling back to CPU:",L)}f.value=!0,t.canvasHistory.saveState(D,q),await tp(),f.value=!1,i&&o&&i.clearPreview(o),t.activeLayer==="rgb"&&t.rgbCanvas?t.rgbCanvas.style.opacity="1":t.activeLayer==="mask"&&t.maskCanvas&&(t.maskCanvas.style.opacity=String(t.maskOpacity)),l&&(l.style.opacity="1")}}async function Mt(x){x.preventDefault();const w={x:x.offsetX,y:x.offsetY},P=r.screenToCanvas(w);t.brushPreviewGradientVisible=!0,pe.value=P}async function ot(x){if(!pe.value)return;const w={x:x.offsetX,y:x.offsetY},P=5,U=r.screenToCanvas(w),D=U.x-pe.value.x,q=U.y-pe.value.y,L=Math.abs(D)<P?0:D,Y=Math.abs(q)<P?0:q;let Q=L,oe=Y;if(Ue.value){const Ge=Math.abs(L)/Math.abs(Y),wr=2;Ge>wr?oe=0:Ge<1/wr&&(Q=0)}const ce=Math.max(-100,Math.min(100,Q)),X=Math.max(-100,Math.min(100,oe)),ee=Math.max(1,Math.min(500,t.brushSettings.size+ce/35*be.value)),Ne=Math.max(0,Math.min(1,t.brushSettings.hardness-X/4e3*be.value));t.setBrushSize(ee),t.setBrushHardness(Ne)}function et(){$g("maskeditor_brush_settings",t.brushSettings)}async function lt(){if(!s||!n||!a||!t.maskCanvas||!t.rgbCanvas||!t.maskCtx||!t.rgbCtx||!i)throw new Error("GPU resources not ready");const x=t.maskCanvas.width,w=t.maskCanvas.height,P=x*w*4;(!u||!c||!p||!d||h!==P)&&(u==null||u.destroy(),c==null||c.destroy(),p==null||p.destroy(),d==null||d.destroy(),u=(globalThis.__TYPEGPU_AUTONAME__??(ee=>ee))(s.createBuffer({size:P,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),"readbackStorageMask"),c=(globalThis.__TYPEGPU_AUTONAME__??(ee=>ee))(s.createBuffer({size:P,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),"readbackStorageRgb"),p=(globalThis.__TYPEGPU_AUTONAME__??(ee=>ee))(s.createBuffer({size:P,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),"readbackStagingMask"),d=(globalThis.__TYPEGPU_AUTONAME__??(ee=>ee))(s.createBuffer({size:P,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),"readbackStagingRgb"),h=P),i.prepareReadback(n,u),i.prepareReadback(a,c);const U=s.createCommandEncoder();U.copyBufferToBuffer(u,0,p,0,P),U.copyBufferToBuffer(c,0,d,0,P),s.queue.submit([U.finish()]),await Promise.all([p.mapAsync(GPUMapMode.READ),d.mapAsync(GPUMapMode.READ)]);const D=new Uint8ClampedArray(p.getMappedRange().slice(0)),q=new Uint8ClampedArray(d.getMappedRange().slice(0));p.unmap(),d.unmap();const L=new ImageData(D,x,w),Y=new ImageData(q,x,w);let Q=0,oe=0,ce=x,X=w;if(G.value.minX!==1/0&&G.value.maxX!==-1/0){const ee=G.value;Q=Math.floor(Math.max(0,ee.minX)),oe=Math.floor(Math.max(0,ee.minY));const Ne=Math.ceil(Math.min(x,ee.maxX)),Ge=Math.ceil(Math.min(w,ee.maxY));ce=Ne-Q,X=Ge-oe}return ce>0&&X>0?(t.maskCtx.putImageData(L,0,0,Q,oe,ce,X),t.rgbCtx.putImageData(Y,0,0,Q,oe,ce,X)):(t.maskCtx.putImageData(L,0,0),t.rgbCtx.putImageData(Y,0,0)),{maskData:L,rgbData:Y}}function kt(){i==null||i.destroy(),n&&(n.destroy(),n=null),a&&(a.destroy(),a=null),u==null||u.destroy(),c==null||c.destroy(),p==null||p.destroy(),d==null||d.destroy(),u=null,c=null,p=null,d=null,h=0,t.tgpuRoot&&(t.tgpuRoot.destroy(),t.tgpuRoot=null),s=null}async function ta(x,w=1){var P;if(i){const U=t.maskCanvas.width,D=t.maskCanvas.height,q=[{x:x.x,y:x.y,pressure:w}],L=t.brushSettings.size,Y=t.brushSettings.hardness,Q=Fr(L,Y),oe=xn(L,Y,Q),ce=t.brushSettings.type===He.Rect?1:0;if(i.renderStrokeToAccumulator(q,{size:Q,opacity:.5,hardness:oe,color:[1,1,1],width:U,height:D,brushShape:ce}),n&&o){const X=t.activeLayer==="rgb";let ee=[1,1,1];if(X){const Ge=Na(t.rgbColor);ee=[Ge.r/255,Ge.g/255,Ge.b/255]}else{const Ge=t.maskColor;ee=[Ge.r/255,Ge.g/255,Ge.b/255]}const Ne=t.currentTool==="eraser"||((P=t.maskCtx)==null?void 0:P.globalCompositeOperation)==="destination-out";i.blitToCanvas(o,{opacity:t.brushSettings.opacity,color:ee,hardness:oe,screenSize:[U,D],brushShape:ce,isErasing:Ne},void 0)}}else Rt(x,w)}function tn(x){if(!s)return;const w=x.getContext("webgpu");w&&(w.configure({device:s,format:navigator.gpu.getPreferredCanvasFormat(),alphaMode:"premultiplied"}),o=w,l=x,console.warn("✅ Preview Canvas Initialized"))}function vr(x,w=!1){var ce;if(!i||!n||!a)return;const P=t.activeLayer==="rgb";let U=[1,1,1];if(P){const X=Na(t.rgbColor);U=[X.r/255,X.g/255,X.b/255]}else{const X=t.maskColor;U=[X.r/255,X.g/255,X.b/255]}let D=[];if(w)D=x.map(X=>({x:X.x,y:X.y,pressure:1}));else for(let X=0;X<x.length-1;X++){const ee=x[X],Ne=x[X+1],Ge=Math.hypot(Ne.x-ee.x,Ne.y-ee.y),wr=t.brushSettings.stepSize/100,Es=Math.max(1,t.brushSettings.size*wr),Ur=Math.max(1,Math.ceil(Ge/Es));for(let ra=0;ra<=Ur;ra++){const Er=ra/Ur,Rs=1,nn=ee.x+(Ne.x-ee.x)*Er,na=ee.y+(Ne.y-ee.y)*Er;D.push({x:nn,y:na,pressure:Rs})}}const q=t.brushSettings.size,L=t.brushSettings.hardness,Y=Fr(q,L),Q=xn(q,L,Y),oe=t.brushSettings.type===He.Rect?1:0;i.renderStrokeToAccumulator(D,{size:Y,opacity:.5,hardness:Q,color:U,width:t.maskCanvas.width,height:t.maskCanvas.height,brushShape:oe});for(const X of D)H(X.x,X.y,Y);if(o){const X=t.currentTool==="eraser"||((ce=t.maskCtx)==null?void 0:ce.globalCompositeOperation)==="destination-out",ee=P?a:n;i.blitToCanvas(o,{opacity:t.brushSettings.opacity,color:U,hardness:Q,screenSize:[t.maskCanvas.width,t.maskCanvas.height],brushShape:oe,isErasing:X},ee??void 0)}}function rn(){if(!s||!n||!a||!t.maskCanvas)return;const x=t.maskCanvas.width,w=t.maskCanvas.height;s.queue.writeTexture({texture:n},new Uint8Array(x*w*4),{bytesPerRow:x*4},{width:x,height:w}),s.queue.writeTexture({texture:a},new Uint8Array(x*w*4),{bytesPerRow:x*4},{width:x,height:w})}return{startDrawing:Xe,handleDrawing:Je,drawEnd:rt,startBrushAdjustment:Mt,handleBrushAdjustment:ot,saveBrushSettings:et,destroy:kt,initGPUResources:Qn,initPreviewCanvas:tn,clearGPU:rn}}const Ja=(e,t,r,n)=>e[(r*n+t)*4+3],la=(e,t,r,n)=>{const a=(r*n+t)*4;return{r:e[a],g:e[a+1],b:e[a+2]}},Ws=(e,t,r,n,a,s)=>{const i=(r*n+t)*4;e[i]=s.r,e[i+1]=s.g,e[i+2]=s.b,e[i+3]=a},Co=(e,t,r)=>{e/=255,t/=255,r/=255;const n=Math.max(e,t,r),a=Math.min(e,t,r);let s=0,i=0;const o=(n+a)/2;if(n!==a){const l=n-a;switch(i=o>.5?l/(2-n-a):l/(n+a),n){case e:s=(t-r)/l+(t<r?6:0);break;case t:s=(r-e)/l+2;break;case r:s=(e-t)/l+4;break}s/=6}return{h:s*360,s:i*100,l:o*100}},Ao=e=>{let t=e.r/255,r=e.g/255,n=e.b/255;t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92,n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92,t*=100,r*=100,n*=100;const a=t*.4124+r*.3576+n*.1805,s=t*.2126+r*.7152+n*.0722,i=t*.0193+r*.1192+n*.9505,c=[a/95.047,s/100,i/108.883];for(let p=0;p<c.length;p++)c[p]=c[p]>.008856?Math.pow(c[p],1/3):7.787*c[p]+16/116;return{l:116*c[1]-16,a:500*(c[0]-c[1]),b:200*(c[1]-c[2])}},Oo=(e,t,r)=>Math.sqrt(Math.pow(e.r-t.r,2)+Math.pow(e.g-t.g,2)+Math.pow(e.b-t.b,2))<=r,kg=(e,t,r)=>{const n=Co(e.r,e.g,e.b),a=Co(t.r,t.g,t.b),s=Math.abs(n.h-a.h),i=Math.abs(n.s-a.s),o=Math.abs(n.l-a.l);return Math.sqrt(Math.pow(s/360*255,2)+Math.pow(i/100*255,2)+Math.pow(o/100*255,2))<=r},_g=(e,t,r)=>{const n=Ao(e),a=Ao(t);return Math.sqrt(Math.pow(n.l-a.l,2)+Math.pow(n.a-a.a,2)+Math.pow(n.b-a.b,2))/100*255<=r},Ys=(e,t,r,n)=>{switch(n){case Hr.Simple:return Oo(e,t,r);case Hr.HSL:return kg(e,t,r);case Hr.LAB:return _g(e,t,r);default:return Oo(e,t,r)}};function Bg(){const e=Ye(),t=k(null),r=o=>{const l=e.maskCtx,u=e.maskCanvas;if(!l||!u)return;const c=Math.floor(o.x),p=Math.floor(o.y),d=u.width,h=u.height;if(c<0||c>=d||p<0||p>=h)return;const f=l.getImageData(0,0,d,h),m=f.data,T=Ja(m,c,p,d),_=T!==255;if(T===-1)return;const O=e.maskColor,ne=e.paintBucketTolerance,Z=Math.floor(e.fillOpacity/100*255),V=[],E=new Uint8Array(d*h),G=(j,H,le,pe)=>j===-1?!1:pe?j!==255&&Math.abs(j-H)<=le:j===255||Math.abs(j-H)<=le;for(G(T,T,ne,_)&&V.push([c,p]);V.length>0;){const[j,H]=V.pop(),le=H*d+j;if(E[le])continue;const pe=Ja(m,j,H,d);if(!G(pe,T,ne,_))continue;E[le]=1,Ws(m,j,H,d,_?Z:0,O);const Ue=(be,Le)=>{if(!(be<0||be>=d||Le<0||Le>=h)&&!E[Le*d+be]){const it=Ja(m,be,Le,d);G(it,T,ne,_)&&V.push([be,Le])}};Ue(j-1,H),Ue(j+1,H),Ue(j,H-1),Ue(j,H+1)}l.putImageData(f,0,0),e.canvasHistory.saveState()},n=async o=>{const l=e.maskCtx,u=e.imgCtx,c=e.imgCanvas;if(!l||!u||!c)return;const p=c.width,d=c.height;t.value=o;const h=l.getImageData(0,0,p,d),f=h.data,m=u.getImageData(0,0,p,d).data,T=e.colorSelectTolerance,_=e.colorComparisonMethod,O=e.maskColor,ne=Math.floor(e.selectionOpacity/100*255),Z=e.applyWholeImage,V=e.maskBoundary,E=e.maskTolerance;if(Z){const G=la(m,Math.floor(o.x),Math.floor(o.y),p),j=1e4;for(let H=0;H<p*d;H+=j){const le=Math.min(H+j,p*d);for(let pe=H;pe<le;pe++){const Ue=pe%p,be=Math.floor(pe/p);Ys(la(m,Ue,be,p),G,T,_)&&Ws(f,Ue,be,p,ne,O)}await new Promise(pe=>setTimeout(pe,0))}}else{const G=Math.floor(o.x),j=Math.floor(o.y);if(G<0||G>=p||j<0||j>=d)return;const H=la(m,G,j,p),le=[],pe=new Uint8Array(p*d);for(le.push([G,j]);le.length>0;){const[Ue,be]=le.pop(),Le=be*p+Ue;if(pe[Le]||!Ys(la(m,Ue,be,p),H,T,_))continue;pe[Le]=1,Ws(f,Ue,be,p,ne,O);const it=(yt,gt)=>{yt<0||yt>=p||gt<0||gt>=d||pe[gt*p+yt]||Ys(la(m,yt,gt,p),H,T,_)&&(V&&255-Ja(f,yt,gt,p)<=E||le.push([yt,gt]))};it(Ue-1,be),it(Ue+1,be),it(Ue,be-1),it(Ue,be+1)}}l.putImageData(h,0,0),e.canvasHistory.saveState()},a=()=>{const o=e.maskCtx,l=e.maskCanvas;if(!o||!l)return;const u=o.getImageData(0,0,l.width,l.height),c=u.data;let p=0,d=0,h=0;for(let f=0;f<c.length;f+=4)if(c[f+3]>0){p=c[f],d=c[f+1],h=c[f+2];break}for(let f=0;f<c.length;f+=4){const m=c[f+3];c[f+3]=255-m,m===0&&(c[f]=p,c[f+1]=d,c[f+2]=h)}o.putImageData(u,0,0),e.canvasHistory.saveState()},s=()=>{const o=e.maskCtx,l=e.maskCanvas,u=e.rgbCtx,c=e.rgbCanvas;o&&l&&o.clearRect(0,0,l.width,l.height),u&&c&&u.clearRect(0,0,c.width,c.height),e.canvasHistory.saveState()},i=()=>{t.value=null};return pr([()=>e.colorSelectTolerance,()=>e.colorComparisonMethod,()=>e.selectionOpacity],async()=>{t.value&&e.colorSelectLivePreview&&e.canUndo&&(e.canvasHistory.undo(),await n(t.value))}),{paintBucketFill:r,colorSelectFill:n,clearLastColorSelectPoint:i,invertMask:a,clearMask:s}}function Pg(e,t){const r=Ye(),n=ou(),a=Mg({useDominantAxis:Kr.extensionManager.setting.get("Comfy.MaskEditor.UseDominantAxis"),brushAdjustmentSpeed:Kr.extensionManager.setting.get("Comfy.MaskEditor.BrushAdjustmentSpeed")}),s=Bg(),i=k(null),o={[se.MaskPen]:{newActiveLayerOnSet:"mask"},[se.Eraser]:{},[se.PaintPen]:{newActiveLayerOnSet:"rgb"},[se.MaskBucket]:{cursor:"url('/cursor/paintBucket.png') 30 25, auto",newActiveLayerOnSet:"mask"},[se.MaskColorFill]:{cursor:"url('/cursor/colorSelect.png') 15 25, auto",newActiveLayerOnSet:"mask"}},l=f=>{r.activeLayer=f;const m=r.currentTool;[se.MaskPen,se.MaskBucket,se.MaskColorFill].includes(m)&&f==="rgb"&&u(se.PaintPen),m===se.PaintPen&&f==="mask"&&u(se.MaskPen)},u=f=>{r.currentTool=f;const m=o[f].newActiveLayerOnSet;m&&(r.activeLayer=m);const T=o[f].cursor,_=r.pointerZone;T&&_?(r.brushVisible=!1,_.style.cursor=T):_&&(r.brushVisible=!0,_.style.cursor="none")},c=()=>{const f=r.currentTool,m=o[f].cursor,T=r.pointerZone;m&&T?(r.brushVisible=!1,T.style.cursor=m):T&&(r.brushVisible=!0,T.style.cursor="none"),r.brushPreviewGradientVisible=!1};return pr(()=>r.currentTool,f=>{f!==se.MaskColorFill&&s.clearLastColorSelectPoint()}),{switchTool:u,setActiveLayer:l,updateCursor:c,handlePointerDown:async f=>{if(f.preventDefault(),f.pointerType==="touch")return;const m=e.isKeyDown(" ");if(f.buttons===4||f.buttons===1&&m){t.handlePanStart(f),r.brushVisible=!1;return}if(r.currentTool===se.PaintPen&&f.button===0){await a.startDrawing(f);return}if(r.currentTool===se.PaintPen&&f.buttons===1){await a.handleDrawing(f);return}if(r.currentTool===se.MaskBucket&&f.button===0){const _={x:f.offsetX,y:f.offsetY},O=n.screenToCanvas(_);s.paintBucketFill(O);return}if(r.currentTool===se.MaskColorFill&&f.button===0){const _={x:f.offsetX,y:f.offsetY},O=n.screenToCanvas(_);await s.colorSelectFill(O);return}if(f.altKey&&f.button===2){r.isAdjustingBrush=!0,await a.startBrushAdjustment(f);return}const T=[se.MaskPen,se.Eraser,se.PaintPen].includes(r.currentTool);if([0,2].includes(f.button)&&T){await a.startDrawing(f);return}},handlePointerMove:async f=>{if(f.preventDefault(),f.pointerType==="touch")return;const m={x:f.clientX,y:f.clientY};t.updateCursorPosition(m);const T=e.isKeyDown(" ");if(f.buttons===4||f.buttons===1&&T){await t.handlePanMove(f);return}if([se.MaskPen,se.Eraser,se.PaintPen].includes(r.currentTool)){if(r.isAdjustingBrush&&(r.currentTool===se.MaskPen||r.currentTool===se.Eraser)&&f.altKey&&f.buttons===2){await a.handleBrushAdjustment(f);return}if(f.buttons===1||f.buttons===2){await a.handleDrawing(f);return}}},handlePointerUp:async f=>{r.isPanning=!1,r.brushVisible=!0,f.pointerType!=="touch"&&(c(),r.isAdjustingBrush=!1,await a.drawEnd(f),i.value=null)},brushDrawing:a}}const zg=Ts("dialog",()=>{const e=k([]),t=k(null),r=()=>`dialog-${Math.random().toString(36).slice(2,9)}`;function n(p){const d=e.value.findIndex(h=>h.priority<=p.priority);e.value.splice(d===-1?e.value.length:d,0,p)}function a(p){const d=p.key,h=e.value.findIndex(f=>f.key===d);if(h!==-1){const[f]=e.value.splice(h,1);n(f),t.value=d,o()}}function s(p){var f,m;const d=p?e.value.find(T=>T.key===p.key):e.value.find(T=>T.key===t.value);if(!d)return;(m=(f=d.dialogComponentProps)==null?void 0:f.onClose)==null||m.call(f);const h=e.value.indexOf(d);e.value.splice(h,1),t.value=e.value.length>0?e.value[e.value.length-1].key:null,o()}function i(p){var h;e.value.length>=10&&e.value.shift();const d={key:p.key,visible:!0,title:p.title,headerComponent:p.headerComponent?Ls(p.headerComponent):void 0,footerComponent:p.footerComponent?Ls(p.footerComponent):void 0,component:Ls(p.component),contentProps:{...p.props},footerProps:{...p.footerProps},priority:p.priority??1,dialogComponentProps:{maximizable:!1,modal:!0,closable:!0,closeOnEscape:!0,dismissableMask:!0,...p.dialogComponentProps,maximized:!1,onMaximize:()=>{d.dialogComponentProps.maximized=!0},onUnmaximize:()=>{d.dialogComponentProps.maximized=!1},onAfterHide:()=>{s(d)},pt:Jp(((h=p.dialogComponentProps)==null?void 0:h.pt)||{},{root:{onMousedown:()=>{a(d)}}})}};return n(d),t.value=p.key,o(),d}function o(){const p=e.value.find(h=>h.key===t.value),d=p==null?void 0:p.dialogComponentProps.closable;e.value.forEach(h=>{h.dialogComponentProps={...h.dialogComponentProps,closeOnEscape:h===p&&!!d}})}function l(p){const d=p.key||r();let h=e.value.find(f=>f.key===d);return h?(h.visible=!0,a(h)):h=i({...p,key:d}),h}function u(p){const{key:d}=p;if(!d){console.error("Extension dialog key is required");return}const h=d.startsWith("extension-")?d:`extension-${d}`,f=e.value.find(m=>m.key===h);return f?(f.visible=!0,a(f),f):i({...p,key:h})}function c(p){return e.value.some(d=>d.key===p)}return{dialogStack:e,riseDialog:a,showDialog:l,closeDialog:s,showExtensionDialog:u,isDialogOpen:c,activeKey:t}}),Ig=mt({__name:"BrushCursor",props:{containerRef:{}},setup(e){const t=Ye(),r=Me(()=>t.brushVisible?1:0),n=Me(()=>{const c=t.brushSettings.size,p=t.brushSettings.hardness;return Fr(c,p)*t.zoomRatio}),a=Me(()=>n.value*2),s=Me(()=>{var d;const c=(d=e.containerRef)==null?void 0:d.getBoundingClientRect(),p=(c==null?void 0:c.left)||0;return t.cursorPoint.x+t.panOffset.x-n.value-p}),i=Me(()=>{var d;const c=(d=e.containerRef)==null?void 0:d.getBoundingClientRect(),p=(c==null?void 0:c.top)||0;return t.cursorPoint.y+t.panOffset.y-n.value-p}),o=Me(()=>t.brushSettings.type===He.Rect?"0%":"50%"),l=Me(()=>t.brushPreviewGradientVisible),u=Me(()=>{const c=t.brushSettings.size,p=t.brushSettings.hardness,d=Fr(c,p),h=xn(c,p,d);if(h===1)return"rgba(255, 0, 0, 0.5)";const f=h*100,m=100,T=f+(m-f)*.5;return`radial-gradient(
    circle,
    rgba(255, 0, 0, 0.5) 0%,
    rgba(255, 0, 0, 0.5) ${f}%,
    rgba(255, 0, 0, 0.125) ${T}%,
    rgba(255, 0, 0, 0) ${m}%
  )`});return(c,p)=>(xe(),je("div",{id:"maskEditor_brush",style:Mr({position:"absolute",opacity:r.value,width:`${a.value}px`,height:`${a.value}px`,left:`${s.value}px`,top:`${i.value}px`,borderRadius:o.value,pointerEvents:"none",zIndex:1e3})},[A("div",{id:"maskEditor_brushPreviewGradient",style:Mr({display:l.value?"block":"none",background:u.value})},null,4)],4))}}),Ug=mt({__name:"PointerZone",props:{toolManager:{},panZoom:{}},setup(e){const t=Ye(),r=k();$i(()=>{if(!r.value){console.error("[PointerZone] Pointer zone ref not initialized");return}t.pointerZone=r.value}),pr(()=>t.isPanning,d=>{r.value&&(d?r.value.style.cursor="grabbing":e.toolManager.updateCursor())});const n=async d=>{await e.toolManager.handlePointerDown(d)},a=async d=>{await e.toolManager.handlePointerMove(d)},s=d=>{e.toolManager.handlePointerUp(d)},i=()=>{t.brushVisible=!1,r.value&&(r.value.style.cursor="")},o=()=>{e.toolManager.updateCursor()},l=d=>{e.panZoom.handleTouchStart(d)},u=async d=>{await e.panZoom.handleTouchMove(d)},c=d=>{e.panZoom.handleTouchEnd(d)},p=async d=>{await e.panZoom.zoom(d);const h={x:d.clientX,y:d.clientY};e.panZoom.updateCursorPosition(h)};return(d,h)=>(xe(),je("div",{ref_key:"pointerZoneRef",ref:r,class:"w-[calc(100%-4rem-220px)] h-full",onPointerdown:n,onPointermove:a,onPointerup:s,onPointerleave:i,onPointerenter:o,onTouchstart:l,onTouchmove:u,onTouchend:c,onWheel:p,onContextmenu:h[0]||(h[0]=wn(()=>{},["prevent"]))},null,544))}}),Eg={"g.save":"Save","g.saving":"Saving...","g.cancel":"Cancel","g.undo":"Undo","g.redo":"Redo","maskeditor.invert":"Invert","maskeditor.clear":"Clear"};function de(e){return Eg[e]||e}const Rg={class:"flex flex-col gap-3 pb-3"},Cg={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},Ag=["min","max","step","value"],er=mt({__name:"SliderControl",props:{label:{},min:{},max:{},step:{default:1},modelValue:{}},emits:["update:modelValue"],setup(e,{emit:t}){const r=t,n=a=>{const s=Number(a.target.value);r("update:modelValue",s)};return(a,s)=>(xe(),je("div",Rg,[A("span",Cg,Pe(e.label),1),A("input",{type:"range",class:"maskEditor_sidePanelBrushRange",min:e.min,max:e.max,step:e.step,value:e.modelValue,onInput:n},null,40,Ag)]))}}),Og={class:"flex flex-col gap-3 pb-3"},Lg={class:"text-center text-[15px] font-sans text-[var(--descrip-text)] mt-2.5"},Fg={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},Gg={class:"flex flex-row gap-2.5 items-center min-h-6 relative h-[50px] w-full rounded-[10px] -mt-2 -mb-1.5"},Dg=["value"],Vg={value:"black"},jg={value:"white"},Ng={value:"negative"},qg={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},Wg=["checked"],Yg={class:"maskEditor_sidePanelLayerPreviewContainer"},Zg={viewBox:"0 0 20 20",style:{}},Xg=["disabled"],Hg={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},Kg=["checked"],Qg=["disabled"],Jg={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},ev={class:"flex flex-row gap-2.5 items-center min-h-6 relative h-[50px] w-full rounded-[10px] bg-[var(--p-surface-300)] dark-theme:bg-[var(--p-surface-800)]"},tv=["checked"],rv={class:"maskEditor_sidePanelLayerPreviewContainer"},nv=["src","alt"],av=mt({__name:"ImageLayerSettingsPanel",props:{toolManager:{}},setup(e){const t=Ye(),r=ru(),n=k(!0),a=k(!0),s=k(!0),i=Me(()=>{var f;return((f=t.image)==null?void 0:f.src)??""}),o=Me(()=>t.currentTool===se.Eraser),l=f=>{const m=f.target.checked;n.value=m;const T=t.maskCanvas;T&&(T.style.opacity=m?String(t.maskOpacity):"0")},u=f=>{const m=f.target.checked;a.value=m;const T=t.rgbCanvas;T&&(T.style.opacity=m?"1":"0")},c=f=>{const m=f.target.checked;s.value=m;const T=t.imgCanvas;T&&(T.style.opacity=m?"1":"0")},p=f=>{t.setMaskOpacity(f);const m=t.maskCanvas;m&&(m.style.opacity=String(f)),n.value=f!==0},d=async f=>{const m=f.target.value;let T;switch(m){case"white":T=xt.White;break;case"negative":T=xt.Negative;break;default:T=xt.Black}t.maskBlendMode=T,await r.updateMaskColor()},h=f=>{var m;(m=e.toolManager)==null||m.setActiveLayer(f)};return(f,m)=>(xe(),je("div",Og,[A("h3",Lg,Pe(I(de)("maskEditor.layers")),1),tt(er,{label:I(de)("maskEditor.maskOpacity"),min:0,max:1,step:.01,"model-value":I(t).maskOpacity,"onUpdate:modelValue":p},null,8,["label","model-value"]),A("span",Fg,Pe(I(de)("maskEditor.maskBlendingOptions")),1),A("div",Gg,[A("select",{class:"maskEditor_sidePanelDropdown",value:I(t).maskBlendMode,onChange:d},[A("option",Vg,Pe(I(de)("maskEditor.black")),1),A("option",jg,Pe(I(de)("maskEditor.white")),1),A("option",Ng,Pe(I(de)("maskEditor.negative")),1)],40,Dg)]),A("span",qg,Pe(I(de)("maskEditor.maskLayer")),1),A("div",{class:"flex flex-row gap-2.5 items-center min-h-6 relative h-[50px] w-full rounded-[10px] bg-[var(--p-surface-300)] dark-theme:bg-[var(--p-surface-800)]",style:Mr({border:I(t).activeLayer==="mask"?"2px solid #007acc":"none"})},[A("input",{type:"checkbox",class:"maskEditor_sidePanelLayerCheckbox",checked:n.value,onChange:l},null,40,Wg),A("div",Yg,[(xe(),je("svg",Zg,[...m[2]||(m[2]=[A("path",{class:"cls-1",d:"M1.31,5.32v9.36c0,.55.45,1,1,1h15.38c.55,0,1-.45,1-1V5.32c0-.55-.45-1-1-1H2.31c-.55,0-1,.45-1,1ZM11.19,13.44c-2.91.94-5.57-1.72-4.63-4.63.34-1.05,1.19-1.9,2.24-2.24,2.91-.94,5.57,1.72,4.63,4.63-.34,1.05-1.19-1.9-2.24,2.24Z"},null,-1)])]))]),A("button",{style:Mr([{"font-size":"12px"},{opacity:I(t).activeLayer==="mask"?"0.5":"1"}]),disabled:I(t).activeLayer==="mask",onClick:m[0]||(m[0]=T=>h("mask"))},Pe(I(de)("maskEditor.activateLayer")),13,Xg)],4),A("span",Hg,Pe(I(de)("maskEditor.paintLayer")),1),A("div",{class:"flex flex-row gap-2.5 items-center min-h-6 relative h-[50px] w-full rounded-[10px] bg-[var(--p-surface-300)] dark-theme:bg-[var(--p-surface-800)]",style:Mr({border:I(t).activeLayer==="rgb"?"2px solid #007acc":"none"})},[A("input",{type:"checkbox",class:"maskEditor_sidePanelLayerCheckbox",checked:a.value,onChange:u},null,40,Kg),m[3]||(m[3]=A("div",{class:"maskEditor_sidePanelLayerPreviewContainer"},[A("svg",{viewBox:"0 0 20 20"},[A("path",{class:"cls-1",d:"M 17 6.965 c 0 0.235 -0.095 0.47 -0.275 0.655 l -6.51 6.52 c -0.045 0.035 -0.09 0.075 -0.135 0.11 c -0.035 -0.695 -0.605 -1.24 -1.305 -1.245 c 0.035 -0.06 0.08 -0.12 0.135 -0.17 l 6.52 -6.52 c 0.36 -0.36 0.945 -0.36 1.3 0 c 0.175 0.175 0.275 0.415 0.275 0.65 Z"}),A("path",{class:"cls-1",d:"M 9.82 14.515 c 0 2.23 -3.23 1.59 -4.82 0 c 1.65 -0.235 2.375 -1.29 3.53 -1.29 c 0.715 0 1.29 0.58 1.29 1.29 Z"})])],-1)),A("button",{style:Mr([{"font-size":"12px"},{opacity:I(t).activeLayer==="rgb"?"0.5":"1",display:o.value?"block":"none"}]),disabled:I(t).activeLayer==="rgb",onClick:m[1]||(m[1]=T=>h("rgb"))},Pe(I(de)("maskEditor.activateLayer")),13,Qg)],4),A("span",Jg,Pe(I(de)("maskEditor.baseImageLayer")),1),A("div",ev,[A("input",{type:"checkbox",class:"maskEditor_sidePanelLayerCheckbox",checked:s.value,onChange:c},null,40,tv),A("div",rv,[A("img",{class:"maskEditor_sidePanelImageLayerImage",src:i.value,alt:I(de)("maskEditor.baseLayerPreview")},null,8,nv)])])]))}}),sv={class:"flex flex-col gap-3 pb-3"},iv={class:"text-center text-[15px] font-sans text-[var(--descrip-text)] mt-2.5"},ov={class:"flex flex-col gap-3 pb-3"},lv={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},uv={class:"flex flex-row gap-2.5 items-center min-h-6 relative h-[50px] w-full rounded-[10px] bg-[var(--p-surface-300)] dark-theme:bg-[var(--p-surface-800)]"},cv={class:"flex flex-col gap-3 pb-3"},pv={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},fv=["value"],dv=mt({__name:"BrushSettingsPanel",setup(e){const t=Ye(),r=u=>{t.brushSettings.type=u},n=u=>{t.rgbColor=u.target.value},a=u=>{t.setBrushSize(u)},s=u=>{t.setBrushOpacity(u)},i=u=>{t.setBrushHardness(u)},o=u=>{t.setBrushStepSize(u)},l=()=>{t.resetBrushToDefault()};return(u,c)=>(xe(),je("div",sv,[A("h3",iv,Pe(I(de)("maskEditor.brushSettings")),1),A("button",{class:"w-45 h-7.5 border-none bg-black/20 border border-[var(--border-color)] text-[var(--input-text)] font-sans text-[15px] pointer-events-auto transition-colors duration-100 hover:bg-[var(--p-overlaybadge-outline-color)] hover:border-none",onClick:l},Pe(I(de)("maskEditor.resetToDefault")),1),A("div",ov,[A("span",lv,Pe(I(de)("maskEditor.brushShape")),1),A("div",uv,[A("div",{class:fs(["maskEditor_sidePanelBrushShapeCircle bg-transparent hover:bg-[var(--comfy-menu-bg)] dark-theme:hover:bg-[var(--p-surface-900)]",{active:I(t).brushSettings.type===I(He).Arc}]),style:Mr({background:I(t).brushSettings.type===I(He).Arc?"var(--p-button-text-primary-color)":""}),onClick:c[0]||(c[0]=p=>r(I(He).Arc))},null,6),A("div",{class:fs(["maskEditor_sidePanelBrushShapeSquare bg-transparent hover:bg-[var(--comfy-menu-bg)] dark-theme:hover:bg-[var(--p-surface-900)]",{active:I(t).brushSettings.type===I(He).Rect}]),style:Mr({background:I(t).brushSettings.type===I(He).Rect?"var(--p-button-text-primary-color)":""}),onClick:c[1]||(c[1]=p=>r(I(He).Rect))},null,6)])]),A("div",cv,[A("span",pv,Pe(I(de)("maskEditor.colorSelector")),1),A("input",{type:"color",value:I(t).rgbColor,onInput:n},null,40,fv)]),tt(er,{label:I(de)("maskEditor.thickness"),min:1,max:500,step:1,"model-value":I(t).brushSettings.size,"onUpdate:modelValue":a},null,8,["label","model-value"]),tt(er,{label:I(de)("maskEditor.opacity"),min:0,max:1,step:.01,"model-value":I(t).brushSettings.opacity,"onUpdate:modelValue":s},null,8,["label","model-value"]),tt(er,{label:I(de)("maskEditor.hardness"),min:0,max:1,step:.01,"model-value":I(t).brushSettings.hardness,"onUpdate:modelValue":i},null,8,["label","model-value"]),tt(er,{label:"Stepsize",min:1,max:100,step:1,"model-value":I(t).brushSettings.stepSize,"onUpdate:modelValue":o},null,8,["model-value"])]))}}),hv={class:"flex flex-row gap-2.5 items-center min-h-6 relative"},mv={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},yv=["value"],gv=["value"],vv=mt({__name:"DropdownControl",props:{label:{},options:{},modelValue:{}},emits:["update:modelValue"],setup(e,{emit:t}){const r=e,n=t,a=Me(()=>r.options.map(i=>typeof i=="string"?{label:i,value:i}:i)),s=i=>{const o=i.target.value;n("update:modelValue",o)};return(i,o)=>(xe(),je("div",hv,[A("span",mv,Pe(e.label),1),A("select",{class:"absolute right-0 h-6 px-1.5 rounded-md border border-[var(--p-form-field-border-color)] transition-colors duration-100 bg-[var(--comfy-menu-bg)] focus:outline focus:outline-1 focus:outline-[var(--p-surface-300)] dark-theme:bg-[var(--p-surface-900)] dark-theme:focus:outline-[var(--p-button-text-primary-color)]",value:e.modelValue,onChange:s},[(xe(!0),je(Yl,null,Zl(a.value,l=>(xe(),je("option",{key:l.value,value:l.value},Pe(l.label),9,gv))),128))],40,yv)]))}}),wv={class:"flex flex-row gap-2.5 items-center min-h-6 relative"},xv={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},bv={class:"maskEditor_sidePanelToggleContainer"},Tv=["checked"],Zs=mt({__name:"ToggleControl",props:{label:{},modelValue:{type:Boolean}},emits:["update:modelValue"],setup(e,{emit:t}){const r=t,n=a=>{const s=a.target.checked;r("update:modelValue",s)};return(a,s)=>(xe(),je("div",wv,[A("span",xv,Pe(e.label),1),A("label",bv,[A("input",{type:"checkbox",class:"maskEditor_sidePanelToggleCheckbox",checked:e.modelValue,onChange:n},null,40,Tv),s[0]||(s[0]=A("div",{class:"maskEditor_sidePanelToggleSwitch"},null,-1))])]))}}),$v={class:"flex flex-col gap-3 pb-3"},Sv={class:"text-center text-[15px] font-sans text-[var(--descrip-text)] mt-2.5"},Mv=mt({__name:"ColorSelectSettingsPanel",setup(e){const t=Ye(),r=Object.values(Hr),n=c=>{t.setColorSelectTolerance(c)},a=c=>{t.setSelectionOpacity(c)},s=c=>{t.colorSelectLivePreview=c},i=c=>{t.applyWholeImage=c},o=c=>{t.colorComparisonMethod=c},l=c=>{t.maskBoundary=c},u=c=>{t.setMaskTolerance(c)};return(c,p)=>(xe(),je("div",$v,[A("h3",Sv,Pe(I(de)("maskEditor.colorSelectSettings")),1),tt(er,{label:I(de)("maskEditor.tolerance"),min:0,max:255,step:1,"model-value":I(t).colorSelectTolerance,"onUpdate:modelValue":n},null,8,["label","model-value"]),tt(er,{label:I(de)("maskEditor.selectionOpacity"),min:0,max:100,step:1,"model-value":I(t).selectionOpacity,"onUpdate:modelValue":a},null,8,["label","model-value"]),tt(Zs,{label:I(de)("maskEditor.livePreview"),"model-value":I(t).colorSelectLivePreview,"onUpdate:modelValue":s},null,8,["label","model-value"]),tt(Zs,{label:I(de)("maskEditor.applyToWholeImage"),"model-value":I(t).applyWholeImage,"onUpdate:modelValue":i},null,8,["label","model-value"]),tt(vv,{label:I(de)("maskEditor.method"),options:I(r),"model-value":I(t).colorComparisonMethod,"onUpdate:modelValue":o},null,8,["label","options","model-value"]),tt(Zs,{label:I(de)("maskEditor.stopAtMask"),"model-value":I(t).maskBoundary,"onUpdate:modelValue":l},null,8,["label","model-value"]),tt(er,{label:I(de)("maskEditor.maskTolerance"),min:0,max:255,step:1,"model-value":I(t).maskTolerance,"onUpdate:modelValue":u},null,8,["label","model-value"])]))}}),kv={class:"flex flex-col gap-3 pb-3"},_v={class:"text-center text-[15px] font-sans text-[var(--descrip-text)] mt-2.5"},Bv=mt({__name:"PaintBucketSettingsPanel",setup(e){const t=Ye(),r=a=>{t.setPaintBucketTolerance(a)},n=a=>{t.setFillOpacity(a)};return(a,s)=>(xe(),je("div",kv,[A("h3",_v,Pe(I(de)("maskEditor.paintBucketSettings")),1),tt(er,{label:I(de)("maskEditor.tolerance"),min:0,max:255,step:1,"model-value":I(t).paintBucketTolerance,"onUpdate:modelValue":r},null,8,["label","model-value"]),tt(er,{label:I(de)("maskEditor.fillOpacity"),min:0,max:100,step:1,"model-value":I(t).fillOpacity,"onUpdate:modelValue":n},null,8,["label","model-value"])]))}}),Pv={class:"maskEditor_sidePanel"},zv={class:"maskEditor_sidePanelContainer"},Iv=mt({__name:"SettingsPanelContainer",setup(e){const t=Me(()=>{const r=Ye().currentTool;return r===se.MaskBucket?Bv:r===se.MaskColorFill?Mv:dv});return(r,n)=>(xe(),je("div",Pv,[A("div",zv,[(xe(),Tn(rp(t.value)))])]))}}),Uv={class:"flex flex-col gap-3 pb-3 h-full !items-stretch bg-[var(--comfy-menu-bg)] overflow-y-auto w-55 px-2.5"},Ev={class:"w-full min-h-full"},Rv=mt({__name:"SidePanel",props:{toolManager:{}},setup(e){return(t,r)=>(xe(),je("div",Uv,[A("div",Ev,[tt(Iv),r[0]||(r[0]=A("div",{class:"w-full h-0.5 bg-[var(--border-color)] mt-6 mb-1.5"},null,-1)),tt(av,{"tool-manager":e.toolManager},null,8,["tool-manager"])])]))}}),Cv={[se.MaskPen]:`
    <svg viewBox="0 0 44 44">
      <path class="cls-1" d="M10.97,15.98v14.04c0,.825.675,1.5,1.5,1.5h23.07c.825,0,1.5-.675,1.5-1.5V15.98c0-.825-.675-1.5-1.5-1.5H12.47c-.825,0-1.5.675-1.5,1.5ZM25.79,28.16c-4.365,1.41-8.355-2.58-6.945-6.945.51-1.575,1.785-2.85,3.36-3.36,4.365-1.41,8.355,2.58,6.945,6.945-.51,1.575-1.785,2.85-3.36,3.36Z"/>
    </svg>
  `,[se.Eraser]:`
    <svg viewBox="0 0 44 44">
      <g>
        <rect class="cls-2" x="16.68" y="10" width="10.63" height="24" rx="1.16" ry="1.16" transform="translate(22 -9.11) rotate(45)"/>
        <path class="cls-1" d="M17.27,34.27c-.42,0-.85-.16-1.17-.48l-5.88-5.88c-.31-.31-.48-.73-.48-1.17s.17-.86.48-1.17l15.34-15.34c.62-.62,1.72-.62,2.34,0l5.88,5.88c.65.65.65,1.7,0,2.34l-15.34,15.34c-.32.32-.75.48-1.17.48ZM26.73,10.73c-.18,0-.34.07-.46.19l-15.34,15.34c-.12.12-.19.29-.19.46s.07.34.19.46l5.88,5.88c.26.26.67.26.93,0l15.34-15.34c.26-.26.26-.67,0-.93l-5.88-5.88c-.12-.12-.29-.19-.46-.19Z"/>
      </g>
      <path class="cls-3" d="M20.33,11.03h8.32c.64,0,1.16.52,1.16,1.16v15.79h-10.63v-15.79c0-.64.52-1.16,1.16-1.16Z" transform="translate(20.97 -11.61) rotate(45)"/>
    </svg>
  `,[se.MaskBucket]:`
    <svg viewBox="0 0 44 44">
      <path class="cls-1" d="M33.4,21.76l-11.42,11.41-.04.05c-.61.61-1.6.61-2.21,0l-8.91-8.91c-.61-.61-.61-1.6,0-2.21l.04-.05.3-.29h22.24Z"/>
      <path class="cls-1" d="M20.83,34.17c-.55,0-1.07-.21-1.46-.6l-8.91-8.91c-.8-.8-.8-2.11,0-2.92l11.31-11.31c.8-.8,2.11-.8,2.92,0l8.91,8.91c.39.39.6.91.6,1.46s-.21,1.07-.6,1.46l-11.31,11.31c-.39.39-.91.6-1.46.6ZM23.24,10.83c-.27,0-.54.1-.75.31l-11.31,11.31c-.41.41-.41,1.09,0,1.5l8.91,8.91c.4.4,1.1.4,1.5,0l11.31-11.31c.2-.2.31-.47.31-.75s-.11-.55-.31-.75l-8.91-8.91c-.21-.21-.48-.31-.75-.31Z"/>
      <path class="cls-1" d="M34.28,26.85c0,.84-.68,1.52-1.52,1.52s-1.52-.68-1.52-1.52,1.52-2.86,1.52-2.86c0,0,1.52,2.02,1.52,2.86Z"/>
    </svg>
  `,[se.MaskColorFill]:`
    <svg viewBox="0 0 44 44">
      <path class="cls-1" d="M30.29,13.72c-1.09-1.1-2.85-1.09-3.94,0l-2.88,2.88-.75-.75c-.2-.19-.51-.19-.71,0-.19.2-.19.51,0,.71l1.4,1.4-9.59,9.59c-.35.36-.54.82-.54,1.32,0,.14,0,.28.05.41-.05.04-.1.08-.15.13-.39.39-.39,1.01,0,1.4.38.39,1.01.39,1.4,0,.04-.04.08-.09.11-.13.14.04.3.06.45.06.5,0,.97-.19,1.32-.55l9.59-9.59,1.38,1.38c.1.09.22.14.35.14s.26-.05.35-.14c.2-.2.2-.52,0-.71l-.71-.72,2.88-2.89c1.08-1.08,1.08-2.85-.01-3.94ZM19.43,25.82h-2.46l7.15-7.15,1.23,1.23-5.92,5.92Z"/>
    </svg>
  `,[se.PaintPen]:`
    <svg viewBox="0 0 44 44">
      <path class="cls-1" d="M34,13.93c0,.47-.19.94-.55,1.31l-13.02,13.04c-.09.07-.18.15-.27.22-.07-1.39-1.21-2.48-2.61-2.49.07-.12.16-.24.27-.34l13.04-13.04c.72-.72,1.89-.72,2.6,0,.35.35.55.83.55,1.3Z"/>
      <path class="cls-1" d="M19.64,29.03c0,4.46-6.46,3.18-9.64,0,3.3-.47,4.75-2.58,7.06-2.58,1.43,0,2.58,1.16,2.58,2.58Z"/>
    </svg>
  `},Av={class:"h-full z-[8888] flex flex-col justify-between bg-[var(--comfy-menu-bg)]"},Ov={class:"flex flex-col"},Lv=["onClick"],Fv=["innerHTML"],Gv=["title"],Dv={class:"text-sm text-[var(--p-button-text-secondary-color)]"},Vv={class:"text-xs text-[var(--p-button-text-secondary-color)]"},jv=mt({__name:"ToolPanel",props:{toolManager:{}},setup(e){const t=Ye(),r=o=>{e.toolManager.switchTool(o)},n=Me(()=>t.currentTool),a=Me(()=>`${Math.round(t.displayZoomRatio*100)}%`),s=Me(()=>{const o=t.image;return o?`${o.width}x${o.height}`:" "}),i=()=>{t.resetZoom()};return(o,l)=>(xe(),je("div",Av,[A("div",Ov,[(xe(!0),je(Yl,null,Zl(I(Up),u=>(xe(),je("div",{key:u,class:fs(["maskEditor_toolPanelContainer hover:bg-[var(--p-surface-300)] dark-theme:hover:bg-[var(--p-surface-800)]",{maskEditor_toolPanelContainerSelected:n.value===u}]),onClick:c=>r(u)},[A("div",{class:"flex items-center justify-center",innerHTML:I(Cv)[u]},null,8,Fv),l[0]||(l[0]=A("div",{class:"maskEditor_toolPanelIndicator"},null,-1))],10,Lv))),128))]),A("div",{class:"flex flex-col items-center cursor-pointer rounded-md mb-2 transition-colors duration-200 hover:bg-[var(--p-surface-300)] dark-theme:hover:bg-[var(--p-surface-800)]",title:I(de)("maskEditor.clickToResetZoom"),onClick:i},[A("span",Dv,Pe(a.value),1),A("span",Vv,Pe(s.value),1)],8,Gv)]))}}),Nv={class:"maskEditor-ui-container flex min-h-0 flex-1 flex-col"},qv={class:"flex min-h-0 flex-1 overflow-hidden"},Wv=mt({__name:"MaskEditorContent",props:{node:{}},setup(e){const t=Ye(),r=ki(),n=zg(),a=jp(),s=k(),i=k(),o=k(),l=k(),u=k(),c=k(),p=k(),d=k(),h=k(),f=k(!1),m=Op(),T=Np(),_=Pg(m,T);let O=null;const ne=V=>{V.ctrlKey&&V.preventDefault()},Z=async()=>{var V,E;if(!s.value){console.error("[MaskEditorContent] Cannot initialize - missing required refs");return}if(!o.value||!l.value||!u.value||!i.value||!p.value){console.error("[MaskEditorContent] Cannot initialize - missing canvas refs");return}t.maskCanvas=l.value,t.rgbCanvas=u.value,t.imgCanvas=o.value,t.canvasContainer=i.value,t.canvasBackground=p.value;try{await a.loadFromNode(e.node);const j=await Ap().loadImages();await T.initializeCanvasPanZoom(j,s.value,(V=d.value)==null?void 0:V.$el,(E=h.value)==null?void 0:E.$el),t.canvasHistory.saveInitialState(),_.brushDrawing&&(await _.brushDrawing.initGPUResources(),c.value&&_.brushDrawing.initPreviewCanvas&&(c.value.width=l.value.width,c.value.height=l.value.height,_.brushDrawing.initPreviewCanvas(c.value))),f.value=!0}catch(G){console.error("[MaskEditorContent] Initialization failed:",G),n.closeDialog()}};return $i(()=>{m.addListeners(),s.value&&(O=new ResizeObserver(async()=>{T&&await T.invalidatePanZoom()}),O.observe(s.value)),Z()}),np(()=>{_.brushDrawing.saveBrushSettings(),m==null||m.removeListeners(),O&&(O.disconnect(),O=null),t.canvasHistory.clearStates(),t.resetState(),r.reset()}),(V,E)=>(xe(),je("div",{ref_key:"containerRef",ref:s,class:"maskEditor-dialog-root flex h-full w-full flex-col",onContextmenu:E[4]||(E[4]=wn(()=>{},["prevent"])),onDragstart:ne},[A("div",{id:"maskEditorCanvasContainer",ref_key:"canvasContainerRef",ref:i,onContextmenu:E[3]||(E[3]=wn(()=>{},["prevent"]))},[A("canvas",{ref_key:"imgCanvasRef",ref:o,class:"absolute top-0 left-0 w-full h-full z-0",onContextmenu:E[0]||(E[0]=wn(()=>{},["prevent"]))},null,544),A("canvas",{ref_key:"rgbCanvasRef",ref:u,class:"absolute top-0 left-0 w-full h-full z-10",onContextmenu:E[1]||(E[1]=wn(()=>{},["prevent"]))},null,544),A("canvas",{ref_key:"maskCanvasRef",ref:l,class:"absolute top-0 left-0 w-full h-full z-30",onContextmenu:E[2]||(E[2]=wn(()=>{},["prevent"]))},null,544),A("canvas",{ref_key:"gpuCanvasRef",ref:c,class:fs(["absolute top-0 left-0 w-full h-full pointer-events-none",{"z-20":I(t).activeLayer==="rgb","z-40":I(t).activeLayer==="mask"}])},null,2),A("div",{ref_key:"canvasBackgroundRef",ref:p,class:"bg-white w-full h-full"},null,512)],544),A("div",Nv,[A("div",qv,[f.value?(xe(),Tn(jv,{key:0,ref_key:"toolPanelRef",ref:d,"tool-manager":I(_)},null,8,["tool-manager"])):ca("",!0),f.value?(xe(),Tn(Ug,{key:1,"tool-manager":I(_),"pan-zoom":I(T)},null,8,["tool-manager","pan-zoom"])):ca("",!0),f.value?(xe(),Tn(Rv,{key:2,ref_key:"sidePanelRef",ref:h,"tool-manager":I(_)},null,8,["tool-manager"])):ca("",!0)])]),f.value?(xe(),Tn(Ig,{key:0,"container-ref":s.value},null,8,["container-ref"])):ca("",!0)],544))}}),Yv=ap(Wv,[["__scopeId","data-v-b0ac6c57"]]),Zv={class:"mask-editor-app"},Xv=mt({__name:"MaskEditorApp",props:{nodeData:{}},setup(e){const t=e,r=k(null);return $i(()=>{t.nodeData&&(r.value=t.nodeData)}),(n,a)=>(xe(),je("div",Zv,[r.value?(xe(),Tn(Yv,{key:0,node:r.value},null,8,["node"])):ca("",!0)]))}});function Hv(e,t={}){const r=sp(Xv,{nodeData:t.nodeData,...t.props}),n=ip();return r.use(n),r.mount(e),r}window.createMaskEditorApp=Hv;
